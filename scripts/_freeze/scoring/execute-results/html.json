{
  "hash": "b767a40959169603627741fde0973159",
  "result": {
    "markdown": "# Pathway activity in a personalized context\n\nThis chapter we present a new way to think about the personalized medicine,\nby incorporating patient molecular information and its context. \nWe saw previously that by using different cohorts, we can embed new patients\ninto a point cloud. The idea is that the neighborhood of the patients \nare similar in the molecular level, and we can draw conclusions based on\nthis. \n\nEach patient can be assigned a score. Scores represent a biological\npathway, or in other words, a biological activity. Given a biological\nprocess, there is usually a set of genes that represent it. We\ncan then use these set of genes to calculate scores that are \nproxies of this biological activity.\n\nFor example, in the previous chapters we used the ER signaling\nscores to motivate the continuity of ER signaling. This is not\nrestricted to this specific pathway, we could have used any\nother list of genes representing a process. \n\nBy combining a score and the neighborhood of a patient, we \ncan make direct comparisons and questions. Given a patient,\nhow different is its score for a pathway compared to its\nneighbors? Is there also an alternative pathway that could\nbe target and has a higher signaling? In this case \nspecifically, is ER signaling more or less expressed compared\nto its neighbors? \n\nThe POETIC trial [@Gao2019] \nis a breast cancer trial that had as hypothesis\nneoadjuvant therapy could improve overall and recurrence free\nsurvival. They gave aromatase inhibitors (AIs) for ER+ BC patients\nfor 2 weeks prior to surgery and then 2 weeks after surgery.\nMoreover, they collected a needle biopsy before the\ntreatment started and a biopsy in the surgery. They\nalso measured the Ki67 levels, therefore we have a proxy\non how well these patients responded in the short term to \nAIs. Also, they sent the tissues for sequencing, so \nmicroarray data is available. This is a unique \ncohort, in the sense that we can understand what are the\nresponders or not, in terms of Ki67 levels, and use\nthe molecular data to try to understand the responsiveness. \nThe definition of responders are those patients that have a \nreduction of at least 60\\%\nin Ki67 levels when comparing pre-treatment versus surgery. \n\nHere we use this cohort to draw conclusions on responders\nand non responders and how the molecular landscape can be \nused. We show that some patients that are close to each\nother in the molecular landscape can have different\npathway scores and therefore have different responses.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n* The library is already synchronized with the lockfile.\n```\n:::\n:::\n\n\n## Calculating scores in neighborhoods\n\nPatients close to each other in the molecular landscape are somewhat\nmolecularly close, due to how the embedding works. Therefore, we can \nlook at patients in a neighborhood and calculate the average scores,\nto see what it means to be in a specific neighborhood. \n\nTo do this, we define a radius for a patient where all the patients\nwithin the euclidean ball with this radius will be selected and an \naverage score distribution is calculated.\n\nTo calculate the average score distribution we use the `rstanarm` package. \nWe set the prior distribution for the intercept to be a normal distribution\ncentered at 0 with standard deviation of 1. All scores are in a range of\n-1 to 1, so this is a relatively flat prior for our use case.\n\nThe video below shows how scores change in average when comparing different\nneighborhoods. \n\n\n::: {.cell}\n\n:::\n\n<iframe width=\"720\" height=\"480\" src=\"../plots/scoring/mol_land.mp4\" align=\"middle\"frameborder=\"0\" allowfullscreen></iframe>\n\n\nGoing from right to left it shows how ER signaling is decreased. From top to\nbottom there is a reduction of proliferation, E2F targets, and a change in\nEMT and TGFb signaling. These are representative scores, other pathways could\nbe used as well. \n\n## POETIC embedding\n\nIn this section we show the embedding of the POETIC trial samples.\nBut first we analyse some basic properties of the dataset.\nThe data for this dataset was downloaded and processed\nas described at \n[chronchi.github.io/transcriptomics](https://chronchi.github.io/transcriptomics/)\nin the chapter AI - GSE105777. \n\n\n::: {.cell}\n\n:::\n\n\n### Number of samples\n\nIn this dataset there are matched samples from patients that \nare treated and untreated. @tbl-pt-poetic-nb\n\n\n::: {#tbl-pt-poetic-nb .cell tbl-cap='Table showing the number of samples for treated and untreated patients'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> group </th>\n   <th style=\"text-align:right;\"> n </th>\n   <th style=\"text-align:right;\"> percent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> treated </td>\n   <td style=\"text-align:right;\"> 157 </td>\n   <td style=\"text-align:right;\"> 74 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> untreated </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 26 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nIn this cohort, there is the PAM50 molecular subtype available\nfor the untreated. @tbl-pt-poetic-pam50 shows the\nnumber of patients for each subtype.\n\n\n::: {#tbl-pt-poetic-pam50 .cell tbl-cap='Table showing the number of molecular subtypes for each group.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> pam50 </th>\n   <th style=\"text-align:right;\"> n </th>\n   <th style=\"text-align:right;\"> percent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> her2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.235 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> luma </td>\n   <td style=\"text-align:right;\"> 77 </td>\n   <td style=\"text-align:right;\"> 18.075 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lumb </td>\n   <td style=\"text-align:right;\"> 31 </td>\n   <td style=\"text-align:right;\"> 7.277 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> normal </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.704 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> not_available </td>\n   <td style=\"text-align:right;\"> 314 </td>\n   <td style=\"text-align:right;\"> 73.709 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe numbers differ from previously, since the molecular subtype is \ncalculated for each sample, so two molecular subtypes for each patient. \n\n### Proportion of top loadings\n\n\n::: {.cell}\n\n:::\n\n\nThere are in total 1008 genes available out\nof the . Among them, \n39 are\nthe housekeeping genes. Out of the\n36 genes missing,\na total number of 8 are missing from the\ntop 200 PC3 loadings, a proportion of \n4\\%. \nA total number of 5 are missing from the\ntop 200 PC4 loadings, a proportion of \n2\\%. These\nare very small proportions, and we have seen from the last chapter that\nthey will not affect the position of the patients in the embedding.\n\n### Embedding \n\n@fig-pca-poetic-er-pam50 shows a good mixing of the POETIC sample and how\nall the patients are scattered across the whole landscape. Here all samples\nare plotted, meaning that every two dots correspond to a single patient.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![PCA embedding of all samples from TCGA, SCANB and METABRIC including the POETIC samples on top. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype.](scoring_files/figure-html/fig-pca-poetic-er-pam50-1.png){#fig-pca-poetic-er-pam50 width=1824}\n:::\n:::\n\n\n@fig-pca-responders-baseline shows the embedding of baseline samples\nfrom patients that received endocrine therapy prior to surgery. \nPatients on the left part of the molecular landscape are considered to\nbe non responders, this coincides with the fact this region corresponds\nto the ER- BC patients.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![PCA embedding of all samples from TCGA, SCANB and METABRIC including the POETIC samples on top. POETIC samples correspond to only baseline treated patients.](scoring_files/figure-html/fig-pca-responders-baseline-1.png){#fig-pca-responders-baseline width=960}\n:::\n:::\n\n\nAnd when checking the first two components, the POETIC data is closer to\nMETABRIC, which makes sense since both are microarrays, as it can be seen\nin @fig-poetic-cohort.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Biplot of first two PCA components from POETIC, TCGA, SCANB and METABRIC. POETIC is highlighted in the plot and has a bigger point.](scoring_files/figure-html/fig-poetic-cohort-1.png){#fig-poetic-cohort width=672}\n:::\n:::\n\n\n### Differences in PC3 for responders and non responders\n\nWe now also compare the differences in non responders vs responders\naccording to the third component. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n## Scoring all samples \n\nIn the last chapters scores were showed for TCGA, SCANB and \nMETABRIC. @fig-pca-seterpr shows how ER signaling changes as patients\nmove across the molecular landscape. We intend to use the scores now for the\nPOETIC samples. We first start by calculating using GSVA as well and include\nin the dataframe with the other cohorts. Before moving to the next chapter,\nwe will analyse and compare the scores across the responders and non \nresponders. \n\n@fig-scores-poetic-er shows that when using the scores, it looks like\nin average at baseline $SET_{ER/PR}$ is lower in non responders than\nin responders. For the other scores there is no clear difference.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![Baseline scores for all treated patients in the POETIC trial. G2M corresponds to a proliferation score, EMT to epithelial to mesenchymal transition score and the others are related to ER signaling.](scoring_files/figure-html/fig-scores-poetic-er-1.png){#fig-scores-poetic-er width=1248}\n:::\n:::\n\n\nWe see that for PC3 and SET ER/PR There are some\ndifferences in terms of the responders and non responders.\n\nLet us take a closer look at those patients. We start\nby plotting the scatter plot of PC3 vs SET ER/PR and color\nby response status defined by the POETIC trial. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![Comparison of the third component with SET ER/PR scores colored by response status.](scoring_files/figure-html/fig-scores-poetic-responders-1.png){#fig-scores-poetic-responders width=672}\n:::\n:::\n\n\nThis figure shows that there is a correlation between\nthird component and SET ER/PR for the POETIC trial data\nas well as it was already seen from the other cohorts. \nMoreover, it seems that the responders have higher PC scores\nin general. We now correlate for each subgroup (responder and non \nresponders) the PC3 and the change in percentage for Ki67.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Correlation between change in Ki67 versus PC3 stratified by response group.](scoring_files/figure-html/fig-scores-corr-poetic-1.png){#fig-scores-corr-poetic width=960}\n:::\n:::\n\n\nNow another metric we can calculate from our dataset is the difference\nof the embedding positions \nbetween the different samples of the same patient. The idea is that if a \npatient responded well, there were bigger changes as well in the\ntranscriptomics and that is reflected in the embedding. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![Differences of the embeddings for each patient individually stratified by response status. Each dot corresponds to a single patient.](scoring_files/figure-html/fig-diff-embedding-poetic-1.png){#fig-diff-embedding-poetic width=960}\n:::\n:::\n\n\nAnd now we perform a comparison of these positions by using\nrstanarm to get the posterior distributions of the differences.\n\n\n::: {.cell}\n\n:::\n\n\nThe figure below shows the distribution of the averages of the differences\nin the embedding of the projections.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Differences of the embeddings for each patient individually stratified by response status. Each dot corresponds to a single patient.](scoring_files/figure-html/fig-diff-embedding-poetic-averages-1.png){#fig-diff-embedding-poetic-averages width=672}\n:::\n:::\n\n\nAnd the figure below shows the posterior distribution of the differences\nin average.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Differences of the average differences in the embedding for each patient individually. The comparison made was non responder vs responder, which means that if non responder has a lower difference in average, the difference in difference will be negative.](scoring_files/figure-html/fig-diff-embedding-poetic-averages-diff-1.png){#fig-diff-embedding-poetic-averages-diff width=672}\n:::\n:::\n\n\n## Analysing patient neighborhoods\n\nThere are two ways to interpret the embedding. If the patient has\nER+ BC and its embedding is close to the ER- BC patients, we can\ninfer that the endocrine response might not work so well, as \nit was shown in @fig-pca-responders-baseline. The other option\nis to compare the patient's score to the average score of \nits neighborhood.\n\nWhat is a neighborhood? When performing the embedding, global\nstructures are not preserved usually. In this sense we only\ncompare patients that are close to each other in an euclidean \nneighborhood, i.e., we calculate a radius around each sample and\nsee what other samples are within this ball given the euclidean\ndistance.\n\nGiven a neighborhood, one can calculate the posterior average score\nof all samples from METABRIC, SCANB and TCGA and use that as an \nindication of average score that we can compare other patients to.\nThe concept is that if an ER+ BC patient has a much lower ER signaling\nscore, it means the patients will not respond so well to endocrine \ntherapy, as they are very different from their neighboors.\n\nTo showcase the ability to use the scores and infer results, we \nuse the POETIC trial patients to compare the scores. This cohort\nis special in the sense that the patients are filtered based on\nselection criterias, meaning that the patients are clinically\nsimilar. \n\nTwo random patients in very close neighborhoods were selected\nto showcase the ability of the molecular landscape.\nThe id of the patients are 63 and 236.\n@tbl-pt63-236 shows the clinical features of these patients. One\nof them is HER2+. Patient 63 had a higher Ki67 baseline level but\na very good response to endocrine therapy. Patient 236 did not \nrespond to endocrine therapy in terms of reduction of Ki67 levels.\n\n\n::: {#tbl-pt63-236 .cell tbl-cap='Clinical features from patients 63 and 236.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> patient_nb </th>\n   <th style=\"text-align:left;\"> er_status </th>\n   <th style=\"text-align:left;\"> her2_status </th>\n   <th style=\"text-align:right;\"> ki67 </th>\n   <th style=\"text-align:right;\"> change_ki67 </th>\n   <th style=\"text-align:left;\"> ccca_surgery_ki67_2_7 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 63 </td>\n   <td style=\"text-align:left;\"> pos </td>\n   <td style=\"text-align:left;\"> Positive </td>\n   <td style=\"text-align:right;\"> 16.60702 </td>\n   <td style=\"text-align:right;\"> -69.958509 </td>\n   <td style=\"text-align:left;\"> noCCCA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 236 </td>\n   <td style=\"text-align:left;\"> pos </td>\n   <td style=\"text-align:left;\"> Negative </td>\n   <td style=\"text-align:right;\"> 11.30906 </td>\n   <td style=\"text-align:right;\"> 5.593711 </td>\n   <td style=\"text-align:left;\"> noCCCA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n@fig-pt63-236 shows the embedding of two distinct patients \nin a similar neighborhood.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Plot of two selected patients in the molecular landscape. One is a responder and the other is a non responder. The patient id numbers are 63 and 236.](scoring_files/figure-html/fig-pt63-236-1.png){#fig-pt63-236 width=960}\n:::\n:::\n\n\n\nAnd now we calculate the average scores for each patient neighborhoods. We \nstart by defining a radius value. After that we select the patients in the\nneighborhood and use `rstanarm` to get the posterior distribution of the\naverage score in the neighborhood. For this we use the function\n`stan_glm` to calculate the average. This is effective because it can\nbe paired with the package `tidybayes` for plotting. It makes extremely easy\nto deal with posterior data. For the average we use a \nnormal prior centered at 0 with 1 standard deviation, \nsince all scores are between -1 and 1.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\nPatient 63 @fig-pt63 is considered a responder. According to \nthe scores, when comparing the estrogen early signature to its average \ndistribution in the neighborhood, the score is higher.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Posterior distribution of the average scores in the neighborhood of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.](scoring_files/figure-html/fig-pt63-1.png){#fig-pt63 width=960}\n:::\n:::\n\n\nPatient 236 @fig-pt236 was considered a non responder. According to \nthe scores, when comparing the estrogen early signature to its average \ndistribution in the neighborhood, the score is lower, being in the\n5% quantile.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Posterior distribution of the average scores in the neighborhood of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.](scoring_files/figure-html/fig-pt236-1.png){#fig-pt236 width=960}\n:::\n:::\n\n\nWhen comparing these two patients, there is also a difference in the androgen\nresponse score, which could be a reflection of different estrogen signaling.\n\n### Analysing all patients\n\nWe now try to extend this comparison to something more systematic. Instead\nof looking just for these two patients we will compare the neighborhoods\nfor the top responders and \nnon-responder patients. The first thing we\nhave to have in mind is that some non \nresponders they did respond to the drug, just the reduction in Ki67\nwas not so big. For example patient 209 has a reduction of 40% in Ki67\ngoing from 16% to 9%. Still this patient is considered a non-responder.\n\n\n::: {.cell}\n\n:::\n\n\nWe don't select all patients for the comparisons. We select only patients that \nare at least in the HER2 enriched region to the right, so we \nexclude the basal like patients. The reason for this as well is because\nthey all either have low Estrogen response early scores or low SET ER/PR.\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:left;\"> HALLMARK_ESTROGEN_RESPONSE_EARLY </th>\n   <th style=\"text-align:left;\"> SET_ERPR </th>\n   <th style=\"text-align:left;\"> PC3 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> treated_nb69_baseline </td>\n   <td style=\"text-align:left;\"> -0.265 </td>\n   <td style=\"text-align:left;\"> -0.50 </td>\n   <td style=\"text-align:left;\"> -4.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treated_nb76_baseline </td>\n   <td style=\"text-align:left;\"> -0.275 </td>\n   <td style=\"text-align:left;\"> -0.19 </td>\n   <td style=\"text-align:left;\"> -4.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treated_nb80_baseline </td>\n   <td style=\"text-align:left;\"> -0.013 </td>\n   <td style=\"text-align:left;\"> -0.49 </td>\n   <td style=\"text-align:left;\"> -5.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treated_nb229_baseline </td>\n   <td style=\"text-align:left;\"> -0.234 </td>\n   <td style=\"text-align:left;\"> -0.54 </td>\n   <td style=\"text-align:left;\"> -4.7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treated_nb230_baseline </td>\n   <td style=\"text-align:left;\"> -0.308 </td>\n   <td style=\"text-align:left;\"> -0.50 </td>\n   <td style=\"text-align:left;\"> -7.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treated_nb237_baseline </td>\n   <td style=\"text-align:left;\"> -0.377 </td>\n   <td style=\"text-align:left;\"> -0.29 </td>\n   <td style=\"text-align:left;\"> -7.9 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\n#### Non-responders\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-29-1.png){width=960}\n:::\n:::\n\n\nEstrogen score still close to 0, high proliferation at baseline and higher\nandrogen score. But in this case SET ER/PR is lower than average. There is\na mismatch.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-30-1.png){width=960}\n:::\n:::\n\n\nThis patient has a score close to 0 still but low proliferation in general. \nThis is a case where the EMT signaling is really at average and \nTGFb is super low. Again SET ER/PR is much lower, mismatch with ER \nsignaling.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-31-1.png){width=960}\n:::\n:::\n\n\nEstrogen signaling close to 0, high androgen and E2F targets and high\nEMT. Intriguing patient, both ER and SET ER/PR are going in \nthe same direction and above average. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-32-1.png){width=960}\n:::\n:::\n\n\nLow ER signaling and super high EMT with an increase P53 pathway\nexpression. Super low ER signaling here in terms of SET ER/PR. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-33-1.png){width=960}\n:::\n:::\n\n\nLow ER score, even lower than average and low EMT signaling. Average \nE2F targets and lower than average for SET ER/PR.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-34-1.png){width=960}\n:::\n:::\n\n\nThis case is a bit different, the ER signaling is higher, E2F targets at\nbaseline is not so high, even lower than the average, but in this\ncase androgen response is much higher and EMT is extremely high. There is\na relative mismatch between ER early and SET ER/PR. SET ER/PR is \nrelatively small and close to the average.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-35-1.png){width=960}\n:::\n:::\n\n\nAndrogen score lower than the average and high E2F targets at baseline. \nIn this case we see a very small EMT signature. In this case there is \nagain a mismatch between ER signaling and SET ER/PR.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-36-1.png){width=960}\n:::\n:::\n\n\nThis one has a low ER signaling as well and higher E2F targets score. \nMassive difference in SET ER/PR here when comparing to the average.\n\nIn general all these non responders with no change in Ki67 had a low\nER signaling score or a mismatch between ER early and SET ER/PR\n\n#### Top responders\n\nWe now investigate the top responders with the\nbiggest decrease in Ki67.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-37-1.png){width=960}\n:::\n:::\n\n\nFirst thing is that this patient had already a positive score\nand a very low Androgen signaling score. Moreover the Ki67\nis low. This is one of the furthest patients to the\nright and still has a low ER signaling score.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-38-1.png){width=960}\n:::\n:::\n\n\nA bit high E2F targets but higher than average of the estrogen\nsignaling score. High SET ER/PR.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-39-1.png){width=960}\n:::\n:::\n\n\nHere the ER signaling is above average and androgen response is similar\nto the average. E2F targets is high. Also super high SET ER/PR.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-40-1.png){width=960}\n:::\n:::\n\n\nVery low E2F targets and low Androgen response. ER is about the\naverage. SET ER/PR is still positive. This sample is in \nthe luminal A region also.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-41-1.png){width=960}\n:::\n:::\n\n\nIn this case ER signaling is also above average and E2F targets is \nsimilar to the average of neighbors. SET ER/PR on average and in the \nexpected direction.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-42-1.png){width=960}\n:::\n:::\n\n\nThis one is intriguing, ER signaling is extremely low, E2F targets is\nvery low as well but the patient responded pretty well. But there is a \nbig mismatch between Ki67 and transcriptomics for this patient. Further\ninvestigation should be performed. Actually probably the samples have mixed\nnames. Below are the values of the pathways after treatment:\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-16e2bfdaa11aace99ef2\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-16e2bfdaa11aace99ef2\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"treated_nb89_baseline\",\"treated_nb89_surgery\"],[49.3116395494368,1.86104218362283],[-0.556062047578453,0.383861479152084],[0.0570299959923077,0.279317135063836],[-0.324343902994388,-0.174999482790282],[0.737080017429381,0.0409566810926228],[-2.03855921324292,1.88122496727946]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>ki67<\\/th>\\n      <th>HALLMARK_E2F_TARGETS<\\/th>\\n      <th>SET_ERPR<\\/th>\\n      <th>HALLMARK_ESTROGEN_RESPONSE_EARLY<\\/th>\\n      <th>PC3<\\/th>\\n      <th>PC4<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollX\":true,\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5,6]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nIt looks super weird that there is a big increase in proliferation based\non the transcriptomic data considering the reduction in the Ki67 percentage.\nNot only that, ER signaling increases. It is very likely that the sample \nhas a mixed label. \n\nMoving to the next one.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-44-1.png){width=960}\n:::\n:::\n\n\nThis one also is intriguing, estrogen signaling is very low but the patient\nis a responder with a good decrease in Ki67. Below is a table with the values\nfor surgery and baseline. We see that there is indeed a decrease in \nproliferation and also in estrogen signaling. Also this sample \nis closer to the normal like and luminal A region.\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-a20dda1ca42ff305348a\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-a20dda1ca42ff305348a\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"treated_nb90_baseline\",\"treated_nb90_surgery\"],[0.4062863196128,2.49153864759479],[-3.02836676173437,-2.06070153823311],[-0.324759889064836,-0.218895973428806],[0.0642536744292175,-0.378936381935116],[29.3718166383701,1.11111111111111]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>PC3<\\/th>\\n      <th>PC4<\\/th>\\n      <th>HALLMARK_ESTROGEN_RESPONSE_EARLY<\\/th>\\n      <th>HALLMARK_E2F_TARGETS<\\/th>\\n      <th>ki67<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollX\":true,\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nAnd last patient.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-46-1.png){width=960}\n:::\n:::\n\n\nThis patient has a score slightly higher than the average, but still negative.\nNonetheless, the patient responded well to the therapy. One note is \nthat this patient is close to the HER2 enriched region. \n\nIn general non responders had more mismatches between SET ER/PR and \nbelow average values than responders.\n\n#### Responders in the middle of embedding \n\nWe lastly check the responders that are in the middle of the \nmolecular landscape to see how they are. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-47-1.png){width=960}\n:::\n:::\n\n\nLow ER signaling in both cases. This patient\nspecifically had very high Ki67 levels at baseline.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-48-1.png){width=960}\n:::\n:::\n\n\nAlso ER signaling is low here compared to the average, but a very low\nKi67 proliferation index at baseline.\n\n#### Conclusion\n\nIn general what we can see is that when comparing responders and\nnon responders the main difference is in the position of \nthe molecular landscape. If we select the top responders and the\ntop non-responders in terms of decrease of Ki67 index, we see\nthat non responders have way lower third principal \ncomponent (@fig-high-respnon).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![PC3 comparison of the top non responders and responders](scoring_files/figure-html/fig-high-respnon-1.png){#fig-high-respnon width=576}\n:::\n:::\n\n\n## Predicting response to endocrine therapy\n\nWe now try to use a penalized logistic regression to predict patient\nresponse, as defined by the POETIC trialists using the principal\ncomponents. For this we already saw that in average the patients further\nto the left are non-responders and further to the right would be responders,\nsuggesting a predictive power of the molecular landscape. The landscape still\nis not perfect as there is a lot of overlap between the responders and \nnon-responders. So we try to use more principal components to \ncapture the differences. \n\nJust when randomizing the train test split, we need to make sure that\nwe include some of the samples that are in the basal like region in \nboth splits, since they are in small numbers. Due to the small sample\nsize, we use the components starting from 3 and going up to 20.\n\n\n::: {.cell}\n\n:::\n\n\nIn this dataset the total of responders vs non responder is:\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-f6fd1124309f6b974c04\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f6fd1124309f6b974c04\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\"],[\"non_responder\",\"responder\"],[43,94],[0.313868613138686,0.686131386861314]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>is_responder<\\/th>\\n      <th>n<\\/th>\\n      <th>percent<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"targets\":3,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"className\":\"dt-right\",\"targets\":[2,3]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[\"options.columnDefs.0.render\"],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nMore than 2/3 are responders. Using a set seed for the randomization, \nthe numbers of responders and non responders are shown below for the training\nset.\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-44af5114ac3fb012fb78\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-44af5114ac3fb012fb78\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\"],[\"non_responder\",\"responder\"],[28,63],[0.307692307692308,0.692307692307692]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>is_responder<\\/th>\\n      <th>n<\\/th>\\n      <th>percent<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"targets\":3,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"className\":\"dt-right\",\"targets\":[2,3]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[\"options.columnDefs.0.render\"],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nAnd for the test set.\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-ecc955e29d01d565a4d0\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-ecc955e29d01d565a4d0\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\"],[\"non_responder\",\"responder\"],[15,31],[0.326086956521739,0.673913043478261]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>is_responder<\\/th>\\n      <th>n<\\/th>\\n      <th>percent<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"targets\":3,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"className\":\"dt-right\",\"targets\":[2,3]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[\"options.columnDefs.0.render\"],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nAnd we compare the PC3 values distributions to see if they are \nequally distributed.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-54-1.png){width=672}\n:::\n:::\n\n\nThey are similarly distributed, so we can proceed with the training and\ntesting strategy. \n\n\n::: {.cell}\n\n:::\n\n\nThe plot below shows the misclassification error versus the \nlambda used for the penalization term in the logistic regression. \n\nThe plot below shows the misclassification error for different $\\lambda$\nvalues and number of components.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-56-1.png){width=672}\n:::\n:::\n\n\nOverall the misclassification is pretty similar for all number of variables.\nWe select the variables obtained with the lambda that is 1 SE away \nfrom the minimum. So in total we have three variables: \nThe intercept and PC3, PC10, PC20. \n\nAnd below we show the confusion matrix.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n         True\nPredicted  0  1 Total\n    0      1  3     4\n    1     14 28    42\n    Total 15 31    46\n\n Percent Correct:  0.6304 \n```\n:::\n:::\n\n\nWe see that the accuracy is very low and most of the patients are \nclassified as responders. This could be potentially due to the\nclass imbalance, but the results are still underwhelming. \n\nLet us take a look on the patients that were predicted to be\nnon responders and check their Ki67 differences in baseline and\nsurgery.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n                             PC3 change_ki67     ki67\ntreated_nb64_baseline  -2.733038   -66.53449 44.46653\ntreated_nb80_baseline  -5.649423    26.83238 43.24122\ntreated_nb129_baseline -3.468263   -86.59865 21.55340\ntreated_nb147_baseline -3.421153   -81.93744 42.51592\n```\n:::\n:::\n\n\nAll the patients that were misclassified as non responders they have a \nvery low third principal component and their baseline Ki67 is quite high, so\nthe decrease in proliferation is not actually big enough. It is still\nconsidered a responder. \n",
    "supporting": [
      "scoring_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/htmlwidgets-1.5.4/htmlwidgets.js\"></script>\n<link href=\"site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/datatables-binding-0.22/datatables.js\"></script>\n<script src=\"site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"site_libs/dt-core-1.11.3/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/dt-core-1.11.3/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/dt-core-1.11.3/js/jquery.dataTables.min.js\"></script>\n<link href=\"site_libs/crosstalk-1.2.0/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/crosstalk-1.2.0/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
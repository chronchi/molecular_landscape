{
  "hash": "4aa8af700c5009676cafe8f1d7644071",
  "result": {
    "markdown": "# Pathway activity in a personalized context\n\nThis chapter we present a new way to think about the personalized medicine,\nby incorporating patient molecular information and its context. \nWe saw previously that by using different cohorts, we can embed new patients\ninto a point cloud. The idea is that the neighborhood of the patients \nare similar in the molecular level, and we can draw conclusions based on\nthis. \n\nEach patient can be assigned a score. Scores represent a biological\npathway, or in other words, a biological activity. Given a biological\nprocess, there is usually a set of genes that represent it. We\ncan then use these set of genes to calculate scores that are \nproxies of this biological activity.\n\nFor example, in the previous chapters we used the ER signaling\nscores to motivate the continuity of ER signaling. This is not\nrestricted to this specific pathway, we could have used any\nother list of genes representing a process. \n\nBy combining a score and the neighborhood of a patient, we \ncan make direct comparisons and questions. Given a patient,\nhow different is its score for a pathway compared to its\nneighbors? Is there also an alternative pathway that could\nbe target and has a higher signaling? In this case \nspecifically, is ER signaling more or less expressed compared\nto its neighbors? \n\nThe POETIC trial [@Gao2019] \nis a breast cancer trial that had as hypothesis\nneoadjuvant therapy could improve overall and recurrence free\nsurvival. They gave aromatase inhibitors (AIs) for ER+ BC patients\nfor 2 weeks prior to surgery and then 2 weeks after surgery.\nMoreover, they collected a needle biopsy before the\ntreatment started and a biopsy in the surgery. They\nalso measured the Ki67 levels, therefore we have a proxy\non how well these patients responded in the short term to \nAIs. Also, they sent the tissues for sequencing, so \nmicroarray data is available. This is a unique \ncohort, in the sense that we can understand what are the\nresponders or not, in terms of Ki67 levels, and use\nthe molecular data to try to understand the responsiveness. \nThe definition of responders are those patients that have a \nreduction of at least 60\\%\nin Ki67 levels when comparing pre-treatment versus surgery. \n\nHere we use this cohort to draw conclusions on responders\nand non responders and how the molecular landscape can be \nused. We show that some patients that are close to each\nother in the molecular landscape can have different\npathway scores and therefore have different responses.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n* The library is already synchronized with the lockfile.\n```\n:::\n:::\n\n\n## Calculating scores in neighborhoods\n\nPatients close to each other in the molecular landscape are somewhat\nmolecularly close, due to how the embedding works. Therefore, we can \nlook at patients in a neighborhood and calculate the average scores,\nto see what it means to be in a specific neighborhood. \n\nTo do this, we define a radius for a patient where all the patients\nwithin the euclidean ball with this radius will be selected and an \naverage score distribution is calculated.\n\nTo calculate the average score distribution we use the `rstanarm` package. \nWe set the prior distribution for the intercept to be a normal distribution\ncentered at 0 with standard deviation of 1. All scores are in a range of\n-1 to 1, so this is a relatively flat prior for our use case.\n\nThe video below shows how scores change in average when comparing different\nneighborhoods. \n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"../results/plots/scoring/movie/01.png\"\n [2] \"../results/plots/scoring/movie/02.png\"\n [3] \"../results/plots/scoring/movie/03.png\"\n [4] \"../results/plots/scoring/movie/04.png\"\n [5] \"../results/plots/scoring/movie/05.png\"\n [6] \"../results/plots/scoring/movie/06.png\"\n [7] \"../results/plots/scoring/movie/07.png\"\n [8] \"../results/plots/scoring/movie/08.png\"\n [9] \"../results/plots/scoring/movie/09.png\"\n[10] \"../results/plots/scoring/movie/10.png\"\n[11] \"../results/plots/scoring/movie/11.png\"\n[12] \"../results/plots/scoring/movie/12.png\"\n[13] \"../results/plots/scoring/movie/13.png\"\n[14] \"../results/plots/scoring/movie/14.png\"\n[15] \"../results/plots/scoring/movie/15.png\"\n[16] \"../results/plots/scoring/movie/16.png\"\n[17] \"../results/plots/scoring/movie/17.png\"\n[18] \"../results/plots/scoring/movie/18.png\"\n[19] \"../results/plots/scoring/movie/19.png\"\n[20] \"../results/plots/scoring/movie/20.png\"\n```\n:::\n:::\n\n\n\n\nGoing from right to left it shows how ER signaling is decreased. From top to\nbottom there is a reduction of proliferation, E2F targets, and a change in\nEMT and TGFb signaling. These are representative scores, other pathways could\nbe used as well. \n\n## POETIC embedding\n\nIn this section we show the embedding of the POETIC trial samples.\nBut first we analyse some basic properties of the dataset.\nThe data for this dataset was downloaded and processed\nas described at \n[chronchi.github.io/transcriptomics](https://chronchi.github.io/transcriptomics/)\nin the chapter AI - GSE105777. \n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\nTotal number of stable genes: 39\nTotal number of genes: 1008\nNumber of samples: 426\n```\n:::\n:::\n\n\n### Number of samples\n\nIn this dataset there are matched samples from patients that \nare treated and untreated. @tbl-pt-poetic-nb\n\n\n::: {#tbl-pt-poetic-nb .cell tbl-cap='Table showing the number of samples for treated and untreated patients'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> group </th>\n   <th style=\"text-align:right;\"> n </th>\n   <th style=\"text-align:right;\"> percent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> treated </td>\n   <td style=\"text-align:right;\"> 157 </td>\n   <td style=\"text-align:right;\"> 74 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> untreated </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 26 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nIn this cohort, there is the PAM50 molecular subtype available\nfor the untreated. @tbl-pt-poetic-pam50 shows the\nnumber of patients for each subtype.\n\n\n::: {#tbl-pt-poetic-pam50 .cell tbl-cap='Table showing the number of molecular subtypes for each group.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> pam50 </th>\n   <th style=\"text-align:right;\"> n </th>\n   <th style=\"text-align:right;\"> percent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> her2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.235 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> luma </td>\n   <td style=\"text-align:right;\"> 77 </td>\n   <td style=\"text-align:right;\"> 18.075 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lumb </td>\n   <td style=\"text-align:right;\"> 31 </td>\n   <td style=\"text-align:right;\"> 7.277 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> normal </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 0.704 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> not_available </td>\n   <td style=\"text-align:right;\"> 314 </td>\n   <td style=\"text-align:right;\"> 73.709 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe numbers differ from previously, since the molecular subtype is \ncalculated for each sample, so two molecular subtypes for each patient. \n\n### Proportion of top loadings\n\n\n::: {.cell}\n\n:::\n\n\nThere are in total 1008 genes available out\nof the . Among them, \n39 are\nthe housekeeping genes. Out of the\n36 genes missing,\na total number of 8 are missing from the\ntop 200 PC3 loadings, a proportion of \n4\\%. \nA total number of 5 are missing from the\ntop 200 PC4 loadings, a proportion of \n2\\%. These\nare very small proportions, and we have seen from the last chapter that\nthey will not affect the position of the patients in the embedding.\n\n### Embedding \n\n@fig-pca-poetic-er-pam50 shows a good mixing of the POETIC sample and how\nall the patients are scattered across the whole landscape. Here all samples\nare plotted, meaning that every two dots correspond to a single patient.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![PCA embedding of all samples from TCGA, SCANB and METABRIC including the POETIC samples on top. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype.](scoring_files/figure-html/fig-pca-poetic-er-pam50-1.png){#fig-pca-poetic-er-pam50 width=1824}\n:::\n:::\n\n\n@fig-pca-responders-baseline shows the embedding of baseline samples\nfrom patients that received endocrine therapy prior to surgery. \nPatients on the left part of the molecular landscape are considered to\nbe non responders, this coincides with the fact this region corresponds\nto the ER- BC patients.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![PCA embedding of all samples from TCGA, SCANB and METABRIC including the POETIC samples on top. POETIC samples correspond to only baseline treated patients.](scoring_files/figure-html/fig-pca-responders-baseline-1.png){#fig-pca-responders-baseline width=960}\n:::\n:::\n\n\nAnd when checking the first two components, the POETIC data is closer to\nMETABRIC, which makes sense since both are microarrays, as it can be seen\nin @fig-poetic-cohort.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Biplot of first two PCA components from POETIC, TCGA, SCANB and METABRIC. POETIC is highlighted in the plot and has a bigger point.](scoring_files/figure-html/fig-poetic-cohort-1.png){#fig-poetic-cohort width=672}\n:::\n:::\n\n\n### Differences in PC3 for responders and non responders\n\nWe now also compare the differences in non responders vs responders\naccording to the third component. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](scoring_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 93\n $ line                      :List of 6\n  ..$ colour       : chr \"black\"\n  ..$ size         : num 0.5\n  ..$ linetype     : num 1\n  ..$ lineend      : chr \"butt\"\n  ..$ arrow        : logi FALSE\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_line\" \"element\"\n $ rect                      :List of 5\n  ..$ fill         : chr \"white\"\n  ..$ colour       : chr \"black\"\n  ..$ size         : num 0.5\n  ..$ linetype     : num 1\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ text                      :List of 11\n  ..$ family       : chr \"\"\n  ..$ face         : chr \"plain\"\n  ..$ colour       : chr \"black\"\n  ..$ size         : num 11\n  ..$ hjust        : num 0.5\n  ..$ vjust        : num 0.5\n  ..$ angle        : num 0\n  ..$ lineheight   : num 0.9\n  ..$ margin       : 'margin' num [1:4] 0points 0points 0points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : logi FALSE\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ title                     : NULL\n $ aspect.ratio              : NULL\n $ axis.title                : NULL\n $ axis.title.x              :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : num 1\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 2.75points 0points 0points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.title.x.top          :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : num 0\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 0points 2.75points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.title.x.bottom       : NULL\n $ axis.title.y              :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : num 1\n  ..$ angle        : num 90\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 2.75points 0points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.title.y.left         : NULL\n $ axis.title.y.right        :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : num 0\n  ..$ angle        : num -90\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 0points 0points 2.75points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.text                 :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : chr \"grey30\"\n  ..$ size         : 'rel' num 0.8\n  ..$ hjust        : NULL\n  ..$ vjust        : NULL\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : NULL\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.text.x               :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : num 1\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 2.2points 0points 0points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.text.x.top           :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : num 0\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 0points 2.2points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.text.x.bottom        : NULL\n $ axis.text.y               :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : num 1\n  ..$ vjust        : NULL\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 2.2points 0points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.text.y.left          : NULL\n $ axis.text.y.right         :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : num 0\n  ..$ vjust        : NULL\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 0points 0points 2.2points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ axis.ticks                :List of 6\n  ..$ colour       : chr \"grey20\"\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ lineend      : NULL\n  ..$ arrow        : logi FALSE\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_line\" \"element\"\n $ axis.ticks.x              : NULL\n $ axis.ticks.x.top          : NULL\n $ axis.ticks.x.bottom       : NULL\n $ axis.ticks.y              : NULL\n $ axis.ticks.y.left         : NULL\n $ axis.ticks.y.right        : NULL\n $ axis.ticks.length         : 'simpleUnit' num 2.75points\n  ..- attr(*, \"unit\")= int 8\n $ axis.ticks.length.x       : NULL\n $ axis.ticks.length.x.top   : NULL\n $ axis.ticks.length.x.bottom: NULL\n $ axis.ticks.length.y       : NULL\n $ axis.ticks.length.y.left  : NULL\n $ axis.ticks.length.y.right : NULL\n $ axis.line                 : list()\n  ..- attr(*, \"class\")= chr [1:2] \"element_blank\" \"element\"\n $ axis.line.x               : NULL\n $ axis.line.x.top           : NULL\n $ axis.line.x.bottom        : NULL\n $ axis.line.y               : NULL\n $ axis.line.y.left          : NULL\n $ axis.line.y.right         : NULL\n $ legend.background         :List of 5\n  ..$ fill         : NULL\n  ..$ colour       : logi NA\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ legend.margin             : 'margin' num [1:4] 5.5points 5.5points 5.5points 5.5points\n  ..- attr(*, \"unit\")= int 8\n $ legend.spacing            : 'simpleUnit' num 11points\n  ..- attr(*, \"unit\")= int 8\n $ legend.spacing.x          : NULL\n $ legend.spacing.y          : NULL\n $ legend.key                :List of 5\n  ..$ fill         : chr \"white\"\n  ..$ colour       : logi NA\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ legend.key.size           : 'simpleUnit' num 1.2lines\n  ..- attr(*, \"unit\")= int 3\n $ legend.key.height         : NULL\n $ legend.key.width          : NULL\n $ legend.text               :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : 'rel' num 0.8\n  ..$ hjust        : NULL\n  ..$ vjust        : NULL\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : NULL\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ legend.text.align         : NULL\n $ legend.title              :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : num 0\n  ..$ vjust        : NULL\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : NULL\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ legend.title.align        : NULL\n $ legend.position           : chr \"right\"\n $ legend.direction          : NULL\n $ legend.justification      : chr \"center\"\n $ legend.box                : NULL\n $ legend.box.just           : NULL\n $ legend.box.margin         : 'margin' num [1:4] 0cm 0cm 0cm 0cm\n  ..- attr(*, \"unit\")= int 1\n $ legend.box.background     : list()\n  ..- attr(*, \"class\")= chr [1:2] \"element_blank\" \"element\"\n $ legend.box.spacing        : 'simpleUnit' num 11points\n  ..- attr(*, \"unit\")= int 8\n $ panel.background          :List of 5\n  ..$ fill         : chr \"white\"\n  ..$ colour       : logi NA\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ panel.border              :List of 5\n  ..$ fill         : logi NA\n  ..$ colour       : chr \"grey20\"\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ panel.spacing             : 'simpleUnit' num 5.5points\n  ..- attr(*, \"unit\")= int 8\n $ panel.spacing.x           : NULL\n $ panel.spacing.y           : NULL\n $ panel.grid                :List of 6\n  ..$ colour       : chr \"grey92\"\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ lineend      : NULL\n  ..$ arrow        : logi FALSE\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_line\" \"element\"\n $ panel.grid.major          : NULL\n $ panel.grid.minor          :List of 6\n  ..$ colour       : NULL\n  ..$ size         : 'rel' num 0.5\n  ..$ linetype     : NULL\n  ..$ lineend      : NULL\n  ..$ arrow        : logi FALSE\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_line\" \"element\"\n $ panel.grid.major.x        : NULL\n $ panel.grid.major.y        : NULL\n $ panel.grid.minor.x        : NULL\n $ panel.grid.minor.y        : NULL\n $ panel.ontop               : logi FALSE\n $ plot.background           :List of 5\n  ..$ fill         : NULL\n  ..$ colour       : chr \"white\"\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ plot.title                :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : 'rel' num 1.2\n  ..$ hjust        : num 0\n  ..$ vjust        : num 1\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 0points 5.5points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ plot.title.position       : chr \"panel\"\n $ plot.subtitle             :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : num 0\n  ..$ vjust        : num 1\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 0points 0points 5.5points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ plot.caption              :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : 'rel' num 0.8\n  ..$ hjust        : num 1\n  ..$ vjust        : num 1\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 5.5points 0points 0points 0points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ plot.caption.position     : chr \"panel\"\n $ plot.tag                  :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : 'rel' num 1.2\n  ..$ hjust        : num 0.5\n  ..$ vjust        : num 0.5\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : NULL\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ plot.tag.position         : chr \"topleft\"\n $ plot.margin               : 'margin' num [1:4] 5.5points 5.5points 5.5points 5.5points\n  ..- attr(*, \"unit\")= int 8\n $ strip.background          :List of 5\n  ..$ fill         : chr \"grey85\"\n  ..$ colour       : chr \"grey20\"\n  ..$ size         : NULL\n  ..$ linetype     : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_rect\" \"element\"\n $ strip.background.x        : NULL\n $ strip.background.y        : NULL\n $ strip.placement           : chr \"inside\"\n $ strip.text                :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : chr \"grey10\"\n  ..$ size         : 'rel' num 0.8\n  ..$ hjust        : NULL\n  ..$ vjust        : NULL\n  ..$ angle        : NULL\n  ..$ lineheight   : NULL\n  ..$ margin       : 'margin' num [1:4] 4.4points 4.4points 4.4points 4.4points\n  .. ..- attr(*, \"unit\")= int 8\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ strip.text.x              : NULL\n $ strip.text.y              :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : NULL\n  ..$ angle        : num -90\n  ..$ lineheight   : NULL\n  ..$ margin       : NULL\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n $ strip.switch.pad.grid     : 'simpleUnit' num 2.75points\n  ..- attr(*, \"unit\")= int 8\n $ strip.switch.pad.wrap     : 'simpleUnit' num 2.75points\n  ..- attr(*, \"unit\")= int 8\n $ strip.text.y.left         :List of 11\n  ..$ family       : NULL\n  ..$ face         : NULL\n  ..$ colour       : NULL\n  ..$ size         : NULL\n  ..$ hjust        : NULL\n  ..$ vjust        : NULL\n  ..$ angle        : num 90\n  ..$ lineheight   : NULL\n  ..$ margin       : NULL\n  ..$ debug        : NULL\n  ..$ inherit.blank: logi TRUE\n  ..- attr(*, \"class\")= chr [1:2] \"element_text\" \"element\"\n - attr(*, \"class\")= chr [1:2] \"theme\" \"gg\"\n - attr(*, \"complete\")= logi TRUE\n - attr(*, \"validate\")= logi TRUE\n```\n:::\n:::\n\n\n\n## Scoring all samples \n\nIn the last chapters scores were showed for TCGA, SCANB and \nMETABRIC. @fig-pca-seterpr shows how ER signaling changes as patients\nmove across the molecular landscape. We intend to use the scores now for the\nPOETIC samples. We first start by calculating using GSVA as well and include\nin the dataframe with the other cohorts. Before moving to the next chapter,\nwe will analyse and compare the scores across the responders and non \nresponders. \n\n@fig-scores-poetic-er shows that when using the scores, it looks like\nin average at baseline $SET_{ER/PR}$ is lower in non responders than\nin responders. For the other scores there is no clear difference.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\nSetting parallel calculations through a MulticoreParam back-end\nwith workers=20 and tasks=100.\nEstimating GSVA scores for 53 gene sets.\nEstimating ECDFs with Gaussian kernels\nEstimating ECDFs in parallel on 20 cores\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |=                                                                     |   2%\n  |                                                                            \n  |===                                                                   |   4%\n  |                                                                            \n  |====                                                                  |   6%\n  |                                                                            \n  |=====                                                                 |   8%\n  |                                                                            \n  |=======                                                               |   9%\n  |                                                                            \n  |========                                                              |  11%\n  |                                                                            \n  |=========                                                             |  13%\n  |                                                                            \n  |===========                                                           |  15%\n  |                                                                            \n  |============                                                          |  17%\n  |                                                                            \n  |=============                                                         |  19%\n  |                                                                            \n  |===============                                                       |  21%\n  |                                                                            \n  |================                                                      |  23%\n  |                                                                            \n  |=================                                                     |  25%\n  |                                                                            \n  |==================                                                    |  26%\n  |                                                                            \n  |====================                                                  |  28%\n  |                                                                            \n  |=====================                                                 |  30%\n  |                                                                            \n  |======================                                                |  32%\n  |                                                                            \n  |========================                                              |  34%\n  |                                                                            \n  |=========================                                             |  36%\n  |                                                                            \n  |==========================                                            |  38%\n  |                                                                            \n  |============================                                          |  40%\n  |                                                                            \n  |=============================                                         |  42%\n  |                                                                            \n  |==============================                                        |  43%\n  |                                                                            \n  |================================                                      |  45%\n  |                                                                            \n  |=================================                                     |  47%\n  |                                                                            \n  |==================================                                    |  49%\n  |                                                                            \n  |====================================                                  |  51%\n  |                                                                            \n  |=====================================                                 |  53%\n  |                                                                            \n  |======================================                                |  55%\n  |                                                                            \n  |========================================                              |  57%\n  |                                                                            \n  |=========================================                             |  58%\n  |                                                                            \n  |==========================================                            |  60%\n  |                                                                            \n  |============================================                          |  62%\n  |                                                                            \n  |=============================================                         |  64%\n  |                                                                            \n  |==============================================                        |  66%\n  |                                                                            \n  |================================================                      |  68%\n  |                                                                            \n  |=================================================                     |  70%\n  |                                                                            \n  |==================================================                    |  72%\n  |                                                                            \n  |====================================================                  |  74%\n  |                                                                            \n  |=====================================================                 |  75%\n  |                                                                            \n  |======================================================                |  77%\n  |                                                                            \n  |=======================================================               |  79%\n  |                                                                            \n  |=========================================================             |  81%\n  |                                                                            \n  |==========================================================            |  83%\n  |                                                                            \n  |===========================================================           |  85%\n  |                                                                            \n  |=============================================================         |  87%\n  |                                                                            \n  |==============================================================        |  89%\n  |                                                                            \n  |===============================================================       |  91%\n  |                                                                            \n  |=================================================================     |  92%\n  |                                                                            \n  |==================================================================    |  94%\n  |                                                                            \n  |===================================================================   |  96%\n  |                                                                            \n  |===================================================================== |  98%\n  |                                                                            \n  |======================================================================| 100%\n```\n:::\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![Baseline scores for all treated patients in the POETIC trial. G2M corresponds to a proliferation score, EMT to epithelial to mesenchymal transition score and the others are related to ER signaling.](scoring_files/figure-html/fig-scores-poetic-er-1.png){#fig-scores-poetic-er width=1248}\n:::\n:::\n\n\nWe see that for PC3 and SET ER/PR There are some\ndifferences in terms of the responders and non responders.\n\nLet us take a closer look at those patients. We start\nby plotting the scatter plot of PC3 vs SET ER/PR and color\nby response status defined by the POETIC trial. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![Comparison of the third component with SET ER/PR scores colored by response status.](scoring_files/figure-html/fig-scores-poetic-responders-1.png){#fig-scores-poetic-responders width=672}\n:::\n:::\n\n\nThis figure shows that there is a correlation between\nthird component and SET ER/PR for the POETIC trial data\nas well as it was already seen from the other cohorts. \nMoreover, it seems that the responders have higher PC scores\nin general. We now correlate for each subgroup (responder and non \nresponders) the PC3 and the change in percentage for Ki67.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Correlation between change in Ki67 versus PC3 stratified by response group.](scoring_files/figure-html/fig-scores-corr-poetic-1.png){#fig-scores-corr-poetic width=960}\n:::\n:::\n\n\nNow another metric we can calculate from our dataset is the difference\nof the embedding positions \nbetween the different samples of the same patient. The idea is that if a \npatient responded well, there were bigger changes as well in the\ntranscriptomics and that is reflected in the embedding. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![Differences of the embeddings for each patient individually stratified by response status. Each dot corresponds to a single patient.](scoring_files/figure-html/fig-diff-embedding-poetic-1.png){#fig-diff-embedding-poetic width=960}\n:::\n:::\n\n\nAnd now we perform a comparison of these positions by using\nrstanarm to get the posterior distributions of the differences.\n\n\n::: {.cell}\n\n:::\n\n\nThe figure below shows the distribution of the averages of the differences\nin the embedding of the projections.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Differences of the embeddings for each patient individually stratified by response status. Each dot corresponds to a single patient.](scoring_files/figure-html/fig-diff-embedding-poetic-averages-1.png){#fig-diff-embedding-poetic-averages width=672}\n:::\n:::\n\n\nAnd the figure below shows the posterior distribution of the differences\nin average.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Differences of the average differences in the embedding for each patient individually. The comparison made was non responder vs responder, which means that if non responder has a lower difference in average, the difference in difference will be negative.](scoring_files/figure-html/fig-diff-embedding-poetic-averages-diff-1.png){#fig-diff-embedding-poetic-averages-diff width=672}\n:::\n:::\n\n\n## Analysing patient neighborhoods\n\nThere are two ways to interpret the embedding. If the patient has\nER+ BC and its embedding is close to the ER- BC patients, we can\ninfer that the endocrine response might not work so well, as \nit was shown in @fig-pca-responders-baseline. The other option\nis to compare the patient's score to the average score of \nits neighborhood.\n\nWhat is a neighborhood? When performing the embedding, global\nstructures are not preserved usually. In this sense we only\ncompare patients that are close to each other in an euclidean \nneighborhood, i.e., we calculate a radius around each sample and\nsee what other samples are within this ball given the euclidean\ndistance.\n\nGiven a neighborhood, one can calculate the posterior average score\nof all samples from METABRIC, SCANB and TCGA and use that as an \nindication of average score that we can compare other patients to.\nThe concept is that if an ER+ BC patient has a much lower ER signaling\nscore, it means the patients will not respond so well to endocrine \ntherapy, as they are very different from their neighboors.\n\nTo showcase the ability to use the scores and infer results, we \nuse the POETIC trial patients to compare the scores. This cohort\nis special in the sense that the patients are filtered based on\nselection criterias, meaning that the patients are clinically\nsimilar. \n\nTwo random patients in very close neighborhoods were selected\nto showcase the ability of the molecular landscape.\nThe id of the patients are 63 and 236.\n@tbl-pt63-236 shows the clinical features of these patients. One\nof them is HER2+. Patient 63 had a higher Ki67 baseline level but\na very good response to endocrine therapy. Patient 236 did not \nrespond to endocrine therapy in terms of reduction of Ki67 levels.\n\n\n::: {#tbl-pt63-236 .cell tbl-cap='Clinical features from patients 63 and 236.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> patient_nb </th>\n   <th style=\"text-align:left;\"> er_status </th>\n   <th style=\"text-align:left;\"> her2_status </th>\n   <th style=\"text-align:right;\"> ki67 </th>\n   <th style=\"text-align:right;\"> change_ki67 </th>\n   <th style=\"text-align:left;\"> ccca_surgery_ki67_2_7 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 63 </td>\n   <td style=\"text-align:left;\"> pos </td>\n   <td style=\"text-align:left;\"> Positive </td>\n   <td style=\"text-align:right;\"> 16.60702 </td>\n   <td style=\"text-align:right;\"> -69.958509 </td>\n   <td style=\"text-align:left;\"> noCCCA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 236 </td>\n   <td style=\"text-align:left;\"> pos </td>\n   <td style=\"text-align:left;\"> Negative </td>\n   <td style=\"text-align:right;\"> 11.30906 </td>\n   <td style=\"text-align:right;\"> 5.593711 </td>\n   <td style=\"text-align:left;\"> noCCCA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n@fig-pt63-236 shows the embedding of two distinct patients \nin a similar neighborhood.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Plot of two selected patients in the molecular landscape. One is a responder and the other is a non responder. The patient id numbers are 63 and 236.](scoring_files/figure-html/fig-pt63-236-1.png){#fig-pt63-236 width=960}\n:::\n:::\n\n\n\nAnd now we calculate the average scores for each patient neighborhoods. We \nstart by defining a radius value. After that we select the patients in the\nneighborhood and use `rstanarm` to get the posterior distribution of the\naverage score in the neighborhood. For this we use the function\n`stan_glm` to calculate the average. This is effective because it can\nbe paired with the package `tidybayes` for plotting. It makes extremely easy\nto deal with posterior data. For the average we use a \nnormal prior centered at 0 with 1 standard deviation, \nsince all scores are between -1 and 1.\n\n\n::: {.cell}\n\n:::\n\n\nPatient 63 @fig-pt63 is considered a responder. According to \nthe scores, when comparing the estrogen early signature to its average \ndistribution in the neighborhood, the score is higher.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Posterior distribution of the average scores in the neighborhood of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.](scoring_files/figure-html/fig-pt63-1.png){#fig-pt63 width=960}\n:::\n:::\n\n\nPatient 236 @fig-pt236 was considered a non responder. According to \nthe scores, when comparing the estrogen early signature to its average \ndistribution in the neighborhood, the score is lower, being in the\n5% quantile.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Posterior distribution of the average scores in the neighborhood of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.](scoring_files/figure-html/fig-pt236-1.png){#fig-pt236 width=960}\n:::\n:::\n\n\nWhen comparing these two patients, there is also a difference in the androgen\nresponse score, which could be a reflection of different estrogen signaling.",
    "supporting": [
      "scoring_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
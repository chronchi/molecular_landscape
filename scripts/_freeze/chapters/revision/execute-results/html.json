{
  "hash": "d4eabaea010a2b00d9c039a44d46ac29",
  "result": {
    "engine": "knitr",
    "markdown": "# Revision\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n* The library is already synchronized with the lockfile.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    ../../results/plots/revision ../../results/rds_files/revision \n                           FALSE                            FALSE \n   ../../results/tables/revision \n                           FALSE \n```\n\n\n:::\n:::\n\n\n## Comparing to combat's performance\n\nWe know that the first two components of PCA correspond to cohort and platform\nspecific effects. We can apply combat from the sva package on the unnormalized\ndata.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\nWe now check what is the relationship between the PC1 and PC2 from \ncombat to the actual PCs from EMBER. \n\n\n::: {.cell}\n\n:::\n\n\nAnd the spearman correlation is for PC3 and PC1: \n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-combat-comparison-1.png){#fig-combat-comparison width=960}\n:::\n:::\n\n\nIn a nutshell, the EMBER position corresponds to what is obtained by combat,\nwith the advantage that we can actually use the embedding for new samples. \nCombat is restricted to the samples inputted.\n\n## Autoencoders\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n\nH2O is not running yet, starting it now...\n\nNote:  In case of errors look at the following log files:\n    /tmp/RtmptVtdKF/filedbe81b4b82f9/h2o_ronchi_started_from_r.out\n    /tmp/RtmptVtdKF/filedbe814b09f213/h2o_ronchi_started_from_r.err\n\n\nStarting H2O JVM and connecting: .. Connection successful!\n\nR is connected to the H2O cluster: \n    H2O cluster uptime:         1 seconds 327 milliseconds \n    H2O cluster timezone:       Europe/Zurich \n    H2O data parsing timezone:  UTC \n    H2O cluster version:        3.44.0.3 \n    H2O cluster version age:    6 months and 1 day \n    H2O cluster name:           H2O_started_from_R_ronchi_hva325 \n    H2O cluster total nodes:    1 \n    H2O cluster total memory:   20.00 GB \n    H2O cluster total cores:    32 \n    H2O cluster allowed cores:  32 \n    H2O cluster healthy:        TRUE \n    H2O Connection ip:          localhost \n    H2O Connection port:        54321 \n    H2O Connection proxy:       NA \n    H2O Internal Security:      FALSE \n    R Version:                  R version 4.2.0 (2022-04-22) \n```\n\n\n:::\n:::\n\n\nFeatures are the columns and the rows are the samples. So for the \ngenomic data we have to transpose it.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-first-autoencoder-1.png){#fig-first-autoencoder width=672}\n:::\n:::\n\n\nJust using the autoencoder in the data does not work. \n\nWe now use on the normalized data instead on 4 units in the hidden\nlayer.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-second-ae-cohort-1.png){#fig-second-ae-cohort width=672}\n:::\n:::\n\n\nAnd now coloring by er status. It is not really able to completely distinguish\nthe ER+ and ER- samples.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-second-ae-erstatus-1.png){#fig-second-ae-erstatus width=672}\n:::\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/unnamed-chunk-14-1.png){width=1344}\n:::\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-ae-4-units-ae-1.png){#fig-ae-4-units-ae width=1920}\n:::\n:::\n\n\n\nWe do a pairsplot coloring by cohort to see where the distinction between\ncohorts is coming from. \n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-ggpairs-4-units-ae-cohort-1.png){#fig-ggpairs-4-units-ae-cohort width=672}\n:::\n:::\n\n\nAnd now coloring by ER status instead.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-ggpairs-4-units-ae-erihc-1.png){#fig-ggpairs-4-units-ae-erihc width=672}\n:::\n:::\n\n\nPerhaps now if we include more layers instead and use 4 components.\n\n\n::: {.cell}\n\n:::\n\n\nIn terms of mean squared error all the models are very similar to each other.\nAnd based on the previous results it seems that by using \n\n\n::: {.cell}\n\n:::\n\n\n## Mixing analysis \n\nIn this section we try to understand what is the minimum number of genes\nnecessary to be able to distinguish ER+ and ER- BC samples. We select\nthe top 10, 25, 50, 100, 200, 500, 750, 1000, 2500, 5000 and all the genes and\ntry to classify the samples bewteen ER+ and ER- based on their position of the\nthird component. This should give an idea of how good the embedding is based\non the number of genes.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-pca-nb-genes-1.png){#fig-pca-nb-genes width=2688}\n:::\n:::\n\n\nUsing less than 25 genes mixes well the cohorts in the first two \ncomponents. When using more than 50 genes the mixing is already \nlost in the first two components. So what we actually want is a mixing\nin just one of the pairs of components, either PC1+PC2 or PC3+PC4 while there\nis no mixing in the other pair of component. By analysing visually this happens\nwhen using at least 1000 genes.\n\n\n::: {.cell}\n\n:::\n\n\nDue to the difference in cohort sizes, METABRIC has 648 samples and \nTCGA 352, the expected iLISI coefficient is:\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.84\n```\n\n\n:::\n:::\n\n\nThe expected value for the iLISI coefficient when calculating for \nER status is: \n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.59\n```\n\n\n:::\n:::\n\n\nAnd the plot below shows the iLISI numbers for each combination of PC1+PC2 and\nPC3+PC4 annotated by the total number of genes. An integration by ER\nstatus means that the combination of components is not capturing the biology.\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-lisi-scores-1.png){#fig-lisi-scores width=768}\n:::\n:::\n\n\n## Stable genes\n\nOne of the raised issues is that the average ranking of the stable genes\nmight depend on phenotypes. Here we show that the distribution of average\nof stable genes is stable across different phenotypes, such as ER status and\nmolecular subtype.\n\n\n::: {.cell}\n\n:::\n\n\nFirst we plot by ER status in both METABRIC and TCGA.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-avg-rank-er-ihc-1.png){#fig-avg-rank-er-ihc width=384}\n:::\n:::\n\n\n## Scaling\n\nWe now show the embedding using no scaling, i.e., just log FPKM and median\nintensity, using the qPCR like normalization and using a z-normalization\non the sample level.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-comparison-plots-1.png){#fig-comparison-plots width=1920}\n:::\n:::\n\n\nAnd now we compare the iLISI scores of the qPCR-like normalization and z-scaling\nas well.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-differences-scaling-1.png){#fig-differences-scaling width=480}\n:::\n:::\n\n\n## Tumor purity: statistical tests\n\nOne of the points raised by the reviewers was about the statistics\non the differences between the principal components stratified by \nmolecular subtype. We perform ANOVA followed by a Tukey post hoc \ntest.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-tumor-purity-metabric-1.png){#fig-tumor-purity-metabric width=1344}\n:::\n:::\n\n\n## Metastasis and FFPE data\n\nAccessed 20240425:\nhttps://www.cbioportal.org/study/summary?id=brca_mbcproject_2022\n\nIn the cBioportal one can check the clinical data directly with\nall the information. When hovering over the column names it is possible\nto obtain the column names from the data available when downloaded. \nFor example, the ER percentage is available from the sample in the diagnostics.\nKi67, similarly. In general the metastasis do not have ER percentage.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-c4332e9aaaae30e16c2c\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-c4332e9aaaae30e16c2c\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\"],[\"ASCENDING COLON - FALLOPIAN TUBE\",\"AXILLARY LYMPH NODE - AXILLARY LYMPH NODE - LYMPH NODE DISTANT\",\"AXILLARY LYMPH NODE - BREAST\",\"AXILLARY LYMPH NODE - BREAST - BREAST\",\"AXILLARY LYMPH NODE - BREAST - PLEURAL FLUID\",\"BONE - BREAST\",\"BRAIN - BREAST\",\"BREAST - BREAST\",\"BREAST - BREAST - BREAST\",\"BREAST - BREAST - LIVER\",\"BREAST - BREAST SKIN\",\"BREAST - CHEST WALL\",\"BREAST - LIVER\"],[1,1,2,1,1,2,1,11,4,1,1,2,1],[0.03448275862068965,0.03448275862068965,0.06896551724137931,0.03448275862068965,0.03448275862068965,0.06896551724137931,0.03448275862068965,0.3793103448275862,0.1379310344827586,0.03448275862068965,0.03448275862068965,0.06896551724137931,0.03448275862068965]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>matched_samples<\\/th>\\n      <th>n<\\/th>\\n      <th>percent<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nWe now try to understand if samples are coming from core biopsy, \nsurgical procedures or from a metastasis setting. To start with that, \nwe look at a single patient ID that has two breast samples.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n  BX_TIME_DAYS CALC_TREATMENT_NAIVE    BX_TYPE\n1            0                  YES       CORE\n2          114                   NO MASTECTOMY\n```\n\n\n:::\n:::\n\n\nFor patient with ID `MBCProject_4MF1FlFQ`, there are two samples. One\nat time of diagnosis, core biopsy, and the other at a mastectomy after\n114 days of treatment. The column CALC_TREATMENT_NAIVE tells if the sample\nis treatment naive or not, BX_TYPE corresponds to the type of surgery \n(PATH Procedure Type column on cBioPortal).\n\nWe now look at another patient (`MBCProject_5gHasou8`):\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n  BX_TIME_DAYS CALC_TREATMENT_NAIVE    BX_TYPE\n1            0                  YES       CORE\n2          199                   NO MASTECTOMY\n```\n\n\n:::\n:::\n\n\nThe results are similar for this patient too. We now move on and use\nEMBER on all available samples and then compare these matched samples.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal number of stable genes: 44\nTotal number of genes: 1037\nNumber of samples: 153\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\nWe show all the samples from the project below on top of TCGA,\nSCAN-B and METABRIC.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-er-ihc-mets-project-1.png){#fig-er-ihc-mets-project width=864}\n:::\n:::\n\n\nAnd now stratified by either local metastasis/primary sample\nor by distant metastasis.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-mets-local-distant-1.png){#fig-mets-local-distant width=1152}\n:::\n:::\n\n\nBoth combined for the response to reviewers:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/unnamed-chunk-44-1.png){width=1920}\n:::\n:::\n\n\n\n## TNBC and ER+ \n\nHere we use another cohort with both ER+ and ER- samples coming from\nFFPE with two different library preparation protocols: Illumina-Access and\nNugen-Ovation.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal number of stable genes: 44\nTotal number of genes: 1022\nNumber of samples: 21\n```\n\n\n:::\n:::\n\n\nWe now show the samples highlighted on top of EMBER space with \nsamples from TCGA and METABRIC.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-illumina-nugen-1.png){#fig-illumina-nugen width=1056}\n:::\n:::\n\n\n## SCAN-B library protocol\n\nSCAN-B has 3 different types of samples based on their \nlibrary protocol, namely: dUTP, NeoPrep and TruSeq.\n\nHere we show that EMBER is capable of fully removing any\neffects associated to library protocol.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-scanb-libprep-1.png){#fig-scanb-libprep width=864}\n:::\n:::\n\n\n## Scaling before doing PCA\n\nWhen developing EMBER we did not center or scale the data, as the gene\nexpressions after normalization all had the same range. Here we compare\nwhat happens when doing the centering followed by the scaling and then \napplying PCA.\n\n\n::: {.cell}\n\n:::\n\n\nTo understand the effect of centering and scaling \nthe data prior to applying PCA, we compared the loadings \nof PC1 from EMBER to the average of the genes in the\nnormalized data (a). The correlation between these two\nvariables is -1, showing that PC1 corresponds to\ncentering. When comparing the loadings with PC2 and \nthe standard deviation of genes after centering, the\nhigher loadings in absolute value are correlated with\nhigher standard deviation (b). \n\nNext, we show that PC1 and PC2 are correlated with\nPC1 obtained after centering and scaling the data\n(c), showing that EMBER’s PC1 and PC2 is\nautomatically centering and scaling the data \nat the same time removing batch effects. \nIn order to confirm that no biological information \nis lost when performing PCA on the \nuncentered and unscaled data, we compared EMBER’s\nPC3 and PC4 with PC2 and PC3 from the \nscaled data respectively (d and e). \nThe correlation is 1 in both cases for \nboth cohorts: METABRIC and TCGA. We show that\nthere is no need to center and scale prior to\napplying PCA in EMBER’s context.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](revision_files/figure-html/fig-pca-center-scaled-1.png){#fig-pca-center-scaled width=1440}\n:::\n:::\n",
    "supporting": [
      "revision_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.28/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.0/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.0/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
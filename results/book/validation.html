<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Molecular landscape: a new framework for personalized medicine in Breast Cancer. - 3&nbsp; Validating the molecular landscape</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./scoring.html" rel="next">
<link href="./pca_merging.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.22/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="site_libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="site_libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="site_libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="site_libs/selectize-0.12.0/selectize.min.js"></script>
<link href="site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Molecular landscape: a new framework for personalized medicine in Breast Cancer.</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chronchi/molecular_landscape" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="sidebar-tool px-1"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surv_analysis_estrogen.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pca_merging.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scoring.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./risk_score.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk score model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discussion.html" class="sidebar-item-text sidebar-link">Discussion</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#scanb-embedding" id="toc-scanb-embedding" class="nav-link active" data-scroll-target="#scanb-embedding"> <span class="header-section-number">3.1</span> SCANB embedding</a></li>
  <li><a href="#missing-genes" id="toc-missing-genes" class="nav-link" data-scroll-target="#missing-genes"> <span class="header-section-number">3.2</span> Missing genes</a>
  <ul class="collapse">
  <li><a href="#fuzziness-score" id="toc-fuzziness-score" class="nav-link" data-scroll-target="#fuzziness-score"> <span class="header-section-number">3.2.1</span> Fuzziness score</a></li>
  <li><a href="#validating-the-score" id="toc-validating-the-score" class="nav-link" data-scroll-target="#validating-the-score"> <span class="header-section-number">3.2.2</span> Validating the score</a></li>
  </ul></li>
  <li><a href="#smc-embedding" id="toc-smc-embedding" class="nav-link" data-scroll-target="#smc-embedding"> <span class="header-section-number">3.3</span> SMC embedding</a></li>
  <li><a href="#pdx" id="toc-pdx" class="nav-link" data-scroll-target="#pdx"> <span class="header-section-number">3.4</span> PDX</a></li>
  <li><a href="#normal-samples" id="toc-normal-samples" class="nav-link" data-scroll-target="#normal-samples"> <span class="header-section-number">3.5</span> Normal samples</a></li>
  <li><a href="#third-component-as-a-prognostic-measure" id="toc-third-component-as-a-prognostic-measure" class="nav-link" data-scroll-target="#third-component-as-a-prognostic-measure"> <span class="header-section-number">3.6</span> Third component as a prognostic measure?</a></li>
  <li><a href="#high-risk-patients" id="toc-high-risk-patients" class="nav-link" data-scroll-target="#high-risk-patients"> <span class="header-section-number">3.7</span> High risk patients</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chronchi/molecular_landscape/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>In the last chapters only TCGA and METABRIC samples were used in the training and testing of the PCA projection. To completely validate, we use another big cohort, SCANB, that was not used in the PCA fitting and testing before. This way we ensure that the embedding is independent of the cohort. Moreover, we use the SMC cohort <span class="citation" data-cites="Kan2018">(<a href="references.html#ref-Kan2018" role="doc-biblioref">Kan et al. 2018</a>)</span>, whose patients are from South Korea. We show how well it is embedded, and that is not dependent on population characteristics.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>* The library is already synchronized with the lockfile.</code></pre>
</div>
</div>
<section id="scanb-embedding" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="scanb-embedding"><span class="header-section-number">3.1</span> SCANB embedding</h2>
<p>The embedding was already calculate before when calculating the fit and tests, since the datasets were organized and loaded together. We also know already that all the 1044 genes are available in the SCANB cohort. SCANB is well mixed with all cohorts as <a href="#fig-pca-scanb">Figure&nbsp;<span>3.1</span></a> shows.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-scanb-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.1: PCA embedding colored by cohort. All samples from TCGA, METABRIC and SCANB were used.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Ideally there would be some overlap between SCANB and TCGA already in the first component. Moreover, if there isnâ€™t, the cohort should be closer to TCGA than to METABRIC, due to technologies and normalization procedures, as both of them are log FPKM. Even though SCANB was processed in a way to get directly FPKM values, by using cufflinks, TCGA was normalized to get log FPKM as well, as discussed previously. <a href="#fig-pca-scanb-pc1">Figure&nbsp;<span>3.2</span></a> shows how close SCANB is from TCGA, moreover there is already some overlap. The variability in the first component is bigger for METABRIC compared to TCGA and SCANB. Probably this is due to the technology processing, since they have genes in the same scale. <a href="pca_merging.html#fig-pca-no-norm">Figure&nbsp;<span>2.22</span></a> contrasts the different normalization procedures. If genes are not scaled correctly, the PCA shows an inverse picture.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb-pc1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-scanb-pc1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.2: PCA embedding colored by cohort. The components used are the first and second components.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-pca-scanb-er-pam50">Figure&nbsp;<span>3.3</span></a> shows that the SCANB samples are also well mixed regarding the clinical factors, including the <span class="math inline">\(SET_{ER/PR}\)</span> signature.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb-er-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-scanb-er-pam50-1.png" class="img-fluid figure-img" width="1536"></p>
<p></p><figcaption class="figure-caption">Figure 3.3: PCA embedding of all samples from TCGA, SCANB and METABRIC. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype, (D) colored by the <span class="math inline">\(SET_{ER/PR}\)</span> signature and only SCANB samples.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="missing-genes" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="missing-genes"><span class="header-section-number">3.2</span> Missing genes</h2>
<p>Genes missing in publicly available datasets is very common. Usually this is due to processing pipelines or even data quality, therefore genes are removed. This should not be much of a problem, if the data is good enough, when calculating the qPCR-like normalization as it was shown before. The problem arises when multiplying the loadings obtained in the PCA with the normalized expression of the sample. If several genes are missing, 0s are added to the matrix and therefore the loadings for these genes cannot be used. Since 1000 genes were used, we investigate the loadings of genes and try to calculate a fuzziness score, indicating when the embedding should be trusted if genes are missing, and which genes are missing.</p>
<section id="fuzziness-score" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="fuzziness-score"><span class="header-section-number">3.2.1</span> Fuzziness score</h3>
<p>The idea of the fuzziness score is that we use the loadings of the missing genes and calculate the cumulative sum of their absolute values. The higher this value the more it indicates the missing genes are important. We start by removing random genes from random samples of the SCANB cohort. Each sample will have a random number of genes removed from the set of 1044 genes. Then two scores are calculated, one for PC2 and another for PC3. We also calculate the fuzziness score for the top loading genes and the low loadings genes, to compare these values.</p>
<p>We start by comparing the scores from top loadings and low loading genes. For this we remove the top 50 loadings and bottom 50 loadings, in terms of absolute values. <a href="#fig-loadings-top-bottom">Figure&nbsp;<span>3.4</span></a> shows the cumulative sum of the absolute values from the top and bottom loadings respectively. See how important the top loadings are compared to the bottom loadings. A way of thinking of this is that the top loadings weights are much more important when calculating the embedding.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-loadings-top-bottom" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-loadings-top-bottom-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.4: Cumulative sum of absolute values for the top loadings and bottom loadings as a function of the number of selected genes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>This was using the top loadings, so probably the fuzziness score of a sample with relatively good data will be between 0 and 12 maximum, meaning that they have less than 200 genes missing. When genes are missing, we hope that they are in the bottom part of the loadings, so the fuzziness score is as small as possible.</p>
<p>Suppose now that the genes missing in a sample are random. We will calculate random fuzziness scores based on this to have a feeling of the scores.</p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fuzziness-random" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-fuzziness-random-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.5: Distribution of the fuzziness scores from random missing genes. Each color corresponds to a different distribution using a different number of genes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-fuzziness-random">Figure&nbsp;<span>3.5</span></a> shows the results as a function of the number of missing genes. We see that in average, if 200 genes are missing, the fuzziness score is around 5. If less than a 100 genes are missing, the fuzziness score is around 3. In the next section we show how this influences the position where the sample is projected into the embedding.</p>
<p>Finally, we calculate the fuzziness score as a number of top loadings missing. Suppose 150 genes are missing. We will change the proportion of genes that are in the top loadings and in the missing list. Since the cumulative sum for PC2 and PC3 are very similar, we focus only on PC2.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fuzziness-random-top" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-fuzziness-random-top-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.6: Distribution of the fuzziness scores from 150 random missing genes with different proportions of top loading genes in the list. Each color corresponds to a different distribution using a different proportion of genes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-fuzziness-random-top">Figure&nbsp;<span>3.6</span></a> shows the fuzziness score with different proportions of the top loading genes. We see that they are actually very important when calculating the score. The top loading genes were defined as the top 150 genes in the list. So when calculating the number of missing genes it is important to check the number of top loadings in the list.</p>
</section>
<section id="validating-the-score" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="validating-the-score"><span class="header-section-number">3.2.2</span> Validating the score</h3>
<p>In this section we calculate the embeddings with different number of genes missing from a given sample and then plot the original embedding with the newly one. For this we use samples from TCGA. The genes are removed even before the normalization procedure, as they are usually not available there. We select randomly a number of top genes from PC3 and PC4 to compose the list of missing genes. The proportion of the top loading genes is varied.</p>
<div class="cell">

</div>
<div class="cell">

</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">TCGA-OL-A66K-01A-11R-A29R-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">TCGA-GI-A2C9-01A-11R-A21T-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">TCGA-3C-AALK-01A-11R-A41B-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">TCGA-BH-A0BW-01A-11R-A115-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">TCGA-A1-A0SI-01A-11R-A144-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false">TCGA-D8-A27L-01A-11R-A16F-07</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-10" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-10-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.7: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-20" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-20-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.8: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-50-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.9: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-80" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-80-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.10: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-182" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-182-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.11: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-198" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-198-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.12: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>When looking at the figures above, it seems that whenever there are genes missing, and the more of top loadings they are, the closer they are to the origin. This makes sense, since PCA is doing a simple linear combination of the loadings. This should be fine to correct, since we can fit a line going through the origin and goes through the points above. Then the adjustment will depend on the number of genes that are missing and are top loadings. The more they are, the more adjustment we will need.</p>
<p>For the adjustment we only know two things, its current position and how many of the top loadings are missing. Based on this information we should be able to correct the samples. Given the list of genes that are missing, we fit lines that would go through the genes that are missing in the TCGA and METABRIC samples. We then try to find the line that is closes to the point. After performing the fit and the line, we can then move the point to closer to the METABRIC and TCGA samples. The point should be close to the line and close to points that have the same proportion of top loadings missing.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "../results/plots/validation/random_loadings/01.png"
 [2] "../results/plots/validation/random_loadings/02.png"
 [3] "../results/plots/validation/random_loadings/03.png"
 [4] "../results/plots/validation/random_loadings/04.png"
 [5] "../results/plots/validation/random_loadings/05.png"
 [6] "../results/plots/validation/random_loadings/06.png"
 [7] "../results/plots/validation/random_loadings/07.png"
 [8] "../results/plots/validation/random_loadings/08.png"
 [9] "../results/plots/validation/random_loadings/09.png"
[10] "../results/plots/validation/random_loadings/10.png"
[11] "../results/plots/validation/random_loadings/11.png"
[12] "../results/plots/validation/random_loadings/12.png"
[13] "../results/plots/validation/random_loadings/13.png"
[14] "../results/plots/validation/random_loadings/14.png"
[15] "../results/plots/validation/random_loadings/15.png"
[16] "../results/plots/validation/random_loadings/16.png"
[17] "../results/plots/validation/random_loadings/17.png"
[18] "../results/plots/validation/random_loadings/18.png"
[19] "../results/plots/validation/random_loadings/19.png"
[20] "../results/plots/validation/random_loadings/20.png"</code></pre>
</div>
</div>
<p>These plots show how the fuzziness score might be indicative of how good the embedding will be depending on the number of missing genes. The video below shows the images for 20 different patients. Notice how all of them are connected to the origin as well.</p>
</section>
</section>
<section id="smc-embedding" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="smc-embedding"><span class="header-section-number">3.3</span> SMC embedding</h2>
<p>By following the same procedures as previously, normalizing and getting the PC coordinates, <a href="#fig-smc-cohort">Figure&nbsp;<span>3.13</span></a> shows the biplot of PC1 and PC2 when coloring by cohorts. The samples seem to be well mixed already in the RNA-seq samples. This is probably due to the fact that the SMC cohort has TPM values.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Total number of stable genes: 44
Total number of genes: 1040
Number of samples: 168</code></pre>
</div>
</div>
<p>When checking the total number of genes missing, there are only 4 genes missing. And as seen before, this number is almost irrelevant, in the sense that the embedding will still be robust and locations will be precise enough.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-smc-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-smc-cohort-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.13: Biplot of first two PCA components from SMC, TCGA, SCANB and METABRIC. SMC is highlighted in the plot and has a bigger dot.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As previously, <a href="#fig-pca-smc-er-pam50">Figure&nbsp;<span>3.14</span></a> shows the biplot of PC3 and PC4, highlighting the well mixing of the cohorts. When coloring by ER status, samples are in the right group. Molecular subtype is also correct. This cohort is special in the sense that there are more luminal B patients, as discussed in the paper. That is why there are more samples in the luminal B region.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-smc-er-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-smc-er-pam50-1.png" class="img-fluid figure-img" width="1728"></p>
<p></p><figcaption class="figure-caption">Figure 3.14: PCA embedding of all samples from TCGA, SCANB and METABRIC including the SMC samples on top. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="pdx" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="pdx"><span class="header-section-number">3.4</span> PDX</h2>
<p>Another way to validate the results is to use patient derived xenografts. In the Brisken lab the MIND model is used <span class="citation" data-cites="Sflomos2016 Scabia2022">(<a href="references.html#ref-Sflomos2016" role="doc-biblioref">Sflomos et al. 2016</a>; <a href="references.html#ref-Scabia2022" role="doc-biblioref">Scabia et al. 2022</a>)</span>. ER+ breast cancer samples coming from patients are processed in a specific way and injected into the mammary glands of mice. Based on that they can stablish themselves and proliferate. The environment should recapitulate what is seen in women as well, in the sense that estrogen (E2) levels are similar to those of post-menopausal women. Since these cells have to proliferate in order to establish and grow in the ducts, we expect them to be more proliferative in terms of RNA-seq components and also to lie in the luminal B region of the molecular landscape. We validate this now.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Total number of stable genes: 44
Total number of genes: 1017
Number of samples: 76</code></pre>
</div>
</div>
<p>When checking the total number of genes missing, there are only 27 genes missing. And as seen before, this number is almost irrelevant, in the sense that the embedding will still be robust and locations will be precise enough.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pdx-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pdx-cohort-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.15: Biplot of first two PCA components from PDX, TCGA, SCANB and METABRIC. PDX is highlighted in the plot and has bigger dot size.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As previously, <a href="#fig-pca-pdx-cohort">Figure&nbsp;<span>3.16</span></a> shows the biplot of PC3 and PC4, highlighting the well mixing of the cohorts. As expected the samples are overall in the luminal B region, since these are tumor cells in a proliferative state.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-pdx-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-pdx-cohort-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.16: Embedding of all samples from TCGA and METABRIC including the PDX samples on top.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-pdx-control-only" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-pdx-control-only-1.png" class="img-fluid figure-img" width="864"></p>
<p></p><figcaption class="figure-caption">Figure 3.17: Embedding of only PDX control samples on top of the METABRIC, SCANB and TCGA samples</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="normal-samples" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="normal-samples"><span class="header-section-number">3.5</span> Normal samples</h2>
<p>We now further validate the molecular landscape on the normal samples that were sequenced using the same pipeline as the SCANB data. These are samples obtained from reduction mammoplasty of swiss women and were sent to Sweden for the tissue processing and sequecing. The hypotheses here is that the samples will be embedded in the region of the normal like BC samples.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Total number of stable genes: 44
Total number of genes: 1044
Number of samples: 66</code></pre>
</div>
</div>
<p>When checking the total number of genes missing, there are only 0 genes missing, i.e., no genes were missing. This makes sense as these samples were processed in the same way as the ones from SCANB.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-normal-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-normal-cohort-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.18: Biplot of first two PCA components from Normal Swiss Cohort, TCGA, SCANB and METABRIC. The normal cohort is highlighted in the plot and has bigger dot size.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As previously, <a href="#fig-pca-normal-cohort">Figure&nbsp;<span>3.19</span></a> shows the biplot of PC3 and PC4, highlighting the well mixing of the cohorts. As expected the samples are overall in the luminal B region, since these are tumor cells in a proliferative state.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-normal-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-normal-cohort-1.png" class="img-fluid figure-img" width="864"></p>
<p></p><figcaption class="figure-caption">Figure 3.19: Embedding of all samples from TCGA, SCNAB and METABRIC including the Normal samples on top.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-normal-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-normal-pam50-1.png" class="img-fluid figure-img" width="864"></p>
<p></p><figcaption class="figure-caption">Figure 3.20: Embedding of Normal Swiss cohort with the other cohorts colored by the PAM50.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="third-component-as-a-prognostic-measure" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="third-component-as-a-prognostic-measure"><span class="header-section-number">3.6</span> Third component as a prognostic measure?</h2>
<p>We have seen that estrogen signaling is a continuous measure across the third component. The farthest to the right you are the higher the ER signaling scores are also. Here we hypothesized then that the third component is correlated to the prognostic nature of the estrogen signaling score. For this we select only samples with PC3 higher than 0, as these would be the ones that are from luminal A and B subtypes and we use PC3 as a score in the survival analysis.</p>
<div class="cell">
<div class="cell-output-display">

<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> cohort </th>
   <th style="text-align:right;"> number_patients </th>
   <th style="text-align:right;"> nb_events </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> SCANB </td>
   <td style="text-align:right;"> 3297 </td>
   <td style="text-align:right;"> 565 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> METABRIC </td>
   <td style="text-align:right;"> 724 </td>
   <td style="text-align:right;"> 445 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> SCANB High ER </td>
   <td style="text-align:right;"> 709 </td>
   <td style="text-align:right;"> 147 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>First we check the correlation of PC3 with estrogen response early and G2M checkpoint.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="validation_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>There is indeed the correlation with the components but still a lot of variability. So it will be unlikely to see such strong effects on the third component.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>../results/plots/validation/forest_plots/pdf 
                                       FALSE 
../results/plots/validation/forest_plots/png 
                                       FALSE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS PC3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS PC4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS SET_ERPR_scaled </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS PC3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS PC4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS SET_ERPR_scaled </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS PC3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS PC4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS SET_ERPR_scaled </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS PC3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS PC4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS SET_ERPR_scaled </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS PC3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS PC4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS SET_ERPR_scaled </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS PC3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS PC4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS SET_ERPR_scaled </code></pre>
</div>
</div>
<div class="cell">

</div>
<p>The table below shows the results for the survival analysis using all the samples from SCANB and METABRIC coming from patients that received only endocrine therapy and whose samples had a <span class="math inline">\(PC3 &gt; 0\)</span>. OS means overall survival and RFS means recurrence free survival.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-e48f95389d9084092397" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e48f95389d9084092397">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.177808287478733\" data-max=\"0.979022768891808\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.068883638953456\" data-max=\"0.915876958079696\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.318120040980438\" data-max=\"1.13667394021597\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"5.5984e-10\" data-max=\"0.533138830970164\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],["os","os","os","rfs","rfs","rfs","os","os","os","rfs","rfs","rfs"],["metabric","scanb","scanb_high_er","metabric","scanb","scanb_high_er","metabric","scanb","scanb_high_er","metabric","scanb","scanb_high_er"],["PC3","PC3","PC3","PC3","PC3","PC3","SET_ERPR","SET_ERPR","SET_ERPR","SET_ERPR","SET_ERPR","SET_ERPR"],[0.965196820738388,0.979022768891808,0.947697267141245,0.927679121305446,0.807994529332639,0.886499065517935,0.464246247797768,0.490709674658738,0.465115718181881,0.342276782189972,0.18738532479055,0.177808287478733],[0.905520711007731,0.915876958079696,0.825574690237194,0.853412922891882,0.712216883639698,0.691386126979256,0.318907386453501,0.361709528818346,0.262252482714936,0.217175112095403,0.110377390366988,0.0688836389534567],[1.02880573733839,1.04652221409546,1.08788474352205,1.0084081562649,0.916652180576142,1.13667394021597,0.675821845931848,0.665716453725538,0.824902128896135,0.539442086599947,0.318120040980438,0.458973822760467],[0.276663895475407,0.533138830970164,0.445335272543427,0.0778512701200417,0.000926841660179685,0.342164298884375,6.2000729287213e-05,4.77135374711357e-06,0.00883410038628265,3.85220744164788e-06,5.59840187739194e-10,0.000357601031233737]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>type_analysis<\/th>\n      <th>cohort<\/th>\n      <th>term<\/th>\n      <th>HR<\/th>\n      <th>conf.low<\/th>\n      <th>conf.high<\/th>\n      <th>p.value<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"pageLength":20,"columnDefs":[{"targets":7,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":6,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[10,20,25,50,100]}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
</div>
<p>We see that in all cases the HR for PC3 is below 1, for OS it ranges from 0.95 to 0.97 the HR and for RFS from 0.88 to 0.89. What is interesting to note here is that in all cases the confidence interval is crossing 1, as expected due to the variability of the correlation with SET ER/PR and estrogen response early. Also it is interesting to note that the confidence interval does not cross so much into the values higher than 1. Remember that the hazard ratio scale is not linear. Indeed it seems that the more a sample is on the right side of the plot the better is its outcome. Notice that the scale for HR is different for PC3 and SET ER/PR, since one is a positive score ranging from 0 to 8 and the other is a score ranging from -1 to 1. If we were to rescale SET ER/PR to an interval between 0 to 10 by multiplying by 5 and then summing 5, we would get hazard ratios in the range of 0.8. Moreover, estrogen signaling is not the only thing fully explaining the third component as it can be seen from <a href="pca_merging.html#fig-pca-mol-land-pathways">Figure&nbsp;<span>2.24</span></a>. In this case, G2M Checkpoint and PI3K signaling have also a role in the third component.</p>
</section>
<section id="high-risk-patients" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="high-risk-patients"><span class="header-section-number">3.7</span> High risk patients</h2>
<p>The Prosigna risk of recurrence score takes into account the tumor stage and the molecular subtype, this is the ROR-C and the formula from the original paper is presented below:</p>
<p><span class="math display">\[
ROR-C = 0.05\times basal + 0.11 \times HER2 - 0.23 \times LumA + 0.09 \times
LumB  + 0.17 \times Tumor size
\]</span></p>
<p>We see that if a tumor sample has a high correlation to the luminal A subtype it will decrease the score, whereas for all other cases there is an increase in the risk. We want to evaluate if the position in the molecular landscape is somehow correlated with the risk score, specially in the forth component for luminal A patients.</p>
<p>In <span class="citation" data-cites="SCANB2022">(<a href="references.html#ref-SCANB2022" role="doc-biblioref">Staaf et al. 2022</a>)</span> they showed that they are able to predict the Prosigna binary categories high or low/intermediate risk for the patients based only on the RNA-seq provided by their pipeline. We use these categories here to understand the molecular scores of the samples and also their correlation with the position and risk groups. All the following analysis are done for ER+ BC patients <strong>only</strong>.</p>
<p>First we stratify the risk groups by the molecular subtype.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-25cd660c4e3371496626" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-25cd660c4e3371496626">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["basal","her2","lumb","luma","normal","Total"],["86%   (63)","89%  (463)","86% (1751)","14%  (472)","16%  (139)","42% (2888)"],["14%   (10)","11%   (59)","14%  (283)","86% (2890)","84%  (714)","58% (3956)"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>pam50<\/th>\n      <th>High<\/th>\n      <th>Low/Intermediate<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>As expected the majority of luminal A patients are low/intermediate risk, on the other hand most of the luminal B patients are considered of high risk.</p>
<p>If we look more specifically for luminal A patients and stratify on the tumor stage we get the following numbers.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-9fb199fba3ba309c6357" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9fb199fba3ba309c6357">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4"],["T1","T2","T3","Total"],["9% (222)","26% (214)","44%  (34)","14% (470)"],["91% (2214)","74%  (624)","56%   (44)","86% (2882)"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tumor_stage<\/th>\n      <th>High<\/th>\n      <th>Low/Intermediate<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We see that for tumor stage 1 the number of high individuals is lower in percentage than in tumor stage 3, as expected. We now plot (<a href="#fig-luma-scanb-g2m-ts">Figure&nbsp;<span>3.21</span></a>) for all these patients the G2M molecular score, an index of proliferation, stratified by the tumor stage.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-luma-scanb-g2m-ts" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-luma-scanb-g2m-ts-1.png" class="img-fluid figure-img" width="1056"></p>
<p></p><figcaption class="figure-caption">Figure 3.21: Luminal A BC patients G2M scores stratified by tumor stage.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We see that in all three cases in average the G2M scores are higher in the high risk groups than in the Low/Intermediate.</p>
<p>We saw previously that some of the G2M checkpoint genes have higher loadings for the fourth component. We now plot the PC4 components stratified by the risk groups for the luminal A patients (<a href="#fig-luma-scanb-pc4">Figure&nbsp;<span>3.22</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-luma-scanb-pc4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-luma-scanb-pc4-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption class="figure-caption">Figure 3.22: Luminal A BC patients PC4 values stratified by risk category.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Indeed, in average the higher the PC4, the more likely it is to be in the High risk group. And now we compare the G2M Checkpoint, Estrogen response early and random 200 signature for each molecular subtype separately (<a href="#fig-all-scanb-g2m-ere">Figure&nbsp;<span>3.23</span></a>) of ER+ BC patients.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-all-scanb-g2m-ere" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-all-scanb-g2m-ere-1.png" class="img-fluid figure-img" width="1344"></p>
<p></p><figcaption class="figure-caption">Figure 3.23: ER+ BC patients and molecular scores stratified by molecular subtype and binary risk categories.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We see that in this case the binary risk category has distinct distributions for the G2M checkpoint for all molecular subtypes, in particular with the basal like.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Kan2018" class="csl-entry" role="doc-biblioentry">
Kan, Zhengyan, Ying Ding, Jinho Kim, Hae Hyun Jung, Woosung Chung, Samir Lal, Soonweng Cho, et al. 2018. <span>â€œMulti-Omics Profiling of Younger Asian Breast Cancers Reveals Distinctive Molecular Signatures.â€</span> <em>Nature Communications</em> 9 (1). <a href="https://doi.org/10.1038/s41467-018-04129-4">https://doi.org/10.1038/s41467-018-04129-4</a>.
</div>
<div id="ref-Scabia2022" class="csl-entry" role="doc-biblioentry">
Scabia, Valentina, Ayyakkannu Ayyanan, Fabio De Martino, Andrea Agnoletto, Laura Battista, Csaba Laszlo, Assia Treboux, et al. 2022. <span>â€œEstrogen Receptor Positive Breast Cancers Have Patient Specific Hormone Sensitivities and Rely on Progesterone Receptor.â€</span> <em>Nature Communications</em> 13 (1). <a href="https://doi.org/10.1038/s41467-022-30898-0">https://doi.org/10.1038/s41467-022-30898-0</a>.
</div>
<div id="ref-Sflomos2016" class="csl-entry" role="doc-biblioentry">
Sflomos, George, Valerian Dormoy, Tauno Metsalu, Rachel Jeitziner, Laura Battista, Valentina Scabia, Wassim Raffoul, et al. 2016. <span>â€œA Preclinical Model for <span>ER</span><span class="math inline">\(\upalpha\)</span>-Positive Breast Cancer Points to the Epithelial Microenvironment as Determinant of Luminal Phenotype and Hormone Response.â€</span> <em>Cancer Cell</em> 29 (3): 407â€“22. <a href="https://doi.org/10.1016/j.ccell.2016.02.002">https://doi.org/10.1016/j.ccell.2016.02.002</a>.
</div>
<div id="ref-SCANB2022" class="csl-entry" role="doc-biblioentry">
Staaf, Johan, Jari HÃ¤kkinen, Cecilia Hegardt, Lao H. Saal, Siker Kimbung, Ingrid Hedenfalk, Tonje Lien, et al. 2022. <span>â€œ<span>RNA</span> Sequencing-Based Single Sample Predictors of Molecular Subtype and Risk of Recurrence for Clinical Assessment of Early-Stage Breast Cancer.â€</span> <em>Npj Breast Cancer</em> 8 (1). <a href="https://doi.org/10.1038/s41523-022-00465-3">https://doi.org/10.1038/s41523-022-00465-3</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./pca_merging.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./scoring.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Validating the molecular landscape</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>In the last chapters only TCGA and METABRIC samples were used in the training</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>and testing of the PCA projection. To completely validate, we use another</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>big cohort, SCANB, that was not used in the PCA fitting and testing before.</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>This way we ensure that the embedding is independent of the cohort. Moreover,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>we use the SMC cohort <span class="co">[</span><span class="ot">@Kan2018</span><span class="co">]</span>, whose patients are from South Korea.</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>We show how well it is embedded, and that </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>is not dependent on population characteristics. </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>()</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCAtools)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(singscore)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SummarizedExperiment)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tximport)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forestplot)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplotify)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"first_run.R"</span>)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we are using rds files from previous chapters, so we source</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="co"># in any case the load_rds_files.R and exclude all the associated files</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co"># that are generated in this current chapter</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>name_document <span class="ot">&lt;-</span> <span class="st">"validation"</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"load_rds_files.R"</span>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co"># by setting the dev to png and pdf, this saves the figures in a specific</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="co"># folder in both formats. moreover, since png is coming first, it shows</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co"># this figure when rendering the html. What is nice about this is that it</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="co"># inherits the properties from the chunk to save the figure, so no need</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="co"># to use ggplot2::ggsave to save the plots. this also works </span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="fu">c</span>(<span class="st">'png'</span>, <span class="st">'pdf'</span>, <span class="st">'svg'</span>))</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">bitmapType =</span> <span class="st">'cairo'</span>)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## SCANB embedding</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>The embedding was already calculate before when calculating the fit and</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>tests, since the datasets were organized and loaded together. We also</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>know already that all the 1044 genes are available in the SCANB cohort. </span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>SCANB is well mixed with all cohorts as @fig-pca-scanb shows.</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding colored by cohort. All samples from TCGA, METABRIC</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="co">#|     and SCANB were used. </span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca_coordinates</span>(</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"cohort"</span>,</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA,</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC and SCANB"</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>Ideally there would be some overlap between SCANB and TCGA already in the </span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>first component. Moreover, if there isn't, the cohort should be closer</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>to TCGA than to METABRIC, due to technologies and normalization procedures,</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>as both of them are log FPKM. Even though SCANB was processed in a way </span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>to get directly FPKM values, by using cufflinks, TCGA was normalized to get</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>log FPKM as well, as discussed previously. @fig-pca-scanb-pc1 shows</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>how close SCANB is from TCGA, moreover there is already some overlap. The </span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>variability in the first component is bigger for METABRIC compared to</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>TCGA and SCANB. Probably this is due to the technology processing, since</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>they have genes in the same scale. @fig-pca-no-norm contrasts the different</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>normalization procedures. If genes are not scaled correctly, the PCA</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>shows an inverse picture.</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb-pc1</span></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding colored by cohort. The components used are the</span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a><span class="co">#|     first and second components.</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca_coordinates</span>(</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates,</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"cohort"</span>,</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC1"</span>,</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC2"</span>,</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA,</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC and SCANB"</span></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>@fig-pca-scanb-er-pam50 shows that the SCANB samples are also well mixed</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>regarding the clinical factors, including the $SET_{ER/PR}$ signature.</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=16, fig.height=12}</span></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb-er-pam50</span></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC.</span></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (A) Colored by cohort,</span></span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (B) colored by ER status, (C) colored by PAM50 molecular subtype,</span></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (D) colored by the $SET_{ER/PR}$ signature and only SCANB samples.</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>base_size <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>plots_with_scanb <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"cohort"</span>, <span class="st">"er_status"</span>, <span class="st">"pam50"</span>, <span class="st">"SET_ERPR"</span>), </span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>    plot_pca_coordinates,</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> df_pca_coordinates <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>        pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"luma"</span>, <span class="st">"lumb"</span>, <span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"normal"</span>)</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())),</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>, </span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> size,</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> base_size,</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA,</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC and SCANB"</span></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>cohort <span class="ot">&lt;-</span> plots_with_scanb<span class="sc">$</span>cohort <span class="sc">+</span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> plots_with_scanb<span class="sc">$</span>pam50 <span class="sc">+</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_colors_pam50</span>(plots_with_scanb<span class="sc">$</span>pam50<span class="sc">$</span>data)</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>er_status <span class="ot">&lt;-</span>  plots_with_scanb<span class="sc">$</span>er_status <span class="sc">+</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"ER status"</span>) <span class="sc">+</span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>SET_ERPR <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes_string</span>(<span class="at">x =</span> <span class="st">"PC3"</span>, <span class="at">y =</span> <span class="st">"PC4"</span>, <span class="at">z =</span> <span class="st">"SET_ERPR"</span>)) <span class="sc">+</span> </span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Embedding of SCANB only"</span>,</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="fu">expression</span>(SET[ER<span class="sc">/</span>PR])</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span> </span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> base_size) <span class="sc">+</span></span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>        <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">plotlist =</span> plots_with_scanb,</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a><span class="fu">## Missing genes</span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>Genes missing in publicly available datasets is very common. Usually this is</span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>due to processing pipelines or even data quality, therefore genes are removed.</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>This should not be much of a problem, if the data is good enough, when </span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a>calculating the qPCR-like normalization as it was shown before. The problem</span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>arises when multiplying the loadings obtained in the PCA with the </span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a>normalized expression of the sample. If several genes are missing, 0s are </span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a>added to the matrix and therefore the loadings for these genes cannot be </span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a>used. Since 1000 genes were used, we investigate the loadings of genes and </span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a>try to calculate a fuzziness score, indicating when the embedding should</span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a>be trusted if genes are missing, and which genes are missing. </span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fuzziness score </span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>The idea of the fuzziness score is that we use the loadings of the missing</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>genes and calculate the cumulative sum of their absolute values. </span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>The higher this value</span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>the more it indicates the missing genes are important. We start by</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>removing random genes from random samples of the SCANB cohort. Each sample</span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>will have a random number of genes removed from the set of 1044 genes. </span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>Then two scores are calculated, one for PC2 and another for PC3. We also</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>calculate the fuzziness score for the top loading genes and the </span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>low loadings genes, to compare these values.</span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>We start by comparing the scores from top loadings and low loading genes. For</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>this we remove the top 50 loadings and bottom 50 loadings, in terms of</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>absolute values. @fig-loadings-top-bottom shows the cumulative sum</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>of the absolute values from the top and bottom loadings respectively. See how </span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>important the top loadings are compared to the bottom loadings. A way of</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>thinking of this is that the top loadings weights are much more important</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>when calculating the embedding.</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-loadings-top-bottom</span></span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Cumulative sum of absolute values for the top loadings and</span></span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a><span class="co">#|     bottom loadings as a function of the number of selected genes.</span></span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>which_loadings <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"PC3"</span>, <span class="st">"PC4"</span>)</span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>top_or_bottom <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"top"</span>, <span class="st">"bottom"</span>)</span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_top <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(n, pca_fit){</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>        top_loadings <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>            pca_fit<span class="sc">$</span>loadings[, which_loadings],</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span>,</span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x, gene_names){</span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>                gene_names[<span class="fu">order</span>(<span class="fu">abs</span>(x), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>n]]</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>            <span class="at">gene_names =</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_fuzziness_score</span>(top_loadings, pca_fit, <span class="at">which_pcs =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(which_loadings) <span class="sc">%&gt;%</span></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_bottom <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(n, pca_fit){</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>        top_loadings <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>            pca_fit<span class="sc">$</span>loadings[, which_loadings],</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span>,</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x, gene_names){</span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>                gene_names[<span class="fu">order</span>(<span class="fu">abs</span>(x), <span class="at">decreasing =</span> <span class="cn">FALSE</span>)[<span class="dv">1</span><span class="sc">:</span>n]]</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a>            <span class="at">gene_names =</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_fuzziness_score</span>(top_loadings, pca_fit)</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(which_loadings) <span class="sc">%&gt;%</span></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a>fuzziness_scores <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">top =</span> fuzziness_scores_top, <span class="at">bottom =</span> fuzziness_scores_bottom),</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">.id =</span> <span class="st">"top_or_bottom"</span></span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_or_bottom =</span> <span class="fu">factor</span>(top_or_bottom, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"top"</span>, <span class="st">"bottom"</span>))</span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>fuzziness_scores <span class="sc">%&gt;%</span> tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(which_loadings),</span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"PC"</span>,</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"fuzziness_score"</span></span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> fuzziness_score, <span class="at">color =</span> PC)) <span class="sc">+</span></span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>top_or_bottom) <span class="sc">+</span></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Number of genes"</span>,</span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Fuzziness score"</span>,</span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Principal</span><span class="sc">\n</span><span class="st">component"</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.65</span>, <span class="fl">0.8</span>))</span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>This was using the top loadings, so probably the fuzziness score of a sample</span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a>with relatively good data will be between 0 and 12 maximum, meaning that</span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a>they have less than 200 genes missing. When genes are missing, we hope that</span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a>they are in the bottom part of the loadings, so the fuzziness score</span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a>is as small as possible. </span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a>Suppose now that the genes missing in a sample are random. We will calculate</span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a>random fuzziness scores based on this to have a feeling of the scores. </span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>nb_of_genes <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span> <span class="dv">220</span>, <span class="at">by =</span> <span class="dv">20</span>)</span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>list_of_random_genes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>    nb_of_genes,</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(n, genes){</span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(</span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x, genes, n){</span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sample</span>(genes, <span class="at">size =</span> n)</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes =</span> genes,</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> n,</span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a>            <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes =</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_random <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>    list_of_random_genes,</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(list_genes, pca_fit){</span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a>            list_genes,</span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>            get_fuzziness_score,</span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>            <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(which_loadings)</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(<span class="st">"#"</span>, nb_of_genes)) <span class="sc">%&gt;%</span></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"nb_genes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a>        <span class="at">nb_genes =</span> <span class="fu">factor</span>(</span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a>            nb_genes,</span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a>            <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"#"</span>, nb_of_genes)</span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a>        which_loadings,</span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"PC"</span>,</span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"fuzziness_score"</span></span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores_random,</span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/fuzziness_scores_random.rds"</span></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fuzziness-random</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Distribution of the fuzziness scores from random missing genes.</span></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a><span class="co">#|     Each color corresponds to a different distribution using a different</span></span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a><span class="co">#|     number of genes.</span></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_random <span class="sc">%&gt;%</span> </span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(PC <span class="sc">==</span> <span class="st">"PC3"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> fuzziness_score, <span class="at">fill =</span> nb_genes)) <span class="sc">+</span></span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Fuzziness score"</span>,</span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Distribution of fuzziness score as a function of the number</span><span class="sc">\n</span><span class="st">of genes missing"</span>,</span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Only PC3 fuzziness scores"</span>,</span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"# missing</span><span class="sc">\n</span><span class="st">genes"</span></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>@fig-fuzziness-random shows the results as a function of the number of missing</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a>genes. We see that in average, if 200 genes are missing, the fuzziness</span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>score is around 5. If less than a 100 genes are missing, the fuzziness</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>score is around 3. In the next section we show how this influences the</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a>position where the sample is projected into the embedding.</span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a>Finally, we calculate the fuzziness score as a number of top loadings </span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>missing. Suppose 150 genes are missing. We will change the proportion</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a>of genes that are in the top loadings and in the missing list. Since</span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>the cumulative sum for PC2 and PC3 are very similar, we focus only on</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>PC2.</span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fuzziness-random-top</span></span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Distribution of the fuzziness scores from 150 random missing genes</span></span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a><span class="co">#|     with different proportions of top loading genes in the list.</span></span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a><span class="co">#|     Each color corresponds to a different distribution using a different</span></span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a><span class="co">#|     proportion of genes.</span></span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>nb_genes <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>proportions <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a>gene_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a>which_pcs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>)</span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a>top_loadings_genes <span class="ot">&lt;-</span> gene_names[<span class="fu">order</span>(</span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(pca_fit<span class="sc">$</span>loadings[, which_pcs]), </span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">decreasing =</span> <span class="cn">TRUE</span></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a>)[<span class="dv">1</span><span class="sc">:</span>nb_genes]]</span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>proportions_top_fuzziness <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a>    proportions,</span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(prop, gene_names, top_loadings_genes, pca_fit, nb_genes){</span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>        nb_genes_top <span class="ot">&lt;-</span> <span class="fu">floor</span>(prop <span class="sc">*</span> nb_genes)</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>        nb_genes_non_top <span class="ot">&lt;-</span> <span class="fu">floor</span>((<span class="dv">1</span> <span class="sc">-</span> prop) <span class="sc">*</span> nb_genes)</span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a>        <span class="co"># run the fuzziness several times to get a distribution based on</span></span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the proportions</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a>        list_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>                i, </span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>                genes_top, </span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>                genes_non_top, </span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>                nb_genes_top, </span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a>                nb_genes_non_top,</span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>                pca_fit</span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>                <span class="fu">get_fuzziness_score</span>(</span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">c</span>(</span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(genes_top, <span class="at">size =</span> nb_genes_top),</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(genes_non_top, <span class="at">size =</span> nb_genes_non_top)</span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a>                    ), </span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a>                    pca_fit,</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>                    <span class="at">which_pcs =</span> which_pcs</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_top =</span> top_loadings_genes,</span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_non_top =</span> <span class="fu">setdiff</span>(gene_names, top_loadings_genes),</span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a>            <span class="at">nb_genes_top =</span> nb_genes_top,</span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>            nb_genes_non_top,</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a>            <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, which_pcs))</span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_loadings_genes =</span> top_loadings_genes,</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(proportions)) <span class="sc">%&gt;%</span></span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"proportions"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, which_pcs),</span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"PC"</span>,</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"fuzziness_score"</span></span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a>proportions_top_fuzziness <span class="sc">%&gt;%</span> </span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> fuzziness_score, <span class="at">fill =</span> proportions)    </span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Fuzziness score"</span>,</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Distribution of fuzziness score as a function of the</span><span class="sc">\n</span><span class="st">proportion "</span>,</span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a>            <span class="st">"of the top loading genes in the list of missing genes"</span></span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Only PC3 fuzziness scores"</span>,</span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"Proportion of</span><span class="sc">\n</span><span class="st">top genes"</span></span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>@fig-fuzziness-random-top shows the fuzziness score with different proportions</span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>of the top loading genes. We see that they are actually very important when</span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>calculating the score. The top loading genes were defined as the top 150 genes</span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>in the list. So when calculating the number of missing genes it is important</span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>to check the number of top loadings in the list. </span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a><span class="fu">### Validating the score</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>In this section we calculate the embeddings with different number of genes</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>missing from a given sample and then plot the original embedding with</span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a>the newly one. For this</span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>we use samples from TCGA. The genes are </span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>removed even before the normalization procedure, as they are usually not</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a>available there. We select randomly a number of top genes from PC3 and PC4</span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>to compose the list of missing genes. The proportion of the top loading</span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a>genes is varied. </span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>nb_genes <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>proportions <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>gene_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>which_pcs <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>top_loadings_genes_random <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>    which_pcs,</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(pc, gene_names, pca_fit, nb_genes){</span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>        gene_names[<span class="fu">order</span>(</span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>            <span class="fu">abs</span>(pca_fit<span class="sc">$</span>loadings[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, pc)]), </span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a>            <span class="at">decreasing =</span> <span class="cn">TRUE</span></span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">1</span><span class="sc">:</span>nb_genes]]   </span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a>    top_loadings_genes_random,</span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/top_loadings_genes_random.rds"</span></span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a><span class="co"># we select a number of samples since it is not necessary to run</span></span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a><span class="co"># the analysis on all samples, but we want a representative sampling</span></span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a><span class="co"># so any sampling should suffice for the analysis</span></span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2039</span>)</span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a>samples_to_use <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">colnames</span>(datasets<span class="sc">$</span>tcga), <span class="at">size =</span> <span class="dv">200</span>)</span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a>genes_proportions_top <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a>    proportions,</span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(prop, gene_names, top_loadings_genes, pca_fit, nb_genes){</span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a>        nb_genes_top <span class="ot">&lt;-</span> <span class="fu">floor</span>(prop <span class="sc">*</span> nb_genes)</span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a>        nb_genes_non_top <span class="ot">&lt;-</span> <span class="fu">floor</span>((<span class="dv">1</span> <span class="sc">-</span> prop) <span class="sc">*</span> nb_genes)</span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a>        <span class="co"># run the fuzziness several times to get a distribution based on</span></span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the proportions</span></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a>        list_genes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a>                i, </span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a>                genes_top, </span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a>                genes_non_top, </span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a>                nb_genes_top, </span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a>                nb_genes_non_top</span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(</span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sample</span>(genes_top, <span class="at">size =</span> nb_genes_top),</span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sample</span>(genes_non_top, <span class="at">size =</span> nb_genes_non_top)</span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_top =</span> top_loadings_genes,</span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_non_top =</span> <span class="fu">setdiff</span>(gene_names, top_loadings_genes),</span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>            <span class="at">nb_genes_top =</span> nb_genes_top,</span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>            nb_genes_non_top</span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_loadings_genes =</span> top_loadings_genes_random,</span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(proportions))</span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a>    samples_to_use,</span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/samples_to_use.rds"</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a>    genes_proportions_top,</span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/genes_proportions_top.rds"</span></span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_random_top <span class="ot">&lt;-</span> <span class="fu">rapply</span>(</span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a>    genes_proportions_top,</span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a>    get_fuzziness_score,</span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a>    <span class="at">how =</span> <span class="st">"list"</span></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-559"><a href="#cb31-559" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-560"><a href="#cb31-560" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores_random_top,</span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/fuzziness_scores_random_top.rds"</span></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a>pca_coords_random <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(</span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a>    genes_proportions_top,</span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(</span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a>        lists_genes, </span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a>        sum_exp, </span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a>        pca_fit, </span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a>        assay_to_use, </span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a>        stable_genes, </span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a>        most_variable_genes</span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for each list of gene, remove the provided genes and proceed</span></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a>        <span class="co"># with the whole pipeline for all samples selected</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a>            lists_genes,</span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a>                genes_to_remove, </span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a>                sum_exp, </span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a>                pca_fit,</span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a>                assay_to_use, </span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a>                stable_genes, </span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a>                most_variable_genes</span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a>                <span class="co"># remove genes</span></span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a>                sum_exp <span class="ot">&lt;-</span> sum_exp[<span class="fu">setdiff</span>(<span class="fu">rownames</span>(sum_exp), genes_to_remove),]</span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a>                <span class="co"># now proceed with the normalization pipeline and PC retrieval</span></span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a>                sum_exp <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a>                    sum_exp,</span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a>                    assay_to_use,</span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a>                    stable_genes,</span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a>                    most_variable_genes</span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a>                pca_coords <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(sum_exp, pca_fit)</span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>                pca_coords[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)]</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a>            <span class="at">sum_exp =</span> sum_exp, </span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a>            <span class="at">pca_fit =</span> pca_fit, </span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a>            <span class="at">assay_to_use =</span> assay_to_use, </span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a>            <span class="at">stable_genes =</span> stable_genes, </span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a>            <span class="at">most_variable_genes =</span> most_variable_genes</span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets<span class="sc">$</span>tcga[, samples_to_use],</span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit, </span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"logFPKM_TMM"</span>, </span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes, </span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(genes_for_pca, stable_genes),</span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a>    <span class="at">mc.cores =</span> <span class="dv">11</span></span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a>    pca_coords_random,</span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pca_coords_random.rds"</span></span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a>get_pca_random_genes <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a>    use_sample,</span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a>    og_pca,</span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a>    pca_coords_random,</span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores_random,</span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_pcs =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for each proportion, extract the coordinates</span></span>
<span id="cb31-634"><a href="#cb31-634" aria-hidden="true" tabindex="-1"></a>    pca_coords <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-635"><a href="#cb31-635" aria-hidden="true" tabindex="-1"></a>        pca_coords_random,</span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x){</span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sapply</span>(</span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(y) y[use_sample, which_pcs]</span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"proportion"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a>        data.frame</span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a>        fuzziness_scores_random,</span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x){</span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sapply</span>(</span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb31-650"><a href="#cb31-650" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(y) y</span>
<span id="cb31-651"><a href="#cb31-651" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"proportion"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a>        data.frame</span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(</span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a>                <span class="at">random =</span> pca_coords,</span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a>                <span class="at">original =</span> og_pca <span class="sc">%&gt;%</span> </span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">==</span> use_sample) <span class="sc">%&gt;%</span></span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(which_pcs)) <span class="sc">%&gt;%</span></span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">proportion =</span> <span class="st">"all_genes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a>                    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a>                    .[, <span class="fu">colnames</span>(pca_coords)]</span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a>            <span class="at">.id =</span> <span class="st">"embedding"</span></span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a>pca_random_genes_patients <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a>    samples_to_use, </span>
<span id="cb31-673"><a href="#cb31-673" aria-hidden="true" tabindex="-1"></a>    get_pca_random_genes, </span>
<span id="cb31-674"><a href="#cb31-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">og_pca =</span> df_pca_coordinates,</span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_coords_random =</span> pca_coords_random, </span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">fuzziness_scores_random =</span> fuzziness_scores_random_top,</span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_pcs =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a>    pca_random_genes_patients,</span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pca_random_genes_patients.rds"</span></span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a>plots_random_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a>    samples_to_use, </span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a>    plot_pca_random_genes,</span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_random_genes_patients =</span> pca_random_genes_patients,</span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca_coordinates =</span> df_pca_coordinates,</span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">10</span>]</span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-712"><a href="#cb31-712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb31-713"><a href="#cb31-713" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-10</span></span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">20</span>]</span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-20</span></span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">50</span>]</span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-50</span></span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">80</span>]</span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-80</span></span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">182</span>]</span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-182</span></span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">198</span>]</span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-198</span></span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a>When looking at the figures above, it seems that whenever there are </span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a>genes missing,</span>
<span id="cb31-786"><a href="#cb31-786" aria-hidden="true" tabindex="-1"></a>and the more of top loadings they are, the closer they are to the origin.</span>
<span id="cb31-787"><a href="#cb31-787" aria-hidden="true" tabindex="-1"></a>This makes sense, since PCA is doing a simple linear combination of the loadings.</span>
<span id="cb31-788"><a href="#cb31-788" aria-hidden="true" tabindex="-1"></a>This should be fine to correct, since we can fit a line going through the </span>
<span id="cb31-789"><a href="#cb31-789" aria-hidden="true" tabindex="-1"></a>origin and goes through the points above. Then the adjustment will depend</span>
<span id="cb31-790"><a href="#cb31-790" aria-hidden="true" tabindex="-1"></a>on the number of genes that are missing and are top loadings. The more </span>
<span id="cb31-791"><a href="#cb31-791" aria-hidden="true" tabindex="-1"></a>they are, the more adjustment we will need. </span>
<span id="cb31-792"><a href="#cb31-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-793"><a href="#cb31-793" aria-hidden="true" tabindex="-1"></a>For the adjustment we only know two things, its current position and </span>
<span id="cb31-794"><a href="#cb31-794" aria-hidden="true" tabindex="-1"></a>how many of the top loadings are missing. Based on this information we</span>
<span id="cb31-795"><a href="#cb31-795" aria-hidden="true" tabindex="-1"></a>should be able to correct the samples. Given the list of genes that are missing,</span>
<span id="cb31-796"><a href="#cb31-796" aria-hidden="true" tabindex="-1"></a>we fit lines that would go through the genes that are missing in the TCGA</span>
<span id="cb31-797"><a href="#cb31-797" aria-hidden="true" tabindex="-1"></a>and METABRIC samples. We then try to find the line that is closes to the point.</span>
<span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a>After performing the fit and the line, we can then move the point to closer</span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a>to the METABRIC and TCGA samples. The point should be close to the line</span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a>and close to points that have the same proportion of top loadings </span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>missing.</span>
<span id="cb31-802"><a href="#cb31-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-803"><a href="#cb31-803" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb31-804"><a href="#cb31-804" aria-hidden="true" tabindex="-1"></a>folder_to_save <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb31-805"><a href="#cb31-805" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/plots/validation/random_loadings"</span></span>
<span id="cb31-806"><a href="#cb31-806" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-807"><a href="#cb31-807" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(</span>
<span id="cb31-808"><a href="#cb31-808" aria-hidden="true" tabindex="-1"></a>    folder_to_save, </span>
<span id="cb31-809"><a href="#cb31-809" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb31-810"><a href="#cb31-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb31-811"><a href="#cb31-811" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-812"><a href="#cb31-812" aria-hidden="true" tabindex="-1"></a>fig_width <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb31-813"><a href="#cb31-813" aria-hidden="true" tabindex="-1"></a>fig_height <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb31-814"><a href="#cb31-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-815"><a href="#cb31-815" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb31-816"><a href="#cb31-816" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,</span>
<span id="cb31-817"><a href="#cb31-817" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i, final_plots){</span>
<span id="cb31-818"><a href="#cb31-818" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggsave</span>(</span>
<span id="cb31-819"><a href="#cb31-819" aria-hidden="true" tabindex="-1"></a>            <span class="at">filename =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-820"><a href="#cb31-820" aria-hidden="true" tabindex="-1"></a>                folder_to_save, </span>
<span id="cb31-821"><a href="#cb31-821" aria-hidden="true" tabindex="-1"></a>                <span class="st">"/"</span>, </span>
<span id="cb31-822"><a href="#cb31-822" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ifelse</span>(i <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="fu">paste0</span>(<span class="st">"0"</span>,i), i), </span>
<span id="cb31-823"><a href="#cb31-823" aria-hidden="true" tabindex="-1"></a>                <span class="st">".png"</span></span>
<span id="cb31-824"><a href="#cb31-824" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb31-825"><a href="#cb31-825" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> final_plots[[i]],</span>
<span id="cb31-826"><a href="#cb31-826" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> fig_width,</span>
<span id="cb31-827"><a href="#cb31-827" aria-hidden="true" tabindex="-1"></a>            <span class="at">height =</span> fig_height, </span>
<span id="cb31-828"><a href="#cb31-828" aria-hidden="true" tabindex="-1"></a>            <span class="at">dpi =</span> <span class="dv">320</span></span>
<span id="cb31-829"><a href="#cb31-829" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-830"><a href="#cb31-830" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-831"><a href="#cb31-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_plots =</span> plots_random_genes</span>
<span id="cb31-832"><a href="#cb31-832" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-833"><a href="#cb31-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-834"><a href="#cb31-834" aria-hidden="true" tabindex="-1"></a><span class="co"># we then proceed to generate a mp4 by using the following command:</span></span>
<span id="cb31-835"><a href="#cb31-835" aria-hidden="true" tabindex="-1"></a><span class="co"># ffmpeg -framerate 1 -pattern_type glob -i 'random_loadings/*.png' random_loadings.mp4</span></span>
<span id="cb31-836"><a href="#cb31-836" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(</span>
<span id="cb31-837"><a href="#cb31-837" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(</span>
<span id="cb31-838"><a href="#cb31-838" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ffmpeg -y -framerate 1 -pattern_type glob -i '"</span>,</span>
<span id="cb31-839"><a href="#cb31-839" aria-hidden="true" tabindex="-1"></a>        folder_to_save, <span class="st">"/*.png' "</span>, </span>
<span id="cb31-840"><a href="#cb31-840" aria-hidden="true" tabindex="-1"></a>        folder_to_save, <span class="st">"/../random_loadings.mp4"</span></span>
<span id="cb31-841"><a href="#cb31-841" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-842"><a href="#cb31-842" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-843"><a href="#cb31-843" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-844"><a href="#cb31-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-845"><a href="#cb31-845" aria-hidden="true" tabindex="-1"></a>These plots show how the fuzziness score might be indicative of how</span>
<span id="cb31-846"><a href="#cb31-846" aria-hidden="true" tabindex="-1"></a>good the embedding will be depending on the number of missing genes. The</span>
<span id="cb31-847"><a href="#cb31-847" aria-hidden="true" tabindex="-1"></a>video below shows the images for 20 different patients. Notice how all of</span>
<span id="cb31-848"><a href="#cb31-848" aria-hidden="true" tabindex="-1"></a>them are connected to the origin as well.</span>
<span id="cb31-849"><a href="#cb31-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-850"><a href="#cb31-850" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = !first_run, results = 'asis', echo = FALSE}</span></span>
<span id="cb31-851"><a href="#cb31-851" aria-hidden="true" tabindex="-1"></a>embedding_video <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb31-852"><a href="#cb31-852" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;iframe width="720" height="480" '</span>,</span>
<span id="cb31-853"><a href="#cb31-853" aria-hidden="true" tabindex="-1"></a>    <span class="st">'src="../plots/validation/random_loadings.mp4" '</span>,</span>
<span id="cb31-854"><a href="#cb31-854" aria-hidden="true" tabindex="-1"></a>    <span class="st">'align="middle" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;'</span></span>
<span id="cb31-855"><a href="#cb31-855" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-856"><a href="#cb31-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-857"><a href="#cb31-857" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(embedding_video)</span>
<span id="cb31-858"><a href="#cb31-858" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-859"><a href="#cb31-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-860"><a href="#cb31-860" aria-hidden="true" tabindex="-1"></a><span class="fu">## SMC embedding</span></span>
<span id="cb31-861"><a href="#cb31-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-862"><a href="#cb31-862" aria-hidden="true" tabindex="-1"></a>By following the same procedures as previously, normalizing and getting</span>
<span id="cb31-863"><a href="#cb31-863" aria-hidden="true" tabindex="-1"></a>the PC coordinates, @fig-smc-cohort shows the biplot of PC1 and PC2</span>
<span id="cb31-864"><a href="#cb31-864" aria-hidden="true" tabindex="-1"></a>when coloring by cohorts. The samples seem to be well mixed already in</span>
<span id="cb31-865"><a href="#cb31-865" aria-hidden="true" tabindex="-1"></a>the RNA-seq samples. This is probably due to the fact that the SMC cohort</span>
<span id="cb31-866"><a href="#cb31-866" aria-hidden="true" tabindex="-1"></a>has TPM values. </span>
<span id="cb31-867"><a href="#cb31-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-868"><a href="#cb31-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb31-869"><a href="#cb31-869" aria-hidden="true" tabindex="-1"></a>clin_data_smc <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb31-870"><a href="#cb31-870" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../data/2018_SMC/data_clinical_sample.txt"</span>,</span>
<span id="cb31-871"><a href="#cb31-871" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb31-872"><a href="#cb31-872" aria-hidden="true" tabindex="-1"></a>    <span class="at">header =</span> <span class="cn">TRUE</span></span>
<span id="cb31-873"><a href="#cb31-873" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-874"><a href="#cb31-874" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(PAM50_SUBTYPE)</span>
<span id="cb31-875"><a href="#cb31-875" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-876"><a href="#cb31-876" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-877"><a href="#cb31-877" aria-hidden="true" tabindex="-1"></a>        <span class="at">pam50 =</span> <span class="fu">tolower</span>(PAM50_SUBTYPE)</span>
<span id="cb31-878"><a href="#cb31-878" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-879"><a href="#cb31-879" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-880"><a href="#cb31-880" aria-hidden="true" tabindex="-1"></a>        <span class="at">pam50 =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(pam50, <span class="st">"luminal"</span>, <span class="st">"lum"</span>)</span>
<span id="cb31-881"><a href="#cb31-881" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-882"><a href="#cb31-882" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>SAMPLE_ID) <span class="sc">%&gt;%</span></span>
<span id="cb31-883"><a href="#cb31-883" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_name =</span> SAMPLE_ID)</span>
<span id="cb31-884"><a href="#cb31-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-885"><a href="#cb31-885" aria-hidden="true" tabindex="-1"></a>smc_df <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb31-886"><a href="#cb31-886" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../data/2018_SMC/data_mrna_seq_tpm.txt"</span>,</span>
<span id="cb31-887"><a href="#cb31-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb31-888"><a href="#cb31-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">header =</span> <span class="cn">TRUE</span></span>
<span id="cb31-889"><a href="#cb31-889" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-890"><a href="#cb31-890" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(Hugo_Symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb31-891"><a href="#cb31-891" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Entrez_Gene_Id =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-892"><a href="#cb31-892" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>Hugo_Symbol) <span class="sc">%&gt;%</span></span>
<span id="cb31-893"><a href="#cb31-893" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Hugo_Symbol =</span> <span class="cn">NULL</span>)</span>
<span id="cb31-894"><a href="#cb31-894" aria-hidden="true" tabindex="-1"></a>smc_df <span class="ot">&lt;-</span> smc_df[, <span class="fu">rownames</span>(clin_data_smc)]</span>
<span id="cb31-895"><a href="#cb31-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-896"><a href="#cb31-896" aria-hidden="true" tabindex="-1"></a><span class="co"># almost all genes are available, only 4 are missing</span></span>
<span id="cb31-897"><a href="#cb31-897" aria-hidden="true" tabindex="-1"></a>smc_df <span class="ot">&lt;-</span> SummarizedExperiment<span class="sc">::</span><span class="fu">SummarizedExperiment</span>(</span>
<span id="cb31-898"><a href="#cb31-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">assays =</span> <span class="fu">list</span>(</span>
<span id="cb31-899"><a href="#cb31-899" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tpm"</span> <span class="ot">=</span> smc_df,</span>
<span id="cb31-900"><a href="#cb31-900" aria-hidden="true" tabindex="-1"></a>        <span class="st">"logtpm"</span> <span class="ot">=</span> <span class="fu">log2</span>(smc_df <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb31-901"><a href="#cb31-901" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-902"><a href="#cb31-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">colData =</span> clin_data_smc</span>
<span id="cb31-903"><a href="#cb31-903" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-904"><a href="#cb31-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-905"><a href="#cb31-905" aria-hidden="true" tabindex="-1"></a><span class="co"># get the normalization performed </span></span>
<span id="cb31-906"><a href="#cb31-906" aria-hidden="true" tabindex="-1"></a>smc_normalized <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb31-907"><a href="#cb31-907" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> smc_df,</span>
<span id="cb31-908"><a href="#cb31-908" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"logtpm"</span>,</span>
<span id="cb31-909"><a href="#cb31-909" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes,</span>
<span id="cb31-910"><a href="#cb31-910" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(<span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings), stable_genes)</span>
<span id="cb31-911"><a href="#cb31-911" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-912"><a href="#cb31-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-913"><a href="#cb31-913" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the embedding</span></span>
<span id="cb31-914"><a href="#cb31-914" aria-hidden="true" tabindex="-1"></a>smc_df_pca <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(smc_normalized, pca_fit) <span class="sc">%&gt;%</span></span>
<span id="cb31-915"><a href="#cb31-915" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb31-916"><a href="#cb31-916" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb31-917"><a href="#cb31-917" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(smc_normalized) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb31-918"><a href="#cb31-918" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-919"><a href="#cb31-919" aria-hidden="true" tabindex="-1"></a>                <span class="at">er_status =</span> <span class="fu">ifelse</span>(</span>
<span id="cb31-920"><a href="#cb31-920" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_detect</span>(IHC_SUBTYPE, <span class="st">"ER</span><span class="sc">\\</span><span class="st">+"</span>), <span class="st">"pos"</span>, <span class="st">"neg"</span></span>
<span id="cb31-921"><a href="#cb31-921" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb31-922"><a href="#cb31-922" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-923"><a href="#cb31-923" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">cohort =</span> <span class="st">"smc"</span>)</span>
<span id="cb31-924"><a href="#cb31-924" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-925"><a href="#cb31-925" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., df_pca_coordinates)</span>
<span id="cb31-926"><a href="#cb31-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-927"><a href="#cb31-927" aria-hidden="true" tabindex="-1"></a><span class="co"># save all the results</span></span>
<span id="cb31-928"><a href="#cb31-928" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-929"><a href="#cb31-929" aria-hidden="true" tabindex="-1"></a>    smc_df,</span>
<span id="cb31-930"><a href="#cb31-930" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/smc_df.rds"</span></span>
<span id="cb31-931"><a href="#cb31-931" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-932"><a href="#cb31-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-933"><a href="#cb31-933" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-934"><a href="#cb31-934" aria-hidden="true" tabindex="-1"></a>    smc_df_pca <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb31-935"><a href="#cb31-935" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/smc_df_pca.rds"</span></span>
<span id="cb31-936"><a href="#cb31-936" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-937"><a href="#cb31-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-938"><a href="#cb31-938" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-939"><a href="#cb31-939" aria-hidden="true" tabindex="-1"></a>    smc_normalized,</span>
<span id="cb31-940"><a href="#cb31-940" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/smc_normalized.rds"</span></span>
<span id="cb31-941"><a href="#cb31-941" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-942"><a href="#cb31-942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-943"><a href="#cb31-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-944"><a href="#cb31-944" aria-hidden="true" tabindex="-1"></a>When checking the total number of genes missing, there are only </span>
<span id="cb31-945"><a href="#cb31-945" aria-hidden="true" tabindex="-1"></a><span class="in">`r nrow(datasets_normalized$tcga) - nrow(smc_normalized)`</span> genes missing. </span>
<span id="cb31-946"><a href="#cb31-946" aria-hidden="true" tabindex="-1"></a>And as seen before, this number is almost irrelevant, in the sense that</span>
<span id="cb31-947"><a href="#cb31-947" aria-hidden="true" tabindex="-1"></a>the embedding will still be robust and locations will be precise enough.</span>
<span id="cb31-948"><a href="#cb31-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-951"><a href="#cb31-951" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-952"><a href="#cb31-952" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-smc-cohort</span></span>
<span id="cb31-953"><a href="#cb31-953" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Biplot of first two PCA components from SMC, TCGA, SCANB and </span></span>
<span id="cb31-954"><a href="#cb31-954" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC. SMC is highlighted in the plot and has a bigger dot.</span></span>
<span id="cb31-955"><a href="#cb31-955" aria-hidden="true" tabindex="-1"></a>smc_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb31-956"><a href="#cb31-956" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb31-957"><a href="#cb31-957" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> cohort)</span>
<span id="cb31-958"><a href="#cb31-958" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-959"><a href="#cb31-959" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb31-960"><a href="#cb31-960" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-961"><a href="#cb31-961" aria-hidden="true" tabindex="-1"></a>        <span class="st">"smc"</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb31-962"><a href="#cb31-962" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-963"><a href="#cb31-963" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-964"><a href="#cb31-964" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb31-965"><a href="#cb31-965" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-966"><a href="#cb31-966" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-967"><a href="#cb31-967" aria-hidden="true" tabindex="-1"></a>        <span class="st">"smc"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb31-968"><a href="#cb31-968" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-969"><a href="#cb31-969" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-970"><a href="#cb31-970" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb31-971"><a href="#cb31-971" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-972"><a href="#cb31-972" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-973"><a href="#cb31-973" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-974"><a href="#cb31-974" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-975"><a href="#cb31-975" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-976"><a href="#cb31-976" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-977"><a href="#cb31-977" aria-hidden="true" tabindex="-1"></a>            <span class="st">"First two components of SMC overlayed on all the three</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-978"><a href="#cb31-978" aria-hidden="true" tabindex="-1"></a>            <span class="st">"big cohorts in the the molecular landscape"</span></span>
<span id="cb31-979"><a href="#cb31-979" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-980"><a href="#cb31-980" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, METABRIC and SCANB are plotted"</span></span>
<span id="cb31-981"><a href="#cb31-981" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-982"><a href="#cb31-982" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb31-983"><a href="#cb31-983" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-984"><a href="#cb31-984" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-985"><a href="#cb31-985" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-986"><a href="#cb31-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-987"><a href="#cb31-987" aria-hidden="true" tabindex="-1"></a>As previously, @fig-pca-smc-er-pam50 shows the biplot of PC3 and PC4, </span>
<span id="cb31-988"><a href="#cb31-988" aria-hidden="true" tabindex="-1"></a>highlighting the well mixing of the cohorts. When coloring by ER status,</span>
<span id="cb31-989"><a href="#cb31-989" aria-hidden="true" tabindex="-1"></a>samples are in the right group. Molecular subtype is also correct. This</span>
<span id="cb31-990"><a href="#cb31-990" aria-hidden="true" tabindex="-1"></a>cohort is special in the sense that there are more luminal B patients,</span>
<span id="cb31-991"><a href="#cb31-991" aria-hidden="true" tabindex="-1"></a>as discussed in the paper. That is why there are more samples in the </span>
<span id="cb31-992"><a href="#cb31-992" aria-hidden="true" tabindex="-1"></a>luminal B region.</span>
<span id="cb31-993"><a href="#cb31-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-994"><a href="#cb31-994" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=18, fig.height=11}</span></span>
<span id="cb31-995"><a href="#cb31-995" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-smc-er-pam50</span></span>
<span id="cb31-996"><a href="#cb31-996" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC including</span></span>
<span id="cb31-997"><a href="#cb31-997" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the SMC samples on top.</span></span>
<span id="cb31-998"><a href="#cb31-998" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (A) Colored by cohort,</span></span>
<span id="cb31-999"><a href="#cb31-999" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (B) colored by ER status, (C) colored by PAM50 molecular subtype.</span></span>
<span id="cb31-1000"><a href="#cb31-1000" aria-hidden="true" tabindex="-1"></a>plots_smc <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-1001"><a href="#cb31-1001" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"cohort"</span>, <span class="st">"er_status"</span>, <span class="st">"pam50"</span>), </span>
<span id="cb31-1002"><a href="#cb31-1002" aria-hidden="true" tabindex="-1"></a>    get_plot_new_samples,</span>
<span id="cb31-1003"><a href="#cb31-1003" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cohort =</span> <span class="st">"smc"</span>,</span>
<span id="cb31-1004"><a href="#cb31-1004" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> smc_df_pca <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">!=</span> <span class="st">"scanb"</span>),</span>
<span id="cb31-1005"><a href="#cb31-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb31-1006"><a href="#cb31-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb31-1007"><a href="#cb31-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-1008"><a href="#cb31-1008" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1009"><a href="#cb31-1009" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1010"><a href="#cb31-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1011"><a href="#cb31-1011" aria-hidden="true" tabindex="-1"></a>plots_smc<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> plots_smc<span class="sc">$</span>pam50 <span class="sc">+</span></span>
<span id="cb31-1012"><a href="#cb31-1012" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb31-1013"><a href="#cb31-1013" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_colors_pam50</span>(plots_smc<span class="sc">$</span>pam50<span class="sc">$</span>data)</span>
<span id="cb31-1014"><a href="#cb31-1014" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1015"><a href="#cb31-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1016"><a href="#cb31-1016" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plots_smc)</span>
<span id="cb31-1017"><a href="#cb31-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1018"><a href="#cb31-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1019"><a href="#cb31-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">## PDX </span></span>
<span id="cb31-1020"><a href="#cb31-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1021"><a href="#cb31-1021" aria-hidden="true" tabindex="-1"></a>Another way to validate the results is to use patient derived xenografts.</span>
<span id="cb31-1022"><a href="#cb31-1022" aria-hidden="true" tabindex="-1"></a>In the Brisken lab the MIND model is used <span class="co">[</span><span class="ot">@Sflomos2016; @Scabia2022</span><span class="co">]</span>. </span>
<span id="cb31-1023"><a href="#cb31-1023" aria-hidden="true" tabindex="-1"></a>ER+ breast cancer</span>
<span id="cb31-1024"><a href="#cb31-1024" aria-hidden="true" tabindex="-1"></a>samples coming from patients are processed in a specific way and</span>
<span id="cb31-1025"><a href="#cb31-1025" aria-hidden="true" tabindex="-1"></a>injected into the mammary glands of mice. Based on that they can</span>
<span id="cb31-1026"><a href="#cb31-1026" aria-hidden="true" tabindex="-1"></a>stablish themselves and proliferate. The environment should recapitulate</span>
<span id="cb31-1027"><a href="#cb31-1027" aria-hidden="true" tabindex="-1"></a>what is seen in women as well, in the sense that estrogen (E2) levels </span>
<span id="cb31-1028"><a href="#cb31-1028" aria-hidden="true" tabindex="-1"></a>are similar to those of post-menopausal women. Since these cells have</span>
<span id="cb31-1029"><a href="#cb31-1029" aria-hidden="true" tabindex="-1"></a>to proliferate in order to establish and grow in the ducts, we expect</span>
<span id="cb31-1030"><a href="#cb31-1030" aria-hidden="true" tabindex="-1"></a>them to be more proliferative in terms of RNA-seq components and also</span>
<span id="cb31-1031"><a href="#cb31-1031" aria-hidden="true" tabindex="-1"></a>to lie in the luminal B region of the molecular landscape. We validate</span>
<span id="cb31-1032"><a href="#cb31-1032" aria-hidden="true" tabindex="-1"></a>this now. </span>
<span id="cb31-1033"><a href="#cb31-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1034"><a href="#cb31-1034" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=first_run}</span></span>
<span id="cb31-1035"><a href="#cb31-1035" aria-hidden="true" tabindex="-1"></a>path_data <span class="ot">&lt;-</span> <span class="st">"../data/2019_pdx_brisken"</span></span>
<span id="cb31-1036"><a href="#cb31-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1037"><a href="#cb31-1037" aria-hidden="true" tabindex="-1"></a>tx2gene <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_table</span>(</span>
<span id="cb31-1038"><a href="#cb31-1038" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.path</span>(path_data, <span class="st">"transcripts_to_genes.txt"</span>), </span>
<span id="cb31-1039"><a href="#cb31-1039" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">"transcript"</span>, <span class="st">"gene"</span>, <span class="st">"symbol"</span>)</span>
<span id="cb31-1040"><a href="#cb31-1040" aria-hidden="true" tabindex="-1"></a>)[, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)]</span>
<span id="cb31-1041"><a href="#cb31-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1042"><a href="#cb31-1042" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">file.path</span>(path_data, <span class="st">"abundance"</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-1043"><a href="#cb31-1043" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(files, <span class="st">"abundance.h5"</span>)</span>
<span id="cb31-1044"><a href="#cb31-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(files) <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">file.path</span>(path_data, <span class="st">"abundance"</span>))</span>
<span id="cb31-1045"><a href="#cb31-1045" aria-hidden="true" tabindex="-1"></a>txi <span class="ot">&lt;-</span> tximport<span class="sc">::</span><span class="fu">tximport</span>(</span>
<span id="cb31-1046"><a href="#cb31-1046" aria-hidden="true" tabindex="-1"></a>    files, </span>
<span id="cb31-1047"><a href="#cb31-1047" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"kallisto"</span>, </span>
<span id="cb31-1048"><a href="#cb31-1048" aria-hidden="true" tabindex="-1"></a>    <span class="at">tx2gene =</span> tx2gene, </span>
<span id="cb31-1049"><a href="#cb31-1049" aria-hidden="true" tabindex="-1"></a>    <span class="at">countsFromAbundance =</span> <span class="st">"lengthScaledTPM"</span></span>
<span id="cb31-1050"><a href="#cb31-1050" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1051"><a href="#cb31-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1052"><a href="#cb31-1052" aria-hidden="true" tabindex="-1"></a>pdx_tpm <span class="ot">&lt;-</span> txi<span class="sc">$</span>abundance</span>
<span id="cb31-1053"><a href="#cb31-1053" aria-hidden="true" tabindex="-1"></a>log2_pdx_tpm <span class="ot">&lt;-</span> <span class="fu">log2</span>(pdx_tpm <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb31-1054"><a href="#cb31-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1055"><a href="#cb31-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># filter the samples to remove lowly expressed genes</span></span>
<span id="cb31-1056"><a href="#cb31-1056" aria-hidden="true" tabindex="-1"></a>highly_expressed <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(log2_pdx_tpm <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.3</span></span>
<span id="cb31-1057"><a href="#cb31-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1058"><a href="#cb31-1058" aria-hidden="true" tabindex="-1"></a><span class="co"># load the metadata so we can create later the summarized</span></span>
<span id="cb31-1059"><a href="#cb31-1059" aria-hidden="true" tabindex="-1"></a><span class="co"># experiment object for the downstream analysis</span></span>
<span id="cb31-1060"><a href="#cb31-1060" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="fu">file.path</span>(path_data, <span class="st">"metadata.csv"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1061"><a href="#cb31-1061" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pdx =</span> <span class="fu">sapply</span>(</span>
<span id="cb31-1062"><a href="#cb31-1062" aria-hidden="true" tabindex="-1"></a>        sample_name,</span>
<span id="cb31-1063"><a href="#cb31-1063" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) stringr<span class="sc">::</span><span class="fu">str_split</span>(x, <span class="st">"_"</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>] <span class="sc">%&gt;%</span></span>
<span id="cb31-1064"><a href="#cb31-1064" aria-hidden="true" tabindex="-1"></a>            as.character</span>
<span id="cb31-1065"><a href="#cb31-1065" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb31-1066"><a href="#cb31-1066" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(metadata) <span class="ot">&lt;-</span> metadata<span class="sc">$</span>sample_name</span>
<span id="cb31-1067"><a href="#cb31-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1068"><a href="#cb31-1068" aria-hidden="true" tabindex="-1"></a>pdx_tpm <span class="ot">&lt;-</span> SummarizedExperiment<span class="sc">::</span><span class="fu">SummarizedExperiment</span>(</span>
<span id="cb31-1069"><a href="#cb31-1069" aria-hidden="true" tabindex="-1"></a>    <span class="at">assays =</span> <span class="fu">list</span>(</span>
<span id="cb31-1070"><a href="#cb31-1070" aria-hidden="true" tabindex="-1"></a>            <span class="at">tpm =</span> pdx_tpm[highly_expressed, ],</span>
<span id="cb31-1071"><a href="#cb31-1071" aria-hidden="true" tabindex="-1"></a>            <span class="at">log2tpm =</span> log2_pdx_tpm[highly_expressed, ]</span>
<span id="cb31-1072"><a href="#cb31-1072" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1073"><a href="#cb31-1073" aria-hidden="true" tabindex="-1"></a>    <span class="at">colData =</span> metadata[<span class="fu">colnames</span>(pdx_tpm), ]</span>
<span id="cb31-1074"><a href="#cb31-1074" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1075"><a href="#cb31-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1076"><a href="#cb31-1076" aria-hidden="true" tabindex="-1"></a>pdx_normalized <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb31-1077"><a href="#cb31-1077" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> pdx_tpm,</span>
<span id="cb31-1078"><a href="#cb31-1078" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"log2tpm"</span>,</span>
<span id="cb31-1079"><a href="#cb31-1079" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes,</span>
<span id="cb31-1080"><a href="#cb31-1080" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(<span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings), stable_genes)</span>
<span id="cb31-1081"><a href="#cb31-1081" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1082"><a href="#cb31-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1083"><a href="#cb31-1083" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the embedding</span></span>
<span id="cb31-1084"><a href="#cb31-1084" aria-hidden="true" tabindex="-1"></a>pdx_df_pca <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(pdx_normalized, pca_fit) <span class="sc">%&gt;%</span></span>
<span id="cb31-1085"><a href="#cb31-1085" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb31-1086"><a href="#cb31-1086" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb31-1087"><a href="#cb31-1087" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(pdx_tpm) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1088"><a href="#cb31-1088" aria-hidden="true" tabindex="-1"></a>            data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb31-1089"><a href="#cb31-1089" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">cohort =</span> <span class="st">"pdx"</span>)</span>
<span id="cb31-1090"><a href="#cb31-1090" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1091"><a href="#cb31-1091" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., df_pca_coordinates)</span>
<span id="cb31-1092"><a href="#cb31-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1093"><a href="#cb31-1093" aria-hidden="true" tabindex="-1"></a><span class="co"># save all the results</span></span>
<span id="cb31-1094"><a href="#cb31-1094" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1095"><a href="#cb31-1095" aria-hidden="true" tabindex="-1"></a>    pdx_tpm,</span>
<span id="cb31-1096"><a href="#cb31-1096" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pdx_tpm.rds"</span></span>
<span id="cb31-1097"><a href="#cb31-1097" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1098"><a href="#cb31-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1099"><a href="#cb31-1099" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1100"><a href="#cb31-1100" aria-hidden="true" tabindex="-1"></a>    pdx_df_pca <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb31-1101"><a href="#cb31-1101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pdx_df_pca.rds"</span></span>
<span id="cb31-1102"><a href="#cb31-1102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1103"><a href="#cb31-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1104"><a href="#cb31-1104" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1105"><a href="#cb31-1105" aria-hidden="true" tabindex="-1"></a>    pdx_normalized,</span>
<span id="cb31-1106"><a href="#cb31-1106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pdx_normalized.rds"</span></span>
<span id="cb31-1107"><a href="#cb31-1107" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1108"><a href="#cb31-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1109"><a href="#cb31-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1110"><a href="#cb31-1110" aria-hidden="true" tabindex="-1"></a>When checking the total number of genes missing, there are only </span>
<span id="cb31-1111"><a href="#cb31-1111" aria-hidden="true" tabindex="-1"></a><span class="in">`r nrow(datasets_normalized$tcga) - nrow(pdx_normalized)`</span> genes missing. </span>
<span id="cb31-1112"><a href="#cb31-1112" aria-hidden="true" tabindex="-1"></a>And as seen before, this number is almost irrelevant, in the sense that</span>
<span id="cb31-1113"><a href="#cb31-1113" aria-hidden="true" tabindex="-1"></a>the embedding will still be robust and locations will be precise enough.</span>
<span id="cb31-1114"><a href="#cb31-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1117"><a href="#cb31-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1118"><a href="#cb31-1118" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pdx-cohort</span></span>
<span id="cb31-1119"><a href="#cb31-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Biplot of first two PCA components from PDX, TCGA, SCANB and </span></span>
<span id="cb31-1120"><a href="#cb31-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC. PDX is highlighted in the plot and has bigger dot size.</span></span>
<span id="cb31-1121"><a href="#cb31-1121" aria-hidden="true" tabindex="-1"></a>pdx_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb31-1122"><a href="#cb31-1122" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb31-1123"><a href="#cb31-1123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> cohort)</span>
<span id="cb31-1124"><a href="#cb31-1124" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1125"><a href="#cb31-1125" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb31-1126"><a href="#cb31-1126" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1127"><a href="#cb31-1127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pdx"</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb31-1128"><a href="#cb31-1128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1129"><a href="#cb31-1129" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1130"><a href="#cb31-1130" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb31-1131"><a href="#cb31-1131" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1132"><a href="#cb31-1132" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1133"><a href="#cb31-1133" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pdx"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb31-1134"><a href="#cb31-1134" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1135"><a href="#cb31-1135" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1136"><a href="#cb31-1136" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb31-1137"><a href="#cb31-1137" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1138"><a href="#cb31-1138" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1139"><a href="#cb31-1139" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1140"><a href="#cb31-1140" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1141"><a href="#cb31-1141" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1142"><a href="#cb31-1142" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1143"><a href="#cb31-1143" aria-hidden="true" tabindex="-1"></a>            <span class="st">"First two components of PDX cohort overlayed on all the three</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-1144"><a href="#cb31-1144" aria-hidden="true" tabindex="-1"></a>            <span class="st">"big cohorts in the the molecular landscape"</span></span>
<span id="cb31-1145"><a href="#cb31-1145" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1146"><a href="#cb31-1146" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, METABRIC and SCANB are plotted"</span></span>
<span id="cb31-1147"><a href="#cb31-1147" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1148"><a href="#cb31-1148" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb31-1149"><a href="#cb31-1149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1150"><a href="#cb31-1150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-1151"><a href="#cb31-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1152"><a href="#cb31-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1153"><a href="#cb31-1153" aria-hidden="true" tabindex="-1"></a>As previously, @fig-pca-pdx-cohort shows the biplot of PC3 and PC4, </span>
<span id="cb31-1154"><a href="#cb31-1154" aria-hidden="true" tabindex="-1"></a>highlighting the well mixing of the cohorts. As expected the samples are </span>
<span id="cb31-1155"><a href="#cb31-1155" aria-hidden="true" tabindex="-1"></a>overall in the luminal B region, since these are tumor cells in a </span>
<span id="cb31-1156"><a href="#cb31-1156" aria-hidden="true" tabindex="-1"></a>proliferative state.</span>
<span id="cb31-1157"><a href="#cb31-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1158"><a href="#cb31-1158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=6}</span></span>
<span id="cb31-1159"><a href="#cb31-1159" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-pdx-cohort</span></span>
<span id="cb31-1160"><a href="#cb31-1160" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of all samples from TCGA and METABRIC including</span></span>
<span id="cb31-1161"><a href="#cb31-1161" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the PDX samples on top.</span></span>
<span id="cb31-1162"><a href="#cb31-1162" aria-hidden="true" tabindex="-1"></a>pdx_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb31-1163"><a href="#cb31-1163" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb31-1164"><a href="#cb31-1164" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">color =</span> cohort)</span>
<span id="cb31-1165"><a href="#cb31-1165" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1166"><a href="#cb31-1166" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb31-1167"><a href="#cb31-1167" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1168"><a href="#cb31-1168" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pdx"</span> <span class="ot">=</span> <span class="dv">3</span>, </span>
<span id="cb31-1169"><a href="#cb31-1169" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1170"><a href="#cb31-1170" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1171"><a href="#cb31-1171" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb31-1172"><a href="#cb31-1172" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1173"><a href="#cb31-1173" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1174"><a href="#cb31-1174" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pdx"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb31-1175"><a href="#cb31-1175" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1176"><a href="#cb31-1176" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1177"><a href="#cb31-1177" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb31-1178"><a href="#cb31-1178" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1179"><a href="#cb31-1179" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1180"><a href="#cb31-1180" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1181"><a href="#cb31-1181" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1182"><a href="#cb31-1182" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1183"><a href="#cb31-1183" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1184"><a href="#cb31-1184" aria-hidden="true" tabindex="-1"></a>            <span class="st">"PDX cohort embedding"</span></span>
<span id="cb31-1185"><a href="#cb31-1185" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1186"><a href="#cb31-1186" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, SCANB and METABRIC are plotted"</span></span>
<span id="cb31-1187"><a href="#cb31-1187" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1188"><a href="#cb31-1188" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb31-1189"><a href="#cb31-1189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1190"><a href="#cb31-1190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-1191"><a href="#cb31-1191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1192"><a href="#cb31-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1193"><a href="#cb31-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1194"><a href="#cb31-1194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=9, fig.height=6}</span></span>
<span id="cb31-1195"><a href="#cb31-1195" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-pdx-control-only</span></span>
<span id="cb31-1196"><a href="#cb31-1196" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of only PDX control samples on top of the </span></span>
<span id="cb31-1197"><a href="#cb31-1197" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC, SCANB and TCGA samples</span></span>
<span id="cb31-1198"><a href="#cb31-1198" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">get_base_plot</span>(df_pca_coordinates)</span>
<span id="cb31-1199"><a href="#cb31-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1200"><a href="#cb31-1200" aria-hidden="true" tabindex="-1"></a>pdx_df_pca_sub <span class="ot">&lt;-</span> pdx_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb31-1201"><a href="#cb31-1201" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"pdx"</span> <span class="sc">&amp;</span> treatment <span class="sc">==</span> <span class="st">"CTRL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1202"><a href="#cb31-1202" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pam50 =</span> <span class="st">"nc"</span>)</span>
<span id="cb31-1203"><a href="#cb31-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1204"><a href="#cb31-1204" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb31-1205"><a href="#cb31-1205" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb31-1206"><a href="#cb31-1206" aria-hidden="true" tabindex="-1"></a>        pdx_df_pca_sub,</span>
<span id="cb31-1207"><a href="#cb31-1207" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">shape =</span> pdx),</span>
<span id="cb31-1208"><a href="#cb31-1208" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb31-1209"><a href="#cb31-1209" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1210"><a href="#cb31-1210" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb31-1211"><a href="#cb31-1211" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1212"><a href="#cb31-1212" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="st">"Grey points correspond to the PDX cohort"</span>,</span>
<span id="cb31-1213"><a href="#cb31-1213" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"PDX cohort, only control samples"</span></span>
<span id="cb31-1214"><a href="#cb31-1214" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1215"><a href="#cb31-1215" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb31-1216"><a href="#cb31-1216" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1217"><a href="#cb31-1217" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_colors_pam50</span>(p<span class="sc">$</span>data),</span>
<span id="cb31-1218"><a href="#cb31-1218" aria-hidden="true" tabindex="-1"></a>            <span class="st">"not available"</span> <span class="ot">=</span> <span class="st">"grey"</span></span>
<span id="cb31-1219"><a href="#cb31-1219" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1220"><a href="#cb31-1220" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1221"><a href="#cb31-1221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1222"><a href="#cb31-1222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>(<span class="at">shape =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-1223"><a href="#cb31-1223" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1224"><a href="#cb31-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1225"><a href="#cb31-1225" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normal samples</span></span>
<span id="cb31-1226"><a href="#cb31-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1227"><a href="#cb31-1227" aria-hidden="true" tabindex="-1"></a>We now further validate the molecular landscape on the normal samples</span>
<span id="cb31-1228"><a href="#cb31-1228" aria-hidden="true" tabindex="-1"></a>that were sequenced using the same pipeline as the SCANB data. These</span>
<span id="cb31-1229"><a href="#cb31-1229" aria-hidden="true" tabindex="-1"></a>are samples obtained from reduction mammoplasty of swiss women and were</span>
<span id="cb31-1230"><a href="#cb31-1230" aria-hidden="true" tabindex="-1"></a>sent to Sweden for the tissue processing and sequecing. The hypotheses </span>
<span id="cb31-1231"><a href="#cb31-1231" aria-hidden="true" tabindex="-1"></a>here is that the samples will be embedded in the region of the normal</span>
<span id="cb31-1232"><a href="#cb31-1232" aria-hidden="true" tabindex="-1"></a>like BC samples.</span>
<span id="cb31-1233"><a href="#cb31-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1234"><a href="#cb31-1234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb31-1235"><a href="#cb31-1235" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data and perform the normalization + embedding</span></span>
<span id="cb31-1236"><a href="#cb31-1236" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/scanb_2022/Normal.66.mymatrix.Rdata"</span>)</span>
<span id="cb31-1237"><a href="#cb31-1237" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../data/scanb_2022/Gene.ID.ann.Rdata"</span>)</span>
<span id="cb31-1238"><a href="#cb31-1238" aria-hidden="true" tabindex="-1"></a>normal_swiss <span class="ot">&lt;-</span> Normal.<span class="fl">66.</span>mymatrix</span>
<span id="cb31-1239"><a href="#cb31-1239" aria-hidden="true" tabindex="-1"></a>gene_id_ann <span class="ot">&lt;-</span> Gene.ID.ann</span>
<span id="cb31-1240"><a href="#cb31-1240" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(normal_swiss) <span class="ot">&lt;-</span> gene_id_ann[<span class="fu">rownames</span>(normal_swiss), <span class="st">"Gene.Name"</span>]</span>
<span id="cb31-1241"><a href="#cb31-1241" aria-hidden="true" tabindex="-1"></a>normal_swiss <span class="ot">&lt;-</span> normal_swiss[<span class="sc">!</span><span class="fu">duplicated</span>(<span class="fu">rownames</span>(normal_swiss)), ]</span>
<span id="cb31-1242"><a href="#cb31-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1243"><a href="#cb31-1243" aria-hidden="true" tabindex="-1"></a>normal_swiss <span class="ot">&lt;-</span> SummarizedExperiment<span class="sc">::</span><span class="fu">SummarizedExperiment</span>(</span>
<span id="cb31-1244"><a href="#cb31-1244" aria-hidden="true" tabindex="-1"></a>    <span class="at">assays =</span> <span class="fu">list</span>(</span>
<span id="cb31-1245"><a href="#cb31-1245" aria-hidden="true" tabindex="-1"></a>            <span class="at">fpkm =</span> normal_swiss,</span>
<span id="cb31-1246"><a href="#cb31-1246" aria-hidden="true" tabindex="-1"></a>            <span class="at">log2fpkm =</span> <span class="fu">log2</span>(normal_swiss <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb31-1247"><a href="#cb31-1247" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1248"><a href="#cb31-1248" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1249"><a href="#cb31-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1250"><a href="#cb31-1250" aria-hidden="true" tabindex="-1"></a>normal_swiss_normalized <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb31-1251"><a href="#cb31-1251" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> normal_swiss,</span>
<span id="cb31-1252"><a href="#cb31-1252" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"log2fpkm"</span>,</span>
<span id="cb31-1253"><a href="#cb31-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes,</span>
<span id="cb31-1254"><a href="#cb31-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(<span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings), stable_genes)</span>
<span id="cb31-1255"><a href="#cb31-1255" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1256"><a href="#cb31-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1257"><a href="#cb31-1257" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the embedding</span></span>
<span id="cb31-1258"><a href="#cb31-1258" aria-hidden="true" tabindex="-1"></a>normal_swiss_df_pca <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(normal_swiss_normalized, pca_fit) <span class="sc">%&gt;%</span></span>
<span id="cb31-1259"><a href="#cb31-1259" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb31-1260"><a href="#cb31-1260" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb31-1261"><a href="#cb31-1261" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">cohort =</span> <span class="fu">rep</span>(<span class="st">"normal_swiss"</span>, <span class="fu">ncol</span>(normal_swiss_normalized)))</span>
<span id="cb31-1262"><a href="#cb31-1262" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1263"><a href="#cb31-1263" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., df_pca_coordinates)</span>
<span id="cb31-1264"><a href="#cb31-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1265"><a href="#cb31-1265" aria-hidden="true" tabindex="-1"></a><span class="co"># save all the results</span></span>
<span id="cb31-1266"><a href="#cb31-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1267"><a href="#cb31-1267" aria-hidden="true" tabindex="-1"></a>    normal_swiss,</span>
<span id="cb31-1268"><a href="#cb31-1268" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/normal_swiss.rds"</span></span>
<span id="cb31-1269"><a href="#cb31-1269" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1270"><a href="#cb31-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1271"><a href="#cb31-1271" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1272"><a href="#cb31-1272" aria-hidden="true" tabindex="-1"></a>    normal_swiss_df_pca <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb31-1273"><a href="#cb31-1273" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/normal_swiss_df_pca.rds"</span></span>
<span id="cb31-1274"><a href="#cb31-1274" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1275"><a href="#cb31-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1276"><a href="#cb31-1276" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1277"><a href="#cb31-1277" aria-hidden="true" tabindex="-1"></a>    normal_swiss_normalized,</span>
<span id="cb31-1278"><a href="#cb31-1278" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/normal_swiss_normalized.rds"</span></span>
<span id="cb31-1279"><a href="#cb31-1279" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1280"><a href="#cb31-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1281"><a href="#cb31-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1282"><a href="#cb31-1282" aria-hidden="true" tabindex="-1"></a>When checking the total number of genes missing, there are only </span>
<span id="cb31-1283"><a href="#cb31-1283" aria-hidden="true" tabindex="-1"></a><span class="in">`r nrow(datasets_normalized$tcga) - nrow(normal_swiss_normalized)`</span> genes</span>
<span id="cb31-1284"><a href="#cb31-1284" aria-hidden="true" tabindex="-1"></a>missing, i.e., no genes were missing. This makes sense as these samples were</span>
<span id="cb31-1285"><a href="#cb31-1285" aria-hidden="true" tabindex="-1"></a>processed in the same way as the ones from SCANB.</span>
<span id="cb31-1286"><a href="#cb31-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1289"><a href="#cb31-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1290"><a href="#cb31-1290" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-normal-cohort</span></span>
<span id="cb31-1291"><a href="#cb31-1291" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Biplot of first two PCA components from Normal Swiss Cohort, </span></span>
<span id="cb31-1292"><a href="#cb31-1292" aria-hidden="true" tabindex="-1"></a><span class="co">#|     TCGA, SCANB and </span></span>
<span id="cb31-1293"><a href="#cb31-1293" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC. The normal cohort is highlighted in the plot and</span></span>
<span id="cb31-1294"><a href="#cb31-1294" aria-hidden="true" tabindex="-1"></a><span class="co">#|     has bigger dot size.</span></span>
<span id="cb31-1295"><a href="#cb31-1295" aria-hidden="true" tabindex="-1"></a>normal_swiss_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb31-1296"><a href="#cb31-1296" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb31-1297"><a href="#cb31-1297" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> cohort)</span>
<span id="cb31-1298"><a href="#cb31-1298" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1299"><a href="#cb31-1299" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb31-1300"><a href="#cb31-1300" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1301"><a href="#cb31-1301" aria-hidden="true" tabindex="-1"></a>        <span class="st">"normal_swiss"</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb31-1302"><a href="#cb31-1302" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1303"><a href="#cb31-1303" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1304"><a href="#cb31-1304" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb31-1305"><a href="#cb31-1305" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1306"><a href="#cb31-1306" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1307"><a href="#cb31-1307" aria-hidden="true" tabindex="-1"></a>        <span class="st">"normal_swiss"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb31-1308"><a href="#cb31-1308" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1309"><a href="#cb31-1309" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1310"><a href="#cb31-1310" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb31-1311"><a href="#cb31-1311" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1312"><a href="#cb31-1312" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1313"><a href="#cb31-1313" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1314"><a href="#cb31-1314" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1315"><a href="#cb31-1315" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1316"><a href="#cb31-1316" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1317"><a href="#cb31-1317" aria-hidden="true" tabindex="-1"></a>            <span class="st">"First two components of Normal Swiss cohort overlayed on all</span><span class="sc">\n</span><span class="st">the three "</span>,</span>
<span id="cb31-1318"><a href="#cb31-1318" aria-hidden="true" tabindex="-1"></a>            <span class="st">"big cohorts in the the molecular landscape"</span></span>
<span id="cb31-1319"><a href="#cb31-1319" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1320"><a href="#cb31-1320" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, METABRIC and SCANB are plotted"</span></span>
<span id="cb31-1321"><a href="#cb31-1321" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1322"><a href="#cb31-1322" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb31-1323"><a href="#cb31-1323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1324"><a href="#cb31-1324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-1325"><a href="#cb31-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1326"><a href="#cb31-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1327"><a href="#cb31-1327" aria-hidden="true" tabindex="-1"></a>As previously, @fig-pca-normal-cohort shows the biplot of PC3 and PC4, </span>
<span id="cb31-1328"><a href="#cb31-1328" aria-hidden="true" tabindex="-1"></a>highlighting the well mixing of the cohorts. As expected the samples are </span>
<span id="cb31-1329"><a href="#cb31-1329" aria-hidden="true" tabindex="-1"></a>overall in the luminal B region, since these are tumor cells in a </span>
<span id="cb31-1330"><a href="#cb31-1330" aria-hidden="true" tabindex="-1"></a>proliferative state.</span>
<span id="cb31-1331"><a href="#cb31-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1332"><a href="#cb31-1332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=9, fig.height=6}</span></span>
<span id="cb31-1333"><a href="#cb31-1333" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-normal-cohort</span></span>
<span id="cb31-1334"><a href="#cb31-1334" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of all samples from TCGA, SCNAB and METABRIC including</span></span>
<span id="cb31-1335"><a href="#cb31-1335" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the Normal samples on top. </span></span>
<span id="cb31-1336"><a href="#cb31-1336" aria-hidden="true" tabindex="-1"></a>normal_swiss_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb31-1337"><a href="#cb31-1337" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb31-1338"><a href="#cb31-1338" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">color =</span> cohort)</span>
<span id="cb31-1339"><a href="#cb31-1339" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1340"><a href="#cb31-1340" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb31-1341"><a href="#cb31-1341" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1342"><a href="#cb31-1342" aria-hidden="true" tabindex="-1"></a>        <span class="st">"normal_swiss"</span> <span class="ot">=</span> <span class="dv">3</span>, </span>
<span id="cb31-1343"><a href="#cb31-1343" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1344"><a href="#cb31-1344" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb31-1345"><a href="#cb31-1345" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb31-1346"><a href="#cb31-1346" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1347"><a href="#cb31-1347" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1348"><a href="#cb31-1348" aria-hidden="true" tabindex="-1"></a>        <span class="st">"normal_swiss"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb31-1349"><a href="#cb31-1349" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1350"><a href="#cb31-1350" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb31-1351"><a href="#cb31-1351" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb31-1352"><a href="#cb31-1352" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb31-1353"><a href="#cb31-1353" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1354"><a href="#cb31-1354" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1355"><a href="#cb31-1355" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1356"><a href="#cb31-1356" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1357"><a href="#cb31-1357" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1358"><a href="#cb31-1358" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Normal Swiss cohort embedding"</span></span>
<span id="cb31-1359"><a href="#cb31-1359" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1360"><a href="#cb31-1360" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, SCANB and METABRIC are plotted"</span></span>
<span id="cb31-1361"><a href="#cb31-1361" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1362"><a href="#cb31-1362" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb31-1363"><a href="#cb31-1363" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1364"><a href="#cb31-1364" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-1365"><a href="#cb31-1365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1366"><a href="#cb31-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1367"><a href="#cb31-1367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=9, fig.height=6}</span></span>
<span id="cb31-1368"><a href="#cb31-1368" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-normal-pam50</span></span>
<span id="cb31-1369"><a href="#cb31-1369" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of Normal Swiss cohort with the </span></span>
<span id="cb31-1370"><a href="#cb31-1370" aria-hidden="true" tabindex="-1"></a><span class="co">#|     other cohorts colored by the PAM50. </span></span>
<span id="cb31-1371"><a href="#cb31-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1372"><a href="#cb31-1372" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">get_base_plot</span>(df_pca_coordinates)</span>
<span id="cb31-1373"><a href="#cb31-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1374"><a href="#cb31-1374" aria-hidden="true" tabindex="-1"></a>normal_df_pca_sub <span class="ot">&lt;-</span> normal_swiss_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb31-1375"><a href="#cb31-1375" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"normal_swiss"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1376"><a href="#cb31-1376" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pam50 =</span> <span class="st">"nc"</span>)</span>
<span id="cb31-1377"><a href="#cb31-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1378"><a href="#cb31-1378" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb31-1379"><a href="#cb31-1379" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb31-1380"><a href="#cb31-1380" aria-hidden="true" tabindex="-1"></a>        normal_df_pca_sub,</span>
<span id="cb31-1381"><a href="#cb31-1381" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4),</span>
<span id="cb31-1382"><a href="#cb31-1382" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb31-1383"><a href="#cb31-1383" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1384"><a href="#cb31-1384" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1385"><a href="#cb31-1385" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1386"><a href="#cb31-1386" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Normal Swiss cohort embedding"</span></span>
<span id="cb31-1387"><a href="#cb31-1387" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1388"><a href="#cb31-1388" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, SCANB and METABRIC are plotted"</span>,</span>
<span id="cb31-1389"><a href="#cb31-1389" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="st">"Grey points correspond to the swiss cohort"</span></span>
<span id="cb31-1390"><a href="#cb31-1390" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1391"><a href="#cb31-1391" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb31-1392"><a href="#cb31-1392" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb31-1393"><a href="#cb31-1393" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_colors_pam50</span>(p<span class="sc">$</span>data),</span>
<span id="cb31-1394"><a href="#cb31-1394" aria-hidden="true" tabindex="-1"></a>            <span class="st">"not available"</span> <span class="ot">=</span> <span class="st">"grey"</span></span>
<span id="cb31-1395"><a href="#cb31-1395" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1396"><a href="#cb31-1396" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1397"><a href="#cb31-1397" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb31-1398"><a href="#cb31-1398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1399"><a href="#cb31-1399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-1400"><a href="#cb31-1400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1401"><a href="#cb31-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1402"><a href="#cb31-1402" aria-hidden="true" tabindex="-1"></a><span class="fu">## Third component as a prognostic measure?</span></span>
<span id="cb31-1403"><a href="#cb31-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1404"><a href="#cb31-1404" aria-hidden="true" tabindex="-1"></a>We have seen that estrogen signaling is a continuous measure across</span>
<span id="cb31-1405"><a href="#cb31-1405" aria-hidden="true" tabindex="-1"></a>the third component. The farthest to the right you are the</span>
<span id="cb31-1406"><a href="#cb31-1406" aria-hidden="true" tabindex="-1"></a>higher the ER signaling scores are also. Here we hypothesized then</span>
<span id="cb31-1407"><a href="#cb31-1407" aria-hidden="true" tabindex="-1"></a>that the third component is correlated to the prognostic nature</span>
<span id="cb31-1408"><a href="#cb31-1408" aria-hidden="true" tabindex="-1"></a>of the estrogen signaling score. For this we select only samples</span>
<span id="cb31-1409"><a href="#cb31-1409" aria-hidden="true" tabindex="-1"></a>with PC3 higher than 0, as these would be the ones that are from</span>
<span id="cb31-1410"><a href="#cb31-1410" aria-hidden="true" tabindex="-1"></a>luminal A and B subtypes and we use PC3 as a score in the survival analysis.</span>
<span id="cb31-1411"><a href="#cb31-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1414"><a href="#cb31-1414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1415"><a href="#cb31-1415" aria-hidden="true" tabindex="-1"></a>scanb_samples <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb31-1416"><a href="#cb31-1416" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1417"><a href="#cb31-1417" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-1418"><a href="#cb31-1418" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NXs"</span> <span class="sc">&amp;</span></span>
<span id="cb31-1419"><a href="#cb31-1419" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb31-1420"><a href="#cb31-1420" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1421"><a href="#cb31-1421" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1422"><a href="#cb31-1422" aria-hidden="true" tabindex="-1"></a>        PC3 <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb31-1423"><a href="#cb31-1423" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1424"><a href="#cb31-1424" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb31-1425"><a href="#cb31-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1426"><a href="#cb31-1426" aria-hidden="true" tabindex="-1"></a>scanb_high_er <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb31-1427"><a href="#cb31-1427" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1428"><a href="#cb31-1428" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-1429"><a href="#cb31-1429" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb31-1430"><a href="#cb31-1430" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb31-1431"><a href="#cb31-1431" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1432"><a href="#cb31-1432" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1433"><a href="#cb31-1433" aria-hidden="true" tabindex="-1"></a>        PC3 <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1434"><a href="#cb31-1434" aria-hidden="true" tabindex="-1"></a>        ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span></span>
<span id="cb31-1435"><a href="#cb31-1435" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1436"><a href="#cb31-1436" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb31-1437"><a href="#cb31-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1438"><a href="#cb31-1438" aria-hidden="true" tabindex="-1"></a>metabric_samples <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb31-1439"><a href="#cb31-1439" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"metabric"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1440"><a href="#cb31-1440" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-1441"><a href="#cb31-1441" aria-hidden="true" tabindex="-1"></a>        CHEMOTHERAPY <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span></span>
<span id="cb31-1442"><a href="#cb31-1442" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1443"><a href="#cb31-1443" aria-hidden="true" tabindex="-1"></a>        HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1444"><a href="#cb31-1444" aria-hidden="true" tabindex="-1"></a>        PC3 <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb31-1445"><a href="#cb31-1445" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1446"><a href="#cb31-1446" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb31-1447"><a href="#cb31-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1448"><a href="#cb31-1448" aria-hidden="true" tabindex="-1"></a>nb_pts_events <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb31-1449"><a href="#cb31-1449" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="fu">c</span>(<span class="st">"SCANB"</span>, <span class="st">"METABRIC"</span>, <span class="st">"SCANB High ER"</span>),</span>
<span id="cb31-1450"><a href="#cb31-1450" aria-hidden="true" tabindex="-1"></a>    <span class="at">number_patients =</span> <span class="fu">c</span>(</span>
<span id="cb31-1451"><a href="#cb31-1451" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_samples),</span>
<span id="cb31-1452"><a href="#cb31-1452" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(metabric_samples),</span>
<span id="cb31-1453"><a href="#cb31-1453" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_high_er)</span>
<span id="cb31-1454"><a href="#cb31-1454" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-1455"><a href="#cb31-1455" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_events =</span> <span class="fu">c</span>(</span>
<span id="cb31-1456"><a href="#cb31-1456" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb31-1457"><a href="#cb31-1457" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1458"><a href="#cb31-1458" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb31-1459"><a href="#cb31-1459" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb31-1460"><a href="#cb31-1460" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>metabric <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb31-1461"><a href="#cb31-1461" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1462"><a href="#cb31-1462" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb31-1463"><a href="#cb31-1463" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb31-1464"><a href="#cb31-1464" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb31-1465"><a href="#cb31-1465" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_high_er <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1466"><a href="#cb31-1466" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb31-1467"><a href="#cb31-1467" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n)</span>
<span id="cb31-1468"><a href="#cb31-1468" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1469"><a href="#cb31-1469" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1470"><a href="#cb31-1470" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-1471"><a href="#cb31-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1472"><a href="#cb31-1472" aria-hidden="true" tabindex="-1"></a>nb_pts_events</span>
<span id="cb31-1473"><a href="#cb31-1473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1474"><a href="#cb31-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1475"><a href="#cb31-1475" aria-hidden="true" tabindex="-1"></a>First we check the correlation of PC3 with estrogen response early and </span>
<span id="cb31-1476"><a href="#cb31-1476" aria-hidden="true" tabindex="-1"></a>G2M checkpoint.</span>
<span id="cb31-1477"><a href="#cb31-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1478"><a href="#cb31-1478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=12, fig.height=10}</span></span>
<span id="cb31-1479"><a href="#cb31-1479" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb31-1480"><a href="#cb31-1480" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb31-1481"><a href="#cb31-1481" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb31-1482"><a href="#cb31-1482" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb31-1483"><a href="#cb31-1483" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_G2M_CHECKPOINT"</span>,</span>
<span id="cb31-1484"><a href="#cb31-1484" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SET_ERPR"</span></span>
<span id="cb31-1485"><a href="#cb31-1485" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1486"><a href="#cb31-1486" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb31-1487"><a href="#cb31-1487" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb31-1488"><a href="#cb31-1488" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1489"><a href="#cb31-1489" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb31-1490"><a href="#cb31-1490" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"PC3"</span>, <span class="st">"PC4"</span>),</span>
<span id="cb31-1491"><a href="#cb31-1491" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"component"</span>,</span>
<span id="cb31-1492"><a href="#cb31-1492" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score_pc"</span></span>
<span id="cb31-1493"><a href="#cb31-1493" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1494"><a href="#cb31-1494" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb31-1495"><a href="#cb31-1495" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> score_pc, </span>
<span id="cb31-1496"><a href="#cb31-1496" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb31-1497"><a href="#cb31-1497" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50,</span>
<span id="cb31-1498"><a href="#cb31-1498" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> cohort</span>
<span id="cb31-1499"><a href="#cb31-1499" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb31-1500"><a href="#cb31-1500" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="co">#, mapping = aes(shape = pam50)) +</span></span>
<span id="cb31-1501"><a href="#cb31-1501" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb31-1502"><a href="#cb31-1502" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs =</span> <span class="st">"cs"</span>),</span>
<span id="cb31-1503"><a href="#cb31-1503" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"gam"</span>,</span>
<span id="cb31-1504"><a href="#cb31-1504" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb31-1505"><a href="#cb31-1505" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">linetype =</span> cohort)</span>
<span id="cb31-1506"><a href="#cb31-1506" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1507"><a href="#cb31-1507" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1508"><a href="#cb31-1508" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Principal Components"</span>,</span>
<span id="cb31-1509"><a href="#cb31-1509" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Molecular score"</span>,</span>
<span id="cb31-1510"><a href="#cb31-1510" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb31-1511"><a href="#cb31-1511" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb31-1512"><a href="#cb31-1512" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1513"><a href="#cb31-1513" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between principal components</span><span class="sc">\n</span><span class="st">and"</span>,</span>
<span id="cb31-1514"><a href="#cb31-1514" aria-hidden="true" tabindex="-1"></a>            <span class="st">" molecular scores"</span></span>
<span id="cb31-1515"><a href="#cb31-1515" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1516"><a href="#cb31-1516" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1517"><a href="#cb31-1517" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb31-1518"><a href="#cb31-1518" aria-hidden="true" tabindex="-1"></a>        pathway <span class="sc">~</span> component, </span>
<span id="cb31-1519"><a href="#cb31-1519" aria-hidden="true" tabindex="-1"></a>        <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb31-1520"><a href="#cb31-1520" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb31-1521"><a href="#cb31-1521" aria-hidden="true" tabindex="-1"></a>            <span class="st">"PC3"</span> <span class="ot">=</span> <span class="st">"PC3"</span>,</span>
<span id="cb31-1522"><a href="#cb31-1522" aria-hidden="true" tabindex="-1"></a>            <span class="st">"PC4"</span> <span class="ot">=</span> <span class="st">"PC4"</span>,</span>
<span id="cb31-1523"><a href="#cb31-1523" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen early"</span>,</span>
<span id="cb31-1524"><a href="#cb31-1524" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_G2M_CHECKPOINT"</span> <span class="ot">=</span> <span class="st">"G2M"</span>,</span>
<span id="cb31-1525"><a href="#cb31-1525" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span></span>
<span id="cb31-1526"><a href="#cb31-1526" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb31-1527"><a href="#cb31-1527" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1528"><a href="#cb31-1528" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb31-1529"><a href="#cb31-1529" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb31-1530"><a href="#cb31-1530" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df_pca_coordinates)</span>
<span id="cb31-1531"><a href="#cb31-1531" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1532"><a href="#cb31-1532" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb31-1533"><a href="#cb31-1533" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb31-1534"><a href="#cb31-1534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1535"><a href="#cb31-1535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1536"><a href="#cb31-1536" aria-hidden="true" tabindex="-1"></a>There is indeed the correlation with the components but still a lot of </span>
<span id="cb31-1537"><a href="#cb31-1537" aria-hidden="true" tabindex="-1"></a>variability. So it will be unlikely to see such strong effects on the</span>
<span id="cb31-1538"><a href="#cb31-1538" aria-hidden="true" tabindex="-1"></a>third component.</span>
<span id="cb31-1539"><a href="#cb31-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1540"><a href="#cb31-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb31-1541"><a href="#cb31-1541" aria-hidden="true" tabindex="-1"></a><span class="co"># run the survival analysis for each dataset with its own formula.</span></span>
<span id="cb31-1542"><a href="#cb31-1542" aria-hidden="true" tabindex="-1"></a><span class="co"># we start by defining the base formulas, because later we sapply and </span></span>
<span id="cb31-1543"><a href="#cb31-1543" aria-hidden="true" tabindex="-1"></a><span class="co"># add the scores. this way if we need to change the formulas, we only</span></span>
<span id="cb31-1544"><a href="#cb31-1544" aria-hidden="true" tabindex="-1"></a><span class="co"># need to change once and all together.</span></span>
<span id="cb31-1545"><a href="#cb31-1545" aria-hidden="true" tabindex="-1"></a>formulas_survival <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb31-1546"><a href="#cb31-1546" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_scanb"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb31-1547"><a href="#cb31-1547" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_scanb_high_er"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb31-1548"><a href="#cb31-1548" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_metabric"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + npi"</span>,</span>
<span id="cb31-1549"><a href="#cb31-1549" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_metabric"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + npi"</span>,</span>
<span id="cb31-1550"><a href="#cb31-1550" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_scanb"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb31-1551"><a href="#cb31-1551" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_scanb_high_er"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage"</span></span>
<span id="cb31-1552"><a href="#cb31-1552" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1553"><a href="#cb31-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1554"><a href="#cb31-1554" aria-hidden="true" tabindex="-1"></a>type_survival <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"os"</span>, <span class="st">"rfs"</span>)</span>
<span id="cb31-1555"><a href="#cb31-1555" aria-hidden="true" tabindex="-1"></a>which_scores <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb31-1556"><a href="#cb31-1556" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PC3"</span>, </span>
<span id="cb31-1557"><a href="#cb31-1557" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PC4"</span>,</span>
<span id="cb31-1558"><a href="#cb31-1558" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>,</span>
<span id="cb31-1559"><a href="#cb31-1559" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR_scaled"</span></span>
<span id="cb31-1560"><a href="#cb31-1560" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1561"><a href="#cb31-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1562"><a href="#cb31-1562" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates<span class="sc">$</span>SET_ERPR_scaled <span class="ot">&lt;-</span> df_pca_coordinates<span class="sc">$</span>SET_ERPR<span class="sc">*</span><span class="dv">5</span> <span class="sc">+</span> <span class="dv">5</span></span>
<span id="cb31-1563"><a href="#cb31-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1564"><a href="#cb31-1564" aria-hidden="true" tabindex="-1"></a>survival_results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-1565"><a href="#cb31-1565" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"os"</span>, <span class="st">"rfs"</span>),</span>
<span id="cb31-1566"><a href="#cb31-1566" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(type_analysis, datasets, name_scores, formulas){</span>
<span id="cb31-1567"><a href="#cb31-1567" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb31-1568"><a href="#cb31-1568" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb31-1569"><a href="#cb31-1569" aria-hidden="true" tabindex="-1"></a>                dataset, name_dataset, name_scores, formulas, type_analysis</span>
<span id="cb31-1570"><a href="#cb31-1570" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb31-1571"><a href="#cb31-1571" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-1572"><a href="#cb31-1572" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (type_analysis <span class="sc">==</span> <span class="st">"rfs"</span> <span class="sc">&amp;</span> name_dataset <span class="sc">==</span> <span class="st">"tcga"</span>){</span>
<span id="cb31-1573"><a href="#cb31-1573" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span>()</span>
<span id="cb31-1574"><a href="#cb31-1574" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> { </span>
<span id="cb31-1575"><a href="#cb31-1575" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-1576"><a href="#cb31-1576" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sapply</span>(</span>
<span id="cb31-1577"><a href="#cb31-1577" aria-hidden="true" tabindex="-1"></a>                        name_scores,</span>
<span id="cb31-1578"><a href="#cb31-1578" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">function</span>(name_score, col_data, formula_str){</span>
<span id="cb31-1579"><a href="#cb31-1579" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb31-1580"><a href="#cb31-1580" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> (name_score <span class="sc">%in%</span> <span class="fu">colnames</span>(col_data)){</span>
<span id="cb31-1581"><a href="#cb31-1581" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb31-1582"><a href="#cb31-1582" aria-hidden="true" tabindex="-1"></a>                                survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb31-1583"><a href="#cb31-1583" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">as.formula</span>(</span>
<span id="cb31-1584"><a href="#cb31-1584" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">paste</span>(</span>
<span id="cb31-1585"><a href="#cb31-1585" aria-hidden="true" tabindex="-1"></a>                                            formula_str, </span>
<span id="cb31-1586"><a href="#cb31-1586" aria-hidden="true" tabindex="-1"></a>                                            name_score, </span>
<span id="cb31-1587"><a href="#cb31-1587" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">sep =</span> <span class="st">"+"</span></span>
<span id="cb31-1588"><a href="#cb31-1588" aria-hidden="true" tabindex="-1"></a>                                        )[<span class="dv">1</span>]</span>
<span id="cb31-1589"><a href="#cb31-1589" aria-hidden="true" tabindex="-1"></a>                                    ),</span>
<span id="cb31-1590"><a href="#cb31-1590" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">data =</span> col_data, </span>
<span id="cb31-1591"><a href="#cb31-1591" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">y =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-1592"><a href="#cb31-1592" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">x =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1593"><a href="#cb31-1593" aria-hidden="true" tabindex="-1"></a>                                )    </span>
<span id="cb31-1594"><a href="#cb31-1594" aria-hidden="true" tabindex="-1"></a>                            } <span class="cf">else</span> {</span>
<span id="cb31-1595"><a href="#cb31-1595" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>()</span>
<span id="cb31-1596"><a href="#cb31-1596" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb31-1597"><a href="#cb31-1597" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb31-1598"><a href="#cb31-1598" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb31-1599"><a href="#cb31-1599" aria-hidden="true" tabindex="-1"></a>                        <span class="at">col_data =</span> dataset,</span>
<span id="cb31-1600"><a href="#cb31-1600" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> formulas[</span>
<span id="cb31-1601"><a href="#cb31-1601" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">grepl</span>(</span>
<span id="cb31-1602"><a href="#cb31-1602" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">paste</span>(type_analysis, name_dataset, <span class="at">sep =</span> <span class="st">"_"</span>),</span>
<span id="cb31-1603"><a href="#cb31-1603" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">names</span>(formulas)</span>
<span id="cb31-1604"><a href="#cb31-1604" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb31-1605"><a href="#cb31-1605" aria-hidden="true" tabindex="-1"></a>                        ],</span>
<span id="cb31-1606"><a href="#cb31-1606" aria-hidden="true" tabindex="-1"></a>                        <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-1607"><a href="#cb31-1607" aria-hidden="true" tabindex="-1"></a>                        <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1608"><a href="#cb31-1608" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb31-1609"><a href="#cb31-1609" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb31-1610"><a href="#cb31-1610" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-1611"><a href="#cb31-1611" aria-hidden="true" tabindex="-1"></a>            <span class="at">dataset =</span> datasets,</span>
<span id="cb31-1612"><a href="#cb31-1612" aria-hidden="true" tabindex="-1"></a>            <span class="at">name_dataset =</span> <span class="fu">names</span>(datasets),</span>
<span id="cb31-1613"><a href="#cb31-1613" aria-hidden="true" tabindex="-1"></a>            <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb31-1614"><a href="#cb31-1614" aria-hidden="true" tabindex="-1"></a>                <span class="at">formulas =</span> formulas, </span>
<span id="cb31-1615"><a href="#cb31-1615" aria-hidden="true" tabindex="-1"></a>                <span class="at">name_scores =</span> name_scores,</span>
<span id="cb31-1616"><a href="#cb31-1616" aria-hidden="true" tabindex="-1"></a>                <span class="at">type_analysis =</span> type_analysis</span>
<span id="cb31-1617"><a href="#cb31-1617" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb31-1618"><a href="#cb31-1618" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-1619"><a href="#cb31-1619" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1620"><a href="#cb31-1620" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1621"><a href="#cb31-1621" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-1622"><a href="#cb31-1622" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> <span class="fu">list</span>(</span>
<span id="cb31-1623"><a href="#cb31-1623" aria-hidden="true" tabindex="-1"></a>        <span class="at">scanb =</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb31-1624"><a href="#cb31-1624" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_samples),</span>
<span id="cb31-1625"><a href="#cb31-1625" aria-hidden="true" tabindex="-1"></a>        <span class="at">metabric =</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb31-1626"><a href="#cb31-1626" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_samples),</span>
<span id="cb31-1627"><a href="#cb31-1627" aria-hidden="true" tabindex="-1"></a>        <span class="at">scanb_high_er =</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb31-1628"><a href="#cb31-1628" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_high_er)</span>
<span id="cb31-1629"><a href="#cb31-1629" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-1630"><a href="#cb31-1630" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_scores =</span> which_scores,</span>
<span id="cb31-1631"><a href="#cb31-1631" aria-hidden="true" tabindex="-1"></a>    <span class="at">formulas =</span> formulas_survival,</span>
<span id="cb31-1632"><a href="#cb31-1632" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-1633"><a href="#cb31-1633" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1634"><a href="#cb31-1634" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1635"><a href="#cb31-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1636"><a href="#cb31-1636" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs <span class="ot">&lt;-</span> survival_results<span class="sc">$</span>rfs[</span>
<span id="cb31-1637"><a href="#cb31-1637" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">sapply</span>(survival_results<span class="sc">$</span>rfs, is.null)</span>
<span id="cb31-1638"><a href="#cb31-1638" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-1639"><a href="#cb31-1639" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric <span class="ot">&lt;-</span> survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric[</span>
<span id="cb31-1640"><a href="#cb31-1640" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">sapply</span>(survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric, is.null)</span>
<span id="cb31-1641"><a href="#cb31-1641" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-1642"><a href="#cb31-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1643"><a href="#cb31-1643" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>os <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">discard</span>(</span>
<span id="cb31-1644"><a href="#cb31-1644" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb31-1645"><a href="#cb31-1645" aria-hidden="true" tabindex="-1"></a>        survival_results<span class="sc">$</span>os, </span>
<span id="cb31-1646"><a href="#cb31-1646" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> purrr<span class="sc">::</span><span class="fu">discard</span>(.x, is.null),</span>
<span id="cb31-1647"><a href="#cb31-1647" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-1648"><a href="#cb31-1648" aria-hidden="true" tabindex="-1"></a>    is.null</span>
<span id="cb31-1649"><a href="#cb31-1649" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1650"><a href="#cb31-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1651"><a href="#cb31-1651" aria-hidden="true" tabindex="-1"></a><span class="co"># we cannot simply save the models as each model has some </span></span>
<span id="cb31-1652"><a href="#cb31-1652" aria-hidden="true" tabindex="-1"></a><span class="co"># environment variables, which adds up to over 20GB. </span></span>
<span id="cb31-1653"><a href="#cb31-1653" aria-hidden="true" tabindex="-1"></a><span class="co"># check this stack exchange thread to read more on it:</span></span>
<span id="cb31-1654"><a href="#cb31-1654" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/42230920/saverds-inflating-size-of-object/52372480</span></span>
<span id="cb31-1655"><a href="#cb31-1655" aria-hidden="true" tabindex="-1"></a><span class="co"># the solution is to basically clear the environment from the terms </span></span>
<span id="cb31-1656"><a href="#cb31-1656" aria-hidden="true" tabindex="-1"></a><span class="co"># object. since it is pretty fast to run the survival analysis</span></span>
<span id="cb31-1657"><a href="#cb31-1657" aria-hidden="true" tabindex="-1"></a><span class="co"># we will not save the objects.</span></span>
<span id="cb31-1658"><a href="#cb31-1658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1659"><a href="#cb31-1659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1660"><a href="#cb31-1660" aria-hidden="true" tabindex="-1"></a><span class="co"># we now proceed to prepare the plots. since the survival result is </span></span>
<span id="cb31-1661"><a href="#cb31-1661" aria-hidden="true" tabindex="-1"></a><span class="co"># actually a large file, it is best to do all the plottings, save</span></span>
<span id="cb31-1662"><a href="#cb31-1662" aria-hidden="true" tabindex="-1"></a><span class="co"># them in other rds/pdf files and then use on the quarto markdown.</span></span>
<span id="cb31-1663"><a href="#cb31-1663" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise it is too slow to render the book. </span></span>
<span id="cb31-1664"><a href="#cb31-1664" aria-hidden="true" tabindex="-1"></a><span class="co"># the same is true for the statistics and coefficients available.</span></span>
<span id="cb31-1665"><a href="#cb31-1665" aria-hidden="true" tabindex="-1"></a>names_signatures <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb31-1666"><a href="#cb31-1666" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>,</span>
<span id="cb31-1667"><a href="#cb31-1667" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span> <span class="ot">=</span> <span class="st">"Estrogen Late"</span>,</span>
<span id="cb31-1668"><a href="#cb31-1668" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>,</span>
<span id="cb31-1669"><a href="#cb31-1669" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span> <span class="ot">=</span> <span class="st">"random 200 genes"</span>,</span>
<span id="cb31-1670"><a href="#cb31-1670" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span> <span class="ot">=</span> <span class="st">"random 18 genes"</span>,</span>
<span id="cb31-1671"><a href="#cb31-1671" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ER.pct"</span> <span class="ot">=</span> <span class="st">"ER percentage"</span>,</span>
<span id="cb31-1672"><a href="#cb31-1672" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PC3"</span> <span class="ot">=</span> <span class="st">"PC3"</span>,</span>
<span id="cb31-1673"><a href="#cb31-1673" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PC4"</span> <span class="ot">=</span> <span class="st">"PC4"</span></span>
<span id="cb31-1674"><a href="#cb31-1674" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1675"><a href="#cb31-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1676"><a href="#cb31-1676" aria-hidden="true" tabindex="-1"></a>names_coefficients <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-1677"><a href="#cb31-1677" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="fu">c</span>(</span>
<span id="cb31-1678"><a href="#cb31-1678" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"Age"</span>, </span>
<span id="cb31-1679"><a href="#cb31-1679" aria-hidden="true" tabindex="-1"></a>        <span class="st">"npi"</span> <span class="ot">=</span> <span class="st">"NPI"</span>, </span>
<span id="cb31-1680"><a href="#cb31-1680" aria-hidden="true" tabindex="-1"></a>        names_signatures</span>
<span id="cb31-1681"><a href="#cb31-1681" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-1682"><a href="#cb31-1682" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="fu">c</span>(</span>
<span id="cb31-1683"><a href="#cb31-1683" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb31-1684"><a href="#cb31-1684" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb31-1685"><a href="#cb31-1685" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb31-1686"><a href="#cb31-1686" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2and3"</span> <span class="ot">=</span> <span class="st">"N2 and N3"</span>,</span>
<span id="cb31-1687"><a href="#cb31-1687" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT1"</span> <span class="ot">=</span> <span class="st">"T1"</span>,</span>
<span id="cb31-1688"><a href="#cb31-1688" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT2"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb31-1689"><a href="#cb31-1689" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT3"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb31-1690"><a href="#cb31-1690" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-1691"><a href="#cb31-1691" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="fu">c</span>(</span>
<span id="cb31-1692"><a href="#cb31-1692" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb31-1693"><a href="#cb31-1693" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stage"</span> <span class="ot">=</span> <span class="st">"Tumor Stage"</span>,</span>
<span id="cb31-1694"><a href="#cb31-1694" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb31-1695"><a href="#cb31-1695" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb31-1696"><a href="#cb31-1696" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2"</span> <span class="ot">=</span> <span class="st">"N2"</span>,</span>
<span id="cb31-1697"><a href="#cb31-1697" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN3"</span> <span class="ot">=</span> <span class="st">"N3"</span>,</span>
<span id="cb31-1698"><a href="#cb31-1698" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stagestage_ii"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb31-1699"><a href="#cb31-1699" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stagestage_iii"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb31-1700"><a href="#cb31-1700" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-1701"><a href="#cb31-1701" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_er =</span> <span class="fu">c</span>(</span>
<span id="cb31-1702"><a href="#cb31-1702" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb31-1703"><a href="#cb31-1703" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb31-1704"><a href="#cb31-1704" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb31-1705"><a href="#cb31-1705" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2and3"</span> <span class="ot">=</span> <span class="st">"N2 and N3"</span>,</span>
<span id="cb31-1706"><a href="#cb31-1706" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT1"</span> <span class="ot">=</span> <span class="st">"T1"</span>,</span>
<span id="cb31-1707"><a href="#cb31-1707" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT2"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb31-1708"><a href="#cb31-1708" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT3"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb31-1709"><a href="#cb31-1709" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1710"><a href="#cb31-1710" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1711"><a href="#cb31-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1712"><a href="#cb31-1712" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-1713"><a href="#cb31-1713" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"Lum A/B, ER+ BC"</span>,</span>
<span id="cb31-1714"><a href="#cb31-1714" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"Endo Only, ER+ BC"</span>,</span>
<span id="cb31-1715"><a href="#cb31-1715" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"Endo Only, ER+ BC"</span>,</span>
<span id="cb31-1716"><a href="#cb31-1716" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_er =</span> <span class="st">"Endo Only, ER+ BC, ER% &gt;= 90"</span></span>
<span id="cb31-1717"><a href="#cb31-1717" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1718"><a href="#cb31-1718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1719"><a href="#cb31-1719" aria-hidden="true" tabindex="-1"></a>path_to_save <span class="ot">&lt;-</span> <span class="st">"../results/plots/validation/forest_plots/"</span></span>
<span id="cb31-1720"><a href="#cb31-1720" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb31-1721"><a href="#cb31-1721" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(</span>
<span id="cb31-1722"><a href="#cb31-1722" aria-hidden="true" tabindex="-1"></a>        path_to_save,</span>
<span id="cb31-1723"><a href="#cb31-1723" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">"pdf"</span>, <span class="st">"png"</span>)</span>
<span id="cb31-1724"><a href="#cb31-1724" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb31-1725"><a href="#cb31-1725" aria-hidden="true" tabindex="-1"></a>    dir.create,</span>
<span id="cb31-1726"><a href="#cb31-1726" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb31-1727"><a href="#cb31-1727" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb31-1728"><a href="#cb31-1728" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1729"><a href="#cb31-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1730"><a href="#cb31-1730" aria-hidden="true" tabindex="-1"></a>forest_plots <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb31-1731"><a href="#cb31-1731" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(fits, type_analysis){</span>
<span id="cb31-1732"><a href="#cb31-1732" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb31-1733"><a href="#cb31-1733" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(cohort_fits, name_cohort, type_analysis){</span>
<span id="cb31-1734"><a href="#cb31-1734" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mapply</span>(</span>
<span id="cb31-1735"><a href="#cb31-1735" aria-hidden="true" tabindex="-1"></a>                    forest_plot_fits,</span>
<span id="cb31-1736"><a href="#cb31-1736" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fit =</span> cohort_fits,</span>
<span id="cb31-1737"><a href="#cb31-1737" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name_signature =</span> <span class="fu">names</span>(cohort_fits),</span>
<span id="cb31-1738"><a href="#cb31-1738" aria-hidden="true" tabindex="-1"></a>                    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb31-1739"><a href="#cb31-1739" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cohort =</span> name_cohort,</span>
<span id="cb31-1740"><a href="#cb31-1740" aria-hidden="true" tabindex="-1"></a>                        <span class="at">names_coefficients =</span> names_coefficients,</span>
<span id="cb31-1741"><a href="#cb31-1741" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type_survival =</span> <span class="fu">toupper</span>(type_analysis),</span>
<span id="cb31-1742"><a href="#cb31-1742" aria-hidden="true" tabindex="-1"></a>                        <span class="at">patients =</span> patients[[name_cohort]],</span>
<span id="cb31-1743"><a href="#cb31-1743" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#clip = c(0.1, 2),</span></span>
<span id="cb31-1744"><a href="#cb31-1744" aria-hidden="true" tabindex="-1"></a>                        <span class="at">width =</span> <span class="dv">6</span>, </span>
<span id="cb31-1745"><a href="#cb31-1745" aria-hidden="true" tabindex="-1"></a>                        <span class="at">height =</span> <span class="dv">4</span>, </span>
<span id="cb31-1746"><a href="#cb31-1746" aria-hidden="true" tabindex="-1"></a>                        <span class="at">path_to_save =</span> path_to_save</span>
<span id="cb31-1747"><a href="#cb31-1747" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb31-1748"><a href="#cb31-1748" aria-hidden="true" tabindex="-1"></a>                    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-1749"><a href="#cb31-1749" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1750"><a href="#cb31-1750" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb31-1751"><a href="#cb31-1751" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1752"><a href="#cb31-1752" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb31-1753"><a href="#cb31-1753" aria-hidden="true" tabindex="-1"></a>            <span class="at">cohort_fits =</span> fits,</span>
<span id="cb31-1754"><a href="#cb31-1754" aria-hidden="true" tabindex="-1"></a>            <span class="at">name_cohort =</span> <span class="fu">names</span>(fits),</span>
<span id="cb31-1755"><a href="#cb31-1755" aria-hidden="true" tabindex="-1"></a>            <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">type_analysis =</span> type_analysis),</span>
<span id="cb31-1756"><a href="#cb31-1756" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-1757"><a href="#cb31-1757" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1758"><a href="#cb31-1758" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1759"><a href="#cb31-1759" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-1760"><a href="#cb31-1760" aria-hidden="true" tabindex="-1"></a>    survival_results,</span>
<span id="cb31-1761"><a href="#cb31-1761" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(survival_results),</span>
<span id="cb31-1762"><a href="#cb31-1762" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-1763"><a href="#cb31-1763" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1764"><a href="#cb31-1764" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1765"><a href="#cb31-1765" aria-hidden="true" tabindex="-1"></a><span class="co"># all forest plots are saved as a pdf in the </span></span>
<span id="cb31-1766"><a href="#cb31-1766" aria-hidden="true" tabindex="-1"></a><span class="co"># results/plots/surv_analysis_estrogen folder and</span></span>
<span id="cb31-1767"><a href="#cb31-1767" aria-hidden="true" tabindex="-1"></a><span class="co"># as a rds file in the folder below.</span></span>
<span id="cb31-1768"><a href="#cb31-1768" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb31-1769"><a href="#cb31-1769" aria-hidden="true" tabindex="-1"></a>    forest_plots,</span>
<span id="cb31-1770"><a href="#cb31-1770" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/forest_plots.rds"</span></span>
<span id="cb31-1771"><a href="#cb31-1771" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1772"><a href="#cb31-1772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1773"><a href="#cb31-1773" aria-hidden="true" tabindex="-1"></a><span class="co"># and now we fetch the tables that will be used later on including the</span></span>
<span id="cb31-1774"><a href="#cb31-1774" aria-hidden="true" tabindex="-1"></a><span class="co"># confidence intervals and other parameters from the fit</span></span>
<span id="cb31-1775"><a href="#cb31-1775" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb31-1776"><a href="#cb31-1776" aria-hidden="true" tabindex="-1"></a>    survival_results, </span>
<span id="cb31-1777"><a href="#cb31-1777" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) </span>
<span id="cb31-1778"><a href="#cb31-1778" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb31-1779"><a href="#cb31-1779" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb31-1780"><a href="#cb31-1780" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(y)</span>
<span id="cb31-1781"><a href="#cb31-1781" aria-hidden="true" tabindex="-1"></a>                <span class="fu">lapply</span>(</span>
<span id="cb31-1782"><a href="#cb31-1782" aria-hidden="true" tabindex="-1"></a>                    y,</span>
<span id="cb31-1783"><a href="#cb31-1783" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>(z) broom<span class="sc">::</span><span class="fu">tidy</span>(</span>
<span id="cb31-1784"><a href="#cb31-1784" aria-hidden="true" tabindex="-1"></a>                        z, </span>
<span id="cb31-1785"><a href="#cb31-1785" aria-hidden="true" tabindex="-1"></a>                        <span class="at">exponentiate =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-1786"><a href="#cb31-1786" aria-hidden="true" tabindex="-1"></a>                        <span class="at">conf.int =</span> <span class="cn">TRUE</span></span>
<span id="cb31-1787"><a href="#cb31-1787" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb31-1788"><a href="#cb31-1788" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"score"</span>)</span>
<span id="cb31-1789"><a href="#cb31-1789" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>)</span>
<span id="cb31-1790"><a href="#cb31-1790" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"type_analysis"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1791"><a href="#cb31-1791" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">HR =</span> estimate)</span>
<span id="cb31-1792"><a href="#cb31-1792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1793"><a href="#cb31-1793" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(</span>
<span id="cb31-1794"><a href="#cb31-1794" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/validation/"</span>,</span>
<span id="cb31-1795"><a href="#cb31-1795" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1796"><a href="#cb31-1796" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1797"><a href="#cb31-1797" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb31-1798"><a href="#cb31-1798" aria-hidden="true" tabindex="-1"></a>    tables_survival,</span>
<span id="cb31-1799"><a href="#cb31-1799" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/validation/survival_results.csv"</span>,</span>
<span id="cb31-1800"><a href="#cb31-1800" aria-hidden="true" tabindex="-1"></a>    <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb31-1801"><a href="#cb31-1801" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1802"><a href="#cb31-1802" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1803"><a href="#cb31-1803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1806"><a href="#cb31-1806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1807"><a href="#cb31-1807" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(</span>
<span id="cb31-1808"><a href="#cb31-1808" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/validation/survival_results.csv"</span></span>
<span id="cb31-1809"><a href="#cb31-1809" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1810"><a href="#cb31-1810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1811"><a href="#cb31-1811" aria-hidden="true" tabindex="-1"></a>forest_plots <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb31-1812"><a href="#cb31-1812" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/forest_plots.rds"</span></span>
<span id="cb31-1813"><a href="#cb31-1813" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1814"><a href="#cb31-1814" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1815"><a href="#cb31-1815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1816"><a href="#cb31-1816" aria-hidden="true" tabindex="-1"></a>The table below shows the results for the survival analysis using all</span>
<span id="cb31-1817"><a href="#cb31-1817" aria-hidden="true" tabindex="-1"></a>the samples from SCANB and METABRIC coming from patients that received</span>
<span id="cb31-1818"><a href="#cb31-1818" aria-hidden="true" tabindex="-1"></a>only endocrine therapy and whose samples had a $PC3 &gt; 0$. OS means</span>
<span id="cb31-1819"><a href="#cb31-1819" aria-hidden="true" tabindex="-1"></a>overall survival and RFS means recurrence free survival.</span>
<span id="cb31-1820"><a href="#cb31-1820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1823"><a href="#cb31-1823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1824"><a href="#cb31-1824" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span> </span>
<span id="cb31-1825"><a href="#cb31-1825" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(term <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"PC3"</span>, <span class="st">"SET_ERPR"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1826"><a href="#cb31-1826" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb31-1827"><a href="#cb31-1827" aria-hidden="true" tabindex="-1"></a>        type_analysis, </span>
<span id="cb31-1828"><a href="#cb31-1828" aria-hidden="true" tabindex="-1"></a>        cohort, term, </span>
<span id="cb31-1829"><a href="#cb31-1829" aria-hidden="true" tabindex="-1"></a>        HR, conf.low, </span>
<span id="cb31-1830"><a href="#cb31-1830" aria-hidden="true" tabindex="-1"></a>        conf.high, p.value</span>
<span id="cb31-1831"><a href="#cb31-1831" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1832"><a href="#cb31-1832" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(term, type_analysis, cohort) <span class="sc">%&gt;%</span></span>
<span id="cb31-1833"><a href="#cb31-1833" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb31-1834"><a href="#cb31-1834" aria-hidden="true" tabindex="-1"></a>        <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb31-1835"><a href="#cb31-1835" aria-hidden="true" tabindex="-1"></a>            <span class="at">scrollX =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-1836"><a href="#cb31-1836" aria-hidden="true" tabindex="-1"></a>            <span class="at">pageLength =</span> <span class="dv">20</span></span>
<span id="cb31-1837"><a href="#cb31-1837" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb31-1838"><a href="#cb31-1838" aria-hidden="true" tabindex="-1"></a>        <span class="at">filter =</span> <span class="st">'top'</span></span>
<span id="cb31-1839"><a href="#cb31-1839" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1840"><a href="#cb31-1840" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatRound</span>(</span>
<span id="cb31-1841"><a href="#cb31-1841" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"HR"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span>), </span>
<span id="cb31-1842"><a href="#cb31-1842" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb31-1843"><a href="#cb31-1843" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-1844"><a href="#cb31-1844" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatSignif</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"p.value"</span>))</span>
<span id="cb31-1845"><a href="#cb31-1845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1846"><a href="#cb31-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1847"><a href="#cb31-1847" aria-hidden="true" tabindex="-1"></a>We see that in all cases the HR for PC3 is below 1, for OS it ranges</span>
<span id="cb31-1848"><a href="#cb31-1848" aria-hidden="true" tabindex="-1"></a>from 0.95 to 0.97 the HR and for RFS from 0.88 to 0.89. What is </span>
<span id="cb31-1849"><a href="#cb31-1849" aria-hidden="true" tabindex="-1"></a>interesting to note here is that in all cases the confidence interval</span>
<span id="cb31-1850"><a href="#cb31-1850" aria-hidden="true" tabindex="-1"></a>is crossing 1, as expected due to the variability of the </span>
<span id="cb31-1851"><a href="#cb31-1851" aria-hidden="true" tabindex="-1"></a>correlation with SET ER/PR and estrogen response early. Also it is interesting</span>
<span id="cb31-1852"><a href="#cb31-1852" aria-hidden="true" tabindex="-1"></a>to note that the confidence interval does not cross so much into </span>
<span id="cb31-1853"><a href="#cb31-1853" aria-hidden="true" tabindex="-1"></a>the values higher than 1. Remember that the hazard ratio scale is not</span>
<span id="cb31-1854"><a href="#cb31-1854" aria-hidden="true" tabindex="-1"></a>linear. Indeed it seems that the more a sample is on the right side</span>
<span id="cb31-1855"><a href="#cb31-1855" aria-hidden="true" tabindex="-1"></a>of the plot the better is its outcome. Notice that the </span>
<span id="cb31-1856"><a href="#cb31-1856" aria-hidden="true" tabindex="-1"></a>scale for HR is different for PC3 and SET ER/PR, since one is a positive</span>
<span id="cb31-1857"><a href="#cb31-1857" aria-hidden="true" tabindex="-1"></a>score ranging from 0 to 8 and the other is a score ranging from</span>
<span id="cb31-1858"><a href="#cb31-1858" aria-hidden="true" tabindex="-1"></a>-1 to 1. If we were to rescale SET ER/PR to an interval between</span>
<span id="cb31-1859"><a href="#cb31-1859" aria-hidden="true" tabindex="-1"></a>0 to 10 by multiplying by 5 and then summing 5, we would get </span>
<span id="cb31-1860"><a href="#cb31-1860" aria-hidden="true" tabindex="-1"></a>hazard ratios in the range of 0.8. Moreover, estrogen signaling</span>
<span id="cb31-1861"><a href="#cb31-1861" aria-hidden="true" tabindex="-1"></a>is not the only thing fully explaining the third component as</span>
<span id="cb31-1862"><a href="#cb31-1862" aria-hidden="true" tabindex="-1"></a>it can be seen from @fig-pca-mol-land-pathways. In this case,</span>
<span id="cb31-1863"><a href="#cb31-1863" aria-hidden="true" tabindex="-1"></a>G2M Checkpoint and PI3K signaling have also a role in the third</span>
<span id="cb31-1864"><a href="#cb31-1864" aria-hidden="true" tabindex="-1"></a>component.</span>
<span id="cb31-1865"><a href="#cb31-1865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1866"><a href="#cb31-1866" aria-hidden="true" tabindex="-1"></a><span class="fu">## High risk patients</span></span>
<span id="cb31-1867"><a href="#cb31-1867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1868"><a href="#cb31-1868" aria-hidden="true" tabindex="-1"></a>The Prosigna risk of recurrence score takes into account the </span>
<span id="cb31-1869"><a href="#cb31-1869" aria-hidden="true" tabindex="-1"></a>tumor stage and the molecular subtype, this is the ROR-C and </span>
<span id="cb31-1870"><a href="#cb31-1870" aria-hidden="true" tabindex="-1"></a>the formula from the original paper is presented below:</span>
<span id="cb31-1871"><a href="#cb31-1871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1872"><a href="#cb31-1872" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1873"><a href="#cb31-1873" aria-hidden="true" tabindex="-1"></a>ROR-C = 0.05\times basal + 0.11 \times HER2 - 0.23 \times LumA + 0.09 \times </span>
<span id="cb31-1874"><a href="#cb31-1874" aria-hidden="true" tabindex="-1"></a>LumB  + 0.17 \times Tumor size</span>
<span id="cb31-1875"><a href="#cb31-1875" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1876"><a href="#cb31-1876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1877"><a href="#cb31-1877" aria-hidden="true" tabindex="-1"></a>We see that if a tumor sample has a high correlation to the</span>
<span id="cb31-1878"><a href="#cb31-1878" aria-hidden="true" tabindex="-1"></a>luminal A subtype it will decrease the score,</span>
<span id="cb31-1879"><a href="#cb31-1879" aria-hidden="true" tabindex="-1"></a>whereas for all other cases there is an increase in the risk. We </span>
<span id="cb31-1880"><a href="#cb31-1880" aria-hidden="true" tabindex="-1"></a>want to evaluate if the position in the molecular landscape is </span>
<span id="cb31-1881"><a href="#cb31-1881" aria-hidden="true" tabindex="-1"></a>somehow correlated with the risk score, specially in the forth component</span>
<span id="cb31-1882"><a href="#cb31-1882" aria-hidden="true" tabindex="-1"></a>for luminal A patients.</span>
<span id="cb31-1883"><a href="#cb31-1883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1884"><a href="#cb31-1884" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">@SCANB2022</span><span class="co">]</span> they showed that they are able to predict the </span>
<span id="cb31-1885"><a href="#cb31-1885" aria-hidden="true" tabindex="-1"></a>Prosigna binary categories high or low/intermediate risk for </span>
<span id="cb31-1886"><a href="#cb31-1886" aria-hidden="true" tabindex="-1"></a>the patients based only on the RNA-seq provided by their pipeline.</span>
<span id="cb31-1887"><a href="#cb31-1887" aria-hidden="true" tabindex="-1"></a>We use these categories here to understand the molecular scores </span>
<span id="cb31-1888"><a href="#cb31-1888" aria-hidden="true" tabindex="-1"></a>of the samples and also their correlation with the position and</span>
<span id="cb31-1889"><a href="#cb31-1889" aria-hidden="true" tabindex="-1"></a>risk groups.  All the following analysis are done for ER+ BC patients </span>
<span id="cb31-1890"><a href="#cb31-1890" aria-hidden="true" tabindex="-1"></a>**only**.</span>
<span id="cb31-1891"><a href="#cb31-1891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1892"><a href="#cb31-1892" aria-hidden="true" tabindex="-1"></a>First we stratify the risk groups by the molecular subtype.</span>
<span id="cb31-1893"><a href="#cb31-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1896"><a href="#cb31-1896" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1897"><a href="#cb31-1897" aria-hidden="true" tabindex="-1"></a>sub_df_scanb <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb31-1898"><a href="#cb31-1898" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-1899"><a href="#cb31-1899" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"scanb"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1900"><a href="#cb31-1900" aria-hidden="true" tabindex="-1"></a>            er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1901"><a href="#cb31-1901" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(SSP.ROR.binary.risk.cat)</span>
<span id="cb31-1902"><a href="#cb31-1902" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1903"><a href="#cb31-1903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1904"><a href="#cb31-1904" aria-hidden="true" tabindex="-1"></a>sub_df_scanb <span class="sc">%&gt;%</span> </span>
<span id="cb31-1905"><a href="#cb31-1905" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pam50 =</span> <span class="fu">droplevels</span>(pam50)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1906"><a href="#cb31-1906" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(pam50, SSP.ROR.binary.risk.cat) <span class="sc">%&gt;%</span></span>
<span id="cb31-1907"><a href="#cb31-1907" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_totals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1908"><a href="#cb31-1908" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_percentages</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1909"><a href="#cb31-1909" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_pct_formatting</span>(<span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1910"><a href="#cb31-1910" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_ns</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1911"><a href="#cb31-1911" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>()</span>
<span id="cb31-1912"><a href="#cb31-1912" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1913"><a href="#cb31-1913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1914"><a href="#cb31-1914" aria-hidden="true" tabindex="-1"></a>As expected the majority of luminal A patients are low/intermediate</span>
<span id="cb31-1915"><a href="#cb31-1915" aria-hidden="true" tabindex="-1"></a>risk, on the other hand most of the luminal B patients are considered</span>
<span id="cb31-1916"><a href="#cb31-1916" aria-hidden="true" tabindex="-1"></a>of high risk. </span>
<span id="cb31-1917"><a href="#cb31-1917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1918"><a href="#cb31-1918" aria-hidden="true" tabindex="-1"></a>If we look more specifically for luminal A patients and stratify </span>
<span id="cb31-1919"><a href="#cb31-1919" aria-hidden="true" tabindex="-1"></a>on the tumor stage we get the following numbers.</span>
<span id="cb31-1920"><a href="#cb31-1920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1923"><a href="#cb31-1923" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1924"><a href="#cb31-1924" aria-hidden="true" tabindex="-1"></a>sub_df_scanb <span class="sc">%&gt;%</span> </span>
<span id="cb31-1925"><a href="#cb31-1925" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>( </span>
<span id="cb31-1926"><a href="#cb31-1926" aria-hidden="true" tabindex="-1"></a>            pam50 <span class="sc">==</span> <span class="st">"luma"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1927"><a href="#cb31-1927" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(tumor_stage)</span>
<span id="cb31-1928"><a href="#cb31-1928" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1929"><a href="#cb31-1929" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(tumor_stage, SSP.ROR.binary.risk.cat) <span class="sc">%&gt;%</span></span>
<span id="cb31-1930"><a href="#cb31-1930" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_totals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1931"><a href="#cb31-1931" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_percentages</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1932"><a href="#cb31-1932" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_pct_formatting</span>(<span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1933"><a href="#cb31-1933" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_ns</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1934"><a href="#cb31-1934" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>()</span>
<span id="cb31-1935"><a href="#cb31-1935" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1936"><a href="#cb31-1936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1937"><a href="#cb31-1937" aria-hidden="true" tabindex="-1"></a>We see that for tumor stage 1 the number of high individuals is</span>
<span id="cb31-1938"><a href="#cb31-1938" aria-hidden="true" tabindex="-1"></a>lower in percentage than in tumor stage 3, as expected. We </span>
<span id="cb31-1939"><a href="#cb31-1939" aria-hidden="true" tabindex="-1"></a>now plot (@fig-luma-scanb-g2m-ts) for all these patients the G2M </span>
<span id="cb31-1940"><a href="#cb31-1940" aria-hidden="true" tabindex="-1"></a>molecular score,</span>
<span id="cb31-1941"><a href="#cb31-1941" aria-hidden="true" tabindex="-1"></a>an index of proliferation, stratified by the tumor stage. </span>
<span id="cb31-1942"><a href="#cb31-1942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1943"><a href="#cb31-1943" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=11, fig.height=6}</span></span>
<span id="cb31-1944"><a href="#cb31-1944" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-luma-scanb-g2m-ts</span></span>
<span id="cb31-1945"><a href="#cb31-1945" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Luminal A BC patients G2M scores stratified by tumor stage.</span></span>
<span id="cb31-1946"><a href="#cb31-1946" aria-hidden="true" tabindex="-1"></a>sub_df_scanb <span class="sc">%&gt;%</span> </span>
<span id="cb31-1947"><a href="#cb31-1947" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-1948"><a href="#cb31-1948" aria-hidden="true" tabindex="-1"></a>            pam50 <span class="sc">==</span> <span class="st">"luma"</span> <span class="sc">&amp;</span> </span>
<span id="cb31-1949"><a href="#cb31-1949" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(tumor_stage)</span>
<span id="cb31-1950"><a href="#cb31-1950" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1951"><a href="#cb31-1951" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb31-1952"><a href="#cb31-1952" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> SSP.ROR.binary.risk.cat, </span>
<span id="cb31-1953"><a href="#cb31-1953" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> HALLMARK_G2M_CHECKPOINT,</span>
<span id="cb31-1954"><a href="#cb31-1954" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> SSP.ROR.binary.risk.cat </span>
<span id="cb31-1955"><a href="#cb31-1955" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb31-1956"><a href="#cb31-1956" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span> </span>
<span id="cb31-1957"><a href="#cb31-1957" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb31-1958"><a href="#cb31-1958" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>tumor_stage) <span class="sc">+</span></span>
<span id="cb31-1959"><a href="#cb31-1959" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb31-1960"><a href="#cb31-1960" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1961"><a href="#cb31-1961" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ROR binary risk category (SSP)"</span>,</span>
<span id="cb31-1962"><a href="#cb31-1962" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1963"><a href="#cb31-1963" aria-hidden="true" tabindex="-1"></a>            <span class="st">"G2M scores stratified by risk category.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-1964"><a href="#cb31-1964" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Only luminal A, ER+ BC, ET treated only patients from SCANB"</span></span>
<span id="cb31-1965"><a href="#cb31-1965" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-1966"><a href="#cb31-1966" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"G2M"</span></span>
<span id="cb31-1967"><a href="#cb31-1967" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-1968"><a href="#cb31-1968" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span> </span>
<span id="cb31-1969"><a href="#cb31-1969" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb31-1970"><a href="#cb31-1970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1971"><a href="#cb31-1971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1972"><a href="#cb31-1972" aria-hidden="true" tabindex="-1"></a>We see that in all three cases in average the G2M scores are </span>
<span id="cb31-1973"><a href="#cb31-1973" aria-hidden="true" tabindex="-1"></a>higher in the high risk groups than in the Low/Intermediate.</span>
<span id="cb31-1974"><a href="#cb31-1974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1975"><a href="#cb31-1975" aria-hidden="true" tabindex="-1"></a>We saw previously that some of the G2M checkpoint genes have higher</span>
<span id="cb31-1976"><a href="#cb31-1976" aria-hidden="true" tabindex="-1"></a>loadings for the fourth component. We now plot the PC4 components stratified</span>
<span id="cb31-1977"><a href="#cb31-1977" aria-hidden="true" tabindex="-1"></a>by the risk groups for the luminal A patients (@fig-luma-scanb-pc4).</span>
<span id="cb31-1978"><a href="#cb31-1978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1979"><a href="#cb31-1979" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=6, fig.height=4}</span></span>
<span id="cb31-1980"><a href="#cb31-1980" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-luma-scanb-pc4</span></span>
<span id="cb31-1981"><a href="#cb31-1981" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Luminal A BC patients PC4 values stratified by risk category.</span></span>
<span id="cb31-1982"><a href="#cb31-1982" aria-hidden="true" tabindex="-1"></a>sub_df_scanb <span class="sc">%&gt;%</span> </span>
<span id="cb31-1983"><a href="#cb31-1983" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">==</span> <span class="st">"luma"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1984"><a href="#cb31-1984" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> SSP.ROR.binary.risk.cat, <span class="at">y =</span> PC4)) <span class="sc">+</span></span>
<span id="cb31-1985"><a href="#cb31-1985" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span> </span>
<span id="cb31-1986"><a href="#cb31-1986" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb31-1987"><a href="#cb31-1987" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb31-1988"><a href="#cb31-1988" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span><span class="fl">0.1</span>, </span>
<span id="cb31-1989"><a href="#cb31-1989" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb31-1990"><a href="#cb31-1990" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb31-1991"><a href="#cb31-1991" aria-hidden="true" tabindex="-1"></a>        <span class="at">outlier.shape =</span> <span class="cn">NA</span></span>
<span id="cb31-1992"><a href="#cb31-1992" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-1993"><a href="#cb31-1993" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb31-1994"><a href="#cb31-1994" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-1995"><a href="#cb31-1995" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ROR binary risk category (SSP)"</span>,</span>
<span id="cb31-1996"><a href="#cb31-1996" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-1997"><a href="#cb31-1997" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Molecular scores stratified by risk category.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-1998"><a href="#cb31-1998" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Only luminal A, ER+ BC patients from SCANB"</span></span>
<span id="cb31-1999"><a href="#cb31-1999" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-2000"><a href="#cb31-2000" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-2001"><a href="#cb31-2001" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb31-2002"><a href="#cb31-2002" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb31-2003"><a href="#cb31-2003" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2004"><a href="#cb31-2004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2005"><a href="#cb31-2005" aria-hidden="true" tabindex="-1"></a>Indeed, in average the higher the PC4, the more likely it is to be</span>
<span id="cb31-2006"><a href="#cb31-2006" aria-hidden="true" tabindex="-1"></a>in the High risk group. And now we compare the </span>
<span id="cb31-2007"><a href="#cb31-2007" aria-hidden="true" tabindex="-1"></a>G2M Checkpoint, Estrogen response early and random 200 signature </span>
<span id="cb31-2008"><a href="#cb31-2008" aria-hidden="true" tabindex="-1"></a>for each molecular subtype separately (@fig-all-scanb-g2m-ere) of </span>
<span id="cb31-2009"><a href="#cb31-2009" aria-hidden="true" tabindex="-1"></a>ER+ BC patients.</span>
<span id="cb31-2010"><a href="#cb31-2010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2011"><a href="#cb31-2011" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=14,fig.height=10}</span></span>
<span id="cb31-2012"><a href="#cb31-2012" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-all-scanb-g2m-ere</span></span>
<span id="cb31-2013"><a href="#cb31-2013" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: ER+ BC patients and molecular scores stratified by</span></span>
<span id="cb31-2014"><a href="#cb31-2014" aria-hidden="true" tabindex="-1"></a><span class="co">#|     molecular subtype and binary risk categories.</span></span>
<span id="cb31-2015"><a href="#cb31-2015" aria-hidden="true" tabindex="-1"></a>sub_df_scanb <span class="sc">%&gt;%</span> </span>
<span id="cb31-2016"><a href="#cb31-2016" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb31-2017"><a href="#cb31-2017" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb31-2018"><a href="#cb31-2018" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_G2M_CHECKPOINT"</span>, </span>
<span id="cb31-2019"><a href="#cb31-2019" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb31-2020"><a href="#cb31-2020" aria-hidden="true" tabindex="-1"></a>            <span class="st">"random_200"</span></span>
<span id="cb31-2021"><a href="#cb31-2021" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-2022"><a href="#cb31-2022" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb31-2023"><a href="#cb31-2023" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb31-2024"><a href="#cb31-2024" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-2025"><a href="#cb31-2025" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb31-2026"><a href="#cb31-2026" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> SSP.ROR.binary.risk.cat, </span>
<span id="cb31-2027"><a href="#cb31-2027" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> score</span>
<span id="cb31-2028"><a href="#cb31-2028" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb31-2029"><a href="#cb31-2029" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb31-2030"><a href="#cb31-2030" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(</span>
<span id="cb31-2031"><a href="#cb31-2031" aria-hidden="true" tabindex="-1"></a>        pathway<span class="sc">~</span>pam50, </span>
<span id="cb31-2032"><a href="#cb31-2032" aria-hidden="true" tabindex="-1"></a>        <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb31-2033"><a href="#cb31-2033" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb31-2034"><a href="#cb31-2034" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen early"</span>,</span>
<span id="cb31-2035"><a href="#cb31-2035" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_G2M_CHECKPOINT"</span> <span class="ot">=</span> <span class="st">"G2M"</span>,</span>
<span id="cb31-2036"><a href="#cb31-2036" aria-hidden="true" tabindex="-1"></a>            <span class="st">"random_200"</span> <span class="ot">=</span> <span class="st">"Random 200"</span>,</span>
<span id="cb31-2037"><a href="#cb31-2037" aria-hidden="true" tabindex="-1"></a>            <span class="st">"luma"</span> <span class="ot">=</span> <span class="st">"luma"</span>,</span>
<span id="cb31-2038"><a href="#cb31-2038" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lumb"</span> <span class="ot">=</span> <span class="st">"lumb"</span>,</span>
<span id="cb31-2039"><a href="#cb31-2039" aria-hidden="true" tabindex="-1"></a>            <span class="st">"her2"</span> <span class="ot">=</span> <span class="st">"her2"</span>,</span>
<span id="cb31-2040"><a href="#cb31-2040" aria-hidden="true" tabindex="-1"></a>            <span class="st">"normal"</span> <span class="ot">=</span> <span class="st">"normal"</span>,</span>
<span id="cb31-2041"><a href="#cb31-2041" aria-hidden="true" tabindex="-1"></a>            <span class="st">"basal"</span> <span class="ot">=</span> <span class="st">"basal"</span></span>
<span id="cb31-2042"><a href="#cb31-2042" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb31-2043"><a href="#cb31-2043" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb31-2044"><a href="#cb31-2044" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb31-2045"><a href="#cb31-2045" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb31-2046"><a href="#cb31-2046" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"ROR binary risk category (SSP)"</span>,</span>
<span id="cb31-2047"><a href="#cb31-2047" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Molecular score"</span>,</span>
<span id="cb31-2048"><a href="#cb31-2048" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb31-2049"><a href="#cb31-2049" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Molecular scores stratified by risk category and PAM50.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-2050"><a href="#cb31-2050" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Only ER+ BC patients from SCANB"</span></span>
<span id="cb31-2051"><a href="#cb31-2051" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-2052"><a href="#cb31-2052" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb31-2053"><a href="#cb31-2053" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb31-2054"><a href="#cb31-2054" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb31-2055"><a href="#cb31-2055" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb31-2056"><a href="#cb31-2056" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2057"><a href="#cb31-2057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2058"><a href="#cb31-2058" aria-hidden="true" tabindex="-1"></a>We see that in this case the binary risk category has distinct distributions</span>
<span id="cb31-2059"><a href="#cb31-2059" aria-hidden="true" tabindex="-1"></a>for the G2M checkpoint for all molecular subtypes, in particular with the </span>
<span id="cb31-2060"><a href="#cb31-2060" aria-hidden="true" tabindex="-1"></a>basal like. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chronchi">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/chronchi">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
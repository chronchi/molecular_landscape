<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Molecular landscape: a new framework for personalized medicine in Breast Cancer. - 3&nbsp; Validating the molecular landscape</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./scoring.html" rel="next">
<link href="./pca_merging.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Molecular landscape: a new framework for personalized medicine in Breast Cancer.</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chronchi/molecular_landscape" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="sidebar-tool px-1"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surv_analysis_estrogen.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pca_merging.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scoring.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discussion.html" class="sidebar-item-text sidebar-link">Discussion</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#scanb-embedding" id="toc-scanb-embedding" class="nav-link active" data-scroll-target="#scanb-embedding"> <span class="header-section-number">3.1</span> SCANB embedding</a></li>
  <li><a href="#missing-genes" id="toc-missing-genes" class="nav-link" data-scroll-target="#missing-genes"> <span class="header-section-number">3.2</span> Missing genes</a>
  <ul class="collapse">
  <li><a href="#fuzziness-score" id="toc-fuzziness-score" class="nav-link" data-scroll-target="#fuzziness-score"> <span class="header-section-number">3.2.1</span> Fuzziness score</a></li>
  <li><a href="#validating-the-score" id="toc-validating-the-score" class="nav-link" data-scroll-target="#validating-the-score"> <span class="header-section-number">3.2.2</span> Validating the score</a></li>
  </ul></li>
  <li><a href="#smc-embedding" id="toc-smc-embedding" class="nav-link" data-scroll-target="#smc-embedding"> <span class="header-section-number">3.3</span> SMC embedding</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chronchi/molecular_landscape/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>In the last chapters only TCGA and METABRIC samples were used in the training and testing of the PCA projection. To completely validate, we use another big cohort, SCANB, that was not used in the PCA fitting and testing before. This way we ensure that the embedding is independent of the cohort. Moreover, we use the SMC cohort <span class="citation" data-cites="Kan2018">(<a href="references.html#ref-Kan2018" role="doc-biblioref">Kan et al. 2018</a>)</span>, whose patients are from South Korea. We show how well it is embedded, and that is not dependent on population characteristics.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>* The library is already synchronized with the lockfile.</code></pre>
</div>
</div>
<section id="scanb-embedding" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="scanb-embedding"><span class="header-section-number">3.1</span> SCANB embedding</h2>
<p>The embedding was already calculate before when calculating the fit and tests, since the datasets were organized and loaded together. We also know already that all the 1044 genes are available in the SCANB cohort. SCANB is well mixed with all cohorts as <a href="#fig-pca-scanb">Figure&nbsp;<span>3.1</span></a> shows.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-scanb-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.1: PCA embedding colored by cohort. All samples from TCGA, METABRIC and SCANB were used.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Ideally there would be some overlap between SCANB and TCGA already in the first component. Moreover, if there isn’t, the cohort should be closer to TCGA than to METABRIC, due to technologies and normalization procedures, as both of them are log FPKM. Even though SCANB was processed in a way to get directly FPKM values, by using cufflinks, TCGA was normalized to get log FPKM as well, as discussed previously. <a href="#fig-pca-scanb-pc1">Figure&nbsp;<span>3.2</span></a> shows how close SCANB is from TCGA, moreover there is already some overlap. The variability in the first component is bigger for METABRIC compared to TCGA and SCANB. Probably this is due to the technology processing, since they have genes in the same scale. <a href="pca_merging.html#fig-pca-no-norm">Figure&nbsp;<span>2.22</span></a> contrasts the different normalization procedures. If genes are not scaled correctly, the PCA shows an inverse picture.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb-pc1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-scanb-pc1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.2: PCA embedding colored by cohort. The components used are the first and second components.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-pca-scanb-er-pam50">Figure&nbsp;<span>3.3</span></a> shows that the SCANB samples are also well mixed regarding the clinical factors, including the <span class="math inline">\(SET_{ER/PR}\)</span> signature.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb-er-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-scanb-er-pam50-1.png" class="img-fluid figure-img" width="1920"></p>
<p></p><figcaption class="figure-caption">Figure 3.3: PCA embedding of all samples from TCGA, SCANB and METABRIC. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype, (D) colored by the <span class="math inline">\(SET_{ER/PR}\)</span> signature and only SCANB samples.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="missing-genes" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="missing-genes"><span class="header-section-number">3.2</span> Missing genes</h2>
<p>Genes missing in publicly available datasets is very common. Usually this is due to processing pipelines or even data quality, therefore genes are removed. This should not be much of a problem, if the data is good enough, when calculating the qPCR-like normalization as it was shown before. The problem arises when multiplying the loadings obtained in the PCA with the normalized expression of the sample. If several genes are missing, 0s are added to the matrix and therefore the loadings for these genes cannot be used. Since 1000 genes were used, we investigate the loadings of genes and try to calculate a fuzziness score, indicating when the embedding should be trusted if genes are missing, and which genes are missing.</p>
<section id="fuzziness-score" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="fuzziness-score"><span class="header-section-number">3.2.1</span> Fuzziness score</h3>
<p>The idea of the fuzziness score is that we use the loadings of the missing genes and calculate the cumulative sum of their absolute values. The higher this value the more it indicates the missing genes are important. We start by removing random genes from random samples of the SCANB cohort. Each sample will have a random number of genes removed from the set of 1044 genes. Then two scores are calculated, one for PC2 and another for PC3. We also calculate the fuzziness score for the top loading genes and the low loadings genes, to compare these values.</p>
<p>We start by comparing the scores from top loadings and low loading genes. For this we remove the top 50 loadings and bottom 50 loadings, in terms of absolute values. <a href="#fig-loadings-top-bottom">Figure&nbsp;<span>3.4</span></a> shows the cumulative sum of the absolute values from the top and bottom loadings respectively. See how important the top loadings are compared to the bottom loadings. A way of thinking of this is that the top loadings weights are much more important when calculating the embedding.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-loadings-top-bottom" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-loadings-top-bottom-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.4: Cumulative sum of absolute values for the top loadings and bottom loadings as a function of the number of selected genes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>This was using the top loadings, so probably the fuzziness score of a sample with relatively good data will be between 0 and 12 maximum, meaning that they have less than 200 genes missing. When genes are missing, we hope that they are in the bottom part of the loadings, so the fuzziness score is as small as possible.</p>
<p>Suppose now that the genes missing in a sample are random. We will calculate random fuzziness scores based on this to have a feeling of the scores.</p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fuzziness-random" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-fuzziness-random-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.5: Distribution of the fuzziness scores from random missing genes. Each color corresponds to a different distribution using a different number of genes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-fuzziness-random">Figure&nbsp;<span>3.5</span></a> shows the results as a function of the number of missing genes. We see that in average, if 200 genes are missing, the fuzziness score is around 5. If less than a 100 genes are missing, the fuzziness score is around 3. In the next section we show how this influences the position where the sample is projected into the embedding.</p>
<p>Finally, we calculate the fuzziness score as a number of top loadings missing. Suppose 150 genes are missing. We will change the proportion of genes that are in the top loadings and in the missing list. Since the cumulative sum for PC2 and PC3 are very similar, we focus only on PC2.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fuzziness-random-top" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-fuzziness-random-top-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.6: Distribution of the fuzziness scores from 150 random missing genes with different proportions of top loading genes in the list. Each color corresponds to a different distribution using a different proportion of genes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-fuzziness-random-top">Figure&nbsp;<span>3.6</span></a> shows the fuzziness score with different proportions of the top loading genes. We see that they are actually very important when calculating the score. The top loading genes were defined as the top 150 genes in the list. So when calculating the number of missing genes it is important to check the number of top loadings in the list.</p>
</section>
<section id="validating-the-score" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="validating-the-score"><span class="header-section-number">3.2.2</span> Validating the score</h3>
<p>In this section we calculate the embeddings with different number of genes missing from a given sample and then plot the original embedding with the newly one. For this we use samples from TCGA. The genes are removed even before the normalization procedure, as they are usually not available there. We select randomly a number of top genes from PC3 and PC4 to compose the list of missing genes. The proportion of the top loading genes is varied.</p>
<div class="cell">

</div>
<div class="cell">

</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">TCGA-OL-A66K-01A-11R-A29R-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">TCGA-GI-A2C9-01A-11R-A21T-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">TCGA-3C-AALK-01A-11R-A41B-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">TCGA-BH-A0BW-01A-11R-A115-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">TCGA-A1-A0SI-01A-11R-A144-07</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false">TCGA-D8-A27L-01A-11R-A16F-07</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-10" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-10-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.7: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-20" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-20-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.8: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-50-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.9: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-80" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-80-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.10: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-182" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-182-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.11: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-missing-correction-198" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-missing-correction-198-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 3.12: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>When looking at the figures above, it seems that whenever there are genes missing, and the more of top loadings they are, the closer they are to the origin. This makes sense, since PCA is doing a simple linear combination of the loadings. This should be fine to correct, since we can fit a line going through the origin and goes through the points above. Then the adjustment will depend on the number of genes that are missing and are top loadings. The more they are, the more adjustment we will need.</p>
<p>For the adjustment we only know two things, its current position and how many of the top loadings are missing. Based on this information we should be able to correct the samples. Given the list of genes that are missing, we fit lines that would go through the genes that are missing in the TCGA and METABRIC samples. We then try to find the line that is closes to the point. After performing the fit and the line, we can then move the point to closer to the METABRIC and TCGA samples. The point should be close to the line and close to points that have the same proportion of top loadings missing.</p>
<div class="cell">

</div>
<p>These plots show how the fuzziness score might be indicative of how good the embedding will be depending on the number of missing genes. The video below shows the images for 20 different patients. Notice how all of them are connected to the origin as well.</p>
<iframe width="720" height="480" src="../plots/validation/random_loadings.mp4" align="middle" frameborder="0" allowfullscreen="">
</iframe>
</section>
</section>
<section id="smc-embedding" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="smc-embedding"><span class="header-section-number">3.3</span> SMC embedding</h2>
<p>By following the same procedures as previously, normalizing and getting the PC coordinates, <a href="#fig-smc-cohort">Figure&nbsp;<span>3.13</span></a> shows the biplot of PC1 and PC2 when coloring by cohorts. The samples seem to be well mixed already in the RNA-seq samples. This is probably due to the fact that the SMC cohort has TPM values.</p>
<div class="cell">

</div>
<p>When checking the total number of genes missing, there are only 4 genes missing. And as seen before, this number is almost irrelevant, in the sense that the embedding will still be robust and locations will be precise enough.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-smc-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-smc-cohort-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 3.13: Biplot of first two PCA components from SMC, TCGA, SCANB and METABRIC. SMC is highlighted in the plot and has a bigger dot.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As previously, <a href="#fig-pca-smc-er-pam50">Figure&nbsp;<span>3.14</span></a> shows the biplot of PC2 and PC3, highlighting the well mixing of the cohorts. When coloring by ER status, samples are in the right group. Molecular subtype is also correct. This cohort is special in the sense that there are more luminal B patients, as discussed in the paper. That is why there are more samples in the luminal B region.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-smc-er-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="validation_files/figure-html/fig-pca-smc-er-pam50-1.png" class="img-fluid figure-img" width="1728"></p>
<p></p><figcaption class="figure-caption">Figure 3.14: PCA embedding of all samples from TCGA, SCANB and METABRIC including the SMC samples on top. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype.</figcaption><p></p>
</figure>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Kan2018" class="csl-entry" role="doc-biblioentry">
Kan, Zhengyan, Ying Ding, Jinho Kim, Hae Hyun Jung, Woosung Chung, Samir Lal, Soonweng Cho, et al. 2018. <span>“Multi-Omics Profiling of Younger Asian Breast Cancers Reveals Distinctive Molecular Signatures.”</span> <em>Nature Communications</em> 9 (1). <a href="https://doi.org/10.1038/s41467-018-04129-4">https://doi.org/10.1038/s41467-018-04129-4</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./pca_merging.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./scoring.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb2" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Validating the molecular landscape</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>In the last chapters only TCGA and METABRIC samples were used in the training</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>and testing of the PCA projection. To completely validate, we use another</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>big cohort, SCANB, that was not used in the PCA fitting and testing before.</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>This way we ensure that the embedding is independent of the cohort. Moreover,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>we use the SMC cohort <span class="co">[</span><span class="ot">@Kan2018</span><span class="co">]</span>, whose patients are from South Korea.</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>We show how well it is embedded, and that </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>is not dependent on population characteristics. </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCAtools)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(singscore)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SummarizedExperiment)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tximport)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"first_run.R"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we are using rds files from previous chapters, so we source</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># in any case the load_rds_files.R and exclude all the associated files</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># that are generated in this current chapter</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>name_document <span class="ot">&lt;-</span> <span class="st">"validation"</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"load_rds_files.R"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># by setting the dev to png and pdf, this saves the figures in a specific</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co"># folder in both formats. moreover, since png is coming first, it shows</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co"># this figure when rendering the html. What is nice about this is that it</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># inherits the properties from the chunk to save the figure, so no need</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># to use ggplot2::ggsave to save the plots. this also works </span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="fu">c</span>(<span class="st">'png'</span>, <span class="st">'pdf'</span>, <span class="st">'svg'</span>))</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">bitmapType =</span> <span class="st">'cairo'</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## SCANB embedding</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>The embedding was already calculate before when calculating the fit and</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>tests, since the datasets were organized and loaded together. We also</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>know already that all the 1044 genes are available in the SCANB cohort. </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>SCANB is well mixed with all cohorts as @fig-pca-scanb shows.</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding colored by cohort. All samples from TCGA, METABRIC</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co">#|     and SCANB were used. </span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca_coordinates</span>(</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"cohort"</span>,</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA"</span>,</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">", METABRIC and SCANB</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Corrected METABRIC samples"</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>()</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>Ideally there would be some overlap between SCANB and TCGA already in the </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>first component. Moreover, if there isn't, the cohort should be closer</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>to TCGA than to METABRIC, due to technologies and normalization procedures,</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>as both of them are log FPKM. Even though SCANB was processed in a way </span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>to get directly FPKM values, by using cufflinks, TCGA was normalized to get</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>log FPKM as well, as discussed previously. @fig-pca-scanb-pc1 shows</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>how close SCANB is from TCGA, moreover there is already some overlap. The </span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>variability in the first component is bigger for METABRIC compared to</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>TCGA and SCANB. Probably this is due to the technology processing, since</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>they have genes in the same scale. @fig-pca-no-norm contrasts the different</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>normalization procedures. If genes are not scaled correctly, the PCA</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>shows an inverse picture.</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb-pc1</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding colored by cohort. The components used are the</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="co">#|     first and second components.</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca_coordinates</span>(</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates,</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"cohort"</span>,</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC1"</span>,</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC2"</span>,</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA"</span>,</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>        <span class="st">", METABRIC and SCANB"</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>@fig-pca-scanb-er-pam50 shows that the SCANB samples are also well mixed</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>regarding the clinical factors, including the $SET_{ER/PR}$ signature.</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=20, fig.height=14}</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb-er-pam50</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC.</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (A) Colored by cohort,</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (B) colored by ER status, (C) colored by PAM50 molecular subtype,</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (D) colored by the $SET_{ER/PR}$ signature and only SCANB samples.</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>base_size <span class="ot">&lt;-</span> <span class="dv">18</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>plots_with_scanb <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"cohort"</span>, <span class="st">"er_status"</span>, <span class="st">"pam50"</span>, <span class="st">"SET_ERPR"</span>), </span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>    plot_pca_coordinates,</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> df_pca_coordinates <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>        pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"luma"</span>, <span class="st">"lumb"</span>, <span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"normal"</span>)</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>, </span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> size,</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> base_size,</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA"</span>,</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">", METABRIC and SCANB"</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>er_status <span class="ot">&lt;-</span>  plots_with_scanb<span class="sc">$</span>er_status <span class="sc">+</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"ER status"</span>)</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>SET_ERPR <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes_string</span>(<span class="at">x =</span> <span class="st">"PC3"</span>, <span class="at">y =</span> <span class="st">"PC4"</span>, <span class="at">z =</span> <span class="st">"SET_ERPR"</span>)) <span class="sc">+</span> </span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Embedding of SCANB only"</span>,</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="fu">expression</span>(SET[ER<span class="sc">/</span>PR])</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span> </span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> base_size)</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">plotlist =</span> plots_with_scanb,</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"AUTO"</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a><span class="fu">## Missing genes</span></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>Genes missing in publicly available datasets is very common. Usually this is</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>due to processing pipelines or even data quality, therefore genes are removed.</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>This should not be much of a problem, if the data is good enough, when </span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>calculating the qPCR-like normalization as it was shown before. The problem</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>arises when multiplying the loadings obtained in the PCA with the </span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>normalized expression of the sample. If several genes are missing, 0s are </span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>added to the matrix and therefore the loadings for these genes cannot be </span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>used. Since 1000 genes were used, we investigate the loadings of genes and </span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>try to calculate a fuzziness score, indicating when the embedding should</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>be trusted if genes are missing, and which genes are missing. </span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fuzziness score </span></span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>The idea of the fuzziness score is that we use the loadings of the missing</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>genes and calculate the cumulative sum of their absolute values. </span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>The higher this value</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>the more it indicates the missing genes are important. We start by</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>removing random genes from random samples of the SCANB cohort. Each sample</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>will have a random number of genes removed from the set of 1044 genes. </span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>Then two scores are calculated, one for PC2 and another for PC3. We also</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>calculate the fuzziness score for the top loading genes and the </span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>low loadings genes, to compare these values.</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>We start by comparing the scores from top loadings and low loading genes. For</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>this we remove the top 50 loadings and bottom 50 loadings, in terms of</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>absolute values. @fig-loadings-top-bottom shows the cumulative sum</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>of the absolute values from the top and bottom loadings respectively. See how </span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>important the top loadings are compared to the bottom loadings. A way of</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>thinking of this is that the top loadings weights are much more important</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>when calculating the embedding.</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-loadings-top-bottom</span></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Cumulative sum of absolute values for the top loadings and</span></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a><span class="co">#|     bottom loadings as a function of the number of selected genes.</span></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>which_loadings <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"PC3"</span>, <span class="st">"PC4"</span>)</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>top_or_bottom <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"top"</span>, <span class="st">"bottom"</span>)</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_top <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(n, pca_fit){</span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>        top_loadings <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>            pca_fit<span class="sc">$</span>loadings[, which_loadings],</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span>,</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x, gene_names){</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>                gene_names[<span class="fu">order</span>(<span class="fu">abs</span>(x), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>n]]</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>            <span class="at">gene_names =</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_fuzziness_score</span>(top_loadings, pca_fit, <span class="at">which_pcs =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(which_loadings) <span class="sc">%&gt;%</span></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_bottom <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(n, pca_fit){</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>        top_loadings <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>            pca_fit<span class="sc">$</span>loadings[, which_loadings],</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span>,</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x, gene_names){</span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>                gene_names[<span class="fu">order</span>(<span class="fu">abs</span>(x), <span class="at">decreasing =</span> <span class="cn">FALSE</span>)[<span class="dv">1</span><span class="sc">:</span>n]]</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>            <span class="at">gene_names =</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>        <span class="fu">get_fuzziness_score</span>(top_loadings, pca_fit)</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(which_loadings) <span class="sc">%&gt;%</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>fuzziness_scores <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">top =</span> fuzziness_scores_top, <span class="at">bottom =</span> fuzziness_scores_bottom),</span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>    <span class="at">.id =</span> <span class="st">"top_or_bottom"</span></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_or_bottom =</span> <span class="fu">factor</span>(top_or_bottom, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"top"</span>, <span class="st">"bottom"</span>))</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>fuzziness_scores <span class="sc">%&gt;%</span> tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(which_loadings),</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"PC"</span>,</span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"fuzziness_score"</span></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> fuzziness_score, <span class="at">color =</span> PC)) <span class="sc">+</span></span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>top_or_bottom) <span class="sc">+</span></span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Number of genes"</span>,</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Fuzziness score"</span>,</span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Principal</span><span class="sc">\n</span><span class="st">component"</span></span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.65</span>, <span class="fl">0.8</span>))</span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>This was using the top loadings, so probably the fuzziness score of a sample</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>with relatively good data will be between 0 and 12 maximum, meaning that</span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>they have less than 200 genes missing. When genes are missing, we hope that</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>they are in the bottom part of the loadings, so the fuzziness score</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>is as small as possible. </span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>Suppose now that the genes missing in a sample are random. We will calculate</span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>random fuzziness scores based on this to have a feeling of the scores. </span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>nb_of_genes <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2</span>, <span class="at">to =</span> <span class="dv">220</span>, <span class="at">by =</span> <span class="dv">20</span>)</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>list_of_random_genes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>    nb_of_genes,</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(n, genes){</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x, genes, n){</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sample</span>(genes, <span class="at">size =</span> n)</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes =</span> genes,</span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> n,</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>            <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes =</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_random <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>    list_of_random_genes,</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(list_genes, pca_fit){</span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>            list_genes,</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>            get_fuzziness_score,</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>            <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(which_loadings)</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(<span class="st">"#"</span>, nb_of_genes)) <span class="sc">%&gt;%</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"nb_genes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>        <span class="at">nb_genes =</span> <span class="fu">factor</span>(</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>            nb_genes,</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>            <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"#"</span>, nb_of_genes)</span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>        which_loadings,</span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"PC"</span>,</span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"fuzziness_score"</span></span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores_random,</span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/fuzziness_scores_random.rds"</span></span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fuzziness-random</span></span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Distribution of the fuzziness scores from random missing genes.</span></span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a><span class="co">#|     Each color corresponds to a different distribution using a different</span></span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a><span class="co">#|     number of genes.</span></span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_random <span class="sc">%&gt;%</span> </span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(PC <span class="sc">==</span> <span class="st">"PC3"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> fuzziness_score, <span class="at">fill =</span> nb_genes)) <span class="sc">+</span></span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Fuzziness score"</span>,</span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Distribution of fuzziness score as a function of the number</span><span class="sc">\n</span><span class="st">of genes missing"</span>,</span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Only PC2 fuzziness scores"</span>,</span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"# missing</span><span class="sc">\n</span><span class="st">genes"</span></span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>@fig-fuzziness-random shows the results as a function of the number of missing</span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a>genes. We see that in average, if 200 genes are missing, the fuzziness</span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>score is around 5. If less than a 100 genes are missing, the fuzziness</span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a>score is around 3. In the next section we show how this influences the</span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>position where the sample is projected into the embedding.</span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>Finally, we calculate the fuzziness score as a number of top loadings </span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a>missing. Suppose 150 genes are missing. We will change the proportion</span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>of genes that are in the top loadings and in the missing list. Since</span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>the cumulative sum for PC2 and PC3 are very similar, we focus only on</span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a>PC2.</span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fuzziness-random-top</span></span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Distribution of the fuzziness scores from 150 random missing genes</span></span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a><span class="co">#|     with different proportions of top loading genes in the list.</span></span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a><span class="co">#|     Each color corresponds to a different distribution using a different</span></span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a><span class="co">#|     proportion of genes.</span></span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>nb_genes <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a>proportions <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>gene_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>which_pcs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>)</span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a>top_loadings_genes <span class="ot">&lt;-</span> gene_names[<span class="fu">order</span>(</span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(pca_fit<span class="sc">$</span>loadings[, which_pcs]), </span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">decreasing =</span> <span class="cn">TRUE</span></span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a>)[<span class="dv">1</span><span class="sc">:</span>nb_genes]]</span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a>proportions_top_fuzziness <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a>    proportions,</span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(prop, gene_names, top_loadings_genes, pca_fit, nb_genes){</span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>        nb_genes_top <span class="ot">&lt;-</span> <span class="fu">floor</span>(prop <span class="sc">*</span> nb_genes)</span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>        nb_genes_non_top <span class="ot">&lt;-</span> <span class="fu">floor</span>((<span class="dv">1</span> <span class="sc">-</span> prop) <span class="sc">*</span> nb_genes)</span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>        <span class="co"># run the fuzziness several times to get a distribution based on</span></span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the proportions</span></span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a>        list_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>                i, </span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>                genes_top, </span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a>                genes_non_top, </span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>                nb_genes_top, </span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>                nb_genes_non_top,</span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>                pca_fit</span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>                <span class="fu">get_fuzziness_score</span>(</span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">c</span>(</span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(genes_top, <span class="at">size =</span> nb_genes_top),</span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sample</span>(genes_non_top, <span class="at">size =</span> nb_genes_non_top)</span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a>                    ), </span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>                    pca_fit,</span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>                    <span class="at">which_pcs =</span> which_pcs</span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_top =</span> top_loadings_genes,</span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_non_top =</span> <span class="fu">setdiff</span>(gene_names, top_loadings_genes),</span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a>            <span class="at">nb_genes_top =</span> nb_genes_top,</span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>            nb_genes_non_top,</span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a>            <span class="at">pca_fit =</span> pca_fit</span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, which_pcs))</span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_loadings_genes =</span> top_loadings_genes,</span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(proportions)) <span class="sc">%&gt;%</span></span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"proportions"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, which_pcs),</span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"PC"</span>,</span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"fuzziness_score"</span></span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>proportions_top_fuzziness <span class="sc">%&gt;%</span> </span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> fuzziness_score, <span class="at">fill =</span> proportions)    </span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Fuzziness score"</span>,</span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Distribution of fuzziness score as a function of the</span><span class="sc">\n</span><span class="st">proportion "</span>,</span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>            <span class="st">"of the top loading genes in the list of missing genes"</span></span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Only PC3 fuzziness scores"</span>,</span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"Proportion of</span><span class="sc">\n</span><span class="st">top genes"</span></span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a>@fig-fuzziness-random-top shows the fuzziness score with different proportions</span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a>of the top loading genes. We see that they are actually very important when</span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a>calculating the score. The top loading genes were defined as the top 150 genes</span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>in the list. So when calculating the number of missing genes it is important</span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>to check the number of top loadings in the list. </span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Validating the score</span></span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a>In this section we calculate the embeddings with different number of genes</span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a>missing from a given sample and then plot the original embedding with</span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a>the newly one. For this</span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a>we use samples from TCGA. The genes are </span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>removed even before the normalization procedure, as they are usually not</span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>available there. We select randomly a number of top genes from PC3 and PC4</span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a>to compose the list of missing genes. The proportion of the top loading</span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>genes is varied. </span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>nb_genes <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a>proportions <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a>gene_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a>which_pcs <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a>top_loadings_genes_random <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a>    which_pcs,</span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(pc, gene_names, pca_fit, nb_genes){</span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a>        gene_names[<span class="fu">order</span>(</span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a>            <span class="fu">abs</span>(pca_fit<span class="sc">$</span>loadings[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, pc)]), </span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a>            <span class="at">decreasing =</span> <span class="cn">TRUE</span></span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">1</span><span class="sc">:</span>nb_genes]]   </span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a>    top_loadings_genes_random,</span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/top_loadings_genes_random.rds"</span></span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a><span class="co"># we select a number of samples since it is not necessary to run</span></span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a><span class="co"># the analysis on all samples, but we want a representative sampling</span></span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a><span class="co"># so any sampling should suffice for the analysis</span></span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2039</span>)</span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a>samples_to_use <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">colnames</span>(datasets<span class="sc">$</span>tcga), <span class="at">size =</span> <span class="dv">200</span>)</span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a>genes_proportions_top <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a>    proportions,</span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(prop, gene_names, top_loadings_genes, pca_fit, nb_genes){</span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a>        nb_genes_top <span class="ot">&lt;-</span> <span class="fu">floor</span>(prop <span class="sc">*</span> nb_genes)</span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a>        nb_genes_non_top <span class="ot">&lt;-</span> <span class="fu">floor</span>((<span class="dv">1</span> <span class="sc">-</span> prop) <span class="sc">*</span> nb_genes)</span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>        <span class="co"># run the fuzziness several times to get a distribution based on</span></span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the proportions</span></span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>        list_genes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>                i, </span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a>                genes_top, </span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>                genes_non_top, </span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>                nb_genes_top, </span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>                nb_genes_non_top</span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(</span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sample</span>(genes_top, <span class="at">size =</span> nb_genes_top),</span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sample</span>(genes_non_top, <span class="at">size =</span> nb_genes_non_top)</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_top =</span> top_loadings_genes,</span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a>            <span class="at">genes_non_top =</span> <span class="fu">setdiff</span>(gene_names, top_loadings_genes),</span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>            <span class="at">nb_genes_top =</span> nb_genes_top,</span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>            nb_genes_non_top</span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a>        ) </span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_loadings_genes =</span> top_loadings_genes_random,</span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(proportions))</span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a>    samples_to_use,</span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/samples_to_use.rds"</span></span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-525"><a href="#cb2-525" aria-hidden="true" tabindex="-1"></a>    genes_proportions_top,</span>
<span id="cb2-526"><a href="#cb2-526" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/genes_proportions_top.rds"</span></span>
<span id="cb2-527"><a href="#cb2-527" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-528"><a href="#cb2-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-529"><a href="#cb2-529" aria-hidden="true" tabindex="-1"></a>fuzziness_scores_random_top <span class="ot">&lt;-</span> <span class="fu">rapply</span>(</span>
<span id="cb2-530"><a href="#cb2-530" aria-hidden="true" tabindex="-1"></a>    genes_proportions_top,</span>
<span id="cb2-531"><a href="#cb2-531" aria-hidden="true" tabindex="-1"></a>    get_fuzziness_score,</span>
<span id="cb2-532"><a href="#cb2-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb2-533"><a href="#cb2-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">how =</span> <span class="st">"list"</span></span>
<span id="cb2-534"><a href="#cb2-534" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-535"><a href="#cb2-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-536"><a href="#cb2-536" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-537"><a href="#cb2-537" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores_random_top,</span>
<span id="cb2-538"><a href="#cb2-538" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/fuzziness_scores_random_top.rds"</span></span>
<span id="cb2-539"><a href="#cb2-539" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-540"><a href="#cb2-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-541"><a href="#cb2-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-542"><a href="#cb2-542" aria-hidden="true" tabindex="-1"></a>pca_coords_random <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(</span>
<span id="cb2-543"><a href="#cb2-543" aria-hidden="true" tabindex="-1"></a>    genes_proportions_top,</span>
<span id="cb2-544"><a href="#cb2-544" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(</span>
<span id="cb2-545"><a href="#cb2-545" aria-hidden="true" tabindex="-1"></a>        lists_genes, </span>
<span id="cb2-546"><a href="#cb2-546" aria-hidden="true" tabindex="-1"></a>        sum_exp, </span>
<span id="cb2-547"><a href="#cb2-547" aria-hidden="true" tabindex="-1"></a>        pca_fit, </span>
<span id="cb2-548"><a href="#cb2-548" aria-hidden="true" tabindex="-1"></a>        assay_to_use, </span>
<span id="cb2-549"><a href="#cb2-549" aria-hidden="true" tabindex="-1"></a>        stable_genes, </span>
<span id="cb2-550"><a href="#cb2-550" aria-hidden="true" tabindex="-1"></a>        most_variable_genes</span>
<span id="cb2-551"><a href="#cb2-551" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb2-552"><a href="#cb2-552" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-553"><a href="#cb2-553" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for each list of gene, remove the provided genes and proceed</span></span>
<span id="cb2-554"><a href="#cb2-554" aria-hidden="true" tabindex="-1"></a>        <span class="co"># with the whole pipeline for all samples selected</span></span>
<span id="cb2-555"><a href="#cb2-555" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb2-556"><a href="#cb2-556" aria-hidden="true" tabindex="-1"></a>            lists_genes,</span>
<span id="cb2-557"><a href="#cb2-557" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb2-558"><a href="#cb2-558" aria-hidden="true" tabindex="-1"></a>                genes_to_remove, </span>
<span id="cb2-559"><a href="#cb2-559" aria-hidden="true" tabindex="-1"></a>                sum_exp, </span>
<span id="cb2-560"><a href="#cb2-560" aria-hidden="true" tabindex="-1"></a>                pca_fit,</span>
<span id="cb2-561"><a href="#cb2-561" aria-hidden="true" tabindex="-1"></a>                assay_to_use, </span>
<span id="cb2-562"><a href="#cb2-562" aria-hidden="true" tabindex="-1"></a>                stable_genes, </span>
<span id="cb2-563"><a href="#cb2-563" aria-hidden="true" tabindex="-1"></a>                most_variable_genes</span>
<span id="cb2-564"><a href="#cb2-564" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb2-565"><a href="#cb2-565" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb2-566"><a href="#cb2-566" aria-hidden="true" tabindex="-1"></a>                <span class="co"># remove genes</span></span>
<span id="cb2-567"><a href="#cb2-567" aria-hidden="true" tabindex="-1"></a>                sum_exp <span class="ot">&lt;-</span> sum_exp[<span class="fu">setdiff</span>(<span class="fu">rownames</span>(sum_exp), genes_to_remove),]</span>
<span id="cb2-568"><a href="#cb2-568" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb2-569"><a href="#cb2-569" aria-hidden="true" tabindex="-1"></a>                <span class="co"># now proceed with the normalization pipeline and PC retrieval</span></span>
<span id="cb2-570"><a href="#cb2-570" aria-hidden="true" tabindex="-1"></a>                sum_exp <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb2-571"><a href="#cb2-571" aria-hidden="true" tabindex="-1"></a>                    sum_exp,</span>
<span id="cb2-572"><a href="#cb2-572" aria-hidden="true" tabindex="-1"></a>                    assay_to_use,</span>
<span id="cb2-573"><a href="#cb2-573" aria-hidden="true" tabindex="-1"></a>                    stable_genes,</span>
<span id="cb2-574"><a href="#cb2-574" aria-hidden="true" tabindex="-1"></a>                    most_variable_genes</span>
<span id="cb2-575"><a href="#cb2-575" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb2-576"><a href="#cb2-576" aria-hidden="true" tabindex="-1"></a>                pca_coords <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(sum_exp, pca_fit)</span>
<span id="cb2-577"><a href="#cb2-577" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb2-578"><a href="#cb2-578" aria-hidden="true" tabindex="-1"></a>                pca_coords[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)]</span>
<span id="cb2-579"><a href="#cb2-579" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb2-580"><a href="#cb2-580" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-581"><a href="#cb2-581" aria-hidden="true" tabindex="-1"></a>            <span class="at">sum_exp =</span> sum_exp, </span>
<span id="cb2-582"><a href="#cb2-582" aria-hidden="true" tabindex="-1"></a>            <span class="at">pca_fit =</span> pca_fit, </span>
<span id="cb2-583"><a href="#cb2-583" aria-hidden="true" tabindex="-1"></a>            <span class="at">assay_to_use =</span> assay_to_use, </span>
<span id="cb2-584"><a href="#cb2-584" aria-hidden="true" tabindex="-1"></a>            <span class="at">stable_genes =</span> stable_genes, </span>
<span id="cb2-585"><a href="#cb2-585" aria-hidden="true" tabindex="-1"></a>            <span class="at">most_variable_genes =</span> most_variable_genes</span>
<span id="cb2-586"><a href="#cb2-586" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-587"><a href="#cb2-587" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-588"><a href="#cb2-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets<span class="sc">$</span>tcga[, samples_to_use],</span>
<span id="cb2-589"><a href="#cb2-589" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit, </span>
<span id="cb2-590"><a href="#cb2-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"logFPKM_TMM"</span>, </span>
<span id="cb2-591"><a href="#cb2-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes, </span>
<span id="cb2-592"><a href="#cb2-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(genes_for_pca, stable_genes),</span>
<span id="cb2-593"><a href="#cb2-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">mc.cores =</span> <span class="dv">11</span></span>
<span id="cb2-594"><a href="#cb2-594" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-595"><a href="#cb2-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-596"><a href="#cb2-596" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-597"><a href="#cb2-597" aria-hidden="true" tabindex="-1"></a>    pca_coords_random,</span>
<span id="cb2-598"><a href="#cb2-598" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pca_coords_random.rds"</span></span>
<span id="cb2-599"><a href="#cb2-599" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-600"><a href="#cb2-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-601"><a href="#cb2-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-602"><a href="#cb2-602" aria-hidden="true" tabindex="-1"></a>get_pca_random_genes <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb2-603"><a href="#cb2-603" aria-hidden="true" tabindex="-1"></a>    use_sample,</span>
<span id="cb2-604"><a href="#cb2-604" aria-hidden="true" tabindex="-1"></a>    og_pca,</span>
<span id="cb2-605"><a href="#cb2-605" aria-hidden="true" tabindex="-1"></a>    pca_coords_random,</span>
<span id="cb2-606"><a href="#cb2-606" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores_random,</span>
<span id="cb2-607"><a href="#cb2-607" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_pcs =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb2-608"><a href="#cb2-608" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb2-609"><a href="#cb2-609" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-610"><a href="#cb2-610" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for each proportion, extract the coordinates</span></span>
<span id="cb2-611"><a href="#cb2-611" aria-hidden="true" tabindex="-1"></a>    pca_coords <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-612"><a href="#cb2-612" aria-hidden="true" tabindex="-1"></a>        pca_coords_random,</span>
<span id="cb2-613"><a href="#cb2-613" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x){</span>
<span id="cb2-614"><a href="#cb2-614" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sapply</span>(</span>
<span id="cb2-615"><a href="#cb2-615" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb2-616"><a href="#cb2-616" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(y) y[use_sample, which_pcs]</span>
<span id="cb2-617"><a href="#cb2-617" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb2-618"><a href="#cb2-618" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-619"><a href="#cb2-619" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"proportion"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-620"><a href="#cb2-620" aria-hidden="true" tabindex="-1"></a>        data.frame</span>
<span id="cb2-621"><a href="#cb2-621" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-622"><a href="#cb2-622" aria-hidden="true" tabindex="-1"></a>    fuzziness_scores <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb2-623"><a href="#cb2-623" aria-hidden="true" tabindex="-1"></a>        fuzziness_scores_random,</span>
<span id="cb2-624"><a href="#cb2-624" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x){</span>
<span id="cb2-625"><a href="#cb2-625" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sapply</span>(</span>
<span id="cb2-626"><a href="#cb2-626" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb2-627"><a href="#cb2-627" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(y) y</span>
<span id="cb2-628"><a href="#cb2-628" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb2-629"><a href="#cb2-629" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-630"><a href="#cb2-630" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., <span class="at">.id =</span> <span class="st">"proportion"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-631"><a href="#cb2-631" aria-hidden="true" tabindex="-1"></a>        data.frame</span>
<span id="cb2-632"><a href="#cb2-632" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-633"><a href="#cb2-633" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-634"><a href="#cb2-634" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb2-635"><a href="#cb2-635" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(</span>
<span id="cb2-636"><a href="#cb2-636" aria-hidden="true" tabindex="-1"></a>                <span class="at">random =</span> pca_coords,</span>
<span id="cb2-637"><a href="#cb2-637" aria-hidden="true" tabindex="-1"></a>                <span class="at">original =</span> og_pca <span class="sc">%&gt;%</span> </span>
<span id="cb2-638"><a href="#cb2-638" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">==</span> use_sample) <span class="sc">%&gt;%</span></span>
<span id="cb2-639"><a href="#cb2-639" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(which_pcs)) <span class="sc">%&gt;%</span></span>
<span id="cb2-640"><a href="#cb2-640" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">proportion =</span> <span class="st">"all_genes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-641"><a href="#cb2-641" aria-hidden="true" tabindex="-1"></a>                    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb2-642"><a href="#cb2-642" aria-hidden="true" tabindex="-1"></a>                    .[, <span class="fu">colnames</span>(pca_coords)]</span>
<span id="cb2-643"><a href="#cb2-643" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb2-644"><a href="#cb2-644" aria-hidden="true" tabindex="-1"></a>            <span class="at">.id =</span> <span class="st">"embedding"</span></span>
<span id="cb2-645"><a href="#cb2-645" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-646"><a href="#cb2-646" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-647"><a href="#cb2-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-648"><a href="#cb2-648" aria-hidden="true" tabindex="-1"></a>pca_random_genes_patients <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-649"><a href="#cb2-649" aria-hidden="true" tabindex="-1"></a>    samples_to_use, </span>
<span id="cb2-650"><a href="#cb2-650" aria-hidden="true" tabindex="-1"></a>    get_pca_random_genes, </span>
<span id="cb2-651"><a href="#cb2-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">og_pca =</span> df_pca_coordinates,</span>
<span id="cb2-652"><a href="#cb2-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_coords_random =</span> pca_coords_random, </span>
<span id="cb2-653"><a href="#cb2-653" aria-hidden="true" tabindex="-1"></a>    <span class="at">fuzziness_scores_random =</span> fuzziness_scores_random_top,</span>
<span id="cb2-654"><a href="#cb2-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_pcs =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb2-655"><a href="#cb2-655" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-656"><a href="#cb2-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb2-657"><a href="#cb2-657" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-658"><a href="#cb2-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-659"><a href="#cb2-659" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-660"><a href="#cb2-660" aria-hidden="true" tabindex="-1"></a>    pca_random_genes_patients,</span>
<span id="cb2-661"><a href="#cb2-661" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/pca_random_genes_patients.rds"</span></span>
<span id="cb2-662"><a href="#cb2-662" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-663"><a href="#cb2-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-664"><a href="#cb2-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-667"><a href="#cb2-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-668"><a href="#cb2-668" aria-hidden="true" tabindex="-1"></a>plots_random_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-669"><a href="#cb2-669" aria-hidden="true" tabindex="-1"></a>    samples_to_use, </span>
<span id="cb2-670"><a href="#cb2-670" aria-hidden="true" tabindex="-1"></a>    plot_pca_random_genes,</span>
<span id="cb2-671"><a href="#cb2-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_random_genes_patients =</span> pca_random_genes_patients,</span>
<span id="cb2-672"><a href="#cb2-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca_coordinates =</span> df_pca_coordinates,</span>
<span id="cb2-673"><a href="#cb2-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-674"><a href="#cb2-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb2-675"><a href="#cb2-675" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-676"><a href="#cb2-676" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-677"><a href="#cb2-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-678"><a href="#cb2-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-679"><a href="#cb2-679" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb2-680"><a href="#cb2-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-683"><a href="#cb2-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-684"><a href="#cb2-684" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">10</span>]</span>
<span id="cb2-685"><a href="#cb2-685" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-686"><a href="#cb2-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-687"><a href="#cb2-687" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb2-688"><a href="#cb2-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-689"><a href="#cb2-689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb2-690"><a href="#cb2-690" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-10</span></span>
<span id="cb2-691"><a href="#cb2-691" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb2-692"><a href="#cb2-692" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-693"><a href="#cb2-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-696"><a href="#cb2-696" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-697"><a href="#cb2-697" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">20</span>]</span>
<span id="cb2-698"><a href="#cb2-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-699"><a href="#cb2-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-700"><a href="#cb2-700" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb2-701"><a href="#cb2-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-702"><a href="#cb2-702" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb2-703"><a href="#cb2-703" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-20</span></span>
<span id="cb2-704"><a href="#cb2-704" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb2-705"><a href="#cb2-705" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-706"><a href="#cb2-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-709"><a href="#cb2-709" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-710"><a href="#cb2-710" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">50</span>]</span>
<span id="cb2-711"><a href="#cb2-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-712"><a href="#cb2-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-713"><a href="#cb2-713" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb2-714"><a href="#cb2-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-715"><a href="#cb2-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb2-716"><a href="#cb2-716" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-50</span></span>
<span id="cb2-717"><a href="#cb2-717" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb2-718"><a href="#cb2-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-719"><a href="#cb2-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-722"><a href="#cb2-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-723"><a href="#cb2-723" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">80</span>]</span>
<span id="cb2-724"><a href="#cb2-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-725"><a href="#cb2-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-726"><a href="#cb2-726" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb2-727"><a href="#cb2-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-728"><a href="#cb2-728" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb2-729"><a href="#cb2-729" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-80</span></span>
<span id="cb2-730"><a href="#cb2-730" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb2-731"><a href="#cb2-731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-732"><a href="#cb2-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-735"><a href="#cb2-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-736"><a href="#cb2-736" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">182</span>]</span>
<span id="cb2-737"><a href="#cb2-737" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-738"><a href="#cb2-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-739"><a href="#cb2-739" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb2-740"><a href="#cb2-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-741"><a href="#cb2-741" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb2-742"><a href="#cb2-742" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-182</span></span>
<span id="cb2-743"><a href="#cb2-743" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb2-744"><a href="#cb2-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-745"><a href="#cb2-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-748"><a href="#cb2-748" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-749"><a href="#cb2-749" aria-hidden="true" tabindex="-1"></a>patient_name <span class="ot">&lt;-</span> samples_to_use[<span class="dv">198</span>]</span>
<span id="cb2-750"><a href="#cb2-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-751"><a href="#cb2-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-752"><a href="#cb2-752" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r patient_name`</span></span>
<span id="cb2-753"><a href="#cb2-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-754"><a href="#cb2-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=5}</span></span>
<span id="cb2-755"><a href="#cb2-755" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-missing-correction-198</span></span>
<span id="cb2-756"><a href="#cb2-756" aria-hidden="true" tabindex="-1"></a>plots_random_genes[[patient_name]]</span>
<span id="cb2-757"><a href="#cb2-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-758"><a href="#cb2-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-759"><a href="#cb2-759" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb2-760"><a href="#cb2-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-761"><a href="#cb2-761" aria-hidden="true" tabindex="-1"></a>When looking at the figures above, it seems that whenever there are </span>
<span id="cb2-762"><a href="#cb2-762" aria-hidden="true" tabindex="-1"></a>genes missing,</span>
<span id="cb2-763"><a href="#cb2-763" aria-hidden="true" tabindex="-1"></a>and the more of top loadings they are, the closer they are to the origin.</span>
<span id="cb2-764"><a href="#cb2-764" aria-hidden="true" tabindex="-1"></a>This makes sense, since PCA is doing a simple linear combination of the loadings.</span>
<span id="cb2-765"><a href="#cb2-765" aria-hidden="true" tabindex="-1"></a>This should be fine to correct, since we can fit a line going through the </span>
<span id="cb2-766"><a href="#cb2-766" aria-hidden="true" tabindex="-1"></a>origin and goes through the points above. Then the adjustment will depend</span>
<span id="cb2-767"><a href="#cb2-767" aria-hidden="true" tabindex="-1"></a>on the number of genes that are missing and are top loadings. The more </span>
<span id="cb2-768"><a href="#cb2-768" aria-hidden="true" tabindex="-1"></a>they are, the more adjustment we will need. </span>
<span id="cb2-769"><a href="#cb2-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-770"><a href="#cb2-770" aria-hidden="true" tabindex="-1"></a>For the adjustment we only know two things, its current position and </span>
<span id="cb2-771"><a href="#cb2-771" aria-hidden="true" tabindex="-1"></a>how many of the top loadings are missing. Based on this information we</span>
<span id="cb2-772"><a href="#cb2-772" aria-hidden="true" tabindex="-1"></a>should be able to correct the samples. Given the list of genes that are missing,</span>
<span id="cb2-773"><a href="#cb2-773" aria-hidden="true" tabindex="-1"></a>we fit lines that would go through the genes that are missing in the TCGA</span>
<span id="cb2-774"><a href="#cb2-774" aria-hidden="true" tabindex="-1"></a>and METABRIC samples. We then try to find the line that is closes to the point.</span>
<span id="cb2-775"><a href="#cb2-775" aria-hidden="true" tabindex="-1"></a>After performing the fit and the line, we can then move the point to closer</span>
<span id="cb2-776"><a href="#cb2-776" aria-hidden="true" tabindex="-1"></a>to the METABRIC and TCGA samples. The point should be close to the line</span>
<span id="cb2-777"><a href="#cb2-777" aria-hidden="true" tabindex="-1"></a>and close to points that have the same proportion of top loadings </span>
<span id="cb2-778"><a href="#cb2-778" aria-hidden="true" tabindex="-1"></a>missing.</span>
<span id="cb2-779"><a href="#cb2-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-780"><a href="#cb2-780" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb2-781"><a href="#cb2-781" aria-hidden="true" tabindex="-1"></a>folder_to_save <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb2-782"><a href="#cb2-782" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/plots/validation/random_loadings/"</span></span>
<span id="cb2-783"><a href="#cb2-783" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-784"><a href="#cb2-784" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(</span>
<span id="cb2-785"><a href="#cb2-785" aria-hidden="true" tabindex="-1"></a>    folder_to_save, </span>
<span id="cb2-786"><a href="#cb2-786" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb2-787"><a href="#cb2-787" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb2-788"><a href="#cb2-788" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-789"><a href="#cb2-789" aria-hidden="true" tabindex="-1"></a>fig_width <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb2-790"><a href="#cb2-790" aria-hidden="true" tabindex="-1"></a>fig_height <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb2-791"><a href="#cb2-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-792"><a href="#cb2-792" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb2-793"><a href="#cb2-793" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,</span>
<span id="cb2-794"><a href="#cb2-794" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i, final_plots){</span>
<span id="cb2-795"><a href="#cb2-795" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggsave</span>(</span>
<span id="cb2-796"><a href="#cb2-796" aria-hidden="true" tabindex="-1"></a>            <span class="at">filename =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-797"><a href="#cb2-797" aria-hidden="true" tabindex="-1"></a>                folder_to_save, </span>
<span id="cb2-798"><a href="#cb2-798" aria-hidden="true" tabindex="-1"></a>                <span class="st">"/"</span>, </span>
<span id="cb2-799"><a href="#cb2-799" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ifelse</span>(i <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="fu">paste0</span>(<span class="st">"0"</span>,i), i), </span>
<span id="cb2-800"><a href="#cb2-800" aria-hidden="true" tabindex="-1"></a>                <span class="st">".png"</span></span>
<span id="cb2-801"><a href="#cb2-801" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb2-802"><a href="#cb2-802" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> final_plots[[i]],</span>
<span id="cb2-803"><a href="#cb2-803" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> fig_width,</span>
<span id="cb2-804"><a href="#cb2-804" aria-hidden="true" tabindex="-1"></a>            <span class="at">height =</span> fig_height, </span>
<span id="cb2-805"><a href="#cb2-805" aria-hidden="true" tabindex="-1"></a>            <span class="at">dpi =</span> <span class="dv">320</span></span>
<span id="cb2-806"><a href="#cb2-806" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-807"><a href="#cb2-807" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-808"><a href="#cb2-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_plots =</span> plots_random_genes</span>
<span id="cb2-809"><a href="#cb2-809" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-810"><a href="#cb2-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-811"><a href="#cb2-811" aria-hidden="true" tabindex="-1"></a><span class="co"># we then proceed to generate a gif by using the following command:</span></span>
<span id="cb2-812"><a href="#cb2-812" aria-hidden="true" tabindex="-1"></a><span class="co"># ffmpeg -framerate 1 -pattern_type glob -i 'random_loadings/*.png' random_loadings.mp4</span></span>
<span id="cb2-813"><a href="#cb2-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-814"><a href="#cb2-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-815"><a href="#cb2-815" aria-hidden="true" tabindex="-1"></a>These plots show how the fuzziness score might be indicative of how</span>
<span id="cb2-816"><a href="#cb2-816" aria-hidden="true" tabindex="-1"></a>good the embedding will be depending on the number of missing genes. The</span>
<span id="cb2-817"><a href="#cb2-817" aria-hidden="true" tabindex="-1"></a>video below shows the images for 20 different patients. Notice how all of</span>
<span id="cb2-818"><a href="#cb2-818" aria-hidden="true" tabindex="-1"></a>them are connected to the origin as well.</span>
<span id="cb2-819"><a href="#cb2-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-820"><a href="#cb2-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = !first_run, results = 'asis', echo = FALSE}</span></span>
<span id="cb2-821"><a href="#cb2-821" aria-hidden="true" tabindex="-1"></a>embedding_video <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb2-822"><a href="#cb2-822" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;iframe width="720" height="480" '</span>,</span>
<span id="cb2-823"><a href="#cb2-823" aria-hidden="true" tabindex="-1"></a>    <span class="st">'src="../plots/validation/random_loadings.mp4" '</span>,</span>
<span id="cb2-824"><a href="#cb2-824" aria-hidden="true" tabindex="-1"></a>    <span class="st">'align="middle" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;'</span></span>
<span id="cb2-825"><a href="#cb2-825" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-826"><a href="#cb2-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-827"><a href="#cb2-827" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(embedding_video)</span>
<span id="cb2-828"><a href="#cb2-828" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-829"><a href="#cb2-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-830"><a href="#cb2-830" aria-hidden="true" tabindex="-1"></a><span class="fu">## SMC embedding</span></span>
<span id="cb2-831"><a href="#cb2-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-832"><a href="#cb2-832" aria-hidden="true" tabindex="-1"></a>By following the same procedures as previously, normalizing and getting</span>
<span id="cb2-833"><a href="#cb2-833" aria-hidden="true" tabindex="-1"></a>the PC coordinates, @fig-smc-cohort shows the biplot of PC1 and PC2</span>
<span id="cb2-834"><a href="#cb2-834" aria-hidden="true" tabindex="-1"></a>when coloring by cohorts. The samples seem to be well mixed already in</span>
<span id="cb2-835"><a href="#cb2-835" aria-hidden="true" tabindex="-1"></a>the RNA-seq samples. This is probably due to the fact that the SMC cohort</span>
<span id="cb2-836"><a href="#cb2-836" aria-hidden="true" tabindex="-1"></a>has TPM values. </span>
<span id="cb2-837"><a href="#cb2-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-838"><a href="#cb2-838" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb2-839"><a href="#cb2-839" aria-hidden="true" tabindex="-1"></a>clin_data_smc <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb2-840"><a href="#cb2-840" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../data/2018_SMC/data_clinical_sample.txt"</span>,</span>
<span id="cb2-841"><a href="#cb2-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb2-842"><a href="#cb2-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">header =</span> <span class="cn">TRUE</span></span>
<span id="cb2-843"><a href="#cb2-843" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb2-844"><a href="#cb2-844" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(PAM50_SUBTYPE)</span>
<span id="cb2-845"><a href="#cb2-845" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-846"><a href="#cb2-846" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-847"><a href="#cb2-847" aria-hidden="true" tabindex="-1"></a>        <span class="at">pam50 =</span> <span class="fu">tolower</span>(PAM50_SUBTYPE)</span>
<span id="cb2-848"><a href="#cb2-848" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-849"><a href="#cb2-849" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-850"><a href="#cb2-850" aria-hidden="true" tabindex="-1"></a>        <span class="at">pam50 =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(pam50, <span class="st">"luminal"</span>, <span class="st">"lum"</span>)</span>
<span id="cb2-851"><a href="#cb2-851" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-852"><a href="#cb2-852" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>SAMPLE_ID) <span class="sc">%&gt;%</span></span>
<span id="cb2-853"><a href="#cb2-853" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_name =</span> SAMPLE_ID)</span>
<span id="cb2-854"><a href="#cb2-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-855"><a href="#cb2-855" aria-hidden="true" tabindex="-1"></a>smc_df <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb2-856"><a href="#cb2-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../data/2018_SMC/data_mrna_seq_tpm.txt"</span>,</span>
<span id="cb2-857"><a href="#cb2-857" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb2-858"><a href="#cb2-858" aria-hidden="true" tabindex="-1"></a>    <span class="at">header =</span> <span class="cn">TRUE</span></span>
<span id="cb2-859"><a href="#cb2-859" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-860"><a href="#cb2-860" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(Hugo_Symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb2-861"><a href="#cb2-861" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Entrez_Gene_Id =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-862"><a href="#cb2-862" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>Hugo_Symbol) <span class="sc">%&gt;%</span></span>
<span id="cb2-863"><a href="#cb2-863" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Hugo_Symbol =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-864"><a href="#cb2-864" aria-hidden="true" tabindex="-1"></a>smc_df <span class="ot">&lt;-</span> smc_df[, <span class="fu">rownames</span>(clin_data_smc)]</span>
<span id="cb2-865"><a href="#cb2-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-866"><a href="#cb2-866" aria-hidden="true" tabindex="-1"></a><span class="co"># almost all genes are available, only 4 are missing</span></span>
<span id="cb2-867"><a href="#cb2-867" aria-hidden="true" tabindex="-1"></a>smc_df <span class="ot">&lt;-</span> SummarizedExperiment<span class="sc">::</span><span class="fu">SummarizedExperiment</span>(</span>
<span id="cb2-868"><a href="#cb2-868" aria-hidden="true" tabindex="-1"></a>    <span class="at">assays =</span> <span class="fu">list</span>(</span>
<span id="cb2-869"><a href="#cb2-869" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tpm"</span> <span class="ot">=</span> smc_df,</span>
<span id="cb2-870"><a href="#cb2-870" aria-hidden="true" tabindex="-1"></a>        <span class="st">"logtpm"</span> <span class="ot">=</span> <span class="fu">log2</span>(smc_df <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb2-871"><a href="#cb2-871" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-872"><a href="#cb2-872" aria-hidden="true" tabindex="-1"></a>    <span class="at">colData =</span> clin_data_smc</span>
<span id="cb2-873"><a href="#cb2-873" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-874"><a href="#cb2-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-875"><a href="#cb2-875" aria-hidden="true" tabindex="-1"></a><span class="co"># get the normalization performed </span></span>
<span id="cb2-876"><a href="#cb2-876" aria-hidden="true" tabindex="-1"></a>smc_normalized <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb2-877"><a href="#cb2-877" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> smc_df,</span>
<span id="cb2-878"><a href="#cb2-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"logtpm"</span>,</span>
<span id="cb2-879"><a href="#cb2-879" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes,</span>
<span id="cb2-880"><a href="#cb2-880" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(<span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings), stable_genes)</span>
<span id="cb2-881"><a href="#cb2-881" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-882"><a href="#cb2-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-883"><a href="#cb2-883" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the embedding</span></span>
<span id="cb2-884"><a href="#cb2-884" aria-hidden="true" tabindex="-1"></a>smc_df_pca <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(smc_normalized, pca_fit) <span class="sc">%&gt;%</span></span>
<span id="cb2-885"><a href="#cb2-885" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb2-886"><a href="#cb2-886" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb2-887"><a href="#cb2-887" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(smc_normalized) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb2-888"><a href="#cb2-888" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-889"><a href="#cb2-889" aria-hidden="true" tabindex="-1"></a>                <span class="at">er_status =</span> <span class="fu">ifelse</span>(</span>
<span id="cb2-890"><a href="#cb2-890" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_detect</span>(IHC_SUBTYPE, <span class="st">"ER</span><span class="sc">\\</span><span class="st">+"</span>), <span class="st">"pos"</span>, <span class="st">"neg"</span></span>
<span id="cb2-891"><a href="#cb2-891" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb2-892"><a href="#cb2-892" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb2-893"><a href="#cb2-893" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">cohort =</span> <span class="st">"smc"</span>)</span>
<span id="cb2-894"><a href="#cb2-894" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb2-895"><a href="#cb2-895" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., df_pca_coordinates)</span>
<span id="cb2-896"><a href="#cb2-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-897"><a href="#cb2-897" aria-hidden="true" tabindex="-1"></a><span class="co"># save all the results</span></span>
<span id="cb2-898"><a href="#cb2-898" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-899"><a href="#cb2-899" aria-hidden="true" tabindex="-1"></a>    smc_df,</span>
<span id="cb2-900"><a href="#cb2-900" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/smc_df.rds"</span></span>
<span id="cb2-901"><a href="#cb2-901" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-902"><a href="#cb2-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-903"><a href="#cb2-903" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-904"><a href="#cb2-904" aria-hidden="true" tabindex="-1"></a>    smc_df_pca <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb2-905"><a href="#cb2-905" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/smc_df_pca.rds"</span></span>
<span id="cb2-906"><a href="#cb2-906" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-907"><a href="#cb2-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-908"><a href="#cb2-908" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb2-909"><a href="#cb2-909" aria-hidden="true" tabindex="-1"></a>    smc_normalized,</span>
<span id="cb2-910"><a href="#cb2-910" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/validation/smc_normalized.rds"</span></span>
<span id="cb2-911"><a href="#cb2-911" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-912"><a href="#cb2-912" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-913"><a href="#cb2-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-914"><a href="#cb2-914" aria-hidden="true" tabindex="-1"></a>When checking the total number of genes missing, there are only </span>
<span id="cb2-915"><a href="#cb2-915" aria-hidden="true" tabindex="-1"></a><span class="in">`r nrow(datasets_normalized$tcga) - nrow(smc_normalized)`</span> genes missing. </span>
<span id="cb2-916"><a href="#cb2-916" aria-hidden="true" tabindex="-1"></a>And as seen before, this number is almost irrelevant, in the sense that</span>
<span id="cb2-917"><a href="#cb2-917" aria-hidden="true" tabindex="-1"></a>the embedding will still be robust and locations will be precise enough.</span>
<span id="cb2-918"><a href="#cb2-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-921"><a href="#cb2-921" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-922"><a href="#cb2-922" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-smc-cohort</span></span>
<span id="cb2-923"><a href="#cb2-923" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Biplot of first two PCA components from SMC, TCGA, SCANB and </span></span>
<span id="cb2-924"><a href="#cb2-924" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC. SMC is highlighted in the plot and has a bigger dot.</span></span>
<span id="cb2-925"><a href="#cb2-925" aria-hidden="true" tabindex="-1"></a>smc_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb2-926"><a href="#cb2-926" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb2-927"><a href="#cb2-927" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> cohort)</span>
<span id="cb2-928"><a href="#cb2-928" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb2-929"><a href="#cb2-929" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb2-930"><a href="#cb2-930" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb2-931"><a href="#cb2-931" aria-hidden="true" tabindex="-1"></a>        <span class="st">"smc"</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb2-932"><a href="#cb2-932" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb2-933"><a href="#cb2-933" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb2-934"><a href="#cb2-934" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb2-935"><a href="#cb2-935" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb2-936"><a href="#cb2-936" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb2-937"><a href="#cb2-937" aria-hidden="true" tabindex="-1"></a>        <span class="st">"smc"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb2-938"><a href="#cb2-938" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb2-939"><a href="#cb2-939" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb2-940"><a href="#cb2-940" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb2-941"><a href="#cb2-941" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb2-942"><a href="#cb2-942" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb2-943"><a href="#cb2-943" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb2-944"><a href="#cb2-944" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb2-945"><a href="#cb2-945" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb2-946"><a href="#cb2-946" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb2-947"><a href="#cb2-947" aria-hidden="true" tabindex="-1"></a>            <span class="st">"First two components of SMC overlayed on all the three</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb2-948"><a href="#cb2-948" aria-hidden="true" tabindex="-1"></a>            <span class="st">"big cohorts in the the molecular landscape"</span></span>
<span id="cb2-949"><a href="#cb2-949" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-950"><a href="#cb2-950" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, METABRIC and SCANB are plotted"</span></span>
<span id="cb2-951"><a href="#cb2-951" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb2-952"><a href="#cb2-952" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>)</span>
<span id="cb2-953"><a href="#cb2-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-954"><a href="#cb2-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-955"><a href="#cb2-955" aria-hidden="true" tabindex="-1"></a>As previously, @fig-pca-smc-er-pam50 shows the biplot of PC2 and PC3, </span>
<span id="cb2-956"><a href="#cb2-956" aria-hidden="true" tabindex="-1"></a>highlighting the well mixing of the cohorts. When coloring by ER status,</span>
<span id="cb2-957"><a href="#cb2-957" aria-hidden="true" tabindex="-1"></a>samples are in the right group. Molecular subtype is also correct. This</span>
<span id="cb2-958"><a href="#cb2-958" aria-hidden="true" tabindex="-1"></a>cohort is special in the sense that there are more luminal B patients,</span>
<span id="cb2-959"><a href="#cb2-959" aria-hidden="true" tabindex="-1"></a>as discussed in the paper. That is why there are more samples in the </span>
<span id="cb2-960"><a href="#cb2-960" aria-hidden="true" tabindex="-1"></a>luminal B region.</span>
<span id="cb2-961"><a href="#cb2-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-962"><a href="#cb2-962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=18, fig.height=11}</span></span>
<span id="cb2-963"><a href="#cb2-963" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-smc-er-pam50</span></span>
<span id="cb2-964"><a href="#cb2-964" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC including</span></span>
<span id="cb2-965"><a href="#cb2-965" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the SMC samples on top.</span></span>
<span id="cb2-966"><a href="#cb2-966" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (A) Colored by cohort,</span></span>
<span id="cb2-967"><a href="#cb2-967" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (B) colored by ER status, (C) colored by PAM50 molecular subtype.</span></span>
<span id="cb2-968"><a href="#cb2-968" aria-hidden="true" tabindex="-1"></a>plots_smc <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb2-969"><a href="#cb2-969" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"cohort"</span>, <span class="st">"er_status"</span>, <span class="st">"pam50"</span>), </span>
<span id="cb2-970"><a href="#cb2-970" aria-hidden="true" tabindex="-1"></a>    get_plot_new_samples,</span>
<span id="cb2-971"><a href="#cb2-971" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cohort =</span> <span class="st">"smc"</span>,</span>
<span id="cb2-972"><a href="#cb2-972" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> smc_df_pca <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">!=</span> <span class="st">"scanb"</span>),</span>
<span id="cb2-973"><a href="#cb2-973" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb2-974"><a href="#cb2-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb2-975"><a href="#cb2-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-976"><a href="#cb2-976" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb2-977"><a href="#cb2-977" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-978"><a href="#cb2-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-979"><a href="#cb2-979" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plots_smc, <span class="at">labels =</span> <span class="st">"AUTO"</span>)</span>
<span id="cb2-980"><a href="#cb2-980" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chronchi">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/chronchi">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
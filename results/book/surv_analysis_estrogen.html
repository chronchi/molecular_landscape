<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Molecular landscape: a new framework for personalized medicine in Breast Cancer. - 1&nbsp; Estrogen receptor status is continuous, not dichotomous</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./pca_merging.html" rel="next">
<link href="./intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.28/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="site_libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="site_libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="site_libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="site_libs/selectize-0.12.0/selectize.min.js"></script>
<link href="site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./surv_analysis_estrogen.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Molecular landscape: a new framework for personalized medicine in Breast Cancer.</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chronchi/molecular_landscape" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surv_analysis_estrogen.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pca_merging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scoring.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./risk_score.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk score model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./trying.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Tests and tries</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discussion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discussion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#loading-and-filtering-the-datasets" id="toc-loading-and-filtering-the-datasets" class="nav-link active" data-scroll-target="#loading-and-filtering-the-datasets"><span class="header-section-number">1.1</span> Loading and filtering the datasets</a></li>
  <li><a href="#umap-projection-of-the-datasets" id="toc-umap-projection-of-the-datasets" class="nav-link" data-scroll-target="#umap-projection-of-the-datasets"><span class="header-section-number">1.2</span> UMAP projection of the datasets</a></li>
  <li><a href="#calculating-scores" id="toc-calculating-scores" class="nav-link" data-scroll-target="#calculating-scores"><span class="header-section-number">1.3</span> Calculating scores</a></li>
  <li><a href="#survival-analysis" id="toc-survival-analysis" class="nav-link" data-scroll-target="#survival-analysis"><span class="header-section-number">1.4</span> Survival analysis</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">1.4.1</span> Results</a></li>
  </ul></li>
  <li><a href="#comparison-of-er-ihc-and-molecular-er-signaling" id="toc-comparison-of-er-ihc-and-molecular-er-signaling" class="nav-link" data-scroll-target="#comparison-of-er-ihc-and-molecular-er-signaling"><span class="header-section-number">1.5</span> Comparison of ER IHC and molecular ER signaling</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">1.6</span> Conclusion</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chronchi/molecular_landscape/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Currently in the clinics estrogen receptor (ER) status is treated as dichotomous condition. Either a breast cancer (BC) is ER positive (ER+) or ER negative (ER-). The threshold for ER+ cells usually is 1% or 10% of the cells positive in a IHC staining. The idea is that ER+ BC patients will receive endocrine therapy, usually tamoxifen or some aromatase inhibitor, for treatment. The problem is not all patients respond the same to these drugs and they also have different proportions of ER+ cells.</p>
<p>In this document we show how leveraging molecular information distinguishes ER+ BC patients and how one should look more carefully on ER status. In order to do this, estrogen related signatures: estrogen response early and late from MSigDB<span class="citation" data-cites="Subramanian2005">(<a href="references.html#ref-Subramanian2005" role="doc-biblioref">Subramanian et al. 2005</a>)</span> and <span class="math inline">\(SET_{ER/PR}\)</span><span class="citation" data-cites="Sinn2019">(<a href="references.html#ref-Sinn2019" role="doc-biblioref">Sinn et al. 2019</a>)</span>, are used to calculate scores for each BC patient. These scores then are used to calculate associations with survival analysis. When performing cox regression, we try to adjust for sensible covariates in order to reduce bias. Even though we are adjusting, it is very difficult to know if a covariate is missing in the regression. Thus, care should be always taken when interpreting these results.</p>
<p>This chapter is structure in the following way. First section corresponds to loading the datasets and then filtering them. Estrogen signatures scores are calculated using GSVA <span class="citation" data-cites="Hnzelmann2013">(<a href="references.html#ref-Hnzelmann2013" role="doc-biblioref">Hänzelmann, Castelo, and Guinney 2013</a>)</span>. Given the scores, cox regression can be performed adjusting for clinical variables. After this the Hazard ratios can be computed and interpreted along with their confidence intervals.</p>
<section id="loading-and-filtering-the-datasets" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="loading-and-filtering-the-datasets"><span class="header-section-number">1.1</span> Loading and filtering the datasets</h2>
<p>The preprocessing of the datasets is described in the website below: &gt; https://chronchi.github.io/transcriptomics</p>
<p>To check the code used here either click in the code button on the top right part of the page or check the github page (github.com/chronchi/molecular_landscape).</p>
<p>The TCGA, METABRIC and SCANB cohorts are used in this section here. They are the biggest cohort of Breast cancer patients in the world. Each datasets has an overall equal distribution of ER+ and ER- patients and similar age distribution.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>* The library is already synchronized with the lockfile.</code></pre>
</div>
</div>
</section>
<section id="umap-projection-of-the-datasets" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="umap-projection-of-the-datasets"><span class="header-section-number">1.2</span> UMAP projection of the datasets</h2>
<p>The plots below show how each patient is different in a molecular sense, and even inside each molecular subtype there are some differences. This indicates how different patients, at least molecularly. We only do the umap of samples that have a PAM50 molecular subtype assigned.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-surv-umap-all" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-surv-umap-all-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.1: UMAP projections of all three cohorts in the following order”:” TCGA, SCANB and METABRIC. They are colored by the PAM50 molecular subtype.</figcaption>
</figure>
</div>
</div>
</div>
<p>From the plots above we see a distinction of the different molecular subtypes.</p>
</section>
<section id="calculating-scores" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="calculating-scores"><span class="header-section-number">1.3</span> Calculating scores</h2>
<p>In order to calculate the scores, the package <code>msigdb</code> is used to load the hallmark data into R. The <span class="math inline">\(SET_{ER/PR}\)</span> is made of the following genes:</p>
<div class="cell">
<div class="cell-output-display">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Affy</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">is_target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">202089_s_at</td>
<td style="text-align: left;">SLC39A6</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">203438_at</td>
<td style="text-align: left;">STC2</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">204508_s_at</td>
<td style="text-align: left;">CA12</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">205225_at</td>
<td style="text-align: left;">ESR1</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">205380_at</td>
<td style="text-align: left;">PDZK1</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">205440_s_at</td>
<td style="text-align: left;">NPY1R</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">205831_at</td>
<td style="text-align: left;">CD2</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">206401_s_at</td>
<td style="text-align: left;">MAPT</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">209123_at</td>
<td style="text-align: left;">QDPR</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">209309_at</td>
<td style="text-align: left;">AZGP1</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">209459_s_at</td>
<td style="text-align: left;">ABAT</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">213245_at</td>
<td style="text-align: left;">ADCY1</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">213539_at</td>
<td style="text-align: left;">CD3D</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">214440_at</td>
<td style="text-align: left;">NAT1</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">218398_at</td>
<td style="text-align: left;">MRPS30</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">218976_at</td>
<td style="text-align: left;">DNAJC12</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">219197_s_at</td>
<td style="text-align: left;">SCUBE2</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="even">
<td style="text-align: left;">222379_at</td>
<td style="text-align: left;">KCNE4</td>
<td style="text-align: left;">yes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">200650_s_at</td>
<td style="text-align: left;">LDHA</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="even">
<td style="text-align: left;">202961_s_at</td>
<td style="text-align: left;">ATP5J2</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="odd">
<td style="text-align: left;">211662_s_at</td>
<td style="text-align: left;">VDAC2</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="even">
<td style="text-align: left;">201623_s_at</td>
<td style="text-align: left;">DARS</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="odd">
<td style="text-align: left;">205480_s_at</td>
<td style="text-align: left;">UGP2</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="even">
<td style="text-align: left;">217750_s_at</td>
<td style="text-align: left;">UBE2Z</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="odd">
<td style="text-align: left;">212175_s_at</td>
<td style="text-align: left;">AK2</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="even">
<td style="text-align: left;">212050_at</td>
<td style="text-align: left;">WIPF2</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="odd">
<td style="text-align: left;">202631_s_at</td>
<td style="text-align: left;">APPBP2</td>
<td style="text-align: left;">no</td>
</tr>
<tr class="even">
<td style="text-align: left;">202342_s_at</td>
<td style="text-align: left;">TRIM2</td>
<td style="text-align: left;">no</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The first 18 genes are considered to be the target genes, the last 10 genes are the genes used for reference. According to their paper, the score is calculated in the following way:</p>
<p><span class="math display">\[
SET_{ER/PR} = \sum_{i = 1}^{18} \frac{T_i}{18} - \sum_{j=1}^{10}\frac{R_j}{10} + 2
\]</span></p>
<p>Where <span class="math inline">\(T_i\)</span> are the expression levels of target genes and <span class="math inline">\(R_j\)</span> are the expression levels of the reference genes. Here we use GSVA to calculate the scores, even when using their genes.</p>
<p>Before we calculate any score, let us check the number of genes available for each pathway in each dataset. This is important, in other to have robust scores, most of the genes should be available in the datasets. We also add signatures of 18 and 200 random genes for control.</p>
<div class="cell">
<div class="cell-output-display">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">pathway</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tcga</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">scanb</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">metabric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">average_percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">HALLMARK_ADIPOGENESIS</td>
<td style="text-align: right;">188</td>
<td style="text-align: right;">187</td>
<td style="text-align: right;">164</td>
<td style="text-align: right;">210</td>
<td style="text-align: left;">0.86</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_ALLOGRAFT_REJECTION</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">134</td>
<td style="text-align: right;">139</td>
<td style="text-align: right;">335</td>
<td style="text-align: left;">0.41</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_ANDROGEN_RESPONSE</td>
<td style="text-align: right;">93</td>
<td style="text-align: right;">92</td>
<td style="text-align: right;">83</td>
<td style="text-align: right;">102</td>
<td style="text-align: left;">0.88</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_ANGIOGENESIS</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">36</td>
<td style="text-align: left;">0.81</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_APICAL_JUNCTION</td>
<td style="text-align: right;">155</td>
<td style="text-align: right;">148</td>
<td style="text-align: right;">151</td>
<td style="text-align: right;">231</td>
<td style="text-align: left;">0.66</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_APICAL_SURFACE</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">46</td>
<td style="text-align: left;">0.67</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_APOPTOSIS</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">130</td>
<td style="text-align: right;">183</td>
<td style="text-align: left;">0.75</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_BILE_ACID_METABOLISM</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">114</td>
<td style="text-align: left;">0.65</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_CHOLESTEROL_HOMEOSTASIS</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">77</td>
<td style="text-align: left;">0.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_COAGULATION</td>
<td style="text-align: right;">92</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">88</td>
<td style="text-align: right;">162</td>
<td style="text-align: left;">0.56</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_COMPLEMENT</td>
<td style="text-align: right;">152</td>
<td style="text-align: right;">149</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">237</td>
<td style="text-align: left;">0.63</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_DNA_REPAIR</td>
<td style="text-align: right;">145</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">127</td>
<td style="text-align: right;">170</td>
<td style="text-align: left;">0.82</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_E2F_TARGETS</td>
<td style="text-align: right;">196</td>
<td style="text-align: right;">179</td>
<td style="text-align: right;">174</td>
<td style="text-align: right;">218</td>
<td style="text-align: left;">0.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION</td>
<td style="text-align: right;">179</td>
<td style="text-align: right;">172</td>
<td style="text-align: right;">172</td>
<td style="text-align: right;">204</td>
<td style="text-align: left;">0.85</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_ESTROGEN_RESPONSE_EARLY</td>
<td style="text-align: right;">189</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">162</td>
<td style="text-align: right;">216</td>
<td style="text-align: left;">0.81</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_ESTROGEN_RESPONSE_LATE</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">162</td>
<td style="text-align: right;">162</td>
<td style="text-align: right;">218</td>
<td style="text-align: left;">0.76</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_FATTY_ACID_METABOLISM</td>
<td style="text-align: right;">128</td>
<td style="text-align: right;">124</td>
<td style="text-align: right;">127</td>
<td style="text-align: right;">165</td>
<td style="text-align: left;">0.77</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_G2M_CHECKPOINT</td>
<td style="text-align: right;">187</td>
<td style="text-align: right;">172</td>
<td style="text-align: right;">173</td>
<td style="text-align: right;">204</td>
<td style="text-align: left;">0.87</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_GLYCOLYSIS</td>
<td style="text-align: right;">173</td>
<td style="text-align: right;">167</td>
<td style="text-align: right;">167</td>
<td style="text-align: right;">215</td>
<td style="text-align: left;">0.79</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_HEDGEHOG_SIGNALING</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">36</td>
<td style="text-align: left;">0.65</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_HEME_METABOLISM</td>
<td style="text-align: right;">152</td>
<td style="text-align: right;">150</td>
<td style="text-align: right;">138</td>
<td style="text-align: right;">214</td>
<td style="text-align: left;">0.69</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_HYPOXIA</td>
<td style="text-align: right;">168</td>
<td style="text-align: right;">163</td>
<td style="text-align: right;">163</td>
<td style="text-align: right;">215</td>
<td style="text-align: left;">0.77</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_IL2_STAT5_SIGNALING</td>
<td style="text-align: right;">163</td>
<td style="text-align: right;">156</td>
<td style="text-align: right;">163</td>
<td style="text-align: right;">216</td>
<td style="text-align: left;">0.74</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_IL6_JAK_STAT3_SIGNALING</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">103</td>
<td style="text-align: left;">0.61</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_INFLAMMATORY_RESPONSE</td>
<td style="text-align: right;">142</td>
<td style="text-align: right;">131</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">222</td>
<td style="text-align: left;">0.63</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_INTERFERON_ALPHA_RESPONSE</td>
<td style="text-align: right;">92</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">140</td>
<td style="text-align: left;">0.63</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_INTERFERON_GAMMA_RESPONSE</td>
<td style="text-align: right;">178</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">164</td>
<td style="text-align: right;">286</td>
<td style="text-align: left;">0.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_KRAS_SIGNALING_DN</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">54</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">220</td>
<td style="text-align: left;">0.31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_KRAS_SIGNALING_UP</td>
<td style="text-align: right;">156</td>
<td style="text-align: right;">147</td>
<td style="text-align: right;">146</td>
<td style="text-align: right;">220</td>
<td style="text-align: left;">0.68</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_MITOTIC_SPINDLE</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">189</td>
<td style="text-align: right;">168</td>
<td style="text-align: right;">215</td>
<td style="text-align: left;">0.85</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_MTORC1_SIGNALING</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">189</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">211</td>
<td style="text-align: left;">0.88</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_MYC_TARGETS_V1</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">185</td>
<td style="text-align: right;">236</td>
<td style="text-align: left;">0.81</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_MYC_TARGETS_V2</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">60</td>
<td style="text-align: left;">0.93</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_MYOGENESIS</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">131</td>
<td style="text-align: right;">139</td>
<td style="text-align: right;">212</td>
<td style="text-align: left;">0.62</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_NOTCH_SIGNALING</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">34</td>
<td style="text-align: left;">0.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_OXIDATIVE_PHOSPHORYLATION</td>
<td style="text-align: right;">199</td>
<td style="text-align: right;">185</td>
<td style="text-align: right;">169</td>
<td style="text-align: right;">220</td>
<td style="text-align: left;">0.84</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_P53_PATHWAY</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">172</td>
<td style="text-align: right;">160</td>
<td style="text-align: right;">215</td>
<td style="text-align: left;">0.79</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_PANCREAS_BETA_CELLS</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">44</td>
<td style="text-align: left;">0.33</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_PEROXISOME</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">87</td>
<td style="text-align: right;">110</td>
<td style="text-align: left;">0.78</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_PI3K_AKT_MTOR_SIGNALING</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">118</td>
<td style="text-align: left;">0.75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_PROTEIN_SECRETION</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">92</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">98</td>
<td style="text-align: left;">0.94</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">58</td>
<td style="text-align: left;">0.78</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_SPERMATOGENESIS</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">59</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">144</td>
<td style="text-align: left;">0.44</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_TGF_BETA_SIGNALING</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">59</td>
<td style="text-align: left;">0.81</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_TNFA_SIGNALING_VIA_NFKB</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">173</td>
<td style="text-align: right;">166</td>
<td style="text-align: right;">228</td>
<td style="text-align: left;">0.75</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_UNFOLDED_PROTEIN_RESPONSE</td>
<td style="text-align: right;">106</td>
<td style="text-align: right;">106</td>
<td style="text-align: right;">98</td>
<td style="text-align: right;">115</td>
<td style="text-align: left;">0.9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_UV_RESPONSE_DN</td>
<td style="text-align: right;">129</td>
<td style="text-align: right;">131</td>
<td style="text-align: right;">121</td>
<td style="text-align: right;">152</td>
<td style="text-align: left;">0.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_UV_RESPONSE_UP</td>
<td style="text-align: right;">129</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">127</td>
<td style="text-align: right;">191</td>
<td style="text-align: left;">0.67</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HALLMARK_WNT_BETA_CATENIN_SIGNALING</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">50</td>
<td style="text-align: left;">0.7</td>
</tr>
<tr class="even">
<td style="text-align: left;">HALLMARK_XENOBIOTIC_METABOLISM</td>
<td style="text-align: right;">142</td>
<td style="text-align: right;">135</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">224</td>
<td style="text-align: left;">0.62</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SET_ERPR</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">0.93</td>
</tr>
<tr class="even">
<td style="text-align: left;">random_200</td>
<td style="text-align: right;">162</td>
<td style="text-align: right;">145</td>
<td style="text-align: right;">154</td>
<td style="text-align: right;">200</td>
<td style="text-align: left;">0.77</td>
</tr>
<tr class="odd">
<td style="text-align: left;">random_18</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">0.8</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Most of the genes are available in all datasets. When calculating scores it is always good to check the availability of the genes. Otherwise this can make the score unstable, since too many of the genes are missing. For example, HALLMARK_PANCREAS_BETA_CELLS might have an unstable score, due to a lot of genes missing.</p>
<p>For each dataset one can plot the differences in scores for ER+ and ER- BC patients. This should be already an indication that the scores are meaningful. The next sections shows the results for each dataset individually.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">TCGA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">METABRIC</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">SCANB</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-tcga" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-tcga-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.2: Scores for TCGA patients</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.3: Scores for METABRIC patients</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-scanb-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.4: Scores for SCANB patients</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>From the plots above one can conclude that three different estrogen pathways capture the differences between ER status and also molecular subtypes. There are two plots with random genes for control and we can see that there is no difference between the ER status when using those gene sets.</p>
<p>Below is a combined image for TCGA, SCANB and METABRIC using the <span class="math inline">\(SET_{ER/PR}\)</span> signature.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric-tcga-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-tcga-scanb-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.5: SET ER/PR scores for all three cohorts.</figcaption>
</figure>
</div>
</div>
</div>
<p>And now using the hallmark estrogen response early.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric-tcga-scanb-estrogen-early" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-tcga-scanb-estrogen-early-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.6: Estrogen early scores for all three cohorts.</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that there is a considerable overlap between the ER+ and ER- BC samples. For each cohort the numbers of ER+ BC samples that have scores below 0 is shown below:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$metabric
                er_status                
 is_below_0           neg             pos
         no   4.66%  (20)  61.43%   (884)
        yes  95.34% (409)  38.57%   (555)
      Total 100.00% (429) 100.00% (1,439)

$scanb
                  er_status                
 is_below_0             neg             pos
         no   3.87%    (50)  48.47% (3,482)
        yes  96.13% (1,241)  51.53% (3,702)
      Total 100.00% (1,291) 100.00% (7,184)

$tcga
                er_status              
 is_below_0           neg           pos
         no   3.03%   (7)  57.49% (445)
        yes  96.97% (224)  42.51% (329)
      Total 100.00% (231) 100.00% (774)</code></pre>
</div>
</div>
<p>Another way to look at the data is to plot by molecular subtype instead of ER status.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">TCGA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">METABRIC</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">SCANB</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-tcga-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-tcga-pam50-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.7: Scores for TCGA patients stratified by PAM50 molecular subtype</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-pam50-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.8: Scores for METABRIC patients stratified by PAM50 molecular subtype</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-scanb-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-scanb-pam50-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.9: Scores for SCANB patients stratified by PAM50 molecular subtype</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In all cohorts the luminal A and B patients have a similar score. Also the distinction is very clear between the basal and HER2-like patients versus luminal A and B.</p>
<p>One question that usually arises when calculating scores from gene sets is if proliferation associated genes (PAG) are driving the distinctions. These signatures are highly curated and they have close or no PAGs. Therefore, the scores are not affected by PAGs and they really reflect the biology.</p>
<p>Lastly we show in <a href="#fig-scores-scanb-esr1">Figure&nbsp;<span>1.10</span></a> the correlation of the estrogen signaling scores with the signatures.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-scanb-esr1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-scanb-esr1-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;1.10: Scores for SCANB patients stratified by PAM50 molecular subtype</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that there is a positive correlation between signatures and scores, the problem though is the high variability in the scores in this case.</p>
<p>In the next section we will show how these scores are also prognostic for ER+ BC patients.</p>
</section>
<section id="survival-analysis" class="level2 page-columns page-full" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="survival-analysis"><span class="header-section-number">1.4</span> Survival analysis</h2>
<p>Since the scores are continuous variables and they are already scaled due to the output of GSVA, cox regression <span class="citation" data-cites="Cox1972">(<a href="references.html#ref-Cox1972" role="doc-biblioref">Cox 1972</a>)</span> can be used. The advantages of using cox regression is that one can control for other variables. You might ask, why should one control for clinical variables? One of the reasons is because the data being dealt here is observational data. There are several confounders, for example, a score might be up because patients with a higher tumor grade have higher expression of some genes. Thus the score is confounded by the tumor grade and the interpretation changes.</p>
<p>There are limitations still when dealing with observational data. A strong hypothesis for performing survival analysis with observational data is that we have measured all the confounder variables. This is pretty strong and in practice we never know if a confounder is missing or not. For a more thorough overview of the causal framework for observational data, check the books <span class="citation" data-cites="Gelman2020-uh McElreath2020-jn">(<a href="references.html#ref-Gelman2020-uh" role="doc-biblioref">Gelman, Hill, and Vehtari 2020</a>; <a href="references.html#ref-McElreath2020-jn" role="doc-biblioref">McElreath 2020</a>)</span>.</p>
<div class="page-columns page-full"><p>All the cohorts have a different set of clinical variables available. Therefore, the regression will be done by adjusting a different set of variables. Below is the description of the variables used for each cohort.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;This <a href="https://web.archive.org/web/20220630083539/https://www.cancer.net/cancer-types/breast-cancer/stages">webpage</a> explains with more details the different tumor stages and how BC are classified.</p></li></div></div>
<ul>
<li><strong>Age</strong>: age is one of the most important factors to adjust, specially in breast cancer. This covariate is used for all cohorts.</li>
<li><strong>NPI</strong>: the Nottingham prognostic index scores each tumor based on tumor grade, tumor size and number of lymph nodes. Only METABRIC has this information.</li>
<li><strong>Tumor Size</strong>: as name describes. Only SCANB has this information.</li>
<li><strong>Tumor Stage</strong>: tumors are usually described in terms of stage, it reflects the tumor size and location. SCANB and TCGA have this information.</li>
<li><strong>Node Stage</strong>: similar to tumor stage, but encodes the number of lymph nodes where breast cancer cells can be found. SCANB and TCGA have this information.</li>
</ul>
<p>Thus the models we are going to use for the survival analysis of each dataset is shown below.</p>
<ul>
<li>TCGA: <code>~ score + age + node_stage + tumor_stage</code>,</li>
<li>SCANB: <code>~ score + age + node_stage + tumor_stage</code>,</li>
<li>METABRIC: <code>~ score + age + NPI</code>,</li>
</ul>
<p>where score is one of the scores calculated earlier with GSVA. Note here that since each node stage and tumor stage have sub classifications they will be grouped together, otherwise there will be too many variables with few points. We will also subselect specific tumor stages for TCGA and SCANB, since there are very few patients with tumor stage 4.</p>
<p>To be very specific in the survival analysis, only endocrine treated patients should be used in the analysis, as that is what are interested in. METABRIC and SCANB has this kind of annotation, but TCGA not. So the survival analysis on SCANB and METABRIC will be performed on endocrine only treated, ER+ BC patients. On TCGA, to mitigate this effect, we subselect only luminal A and B patients, and we keep in mind that they might have been treated with chemotherapy as well. Moreover, in Sweden the guidelines for BC treatment is to use 10% as the threshold for ER status. Therefore, ER+ BC patients used on SCANB are those that are above the 10% threshold.</p>
<p>The table below shows the number of patients for each cohort.</p>
<div class="cell">
<div class="cell-output-display">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">cohort</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">number_patients</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">nb_events</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">TCGA</td>
<td style="text-align: right;">684</td>
<td style="text-align: right;">73</td>
</tr>
<tr class="even">
<td style="text-align: left;">SCANB</td>
<td style="text-align: right;">3603</td>
<td style="text-align: right;">637</td>
</tr>
<tr class="odd">
<td style="text-align: left;">METABRIC</td>
<td style="text-align: right;">934</td>
<td style="text-align: right;">573</td>
</tr>
<tr class="even">
<td style="text-align: left;">SCANB High ER</td>
<td style="text-align: right;">2860</td>
<td style="text-align: right;">454</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SCANB Low ER</td>
<td style="text-align: right;">228</td>
<td style="text-align: right;">43</td>
</tr>
<tr class="even">
<td style="text-align: left;">SCANB High ESR1</td>
<td style="text-align: right;">486</td>
<td style="text-align: right;">111</td>
</tr>
<tr class="odd">
<td style="text-align: left;">METABRIC High ESR1</td>
<td style="text-align: right;">254</td>
<td style="text-align: right;">175</td>
</tr>
</tbody>
</table>


</div>
</div>
<section id="results" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="results"><span class="header-section-number">1.4.1</span> Results</h3>
<p>The table below shows the results for each analysis performed for a specific term. In order to understand the table the user can filter based on the term, cohort and type of analysis. Since METABRIC has recurrence free survival (RFS) and overall survival (OS), the results for both analysis are presented here.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-e2309e7a4261cac76174" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-e2309e7a4261cac76174">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.115809878504831\" data-max=\"0.614740958536308\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.130685838844551\" data-max=\"0.737296332838902\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"-8.34713132031964\" data-max=\"-1.97093647428203\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"0.048731142467473\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.052525473940036\" data-max=\"0.471765924783858\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.242371171790281\" data-max=\"0.991942659343702\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.115809878504831\" data-max=\"0.614740958536308\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10"],["os","os","os","os","os","os","rfs","rfs","rfs","rfs"],["tcga","tcga","scanb","scanb","metabric","metabric","scanb","scanb","metabric","metabric"],["HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR"],["HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR"],[0.233829225703695,0.230338944922228,0.547074281580645,0.478672855565508,0.5584385300696471,0.6147409585363079,0.115809878504831,0.156892795460244,0.430913702461177,0.45293441930167],[0.7372963328389019,0.39763624663053,0.239689821888115,0.130685838844551,0.240219789131416,0.135062702694086,0.403401085182645,0.22189569892401,0.292397620536938,0.163586330692911],[-1.97093647428203,-3.69232783408581,-2.51646349808287,-5.63747300537742,-2.42532362208777,-3.60243276518523,-5.34407439657933,-8.34713132031964,-2.87911862514004,-4.84152881465094],[0.0487311424674724,0.000222210765540212,0.0118539178303981,1.72563644993162e-08,0.0152947457514795,0.000315252955042664,9.08802388838188e-08,6.99409389787678e-17,0.00398788301018185,1.28843987757473e-06],[0.0551202292573695,0.105657124357175,0.341996729098428,0.370509043329945,0.348738519932462,0.471765924783858,0.0525254739400364,0.101560548993959,0.242941102721224,0.328692948822314],[0.991942659343702,0.502152882455225,0.87512611701278,0.618413252739949,0.894233283798828,0.801046506856718,0.255341398244494,0.242371171790281,0.764327719306833,0.624137478224522],[0.233829225703695,0.230338944922228,0.547074281580645,0.478672855565508,0.5584385300696471,0.6147409585363079,0.115809878504831,0.156892795460244,0.430913702461177,0.45293441930167]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>type_analysis<\/th>\n      <th>cohort<\/th>\n      <th>score<\/th>\n      <th>term<\/th>\n      <th>estimate<\/th>\n      <th>std.error<\/th>\n      <th>statistic<\/th>\n      <th>p.value<\/th>\n      <th>conf.low<\/th>\n      <th>conf.high<\/th>\n      <th>HR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"targets":8,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":6,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":7,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":11,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render","options.columnDefs.4.render"],"jsHooks":[]}</script>
</div>
</div>
<p>The table above shows that <span class="math inline">\(SET_{ER/PR}\)</span> had a small hazard ratio (&lt; 1) in all 4 analysis performed. Moreover, for all cases where a measure of estrogen signaling was used, the hazard ratio was below 1, indicating that the higher the score, the less likely the patient is to suffer the event in a specific timepoint. This indicates that ER signaling is actually something continuous and not dichotomous.</p>
<p><a href="#fig-forest-plot">Figure&nbsp;<span>1.11</span></a> shows the forest plot of HALLMARK_ESTROGEN_RESPONSE_EARLY for all three cohorts.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-forest-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-forest-plot-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.11: Forest plots of the different cohorts and their hazard ratios. The bars correspond to 95% confidence interval.</figcaption>
</figure>
</div>
</div>
</div>
<p>The hazard ratios are all below 1 and small for HALLMARK_ESTROGEN_RESPONSE_EARLY. The variability changes depending on the cohort, specially because they have different follow-up times, SCANB being the shortest. TCGA has very few number of events and we could not select based on the treatment, the results for TCGA are less reliable.</p>
<p>Below we show the results for recurrence free survival.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-forest-plot-rfs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-forest-plot-rfs-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.12: Forest plots of the different cohorts and their hazard ratios. The bars correspond to 95% confidence interval.</figcaption>
</figure>
</div>
</div>
</div>
<p>And <a href="#fig-surv-all-cohorts">Figure&nbsp;<span>1.13</span></a> is a different way of display the same results but only including the hazard ratios of the variables of interest.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-surv-all-cohorts" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-surv-all-cohorts-1.png" class="img-fluid figure-img" width="1152"></p>
<figcaption class="figure-caption">Figure&nbsp;1.13: Hazard ratios for estrogen early and SET ER/PR for all the three cohorts of only endocrine treated patients with ER+ BC.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="comparison-of-er-ihc-and-molecular-er-signaling" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="comparison-of-er-ihc-and-molecular-er-signaling"><span class="header-section-number">1.5</span> Comparison of ER IHC and molecular ER signaling</h2>
<p>The new released dataset from the SCANB consortium contains the ER percentage based on the IHC stainings. This is great, because we can now compare the molecular ER signaling score to what is seen in the clinics.</p>
<p>First we start by comparing the molecular score with the percentages (<a href="#fig-cor-ihc-rna">Figure&nbsp;<span>1.14</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-cor-ihc-rna" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-cor-ihc-rna-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;1.14: Correlation between ER IHC percentage and molecular ER signaling by using the signature HALLMARK_ESTROGEN_RESPONSE_EARLY and SET ER/PR.</figcaption>
</figure>
</div>
</div>
</div>
<p>The first thing that one can notice is that ER percentage is very discrete, pathologists probably don’t assign non rounded percentage values, which makes sense. Another thing to notice is that for high ER percentage patients you have a whole spectrum of molecular ER signaling score.</p>
<p>The spearman correlation for Estrogen early and ER IHC is:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  df_wide$ER.pct and df_wide$HALLMARK_ESTROGEN_RESPONSE_EARLY
S = 3.9144e+10, p-value &lt; 2.2e-16
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.3925207 </code></pre>
</div>
</div>
<p>For SET ER/PR is:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  df_wide$ER.pct and df_wide$SET_ERPR
S = 3.1292e+10, p-value &lt; 2.2e-16
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.5143766 </code></pre>
</div>
</div>
<p>And finally for log(ESR1) is:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Spearman's rank correlation rho

data:  df_wide$ER.pct and df_wide$`log2(ESR1)`
S = 2.7133e+10, p-value &lt; 2.2e-16
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.5789259 </code></pre>
</div>
</div>
<p>Now we look speficially at the high ER percentage patients and compare their ER signaling scores. We previously saw that the distribution of these scores seems to be wide.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-high-er" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-high-er-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.15: Scores for high ER percentage breast cancer patients.</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-scores-high-er">Figure&nbsp;<span>1.15</span></a> shows how the distributions are not skewed towards high values only. It looks like there is a step in the SET ER/PR signature, we now compare with the ESR1 values and hallmark estrogen response early.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-seter-others" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-seter-others-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;1.16: Correlation between SET ER/PR and other scores.</figcaption>
</figure>
</div>
</div>
</div>
<p>There is a highly positive correlation. Also interesting to see that ESR1 levels are not necessarily highly correlated with high SET ER/PR scores. Remember that for ESR1 the scale is logarithmic, so even if the slope is smaller than in the hallmark estrogen response early, it might mean a higher correlation even..</p>
<p><a href="#fig-er-hist">Figure&nbsp;<span>1.17</span></a> shows the distribution of the ER IHC percentage for the patients used in the previous survival analysis for SCANB.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-hist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-hist-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.17: Histogram of ER IHC percentage of the SCANB samples used for survival analysis</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that the majority of the patients actually have already pretty high percentage. It could be that the results of the overall survival analysis are actually driven by the the low ER percentage patients, so we performed the survival analysis only on patients with ER percentage equal or higher than 90%. The table below shows the total number of patients for each analysis.</p>
<div class="cell">
<div class="cell-output-display">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">cohort</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">number_patients</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">nb_events</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">TCGA</td>
<td style="text-align: right;">684</td>
<td style="text-align: right;">73</td>
</tr>
<tr class="even">
<td style="text-align: left;">SCANB</td>
<td style="text-align: right;">3603</td>
<td style="text-align: right;">637</td>
</tr>
<tr class="odd">
<td style="text-align: left;">METABRIC</td>
<td style="text-align: right;">934</td>
<td style="text-align: right;">573</td>
</tr>
<tr class="even">
<td style="text-align: left;">SCANB High ER</td>
<td style="text-align: right;">2860</td>
<td style="text-align: right;">454</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SCANB Low ER</td>
<td style="text-align: right;">228</td>
<td style="text-align: right;">43</td>
</tr>
<tr class="even">
<td style="text-align: left;">SCANB High ESR1</td>
<td style="text-align: right;">486</td>
<td style="text-align: right;">111</td>
</tr>
<tr class="odd">
<td style="text-align: left;">METABRIC High ESR1</td>
<td style="text-align: right;">254</td>
<td style="text-align: right;">175</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>There was a decrease of around 200 patients with 80 events less, so indeed a lot of those patients with lower ER percentage had died. <a href="#fig-er-ihc-survival">Figure&nbsp;<span>1.18</span></a> shows the results of the survival analysis when considering the ER IHC percentage as a continuous score on SCANB.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-survival" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-survival-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.18: Survival analysis using ER IHC percentage as the score instead of the common molecular ER signaling scores</figcaption>
</figure>
</div>
</div>
</div>
<p>We a very tight confidence interval in this case with a HR very close to 1, meaning that for every 1% increase there is a 2% decrease in your risk of dying. The table with the values is shown below.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-b6c20fd6aea3c0e92c5d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-b6c20fd6aea3c0e92c5d">{"x":{"filter":"none","vertical":false,"data":[["1","2"],["os","rfs"],["scanb","scanb"],["ER.pct","ER.pct"],["ER.pct","ER.pct"],[0.986993674421427,0.979050070922542],[0.00382339569773735,0.00509066313308464],[-3.42408934318182,-4.15908345123801],[0.000616863371453935,3.19527153906888e-05],[0.97962506590869,0.969330153737092],[0.99441770862028,0.988867454167135],[0.986993674421427,0.979050070922542]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>type_analysis<\/th>\n      <th>cohort<\/th>\n      <th>score<\/th>\n      <th>term<\/th>\n      <th>estimate<\/th>\n      <th>std.error<\/th>\n      <th>statistic<\/th>\n      <th>p.value<\/th>\n      <th>conf.low<\/th>\n      <th>conf.high<\/th>\n      <th>HR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":6,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":7,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":8,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":9,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":10,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":11,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render","options.columnDefs.4.render","options.columnDefs.5.render","options.columnDefs.6.render"],"jsHooks":[]}</script>
</div>
</div>
<p>Next we selected only patients that had 90% or more ER IHC percentage to perform the survival analysis. <a href="#fig-er-ihc-high-os">Figure&nbsp;<span>1.19</span></a> shows the results for both the analysis done on ER IHC percentage,<br>
HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-high-os" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-high-os-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.19: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with 90% or more in the ER IHC were selected.</figcaption>
</figure>
</div>
</div>
</div>
<p>When performing the survival analysis among the high ER percentage, there is no evidence to differentiate between 90 to 100%, but by using the molecular scores that fact is still true, showing that perhaps the molecular score could be more sensitive for these patients.</p>
<p>We can also analyse the recurrence free survival for this cohort (<a href="#fig-er-ihc-high-rfs">Figure&nbsp;<span>1.20</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-high-rfs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-high-rfs-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.20: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with 90% or more in the ER IHC were selected.</figcaption>
</figure>
</div>
</div>
</div>
<p>The problem now is that the number of events is much smaller, so the confidence intervals for the estimates will be bigger. We see that for both signatures the HR is way below 1, meaning that the higher the score the better it is for the patient. Also the hazard ratio decreased in this case.</p>
<p>Another way of visualizing as previously is shown below (<a href="#fig-surv-high-er-ihc-ggplot2">Figure&nbsp;<span>1.21</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-surv-high-er-ihc-ggplot2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-surv-high-er-ihc-ggplot2-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.21: Hazard ratios for estrogen early and SET ER/PR for all the three cohorts of only endocrine treated patients with ER+ BC.</figcaption>
</figure>
</div>
</div>
</div>
<p>To further validate the ER signaling we partitionate the score in 4 different categories, low, intermediate, high, ultra high and perform the OS and RFS analysis.</p>
<p>For SET ER/PR the results are:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = Surv(rfs_months, rfs_status) ~ sig_dich + 
    age + node_stage + tumor_stage, data = df)

                                coef exp(coef) se(coef)      z        p
sig_dichhighERIHC_highERsig -0.90766   0.40347  0.16258 -5.583 2.37e-08
sig_dichlowERIHC_lowERsig    0.24354   1.27575  0.27791  0.876  0.38085
sig_dichlowERIHC_highERsig  -0.90197   0.40577  0.46417 -1.943  0.05199
age                          0.02194   1.02218  0.00751  2.921  0.00349
node_stageN1                -0.50780   0.60182  0.20628 -2.462  0.01383
node_stageN2and3             0.94017   2.56042  0.23470  4.006 6.18e-05
tumor_stageT2                0.90454   2.47079  0.16690  5.420 5.97e-08
tumor_stageT3                0.80154   2.22898  0.37765  2.122  0.03380

Likelihood ratio test=133  on 8 df, p=&lt; 2.2e-16
n= 2246, number of events= 174 
   (1357 observations deleted due to missingness)</code></pre>
</div>
</div>
<p>For Estrogen early the results are:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = Surv(rfs_months, rfs_status) ~ sig_dich + 
    age + node_stage + tumor_stage, data = df)

                                 coef exp(coef)  se(coef)      z        p
sig_dichhighERIHC_highERsig -0.566434  0.567546  0.163076 -3.473 0.000514
sig_dichlowERIHC_lowERsig    0.731154  2.077477  0.279781  2.613 0.008967
sig_dichlowERIHC_highERsig  -0.969188  0.379391  0.467623 -2.073 0.038211
age                          0.021284  1.021512  0.007516  2.832 0.004627
node_stageN1                -0.478136  0.619938  0.207097 -2.309 0.020957
node_stageN2and3             0.919321  2.507586  0.237012  3.879 0.000105
tumor_stageT2                0.901724  2.463846  0.167396  5.387 7.17e-08
tumor_stageT3                0.924196  2.519843  0.373852  2.472 0.013432

Likelihood ratio test=121.7  on 8 df, p=&lt; 2.2e-16
n= 2246, number of events= 174 
   (1357 observations deleted due to missingness)</code></pre>
</div>
</div>
<p>High ER sig and high ER IHC have a better outcome than high ER IHC and low ER sig for both signatures.</p>
<p>The table below shows the number of RFS events for each subgroup in the SET ER/PR dichotomization procedure.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>                         rfs_status                                         
            sig_dich              1           2          NA_           Total
  highERIHC_lowERsig 61.51%   (569)  8.86% (82) 29.62% (274) 100.00%   (925)
 highERIHC_highERsig 70.03% (1,355)  3.82% (74) 26.15% (506) 100.00% (1,935)
   lowERIHC_lowERsig 67.46%    (85) 12.70% (16) 19.84%  (25) 100.00%   (126)
  lowERIHC_highERsig 72.55%    (74)  4.90%  (5) 22.55%  (23) 100.00%   (102)
                &lt;NA&gt; 91.46%   (471)  6.41% (33)  2.14%  (11) 100.00%   (515)</code></pre>
</div>
</div>
<p>Next we show the Kaplan Meier estimate curves for both signatures.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-km-seterpr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-km-seterpr-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;1.22: Kaplan-Meier estimate of the categorized SET ER/PR signature</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-km-er-early" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-km-er-early-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;1.23: Kaplan-Meier estimate of the categorized Estrogen early signature</figcaption>
</figure>
</div>
</div>
</div>
<p>In both cases there is a good distinction between low ER sig/High ER IHC and High ER sig/Low ER IHC. Interestingly, there the worst group is really the low ER sig/low ER IHC, as expected.</p>
<p>We now evaluate the protective effect of the estrogen signaling signatures in the patients that have tumors with ER IHC lower than 90%.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-low-rfs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-low-rfs-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.24: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with less than 90% in the ER IHC were selected.</figcaption>
</figure>
</div>
</div>
</div>
<p>The number of patients now is very low, but the effect is still there. When we look at the survival. Below we show the results for the overall survival.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-low-os" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-low-os-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.25: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with less than 90% in the ER IHC were selected.</figcaption>
</figure>
</div>
</div>
</div>
<p>The hazard ratio is still below 1 but the uncertainty is much higher, probably due to the number of patients and events.</p>
<p>Another way of evaluating the effect of estrogen signaling and not only the presence of the estrogen receptor protein or the mRNA transcripts, is to check the patients whose tumor samples have high expression of ESR1. We can perform such analysis in both METABRIC and SCANB.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-highesr1-rfs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-highesr1-rfs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.26: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with more than 7.5 units of ESR1 in the logFPKM scale were selected.</figcaption>
</figure>
</div>
</div>
</div>
<p>The number of events is very small but the HR is very small also and confidence interval is far away from 1. And now for METABRIC when we select all patients of 3rd quantile and above (median intensity higher than 11.5).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-highesr1-rfs-metabric" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-highesr1-rfs-metabric-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;1.27: Survival analysis using HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with more than 11 units of ESR1 in the log median intensity scale were selected.</figcaption>
</figure>
</div>
</div>
</div>
<p>The variability is way higher but the hazard ratio is still below 1 as expected. In this case probably there are patients that have low score and don’t benefit as much from the treatment. <a href="#fig-er-signaling-highesr1-metabric">Figure&nbsp;<span>1.28</span></a> shows the distribution of ER signaling scores for those patients. We notice that the average is very close to the peak of the distributions.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-signaling-highesr1-metabric" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-signaling-highesr1-metabric-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.28: <strong>?(caption)</strong></figcaption>
</figure>
</div>
</div>
</div>
<p>And below for all patients used for the full analysis on METABRIC.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-signaling-all-metabric" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-signaling-all-metabric-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;1.29: <strong>?(caption)</strong></figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">1.6</span> Conclusion</h2>
<p>In this chapter we’ve shown that ER+ BC patients are very distinct from each other, as it can be seen from the umap projections and the subtypes. These patients might respond differently for endocrine therapy as well, and this might depend on the ER signaling, how active it is. Therefore, when deciding a treatment, more care should be taken with ER+ BC patients and check their signaling scores somehow. The <span class="math inline">\(SET_{ER/PR}\)</span> signature is a good signature showing very good hazard ratios across the different cohorts. This signature has also been validated on the clinics for use.</p>
<p>Knowing the ER signaling for a patient is very important when deciding treatment, but not enough. What could be other alternatives for patients that have low ER signaling and are still considered ER+? Should they use only endocrine therapy or supplement it with something else? In the next chapters we present a framework where we can take a look at a more personalised approach for treatments.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Cox1972" class="csl-entry" role="listitem">
Cox, D. R. 1972. <span>“Regression Models and Life-Tables.”</span> <em>Journal of the Royal Statistical Society: Series B (Methodological)</em> 34 (2): 187–202. <a href="https://doi.org/10.1111/j.2517-6161.1972.tb00899.x">https://doi.org/10.1111/j.2517-6161.1972.tb00899.x</a>.
</div>
<div id="ref-Gelman2020-uh" class="csl-entry" role="listitem">
Gelman, Andrew, Jennifer Hill, and Aki Vehtari. 2020. <em>Regression and Other Stories</em>. Analytical Methods for Social Research. Cambridge, England: Cambridge University Press.
</div>
<div id="ref-Hnzelmann2013" class="csl-entry" role="listitem">
Hänzelmann, Sonja, Robert Castelo, and Justin Guinney. 2013. <span>“<span>GSVA</span>: Gene Set Variation Analysis for Microarray and <span>RNA</span>-Seq Data.”</span> <em><span>BMC</span> Bioinformatics</em> 14 (1). <a href="https://doi.org/10.1186/1471-2105-14-7">https://doi.org/10.1186/1471-2105-14-7</a>.
</div>
<div id="ref-McElreath2020-jn" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical Rethinking</em>. 2nd ed. Chapman &amp; Hall/CRC Texts in Statistical Science. London, England: CRC Press.
</div>
<div id="ref-Sinn2019" class="csl-entry" role="listitem">
Sinn, Bruno V., Chunxiao Fu, Rosanna Lau, Jennifer Litton, Tsung-Heng Tsai, Rashmi Murthy, Alda Tam, et al. 2019. <span>“<span>SETER</span>/<span>PR</span>: A Robust 18-Gene Predictor for Sensitivity to Endocrine Therapy for Metastatic Breast Cancer.”</span> <em>Npj Breast Cancer</em> 5 (1). <a href="https://doi.org/10.1038/s41523-019-0111-0">https://doi.org/10.1038/s41523-019-0111-0</a>.
</div>
<div id="ref-Subramanian2005" class="csl-entry" role="listitem">
Subramanian, Aravind, Pablo Tamayo, Vamsi K. Mootha, Sayan Mukherjee, Benjamin L. Ebert, Michael A. Gillette, Amanda Paulovich, et al. 2005. <span>“Gene Set Enrichment Analysis: A Knowledge-Based Approach for Interpreting Genome-Wide Expression Profiles.”</span> <em>Proceedings of the National Academy of Sciences</em> 102 (43): 15545–50. <a href="https://doi.org/10.1073/pnas.0506580102">https://doi.org/10.1073/pnas.0506580102</a>.
</div>
</div>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./intro.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./pca_merging.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb9" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estrogen receptor status is continuous, not dichotomous</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>Currently in the clinics estrogen receptor (ER) status is treated </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>as dichotomous condition. Either a breast cancer (BC) is ER positive (ER+) or</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ER negative (ER-). The threshold for ER+ cells usually is 1% or 10% of the </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>cells positive in a IHC staining. The idea is that ER+ BC patients</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>will receive endocrine therapy, usually tamoxifen or some aromatase inhibitor,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>for treatment. The problem is not all patients respond the same to these</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>drugs and they also have different proportions of ER+ cells. </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>In this document we show how leveraging molecular information distinguishes</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>ER+ BC patients and how one should look more carefully on ER status. In order</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>to do this, estrogen related signatures: estrogen response early and late from</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>MSigDB<span class="co">[</span><span class="ot">@Subramanian2005</span><span class="co">]</span> and $SET_{ER/PR}$<span class="co">[</span><span class="ot">@Sinn2019</span><span class="co">]</span>, </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>are used to calculate scores for each</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>BC patient. These scores then are used to calculate associations with survival</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>analysis. When performing cox regression, we try to adjust for sensible </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>covariates in order to reduce bias. Even though we are adjusting, it is </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>very difficult to know if a covariate is missing in the regression. Thus,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>care should be always taken when interpreting these results.</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>This chapter is structure in the following way. First section corresponds</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>to loading the datasets and then filtering them. Estrogen signatures scores</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>are calculated using GSVA <span class="co">[</span><span class="ot">@Hnzelmann2013</span><span class="co">]</span>. Given the scores, cox regression</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>can be performed adjusting for clinical variables. After this the Hazard</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>ratios can be computed and interpreted along with their confidence</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>intervals.</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading and filtering the datasets</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>The preprocessing of the datasets is described in the website below:</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; https://chronchi.github.io/transcriptomics</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>To check the code used here either click in the code button on the top right</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>part of the page or check the github page </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>(github.com/chronchi/molecular_landscape).</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>The TCGA, METABRIC and SCANB cohorts are used in this section here. They</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>are the biggest cohort of Breast cancer patients in the world. Each datasets</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>has an overall equal distribution of ER+ and ER- patients and similar age</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>distribution. </span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># init renv due to docker installation</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>(<span class="at">prompt =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="co"># first load the packages</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forestplot)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplotify)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SummarizedExperiment)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(msigdbr)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GSVA)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(uwot)</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"first_run.R"</span>)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="co"># by setting the dev to png and pdf, this saves the figures in a specific</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="co"># folder in both formats. moreover, since png is coming first, it shows</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="co"># this figure when rendering the html. What is nice about this is that it</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="co"># inherits the properties from the chunk to save the figure, so no need</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="co"># to use ggplot2::ggsave to save the plots. this also works </span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="fu">c</span>(<span class="st">'png'</span>, <span class="st">'pdf'</span>, <span class="st">'svg'</span>))</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">bitmapType =</span> <span class="st">'cairo'</span>)</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="co"># load the different datasets. we will do the analysis </span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="co"># and save the intermediate results so loading all the dataset again</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a><span class="co"># is not necessary</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/tcga_brca_tumor_filtered.rds"</span>)</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/metabric_filtered_complete.rds"</span>)</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/scanb_2022/scanb_sumexp.rds"</span>)</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="co"># we want to have common variables across datasets. so for tcga</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a><span class="co"># we convert the ensembl ids to gene symbol in the rownames,</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a><span class="co"># for scanb and metabric we perform a heavier filtering as well.</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="co"># also for the clinical data we want to have common column names,</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a><span class="co"># such as for pam50, events, time to event, tumor stage,</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="co"># tumor grade and others.</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="co"># first convert ensembl to symbol. this information is readily available</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="co"># from the tcga filtered data. we just need to remove duplicated symbols</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a><span class="co"># first.</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>symbol_names <span class="ot">&lt;-</span> <span class="fu">mcols</span>(<span class="fu">rowRanges</span>(tcga)) <span class="sc">%&gt;%</span> </span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(external_gene_name))</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> tcga[symbol_names<span class="sc">$</span>ensembl_gene_id, ]</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tcga) <span class="ot">&lt;-</span> symbol_names<span class="sc">$</span>external_gene_name</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>fpkm_tcga <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span><span class="fu">assay</span>(tcga, <span class="st">"logFPKM_TMM"</span>)</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>prop_expressed <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(fpkm_tcga <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>genes_to_keep <span class="ot">&lt;-</span> prop_expressed <span class="sc">&gt;</span> <span class="fl">0.5</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> tcga[genes_to_keep, ]</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a><span class="co"># we now filter down the list of genes from metabric and scanb.</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a><span class="co"># remove first genes with na in the table</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">assay</span>(metabric, <span class="st">"median_intensity"</span>) <span class="sc">&gt;</span> <span class="fl">5.5</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> keep_genes <span class="sc">&gt;</span> <span class="fl">0.7</span> <span class="sc">%&gt;%</span> unname <span class="sc">%&gt;%</span> unlist</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(keep_genes))</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[<span class="sc">-</span>keep_genes, ]</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a><span class="co"># now remove genes with low expression across samples</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">assay</span>(metabric, <span class="st">"median_intensity"</span>) <span class="sc">&gt;</span> <span class="fl">5.5</span>)</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> keep_genes <span class="sc">&gt;</span> <span class="fl">0.7</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[keep_genes, ]</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a><span class="co"># convert back to non log values and then filter.</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a><span class="fu">assay</span>(scanb, <span class="st">"logFPKM"</span>) <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">assay</span>(scanb) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">base =</span> <span class="dv">2</span>)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>fpkm_scanb <span class="ot">&lt;-</span> <span class="fu">assay</span>(scanb, <span class="st">"FPKM"</span>)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>prop_expressed <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(fpkm_scanb <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>genes_to_keep <span class="ot">&lt;-</span> prop_expressed <span class="sc">&gt;</span> <span class="fl">0.8</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> scanb[genes_to_keep, ]</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>esr1_levels <span class="ot">&lt;-</span> <span class="fu">assay</span>(scanb, <span class="st">"logFPKM"</span>)[<span class="st">"ESR1"</span>, ]</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a><span class="co"># we now convert the clinical data to some common names and values</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> tcga[, tcga<span class="sc">$</span>er_status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Positive"</span>, <span class="st">"Negative"</span>)]</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>er_status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Positive"</span> <span class="ot">=</span> <span class="st">"pos"</span>, <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"neg"</span>)[tcga<span class="sc">$</span>er_status]</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">tolower</span>(tcga<span class="sc">$</span>molecular_subtype)</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>levels_order_pam50 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"lumb"</span>, <span class="st">"luma"</span>, <span class="st">"normal"</span>, <span class="st">"claudin-low"</span>)</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">factor</span>(tcga<span class="sc">$</span>pam50, <span class="at">levels =</span> levels_order_pam50)</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>os_days <span class="ot">&lt;-</span> tcga<span class="sc">$</span>time</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>os_months <span class="ot">&lt;-</span> tcga<span class="sc">$</span>os_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>os_status <span class="ot">&lt;-</span> tcga<span class="sc">$</span>status</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>tumor_stage <span class="ot">&lt;-</span> <span class="fu">tolower</span>(tcga<span class="sc">$</span>paper_pathologic_stage)</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>age <span class="ot">&lt;-</span> tcga<span class="sc">$</span>age_at_index</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(tcga)</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>node_stage <span class="ot">&lt;-</span> tcga<span class="sc">$</span>ajcc_pathologic_n</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>node_stage <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"^N0"</span>, node_stage),</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N0"</span>,</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grepl</span>(<span class="st">"^N1"</span>, node_stage),</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N1"</span>,</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>            <span class="fu">grepl</span>(<span class="st">"^N2"</span>, node_stage),</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>            <span class="st">"N2"</span>,</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>                <span class="fu">grepl</span>(<span class="st">"^N3"</span>, node_stage),</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>                <span class="st">"N3"</span>,</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>                <span class="st">"NX"</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>            ) </span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[, metabric<span class="sc">$</span>ER_IHC <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Positve"</span>, <span class="st">"Negative"</span>)]</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>er_status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Positve"</span> <span class="ot">=</span> <span class="st">"pos"</span>, <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"neg"</span>)[metabric<span class="sc">$</span>ER_IHC]</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">tolower</span>(metabric<span class="sc">$</span>CLAUDIN_SUBTYPE)</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[, metabric<span class="sc">$</span>pam50 <span class="sc">!=</span> <span class="st">"nc"</span>]</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">factor</span>(metabric<span class="sc">$</span>pam50, <span class="at">levels =</span> levels_order_pam50)</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>os_months <span class="ot">&lt;-</span> metabric<span class="sc">$</span>OS_MONTHS</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>rfs_months <span class="ot">&lt;-</span> metabric<span class="sc">$</span>RFS_MONTHS</span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>os_status <span class="ot">&lt;-</span> <span class="fu">substr</span>(metabric<span class="sc">$</span>OS_STATUS, <span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>os_status <span class="ot">&lt;-</span> metabric<span class="sc">$</span>os_status <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> <span class="fu">substr</span>(metabric<span class="sc">$</span>RFS_STATUS, <span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> metabric<span class="sc">$</span>rfs_status <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>age <span class="ot">&lt;-</span> metabric<span class="sc">$</span>AGE_AT_DIAGNOSIS</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>npi <span class="ot">&lt;-</span> metabric<span class="sc">$</span>NPI </span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>NPI <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(metabric)</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> scanb[, scanb<span class="sc">$</span>ER <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Negative"</span>, <span class="st">"Positive"</span>)]</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>er_status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Positive"</span> <span class="ot">=</span> <span class="st">"pos"</span>, <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"neg"</span>)[scanb<span class="sc">$</span>ER]</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">tolower</span>(scanb<span class="sc">$</span>SSP.PAM50)</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">factor</span>(scanb<span class="sc">$</span>pam50, <span class="at">levels =</span> levels_order_pam50)</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>nhg <span class="ot">&lt;-</span> scanb<span class="sc">$</span>NHG</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>NHG <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>age <span class="ot">&lt;-</span> scanb<span class="sc">$</span>Age..<span class="fl">5.</span>year.range..e.g...<span class="dv">35</span>.<span class="dv">31</span>.<span class="dv">35</span>...<span class="dv">40</span>.<span class="dv">36</span>.<span class="dv">40</span>...<span class="dv">45</span>.<span class="dv">41</span>.<span class="dv">45</span>..etc..</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>os_months <span class="ot">&lt;-</span> scanb<span class="sc">$</span>OS_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>os_status <span class="ot">&lt;-</span> scanb<span class="sc">$</span>OS_event <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> scanb<span class="sc">$</span>RFi_event <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>rfs_months <span class="ot">&lt;-</span> scanb<span class="sc">$</span>RFi_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>drfs_status <span class="ot">&lt;-</span> scanb<span class="sc">$</span>DRFi_event <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>drfs_months <span class="ot">&lt;-</span> scanb<span class="sc">$</span>DRFi_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>tumor_size <span class="ot">&lt;-</span> scanb<span class="sc">$</span>Size.mm</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>tumor_stage <span class="ot">&lt;-</span> scanb<span class="sc">$</span>pT</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>tumor_stage <span class="ot">&lt;-</span> <span class="fu">colData</span>(scanb) <span class="sc">%&gt;%</span></span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tumor_stage =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(tumor_stage, <span class="st">"^T1"</span>) <span class="sc">~</span> <span class="st">"T1"</span>,</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(tumor_stage, <span class="st">"^T2"</span>) <span class="sc">~</span> <span class="st">"T2"</span>,</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(tumor_stage, <span class="st">"^T3"</span>) <span class="sc">~</span> <span class="st">"T3"</span></span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(tumor_stage)</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>node_group <span class="ot">&lt;-</span> scanb<span class="sc">$</span>LN.spec</span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>LN.spec <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(scanb)</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>node_stage <span class="ot">&lt;-</span> scanb<span class="sc">$</span>node_group</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>node_stage <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"1to3"</span>, node_stage),</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N1"</span>,</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(</span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grepl</span>(<span class="st">"4toX"</span>, node_stage),</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N2and3"</span>,</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>            <span class="fu">grepl</span>(<span class="st">"N0"</span>, node_stage),</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>            <span class="st">"N0"</span>,</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NX"</span></span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">tcga =</span> tcga, <span class="at">scanb =</span> scanb, <span class="at">metabric =</span> metabric),</span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets.rds"</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>which_exp <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"logFPKM_TMM"</span>,</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"logFPKM"</span>,</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"median_intensity"</span></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>    which_exp,</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/which_exp.rds"</span></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../results/rds_files/surv_analysis_estrogen/datasets.rds"</span>)</span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a><span class="co"># these are some global parameters for each dataset. important for</span></span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a><span class="co"># when calculating scores and embeddings.</span></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>which_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../results/rds_files/surv_analysis_estrogen/which_exp.rds"</span>)</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a><span class="fu">## UMAP projection of the datasets</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>The plots below show how each patient is different in a molecular sense, </span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>and even inside each molecular subtype there are some differences. This</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>indicates how different patients, at least molecularly. We only do the umap</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>of samples that have a PAM50 molecular subtype assigned.</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a><span class="co"># first one uses the library uwot to calculate the umap projection.</span></span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a><span class="co"># using uwot is better than umap as it allows you to make parallel computations</span></span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a><span class="co"># in a reproducible way.</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>umap_projections <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(dataset, name_assay){</span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Assay being used:"</span>, name_assay, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a>        samples_to_use <span class="ot">&lt;-</span> <span class="fu">colData</span>(dataset) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">%in%</span> </span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(<span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"luma"</span>, <span class="st">"lumb"</span>, <span class="st">"normal"</span>)</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a>        <span class="co"># select most variable genes first</span></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">assay</span>(dataset[, samples_to_use], name_assay) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> df[<span class="fu">order</span>(<span class="fu">rowVars</span>(df), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>], ]</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">t</span>(df)</span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>        uwot<span class="sc">::</span><span class="fu">umap</span>(</span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a>            df,</span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_threads =</span> <span class="dv">20</span>,</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_sgd_threads =</span> <span class="st">"auto"</span>, </span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>            <span class="at">batch =</span> <span class="cn">TRUE</span></span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a>    which_exp,</span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>    umap_projections, </span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/umap_projections.rds"</span></span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>umap_projections <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/umap_projections.rds"</span></span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=20}</span></span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-surv-umap-all</span></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: UMAP projections of all three cohorts in the following order":" </span></span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a><span class="co">#|     TCGA, SCANB and METABRIC. They are colored by the PAM50</span></span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a><span class="co">#|     molecular subtype.</span></span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>plots_umap <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>    plot_umap,</span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets,</span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>    <span class="at">umap_projection =</span> umap_projections,</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="fu">names</span>(datasets),</span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">color_by =</span> <span class="st">"pam50"</span>, <span class="at">point_size =</span> <span class="dv">2</span>, <span class="at">base_size =</span> <span class="dv">20</span>),</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plots_umap, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>width_plot <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>height_plot <span class="ot">&lt;-</span> width_plot<span class="sc">/</span><span class="fl">1.6</span></span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/plots/surv_analysis_estrogen/umap/"</span>, </span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>    ggsave,</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> plots_umap,</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>        <span class="st">"../results/plots/surv_analysis_estrogen/umap/"</span>,</span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(plots_umap),</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>        <span class="st">".pdf"</span></span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">width =</span> width_plot, <span class="at">height =</span> height_plot)</span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>From the plots above we see a distinction of the different molecular subtypes.</span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a><span class="fu">## Calculating scores</span></span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a>In order to calculate the scores, the package <span class="in">`msigdb`</span> is used to load</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a>the hallmark data into R. The $SET_{ER/PR}$ is made of the following genes:</span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a><span class="co"># data is available in the supplementary material of the paper </span></span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a>seterpr <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"../data/seterpr.tsv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a>seterpr<span class="sc">$</span>is_target <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"yes"</span>, <span class="dv">18</span>), <span class="fu">rep</span>(<span class="st">"no"</span>, <span class="dv">10</span>))</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a>seterpr <span class="sc">%&gt;%</span> kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a>The first 18 genes are considered to be the target genes, the last 10 genes</span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a>are the genes used for reference. According to their paper, the score is </span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a>calculated in the following way:</span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a>SET_{ER/PR} = \sum_{i = 1}^{18} \frac{T_i}{18} - \sum_{j=1}^{10}\frac{R_j}{10} + 2</span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>Where $T_i$ are the expression levels of target genes and $R_j$ are the</span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a>expression levels of the reference genes. Here we use GSVA to calculate</span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a>the scores, even when using their genes. </span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a>all_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(datasets, rownames) <span class="sc">%&gt;%</span> unlist <span class="sc">%&gt;%</span> unique</span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a><span class="co"># now load the msigdbr and concatenate with set erpr</span></span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> msigdbr<span class="sc">::</span><span class="fu">msigdbr</span>(<span class="at">species =</span> <span class="st">"Homo sapiens"</span>, <span class="at">category =</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(gs_name, gene_symbol) <span class="sc">%&gt;%</span></span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>        seterpr <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_target <span class="sc">==</span> <span class="st">"yes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">gene_symbol =</span> ID) <span class="sc">%&gt;%</span></span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">gs_name =</span> <span class="st">"SET_ERPR"</span>)</span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">gene_symbol =</span> <span class="fu">sample</span>(all_genes, <span class="dv">200</span>), <span class="at">gs_name =</span> <span class="st">"random_200"</span>)</span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">gene_symbol =</span> <span class="fu">sample</span>(all_genes, <span class="dv">18</span>), <span class="at">gs_name =</span> <span class="st">"random_18"</span>)</span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gene_sets, <span class="st">"../results/rds_files/surv_analysis_estrogen/gene_sets.rds"</span>)</span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a>Before we calculate any score, let us check the number of genes available</span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a>for each pathway in each dataset. This is important, in other to have</span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a>robust scores, most of the genes should be available in the datasets. We also</span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a>add signatures of 18 and 200 random genes for control. </span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../results/rds_files/surv_analysis_estrogen/gene_sets.rds"</span>)</span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>genes_each_dataset <span class="ot">&lt;-</span> <span class="fu">lapply</span>(datasets, rownames)</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a>genes_intersection <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a>    gene_sets<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique,</span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(set_name, gene_sets, genes_each_dataset){</span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a>            genes_each_dataset,</span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a>            intersect,</span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> gene_sets <span class="sc">%&gt;%</span> </span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">==</span> set_name) <span class="sc">%&gt;%</span></span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">pull</span>(gene_symbol)</span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets,</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes_each_dataset =</span> genes_each_dataset,</span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(genes_intersection, <span class="cf">function</span>(x) <span class="fu">sapply</span>(x, length)) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span></span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"pathway"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a>        gene_sets <span class="sc">%&gt;%</span> </span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(gs_name) <span class="sc">%&gt;%</span></span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">pathway =</span> gs_name),</span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"pathway"</span></span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">average_percentage =</span> <span class="fu">format</span>(<span class="fu">mean</span>(</span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(tcga<span class="sc">/</span>n, scanb<span class="sc">/</span>n, metabric<span class="sc">/</span>n)</span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a>Most of the genes are available in all datasets. When calculating scores</span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a>it is always good to check the availability of the genes. Otherwise this</span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a>can make the score unstable, since too many of the genes are missing. </span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a>For example, </span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a>HALLMARK_PANCREAS_BETA_CELLS might have an unstable score, due to a lot </span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a>of genes missing. </span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a>which_exp <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"logFPKM_TMM"</span>,</span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"logFPKM"</span>,</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"median_intensity"</span></span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-452"><a href="#cb9-452" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true" tabindex="-1"></a>    gene_sets<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique,</span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, gene_sets) gene_sets <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(gene_symbol),</span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets,</span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a>gsva_scores <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(sum_exp, which_assay, gene_sets){</span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a>        GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a>            <span class="at">expr =</span> <span class="fu">as.matrix</span>(<span class="fu">assay</span>(sum_exp, which_assay)),</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a>            <span class="at">gset.idx.list =</span> gene_sets, </span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a>            <span class="at">parallel.sz =</span> <span class="dv">10</span></span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets,</span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_assay =</span> which_exp,</span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">gene_sets =</span> gene_sets),</span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span></span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(gsva_score, dataset){</span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(dataset)[, <span class="fu">rownames</span>(gsva_score)] <span class="ot">&lt;-</span> <span class="fu">t</span>(gsva_score)</span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a>        dataset</span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a>    gsva_scores,</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true" tabindex="-1"></a>    gsva_scores, </span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/gsva_scores.rds"</span></span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets_with_scores.rds"</span></span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true" tabindex="-1"></a>gsva_scores <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/gsva_scores.rds"</span></span>
<span id="cb9-503"><a href="#cb9-503" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-504"><a href="#cb9-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets_with_scores.rds"</span></span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true" tabindex="-1"></a>For each dataset one can plot the differences in scores for ER+ and ER- BC</span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true" tabindex="-1"></a>patients. This should be already an indication that the scores are meaningful.</span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true" tabindex="-1"></a>The next sections shows the results for each dataset individually.</span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true" tabindex="-1"></a>plot_scores <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true" tabindex="-1"></a>which_scores <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span>,</span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>,</span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span>,</span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span></span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a><span class="fu">### TCGA</span></span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"tcga"</span></span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> <span class="st">"er_status"</span>, </span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> <span class="st">"pam50"</span>,</span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-547"><a href="#cb9-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-548"><a href="#cb9-548" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-tcga</span></span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for TCGA patients</span></span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-558"><a href="#cb9-558" aria-hidden="true" tabindex="-1"></a><span class="fu">### METABRIC</span></span>
<span id="cb9-559"><a href="#cb9-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-562"><a href="#cb9-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-563"><a href="#cb9-563" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"metabric"</span></span>
<span id="cb9-564"><a href="#cb9-564" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> <span class="st">"er_status"</span>, </span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> <span class="st">"pam50"</span>,</span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb9-573"><a href="#cb9-573" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb9-574"><a href="#cb9-574" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-575"><a href="#cb9-575" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-576"><a href="#cb9-576" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-577"><a href="#cb9-577" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-578"><a href="#cb9-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-579"><a href="#cb9-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-580"><a href="#cb9-580" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb9-581"><a href="#cb9-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric</span></span>
<span id="cb9-582"><a href="#cb9-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for METABRIC patients</span></span>
<span id="cb9-583"><a href="#cb9-583" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-584"><a href="#cb9-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-585"><a href="#cb9-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-586"><a href="#cb9-586" aria-hidden="true" tabindex="-1"></a><span class="fu">### SCANB</span></span>
<span id="cb9-587"><a href="#cb9-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-590"><a href="#cb9-590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-591"><a href="#cb9-591" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"scanb"</span></span>
<span id="cb9-592"><a href="#cb9-592" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-593"><a href="#cb9-593" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb9-594"><a href="#cb9-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb9-595"><a href="#cb9-595" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb9-596"><a href="#cb9-596" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-597"><a href="#cb9-597" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb9-598"><a href="#cb9-598" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> <span class="st">"er_status"</span>, </span>
<span id="cb9-599"><a href="#cb9-599" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> <span class="st">"pam50"</span>,</span>
<span id="cb9-600"><a href="#cb9-600" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb9-601"><a href="#cb9-601" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb9-602"><a href="#cb9-602" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-603"><a href="#cb9-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-604"><a href="#cb9-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-605"><a href="#cb9-605" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-606"><a href="#cb9-606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-607"><a href="#cb9-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-608"><a href="#cb9-608" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb9-609"><a href="#cb9-609" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-scanb</span></span>
<span id="cb9-610"><a href="#cb9-610" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for SCANB patients</span></span>
<span id="cb9-611"><a href="#cb9-611" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-612"><a href="#cb9-612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-613"><a href="#cb9-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-614"><a href="#cb9-614" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-615"><a href="#cb9-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-616"><a href="#cb9-616" aria-hidden="true" tabindex="-1"></a>From the plots above one can conclude that three different estrogen pathways</span>
<span id="cb9-617"><a href="#cb9-617" aria-hidden="true" tabindex="-1"></a>capture the differences between ER status and also molecular subtypes.</span>
<span id="cb9-618"><a href="#cb9-618" aria-hidden="true" tabindex="-1"></a>There are two plots with random genes for control and we can see that</span>
<span id="cb9-619"><a href="#cb9-619" aria-hidden="true" tabindex="-1"></a>there is no difference between the ER status when using those gene sets.</span>
<span id="cb9-620"><a href="#cb9-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-621"><a href="#cb9-621" aria-hidden="true" tabindex="-1"></a>Below is a combined image for TCGA, SCANB and METABRIC using the $SET_{ER/PR}$</span>
<span id="cb9-622"><a href="#cb9-622" aria-hidden="true" tabindex="-1"></a>signature.</span>
<span id="cb9-623"><a href="#cb9-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-624"><a href="#cb9-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=10, fig.width = 6}</span></span>
<span id="cb9-625"><a href="#cb9-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric-tcga-scanb</span></span>
<span id="cb9-626"><a href="#cb9-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: SET ER/PR scores for all three cohorts.</span></span>
<span id="cb9-627"><a href="#cb9-627" aria-hidden="true" tabindex="-1"></a>pathway_to_get <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>)</span>
<span id="cb9-628"><a href="#cb9-628" aria-hidden="true" tabindex="-1"></a>cols_to_select <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pam50"</span>, <span class="st">"er_status"</span>, <span class="fu">names</span>(pathway_to_get))</span>
<span id="cb9-629"><a href="#cb9-629" aria-hidden="true" tabindex="-1"></a>selected_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb9-630"><a href="#cb9-630" aria-hidden="true" tabindex="-1"></a>    plot_scores,</span>
<span id="cb9-631"><a href="#cb9-631" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span>pluck,</span>
<span id="cb9-632"><a href="#cb9-632" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>, </span>
<span id="cb9-633"><a href="#cb9-633" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span></span>
<span id="cb9-634"><a href="#cb9-634" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-635"><a href="#cb9-635" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(., \(x) x[, cols_to_select]) <span class="sc">%&gt;%</span></span>
<span id="cb9-636"><a href="#cb9-636" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-637"><a href="#cb9-637" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">%in%</span> <span class="fu">levels</span>(pam50))</span>
<span id="cb9-638"><a href="#cb9-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-639"><a href="#cb9-639" aria-hidden="true" tabindex="-1"></a>selected_data <span class="sc">%&gt;%</span> </span>
<span id="cb9-640"><a href="#cb9-640" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-641"><a href="#cb9-641" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> er_status, </span>
<span id="cb9-642"><a href="#cb9-642" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">names</span>(pathway_to_get)),</span>
<span id="cb9-643"><a href="#cb9-643" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb9-644"><a href="#cb9-644" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb9-645"><a href="#cb9-645" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb9-646"><a href="#cb9-646" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb9-647"><a href="#cb9-647" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span><span class="fl">0.05</span>, </span>
<span id="cb9-648"><a href="#cb9-648" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb9-649"><a href="#cb9-649" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb9-650"><a href="#cb9-650" aria-hidden="true" tabindex="-1"></a>        <span class="at">outlier.shape =</span> <span class="cn">NA</span></span>
<span id="cb9-651"><a href="#cb9-651" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-652"><a href="#cb9-652" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb9-653"><a href="#cb9-653" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb9-654"><a href="#cb9-654" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span>cohort, </span>
<span id="cb9-655"><a href="#cb9-655" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb9-656"><a href="#cb9-656" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb9-657"><a href="#cb9-657" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tcga"</span> <span class="ot">=</span> <span class="st">"TCGA"</span>,</span>
<span id="cb9-658"><a href="#cb9-658" aria-hidden="true" tabindex="-1"></a>            <span class="st">"metabric"</span> <span class="ot">=</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb9-659"><a href="#cb9-659" aria-hidden="true" tabindex="-1"></a>            <span class="st">"scanb"</span> <span class="ot">=</span> <span class="st">"SCANB"</span></span>
<span id="cb9-660"><a href="#cb9-660" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb9-661"><a href="#cb9-661" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span> </span>
<span id="cb9-662"><a href="#cb9-662" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-663"><a href="#cb9-663" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER status"</span>,</span>
<span id="cb9-664"><a href="#cb9-664" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb9-665"><a href="#cb9-665" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"SET ER/PR score"</span>,</span>
<span id="cb9-666"><a href="#cb9-666" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(pathway_to_get[<span class="dv">1</span>], <span class="st">" scores by cohort"</span>)</span>
<span id="cb9-667"><a href="#cb9-667" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-668"><a href="#cb9-668" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb9-669"><a href="#cb9-669" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(selected_data)) <span class="sc">+</span></span>
<span id="cb9-670"><a href="#cb9-670" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-671"><a href="#cb9-671" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb9-672"><a href="#cb9-672" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>))</span>
<span id="cb9-673"><a href="#cb9-673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-674"><a href="#cb9-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-675"><a href="#cb9-675" aria-hidden="true" tabindex="-1"></a>And now using the hallmark estrogen response early.</span>
<span id="cb9-676"><a href="#cb9-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-677"><a href="#cb9-677" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=10, fig.width = 6}</span></span>
<span id="cb9-678"><a href="#cb9-678" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric-tcga-scanb-estrogen-early</span></span>
<span id="cb9-679"><a href="#cb9-679" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Estrogen early scores for all three cohorts.</span></span>
<span id="cb9-680"><a href="#cb9-680" aria-hidden="true" tabindex="-1"></a>pathway_to_get <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>)</span>
<span id="cb9-681"><a href="#cb9-681" aria-hidden="true" tabindex="-1"></a>cols_to_select <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pam50"</span>, <span class="st">"er_status"</span>, <span class="fu">names</span>(pathway_to_get))</span>
<span id="cb9-682"><a href="#cb9-682" aria-hidden="true" tabindex="-1"></a>selected_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb9-683"><a href="#cb9-683" aria-hidden="true" tabindex="-1"></a>    plot_scores,</span>
<span id="cb9-684"><a href="#cb9-684" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span>pluck,</span>
<span id="cb9-685"><a href="#cb9-685" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>, </span>
<span id="cb9-686"><a href="#cb9-686" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span></span>
<span id="cb9-687"><a href="#cb9-687" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-688"><a href="#cb9-688" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(., \(x) x[, cols_to_select]) <span class="sc">%&gt;%</span></span>
<span id="cb9-689"><a href="#cb9-689" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>)</span>
<span id="cb9-690"><a href="#cb9-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-691"><a href="#cb9-691" aria-hidden="true" tabindex="-1"></a>selected_data <span class="sc">%&gt;%</span> </span>
<span id="cb9-692"><a href="#cb9-692" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-693"><a href="#cb9-693" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> er_status, </span>
<span id="cb9-694"><a href="#cb9-694" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">names</span>(pathway_to_get)),</span>
<span id="cb9-695"><a href="#cb9-695" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb9-696"><a href="#cb9-696" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb9-697"><a href="#cb9-697" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb9-698"><a href="#cb9-698" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb9-699"><a href="#cb9-699" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb9-700"><a href="#cb9-700" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span><span class="fl">0.05</span>, </span>
<span id="cb9-701"><a href="#cb9-701" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb9-702"><a href="#cb9-702" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb9-703"><a href="#cb9-703" aria-hidden="true" tabindex="-1"></a>        <span class="at">outlier.shape =</span> <span class="cn">NA</span></span>
<span id="cb9-704"><a href="#cb9-704" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-705"><a href="#cb9-705" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb9-706"><a href="#cb9-706" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span>cohort, </span>
<span id="cb9-707"><a href="#cb9-707" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb9-708"><a href="#cb9-708" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb9-709"><a href="#cb9-709" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tcga"</span> <span class="ot">=</span> <span class="st">"TCGA"</span>,</span>
<span id="cb9-710"><a href="#cb9-710" aria-hidden="true" tabindex="-1"></a>            <span class="st">"metabric"</span> <span class="ot">=</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb9-711"><a href="#cb9-711" aria-hidden="true" tabindex="-1"></a>            <span class="st">"scanb"</span> <span class="ot">=</span> <span class="st">"SCANB"</span></span>
<span id="cb9-712"><a href="#cb9-712" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb9-713"><a href="#cb9-713" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span> </span>
<span id="cb9-714"><a href="#cb9-714" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-715"><a href="#cb9-715" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER status"</span>,</span>
<span id="cb9-716"><a href="#cb9-716" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb9-717"><a href="#cb9-717" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Estrogen early score"</span>,</span>
<span id="cb9-718"><a href="#cb9-718" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(pathway_to_get[<span class="dv">1</span>], <span class="st">" scores by cohort"</span>)</span>
<span id="cb9-719"><a href="#cb9-719" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-720"><a href="#cb9-720" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb9-721"><a href="#cb9-721" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(selected_data)) <span class="sc">+</span></span>
<span id="cb9-722"><a href="#cb9-722" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-723"><a href="#cb9-723" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb9-724"><a href="#cb9-724" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>))</span>
<span id="cb9-725"><a href="#cb9-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-726"><a href="#cb9-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-727"><a href="#cb9-727" aria-hidden="true" tabindex="-1"></a>We see that there is a considerable overlap between the ER+ and ER- BC samples.</span>
<span id="cb9-728"><a href="#cb9-728" aria-hidden="true" tabindex="-1"></a>For each cohort the numbers of ER+ BC samples that have scores below</span>
<span id="cb9-729"><a href="#cb9-729" aria-hidden="true" tabindex="-1"></a>0 is shown below:</span>
<span id="cb9-730"><a href="#cb9-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-733"><a href="#cb9-733" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-734"><a href="#cb9-734" aria-hidden="true" tabindex="-1"></a>selected_data <span class="sc">%&gt;%</span></span>
<span id="cb9-735"><a href="#cb9-735" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb9-736"><a href="#cb9-736" aria-hidden="true" tabindex="-1"></a>        <span class="at">is_below_0 =</span> <span class="fu">ifelse</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>)</span>
<span id="cb9-737"><a href="#cb9-737" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-738"><a href="#cb9-738" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(is_below_0, er_status, cohort) <span class="sc">%&gt;%</span></span>
<span id="cb9-739"><a href="#cb9-739" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_totals</span>(<span class="st">"row"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-740"><a href="#cb9-740" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_percentages</span>(<span class="st">"col"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-741"><a href="#cb9-741" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_pct_formatting</span>(<span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-742"><a href="#cb9-742" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_ns</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-743"><a href="#cb9-743" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_title</span>()</span>
<span id="cb9-744"><a href="#cb9-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-745"><a href="#cb9-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-746"><a href="#cb9-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-747"><a href="#cb9-747" aria-hidden="true" tabindex="-1"></a>Another way to look at the data is to plot by molecular subtype instead</span>
<span id="cb9-748"><a href="#cb9-748" aria-hidden="true" tabindex="-1"></a>of ER status.</span>
<span id="cb9-749"><a href="#cb9-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-750"><a href="#cb9-750" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-751"><a href="#cb9-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-752"><a href="#cb9-752" aria-hidden="true" tabindex="-1"></a><span class="fu">### TCGA</span></span>
<span id="cb9-753"><a href="#cb9-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-756"><a href="#cb9-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-757"><a href="#cb9-757" aria-hidden="true" tabindex="-1"></a>clinical_variable <span class="ot">&lt;-</span> <span class="st">"pam50"</span></span>
<span id="cb9-758"><a href="#cb9-758" aria-hidden="true" tabindex="-1"></a>color_by <span class="ot">&lt;-</span> <span class="st">"er_status"</span></span>
<span id="cb9-759"><a href="#cb9-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-760"><a href="#cb9-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-761"><a href="#cb9-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-764"><a href="#cb9-764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-765"><a href="#cb9-765" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"tcga"</span></span>
<span id="cb9-766"><a href="#cb9-766" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-767"><a href="#cb9-767" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb9-768"><a href="#cb9-768" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb9-769"><a href="#cb9-769" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb9-770"><a href="#cb9-770" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-771"><a href="#cb9-771" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb9-772"><a href="#cb9-772" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> clinical_variable, </span>
<span id="cb9-773"><a href="#cb9-773" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> color_by,</span>
<span id="cb9-774"><a href="#cb9-774" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb9-775"><a href="#cb9-775" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb9-776"><a href="#cb9-776" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-777"><a href="#cb9-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-778"><a href="#cb9-778" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-779"><a href="#cb9-779" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-780"><a href="#cb9-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-781"><a href="#cb9-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-782"><a href="#cb9-782" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb9-783"><a href="#cb9-783" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-tcga-pam50</span></span>
<span id="cb9-784"><a href="#cb9-784" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for TCGA patients stratified by PAM50 molecular subtype</span></span>
<span id="cb9-785"><a href="#cb9-785" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-786"><a href="#cb9-786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-787"><a href="#cb9-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-788"><a href="#cb9-788" aria-hidden="true" tabindex="-1"></a><span class="fu">### METABRIC</span></span>
<span id="cb9-789"><a href="#cb9-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-792"><a href="#cb9-792" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-793"><a href="#cb9-793" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"metabric"</span></span>
<span id="cb9-794"><a href="#cb9-794" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-795"><a href="#cb9-795" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb9-796"><a href="#cb9-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb9-797"><a href="#cb9-797" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb9-798"><a href="#cb9-798" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-799"><a href="#cb9-799" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb9-800"><a href="#cb9-800" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> clinical_variable, </span>
<span id="cb9-801"><a href="#cb9-801" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> color_by,</span>
<span id="cb9-802"><a href="#cb9-802" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb9-803"><a href="#cb9-803" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb9-804"><a href="#cb9-804" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-805"><a href="#cb9-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-806"><a href="#cb9-806" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-807"><a href="#cb9-807" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-808"><a href="#cb9-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-809"><a href="#cb9-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-810"><a href="#cb9-810" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb9-811"><a href="#cb9-811" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric-pam50</span></span>
<span id="cb9-812"><a href="#cb9-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for METABRIC patients stratified by PAM50 molecular subtype</span></span>
<span id="cb9-813"><a href="#cb9-813" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-814"><a href="#cb9-814" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-815"><a href="#cb9-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-816"><a href="#cb9-816" aria-hidden="true" tabindex="-1"></a><span class="fu">### SCANB</span></span>
<span id="cb9-817"><a href="#cb9-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-820"><a href="#cb9-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-821"><a href="#cb9-821" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"scanb"</span></span>
<span id="cb9-822"><a href="#cb9-822" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-823"><a href="#cb9-823" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb9-824"><a href="#cb9-824" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb9-825"><a href="#cb9-825" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb9-826"><a href="#cb9-826" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-827"><a href="#cb9-827" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb9-828"><a href="#cb9-828" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> clinical_variable, </span>
<span id="cb9-829"><a href="#cb9-829" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> color_by,</span>
<span id="cb9-830"><a href="#cb9-830" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb9-831"><a href="#cb9-831" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb9-832"><a href="#cb9-832" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-833"><a href="#cb9-833" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-834"><a href="#cb9-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-835"><a href="#cb9-835" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-836"><a href="#cb9-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-837"><a href="#cb9-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-838"><a href="#cb9-838" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb9-839"><a href="#cb9-839" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-scanb-pam50</span></span>
<span id="cb9-840"><a href="#cb9-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for SCANB patients stratified by PAM50 molecular subtype</span></span>
<span id="cb9-841"><a href="#cb9-841" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-842"><a href="#cb9-842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-843"><a href="#cb9-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-844"><a href="#cb9-844" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-845"><a href="#cb9-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-846"><a href="#cb9-846" aria-hidden="true" tabindex="-1"></a>In all cohorts the luminal A and B patients have a similar score. Also</span>
<span id="cb9-847"><a href="#cb9-847" aria-hidden="true" tabindex="-1"></a>the distinction is very clear between the basal and HER2-like patients</span>
<span id="cb9-848"><a href="#cb9-848" aria-hidden="true" tabindex="-1"></a>versus luminal A and B.</span>
<span id="cb9-849"><a href="#cb9-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-850"><a href="#cb9-850" aria-hidden="true" tabindex="-1"></a>One question that usually arises when calculating scores from gene sets is</span>
<span id="cb9-851"><a href="#cb9-851" aria-hidden="true" tabindex="-1"></a>if proliferation associated genes (PAG) are driving the distinctions. </span>
<span id="cb9-852"><a href="#cb9-852" aria-hidden="true" tabindex="-1"></a>These signatures are highly curated and they have close or no PAGs. </span>
<span id="cb9-853"><a href="#cb9-853" aria-hidden="true" tabindex="-1"></a>Therefore, the scores are not affected by PAGs and they really reflect the</span>
<span id="cb9-854"><a href="#cb9-854" aria-hidden="true" tabindex="-1"></a>biology.</span>
<span id="cb9-855"><a href="#cb9-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-856"><a href="#cb9-856" aria-hidden="true" tabindex="-1"></a>Lastly we show in @fig-scores-scanb-esr1 the correlation of </span>
<span id="cb9-857"><a href="#cb9-857" aria-hidden="true" tabindex="-1"></a>the estrogen signaling scores with the signatures. </span>
<span id="cb9-858"><a href="#cb9-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-859"><a href="#cb9-859" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=6}</span></span>
<span id="cb9-860"><a href="#cb9-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-scanb-esr1</span></span>
<span id="cb9-861"><a href="#cb9-861" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for SCANB patients stratified by PAM50 molecular subtype</span></span>
<span id="cb9-862"><a href="#cb9-862" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb9-863"><a href="#cb9-863" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb9-864"><a href="#cb9-864" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-865"><a href="#cb9-865" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) <span class="sc">%&gt;%</span></span>
<span id="cb9-866"><a href="#cb9-866" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-867"><a href="#cb9-867" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, SET_ERPR),</span>
<span id="cb9-868"><a href="#cb9-868" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb9-869"><a href="#cb9-869" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb9-870"><a href="#cb9-870" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-871"><a href="#cb9-871" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-872"><a href="#cb9-872" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>, </span>
<span id="cb9-873"><a href="#cb9-873" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb9-874"><a href="#cb9-874" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> TreatGroup</span>
<span id="cb9-875"><a href="#cb9-875" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb9-876"><a href="#cb9-876" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">shape =</span> pam50)) <span class="sc">+</span></span>
<span id="cb9-877"><a href="#cb9-877" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb9-878"><a href="#cb9-878" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-879"><a href="#cb9-879" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"log2(ESR1) levels (FPKM)"</span>,</span>
<span id="cb9-880"><a href="#cb9-880" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Treatment</span><span class="sc">\n</span><span class="st">Group"</span>,</span>
<span id="cb9-881"><a href="#cb9-881" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb9-882"><a href="#cb9-882" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-883"><a href="#cb9-883" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between ER IHC percentage and</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-884"><a href="#cb9-884" aria-hidden="true" tabindex="-1"></a>            <span class="st">"molecular ER signaling score"</span></span>
<span id="cb9-885"><a href="#cb9-885" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-886"><a href="#cb9-886" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb9-887"><a href="#cb9-887" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-888"><a href="#cb9-888" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb9-889"><a href="#cb9-889" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-890"><a href="#cb9-890" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>(<span class="at">shape =</span> <span class="cn">TRUE</span>) </span>
<span id="cb9-891"><a href="#cb9-891" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-892"><a href="#cb9-892" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-893"><a href="#cb9-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-894"><a href="#cb9-894" aria-hidden="true" tabindex="-1"></a>We see that there is a positive correlation between signatures and scores,</span>
<span id="cb9-895"><a href="#cb9-895" aria-hidden="true" tabindex="-1"></a>the problem though is the high variability in the scores in this case. </span>
<span id="cb9-896"><a href="#cb9-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-897"><a href="#cb9-897" aria-hidden="true" tabindex="-1"></a>In the next section we will show how these scores are also prognostic for</span>
<span id="cb9-898"><a href="#cb9-898" aria-hidden="true" tabindex="-1"></a>ER+ BC patients.</span>
<span id="cb9-899"><a href="#cb9-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-900"><a href="#cb9-900" aria-hidden="true" tabindex="-1"></a><span class="fu">## Survival analysis</span></span>
<span id="cb9-901"><a href="#cb9-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-902"><a href="#cb9-902" aria-hidden="true" tabindex="-1"></a>Since the scores are continuous variables and they are already scaled due</span>
<span id="cb9-903"><a href="#cb9-903" aria-hidden="true" tabindex="-1"></a>to the output of GSVA, cox regression <span class="co">[</span><span class="ot">@Cox1972</span><span class="co">]</span> can be used. The advantages </span>
<span id="cb9-904"><a href="#cb9-904" aria-hidden="true" tabindex="-1"></a>of using cox regression is that one can control for other variables. You might</span>
<span id="cb9-905"><a href="#cb9-905" aria-hidden="true" tabindex="-1"></a>ask, why should one control for clinical variables? One of the reasons is </span>
<span id="cb9-906"><a href="#cb9-906" aria-hidden="true" tabindex="-1"></a>because the data being dealt here is observational data. There are several</span>
<span id="cb9-907"><a href="#cb9-907" aria-hidden="true" tabindex="-1"></a>confounders, for example, a score might be up because patients with a higher</span>
<span id="cb9-908"><a href="#cb9-908" aria-hidden="true" tabindex="-1"></a>tumor grade have higher expression of some genes. Thus the score is confounded</span>
<span id="cb9-909"><a href="#cb9-909" aria-hidden="true" tabindex="-1"></a>by the tumor grade and the interpretation changes. </span>
<span id="cb9-910"><a href="#cb9-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-911"><a href="#cb9-911" aria-hidden="true" tabindex="-1"></a>There are limitations still when dealing with observational data. A strong </span>
<span id="cb9-912"><a href="#cb9-912" aria-hidden="true" tabindex="-1"></a>hypothesis for performing survival analysis with observational data is that</span>
<span id="cb9-913"><a href="#cb9-913" aria-hidden="true" tabindex="-1"></a>we have measured all the confounder variables. This is pretty strong and in</span>
<span id="cb9-914"><a href="#cb9-914" aria-hidden="true" tabindex="-1"></a>practice we never know if a confounder is missing or not. For a more</span>
<span id="cb9-915"><a href="#cb9-915" aria-hidden="true" tabindex="-1"></a>thorough overview of the causal framework for observational data, check</span>
<span id="cb9-916"><a href="#cb9-916" aria-hidden="true" tabindex="-1"></a>the books <span class="co">[</span><span class="ot">@Gelman2020-uh; @McElreath2020-jn</span><span class="co">]</span>.</span>
<span id="cb9-917"><a href="#cb9-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-918"><a href="#cb9-918" aria-hidden="true" tabindex="-1"></a>All the cohorts have a different set of clinical variables available. Therefore,</span>
<span id="cb9-919"><a href="#cb9-919" aria-hidden="true" tabindex="-1"></a>the regression will be done by adjusting a different set of variables. Below</span>
<span id="cb9-920"><a href="#cb9-920" aria-hidden="true" tabindex="-1"></a>is the description of the variables used for each cohort.^<span class="co">[</span><span class="ot">This [webpage</span><span class="co">](https://web.archive.org/web/20220630083539/https://www.cancer.net/cancer-types/breast-cancer/stages)</span> explains with more details the different tumor stages and how</span>
<span id="cb9-921"><a href="#cb9-921" aria-hidden="true" tabindex="-1"></a>BC are classified.]</span>
<span id="cb9-922"><a href="#cb9-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-923"><a href="#cb9-923" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Age**: age is one of the most important factors to adjust, specially in</span>
<span id="cb9-924"><a href="#cb9-924" aria-hidden="true" tabindex="-1"></a>breast cancer. This covariate is used for all cohorts.</span>
<span id="cb9-925"><a href="#cb9-925" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**NPI**: the Nottingham prognostic index scores each tumor</span>
<span id="cb9-926"><a href="#cb9-926" aria-hidden="true" tabindex="-1"></a>based on tumor grade, tumor size and number of lymph nodes. Only METABRIC</span>
<span id="cb9-927"><a href="#cb9-927" aria-hidden="true" tabindex="-1"></a>has this information. </span>
<span id="cb9-928"><a href="#cb9-928" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tumor Size**: as name describes. Only SCANB has this information. </span>
<span id="cb9-929"><a href="#cb9-929" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tumor Stage**: tumors are usually described in terms of stage, it reflects</span>
<span id="cb9-930"><a href="#cb9-930" aria-hidden="true" tabindex="-1"></a>the tumor size and location. SCANB and TCGA have this information.</span>
<span id="cb9-931"><a href="#cb9-931" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Node Stage**: similar to tumor stage, but encodes the number of lymph nodes</span>
<span id="cb9-932"><a href="#cb9-932" aria-hidden="true" tabindex="-1"></a>where breast cancer cells can be found. SCANB and TCGA have this information.</span>
<span id="cb9-933"><a href="#cb9-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-934"><a href="#cb9-934" aria-hidden="true" tabindex="-1"></a>Thus the models we are going to use for the survival analysis of each dataset</span>
<span id="cb9-935"><a href="#cb9-935" aria-hidden="true" tabindex="-1"></a>is shown below.</span>
<span id="cb9-936"><a href="#cb9-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-937"><a href="#cb9-937" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TCGA: <span class="in">`~ score + age + node_stage + tumor_stage`</span>,</span>
<span id="cb9-938"><a href="#cb9-938" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>SCANB: <span class="in">`~ score + age + node_stage + tumor_stage`</span>,</span>
<span id="cb9-939"><a href="#cb9-939" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>METABRIC: <span class="in">`~ score + age + NPI`</span>,</span>
<span id="cb9-940"><a href="#cb9-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-941"><a href="#cb9-941" aria-hidden="true" tabindex="-1"></a>where score is one of the scores calculated earlier with GSVA. Note here</span>
<span id="cb9-942"><a href="#cb9-942" aria-hidden="true" tabindex="-1"></a>that since each node stage and tumor stage have sub classifications they </span>
<span id="cb9-943"><a href="#cb9-943" aria-hidden="true" tabindex="-1"></a>will be grouped together, otherwise there will be too many variables with</span>
<span id="cb9-944"><a href="#cb9-944" aria-hidden="true" tabindex="-1"></a>few points. We will also subselect specific tumor stages for TCGA and SCANB,</span>
<span id="cb9-945"><a href="#cb9-945" aria-hidden="true" tabindex="-1"></a>since there are very few patients with tumor stage 4.</span>
<span id="cb9-946"><a href="#cb9-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-947"><a href="#cb9-947" aria-hidden="true" tabindex="-1"></a>To be very specific in the survival analysis, only endocrine treated patients</span>
<span id="cb9-948"><a href="#cb9-948" aria-hidden="true" tabindex="-1"></a>should be used in the analysis, as that is what are interested in. METABRIC</span>
<span id="cb9-949"><a href="#cb9-949" aria-hidden="true" tabindex="-1"></a>and SCANB has this kind of annotation, but TCGA not. So the survival analysis</span>
<span id="cb9-950"><a href="#cb9-950" aria-hidden="true" tabindex="-1"></a>on SCANB and METABRIC will be performed on endocrine only treated, ER+ BC</span>
<span id="cb9-951"><a href="#cb9-951" aria-hidden="true" tabindex="-1"></a>patients. On TCGA, to mitigate this effect, we subselect only luminal A and </span>
<span id="cb9-952"><a href="#cb9-952" aria-hidden="true" tabindex="-1"></a>B patients, and we keep in mind that they might have been treated with</span>
<span id="cb9-953"><a href="#cb9-953" aria-hidden="true" tabindex="-1"></a>chemotherapy as well. Moreover, in Sweden the guidelines for BC treatment is to</span>
<span id="cb9-954"><a href="#cb9-954" aria-hidden="true" tabindex="-1"></a>use 10% as the threshold for ER status. Therefore, ER+ BC patients used on</span>
<span id="cb9-955"><a href="#cb9-955" aria-hidden="true" tabindex="-1"></a>SCANB are those that are above the 10% threshold.</span>
<span id="cb9-956"><a href="#cb9-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-957"><a href="#cb9-957" aria-hidden="true" tabindex="-1"></a>The table below shows the number of patients for each cohort.</span>
<span id="cb9-958"><a href="#cb9-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-961"><a href="#cb9-961" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-962"><a href="#cb9-962" aria-hidden="true" tabindex="-1"></a>tcga_samples <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>tcga) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-963"><a href="#cb9-963" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-964"><a href="#cb9-964" aria-hidden="true" tabindex="-1"></a>        pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"luma"</span>, <span class="st">"lumb"</span>) <span class="sc">&amp;</span></span>
<span id="cb9-965"><a href="#cb9-965" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb9-966"><a href="#cb9-966" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"stage_iv"</span>, <span class="st">"na"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb9-967"><a href="#cb9-967" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span></span>
<span id="cb9-968"><a href="#cb9-968" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-969"><a href="#cb9-969" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-970"><a href="#cb9-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-971"><a href="#cb9-971" aria-hidden="true" tabindex="-1"></a>scanb_samples <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-972"><a href="#cb9-972" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-973"><a href="#cb9-973" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb9-974"><a href="#cb9-974" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb9-975"><a href="#cb9-975" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-976"><a href="#cb9-976" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span></span>
<span id="cb9-977"><a href="#cb9-977" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-978"><a href="#cb9-978" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-979"><a href="#cb9-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-980"><a href="#cb9-980" aria-hidden="true" tabindex="-1"></a><span class="co"># we select also patients with high ER percentage &gt; 90 for comparison</span></span>
<span id="cb9-981"><a href="#cb9-981" aria-hidden="true" tabindex="-1"></a><span class="co"># down in the analysis</span></span>
<span id="cb9-982"><a href="#cb9-982" aria-hidden="true" tabindex="-1"></a>scanb_high_er <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-983"><a href="#cb9-983" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-984"><a href="#cb9-984" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb9-985"><a href="#cb9-985" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb9-986"><a href="#cb9-986" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-987"><a href="#cb9-987" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-988"><a href="#cb9-988" aria-hidden="true" tabindex="-1"></a>        ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span>    </span>
<span id="cb9-989"><a href="#cb9-989" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-990"><a href="#cb9-990" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-991"><a href="#cb9-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-992"><a href="#cb9-992" aria-hidden="true" tabindex="-1"></a><span class="co"># and we test if the er signaling score is protective for the low </span></span>
<span id="cb9-993"><a href="#cb9-993" aria-hidden="true" tabindex="-1"></a><span class="co"># ER IHC. low meaning less than 90%</span></span>
<span id="cb9-994"><a href="#cb9-994" aria-hidden="true" tabindex="-1"></a>scanb_low_er <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-995"><a href="#cb9-995" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-996"><a href="#cb9-996" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb9-997"><a href="#cb9-997" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb9-998"><a href="#cb9-998" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-999"><a href="#cb9-999" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-1000"><a href="#cb9-1000" aria-hidden="true" tabindex="-1"></a>        ER.pct <span class="sc">&lt;</span> <span class="dv">90</span></span>
<span id="cb9-1001"><a href="#cb9-1001" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1002"><a href="#cb9-1002" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-1003"><a href="#cb9-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1004"><a href="#cb9-1004" aria-hidden="true" tabindex="-1"></a>scanb_high_esr1 <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1005"><a href="#cb9-1005" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">esr1 =</span> <span class="fu">log2</span>(<span class="fu">assay</span>(datasets<span class="sc">$</span>scanb, <span class="st">"FPKM"</span>)[<span class="st">"ESR1"</span>,] <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-1006"><a href="#cb9-1006" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-1007"><a href="#cb9-1007" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb9-1008"><a href="#cb9-1008" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb9-1009"><a href="#cb9-1009" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-1010"><a href="#cb9-1010" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-1011"><a href="#cb9-1011" aria-hidden="true" tabindex="-1"></a>        esr1 <span class="sc">&gt;</span> <span class="fl">7.5</span></span>
<span id="cb9-1012"><a href="#cb9-1012" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1013"><a href="#cb9-1013" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-1014"><a href="#cb9-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1015"><a href="#cb9-1015" aria-hidden="true" tabindex="-1"></a><span class="co"># and lastly we only select patients with high ESR1 levels</span></span>
<span id="cb9-1016"><a href="#cb9-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1017"><a href="#cb9-1017" aria-hidden="true" tabindex="-1"></a>metabric_samples <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>metabric) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1018"><a href="#cb9-1018" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-1019"><a href="#cb9-1019" aria-hidden="true" tabindex="-1"></a>        CHEMOTHERAPY <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span></span>
<span id="cb9-1020"><a href="#cb9-1020" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-1021"><a href="#cb9-1021" aria-hidden="true" tabindex="-1"></a>        HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span></span>
<span id="cb9-1022"><a href="#cb9-1022" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1023"><a href="#cb9-1023" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-1024"><a href="#cb9-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1025"><a href="#cb9-1025" aria-hidden="true" tabindex="-1"></a>metabric_high_esr1 <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>metabric) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1026"><a href="#cb9-1026" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">esr1 =</span> <span class="fu">as.matrix</span>(<span class="fu">assay</span>(</span>
<span id="cb9-1027"><a href="#cb9-1027" aria-hidden="true" tabindex="-1"></a>            datasets<span class="sc">$</span>metabric, </span>
<span id="cb9-1028"><a href="#cb9-1028" aria-hidden="true" tabindex="-1"></a>            <span class="st">"median_intensity"</span></span>
<span id="cb9-1029"><a href="#cb9-1029" aria-hidden="true" tabindex="-1"></a>        ))[<span class="st">"ESR1"</span>, ]</span>
<span id="cb9-1030"><a href="#cb9-1030" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-1031"><a href="#cb9-1031" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-1032"><a href="#cb9-1032" aria-hidden="true" tabindex="-1"></a>        CHEMOTHERAPY <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span></span>
<span id="cb9-1033"><a href="#cb9-1033" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb9-1034"><a href="#cb9-1034" aria-hidden="true" tabindex="-1"></a>        HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">&amp;</span></span>
<span id="cb9-1035"><a href="#cb9-1035" aria-hidden="true" tabindex="-1"></a>        esr1 <span class="sc">&gt;</span> <span class="fl">11.5</span></span>
<span id="cb9-1036"><a href="#cb9-1036" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1037"><a href="#cb9-1037" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb9-1038"><a href="#cb9-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1039"><a href="#cb9-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1040"><a href="#cb9-1040" aria-hidden="true" tabindex="-1"></a>nb_pts_events <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-1041"><a href="#cb9-1041" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="fu">c</span>(</span>
<span id="cb9-1042"><a href="#cb9-1042" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TCGA"</span>, <span class="st">"SCANB"</span>, <span class="st">"METABRIC"</span>, </span>
<span id="cb9-1043"><a href="#cb9-1043" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SCANB High ER"</span>, <span class="st">"SCANB Low ER"</span>,</span>
<span id="cb9-1044"><a href="#cb9-1044" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SCANB High ESR1"</span>,</span>
<span id="cb9-1045"><a href="#cb9-1045" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC High ESR1"</span></span>
<span id="cb9-1046"><a href="#cb9-1046" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1047"><a href="#cb9-1047" aria-hidden="true" tabindex="-1"></a>    <span class="at">number_patients =</span> <span class="fu">c</span>(</span>
<span id="cb9-1048"><a href="#cb9-1048" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(tcga_samples),</span>
<span id="cb9-1049"><a href="#cb9-1049" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_samples),</span>
<span id="cb9-1050"><a href="#cb9-1050" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(metabric_samples),</span>
<span id="cb9-1051"><a href="#cb9-1051" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_high_er),</span>
<span id="cb9-1052"><a href="#cb9-1052" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_low_er),</span>
<span id="cb9-1053"><a href="#cb9-1053" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_high_esr1),</span>
<span id="cb9-1054"><a href="#cb9-1054" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(metabric_high_esr1)</span>
<span id="cb9-1055"><a href="#cb9-1055" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1056"><a href="#cb9-1056" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_events =</span> <span class="fu">c</span>(</span>
<span id="cb9-1057"><a href="#cb9-1057" aria-hidden="true" tabindex="-1"></a>        datasets<span class="sc">$</span>tcga <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1058"><a href="#cb9-1058" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> tcga_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1059"><a href="#cb9-1059" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1060"><a href="#cb9-1060" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb9-1061"><a href="#cb9-1061" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1062"><a href="#cb9-1062" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1063"><a href="#cb9-1063" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1064"><a href="#cb9-1064" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb9-1065"><a href="#cb9-1065" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>metabric <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1066"><a href="#cb9-1066" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1067"><a href="#cb9-1067" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1068"><a href="#cb9-1068" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb9-1069"><a href="#cb9-1069" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1070"><a href="#cb9-1070" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_high_er <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1071"><a href="#cb9-1071" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1072"><a href="#cb9-1072" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb9-1073"><a href="#cb9-1073" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1074"><a href="#cb9-1074" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_low_er <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1075"><a href="#cb9-1075" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1076"><a href="#cb9-1076" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb9-1077"><a href="#cb9-1077" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1078"><a href="#cb9-1078" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_high_esr1 <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1079"><a href="#cb9-1079" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1080"><a href="#cb9-1080" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb9-1081"><a href="#cb9-1081" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>metabric <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1082"><a href="#cb9-1082" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_high_esr1 <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1083"><a href="#cb9-1083" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-1084"><a href="#cb9-1084" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n)</span>
<span id="cb9-1085"><a href="#cb9-1085" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1086"><a href="#cb9-1086" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-1087"><a href="#cb9-1087" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-1088"><a href="#cb9-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1089"><a href="#cb9-1089" aria-hidden="true" tabindex="-1"></a>nb_pts_events</span>
<span id="cb9-1090"><a href="#cb9-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1091"><a href="#cb9-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1092"><a href="#cb9-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1093"><a href="#cb9-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb9-1094"><a href="#cb9-1094" aria-hidden="true" tabindex="-1"></a><span class="co"># run the survival analysis for each dataset with its own formula.</span></span>
<span id="cb9-1095"><a href="#cb9-1095" aria-hidden="true" tabindex="-1"></a><span class="co"># we start by defining the base formulas, because later we sapply and </span></span>
<span id="cb9-1096"><a href="#cb9-1096" aria-hidden="true" tabindex="-1"></a><span class="co"># add the scores. this way if we need to change the formulas, we only</span></span>
<span id="cb9-1097"><a href="#cb9-1097" aria-hidden="true" tabindex="-1"></a><span class="co"># need to change once and all together.</span></span>
<span id="cb9-1098"><a href="#cb9-1098" aria-hidden="true" tabindex="-1"></a>formulas_survival <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-1099"><a href="#cb9-1099" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_tcga"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb9-1100"><a href="#cb9-1100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_scanb"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb9-1101"><a href="#cb9-1101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"os_scanb_high_er" = "Surv(os_months, os_status) ~ age + node_stage + tumor_stage",</span></span>
<span id="cb9-1102"><a href="#cb9-1102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"os_scanb_low_er" = "Surv(os_months, os_status) ~ age + node_stage + tumor_stage",</span></span>
<span id="cb9-1103"><a href="#cb9-1103" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"os_scanb_high_esr1" = "Surv(os_months, os_status) ~ age + node_stage + tumor_stage",</span></span>
<span id="cb9-1104"><a href="#cb9-1104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_metabric"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + npi"</span>,</span>
<span id="cb9-1105"><a href="#cb9-1105" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"os_metabric_high_esr1" = "Surv(os_months, os_status) ~ age + npi",</span></span>
<span id="cb9-1106"><a href="#cb9-1106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_metabric"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + npi"</span>,</span>
<span id="cb9-1107"><a href="#cb9-1107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_scanb"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage"</span><span class="co">#,</span></span>
<span id="cb9-1108"><a href="#cb9-1108" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"rfs_scanb_high_er" = "Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage",</span></span>
<span id="cb9-1109"><a href="#cb9-1109" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"rfs_scanb_low_er" = "Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage",</span></span>
<span id="cb9-1110"><a href="#cb9-1110" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"rfs_scanb_high_esr1" = "Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage",</span></span>
<span id="cb9-1111"><a href="#cb9-1111" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"rfs_metabric_high_esr1" = "Surv(rfs_months, rfs_status) ~ age + npi"</span></span>
<span id="cb9-1112"><a href="#cb9-1112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1113"><a href="#cb9-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1114"><a href="#cb9-1114" aria-hidden="true" tabindex="-1"></a>type_survival <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"os"</span>, <span class="st">"rfs"</span>)</span>
<span id="cb9-1115"><a href="#cb9-1115" aria-hidden="true" tabindex="-1"></a>which_scores <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-1116"><a href="#cb9-1116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb9-1117"><a href="#cb9-1117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span>,</span>
<span id="cb9-1118"><a href="#cb9-1118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>,</span>
<span id="cb9-1119"><a href="#cb9-1119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span>,</span>
<span id="cb9-1120"><a href="#cb9-1120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span>,</span>
<span id="cb9-1121"><a href="#cb9-1121" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ER.pct"</span></span>
<span id="cb9-1122"><a href="#cb9-1122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1123"><a href="#cb9-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1124"><a href="#cb9-1124" aria-hidden="true" tabindex="-1"></a>survival_results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb9-1125"><a href="#cb9-1125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"os"</span>, <span class="st">"rfs"</span>),</span>
<span id="cb9-1126"><a href="#cb9-1126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(type_analysis, datasets, name_scores, formulas){</span>
<span id="cb9-1127"><a href="#cb9-1127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb9-1128"><a href="#cb9-1128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb9-1129"><a href="#cb9-1129" aria-hidden="true" tabindex="-1"></a>                dataset, name_dataset, name_scores, formulas, type_analysis</span>
<span id="cb9-1130"><a href="#cb9-1130" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb9-1131"><a href="#cb9-1131" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-1132"><a href="#cb9-1132" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (type_analysis <span class="sc">==</span> <span class="st">"rfs"</span> <span class="sc">&amp;</span> name_dataset <span class="sc">==</span> <span class="st">"tcga"</span>){</span>
<span id="cb9-1133"><a href="#cb9-1133" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span>()</span>
<span id="cb9-1134"><a href="#cb9-1134" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> { </span>
<span id="cb9-1135"><a href="#cb9-1135" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-1136"><a href="#cb9-1136" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb9-1137"><a href="#cb9-1137" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sapply</span>(</span>
<span id="cb9-1138"><a href="#cb9-1138" aria-hidden="true" tabindex="-1"></a>                        name_scores,</span>
<span id="cb9-1139"><a href="#cb9-1139" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">function</span>(name_score, col_data, formula_str, type_analysis){</span>
<span id="cb9-1140"><a href="#cb9-1140" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb9-1141"><a href="#cb9-1141" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> (name_score <span class="sc">%in%</span> <span class="fu">colnames</span>(col_data)){</span>
<span id="cb9-1142"><a href="#cb9-1142" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb9-1143"><a href="#cb9-1143" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb9-1144"><a href="#cb9-1144" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">if</span> (type_analysis <span class="sc">==</span> <span class="st">"rfs"</span>){</span>
<span id="cb9-1145"><a href="#cb9-1145" aria-hidden="true" tabindex="-1"></a>                                    col_data<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-1146"><a href="#cb9-1146" aria-hidden="true" tabindex="-1"></a>                                        col_data<span class="sc">$</span>rfs_status <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb9-1147"><a href="#cb9-1147" aria-hidden="true" tabindex="-1"></a>                                        <span class="dv">1</span>,</span>
<span id="cb9-1148"><a href="#cb9-1148" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">ifelse</span>(</span>
<span id="cb9-1149"><a href="#cb9-1149" aria-hidden="true" tabindex="-1"></a>                                            col_data<span class="sc">$</span>rfs_status <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb9-1150"><a href="#cb9-1150" aria-hidden="true" tabindex="-1"></a>                                            <span class="dv">0</span>,</span>
<span id="cb9-1151"><a href="#cb9-1151" aria-hidden="true" tabindex="-1"></a>                                            <span class="cn">NA</span></span>
<span id="cb9-1152"><a href="#cb9-1152" aria-hidden="true" tabindex="-1"></a>                                        )</span>
<span id="cb9-1153"><a href="#cb9-1153" aria-hidden="true" tabindex="-1"></a>                                        </span>
<span id="cb9-1154"><a href="#cb9-1154" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb9-1155"><a href="#cb9-1155" aria-hidden="true" tabindex="-1"></a>                                } <span class="cf">else</span> {</span>
<span id="cb9-1156"><a href="#cb9-1156" aria-hidden="true" tabindex="-1"></a>                                    col_data<span class="sc">$</span>os_status <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-1157"><a href="#cb9-1157" aria-hidden="true" tabindex="-1"></a>                                        col_data<span class="sc">$</span>os_status <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb9-1158"><a href="#cb9-1158" aria-hidden="true" tabindex="-1"></a>                                        <span class="dv">1</span>,</span>
<span id="cb9-1159"><a href="#cb9-1159" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">ifelse</span>(</span>
<span id="cb9-1160"><a href="#cb9-1160" aria-hidden="true" tabindex="-1"></a>                                            col_data<span class="sc">$</span>os_status <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb9-1161"><a href="#cb9-1161" aria-hidden="true" tabindex="-1"></a>                                            <span class="dv">0</span>,</span>
<span id="cb9-1162"><a href="#cb9-1162" aria-hidden="true" tabindex="-1"></a>                                            <span class="cn">NA</span></span>
<span id="cb9-1163"><a href="#cb9-1163" aria-hidden="true" tabindex="-1"></a>                                        )</span>
<span id="cb9-1164"><a href="#cb9-1164" aria-hidden="true" tabindex="-1"></a>                                        </span>
<span id="cb9-1165"><a href="#cb9-1165" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb9-1166"><a href="#cb9-1166" aria-hidden="true" tabindex="-1"></a>                                }</span>
<span id="cb9-1167"><a href="#cb9-1167" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb9-1168"><a href="#cb9-1168" aria-hidden="true" tabindex="-1"></a>                                flexsurv<span class="sc">::</span><span class="fu">flexsurvreg</span>(<span class="co">#coxph(</span></span>
<span id="cb9-1169"><a href="#cb9-1169" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">as.formula</span>(</span>
<span id="cb9-1170"><a href="#cb9-1170" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">paste</span>(</span>
<span id="cb9-1171"><a href="#cb9-1171" aria-hidden="true" tabindex="-1"></a>                                            formula_str, </span>
<span id="cb9-1172"><a href="#cb9-1172" aria-hidden="true" tabindex="-1"></a>                                            name_score, </span>
<span id="cb9-1173"><a href="#cb9-1173" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">sep =</span> <span class="st">"+"</span></span>
<span id="cb9-1174"><a href="#cb9-1174" aria-hidden="true" tabindex="-1"></a>                                        )[<span class="dv">1</span>]</span>
<span id="cb9-1175"><a href="#cb9-1175" aria-hidden="true" tabindex="-1"></a>                                    ),</span>
<span id="cb9-1176"><a href="#cb9-1176" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">data =</span> col_data, </span>
<span id="cb9-1177"><a href="#cb9-1177" aria-hidden="true" tabindex="-1"></a>                                    <span class="co">#y = FALSE,</span></span>
<span id="cb9-1178"><a href="#cb9-1178" aria-hidden="true" tabindex="-1"></a>                                    <span class="co">#x = FALSE,</span></span>
<span id="cb9-1179"><a href="#cb9-1179" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">dist =</span> <span class="st">"lognormal"</span></span>
<span id="cb9-1180"><a href="#cb9-1180" aria-hidden="true" tabindex="-1"></a>                                )    </span>
<span id="cb9-1181"><a href="#cb9-1181" aria-hidden="true" tabindex="-1"></a>                            } <span class="cf">else</span> {</span>
<span id="cb9-1182"><a href="#cb9-1182" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>()</span>
<span id="cb9-1183"><a href="#cb9-1183" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb9-1184"><a href="#cb9-1184" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb9-1185"><a href="#cb9-1185" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb9-1186"><a href="#cb9-1186" aria-hidden="true" tabindex="-1"></a>                        <span class="at">col_data =</span> <span class="fu">colData</span>(dataset) <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb9-1187"><a href="#cb9-1187" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> formulas[</span>
<span id="cb9-1188"><a href="#cb9-1188" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">grepl</span>(</span>
<span id="cb9-1189"><a href="#cb9-1189" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">paste</span>(type_analysis, name_dataset, <span class="at">sep =</span> <span class="st">"_"</span>),</span>
<span id="cb9-1190"><a href="#cb9-1190" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">names</span>(formulas)</span>
<span id="cb9-1191"><a href="#cb9-1191" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb9-1192"><a href="#cb9-1192" aria-hidden="true" tabindex="-1"></a>                        ],</span>
<span id="cb9-1193"><a href="#cb9-1193" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type_analysis =</span> type_analysis,</span>
<span id="cb9-1194"><a href="#cb9-1194" aria-hidden="true" tabindex="-1"></a>                        <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1195"><a href="#cb9-1195" aria-hidden="true" tabindex="-1"></a>                        <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1196"><a href="#cb9-1196" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb9-1197"><a href="#cb9-1197" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb9-1198"><a href="#cb9-1198" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb9-1199"><a href="#cb9-1199" aria-hidden="true" tabindex="-1"></a>            <span class="at">dataset =</span> datasets,</span>
<span id="cb9-1200"><a href="#cb9-1200" aria-hidden="true" tabindex="-1"></a>            <span class="at">name_dataset =</span> <span class="fu">names</span>(datasets),</span>
<span id="cb9-1201"><a href="#cb9-1201" aria-hidden="true" tabindex="-1"></a>            <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-1202"><a href="#cb9-1202" aria-hidden="true" tabindex="-1"></a>                <span class="at">formulas =</span> formulas, </span>
<span id="cb9-1203"><a href="#cb9-1203" aria-hidden="true" tabindex="-1"></a>                <span class="at">name_scores =</span> name_scores,</span>
<span id="cb9-1204"><a href="#cb9-1204" aria-hidden="true" tabindex="-1"></a>                <span class="at">type_analysis =</span> type_analysis</span>
<span id="cb9-1205"><a href="#cb9-1205" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb9-1206"><a href="#cb9-1206" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1207"><a href="#cb9-1207" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1208"><a href="#cb9-1208" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1209"><a href="#cb9-1209" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-1210"><a href="#cb9-1210" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> <span class="fu">mapply</span>(</span>
<span id="cb9-1211"><a href="#cb9-1211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(dataset, patients) dataset[, patients],</span>
<span id="cb9-1212"><a href="#cb9-1212" aria-hidden="true" tabindex="-1"></a>        <span class="at">dataset =</span> <span class="fu">c</span>(</span>
<span id="cb9-1213"><a href="#cb9-1213" aria-hidden="true" tabindex="-1"></a>            datasets<span class="co">#, </span></span>
<span id="cb9-1214"><a href="#cb9-1214" aria-hidden="true" tabindex="-1"></a>            <span class="co">#scanb_high_er = datasets$scanb,</span></span>
<span id="cb9-1215"><a href="#cb9-1215" aria-hidden="true" tabindex="-1"></a>            <span class="co">#scanb_low_er = datasets$scanb,</span></span>
<span id="cb9-1216"><a href="#cb9-1216" aria-hidden="true" tabindex="-1"></a>            <span class="co">#scanb_high_esr1 = datasets$scanb,</span></span>
<span id="cb9-1217"><a href="#cb9-1217" aria-hidden="true" tabindex="-1"></a>            <span class="co">#metabric_high_esr1 = datasets$metabric</span></span>
<span id="cb9-1218"><a href="#cb9-1218" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-1219"><a href="#cb9-1219" aria-hidden="true" tabindex="-1"></a>        <span class="at">patients =</span> <span class="fu">list</span>(</span>
<span id="cb9-1220"><a href="#cb9-1220" aria-hidden="true" tabindex="-1"></a>            tcga_samples, </span>
<span id="cb9-1221"><a href="#cb9-1221" aria-hidden="true" tabindex="-1"></a>            scanb_samples, </span>
<span id="cb9-1222"><a href="#cb9-1222" aria-hidden="true" tabindex="-1"></a>            metabric_samples<span class="co">#, </span></span>
<span id="cb9-1223"><a href="#cb9-1223" aria-hidden="true" tabindex="-1"></a>            <span class="co">#scanb_high_er,</span></span>
<span id="cb9-1224"><a href="#cb9-1224" aria-hidden="true" tabindex="-1"></a>            <span class="co">#scanb_low_er,</span></span>
<span id="cb9-1225"><a href="#cb9-1225" aria-hidden="true" tabindex="-1"></a>            <span class="co">#scanb_high_esr1,</span></span>
<span id="cb9-1226"><a href="#cb9-1226" aria-hidden="true" tabindex="-1"></a>            <span class="co">#metabric_high_esr1</span></span>
<span id="cb9-1227"><a href="#cb9-1227" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-1228"><a href="#cb9-1228" aria-hidden="true" tabindex="-1"></a>        <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1229"><a href="#cb9-1229" aria-hidden="true" tabindex="-1"></a>        <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1230"><a href="#cb9-1230" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1231"><a href="#cb9-1231" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_scores =</span> which_scores,</span>
<span id="cb9-1232"><a href="#cb9-1232" aria-hidden="true" tabindex="-1"></a>    <span class="at">formulas =</span> formulas_survival,</span>
<span id="cb9-1233"><a href="#cb9-1233" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1234"><a href="#cb9-1234" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1235"><a href="#cb9-1235" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1236"><a href="#cb9-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1237"><a href="#cb9-1237" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_esr1<span class="sc">$</span>ER.pct <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-1238"><a href="#cb9-1238" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric_high_esr1<span class="sc">$</span>ER.pct <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-1239"><a href="#cb9-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1240"><a href="#cb9-1240" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs <span class="ot">&lt;-</span> survival_results<span class="sc">$</span>rfs[</span>
<span id="cb9-1241"><a href="#cb9-1241" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">sapply</span>(survival_results<span class="sc">$</span>rfs, is.null)</span>
<span id="cb9-1242"><a href="#cb9-1242" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb9-1243"><a href="#cb9-1243" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric <span class="ot">&lt;-</span> survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric[</span>
<span id="cb9-1244"><a href="#cb9-1244" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">sapply</span>(survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric, is.null)</span>
<span id="cb9-1245"><a href="#cb9-1245" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb9-1246"><a href="#cb9-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1247"><a href="#cb9-1247" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>os <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">discard</span>(</span>
<span id="cb9-1248"><a href="#cb9-1248" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb9-1249"><a href="#cb9-1249" aria-hidden="true" tabindex="-1"></a>        survival_results<span class="sc">$</span>os, </span>
<span id="cb9-1250"><a href="#cb9-1250" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> purrr<span class="sc">::</span><span class="fu">discard</span>(.x, is.null),</span>
<span id="cb9-1251"><a href="#cb9-1251" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1252"><a href="#cb9-1252" aria-hidden="true" tabindex="-1"></a>    is.null</span>
<span id="cb9-1253"><a href="#cb9-1253" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1254"><a href="#cb9-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1255"><a href="#cb9-1255" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">discard</span>(</span>
<span id="cb9-1256"><a href="#cb9-1256" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb9-1257"><a href="#cb9-1257" aria-hidden="true" tabindex="-1"></a>        survival_results<span class="sc">$</span>rfs, </span>
<span id="cb9-1258"><a href="#cb9-1258" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> purrr<span class="sc">::</span><span class="fu">discard</span>(.x, is.null),</span>
<span id="cb9-1259"><a href="#cb9-1259" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1260"><a href="#cb9-1260" aria-hidden="true" tabindex="-1"></a>    is.null</span>
<span id="cb9-1261"><a href="#cb9-1261" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1262"><a href="#cb9-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1263"><a href="#cb9-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1264"><a href="#cb9-1264" aria-hidden="true" tabindex="-1"></a><span class="co"># we cannot simply save the models as each model has some </span></span>
<span id="cb9-1265"><a href="#cb9-1265" aria-hidden="true" tabindex="-1"></a><span class="co"># environment variables, which adds up to over 20GB. </span></span>
<span id="cb9-1266"><a href="#cb9-1266" aria-hidden="true" tabindex="-1"></a><span class="co"># check this stack exchange thread to read more on it:</span></span>
<span id="cb9-1267"><a href="#cb9-1267" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/42230920/saverds-inflating-size-of-object/52372480</span></span>
<span id="cb9-1268"><a href="#cb9-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># the solution is to basically clear the environment from the terms </span></span>
<span id="cb9-1269"><a href="#cb9-1269" aria-hidden="true" tabindex="-1"></a><span class="co"># object. since it is pretty fast to run the survival analysis</span></span>
<span id="cb9-1270"><a href="#cb9-1270" aria-hidden="true" tabindex="-1"></a><span class="co"># we will not save the objects.</span></span>
<span id="cb9-1271"><a href="#cb9-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1272"><a href="#cb9-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1273"><a href="#cb9-1273" aria-hidden="true" tabindex="-1"></a><span class="co"># we now proceed to prepare the plots. since the survival result is </span></span>
<span id="cb9-1274"><a href="#cb9-1274" aria-hidden="true" tabindex="-1"></a><span class="co"># actually a large file, it is best to do all the plottings, save</span></span>
<span id="cb9-1275"><a href="#cb9-1275" aria-hidden="true" tabindex="-1"></a><span class="co"># them in other rds/pdf files and then use on the quarto markdown.</span></span>
<span id="cb9-1276"><a href="#cb9-1276" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise it is too slow to render the book. </span></span>
<span id="cb9-1277"><a href="#cb9-1277" aria-hidden="true" tabindex="-1"></a><span class="co"># the same is true for the statistics and coefficients available.</span></span>
<span id="cb9-1278"><a href="#cb9-1278" aria-hidden="true" tabindex="-1"></a>names_signatures <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-1279"><a href="#cb9-1279" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>,</span>
<span id="cb9-1280"><a href="#cb9-1280" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span> <span class="ot">=</span> <span class="st">"Estrogen Late"</span>,</span>
<span id="cb9-1281"><a href="#cb9-1281" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>,</span>
<span id="cb9-1282"><a href="#cb9-1282" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span> <span class="ot">=</span> <span class="st">"random 200 genes"</span>,</span>
<span id="cb9-1283"><a href="#cb9-1283" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span> <span class="ot">=</span> <span class="st">"random 18 genes"</span>,</span>
<span id="cb9-1284"><a href="#cb9-1284" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ER.pct"</span> <span class="ot">=</span> <span class="st">"ER percentage"</span></span>
<span id="cb9-1285"><a href="#cb9-1285" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1286"><a href="#cb9-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1287"><a href="#cb9-1287" aria-hidden="true" tabindex="-1"></a>names_coefficients <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-1288"><a href="#cb9-1288" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="fu">c</span>(</span>
<span id="cb9-1289"><a href="#cb9-1289" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"Age"</span>, </span>
<span id="cb9-1290"><a href="#cb9-1290" aria-hidden="true" tabindex="-1"></a>        <span class="st">"npi"</span> <span class="ot">=</span> <span class="st">"NPI"</span>, </span>
<span id="cb9-1291"><a href="#cb9-1291" aria-hidden="true" tabindex="-1"></a>        names_signatures</span>
<span id="cb9-1292"><a href="#cb9-1292" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1293"><a href="#cb9-1293" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="fu">c</span>(</span>
<span id="cb9-1294"><a href="#cb9-1294" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb9-1295"><a href="#cb9-1295" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb9-1296"><a href="#cb9-1296" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb9-1297"><a href="#cb9-1297" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2and3"</span> <span class="ot">=</span> <span class="st">"N2 and N3"</span>,</span>
<span id="cb9-1298"><a href="#cb9-1298" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT1"</span> <span class="ot">=</span> <span class="st">"T1"</span>,</span>
<span id="cb9-1299"><a href="#cb9-1299" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT2"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb9-1300"><a href="#cb9-1300" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT3"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb9-1301"><a href="#cb9-1301" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1302"><a href="#cb9-1302" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="fu">c</span>(</span>
<span id="cb9-1303"><a href="#cb9-1303" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb9-1304"><a href="#cb9-1304" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stage"</span> <span class="ot">=</span> <span class="st">"Tumor Stage"</span>,</span>
<span id="cb9-1305"><a href="#cb9-1305" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb9-1306"><a href="#cb9-1306" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb9-1307"><a href="#cb9-1307" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2"</span> <span class="ot">=</span> <span class="st">"N2"</span>,</span>
<span id="cb9-1308"><a href="#cb9-1308" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN3"</span> <span class="ot">=</span> <span class="st">"N3"</span>,</span>
<span id="cb9-1309"><a href="#cb9-1309" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stagestage_ii"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb9-1310"><a href="#cb9-1310" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stagestage_iii"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb9-1311"><a href="#cb9-1311" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-1312"><a href="#cb9-1312" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_er =</span> <span class="fu">c</span>(</span>
<span id="cb9-1313"><a href="#cb9-1313" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb9-1314"><a href="#cb9-1314" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb9-1315"><a href="#cb9-1315" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb9-1316"><a href="#cb9-1316" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2and3"</span> <span class="ot">=</span> <span class="st">"N2 and N3"</span>,</span>
<span id="cb9-1317"><a href="#cb9-1317" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT1"</span> <span class="ot">=</span> <span class="st">"T1"</span>,</span>
<span id="cb9-1318"><a href="#cb9-1318" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT2"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb9-1319"><a href="#cb9-1319" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT3"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb9-1320"><a href="#cb9-1320" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1321"><a href="#cb9-1321" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1322"><a href="#cb9-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1323"><a href="#cb9-1323" aria-hidden="true" tabindex="-1"></a>names_coefficients <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-1324"><a href="#cb9-1324" aria-hidden="true" tabindex="-1"></a>    names_coefficients,</span>
<span id="cb9-1325"><a href="#cb9-1325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb9-1326"><a href="#cb9-1326" aria-hidden="true" tabindex="-1"></a>        <span class="at">scanb_low_er =</span> names_coefficients<span class="sc">$</span>scanb_high_er,</span>
<span id="cb9-1327"><a href="#cb9-1327" aria-hidden="true" tabindex="-1"></a>        <span class="at">scanb_high_esr1 =</span> names_coefficients<span class="sc">$</span>scanb_high_er,</span>
<span id="cb9-1328"><a href="#cb9-1328" aria-hidden="true" tabindex="-1"></a>        <span class="at">metabric_high_esr1 =</span> names_coefficients<span class="sc">$</span>metabric</span>
<span id="cb9-1329"><a href="#cb9-1329" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1330"><a href="#cb9-1330" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1331"><a href="#cb9-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1332"><a href="#cb9-1332" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-1333"><a href="#cb9-1333" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"Lum A/B, ER+ BC"</span>,</span>
<span id="cb9-1334"><a href="#cb9-1334" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"Endo Only, ER+ BC"</span>,</span>
<span id="cb9-1335"><a href="#cb9-1335" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"Endo Only, ER+ BC"</span>,</span>
<span id="cb9-1336"><a href="#cb9-1336" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_er =</span> <span class="st">"Endo Only, ER+ BC, ER% &gt;= 90"</span>,</span>
<span id="cb9-1337"><a href="#cb9-1337" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_low_er =</span> <span class="st">"Endo Only, ER+ BC, ER% &lt; 90"</span>,</span>
<span id="cb9-1338"><a href="#cb9-1338" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_esr1 =</span> <span class="st">"Endo Only, ER+ BC, ESR1 (log2FPKM) &gt;= 7.5"</span>,</span>
<span id="cb9-1339"><a href="#cb9-1339" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric_high_esr1 =</span> <span class="st">"Endo Only, ER+ BC,</span><span class="sc">\n</span><span class="st">ESR1 (median intensity) &gt;= 11.5"</span></span>
<span id="cb9-1340"><a href="#cb9-1340" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1341"><a href="#cb9-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1342"><a href="#cb9-1342" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb9-1343"><a href="#cb9-1343" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(</span>
<span id="cb9-1344"><a href="#cb9-1344" aria-hidden="true" tabindex="-1"></a>        <span class="st">"../results/plots/surv_analysis_estrogen/forest_plots/"</span>,</span>
<span id="cb9-1345"><a href="#cb9-1345" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">"pdf"</span>, <span class="st">"png"</span>)</span>
<span id="cb9-1346"><a href="#cb9-1346" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb9-1347"><a href="#cb9-1347" aria-hidden="true" tabindex="-1"></a>    dir.create,</span>
<span id="cb9-1348"><a href="#cb9-1348" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb9-1349"><a href="#cb9-1349" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb9-1350"><a href="#cb9-1350" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1351"><a href="#cb9-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1352"><a href="#cb9-1352" aria-hidden="true" tabindex="-1"></a>forest_plots <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb9-1353"><a href="#cb9-1353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(fits, type_analysis){</span>
<span id="cb9-1354"><a href="#cb9-1354" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb9-1355"><a href="#cb9-1355" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(cohort_fits, name_cohort, type_analysis){</span>
<span id="cb9-1356"><a href="#cb9-1356" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mapply</span>(</span>
<span id="cb9-1357"><a href="#cb9-1357" aria-hidden="true" tabindex="-1"></a>                    forest_plot_fits,</span>
<span id="cb9-1358"><a href="#cb9-1358" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fit =</span> cohort_fits,</span>
<span id="cb9-1359"><a href="#cb9-1359" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name_signature =</span> <span class="fu">names</span>(cohort_fits),</span>
<span id="cb9-1360"><a href="#cb9-1360" aria-hidden="true" tabindex="-1"></a>                    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb9-1361"><a href="#cb9-1361" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cohort =</span> name_cohort,</span>
<span id="cb9-1362"><a href="#cb9-1362" aria-hidden="true" tabindex="-1"></a>                        <span class="at">names_coefficients =</span> names_coefficients,</span>
<span id="cb9-1363"><a href="#cb9-1363" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type_survival =</span> <span class="fu">toupper</span>(type_analysis),</span>
<span id="cb9-1364"><a href="#cb9-1364" aria-hidden="true" tabindex="-1"></a>                        <span class="at">patients =</span> patients[[name_cohort]],</span>
<span id="cb9-1365"><a href="#cb9-1365" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#clip = c(0.1, 2),</span></span>
<span id="cb9-1366"><a href="#cb9-1366" aria-hidden="true" tabindex="-1"></a>                        <span class="at">width =</span> <span class="dv">6</span>, </span>
<span id="cb9-1367"><a href="#cb9-1367" aria-hidden="true" tabindex="-1"></a>                        <span class="at">height =</span> <span class="dv">4</span>, </span>
<span id="cb9-1368"><a href="#cb9-1368" aria-hidden="true" tabindex="-1"></a>                        <span class="at">path_to_save =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1369"><a href="#cb9-1369" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"../results/plots/surv_analysis_estrogen"</span>,</span>
<span id="cb9-1370"><a href="#cb9-1370" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"/forest_plots/"</span>  </span>
<span id="cb9-1371"><a href="#cb9-1371" aria-hidden="true" tabindex="-1"></a>                        ) </span>
<span id="cb9-1372"><a href="#cb9-1372" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb9-1373"><a href="#cb9-1373" aria-hidden="true" tabindex="-1"></a>                    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1374"><a href="#cb9-1374" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1375"><a href="#cb9-1375" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-1376"><a href="#cb9-1376" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-1377"><a href="#cb9-1377" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb9-1378"><a href="#cb9-1378" aria-hidden="true" tabindex="-1"></a>            <span class="at">cohort_fits =</span> fits,</span>
<span id="cb9-1379"><a href="#cb9-1379" aria-hidden="true" tabindex="-1"></a>            <span class="at">name_cohort =</span> <span class="fu">names</span>(fits),</span>
<span id="cb9-1380"><a href="#cb9-1380" aria-hidden="true" tabindex="-1"></a>            <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">type_analysis =</span> type_analysis),</span>
<span id="cb9-1381"><a href="#cb9-1381" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1382"><a href="#cb9-1382" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1383"><a href="#cb9-1383" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1384"><a href="#cb9-1384" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-1385"><a href="#cb9-1385" aria-hidden="true" tabindex="-1"></a>    survival_results,</span>
<span id="cb9-1386"><a href="#cb9-1386" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(survival_results),</span>
<span id="cb9-1387"><a href="#cb9-1387" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-1388"><a href="#cb9-1388" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1389"><a href="#cb9-1389" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1390"><a href="#cb9-1390" aria-hidden="true" tabindex="-1"></a><span class="co"># all forest plots are saved as a pdf in the </span></span>
<span id="cb9-1391"><a href="#cb9-1391" aria-hidden="true" tabindex="-1"></a><span class="co"># results/plots/surv_analysis_estrogen folder and</span></span>
<span id="cb9-1392"><a href="#cb9-1392" aria-hidden="true" tabindex="-1"></a><span class="co"># as a rds file in the folder below.</span></span>
<span id="cb9-1393"><a href="#cb9-1393" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb9-1394"><a href="#cb9-1394" aria-hidden="true" tabindex="-1"></a>    forest_plots,</span>
<span id="cb9-1395"><a href="#cb9-1395" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/forest_plots.rds"</span></span>
<span id="cb9-1396"><a href="#cb9-1396" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1397"><a href="#cb9-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1398"><a href="#cb9-1398" aria-hidden="true" tabindex="-1"></a><span class="co"># and now we fetch the tables that will be used later on including the</span></span>
<span id="cb9-1399"><a href="#cb9-1399" aria-hidden="true" tabindex="-1"></a><span class="co"># confidence intervals and other parameters from the fit</span></span>
<span id="cb9-1400"><a href="#cb9-1400" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb9-1401"><a href="#cb9-1401" aria-hidden="true" tabindex="-1"></a>    survival_results, </span>
<span id="cb9-1402"><a href="#cb9-1402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) </span>
<span id="cb9-1403"><a href="#cb9-1403" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb9-1404"><a href="#cb9-1404" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb9-1405"><a href="#cb9-1405" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(y)</span>
<span id="cb9-1406"><a href="#cb9-1406" aria-hidden="true" tabindex="-1"></a>                <span class="fu">lapply</span>(</span>
<span id="cb9-1407"><a href="#cb9-1407" aria-hidden="true" tabindex="-1"></a>                    y,</span>
<span id="cb9-1408"><a href="#cb9-1408" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>(z) broom<span class="sc">::</span><span class="fu">tidy</span>(</span>
<span id="cb9-1409"><a href="#cb9-1409" aria-hidden="true" tabindex="-1"></a>                        z, </span>
<span id="cb9-1410"><a href="#cb9-1410" aria-hidden="true" tabindex="-1"></a>                        <span class="at">exponentiate =</span> <span class="cn">TRUE</span>, </span>
<span id="cb9-1411"><a href="#cb9-1411" aria-hidden="true" tabindex="-1"></a>                        <span class="at">conf.int =</span> <span class="cn">TRUE</span></span>
<span id="cb9-1412"><a href="#cb9-1412" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb9-1413"><a href="#cb9-1413" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"score"</span>)</span>
<span id="cb9-1414"><a href="#cb9-1414" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>)</span>
<span id="cb9-1415"><a href="#cb9-1415" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"type_analysis"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1416"><a href="#cb9-1416" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">HR =</span> estimate)</span>
<span id="cb9-1417"><a href="#cb9-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1418"><a href="#cb9-1418" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb9-1419"><a href="#cb9-1419" aria-hidden="true" tabindex="-1"></a>    tables_survival,</span>
<span id="cb9-1420"><a href="#cb9-1420" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/surv_analysis_estrogen/survival_results.csv"</span>,</span>
<span id="cb9-1421"><a href="#cb9-1421" aria-hidden="true" tabindex="-1"></a>    <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1422"><a href="#cb9-1422" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1423"><a href="#cb9-1423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1424"><a href="#cb9-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1427"><a href="#cb9-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1428"><a href="#cb9-1428" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(</span>
<span id="cb9-1429"><a href="#cb9-1429" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/surv_analysis_estrogen/survival_results.csv"</span></span>
<span id="cb9-1430"><a href="#cb9-1430" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1431"><a href="#cb9-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1432"><a href="#cb9-1432" aria-hidden="true" tabindex="-1"></a>forest_plots <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb9-1433"><a href="#cb9-1433" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/forest_plots.rds"</span></span>
<span id="cb9-1434"><a href="#cb9-1434" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1435"><a href="#cb9-1435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1436"><a href="#cb9-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1437"><a href="#cb9-1437" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results</span></span>
<span id="cb9-1438"><a href="#cb9-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1439"><a href="#cb9-1439" aria-hidden="true" tabindex="-1"></a>The table below shows the results for each analysis performed for a specific</span>
<span id="cb9-1440"><a href="#cb9-1440" aria-hidden="true" tabindex="-1"></a>term. In order to understand the table the user can filter based on the term,</span>
<span id="cb9-1441"><a href="#cb9-1441" aria-hidden="true" tabindex="-1"></a>cohort and type of analysis. Since METABRIC has recurrence free survival (RFS)</span>
<span id="cb9-1442"><a href="#cb9-1442" aria-hidden="true" tabindex="-1"></a>and overall survival (OS), the results for both analysis are presented here. </span>
<span id="cb9-1443"><a href="#cb9-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1446"><a href="#cb9-1446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1447"><a href="#cb9-1447" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span> </span>
<span id="cb9-1448"><a href="#cb9-1448" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb"</span>, <span class="st">"tcga"</span>, <span class="st">"metabric"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-1449"><a href="#cb9-1449" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(term <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>, <span class="st">"SET_ERPR"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-1450"><a href="#cb9-1450" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>), <span class="at">filter =</span> <span class="st">'top'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1451"><a href="#cb9-1451" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatRound</span>(</span>
<span id="cb9-1452"><a href="#cb9-1452" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns=</span><span class="fu">c</span>(</span>
<span id="cb9-1453"><a href="#cb9-1453" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimate"</span>, <span class="st">"std.error"</span>, <span class="st">"statistic"</span>, <span class="st">"HR"</span></span>
<span id="cb9-1454"><a href="#cb9-1454" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb9-1455"><a href="#cb9-1455" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb9-1456"><a href="#cb9-1456" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1457"><a href="#cb9-1457" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatSignif</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"p.value"</span>))</span>
<span id="cb9-1458"><a href="#cb9-1458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1459"><a href="#cb9-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1460"><a href="#cb9-1460" aria-hidden="true" tabindex="-1"></a>The table above shows that $SET_{ER/PR}$ had a small hazard ratio (&lt; 1) in all</span>
<span id="cb9-1461"><a href="#cb9-1461" aria-hidden="true" tabindex="-1"></a>4 analysis performed. Moreover, for all cases where a measure of estrogen</span>
<span id="cb9-1462"><a href="#cb9-1462" aria-hidden="true" tabindex="-1"></a>signaling was used, the hazard ratio was below 1, indicating that the higher</span>
<span id="cb9-1463"><a href="#cb9-1463" aria-hidden="true" tabindex="-1"></a>the score, the less likely the patient is to suffer the event in a specific</span>
<span id="cb9-1464"><a href="#cb9-1464" aria-hidden="true" tabindex="-1"></a>timepoint. This indicates that ER signaling is actually something continuous</span>
<span id="cb9-1465"><a href="#cb9-1465" aria-hidden="true" tabindex="-1"></a>and not dichotomous.</span>
<span id="cb9-1466"><a href="#cb9-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1467"><a href="#cb9-1467" aria-hidden="true" tabindex="-1"></a>@fig-forest-plot shows the forest plot of HALLMARK_ESTROGEN_RESPONSE_EARLY for all </span>
<span id="cb9-1468"><a href="#cb9-1468" aria-hidden="true" tabindex="-1"></a>three cohorts. </span>
<span id="cb9-1469"><a href="#cb9-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1470"><a href="#cb9-1470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb9-1471"><a href="#cb9-1471" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-forest-plot</span></span>
<span id="cb9-1472"><a href="#cb9-1472" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Forest plots of the different cohorts and their hazard ratios.</span></span>
<span id="cb9-1473"><a href="#cb9-1473" aria-hidden="true" tabindex="-1"></a><span class="co">#|     The bars correspond to 95% confidence interval.</span></span>
<span id="cb9-1474"><a href="#cb9-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1475"><a href="#cb9-1475" aria-hidden="true" tabindex="-1"></a><span class="co"># we use the workaround described here:</span></span>
<span id="cb9-1476"><a href="#cb9-1476" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/71266791/combine-several-forestplot-object-in-one-graph-in-r</span></span>
<span id="cb9-1477"><a href="#cb9-1477" aria-hidden="true" tabindex="-1"></a><span class="co"># we convert the forest plots to grob and then used gridExtra to </span></span>
<span id="cb9-1478"><a href="#cb9-1478" aria-hidden="true" tabindex="-1"></a><span class="co"># plot into the output</span></span>
<span id="cb9-1479"><a href="#cb9-1479" aria-hidden="true" tabindex="-1"></a>which_pathway <span class="ot">&lt;-</span> <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span></span>
<span id="cb9-1480"><a href="#cb9-1480" aria-hidden="true" tabindex="-1"></a>plots_estrogen_early <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb9-1481"><a href="#cb9-1481" aria-hidden="true" tabindex="-1"></a>    forest_plots<span class="sc">$</span>os, </span>
<span id="cb9-1482"><a href="#cb9-1482" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x){</span>
<span id="cb9-1483"><a href="#cb9-1483" aria-hidden="true" tabindex="-1"></a>        ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(x[[which_pathway]]))</span>
<span id="cb9-1484"><a href="#cb9-1484" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb9-1485"><a href="#cb9-1485" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1486"><a href="#cb9-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1487"><a href="#cb9-1487" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-1488"><a href="#cb9-1488" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>tcga, </span>
<span id="cb9-1489"><a href="#cb9-1489" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>scanb,</span>
<span id="cb9-1490"><a href="#cb9-1490" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>metabric</span>
<span id="cb9-1491"><a href="#cb9-1491" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1492"><a href="#cb9-1492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1493"><a href="#cb9-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1494"><a href="#cb9-1494" aria-hidden="true" tabindex="-1"></a>The hazard ratios are all below 1 and small for HALLMARK_ESTROGEN_RESPONSE_EARLY.</span>
<span id="cb9-1495"><a href="#cb9-1495" aria-hidden="true" tabindex="-1"></a>The variability changes depending on the cohort, </span>
<span id="cb9-1496"><a href="#cb9-1496" aria-hidden="true" tabindex="-1"></a>specially because they have different follow-up times, </span>
<span id="cb9-1497"><a href="#cb9-1497" aria-hidden="true" tabindex="-1"></a>SCANB being the shortest. TCGA has very few number of events and we could</span>
<span id="cb9-1498"><a href="#cb9-1498" aria-hidden="true" tabindex="-1"></a>not select based on the treatment, the results for TCGA are less reliable.</span>
<span id="cb9-1499"><a href="#cb9-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1500"><a href="#cb9-1500" aria-hidden="true" tabindex="-1"></a>Below we show the results for recurrence free survival.</span>
<span id="cb9-1501"><a href="#cb9-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1502"><a href="#cb9-1502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=7, fig.width = 6}</span></span>
<span id="cb9-1503"><a href="#cb9-1503" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-forest-plot-rfs</span></span>
<span id="cb9-1504"><a href="#cb9-1504" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Forest plots of the different cohorts and their hazard ratios.</span></span>
<span id="cb9-1505"><a href="#cb9-1505" aria-hidden="true" tabindex="-1"></a><span class="co">#|     The bars correspond to 95% confidence interval.</span></span>
<span id="cb9-1506"><a href="#cb9-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1507"><a href="#cb9-1507" aria-hidden="true" tabindex="-1"></a><span class="co"># we use the workaround described here:</span></span>
<span id="cb9-1508"><a href="#cb9-1508" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/71266791/combine-several-forestplot-object-in-one-graph-in-r</span></span>
<span id="cb9-1509"><a href="#cb9-1509" aria-hidden="true" tabindex="-1"></a><span class="co"># we convert the forest plots to grob and then used gridExtra to </span></span>
<span id="cb9-1510"><a href="#cb9-1510" aria-hidden="true" tabindex="-1"></a><span class="co"># plot into the output</span></span>
<span id="cb9-1511"><a href="#cb9-1511" aria-hidden="true" tabindex="-1"></a>which_pathway <span class="ot">&lt;-</span> <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span></span>
<span id="cb9-1512"><a href="#cb9-1512" aria-hidden="true" tabindex="-1"></a>plots_estrogen_early <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb9-1513"><a href="#cb9-1513" aria-hidden="true" tabindex="-1"></a>    forest_plots<span class="sc">$</span>rfs, </span>
<span id="cb9-1514"><a href="#cb9-1514" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x){</span>
<span id="cb9-1515"><a href="#cb9-1515" aria-hidden="true" tabindex="-1"></a>        ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(x[[which_pathway]]))</span>
<span id="cb9-1516"><a href="#cb9-1516" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb9-1517"><a href="#cb9-1517" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1518"><a href="#cb9-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1519"><a href="#cb9-1519" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-1520"><a href="#cb9-1520" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>scanb,</span>
<span id="cb9-1521"><a href="#cb9-1521" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>metabric</span>
<span id="cb9-1522"><a href="#cb9-1522" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1523"><a href="#cb9-1523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1524"><a href="#cb9-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1525"><a href="#cb9-1525" aria-hidden="true" tabindex="-1"></a>And @fig-surv-all-cohorts is a different way of display the same results</span>
<span id="cb9-1526"><a href="#cb9-1526" aria-hidden="true" tabindex="-1"></a>but only including the hazard ratios of the variables of interest. </span>
<span id="cb9-1527"><a href="#cb9-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1528"><a href="#cb9-1528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=12, fig.height=7}</span></span>
<span id="cb9-1529"><a href="#cb9-1529" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Hazard ratios for estrogen early and SET ER/PR for all the</span></span>
<span id="cb9-1530"><a href="#cb9-1530" aria-hidden="true" tabindex="-1"></a><span class="co">#|      three cohorts of only endocrine treated patients with ER+ BC. </span></span>
<span id="cb9-1531"><a href="#cb9-1531" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-surv-all-cohorts</span></span>
<span id="cb9-1532"><a href="#cb9-1532" aria-hidden="true" tabindex="-1"></a>terms_to_plot <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-1533"><a href="#cb9-1533" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>, </span>
<span id="cb9-1534"><a href="#cb9-1534" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span></span>
<span id="cb9-1535"><a href="#cb9-1535" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1536"><a href="#cb9-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1537"><a href="#cb9-1537" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span></span>
<span id="cb9-1538"><a href="#cb9-1538" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-1539"><a href="#cb9-1539" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">%in%</span> <span class="fu">names</span>(terms_to_plot) <span class="sc">&amp;</span> </span>
<span id="cb9-1540"><a href="#cb9-1540" aria-hidden="true" tabindex="-1"></a>            cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tcga"</span>, <span class="st">"scanb"</span>, <span class="st">"metabric"</span>)</span>
<span id="cb9-1541"><a href="#cb9-1541" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1542"><a href="#cb9-1542" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb9-1543"><a href="#cb9-1543" aria-hidden="true" tabindex="-1"></a>        <span class="at">cohort =</span> <span class="fu">toupper</span>(cohort),</span>
<span id="cb9-1544"><a href="#cb9-1544" aria-hidden="true" tabindex="-1"></a>        <span class="at">type_analysis =</span> <span class="fu">toupper</span>(type_analysis),</span>
<span id="cb9-1545"><a href="#cb9-1545" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> terms_to_plot[term]</span>
<span id="cb9-1546"><a href="#cb9-1546" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-1547"><a href="#cb9-1547" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-1548"><a href="#cb9-1548" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> cohort, </span>
<span id="cb9-1549"><a href="#cb9-1549" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> estimate, </span>
<span id="cb9-1550"><a href="#cb9-1550" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmin =</span> conf.low, </span>
<span id="cb9-1551"><a href="#cb9-1551" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> conf.high</span>
<span id="cb9-1552"><a href="#cb9-1552" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb9-1553"><a href="#cb9-1553" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_pointrange</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb9-1554"><a href="#cb9-1554" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb9-1555"><a href="#cb9-1555" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-1556"><a href="#cb9-1556" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Hazard ratio (95% CI)"</span>,</span>
<span id="cb9-1557"><a href="#cb9-1557" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb9-1558"><a href="#cb9-1558" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1559"><a href="#cb9-1559" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Patients selected for survival analysis: SCAN-B ET only; METABRIC ET only;"</span>,</span>
<span id="cb9-1560"><a href="#cb9-1560" aria-hidden="true" tabindex="-1"></a>            <span class="st">" TCGA LumA/LumB</span><span class="sc">\n</span><span class="st">ER+ BC were subselected, ET: endocrine therapy treated"</span>,</span>
<span id="cb9-1561"><a href="#cb9-1561" aria-hidden="true" tabindex="-1"></a>            <span class="st">", OS: Overall survival, RFS: Recurrence free survival"</span></span>
<span id="cb9-1562"><a href="#cb9-1562" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1563"><a href="#cb9-1563" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-1564"><a href="#cb9-1564" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(type_analysis <span class="sc">~</span> term, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb9-1565"><a href="#cb9-1565" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span> </span>
<span id="cb9-1566"><a href="#cb9-1566" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb9-1567"><a href="#cb9-1567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-1568"><a href="#cb9-1568" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.caption =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>))</span>
<span id="cb9-1569"><a href="#cb9-1569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1570"><a href="#cb9-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1571"><a href="#cb9-1571" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of ER IHC and molecular ER signaling</span></span>
<span id="cb9-1572"><a href="#cb9-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1573"><a href="#cb9-1573" aria-hidden="true" tabindex="-1"></a>The new released dataset from the SCANB consortium contains the ER </span>
<span id="cb9-1574"><a href="#cb9-1574" aria-hidden="true" tabindex="-1"></a>percentage based on the IHC stainings. This is great, because we can</span>
<span id="cb9-1575"><a href="#cb9-1575" aria-hidden="true" tabindex="-1"></a>now compare the molecular ER signaling score to what is seen in the clinics.</span>
<span id="cb9-1576"><a href="#cb9-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1577"><a href="#cb9-1577" aria-hidden="true" tabindex="-1"></a>First we start by comparing the molecular score with the percentages </span>
<span id="cb9-1578"><a href="#cb9-1578" aria-hidden="true" tabindex="-1"></a>(@fig-cor-ihc-rna).</span>
<span id="cb9-1579"><a href="#cb9-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1580"><a href="#cb9-1580" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=10}</span></span>
<span id="cb9-1581"><a href="#cb9-1581" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cor-ihc-rna</span></span>
<span id="cb9-1582"><a href="#cb9-1582" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between ER IHC percentage and molecular ER signaling</span></span>
<span id="cb9-1583"><a href="#cb9-1583" aria-hidden="true" tabindex="-1"></a><span class="co">#|     by using the signature HALLMARK_ESTROGEN_RESPONSE_EARLY and SET ER/PR.</span></span>
<span id="cb9-1584"><a href="#cb9-1584" aria-hidden="true" tabindex="-1"></a>esr1_levels <span class="ot">&lt;-</span> <span class="fu">assay</span>(datasets<span class="sc">$</span>scanb, <span class="st">"logFPKM"</span>)[<span class="st">"ESR1"</span>, ]</span>
<span id="cb9-1585"><a href="#cb9-1585" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1586"><a href="#cb9-1586" aria-hidden="true" tabindex="-1"></a>df_wide <span class="ot">&lt;-</span> datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb9-1587"><a href="#cb9-1587" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb9-1588"><a href="#cb9-1588" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1589"><a href="#cb9-1589" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels)</span>
<span id="cb9-1590"><a href="#cb9-1590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1591"><a href="#cb9-1591" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df_wide <span class="sc">%&gt;%</span></span>
<span id="cb9-1592"><a href="#cb9-1592" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-1593"><a href="#cb9-1593" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, SET_ERPR, <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>),</span>
<span id="cb9-1594"><a href="#cb9-1594" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb9-1595"><a href="#cb9-1595" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb9-1596"><a href="#cb9-1596" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb9-1597"><a href="#cb9-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1598"><a href="#cb9-1598" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb9-1599"><a href="#cb9-1599" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-1600"><a href="#cb9-1600" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> ER.pct, </span>
<span id="cb9-1601"><a href="#cb9-1601" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb9-1602"><a href="#cb9-1602" aria-hidden="true" tabindex="-1"></a>        <span class="co">#color = TreatGroup</span></span>
<span id="cb9-1603"><a href="#cb9-1603" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb9-1604"><a href="#cb9-1604" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb9-1605"><a href="#cb9-1605" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="co">#, mapping = aes(shape = pam50)) +</span></span>
<span id="cb9-1606"><a href="#cb9-1606" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb9-1607"><a href="#cb9-1607" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-1608"><a href="#cb9-1608" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER percentage"</span>,</span>
<span id="cb9-1609"><a href="#cb9-1609" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Molecular score"</span>,</span>
<span id="cb9-1610"><a href="#cb9-1610" aria-hidden="true" tabindex="-1"></a>        <span class="co">#shape = "Treatment group",</span></span>
<span id="cb9-1611"><a href="#cb9-1611" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb9-1612"><a href="#cb9-1612" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1613"><a href="#cb9-1613" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between ER IHC percentage</span><span class="sc">\n</span><span class="st">and"</span>,</span>
<span id="cb9-1614"><a href="#cb9-1614" aria-hidden="true" tabindex="-1"></a>            <span class="st">" molecular ER signaling score"</span></span>
<span id="cb9-1615"><a href="#cb9-1615" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1616"><a href="#cb9-1616" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb9-1617"><a href="#cb9-1617" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-1618"><a href="#cb9-1618" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb9-1619"><a href="#cb9-1619" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df)) <span class="sc">+</span></span>
<span id="cb9-1620"><a href="#cb9-1620" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-1621"><a href="#cb9-1621" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb9-1622"><a href="#cb9-1622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1623"><a href="#cb9-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1624"><a href="#cb9-1624" aria-hidden="true" tabindex="-1"></a>The first thing that one can notice is that ER percentage is very discrete,</span>
<span id="cb9-1625"><a href="#cb9-1625" aria-hidden="true" tabindex="-1"></a>pathologists probably don't assign non rounded percentage values, which </span>
<span id="cb9-1626"><a href="#cb9-1626" aria-hidden="true" tabindex="-1"></a>makes sense. Another thing to notice is that for high ER percentage </span>
<span id="cb9-1627"><a href="#cb9-1627" aria-hidden="true" tabindex="-1"></a>patients you have a whole spectrum of molecular ER signaling score.</span>
<span id="cb9-1628"><a href="#cb9-1628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1629"><a href="#cb9-1629" aria-hidden="true" tabindex="-1"></a>The spearman correlation for Estrogen early and ER IHC is:</span>
<span id="cb9-1630"><a href="#cb9-1630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1633"><a href="#cb9-1633" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1634"><a href="#cb9-1634" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(</span>
<span id="cb9-1635"><a href="#cb9-1635" aria-hidden="true" tabindex="-1"></a>    df_wide<span class="sc">$</span>ER.pct,</span>
<span id="cb9-1636"><a href="#cb9-1636" aria-hidden="true" tabindex="-1"></a>    df_wide<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY,</span>
<span id="cb9-1637"><a href="#cb9-1637" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"spearman"</span>, </span>
<span id="cb9-1638"><a href="#cb9-1638" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1639"><a href="#cb9-1639" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1640"><a href="#cb9-1640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1641"><a href="#cb9-1641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1642"><a href="#cb9-1642" aria-hidden="true" tabindex="-1"></a>For SET ER/PR is:</span>
<span id="cb9-1643"><a href="#cb9-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1646"><a href="#cb9-1646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1647"><a href="#cb9-1647" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(</span>
<span id="cb9-1648"><a href="#cb9-1648" aria-hidden="true" tabindex="-1"></a>    df_wide<span class="sc">$</span>ER.pct,</span>
<span id="cb9-1649"><a href="#cb9-1649" aria-hidden="true" tabindex="-1"></a>    df_wide<span class="sc">$</span>SET_ERPR,</span>
<span id="cb9-1650"><a href="#cb9-1650" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"spearman"</span>, </span>
<span id="cb9-1651"><a href="#cb9-1651" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1652"><a href="#cb9-1652" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1653"><a href="#cb9-1653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1654"><a href="#cb9-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1655"><a href="#cb9-1655" aria-hidden="true" tabindex="-1"></a>And finally for log(ESR1) is:</span>
<span id="cb9-1656"><a href="#cb9-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1659"><a href="#cb9-1659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1660"><a href="#cb9-1660" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(</span>
<span id="cb9-1661"><a href="#cb9-1661" aria-hidden="true" tabindex="-1"></a>    df_wide<span class="sc">$</span>ER.pct,</span>
<span id="cb9-1662"><a href="#cb9-1662" aria-hidden="true" tabindex="-1"></a>    df_wide<span class="sc">$</span><span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>,</span>
<span id="cb9-1663"><a href="#cb9-1663" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"spearman"</span>, </span>
<span id="cb9-1664"><a href="#cb9-1664" aria-hidden="true" tabindex="-1"></a>    <span class="at">exact =</span> <span class="cn">FALSE</span></span>
<span id="cb9-1665"><a href="#cb9-1665" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1666"><a href="#cb9-1666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1667"><a href="#cb9-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1668"><a href="#cb9-1668" aria-hidden="true" tabindex="-1"></a>Now we look speficially at the high ER percentage patients and compare</span>
<span id="cb9-1669"><a href="#cb9-1669" aria-hidden="true" tabindex="-1"></a>their ER signaling scores. We previously saw that the distribution</span>
<span id="cb9-1670"><a href="#cb9-1670" aria-hidden="true" tabindex="-1"></a>of these scores seems to be wide.</span>
<span id="cb9-1671"><a href="#cb9-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1672"><a href="#cb9-1672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=7, fig.height=10}</span></span>
<span id="cb9-1673"><a href="#cb9-1673" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-high-er</span></span>
<span id="cb9-1674"><a href="#cb9-1674" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for high ER percentage breast cancer patients.</span></span>
<span id="cb9-1675"><a href="#cb9-1675" aria-hidden="true" tabindex="-1"></a>df_scores_scanb_high_er <span class="ot">&lt;-</span> datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb9-1676"><a href="#cb9-1676" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb9-1677"><a href="#cb9-1677" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1678"><a href="#cb9-1678" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1679"><a href="#cb9-1679" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) </span>
<span id="cb9-1680"><a href="#cb9-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1681"><a href="#cb9-1681" aria-hidden="true" tabindex="-1"></a>df_scores_scanb_high_er <span class="sc">%&gt;%</span></span>
<span id="cb9-1682"><a href="#cb9-1682" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-1683"><a href="#cb9-1683" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, SET_ERPR, <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>),</span>
<span id="cb9-1684"><a href="#cb9-1684" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb9-1685"><a href="#cb9-1685" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb9-1686"><a href="#cb9-1686" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-1687"><a href="#cb9-1687" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-1688"><a href="#cb9-1688" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> score</span>
<span id="cb9-1689"><a href="#cb9-1689" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb9-1690"><a href="#cb9-1690" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span> </span>
<span id="cb9-1691"><a href="#cb9-1691" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ggplot2::geom_density(alpha = 0.5) + </span></span>
<span id="cb9-1692"><a href="#cb9-1692" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-1693"><a href="#cb9-1693" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Score"</span>,</span>
<span id="cb9-1694"><a href="#cb9-1694" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1695"><a href="#cb9-1695" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Scores for high ER IHC (over 90%)</span><span class="sc">\n</span><span class="st">percentage BC patients"</span>,</span>
<span id="cb9-1696"><a href="#cb9-1696" aria-hidden="true" tabindex="-1"></a>            <span class="st">" ("</span>, <span class="fu">nrow</span>(df_scores_scanb_high_er), <span class="st">" pts)"</span></span>
<span id="cb9-1697"><a href="#cb9-1697" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-1698"><a href="#cb9-1698" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb9-1699"><a href="#cb9-1699" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb9-1700"><a href="#cb9-1700" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-1701"><a href="#cb9-1701" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span> </span>
<span id="cb9-1702"><a href="#cb9-1702" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb9-1703"><a href="#cb9-1703" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">16</span>),</span>
<span id="cb9-1704"><a href="#cb9-1704" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>), </span>
<span id="cb9-1705"><a href="#cb9-1705" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb9-1706"><a href="#cb9-1706" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb9-1707"><a href="#cb9-1707" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)</span>
<span id="cb9-1708"><a href="#cb9-1708" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1709"><a href="#cb9-1709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1710"><a href="#cb9-1710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1711"><a href="#cb9-1711" aria-hidden="true" tabindex="-1"></a>@fig-scores-high-er shows how the distributions are not skewed towards</span>
<span id="cb9-1712"><a href="#cb9-1712" aria-hidden="true" tabindex="-1"></a>high values only. It looks like there is a step in the SET ER/PR signature,</span>
<span id="cb9-1713"><a href="#cb9-1713" aria-hidden="true" tabindex="-1"></a>we now compare with the ESR1 values and hallmark estrogen response early.</span>
<span id="cb9-1714"><a href="#cb9-1714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1715"><a href="#cb9-1715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=7}</span></span>
<span id="cb9-1716"><a href="#cb9-1716" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-seter-others</span></span>
<span id="cb9-1717"><a href="#cb9-1717" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between SET ER/PR and other scores.</span></span>
<span id="cb9-1718"><a href="#cb9-1718" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb9-1719"><a href="#cb9-1719" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb9-1720"><a href="#cb9-1720" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1721"><a href="#cb9-1721" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) <span class="sc">%&gt;%</span></span>
<span id="cb9-1722"><a href="#cb9-1722" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-1723"><a href="#cb9-1723" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>),</span>
<span id="cb9-1724"><a href="#cb9-1724" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb9-1725"><a href="#cb9-1725" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb9-1726"><a href="#cb9-1726" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb9-1727"><a href="#cb9-1727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1728"><a href="#cb9-1728" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb9-1729"><a href="#cb9-1729" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-1730"><a href="#cb9-1730" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> SET_ERPR, </span>
<span id="cb9-1731"><a href="#cb9-1731" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb9-1732"><a href="#cb9-1732" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb9-1733"><a href="#cb9-1733" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb9-1734"><a href="#cb9-1734" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb9-1735"><a href="#cb9-1735" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb9-1736"><a href="#cb9-1736" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-1737"><a href="#cb9-1737" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">expression</span>(SET[ER<span class="sc">/</span>PR]),</span>
<span id="cb9-1738"><a href="#cb9-1738" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Score"</span>,</span>
<span id="cb9-1739"><a href="#cb9-1739" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb9-1740"><a href="#cb9-1740" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1741"><a href="#cb9-1741" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between SET ER/PR and"</span>,</span>
<span id="cb9-1742"><a href="#cb9-1742" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">Estrogen Early, log(ESR1)"</span></span>
<span id="cb9-1743"><a href="#cb9-1743" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1744"><a href="#cb9-1744" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb9-1745"><a href="#cb9-1745" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-1746"><a href="#cb9-1746" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span> </span>
<span id="cb9-1747"><a href="#cb9-1747" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df)) <span class="sc">+</span></span>
<span id="cb9-1748"><a href="#cb9-1748" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-1749"><a href="#cb9-1749" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() </span>
<span id="cb9-1750"><a href="#cb9-1750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1751"><a href="#cb9-1751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1752"><a href="#cb9-1752" aria-hidden="true" tabindex="-1"></a>There is a highly positive correlation. Also interesting to see that </span>
<span id="cb9-1753"><a href="#cb9-1753" aria-hidden="true" tabindex="-1"></a>ESR1 levels are not necessarily highly correlated with high </span>
<span id="cb9-1754"><a href="#cb9-1754" aria-hidden="true" tabindex="-1"></a>SET ER/PR scores. Remember that for ESR1 the scale is </span>
<span id="cb9-1755"><a href="#cb9-1755" aria-hidden="true" tabindex="-1"></a>logarithmic, so even if the slope is smaller than in the</span>
<span id="cb9-1756"><a href="#cb9-1756" aria-hidden="true" tabindex="-1"></a>hallmark estrogen response early, it might mean a higher correlation</span>
<span id="cb9-1757"><a href="#cb9-1757" aria-hidden="true" tabindex="-1"></a>even..</span>
<span id="cb9-1758"><a href="#cb9-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1759"><a href="#cb9-1759" aria-hidden="true" tabindex="-1"></a>@fig-er-hist shows the distribution of the ER IHC percentage for the</span>
<span id="cb9-1760"><a href="#cb9-1760" aria-hidden="true" tabindex="-1"></a>patients used in the previous survival analysis for SCANB. </span>
<span id="cb9-1761"><a href="#cb9-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1764"><a href="#cb9-1764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1765"><a href="#cb9-1765" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-hist</span></span>
<span id="cb9-1766"><a href="#cb9-1766" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Histogram of ER IHC percentage of the SCANB samples used</span></span>
<span id="cb9-1767"><a href="#cb9-1767" aria-hidden="true" tabindex="-1"></a><span class="co">#|     for survival analysis</span></span>
<span id="cb9-1768"><a href="#cb9-1768" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb9-1769"><a href="#cb9-1769" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb9-1770"><a href="#cb9-1770" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-1771"><a href="#cb9-1771" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_samples) <span class="sc">%&gt;%</span></span>
<span id="cb9-1772"><a href="#cb9-1772" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ER.pct)) <span class="sc">+</span></span>
<span id="cb9-1773"><a href="#cb9-1773" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb9-1774"><a href="#cb9-1774" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-1775"><a href="#cb9-1775" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER percentage"</span>,</span>
<span id="cb9-1776"><a href="#cb9-1776" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1777"><a href="#cb9-1777" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ER IHC percentage of the patients"</span>,</span>
<span id="cb9-1778"><a href="#cb9-1778" aria-hidden="true" tabindex="-1"></a>            <span class="st">" selected for survival analysis"</span></span>
<span id="cb9-1779"><a href="#cb9-1779" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1780"><a href="#cb9-1780" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-1781"><a href="#cb9-1781" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) </span>
<span id="cb9-1782"><a href="#cb9-1782" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1783"><a href="#cb9-1783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1784"><a href="#cb9-1784" aria-hidden="true" tabindex="-1"></a>We see that the majority of the patients actually have already pretty</span>
<span id="cb9-1785"><a href="#cb9-1785" aria-hidden="true" tabindex="-1"></a>high percentage. It could be that the results of the overall survival </span>
<span id="cb9-1786"><a href="#cb9-1786" aria-hidden="true" tabindex="-1"></a>analysis are actually driven by the the low ER percentage patients,</span>
<span id="cb9-1787"><a href="#cb9-1787" aria-hidden="true" tabindex="-1"></a>so we performed the survival analysis only on patients with ER percentage</span>
<span id="cb9-1788"><a href="#cb9-1788" aria-hidden="true" tabindex="-1"></a>equal or higher than 90%. The table below shows the total number of </span>
<span id="cb9-1789"><a href="#cb9-1789" aria-hidden="true" tabindex="-1"></a>patients for each analysis.</span>
<span id="cb9-1790"><a href="#cb9-1790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1793"><a href="#cb9-1793" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1794"><a href="#cb9-1794" aria-hidden="true" tabindex="-1"></a>nb_pts_events</span>
<span id="cb9-1795"><a href="#cb9-1795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1796"><a href="#cb9-1796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1797"><a href="#cb9-1797" aria-hidden="true" tabindex="-1"></a>There was a decrease of around 200 patients with 80 events less, so indeed</span>
<span id="cb9-1798"><a href="#cb9-1798" aria-hidden="true" tabindex="-1"></a>a lot of those patients with lower ER percentage had died. @fig-er-ihc-survival</span>
<span id="cb9-1799"><a href="#cb9-1799" aria-hidden="true" tabindex="-1"></a>shows the results of the survival analysis when considering the ER IHC </span>
<span id="cb9-1800"><a href="#cb9-1800" aria-hidden="true" tabindex="-1"></a>percentage as a continuous score on SCANB.</span>
<span id="cb9-1801"><a href="#cb9-1801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1804"><a href="#cb9-1804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1805"><a href="#cb9-1805" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-survival</span></span>
<span id="cb9-1806"><a href="#cb9-1806" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage as the score instead</span></span>
<span id="cb9-1807"><a href="#cb9-1807" aria-hidden="true" tabindex="-1"></a><span class="co">#|     of the common molecular ER signaling scores</span></span>
<span id="cb9-1808"><a href="#cb9-1808" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-1809"><a href="#cb9-1809" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb[[<span class="st">"ER.pct"</span>]]))</span>
<span id="cb9-1810"><a href="#cb9-1810" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1811"><a href="#cb9-1811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1812"><a href="#cb9-1812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1813"><a href="#cb9-1813" aria-hidden="true" tabindex="-1"></a>We a very tight confidence interval in this case with a HR very close</span>
<span id="cb9-1814"><a href="#cb9-1814" aria-hidden="true" tabindex="-1"></a>to 1, meaning that for every 1% increase there is a 2% decrease in your </span>
<span id="cb9-1815"><a href="#cb9-1815" aria-hidden="true" tabindex="-1"></a>risk of dying. The table with the values is shown below.</span>
<span id="cb9-1816"><a href="#cb9-1816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1819"><a href="#cb9-1819" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1820"><a href="#cb9-1820" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span></span>
<span id="cb9-1821"><a href="#cb9-1821" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span> <span class="sc">&amp;</span> term <span class="sc">==</span> <span class="st">"ER.pct"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-1822"><a href="#cb9-1822" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-1823"><a href="#cb9-1823" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatSignif</span>(<span class="fu">c</span>(</span>
<span id="cb9-1824"><a href="#cb9-1824" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimate"</span>, <span class="st">"std.error"</span>, <span class="st">"statistic"</span>,</span>
<span id="cb9-1825"><a href="#cb9-1825" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p.value"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span>,</span>
<span id="cb9-1826"><a href="#cb9-1826" aria-hidden="true" tabindex="-1"></a>        <span class="st">"HR"</span></span>
<span id="cb9-1827"><a href="#cb9-1827" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb9-1828"><a href="#cb9-1828" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1829"><a href="#cb9-1829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1830"><a href="#cb9-1830" aria-hidden="true" tabindex="-1"></a>Next we selected only patients that had 90% or more ER IHC percentage </span>
<span id="cb9-1831"><a href="#cb9-1831" aria-hidden="true" tabindex="-1"></a>to perform the survival analysis. @fig-er-ihc-high-os shows the results</span>
<span id="cb9-1832"><a href="#cb9-1832" aria-hidden="true" tabindex="-1"></a>for both the analysis done on ER IHC percentage,  </span>
<span id="cb9-1833"><a href="#cb9-1833" aria-hidden="true" tabindex="-1"></a>HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR.</span>
<span id="cb9-1834"><a href="#cb9-1834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1835"><a href="#cb9-1835" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb9-1836"><a href="#cb9-1836" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-high-os</span></span>
<span id="cb9-1837"><a href="#cb9-1837" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb9-1838"><a href="#cb9-1838" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb9-1839"><a href="#cb9-1839" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with 90% or more in the ER IHC were selected.</span></span>
<span id="cb9-1840"><a href="#cb9-1840" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-1841"><a href="#cb9-1841" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_high_er<span class="sc">$</span>ER.pct)),</span>
<span id="cb9-1842"><a href="#cb9-1842" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_high_er<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY)),</span>
<span id="cb9-1843"><a href="#cb9-1843" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_high_er<span class="sc">$</span>SET_ERPR))</span>
<span id="cb9-1844"><a href="#cb9-1844" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1845"><a href="#cb9-1845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1846"><a href="#cb9-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1847"><a href="#cb9-1847" aria-hidden="true" tabindex="-1"></a>When performing the survival analysis among the high ER percentage, there is</span>
<span id="cb9-1848"><a href="#cb9-1848" aria-hidden="true" tabindex="-1"></a>no evidence to differentiate between 90 to 100%, but by using the molecular</span>
<span id="cb9-1849"><a href="#cb9-1849" aria-hidden="true" tabindex="-1"></a>scores that fact is still true, showing that perhaps the molecular score</span>
<span id="cb9-1850"><a href="#cb9-1850" aria-hidden="true" tabindex="-1"></a>could be more sensitive for these patients. </span>
<span id="cb9-1851"><a href="#cb9-1851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1852"><a href="#cb9-1852" aria-hidden="true" tabindex="-1"></a>We can also analyse the recurrence free survival for this cohort </span>
<span id="cb9-1853"><a href="#cb9-1853" aria-hidden="true" tabindex="-1"></a>(@fig-er-ihc-high-rfs).</span>
<span id="cb9-1854"><a href="#cb9-1854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1855"><a href="#cb9-1855" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb9-1856"><a href="#cb9-1856" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-high-rfs</span></span>
<span id="cb9-1857"><a href="#cb9-1857" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb9-1858"><a href="#cb9-1858" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb9-1859"><a href="#cb9-1859" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with 90% or more in the ER IHC were selected.</span></span>
<span id="cb9-1860"><a href="#cb9-1860" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-1861"><a href="#cb9-1861" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_er<span class="sc">$</span>ER.pct)),</span>
<span id="cb9-1862"><a href="#cb9-1862" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_er<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY)),</span>
<span id="cb9-1863"><a href="#cb9-1863" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_er<span class="sc">$</span>SET_ERPR))</span>
<span id="cb9-1864"><a href="#cb9-1864" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1865"><a href="#cb9-1865" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1866"><a href="#cb9-1866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1867"><a href="#cb9-1867" aria-hidden="true" tabindex="-1"></a>The problem now is that the number of events is much smaller, so the</span>
<span id="cb9-1868"><a href="#cb9-1868" aria-hidden="true" tabindex="-1"></a>confidence intervals for the estimates will be bigger. We see</span>
<span id="cb9-1869"><a href="#cb9-1869" aria-hidden="true" tabindex="-1"></a>that for both signatures the HR is way below 1, meaning that </span>
<span id="cb9-1870"><a href="#cb9-1870" aria-hidden="true" tabindex="-1"></a>the higher the score the better it is for the patient. Also the </span>
<span id="cb9-1871"><a href="#cb9-1871" aria-hidden="true" tabindex="-1"></a>hazard ratio decreased in this case.</span>
<span id="cb9-1872"><a href="#cb9-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1873"><a href="#cb9-1873" aria-hidden="true" tabindex="-1"></a>Another way of visualizing as previously is shown below </span>
<span id="cb9-1874"><a href="#cb9-1874" aria-hidden="true" tabindex="-1"></a>(@fig-surv-high-er-ihc-ggplot2).</span>
<span id="cb9-1875"><a href="#cb9-1875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1876"><a href="#cb9-1876" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=5}</span></span>
<span id="cb9-1877"><a href="#cb9-1877" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Hazard ratios for estrogen early and SET ER/PR for all the</span></span>
<span id="cb9-1878"><a href="#cb9-1878" aria-hidden="true" tabindex="-1"></a><span class="co">#|      three cohorts of only endocrine treated patients with ER+ BC. </span></span>
<span id="cb9-1879"><a href="#cb9-1879" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-surv-high-er-ihc-ggplot2</span></span>
<span id="cb9-1880"><a href="#cb9-1880" aria-hidden="true" tabindex="-1"></a>terms_to_plot <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-1881"><a href="#cb9-1881" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>, </span>
<span id="cb9-1882"><a href="#cb9-1882" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>,</span>
<span id="cb9-1883"><a href="#cb9-1883" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ER.pct"</span> <span class="ot">=</span> <span class="st">"ER IHC"</span></span>
<span id="cb9-1884"><a href="#cb9-1884" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-1885"><a href="#cb9-1885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1886"><a href="#cb9-1886" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span></span>
<span id="cb9-1887"><a href="#cb9-1887" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb9-1888"><a href="#cb9-1888" aria-hidden="true" tabindex="-1"></a>        term <span class="sc">%in%</span> <span class="fu">names</span>(terms_to_plot) <span class="sc">&amp;</span> </span>
<span id="cb9-1889"><a href="#cb9-1889" aria-hidden="true" tabindex="-1"></a>            cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb_high_er"</span>)</span>
<span id="cb9-1890"><a href="#cb9-1890" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-1891"><a href="#cb9-1891" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb9-1892"><a href="#cb9-1892" aria-hidden="true" tabindex="-1"></a>        <span class="at">type_analysis =</span> <span class="fu">toupper</span>(type_analysis),</span>
<span id="cb9-1893"><a href="#cb9-1893" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> terms_to_plot[term]</span>
<span id="cb9-1894"><a href="#cb9-1894" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-1895"><a href="#cb9-1895" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb9-1896"><a href="#cb9-1896" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> term, </span>
<span id="cb9-1897"><a href="#cb9-1897" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> estimate, </span>
<span id="cb9-1898"><a href="#cb9-1898" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmin =</span> conf.low, </span>
<span id="cb9-1899"><a href="#cb9-1899" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> conf.high</span>
<span id="cb9-1900"><a href="#cb9-1900" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb9-1901"><a href="#cb9-1901" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_pointrange</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb9-1902"><a href="#cb9-1902" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb9-1903"><a href="#cb9-1903" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb9-1904"><a href="#cb9-1904" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Hazard ratio (95% CI)"</span>,</span>
<span id="cb9-1905"><a href="#cb9-1905" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb9-1906"><a href="#cb9-1906" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-1907"><a href="#cb9-1907" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Only endocrine therapy treated patients with high ER IHC index"</span>,</span>
<span id="cb9-1908"><a href="#cb9-1908" aria-hidden="true" tabindex="-1"></a>            <span class="st">" were selected."</span></span>
<span id="cb9-1909"><a href="#cb9-1909" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1910"><a href="#cb9-1910" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-1911"><a href="#cb9-1911" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>type_analysis, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-1912"><a href="#cb9-1912" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">30</span>) <span class="sc">+</span> </span>
<span id="cb9-1913"><a href="#cb9-1913" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb9-1914"><a href="#cb9-1914" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb9-1915"><a href="#cb9-1915" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">plot.caption =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>))</span>
<span id="cb9-1916"><a href="#cb9-1916" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1917"><a href="#cb9-1917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1918"><a href="#cb9-1918" aria-hidden="true" tabindex="-1"></a>To further validate the ER signaling we partitionate the score in </span>
<span id="cb9-1919"><a href="#cb9-1919" aria-hidden="true" tabindex="-1"></a>4 different categories, low, intermediate, high, ultra high and perform</span>
<span id="cb9-1920"><a href="#cb9-1920" aria-hidden="true" tabindex="-1"></a>the OS and RFS analysis.</span>
<span id="cb9-1921"><a href="#cb9-1921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1922"><a href="#cb9-1922" aria-hidden="true" tabindex="-1"></a>For SET ER/PR the results are:</span>
<span id="cb9-1923"><a href="#cb9-1923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1926"><a href="#cb9-1926" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-1927"><a href="#cb9-1927" aria-hidden="true" tabindex="-1"></a>sig_dich_survival <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb9-1928"><a href="#cb9-1928" aria-hidden="true" tabindex="-1"></a>    df, </span>
<span id="cb9-1929"><a href="#cb9-1929" aria-hidden="true" tabindex="-1"></a>    signature_dichotomization,</span>
<span id="cb9-1930"><a href="#cb9-1930" aria-hidden="true" tabindex="-1"></a>    samples_to_use</span>
<span id="cb9-1931"><a href="#cb9-1931" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb9-1932"><a href="#cb9-1932" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1933"><a href="#cb9-1933" aria-hidden="true" tabindex="-1"></a>    quantile_signature <span class="ot">&lt;-</span> <span class="fu">quantile</span>(df[, signature_dichotomization])</span>
<span id="cb9-1934"><a href="#cb9-1934" aria-hidden="true" tabindex="-1"></a>    signature_values <span class="ot">&lt;-</span> df[, signature_dichotomization]</span>
<span id="cb9-1935"><a href="#cb9-1935" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>sig_dich <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb9-1936"><a href="#cb9-1936" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">between</span>(</span>
<span id="cb9-1937"><a href="#cb9-1937" aria-hidden="true" tabindex="-1"></a>            signature_values,</span>
<span id="cb9-1938"><a href="#cb9-1938" aria-hidden="true" tabindex="-1"></a>            quantile_signature[<span class="dv">1</span>], quantile_signature[<span class="dv">2</span>]</span>
<span id="cb9-1939"><a href="#cb9-1939" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">~</span> <span class="st">"low"</span>,</span>
<span id="cb9-1940"><a href="#cb9-1940" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">between</span>(</span>
<span id="cb9-1941"><a href="#cb9-1941" aria-hidden="true" tabindex="-1"></a>            signature_values,</span>
<span id="cb9-1942"><a href="#cb9-1942" aria-hidden="true" tabindex="-1"></a>            quantile_signature[<span class="dv">2</span>], quantile_signature[<span class="dv">3</span>]</span>
<span id="cb9-1943"><a href="#cb9-1943" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">~</span> <span class="st">"intermediate"</span>,</span>
<span id="cb9-1944"><a href="#cb9-1944" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">between</span>(</span>
<span id="cb9-1945"><a href="#cb9-1945" aria-hidden="true" tabindex="-1"></a>            signature_values,</span>
<span id="cb9-1946"><a href="#cb9-1946" aria-hidden="true" tabindex="-1"></a>            quantile_signature[<span class="dv">3</span>], quantile_signature[<span class="dv">4</span>]</span>
<span id="cb9-1947"><a href="#cb9-1947" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">~</span> <span class="st">"high"</span>,</span>
<span id="cb9-1948"><a href="#cb9-1948" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">between</span>(</span>
<span id="cb9-1949"><a href="#cb9-1949" aria-hidden="true" tabindex="-1"></a>            signature_values,</span>
<span id="cb9-1950"><a href="#cb9-1950" aria-hidden="true" tabindex="-1"></a>            quantile_signature[<span class="dv">4</span>], quantile_signature[<span class="dv">5</span>]</span>
<span id="cb9-1951"><a href="#cb9-1951" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">~</span> <span class="st">"ultra_high"</span>,</span>
<span id="cb9-1952"><a href="#cb9-1952" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1953"><a href="#cb9-1953" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1954"><a href="#cb9-1954" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>sig_dich <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb9-1955"><a href="#cb9-1955" aria-hidden="true" tabindex="-1"></a>        df<span class="sc">$</span>sig_dich,</span>
<span id="cb9-1956"><a href="#cb9-1956" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"low"</span>, <span class="st">"intermediate"</span>, <span class="st">"high"</span>, <span class="st">"ultra_high"</span>)</span>
<span id="cb9-1957"><a href="#cb9-1957" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1958"><a href="#cb9-1958" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1959"><a href="#cb9-1959" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1960"><a href="#cb9-1960" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> samples_to_use) </span>
<span id="cb9-1961"><a href="#cb9-1961" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1962"><a href="#cb9-1962" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb9-1963"><a href="#cb9-1963" aria-hidden="true" tabindex="-1"></a>        <span class="at">surv_results =</span> surv_results_sig_dich <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb9-1964"><a href="#cb9-1964" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Surv</span>(rfs_months, rfs_status) <span class="sc">~</span> sig_dich <span class="sc">+</span>  age <span class="sc">+</span> </span>
<span id="cb9-1965"><a href="#cb9-1965" aria-hidden="true" tabindex="-1"></a>                node_stage <span class="sc">+</span> tumor_stage,</span>
<span id="cb9-1966"><a href="#cb9-1966" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df</span>
<span id="cb9-1967"><a href="#cb9-1967" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-1968"><a href="#cb9-1968" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> df</span>
<span id="cb9-1969"><a href="#cb9-1969" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1970"><a href="#cb9-1970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1971"><a href="#cb9-1971" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-1972"><a href="#cb9-1972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1973"><a href="#cb9-1973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1974"><a href="#cb9-1974" aria-hidden="true" tabindex="-1"></a>sig_dich_er_survival <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb9-1975"><a href="#cb9-1975" aria-hidden="true" tabindex="-1"></a>    df, </span>
<span id="cb9-1976"><a href="#cb9-1976" aria-hidden="true" tabindex="-1"></a>    signature_dichotomization,</span>
<span id="cb9-1977"><a href="#cb9-1977" aria-hidden="true" tabindex="-1"></a>    samples_to_use</span>
<span id="cb9-1978"><a href="#cb9-1978" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb9-1979"><a href="#cb9-1979" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1980"><a href="#cb9-1980" aria-hidden="true" tabindex="-1"></a>    quantile_signature <span class="ot">&lt;-</span> <span class="fu">quantile</span>(df[, signature_dichotomization], <span class="at">probs =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb9-1981"><a href="#cb9-1981" aria-hidden="true" tabindex="-1"></a>    signature_values <span class="ot">&lt;-</span> df[, signature_dichotomization]</span>
<span id="cb9-1982"><a href="#cb9-1982" aria-hidden="true" tabindex="-1"></a>    ER.pct <span class="ot">&lt;-</span> df<span class="sc">$</span>ER.pct</span>
<span id="cb9-1983"><a href="#cb9-1983" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>sig_dich <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb9-1984"><a href="#cb9-1984" aria-hidden="true" tabindex="-1"></a>        signature_values <span class="sc">&lt;</span> quantile_signature[<span class="dv">2</span>] <span class="sc">&amp;</span> ER.pct <span class="sc">&lt;</span> <span class="dv">90</span> <span class="sc">~</span> <span class="st">"lowERIHC_lowERsig"</span>,</span>
<span id="cb9-1985"><a href="#cb9-1985" aria-hidden="true" tabindex="-1"></a>        signature_values <span class="sc">&lt;</span> quantile_signature[<span class="dv">2</span>] <span class="sc">&amp;</span> ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span> <span class="sc">~</span> <span class="st">"highERIHC_lowERsig"</span>,</span>
<span id="cb9-1986"><a href="#cb9-1986" aria-hidden="true" tabindex="-1"></a>        signature_values <span class="sc">&gt;=</span> quantile_signature[<span class="dv">2</span>] <span class="sc">&amp;</span> ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span> <span class="sc">~</span> <span class="st">"highERIHC_highERsig"</span>,</span>
<span id="cb9-1987"><a href="#cb9-1987" aria-hidden="true" tabindex="-1"></a>        signature_values <span class="sc">&gt;=</span> quantile_signature[<span class="dv">2</span>] <span class="sc">&amp;</span> ER.pct <span class="sc">&lt;</span> <span class="dv">90</span> <span class="sc">~</span> <span class="st">"lowERIHC_highERsig"</span></span>
<span id="cb9-1988"><a href="#cb9-1988" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1989"><a href="#cb9-1989" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-1990"><a href="#cb9-1990" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>sig_dich <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb9-1991"><a href="#cb9-1991" aria-hidden="true" tabindex="-1"></a>        df<span class="sc">$</span>sig_dich,</span>
<span id="cb9-1992"><a href="#cb9-1992" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb9-1993"><a href="#cb9-1993" aria-hidden="true" tabindex="-1"></a>            <span class="st">"highERIHC_lowERsig"</span>,</span>
<span id="cb9-1994"><a href="#cb9-1994" aria-hidden="true" tabindex="-1"></a>            <span class="st">"highERIHC_highERsig"</span>,</span>
<span id="cb9-1995"><a href="#cb9-1995" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lowERIHC_lowERsig"</span>,</span>
<span id="cb9-1996"><a href="#cb9-1996" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lowERIHC_highERsig"</span></span>
<span id="cb9-1997"><a href="#cb9-1997" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-1998"><a href="#cb9-1998" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-1999"><a href="#cb9-1999" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-2000"><a href="#cb9-2000" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-2001"><a href="#cb9-2001" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> samples_to_use) </span>
<span id="cb9-2002"><a href="#cb9-2002" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-2003"><a href="#cb9-2003" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb9-2004"><a href="#cb9-2004" aria-hidden="true" tabindex="-1"></a>        <span class="at">surv_results =</span> surv_results_sig_dich <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb9-2005"><a href="#cb9-2005" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Surv</span>(rfs_months, rfs_status) <span class="sc">~</span> sig_dich <span class="sc">+</span>  age <span class="sc">+</span> </span>
<span id="cb9-2006"><a href="#cb9-2006" aria-hidden="true" tabindex="-1"></a>                node_stage <span class="sc">+</span> tumor_stage,</span>
<span id="cb9-2007"><a href="#cb9-2007" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df</span>
<span id="cb9-2008"><a href="#cb9-2008" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-2009"><a href="#cb9-2009" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> df</span>
<span id="cb9-2010"><a href="#cb9-2010" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-2011"><a href="#cb9-2011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2012"><a href="#cb9-2012" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-2013"><a href="#cb9-2013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2014"><a href="#cb9-2014" aria-hidden="true" tabindex="-1"></a>results_surv_dich <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb9-2015"><a href="#cb9-2015" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"SET_ERPR"</span>, <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>), </span>
<span id="cb9-2016"><a href="#cb9-2016" aria-hidden="true" tabindex="-1"></a>    sig_dich_survival, </span>
<span id="cb9-2017"><a href="#cb9-2017" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb9-2018"><a href="#cb9-2018" aria-hidden="true" tabindex="-1"></a>    <span class="at">samples_to_use =</span> scanb_high_er,</span>
<span id="cb9-2019"><a href="#cb9-2019" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb9-2020"><a href="#cb9-2020" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb9-2021"><a href="#cb9-2021" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2022"><a href="#cb9-2022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2023"><a href="#cb9-2023" aria-hidden="true" tabindex="-1"></a>results_surv_dich_er_sig <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb9-2024"><a href="#cb9-2024" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"SET_ERPR"</span>, <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>), </span>
<span id="cb9-2025"><a href="#cb9-2025" aria-hidden="true" tabindex="-1"></a>    sig_dich_er_survival, </span>
<span id="cb9-2026"><a href="#cb9-2026" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb9-2027"><a href="#cb9-2027" aria-hidden="true" tabindex="-1"></a>    <span class="at">samples_to_use =</span> scanb_samples,</span>
<span id="cb9-2028"><a href="#cb9-2028" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb9-2029"><a href="#cb9-2029" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb9-2030"><a href="#cb9-2030" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2031"><a href="#cb9-2031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2032"><a href="#cb9-2032" aria-hidden="true" tabindex="-1"></a>results_surv_dich_er_sig<span class="sc">$</span>SET_ERPR<span class="sc">$</span>surv_results</span>
<span id="cb9-2033"><a href="#cb9-2033" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2034"><a href="#cb9-2034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2035"><a href="#cb9-2035" aria-hidden="true" tabindex="-1"></a>For Estrogen early the results are:</span>
<span id="cb9-2036"><a href="#cb9-2036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2039"><a href="#cb9-2039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-2040"><a href="#cb9-2040" aria-hidden="true" tabindex="-1"></a>results_surv_dich_er_sig<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY<span class="sc">$</span>surv_results</span>
<span id="cb9-2041"><a href="#cb9-2041" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2042"><a href="#cb9-2042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2043"><a href="#cb9-2043" aria-hidden="true" tabindex="-1"></a>High ER sig and high ER IHC have a better outcome than high ER IHC and </span>
<span id="cb9-2044"><a href="#cb9-2044" aria-hidden="true" tabindex="-1"></a>low ER sig for both signatures.</span>
<span id="cb9-2045"><a href="#cb9-2045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2046"><a href="#cb9-2046" aria-hidden="true" tabindex="-1"></a>The table below shows the number of RFS events for each subgroup in the</span>
<span id="cb9-2047"><a href="#cb9-2047" aria-hidden="true" tabindex="-1"></a>SET ER/PR dichotomization procedure.</span>
<span id="cb9-2048"><a href="#cb9-2048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2051"><a href="#cb9-2051" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-2052"><a href="#cb9-2052" aria-hidden="true" tabindex="-1"></a>results_surv_dich_er_sig<span class="sc">$</span>SET_ERPR<span class="sc">$</span>df <span class="sc">%&gt;%</span></span>
<span id="cb9-2053"><a href="#cb9-2053" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(sig_dich, rfs_status) <span class="sc">%&gt;%</span></span>
<span id="cb9-2054"><a href="#cb9-2054" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_totals</span>(<span class="at">where =</span> <span class="st">"col"</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb9-2055"><a href="#cb9-2055" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_percentages</span>(<span class="st">"row"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-2056"><a href="#cb9-2056" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_pct_formatting</span>(<span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-2057"><a href="#cb9-2057" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_ns</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-2058"><a href="#cb9-2058" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">adorn_title</span>()</span>
<span id="cb9-2059"><a href="#cb9-2059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2060"><a href="#cb9-2060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2061"><a href="#cb9-2061" aria-hidden="true" tabindex="-1"></a>Next we show the Kaplan Meier estimate curves for both signatures.</span>
<span id="cb9-2062"><a href="#cb9-2062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2063"><a href="#cb9-2063" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=8}</span></span>
<span id="cb9-2064"><a href="#cb9-2064" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-km-seterpr</span></span>
<span id="cb9-2065"><a href="#cb9-2065" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Kaplan-Meier estimate of the categorized SET ER/PR signature</span></span>
<span id="cb9-2066"><a href="#cb9-2066" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(</span>
<span id="cb9-2067"><a href="#cb9-2067" aria-hidden="true" tabindex="-1"></a>    survival<span class="sc">::</span><span class="fu">Surv</span>(rfs_months, rfs_status) <span class="sc">~</span> sig_dich, </span>
<span id="cb9-2068"><a href="#cb9-2068" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> results_surv_dich_er_sig<span class="sc">$</span>SET_ERPR<span class="sc">$</span>df</span>
<span id="cb9-2069"><a href="#cb9-2069" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2070"><a href="#cb9-2070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2071"><a href="#cb9-2071" aria-hidden="true" tabindex="-1"></a>plot_fit_km <span class="ot">&lt;-</span> survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb9-2072"><a href="#cb9-2072" aria-hidden="true" tabindex="-1"></a>    fit,</span>
<span id="cb9-2073"><a href="#cb9-2073" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table =</span> <span class="cn">TRUE</span>, <span class="co"># Add risk table</span></span>
<span id="cb9-2074"><a href="#cb9-2074" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table.col =</span> <span class="st">"strata"</span>, <span class="co"># Change risk table color by groups</span></span>
<span id="cb9-2075"><a href="#cb9-2075" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"strata"</span>, <span class="co"># Change line type by groups</span></span>
<span id="cb9-2076"><a href="#cb9-2076" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) </span>
<span id="cb9-2077"><a href="#cb9-2077" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2078"><a href="#cb9-2078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2079"><a href="#cb9-2079" aria-hidden="true" tabindex="-1"></a>labels_er_ihc <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-2080"><a href="#cb9-2080" aria-hidden="true" tabindex="-1"></a>    <span class="st">"high ER IHC, low ER sig"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb9-2081"><a href="#cb9-2081" aria-hidden="true" tabindex="-1"></a>    <span class="st">"high ER IHC, high ER sig"</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb9-2082"><a href="#cb9-2082" aria-hidden="true" tabindex="-1"></a>    <span class="st">"low ER IHC, low ER sig"</span> <span class="ot">=</span> <span class="dv">3</span>,</span>
<span id="cb9-2083"><a href="#cb9-2083" aria-hidden="true" tabindex="-1"></a>    <span class="st">"low ER IHC, high ER sig"</span> <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb9-2084"><a href="#cb9-2084" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2085"><a href="#cb9-2085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2086"><a href="#cb9-2086" aria-hidden="true" tabindex="-1"></a>tidy_results_hr <span class="ot">&lt;-</span> results_surv_dich_er_sig<span class="sc">$</span>SET_ERPR<span class="sc">$</span>surv_results <span class="sc">%&gt;%</span> </span>
<span id="cb9-2087"><a href="#cb9-2087" aria-hidden="true" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-2088"><a href="#cb9-2088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2089"><a href="#cb9-2089" aria-hidden="true" tabindex="-1"></a>plot_fit_km<span class="sc">$</span>plot <span class="ot">&lt;-</span> plot_fit_km<span class="sc">$</span>plot <span class="sc">+</span></span>
<span id="cb9-2090"><a href="#cb9-2090" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"SET ER/PR</span><span class="sc">\n</span><span class="st">ER+ BC, Endo only, SCAN-B"</span>) <span class="sc">+</span> </span>
<span id="cb9-2091"><a href="#cb9-2091" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">names</span>(labels_er_ihc)) <span class="sc">+</span> </span>
<span id="cb9-2092"><a href="#cb9-2092" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_linetype_discrete</span>(<span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb9-2093"><a href="#cb9-2093" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">annotate</span>(</span>
<span id="cb9-2094"><a href="#cb9-2094" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>, </span>
<span id="cb9-2095"><a href="#cb9-2095" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="dv">40</span>, </span>
<span id="cb9-2096"><a href="#cb9-2096" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fl">0.3</span>, </span>
<span id="cb9-2097"><a href="#cb9-2097" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-2098"><a href="#cb9-2098" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Hazard ratios</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-2099"><a href="#cb9-2099" aria-hidden="true" tabindex="-1"></a>            <span class="st">"High ER IHC, High ER sig: "</span>, </span>
<span id="cb9-2100"><a href="#cb9-2100" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">1</span>, <span class="st">"estimate"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2101"><a href="#cb9-2101" aria-hidden="true" tabindex="-1"></a>                <span class="st">", p-value: "</span>, </span>
<span id="cb9-2102"><a href="#cb9-2102" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">1</span>, <span class="st">"p.value"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2103"><a href="#cb9-2103" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">Low ER IHC, Low ER sig: "</span>, </span>
<span id="cb9-2104"><a href="#cb9-2104" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">2</span>, <span class="st">"estimate"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2105"><a href="#cb9-2105" aria-hidden="true" tabindex="-1"></a>                <span class="st">", p-value: "</span>, </span>
<span id="cb9-2106"><a href="#cb9-2106" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">2</span>, <span class="st">"p.value"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2107"><a href="#cb9-2107" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">Low ER IHC, High ER sig: "</span>, </span>
<span id="cb9-2108"><a href="#cb9-2108" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">3</span>, <span class="st">"estimate"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2109"><a href="#cb9-2109" aria-hidden="true" tabindex="-1"></a>                <span class="st">", p-value: "</span>, </span>
<span id="cb9-2110"><a href="#cb9-2110" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">3</span>, <span class="st">"p.value"</span>]), <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb9-2111"><a href="#cb9-2111" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb9-2112"><a href="#cb9-2112" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb9-2113"><a href="#cb9-2113" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-2114"><a href="#cb9-2114" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Baseline group: high ER IHC and low ER sig is baseline</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-2115"><a href="#cb9-2115" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Thresholds: median of signature in the whole dataset, ER IHC 90%"</span></span>
<span id="cb9-2116"><a href="#cb9-2116" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb9-2117"><a href="#cb9-2117" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">2</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb9-2118"><a href="#cb9-2118" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb9-2119"><a href="#cb9-2119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2120"><a href="#cb9-2120" aria-hidden="true" tabindex="-1"></a>plot_fit_km<span class="sc">$</span>plot</span>
<span id="cb9-2121"><a href="#cb9-2121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2122"><a href="#cb9-2122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2123"><a href="#cb9-2123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2124"><a href="#cb9-2124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=8}</span></span>
<span id="cb9-2125"><a href="#cb9-2125" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-km-er-early</span></span>
<span id="cb9-2126"><a href="#cb9-2126" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Kaplan-Meier estimate of the categorized Estrogen early signature</span></span>
<span id="cb9-2127"><a href="#cb9-2127" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(</span>
<span id="cb9-2128"><a href="#cb9-2128" aria-hidden="true" tabindex="-1"></a>    survival<span class="sc">::</span><span class="fu">Surv</span>(rfs_months, rfs_status) <span class="sc">~</span> sig_dich, </span>
<span id="cb9-2129"><a href="#cb9-2129" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> results_surv_dich_er_sig<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY<span class="sc">$</span>df</span>
<span id="cb9-2130"><a href="#cb9-2130" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2131"><a href="#cb9-2131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2132"><a href="#cb9-2132" aria-hidden="true" tabindex="-1"></a>plot_fit_km <span class="ot">&lt;-</span> survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb9-2133"><a href="#cb9-2133" aria-hidden="true" tabindex="-1"></a>    fit,</span>
<span id="cb9-2134"><a href="#cb9-2134" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table =</span> <span class="cn">TRUE</span>, <span class="co"># Add risk table</span></span>
<span id="cb9-2135"><a href="#cb9-2135" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table.col =</span> <span class="st">"strata"</span>, <span class="co"># Change risk table color by groups</span></span>
<span id="cb9-2136"><a href="#cb9-2136" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"strata"</span>, <span class="co"># Change line type by groups</span></span>
<span id="cb9-2137"><a href="#cb9-2137" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>), </span>
<span id="cb9-2138"><a href="#cb9-2138" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2139"><a href="#cb9-2139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2140"><a href="#cb9-2140" aria-hidden="true" tabindex="-1"></a>labels_er_ihc <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-2141"><a href="#cb9-2141" aria-hidden="true" tabindex="-1"></a>    <span class="st">"high ER IHC, low ER sig"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb9-2142"><a href="#cb9-2142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"high ER IHC, high ER sig"</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb9-2143"><a href="#cb9-2143" aria-hidden="true" tabindex="-1"></a>    <span class="st">"low ER IHC, low ER sig"</span> <span class="ot">=</span> <span class="dv">3</span>,</span>
<span id="cb9-2144"><a href="#cb9-2144" aria-hidden="true" tabindex="-1"></a>    <span class="st">"low ER IHC, high ER sig"</span> <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb9-2145"><a href="#cb9-2145" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2146"><a href="#cb9-2146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2147"><a href="#cb9-2147" aria-hidden="true" tabindex="-1"></a>tidy_results_hr <span class="ot">&lt;-</span> results_surv_dich_er_sig<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY<span class="sc">$</span>surv_results <span class="sc">%&gt;%</span> </span>
<span id="cb9-2148"><a href="#cb9-2148" aria-hidden="true" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-2149"><a href="#cb9-2149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2150"><a href="#cb9-2150" aria-hidden="true" tabindex="-1"></a>plot_fit_km<span class="sc">$</span>plot <span class="ot">&lt;-</span> plot_fit_km<span class="sc">$</span>plot <span class="sc">+</span></span>
<span id="cb9-2151"><a href="#cb9-2151" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Estrogen early</span><span class="sc">\n</span><span class="st">ER+ BC, Endo only"</span>) <span class="sc">+</span> </span>
<span id="cb9-2152"><a href="#cb9-2152" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">names</span>(labels_er_ihc)) <span class="sc">+</span> </span>
<span id="cb9-2153"><a href="#cb9-2153" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_linetype_discrete</span>(<span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb9-2154"><a href="#cb9-2154" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">annotate</span>(</span>
<span id="cb9-2155"><a href="#cb9-2155" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>, </span>
<span id="cb9-2156"><a href="#cb9-2156" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="dv">40</span>, </span>
<span id="cb9-2157"><a href="#cb9-2157" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fl">0.3</span>, </span>
<span id="cb9-2158"><a href="#cb9-2158" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-2159"><a href="#cb9-2159" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Hazard ratios</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-2160"><a href="#cb9-2160" aria-hidden="true" tabindex="-1"></a>            <span class="st">"High ER IHC, High ER sig: "</span>, </span>
<span id="cb9-2161"><a href="#cb9-2161" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">1</span>, <span class="st">"estimate"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2162"><a href="#cb9-2162" aria-hidden="true" tabindex="-1"></a>                <span class="st">", p-value: "</span>, </span>
<span id="cb9-2163"><a href="#cb9-2163" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">1</span>, <span class="st">"p.value"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2164"><a href="#cb9-2164" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">Low ER IHC, Low ER sig: "</span>, </span>
<span id="cb9-2165"><a href="#cb9-2165" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">2</span>, <span class="st">"estimate"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2166"><a href="#cb9-2166" aria-hidden="true" tabindex="-1"></a>                <span class="st">", p-value: "</span>, </span>
<span id="cb9-2167"><a href="#cb9-2167" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">2</span>, <span class="st">"p.value"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2168"><a href="#cb9-2168" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">Low ER IHC, High ER sig: "</span>, </span>
<span id="cb9-2169"><a href="#cb9-2169" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">3</span>, <span class="st">"estimate"</span>]), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb9-2170"><a href="#cb9-2170" aria-hidden="true" tabindex="-1"></a>                <span class="st">", p-value: "</span>, </span>
<span id="cb9-2171"><a href="#cb9-2171" aria-hidden="true" tabindex="-1"></a>                <span class="fu">format</span>(<span class="fu">pull</span>(tidy_results_hr[<span class="dv">3</span>, <span class="st">"p.value"</span>]), <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb9-2172"><a href="#cb9-2172" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-2173"><a href="#cb9-2173" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb9-2174"><a href="#cb9-2174" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb9-2175"><a href="#cb9-2175" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Baseline group: high ER IHC and low ER sig is baseline</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-2176"><a href="#cb9-2176" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Thresholds: median of signature in the whole dataset, ER IHC 90%"</span></span>
<span id="cb9-2177"><a href="#cb9-2177" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb9-2178"><a href="#cb9-2178" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">2</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb9-2179"><a href="#cb9-2179" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb9-2180"><a href="#cb9-2180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2181"><a href="#cb9-2181" aria-hidden="true" tabindex="-1"></a>plot_fit_km<span class="sc">$</span>plot</span>
<span id="cb9-2182"><a href="#cb9-2182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2183"><a href="#cb9-2183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2184"><a href="#cb9-2184" aria-hidden="true" tabindex="-1"></a>In both cases there is a good distinction between low ER sig/High ER IHC and</span>
<span id="cb9-2185"><a href="#cb9-2185" aria-hidden="true" tabindex="-1"></a>High ER sig/Low ER IHC. Interestingly, there the worst group is really the</span>
<span id="cb9-2186"><a href="#cb9-2186" aria-hidden="true" tabindex="-1"></a>low ER sig/low ER IHC, as expected.</span>
<span id="cb9-2187"><a href="#cb9-2187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2188"><a href="#cb9-2188" aria-hidden="true" tabindex="-1"></a>We now evaluate the protective effect of the estrogen signaling signatures</span>
<span id="cb9-2189"><a href="#cb9-2189" aria-hidden="true" tabindex="-1"></a>in the patients that have tumors with ER IHC lower than 90%. </span>
<span id="cb9-2190"><a href="#cb9-2190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2191"><a href="#cb9-2191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb9-2192"><a href="#cb9-2192" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-low-rfs</span></span>
<span id="cb9-2193"><a href="#cb9-2193" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb9-2194"><a href="#cb9-2194" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb9-2195"><a href="#cb9-2195" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with less than 90% in the ER IHC were selected.</span></span>
<span id="cb9-2196"><a href="#cb9-2196" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-2197"><a href="#cb9-2197" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_low_er<span class="sc">$</span>ER.pct)),</span>
<span id="cb9-2198"><a href="#cb9-2198" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_low_er<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY)),</span>
<span id="cb9-2199"><a href="#cb9-2199" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_low_er<span class="sc">$</span>SET_ERPR))</span>
<span id="cb9-2200"><a href="#cb9-2200" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2201"><a href="#cb9-2201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2202"><a href="#cb9-2202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2203"><a href="#cb9-2203" aria-hidden="true" tabindex="-1"></a>The number of patients now is very low, but the effect is still there. </span>
<span id="cb9-2204"><a href="#cb9-2204" aria-hidden="true" tabindex="-1"></a>When we look at the survival. Below we show the results for the </span>
<span id="cb9-2205"><a href="#cb9-2205" aria-hidden="true" tabindex="-1"></a>overall survival.</span>
<span id="cb9-2206"><a href="#cb9-2206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2207"><a href="#cb9-2207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb9-2208"><a href="#cb9-2208" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-low-os</span></span>
<span id="cb9-2209"><a href="#cb9-2209" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb9-2210"><a href="#cb9-2210" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb9-2211"><a href="#cb9-2211" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with less than 90% in the ER IHC were selected.</span></span>
<span id="cb9-2212"><a href="#cb9-2212" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-2213"><a href="#cb9-2213" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_low_er<span class="sc">$</span>ER.pct)),</span>
<span id="cb9-2214"><a href="#cb9-2214" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_low_er<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY)),</span>
<span id="cb9-2215"><a href="#cb9-2215" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_low_er<span class="sc">$</span>SET_ERPR))</span>
<span id="cb9-2216"><a href="#cb9-2216" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2217"><a href="#cb9-2217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2218"><a href="#cb9-2218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2219"><a href="#cb9-2219" aria-hidden="true" tabindex="-1"></a>The hazard ratio is still below 1 but the uncertainty is much </span>
<span id="cb9-2220"><a href="#cb9-2220" aria-hidden="true" tabindex="-1"></a>higher, probably due to the number of patients and events. </span>
<span id="cb9-2221"><a href="#cb9-2221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2222"><a href="#cb9-2222" aria-hidden="true" tabindex="-1"></a>Another way of evaluating the effect of estrogen signaling and not only</span>
<span id="cb9-2223"><a href="#cb9-2223" aria-hidden="true" tabindex="-1"></a>the presence of the estrogen receptor protein or the mRNA transcripts, is</span>
<span id="cb9-2224"><a href="#cb9-2224" aria-hidden="true" tabindex="-1"></a>to check the patients whose tumor samples have high expression of ESR1. </span>
<span id="cb9-2225"><a href="#cb9-2225" aria-hidden="true" tabindex="-1"></a>We can perform such analysis in both METABRIC and SCANB. </span>
<span id="cb9-2226"><a href="#cb9-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2227"><a href="#cb9-2227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 7}</span></span>
<span id="cb9-2228"><a href="#cb9-2228" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-highesr1-rfs</span></span>
<span id="cb9-2229"><a href="#cb9-2229" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb9-2230"><a href="#cb9-2230" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb9-2231"><a href="#cb9-2231" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with more than 7.5 units of ESR1 </span></span>
<span id="cb9-2232"><a href="#cb9-2232" aria-hidden="true" tabindex="-1"></a><span class="co">#|     in the logFPKM scale were selected.</span></span>
<span id="cb9-2233"><a href="#cb9-2233" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-2234"><a href="#cb9-2234" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(</span>
<span id="cb9-2235"><a href="#cb9-2235" aria-hidden="true" tabindex="-1"></a>        forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_esr1<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY</span>
<span id="cb9-2236"><a href="#cb9-2236" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb9-2237"><a href="#cb9-2237" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_esr1<span class="sc">$</span>SET_ERPR))</span>
<span id="cb9-2238"><a href="#cb9-2238" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2239"><a href="#cb9-2239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2240"><a href="#cb9-2240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2241"><a href="#cb9-2241" aria-hidden="true" tabindex="-1"></a>The number of events is very small but the HR is very small also and confidence</span>
<span id="cb9-2242"><a href="#cb9-2242" aria-hidden="true" tabindex="-1"></a>interval is far away from 1. And now for METABRIC when we select all patients</span>
<span id="cb9-2243"><a href="#cb9-2243" aria-hidden="true" tabindex="-1"></a>of 3rd quantile and above (median intensity higher than 11.5).</span>
<span id="cb9-2244"><a href="#cb9-2244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2245"><a href="#cb9-2245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb9-2246"><a href="#cb9-2246" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-highesr1-rfs-metabric</span></span>
<span id="cb9-2247"><a href="#cb9-2247" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using  </span></span>
<span id="cb9-2248"><a href="#cb9-2248" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb9-2249"><a href="#cb9-2249" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with more than 11 units of ESR1 </span></span>
<span id="cb9-2250"><a href="#cb9-2250" aria-hidden="true" tabindex="-1"></a><span class="co">#|     in the log median intensity scale were selected.</span></span>
<span id="cb9-2251"><a href="#cb9-2251" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb9-2252"><a href="#cb9-2252" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(</span>
<span id="cb9-2253"><a href="#cb9-2253" aria-hidden="true" tabindex="-1"></a>        forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>metabric_high_esr1<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY</span>
<span id="cb9-2254"><a href="#cb9-2254" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb9-2255"><a href="#cb9-2255" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>metabric_high_esr1<span class="sc">$</span>SET_ERPR))</span>
<span id="cb9-2256"><a href="#cb9-2256" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-2257"><a href="#cb9-2257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2258"><a href="#cb9-2258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2259"><a href="#cb9-2259" aria-hidden="true" tabindex="-1"></a>The variability is way higher but the hazard ratio is still below 1 as </span>
<span id="cb9-2260"><a href="#cb9-2260" aria-hidden="true" tabindex="-1"></a>expected. In this case probably there are patients that have low score and</span>
<span id="cb9-2261"><a href="#cb9-2261" aria-hidden="true" tabindex="-1"></a>don't benefit as much from the treatment. @fig-er-signaling-highesr1-metabric</span>
<span id="cb9-2262"><a href="#cb9-2262" aria-hidden="true" tabindex="-1"></a>shows the distribution of ER signaling scores for those patients. We notice</span>
<span id="cb9-2263"><a href="#cb9-2263" aria-hidden="true" tabindex="-1"></a>that the average is very close to the peak of the distributions.</span>
<span id="cb9-2264"><a href="#cb9-2264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2265"><a href="#cb9-2265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=4}</span></span>
<span id="cb9-2266"><a href="#cb9-2266" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-signaling-highesr1-metabric</span></span>
<span id="cb9-2267"><a href="#cb9-2267" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(datasets<span class="sc">$</span>metabric) <span class="sc">%&gt;%</span></span>
<span id="cb9-2268"><a href="#cb9-2268" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-2269"><a href="#cb9-2269" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_high_esr1) <span class="sc">%&gt;%</span></span>
<span id="cb9-2270"><a href="#cb9-2270" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-2271"><a href="#cb9-2271" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"SET_ERPR"</span>, <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>)),</span>
<span id="cb9-2272"><a href="#cb9-2272" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb9-2273"><a href="#cb9-2273" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb9-2274"><a href="#cb9-2274" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-2275"><a href="#cb9-2275" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> score)) <span class="sc">+</span></span>
<span id="cb9-2276"><a href="#cb9-2276" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb9-2277"><a href="#cb9-2277" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb9-2278"><a href="#cb9-2278" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span>
<span id="cb9-2279"><a href="#cb9-2279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2280"><a href="#cb9-2280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2281"><a href="#cb9-2281" aria-hidden="true" tabindex="-1"></a>And below for all patients used for the full analysis on METABRIC.</span>
<span id="cb9-2282"><a href="#cb9-2282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2283"><a href="#cb9-2283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=4}</span></span>
<span id="cb9-2284"><a href="#cb9-2284" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-signaling-all-metabric</span></span>
<span id="cb9-2285"><a href="#cb9-2285" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(datasets<span class="sc">$</span>metabric) <span class="sc">%&gt;%</span></span>
<span id="cb9-2286"><a href="#cb9-2286" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb9-2287"><a href="#cb9-2287" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_samples) <span class="sc">%&gt;%</span></span>
<span id="cb9-2288"><a href="#cb9-2288" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb9-2289"><a href="#cb9-2289" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"SET_ERPR"</span>, <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>)),</span>
<span id="cb9-2290"><a href="#cb9-2290" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb9-2291"><a href="#cb9-2291" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb9-2292"><a href="#cb9-2292" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb9-2293"><a href="#cb9-2293" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> score)) <span class="sc">+</span></span>
<span id="cb9-2294"><a href="#cb9-2294" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb9-2295"><a href="#cb9-2295" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb9-2296"><a href="#cb9-2296" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span>
<span id="cb9-2297"><a href="#cb9-2297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-2298"><a href="#cb9-2298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2299"><a href="#cb9-2299" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb9-2300"><a href="#cb9-2300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2301"><a href="#cb9-2301" aria-hidden="true" tabindex="-1"></a>In this chapter we've shown that ER+ BC patients are very distinct</span>
<span id="cb9-2302"><a href="#cb9-2302" aria-hidden="true" tabindex="-1"></a>from each other, as it can be seen from the umap projections and </span>
<span id="cb9-2303"><a href="#cb9-2303" aria-hidden="true" tabindex="-1"></a>the subtypes. These patients might respond differently for endocrine therapy</span>
<span id="cb9-2304"><a href="#cb9-2304" aria-hidden="true" tabindex="-1"></a>as well, and this might depend on the ER signaling, how active it is. </span>
<span id="cb9-2305"><a href="#cb9-2305" aria-hidden="true" tabindex="-1"></a>Therefore, when deciding a treatment, more care should be taken with</span>
<span id="cb9-2306"><a href="#cb9-2306" aria-hidden="true" tabindex="-1"></a>ER+ BC patients and check their signaling scores somehow. The $SET_{ER/PR}$</span>
<span id="cb9-2307"><a href="#cb9-2307" aria-hidden="true" tabindex="-1"></a>signature is a good signature showing very good hazard ratios across</span>
<span id="cb9-2308"><a href="#cb9-2308" aria-hidden="true" tabindex="-1"></a>the different cohorts. This signature has also been validated on the clinics</span>
<span id="cb9-2309"><a href="#cb9-2309" aria-hidden="true" tabindex="-1"></a>for use.</span>
<span id="cb9-2310"><a href="#cb9-2310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2311"><a href="#cb9-2311" aria-hidden="true" tabindex="-1"></a>Knowing the ER signaling for a patient is very important when deciding</span>
<span id="cb9-2312"><a href="#cb9-2312" aria-hidden="true" tabindex="-1"></a>treatment, but not enough. What could be other alternatives for patients</span>
<span id="cb9-2313"><a href="#cb9-2313" aria-hidden="true" tabindex="-1"></a>that have low ER signaling and are still considered ER+? Should they use</span>
<span id="cb9-2314"><a href="#cb9-2314" aria-hidden="true" tabindex="-1"></a>only endocrine therapy or supplement it with something else? In the</span>
<span id="cb9-2315"><a href="#cb9-2315" aria-hidden="true" tabindex="-1"></a>next chapters we present a framework where we can take a look</span>
<span id="cb9-2316"><a href="#cb9-2316" aria-hidden="true" tabindex="-1"></a>at a more personalised approach for treatments. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chronchi">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/chronchi">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Molecular landscape: a new framework for personalized medicine in Breast Cancer. - 1&nbsp; Estrogen receptor status is continuous, not dichotomous</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./pca_merging.html" rel="next">
<link href="./intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.22/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="site_libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="site_libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="site_libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="site_libs/selectize-0.12.0/selectize.min.js"></script>
<link href="site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Molecular landscape: a new framework for personalized medicine in Breast Cancer.</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chronchi/molecular_landscape" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="sidebar-tool px-1"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surv_analysis_estrogen.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pca_merging.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scoring.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./risk_score.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk score model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discussion.html" class="sidebar-item-text sidebar-link">Discussion</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#loading-and-filtering-the-datasets" id="toc-loading-and-filtering-the-datasets" class="nav-link active" data-scroll-target="#loading-and-filtering-the-datasets"> <span class="header-section-number">1.1</span> Loading and filtering the datasets</a></li>
  <li><a href="#umap-projection-of-the-datasets" id="toc-umap-projection-of-the-datasets" class="nav-link" data-scroll-target="#umap-projection-of-the-datasets"> <span class="header-section-number">1.2</span> UMAP projection of the datasets</a></li>
  <li><a href="#calculating-scores" id="toc-calculating-scores" class="nav-link" data-scroll-target="#calculating-scores"> <span class="header-section-number">1.3</span> Calculating scores</a></li>
  <li><a href="#survival-analysis" id="toc-survival-analysis" class="nav-link" data-scroll-target="#survival-analysis"> <span class="header-section-number">1.4</span> Survival analysis</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"> <span class="header-section-number">1.4.1</span> Results</a></li>
  </ul></li>
  <li><a href="#comparison-of-er-ihc-and-molecular-er-signaling" id="toc-comparison-of-er-ihc-and-molecular-er-signaling" class="nav-link" data-scroll-target="#comparison-of-er-ihc-and-molecular-er-signaling"> <span class="header-section-number">1.5</span> Comparison of ER IHC and molecular ER signaling</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"> <span class="header-section-number">1.6</span> Conclusion</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chronchi/molecular_landscape/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>Currently in the clinics estrogen receptor (ER) status is treated as dichotomous condition. Either a breast cancer (BC) is ER positive (ER+) or ER negative (ER-). The threshold for ER+ cells usually is 1% or 10% of the cells positive in a IHC staining. The idea is that ER+ BC patients will receive endocrine therapy, usually tamoxifen or some aromatase inhibitor, for treatment. The problem is not all patients respond the same to these drugs and they also have different proportions of ER+ cells.</p>
<p>In this document we show how leveraging molecular information distinguishes ER+ BC patients and how one should look more carefully on ER status. In order to do this, estrogen related signatures: estrogen response early and late from MSigDB<span class="citation" data-cites="Subramanian2005">(<a href="references.html#ref-Subramanian2005" role="doc-biblioref">Subramanian et al. 2005</a>)</span> and <span class="math inline">\(SET_{ER/PR}\)</span><span class="citation" data-cites="Sinn2019">(<a href="references.html#ref-Sinn2019" role="doc-biblioref">Sinn et al. 2019</a>)</span>, are used to calculate scores for each BC patient. These scores then are used to calculate associations with survival analysis. When performing cox regression, we try to adjust for sensible covariates in order to reduce bias. Even though we are adjusting, it is very difficult to know if a covariate is missing in the regression. Thus, care should be always taken when interpreting these results.</p>
<p>This chapter is structure in the following way. First section corresponds to loading the datasets and then filtering them. Estrogen signatures scores are calculated using GSVA <span class="citation" data-cites="Hnzelmann2013">(<a href="references.html#ref-Hnzelmann2013" role="doc-biblioref">Hänzelmann, Castelo, and Guinney 2013</a>)</span>. Given the scores, cox regression can be performed adjusting for clinical variables. After this the Hazard ratios can be computed and interpreted along with their confidence intervals.</p>
<section id="loading-and-filtering-the-datasets" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="loading-and-filtering-the-datasets"><span class="header-section-number">1.1</span> Loading and filtering the datasets</h2>
<p>The preprocessing of the datasets is described in the website below: &gt; https://chronchi.github.io/transcriptomics</p>
<p>To check the code used here either click in the code button on the top right part of the page or check the github page (github.com/chronchi/molecular_landscape).</p>
<p>The TCGA, METABRIC and SCANB cohorts are used in this section here. They are the biggest cohort of Breast cancer patients in the world. Each datasets has an overall equal distribution of ER+ and ER- patients and similar age distribution.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>* The library is already synchronized with the lockfile.</code></pre>
</div>
</div>
<div class="cell">

</div>
<div class="cell">

</div>
</section>
<section id="umap-projection-of-the-datasets" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="umap-projection-of-the-datasets"><span class="header-section-number">1.2</span> UMAP projection of the datasets</h2>
<p>The plots below show how each patient is different in a molecular sense, and even inside each molecular subtype there are some differences. This indicates how different patients, at least molecularly. We only do the umap of samples that have a PAM50 molecular subtype assigned.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Assay being used: logFPKM_TMM 
Assay being used: logFPKM 
Assay being used: median_intensity </code></pre>
</div>
</div>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-surv-umap-all" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-surv-umap-all-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.1: UMAP projections of all three cohorts in the following order”:” TCGA, SCANB and METABRIC. They are colored by the PAM50 molecular subtype.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
<p>From the plots above we see a distinction of the different molecular subtypes.</p>
</section>
<section id="calculating-scores" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="calculating-scores"><span class="header-section-number">1.3</span> Calculating scores</h2>
<p>In order to calculate the scores, the package <code>msigdb</code> is used to load the hallmark data into R. The <span class="math inline">\(SET_{ER/PR}\)</span> is made of the following genes:</p>
<div class="cell">
<div class="cell-output-display">

<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> Affy </th>
   <th style="text-align:left;"> ID </th>
   <th style="text-align:left;"> is_target </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 202089_s_at </td>
   <td style="text-align:left;"> SLC39A6 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 203438_at </td>
   <td style="text-align:left;"> STC2 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 204508_s_at </td>
   <td style="text-align:left;"> CA12 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 205225_at </td>
   <td style="text-align:left;"> ESR1 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 205380_at </td>
   <td style="text-align:left;"> PDZK1 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 205440_s_at </td>
   <td style="text-align:left;"> NPY1R </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 205831_at </td>
   <td style="text-align:left;"> CD2 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 206401_s_at </td>
   <td style="text-align:left;"> MAPT </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 209123_at </td>
   <td style="text-align:left;"> QDPR </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 209309_at </td>
   <td style="text-align:left;"> AZGP1 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 209459_s_at </td>
   <td style="text-align:left;"> ABAT </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 213245_at </td>
   <td style="text-align:left;"> ADCY1 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 213539_at </td>
   <td style="text-align:left;"> CD3D </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 214440_at </td>
   <td style="text-align:left;"> NAT1 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 218398_at </td>
   <td style="text-align:left;"> MRPS30 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 218976_at </td>
   <td style="text-align:left;"> DNAJC12 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 219197_s_at </td>
   <td style="text-align:left;"> SCUBE2 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 222379_at </td>
   <td style="text-align:left;"> KCNE4 </td>
   <td style="text-align:left;"> yes </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 200650_s_at </td>
   <td style="text-align:left;"> LDHA </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 202961_s_at </td>
   <td style="text-align:left;"> ATP5J2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 211662_s_at </td>
   <td style="text-align:left;"> VDAC2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 201623_s_at </td>
   <td style="text-align:left;"> DARS </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 205480_s_at </td>
   <td style="text-align:left;"> UGP2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 217750_s_at </td>
   <td style="text-align:left;"> UBE2Z </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 212175_s_at </td>
   <td style="text-align:left;"> AK2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 212050_at </td>
   <td style="text-align:left;"> WIPF2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 202631_s_at </td>
   <td style="text-align:left;"> APPBP2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 202342_s_at </td>
   <td style="text-align:left;"> TRIM2 </td>
   <td style="text-align:left;"> no </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The first 18 genes are considered to be the target genes, the last 10 genes are the genes used for reference. According to their paper, the score is calculated in the following way:</p>
<p><span class="math display">\[
SET_{ER/PR} = \sum_{i = 1}^{18} \frac{T_i}{18} - \sum_{j=1}^{10}\frac{R_j}{10} + 2
\]</span></p>
<p>Where <span class="math inline">\(T_i\)</span> are the expression levels of target genes and <span class="math inline">\(R_j\)</span> are the expression levels of the reference genes. Here we use GSVA to calculate the scores, even when using their genes.</p>
<div class="cell">

</div>
<p>Before we calculate any score, let us check the number of genes available for each pathway in each dataset. This is important, in other to have robust scores, most of the genes should be available in the datasets. We also add signatures of 18 and 200 random genes for control.</p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">

<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> pathway </th>
   <th style="text-align:right;"> tcga </th>
   <th style="text-align:right;"> scanb </th>
   <th style="text-align:right;"> metabric </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:left;"> average_percentage </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> HALLMARK_ADIPOGENESIS </td>
   <td style="text-align:right;"> 188 </td>
   <td style="text-align:right;"> 187 </td>
   <td style="text-align:right;"> 164 </td>
   <td style="text-align:right;"> 210 </td>
   <td style="text-align:left;"> 0.86 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_ALLOGRAFT_REJECTION </td>
   <td style="text-align:right;"> 141 </td>
   <td style="text-align:right;"> 134 </td>
   <td style="text-align:right;"> 139 </td>
   <td style="text-align:right;"> 335 </td>
   <td style="text-align:left;"> 0.41 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_ANDROGEN_RESPONSE </td>
   <td style="text-align:right;"> 93 </td>
   <td style="text-align:right;"> 92 </td>
   <td style="text-align:right;"> 83 </td>
   <td style="text-align:right;"> 102 </td>
   <td style="text-align:left;"> 0.88 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_ANGIOGENESIS </td>
   <td style="text-align:right;"> 30 </td>
   <td style="text-align:right;"> 29 </td>
   <td style="text-align:right;"> 28 </td>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:left;"> 0.81 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_APICAL_JUNCTION </td>
   <td style="text-align:right;"> 155 </td>
   <td style="text-align:right;"> 148 </td>
   <td style="text-align:right;"> 151 </td>
   <td style="text-align:right;"> 231 </td>
   <td style="text-align:left;"> 0.66 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_APICAL_SURFACE </td>
   <td style="text-align:right;"> 31 </td>
   <td style="text-align:right;"> 30 </td>
   <td style="text-align:right;"> 31 </td>
   <td style="text-align:right;"> 46 </td>
   <td style="text-align:left;"> 0.67 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_APOPTOSIS </td>
   <td style="text-align:right;"> 141 </td>
   <td style="text-align:right;"> 141 </td>
   <td style="text-align:right;"> 130 </td>
   <td style="text-align:right;"> 183 </td>
   <td style="text-align:left;"> 0.75 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_BILE_ACID_METABOLISM </td>
   <td style="text-align:right;"> 75 </td>
   <td style="text-align:right;"> 71 </td>
   <td style="text-align:right;"> 77 </td>
   <td style="text-align:right;"> 114 </td>
   <td style="text-align:left;"> 0.65 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_CHOLESTEROL_HOMEOSTASIS </td>
   <td style="text-align:right;"> 67 </td>
   <td style="text-align:right;"> 67 </td>
   <td style="text-align:right;"> 60 </td>
   <td style="text-align:right;"> 77 </td>
   <td style="text-align:left;"> 0.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_COAGULATION </td>
   <td style="text-align:right;"> 92 </td>
   <td style="text-align:right;"> 90 </td>
   <td style="text-align:right;"> 88 </td>
   <td style="text-align:right;"> 162 </td>
   <td style="text-align:left;"> 0.56 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_COMPLEMENT </td>
   <td style="text-align:right;"> 152 </td>
   <td style="text-align:right;"> 149 </td>
   <td style="text-align:right;"> 144 </td>
   <td style="text-align:right;"> 237 </td>
   <td style="text-align:left;"> 0.63 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_DNA_REPAIR </td>
   <td style="text-align:right;"> 145 </td>
   <td style="text-align:right;"> 144 </td>
   <td style="text-align:right;"> 127 </td>
   <td style="text-align:right;"> 170 </td>
   <td style="text-align:left;"> 0.82 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_E2F_TARGETS </td>
   <td style="text-align:right;"> 196 </td>
   <td style="text-align:right;"> 179 </td>
   <td style="text-align:right;"> 174 </td>
   <td style="text-align:right;"> 218 </td>
   <td style="text-align:left;"> 0.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION </td>
   <td style="text-align:right;"> 179 </td>
   <td style="text-align:right;"> 172 </td>
   <td style="text-align:right;"> 172 </td>
   <td style="text-align:right;"> 204 </td>
   <td style="text-align:left;"> 0.85 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_ESTROGEN_RESPONSE_EARLY </td>
   <td style="text-align:right;"> 189 </td>
   <td style="text-align:right;"> 176 </td>
   <td style="text-align:right;"> 162 </td>
   <td style="text-align:right;"> 216 </td>
   <td style="text-align:left;"> 0.81 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_ESTROGEN_RESPONSE_LATE </td>
   <td style="text-align:right;"> 176 </td>
   <td style="text-align:right;"> 162 </td>
   <td style="text-align:right;"> 162 </td>
   <td style="text-align:right;"> 218 </td>
   <td style="text-align:left;"> 0.76 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_FATTY_ACID_METABOLISM </td>
   <td style="text-align:right;"> 128 </td>
   <td style="text-align:right;"> 124 </td>
   <td style="text-align:right;"> 127 </td>
   <td style="text-align:right;"> 165 </td>
   <td style="text-align:left;"> 0.77 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_G2M_CHECKPOINT </td>
   <td style="text-align:right;"> 187 </td>
   <td style="text-align:right;"> 172 </td>
   <td style="text-align:right;"> 173 </td>
   <td style="text-align:right;"> 204 </td>
   <td style="text-align:left;"> 0.87 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_GLYCOLYSIS </td>
   <td style="text-align:right;"> 173 </td>
   <td style="text-align:right;"> 167 </td>
   <td style="text-align:right;"> 167 </td>
   <td style="text-align:right;"> 215 </td>
   <td style="text-align:left;"> 0.79 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_HEDGEHOG_SIGNALING </td>
   <td style="text-align:right;"> 24 </td>
   <td style="text-align:right;"> 21 </td>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:left;"> 0.65 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_HEME_METABOLISM </td>
   <td style="text-align:right;"> 152 </td>
   <td style="text-align:right;"> 150 </td>
   <td style="text-align:right;"> 138 </td>
   <td style="text-align:right;"> 214 </td>
   <td style="text-align:left;"> 0.69 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_HYPOXIA </td>
   <td style="text-align:right;"> 168 </td>
   <td style="text-align:right;"> 163 </td>
   <td style="text-align:right;"> 163 </td>
   <td style="text-align:right;"> 215 </td>
   <td style="text-align:left;"> 0.77 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_IL2_STAT5_SIGNALING </td>
   <td style="text-align:right;"> 163 </td>
   <td style="text-align:right;"> 156 </td>
   <td style="text-align:right;"> 163 </td>
   <td style="text-align:right;"> 216 </td>
   <td style="text-align:left;"> 0.74 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_IL6_JAK_STAT3_SIGNALING </td>
   <td style="text-align:right;"> 65 </td>
   <td style="text-align:right;"> 62 </td>
   <td style="text-align:right;"> 63 </td>
   <td style="text-align:right;"> 103 </td>
   <td style="text-align:left;"> 0.61 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_INFLAMMATORY_RESPONSE </td>
   <td style="text-align:right;"> 142 </td>
   <td style="text-align:right;"> 131 </td>
   <td style="text-align:right;"> 144 </td>
   <td style="text-align:right;"> 222 </td>
   <td style="text-align:left;"> 0.63 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_INTERFERON_ALPHA_RESPONSE </td>
   <td style="text-align:right;"> 92 </td>
   <td style="text-align:right;"> 90 </td>
   <td style="text-align:right;"> 81 </td>
   <td style="text-align:right;"> 140 </td>
   <td style="text-align:left;"> 0.63 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_INTERFERON_GAMMA_RESPONSE </td>
   <td style="text-align:right;"> 178 </td>
   <td style="text-align:right;"> 176 </td>
   <td style="text-align:right;"> 164 </td>
   <td style="text-align:right;"> 286 </td>
   <td style="text-align:left;"> 0.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_KRAS_SIGNALING_DN </td>
   <td style="text-align:right;"> 71 </td>
   <td style="text-align:right;"> 54 </td>
   <td style="text-align:right;"> 82 </td>
   <td style="text-align:right;"> 220 </td>
   <td style="text-align:left;"> 0.31 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_KRAS_SIGNALING_UP </td>
   <td style="text-align:right;"> 156 </td>
   <td style="text-align:right;"> 147 </td>
   <td style="text-align:right;"> 146 </td>
   <td style="text-align:right;"> 220 </td>
   <td style="text-align:left;"> 0.68 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_MITOTIC_SPINDLE </td>
   <td style="text-align:right;"> 194 </td>
   <td style="text-align:right;"> 189 </td>
   <td style="text-align:right;"> 168 </td>
   <td style="text-align:right;"> 215 </td>
   <td style="text-align:left;"> 0.85 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_MTORC1_SIGNALING </td>
   <td style="text-align:right;"> 190 </td>
   <td style="text-align:right;"> 189 </td>
   <td style="text-align:right;"> 176 </td>
   <td style="text-align:right;"> 211 </td>
   <td style="text-align:left;"> 0.88 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_MYC_TARGETS_V1 </td>
   <td style="text-align:right;"> 194 </td>
   <td style="text-align:right;"> 194 </td>
   <td style="text-align:right;"> 185 </td>
   <td style="text-align:right;"> 236 </td>
   <td style="text-align:left;"> 0.81 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_MYC_TARGETS_V2 </td>
   <td style="text-align:right;"> 58 </td>
   <td style="text-align:right;"> 57 </td>
   <td style="text-align:right;"> 52 </td>
   <td style="text-align:right;"> 60 </td>
   <td style="text-align:left;"> 0.93 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_MYOGENESIS </td>
   <td style="text-align:right;"> 126 </td>
   <td style="text-align:right;"> 131 </td>
   <td style="text-align:right;"> 139 </td>
   <td style="text-align:right;"> 212 </td>
   <td style="text-align:left;"> 0.62 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_NOTCH_SIGNALING </td>
   <td style="text-align:right;"> 29 </td>
   <td style="text-align:right;"> 28 </td>
   <td style="text-align:right;"> 29 </td>
   <td style="text-align:right;"> 34 </td>
   <td style="text-align:left;"> 0.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_OXIDATIVE_PHOSPHORYLATION </td>
   <td style="text-align:right;"> 199 </td>
   <td style="text-align:right;"> 185 </td>
   <td style="text-align:right;"> 169 </td>
   <td style="text-align:right;"> 220 </td>
   <td style="text-align:left;"> 0.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_P53_PATHWAY </td>
   <td style="text-align:right;"> 177 </td>
   <td style="text-align:right;"> 172 </td>
   <td style="text-align:right;"> 160 </td>
   <td style="text-align:right;"> 215 </td>
   <td style="text-align:left;"> 0.79 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_PANCREAS_BETA_CELLS </td>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 17 </td>
   <td style="text-align:right;"> 44 </td>
   <td style="text-align:left;"> 0.33 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_PEROXISOME </td>
   <td style="text-align:right;"> 85 </td>
   <td style="text-align:right;"> 84 </td>
   <td style="text-align:right;"> 87 </td>
   <td style="text-align:right;"> 110 </td>
   <td style="text-align:left;"> 0.78 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_PI3K_AKT_MTOR_SIGNALING </td>
   <td style="text-align:right;"> 91 </td>
   <td style="text-align:right;"> 91 </td>
   <td style="text-align:right;"> 84 </td>
   <td style="text-align:right;"> 118 </td>
   <td style="text-align:left;"> 0.75 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_PROTEIN_SECRETION </td>
   <td style="text-align:right;"> 94 </td>
   <td style="text-align:right;"> 92 </td>
   <td style="text-align:right;"> 90 </td>
   <td style="text-align:right;"> 98 </td>
   <td style="text-align:left;"> 0.94 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY </td>
   <td style="text-align:right;"> 46 </td>
   <td style="text-align:right;"> 47 </td>
   <td style="text-align:right;"> 43 </td>
   <td style="text-align:right;"> 58 </td>
   <td style="text-align:left;"> 0.78 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_SPERMATOGENESIS </td>
   <td style="text-align:right;"> 62 </td>
   <td style="text-align:right;"> 59 </td>
   <td style="text-align:right;"> 71 </td>
   <td style="text-align:right;"> 144 </td>
   <td style="text-align:left;"> 0.44 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_TGF_BETA_SIGNALING </td>
   <td style="text-align:right;"> 49 </td>
   <td style="text-align:right;"> 50 </td>
   <td style="text-align:right;"> 45 </td>
   <td style="text-align:right;"> 59 </td>
   <td style="text-align:left;"> 0.81 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_TNFA_SIGNALING_VIA_NFKB </td>
   <td style="text-align:right;"> 175 </td>
   <td style="text-align:right;"> 173 </td>
   <td style="text-align:right;"> 166 </td>
   <td style="text-align:right;"> 228 </td>
   <td style="text-align:left;"> 0.75 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_UNFOLDED_PROTEIN_RESPONSE </td>
   <td style="text-align:right;"> 106 </td>
   <td style="text-align:right;"> 106 </td>
   <td style="text-align:right;"> 98 </td>
   <td style="text-align:right;"> 115 </td>
   <td style="text-align:left;"> 0.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_UV_RESPONSE_DN </td>
   <td style="text-align:right;"> 129 </td>
   <td style="text-align:right;"> 131 </td>
   <td style="text-align:right;"> 121 </td>
   <td style="text-align:right;"> 152 </td>
   <td style="text-align:left;"> 0.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_UV_RESPONSE_UP </td>
   <td style="text-align:right;"> 129 </td>
   <td style="text-align:right;"> 126 </td>
   <td style="text-align:right;"> 127 </td>
   <td style="text-align:right;"> 191 </td>
   <td style="text-align:left;"> 0.67 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_WNT_BETA_CATENIN_SIGNALING </td>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:right;"> 33 </td>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:right;"> 50 </td>
   <td style="text-align:left;"> 0.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> HALLMARK_XENOBIOTIC_METABOLISM </td>
   <td style="text-align:right;"> 142 </td>
   <td style="text-align:right;"> 135 </td>
   <td style="text-align:right;"> 141 </td>
   <td style="text-align:right;"> 224 </td>
   <td style="text-align:left;"> 0.62 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> SET_ERPR </td>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:left;"> 0.93 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> random_200 </td>
   <td style="text-align:right;"> 162 </td>
   <td style="text-align:right;"> 145 </td>
   <td style="text-align:right;"> 154 </td>
   <td style="text-align:right;"> 200 </td>
   <td style="text-align:left;"> 0.77 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> random_18 </td>
   <td style="text-align:right;"> 15 </td>
   <td style="text-align:right;"> 15 </td>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:left;"> 0.8 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Most of the genes are available in all datasets. When calculating scores it is always good to check the availability of the genes. Otherwise this can make the score unstable, since too many of the genes are missing. For example, HALLMARK_PANCREAS_BETA_CELLS might have an unstable score, due to a lot of genes missing.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Setting parallel calculations through a MulticoreParam back-end
with workers=10 and tasks=100.
Estimating GSVA scores for 53 gene sets.
Estimating ECDFs with Gaussian kernels
Estimating ECDFs in parallel on 10 cores

  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |=======                                                               |   9%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |======================================================================| 100%

Setting parallel calculations through a MulticoreParam back-end
with workers=10 and tasks=100.
Estimating GSVA scores for 53 gene sets.
Estimating ECDFs with Gaussian kernels
Estimating ECDFs in parallel on 10 cores

  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |=======                                                               |   9%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |======================================================================| 100%

Setting parallel calculations through a MulticoreParam back-end
with workers=10 and tasks=100.
Estimating GSVA scores for 53 gene sets.
Estimating ECDFs with Gaussian kernels
Estimating ECDFs in parallel on 10 cores

  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |=======                                                               |   9%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>For each dataset one can plot the differences in scores for ER+ and ER- BC patients. This should be already an indication that the scores are meaningful. The next sections shows the results for each dataset individually.</p>
<div class="cell">

</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">TCGA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">METABRIC</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">SCANB</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-tcga" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-tcga-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.2: Scores for TCGA patients</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.3: Scores for METABRIC patients</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-scanb-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.4: Scores for SCANB patients</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>From the plots above one can conclude that three different estrogen pathways capture the differences between ER status and also molecular subtypes. There are two plots with random genes for control and we can see that there is no difference between the ER status when using those gene sets.</p>
<p>Below is a combined image for TCGA, SCANB and METABRIC using the <span class="math inline">\(SET_{ER/PR}\)</span> signature.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric-tcga-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-tcga-scanb-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption class="figure-caption">Figure 1.5: SET ER/PR scores for all three cohorts.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>And now using the hallmark estrogen response early.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric-tcga-scanb-estrogen-early" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-tcga-scanb-estrogen-early-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption class="figure-caption">Figure 1.6: Estrogen early scores for all three cohorts.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Another way to look at the data is to plot by molecular subtype instead of ER status.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">TCGA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">METABRIC</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">SCANB</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">

</div>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-tcga-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-tcga-pam50-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.7: Scores for TCGA patients stratified by PAM50 molecular subtype</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-metabric-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-metabric-pam50-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.8: Scores for METABRIC patients stratified by PAM50 molecular subtype</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-scanb-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-scanb-pam50-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1.9: Scores for SCANB patients stratified by PAM50 molecular subtype</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In all cohorts the luminal A and B patients have a similar score. Also the distinction is very clear between the basal and HER2-like patients versus luminal A and B.</p>
<p>One question that usually arises when calculating scores from gene sets is if proliferation associated genes (PAG) are driving the distinctions. These signatures are highly curated and they have close or no PAGs. Therefore, the scores are not affected by PAGs and they really reflect the biology.</p>
<p>Lastly we show in <a href="#fig-scores-scanb-esr1">Figure&nbsp;<span>1.10</span></a> the correlation of the estrogen signaling scores with the signatures.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-scanb-esr1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-scanb-esr1-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 1.10: Scores for SCANB patients stratified by PAM50 molecular subtype</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We see that there is a positive correlation between signatures and scores, the problem though is the high variability in the scores in this case.</p>
<p>In the next section we will show how these scores are also prognostic for ER+ BC patients.</p>
</section>
<section id="survival-analysis" class="level2 page-columns page-full" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="survival-analysis"><span class="header-section-number">1.4</span> Survival analysis</h2>
<p>Since the scores are continuous variables and they are already scaled due to the output of GSVA, cox regression <span class="citation" data-cites="Cox1972">(<a href="references.html#ref-Cox1972" role="doc-biblioref">Cox 1972</a>)</span> can be used. The advantages of using cox regression is that one can control for other variables. You might ask, why should one control for clinical variables? One of the reasons is because the data being dealt here is observational data. There are several confounders, for example, a score might be up because patients with a higher tumor grade have higher expression of some genes. Thus the score is confounded by the tumor grade and the interpretation changes.</p>
<p>There are limitations still when dealing with observational data. A strong hypothesis for performing survival analysis with observational data is that we have measured all the confounder variables. This is pretty strong and in practice we never know if a confounder is missing or not. For a more thorough overview of the causal framework for observational data, check the books <span class="citation" data-cites="Gelman2020-uh McElreath2020-jn">(<a href="references.html#ref-Gelman2020-uh" role="doc-biblioref">Gelman, Hill, and Vehtari 2020</a>; <a href="references.html#ref-McElreath2020-jn" role="doc-biblioref">McElreath 2020</a>)</span>.</p>
<div class="page-columns page-full"><p>All the cohorts have a different set of clinical variables available. Therefore, the regression will be done by adjusting a different set of variables. Below is the description of the variables used for each cohort.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn1" role="doc-endnote"><p><sup>1</sup>&nbsp;This <a href="https://web.archive.org/web/20220630083539/https://www.cancer.net/cancer-types/breast-cancer/stages">webpage</a> explains with more details the different tumor stages and how BC are classified.</p></li></div></div>
<ul>
<li><strong>Age</strong>: age is one of the most important factors to adjust, specially in breast cancer. This covariate is used for all cohorts.</li>
<li><strong>NPI</strong>: the Nottingham prognostic index scores each tumor based on tumor grade, tumor size and number of lymph nodes. Only METABRIC has this information.</li>
<li><strong>Tumor Size</strong>: as name describes. Only SCANB has this information.</li>
<li><strong>Tumor Stage</strong>: tumors are usually described in terms of stage, it reflects the tumor size and location. SCANB and TCGA have this information.</li>
<li><strong>Node Stage</strong>: similar to tumor stage, but encodes the number of lymph nodes where breast cancer cells can be found. SCANB and TCGA have this information.</li>
</ul>
<p>Thus the models we are going to use for the survival analysis of each dataset is shown below.</p>
<ul>
<li>TCGA: <code>~ score + age + node_stage + tumor_stage</code>,</li>
<li>SCANB: <code>~ score + age + node_stage + tumor_stage</code>,</li>
<li>METABRIC: <code>~ score + age + NPI</code>,</li>
</ul>
<p>where score is one of the scores calculated earlier with GSVA. Note here that since each node stage and tumor stage have sub classifications they will be grouped together, otherwise there will be too many variables with few points. We will also subselect specific tumor stages for TCGA and SCANB, since there are very few patients with tumor stage 4.</p>
<p>To be very specific in the survival analysis, only endocrine treated patients should be used in the analysis, as that is what are interested in. METABRIC and SCANB has this kind of annotation, but TCGA not. So the survival analysis on SCANB and METABRIC will be performed on endocrine only treated, ER+ BC patients. On TCGA, to mitigate this effect, we subselect only luminal A and B patients, and we keep in mind that they might have been treated with chemotherapy as well. Moreover, in Sweden the guidelines for BC treatment is to use 10% as the threshold for ER status. Therefore, ER+ BC patients used on SCANB are those that are above the 10% threshold.</p>
<p>The table below shows the number of patients for each cohort.</p>
<div class="cell">
<div class="cell-output-display">

<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> cohort </th>
   <th style="text-align:right;"> number_patients </th>
   <th style="text-align:right;"> nb_events </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> TCGA </td>
   <td style="text-align:right;"> 684 </td>
   <td style="text-align:right;"> 73 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> SCANB </td>
   <td style="text-align:right;"> 3603 </td>
   <td style="text-align:right;"> 637 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> METABRIC </td>
   <td style="text-align:right;"> 934 </td>
   <td style="text-align:right;"> 573 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> SCANB High ER </td>
   <td style="text-align:right;"> 2860 </td>
   <td style="text-align:right;"> 454 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>../results/plots/surv_analysis_estrogen/forest_plots/pdf 
                                                   FALSE 
../results/plots/surv_analysis_estrogen/forest_plots/png 
                                                   FALSE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>tcga OS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>tcga OS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>tcga OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>tcga OS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>tcga OS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb OS ER.pct </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric OS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er OS ER.pct </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb RFS ER.pct </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>metabric RFS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS HALLMARK_ESTROGEN_RESPONSE_EARLY </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS HALLMARK_ESTROGEN_RESPONSE_LATE </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS SET_ERPR </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS random_200 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS random_18 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>scanb_high_er RFS ER.pct </code></pre>
</div>
</div>
<div class="cell">

</div>
<section id="results" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="results"><span class="header-section-number">1.4.1</span> Results</h3>
<p>The table below shows the results for each analysis performed for a specific term. In order to understand the table the user can filter based on the term, cohort and type of analysis. Since METABRIC has recurrence free survival (RFS) and overall survival (OS), the results for both analysis are presented here.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-26f8d5e923df7f11fbfb" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-26f8d5e923df7f11fbfb">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.115809878504831\" data-max=\"0.614740958536308\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.130685838844551\" data-max=\"0.737296332838902\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"-8.34713132031964\" data-max=\"-1.97093647428203\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"0.048731142467473\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.052525473940036\" data-max=\"0.471765924783858\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.242371171790281\" data-max=\"0.991942659343702\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0.115809878504831\" data-max=\"0.614740958536308\" data-scale=\"15\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10"],["os","os","os","os","os","os","rfs","rfs","rfs","rfs"],["tcga","tcga","scanb","scanb","metabric","metabric","scanb","scanb","metabric","metabric"],["HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR"],["HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR","HALLMARK_ESTROGEN_RESPONSE_EARLY","SET_ERPR"],[0.233829225703695,0.230338944922228,0.547074281580645,0.478672855565508,0.558438530069647,0.614740958536308,0.115809878504831,0.156892795460244,0.430913702461177,0.45293441930167],[0.737296332838902,0.39763624663053,0.239689821888115,0.130685838844551,0.240219789131416,0.135062702694086,0.403401085182645,0.22189569892401,0.292397620536938,0.163586330692911],[-1.97093647428203,-3.69232783408581,-2.51646349808287,-5.63747300537742,-2.42532362208777,-3.60243276518523,-5.34407439657933,-8.34713132031964,-2.87911862514004,-4.84152881465094],[0.0487311424674724,0.000222210765540212,0.0118539178303981,1.72563644993162e-08,0.0152947457514795,0.000315252955042664,9.08802388838188e-08,6.99409389787678e-17,0.00398788301018185,1.28843987757473e-06],[0.0551202292573695,0.105657124357175,0.341996729098428,0.370509043329945,0.348738519932462,0.471765924783858,0.0525254739400364,0.101560548993959,0.242941102721224,0.328692948822314],[0.991942659343702,0.502152882455225,0.87512611701278,0.618413252739949,0.894233283798828,0.801046506856718,0.255341398244494,0.242371171790281,0.764327719306833,0.624137478224522],[0.233829225703695,0.230338944922228,0.547074281580645,0.478672855565508,0.558438530069647,0.614740958536308,0.115809878504831,0.156892795460244,0.430913702461177,0.45293441930167]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>type_analysis<\/th>\n      <th>cohort<\/th>\n      <th>score<\/th>\n      <th>term<\/th>\n      <th>estimate<\/th>\n      <th>std.error<\/th>\n      <th>statistic<\/th>\n      <th>p.value<\/th>\n      <th>conf.low<\/th>\n      <th>conf.high<\/th>\n      <th>HR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"targets":8,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":5,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":6,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":7,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":11,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render","options.columnDefs.4.render"],"jsHooks":[]}</script>
</div>
</div>
<p>The table above shows that <span class="math inline">\(SET_{ER/PR}\)</span> had a small hazard ratio (&lt; 1) in all 4 analysis performed. Moreover, for all cases where a measure of estrogen signaling was used, the hazard ratio was below 1, indicating that the higher the score, the less likely the patient is to suffer the event in a specific timepoint. This indicates that ER signaling is actually something continuous and not dichotomous.</p>
<p><a href="#fig-forest-plot">Figure&nbsp;<span>1.11</span></a> shows the forest plot of HALLMARK_ESTROGEN_RESPONSE_EARLY for all three cohorts.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-forest-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-forest-plot-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption class="figure-caption">Figure 1.11: Forest plots of the different cohorts and their hazard ratios. The bars correspond to 95% confidence interval.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The hazard ratios are all below 1 and small for HALLMARK_ESTROGEN_RESPONSE_EARLY. The variability changes depending on the cohort, specially because they have different follow-up times, SCANB being the shortest. TCGA has very few number of events and we could not select based on the treatment, the results for TCGA are less reliable.</p>
</section>
</section>
<section id="comparison-of-er-ihc-and-molecular-er-signaling" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="comparison-of-er-ihc-and-molecular-er-signaling"><span class="header-section-number">1.5</span> Comparison of ER IHC and molecular ER signaling</h2>
<p>The new released dataset from the SCANB consortium contains the ER percentage based on the IHC stainings. This is great, because we can now compare the molecular ER signaling score to what is seen in the clinics.</p>
<p>First we start by comparing the molecular score with the percentages (<a href="#fig-cor-ihc-rna">Figure&nbsp;<span>1.12</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-cor-ihc-rna" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-cor-ihc-rna-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 1.12: Correlation between ER IHC percentage and molecular ER signaling by using the signature HALLMARK_ESTROGEN_RESPONSE_EARLY and SET ER/PR.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The first thing that one can notice is that ER percentage is very discrete, pathologists probably don’t assign non rounded percentage values, which makes sense. Another thing to notice is that for high ER percentage patients you have a whole spectrum of molecular ER signaling score.</p>
<p>Now we look speficially at the high ER percentage patients and compare their ER signaling scores. We previously saw that the distribution of these scores seems to be wide.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-high-er" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-scores-high-er-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 1.13: Scores for high ER percentage breast cancer patients.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-scores-high-er">Figure&nbsp;<span>1.13</span></a> shows how the distributions are not skewed towards high values only. It looks like there is a step in the SET ER/PR signature, we now compare with the ESR1 values and hallmark estrogen response early.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-seter-others" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-seter-others-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure 1.14: Correlation between SET ER/PR and other scores.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>There is a highly positive correlation. Also interesting to see that ESR1 levels are not necessarily highly correlated with high SET ER/PR scores. Remember that for ESR1 the scale is logarithmic, so even if the slope is smaller than in the hallmark estrogen response early, it might mean a higher correlation even..</p>
<p><a href="#fig-er-hist">Figure&nbsp;<span>1.15</span></a> shows the distribution of the ER IHC percentage for the patients used in the previous survival analysis for SCANB.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-hist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-hist-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 1.15: Histogram of ER IHC percentage of the SCANB samples used for survival analysis</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We see that the majority of the patients actually have already pretty high percentage. It could be that the results of the overall survival analysis are actually driven by the the low ER percentage patients, so we performed the survival analysis only on patients with ER percentage equal or higher than 90%. The table below shows the total number of patients for each analysis.</p>
<div class="cell">
<div class="cell-output-display">

<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> cohort </th>
   <th style="text-align:right;"> number_patients </th>
   <th style="text-align:right;"> nb_events </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> TCGA </td>
   <td style="text-align:right;"> 684 </td>
   <td style="text-align:right;"> 73 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> SCANB </td>
   <td style="text-align:right;"> 3603 </td>
   <td style="text-align:right;"> 637 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> METABRIC </td>
   <td style="text-align:right;"> 934 </td>
   <td style="text-align:right;"> 573 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> SCANB High ER </td>
   <td style="text-align:right;"> 2860 </td>
   <td style="text-align:right;"> 454 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>There was a decrease of around 200 patients with 80 events less, so indeed a lot of those patients with lower ER percentage had died. <a href="#fig-er-ihc-survival">Figure&nbsp;<span>1.16</span></a> shows the results of the survival analysis when considering the ER IHC percentage as a continuous score on SCANB.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-survival" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-survival-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 1.16: Survival analysis using ER IHC percentage as the score instead of the common molecular ER signaling scores</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We a very tight confidence interval in this case with a HR very close to 1, meaning that for every 1% increase there is a 2% decrease in your risk of dying. The table with the values is shown below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  type_analysis cohort  score   term  estimate   std.error statistic
1            os  scanb ER.pct ER.pct 0.9869937 0.003823396 -3.424089
2           rfs  scanb ER.pct ER.pct 0.9790501 0.005090663 -4.159083
       p.value  conf.low conf.high        HR
1 6.168634e-04 0.9796251 0.9944177 0.9869937
2 3.195272e-05 0.9693302 0.9888675 0.9790501</code></pre>
</div>
</div>
<p>Next we selected only patients that had 90% or more ER IHC percentage to perform the survival analysis. <a href="#fig-er-ihc-high-os">Figure&nbsp;<span>1.17</span></a> shows the results for both the analysis done on ER IHC percentage,<br>
HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-high-os" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-high-os-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption class="figure-caption">Figure 1.17: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with 90% or more in the ER IHC were selected.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>When performing the survival analysis among the high ER percentage, there is no evidence to differentiate between 90 to 100%, but by using the molecular scores that fact is still true, showing that perhaps the molecular score could be more sensitive for these patients.</p>
<p>We can also analyse the recurrence free survival for this cohort (<a href="#fig-er-ihc-high-rfs">Figure&nbsp;<span>1.18</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-er-ihc-high-rfs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="surv_analysis_estrogen_files/figure-html/fig-er-ihc-high-rfs-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption class="figure-caption">Figure 1.18: Survival analysis using ER IHC percentage, HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only patients with 90% or more in the ER IHC were selected.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The problem now is that the number of events is much smaller, so the confidence intervals for the estimates will be bigger. We see that for both signatures the HR is way below 1, meaning that the higher the score the better it is for the patient. Also the hazard ratio decreased in this case.</p>
</section>
<section id="conclusion" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">1.6</span> Conclusion</h2>
<p>In this chapter we’ve shown that ER+ BC patients are very distinct from each other, as it can be seen from the umap projections and the subtypes. These patients might respond differently for endocrine therapy as well, and this might depend on the ER signaling, how active it is. Therefore, when deciding a treatment, more care should be taken with ER+ BC patients and check their signaling scores somehow. The <span class="math inline">\(SET_{ER/PR}\)</span> signature is a good signature showing very good hazard ratios across the different cohorts. This signature has also been validated on the clinics for use.</p>
<p>Knowing the ER signaling for a patient is very important when deciding treatment, but not enough. What could be other alternatives for patients that have low ER signaling and are still considered ER+? Should they use only endocrine therapy or supplement it with something else? In the next chapters we present a framework where we can take a look at a more personalised approach for treatments.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Cox1972" class="csl-entry" role="doc-biblioentry">
Cox, D. R. 1972. <span>“Regression Models and Life-Tables.”</span> <em>Journal of the Royal Statistical Society: Series B (Methodological)</em> 34 (2): 187–202. <a href="https://doi.org/10.1111/j.2517-6161.1972.tb00899.x">https://doi.org/10.1111/j.2517-6161.1972.tb00899.x</a>.
</div>
<div id="ref-Gelman2020-uh" class="csl-entry" role="doc-biblioentry">
Gelman, Andrew, Jennifer Hill, and Aki Vehtari. 2020. <em>Regression and Other Stories</em>. Analytical Methods for Social Research. Cambridge, England: Cambridge University Press.
</div>
<div id="ref-Hnzelmann2013" class="csl-entry" role="doc-biblioentry">
Hänzelmann, Sonja, Robert Castelo, and Justin Guinney. 2013. <span>“<span>GSVA</span>: Gene Set Variation Analysis for Microarray and <span>RNA</span>-Seq Data.”</span> <em><span>BMC</span> Bioinformatics</em> 14 (1). <a href="https://doi.org/10.1186/1471-2105-14-7">https://doi.org/10.1186/1471-2105-14-7</a>.
</div>
<div id="ref-McElreath2020-jn" class="csl-entry" role="doc-biblioentry">
McElreath, Richard. 2020. <em>Statistical Rethinking</em>. 2nd ed. Chapman &amp; Hall/CRC Texts in Statistical Science. London, England: CRC Press.
</div>
<div id="ref-Sinn2019" class="csl-entry" role="doc-biblioentry">
Sinn, Bruno V., Chunxiao Fu, Rosanna Lau, Jennifer Litton, Tsung-Heng Tsai, Rashmi Murthy, Alda Tam, et al. 2019. <span>“<span>SETER</span>/<span>PR</span>: A Robust 18-Gene Predictor for Sensitivity to Endocrine Therapy for Metastatic Breast Cancer.”</span> <em>Npj Breast Cancer</em> 5 (1). <a href="https://doi.org/10.1038/s41523-019-0111-0">https://doi.org/10.1038/s41523-019-0111-0</a>.
</div>
<div id="ref-Subramanian2005" class="csl-entry" role="doc-biblioentry">
Subramanian, Aravind, Pablo Tamayo, Vamsi K. Mootha, Sayan Mukherjee, Benjamin L. Ebert, Michael A. Gillette, Amanda Paulovich, et al. 2005. <span>“Gene Set Enrichment Analysis: A Knowledge-Based Approach for Interpreting Genome-Wide Expression Profiles.”</span> <em>Proceedings of the National Academy of Sciences</em> 102 (43): 15545–50. <a href="https://doi.org/10.1073/pnas.0506580102">https://doi.org/10.1073/pnas.0506580102</a>.
</div>
</div>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./intro.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./pca_merging.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb45" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estrogen receptor status is continuous, not dichotomous</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>Currently in the clinics estrogen receptor (ER) status is treated </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>as dichotomous condition. Either a breast cancer (BC) is ER positive (ER+) or</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>ER negative (ER-). The threshold for ER+ cells usually is 1% or 10% of the </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>cells positive in a IHC staining. The idea is that ER+ BC patients</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>will receive endocrine therapy, usually tamoxifen or some aromatase inhibitor,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>for treatment. The problem is not all patients respond the same to these</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>drugs and they also have different proportions of ER+ cells. </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>In this document we show how leveraging molecular information distinguishes</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>ER+ BC patients and how one should look more carefully on ER status. In order</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>to do this, estrogen related signatures: estrogen response early and late from</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>MSigDB<span class="co">[</span><span class="ot">@Subramanian2005</span><span class="co">]</span> and $SET_{ER/PR}$<span class="co">[</span><span class="ot">@Sinn2019</span><span class="co">]</span>, </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>are used to calculate scores for each</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>BC patient. These scores then are used to calculate associations with survival</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>analysis. When performing cox regression, we try to adjust for sensible </span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>covariates in order to reduce bias. Even though we are adjusting, it is </span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>very difficult to know if a covariate is missing in the regression. Thus,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>care should be always taken when interpreting these results.</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>This chapter is structure in the following way. First section corresponds</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>to loading the datasets and then filtering them. Estrogen signatures scores</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>are calculated using GSVA <span class="co">[</span><span class="ot">@Hnzelmann2013</span><span class="co">]</span>. Given the scores, cox regression</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>can be performed adjusting for clinical variables. After this the Hazard</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>ratios can be computed and interpreted along with their confidence</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>intervals.</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading and filtering the datasets</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>The preprocessing of the datasets is described in the website below:</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; https://chronchi.github.io/transcriptomics</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>To check the code used here either click in the code button on the top right</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>part of the page or check the github page </span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>(github.com/chronchi/molecular_landscape).</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>The TCGA, METABRIC and SCANB cohorts are used in this section here. They</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>are the biggest cohort of Breast cancer patients in the world. Each datasets</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>has an overall equal distribution of ER+ and ER- patients and similar age</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>distribution. </span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="co"># init renv due to docker installation</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>(<span class="at">prompt =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a><span class="co"># first load the packages</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forestplot)</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplotify)</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SummarizedExperiment)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(msigdbr)</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GSVA)</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(uwot)</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"first_run.R"</span>)</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a><span class="co"># by setting the dev to png and pdf, this saves the figures in a specific</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a><span class="co"># folder in both formats. moreover, since png is coming first, it shows</span></span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a><span class="co"># this figure when rendering the html. What is nice about this is that it</span></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a><span class="co"># inherits the properties from the chunk to save the figure, so no need</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a><span class="co"># to use ggplot2::ggsave to save the plots. this also works </span></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="fu">c</span>(<span class="st">'png'</span>, <span class="st">'pdf'</span>, <span class="st">'svg'</span>))</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">bitmapType =</span> <span class="st">'cairo'</span>)</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a><span class="co"># load the different datasets. we will do the analysis </span></span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a><span class="co"># and save the intermediate results so loading all the dataset again</span></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a><span class="co"># is not necessary</span></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/tcga_brca_tumor_filtered.rds"</span>)</span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/metabric_filtered_complete.rds"</span>)</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/scanb_2022/scanb_sumexp.rds"</span>)</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a><span class="co"># we want to have common variables across datasets. so for tcga</span></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a><span class="co"># we convert the ensembl ids to gene symbol in the rownames,</span></span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a><span class="co"># for scanb and metabric we perform a heavier filtering as well.</span></span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a><span class="co"># also for the clinical data we want to have common column names,</span></span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a><span class="co"># such as for pam50, events, time to event, tumor stage,</span></span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a><span class="co"># tumor grade and others.</span></span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a><span class="co"># first convert ensembl to symbol. this information is readily available</span></span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a><span class="co"># from the tcga filtered data. we just need to remove duplicated symbols</span></span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a><span class="co"># first.</span></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>symbol_names <span class="ot">&lt;-</span> <span class="fu">mcols</span>(<span class="fu">rowRanges</span>(tcga)) <span class="sc">%&gt;%</span> </span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(external_gene_name))</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> tcga[symbol_names<span class="sc">$</span>ensembl_gene_id, ]</span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tcga) <span class="ot">&lt;-</span> symbol_names<span class="sc">$</span>external_gene_name</span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a>fpkm_tcga <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span><span class="fu">assay</span>(tcga, <span class="st">"logFPKM_TMM"</span>)</span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a>prop_expressed <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(fpkm_tcga <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>genes_to_keep <span class="ot">&lt;-</span> prop_expressed <span class="sc">&gt;</span> <span class="fl">0.5</span></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> tcga[genes_to_keep, ]</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a><span class="co"># we now filter down the list of genes from metabric and scanb.</span></span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a><span class="co"># remove first genes with na in the table</span></span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">assay</span>(metabric, <span class="st">"median_intensity"</span>) <span class="sc">&gt;</span> <span class="fl">5.5</span>)</span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> keep_genes <span class="sc">&gt;</span> <span class="fl">0.7</span> <span class="sc">%&gt;%</span> unname <span class="sc">%&gt;%</span> unlist</span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(keep_genes))</span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[<span class="sc">-</span>keep_genes, ]</span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a><span class="co"># now remove genes with low expression across samples</span></span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">assay</span>(metabric, <span class="st">"median_intensity"</span>) <span class="sc">&gt;</span> <span class="fl">5.5</span>)</span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> keep_genes <span class="sc">&gt;</span> <span class="fl">0.7</span></span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[keep_genes, ]</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a><span class="co"># convert back to non log values and then filter.</span></span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a><span class="fu">assay</span>(scanb, <span class="st">"logFPKM"</span>) <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">assay</span>(scanb) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">base =</span> <span class="dv">2</span>)</span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a>fpkm_scanb <span class="ot">&lt;-</span> <span class="fu">assay</span>(scanb, <span class="st">"FPKM"</span>)</span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a>prop_expressed <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(fpkm_scanb <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a>genes_to_keep <span class="ot">&lt;-</span> prop_expressed <span class="sc">&gt;</span> <span class="fl">0.8</span></span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> scanb[genes_to_keep, ]</span>
<span id="cb45-121"><a href="#cb45-121" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>esr1_levels <span class="ot">&lt;-</span> <span class="fu">assay</span>(scanb, <span class="st">"logFPKM"</span>)[<span class="st">"ESR1"</span>, ]</span>
<span id="cb45-122"><a href="#cb45-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-123"><a href="#cb45-123" aria-hidden="true" tabindex="-1"></a><span class="co"># we now convert the clinical data to some common names and values</span></span>
<span id="cb45-124"><a href="#cb45-124" aria-hidden="true" tabindex="-1"></a>tcga <span class="ot">&lt;-</span> tcga[, tcga<span class="sc">$</span>er_status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Positive"</span>, <span class="st">"Negative"</span>)]</span>
<span id="cb45-125"><a href="#cb45-125" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>er_status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Positive"</span> <span class="ot">=</span> <span class="st">"pos"</span>, <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"neg"</span>)[tcga<span class="sc">$</span>er_status]</span>
<span id="cb45-126"><a href="#cb45-126" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">tolower</span>(tcga<span class="sc">$</span>molecular_subtype)</span>
<span id="cb45-127"><a href="#cb45-127" aria-hidden="true" tabindex="-1"></a>levels_order_pam50 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"lumb"</span>, <span class="st">"luma"</span>, <span class="st">"normal"</span>, <span class="st">"claudin-low"</span>)</span>
<span id="cb45-128"><a href="#cb45-128" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">factor</span>(tcga<span class="sc">$</span>pam50, <span class="at">levels =</span> levels_order_pam50)</span>
<span id="cb45-129"><a href="#cb45-129" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>os_days <span class="ot">&lt;-</span> tcga<span class="sc">$</span>time</span>
<span id="cb45-130"><a href="#cb45-130" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>os_months <span class="ot">&lt;-</span> tcga<span class="sc">$</span>os_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb45-131"><a href="#cb45-131" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>os_status <span class="ot">&lt;-</span> tcga<span class="sc">$</span>status</span>
<span id="cb45-132"><a href="#cb45-132" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>tumor_stage <span class="ot">&lt;-</span> <span class="fu">tolower</span>(tcga<span class="sc">$</span>paper_pathologic_stage)</span>
<span id="cb45-133"><a href="#cb45-133" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>age <span class="ot">&lt;-</span> tcga<span class="sc">$</span>age_at_index</span>
<span id="cb45-134"><a href="#cb45-134" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(tcga)</span>
<span id="cb45-135"><a href="#cb45-135" aria-hidden="true" tabindex="-1"></a>node_stage <span class="ot">&lt;-</span> tcga<span class="sc">$</span>ajcc_pathologic_n</span>
<span id="cb45-136"><a href="#cb45-136" aria-hidden="true" tabindex="-1"></a>tcga<span class="sc">$</span>node_stage <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb45-137"><a href="#cb45-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"^N0"</span>, node_stage),</span>
<span id="cb45-138"><a href="#cb45-138" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N0"</span>,</span>
<span id="cb45-139"><a href="#cb45-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(</span>
<span id="cb45-140"><a href="#cb45-140" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grepl</span>(<span class="st">"^N1"</span>, node_stage),</span>
<span id="cb45-141"><a href="#cb45-141" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N1"</span>,</span>
<span id="cb45-142"><a href="#cb45-142" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(</span>
<span id="cb45-143"><a href="#cb45-143" aria-hidden="true" tabindex="-1"></a>            <span class="fu">grepl</span>(<span class="st">"^N2"</span>, node_stage),</span>
<span id="cb45-144"><a href="#cb45-144" aria-hidden="true" tabindex="-1"></a>            <span class="st">"N2"</span>,</span>
<span id="cb45-145"><a href="#cb45-145" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(</span>
<span id="cb45-146"><a href="#cb45-146" aria-hidden="true" tabindex="-1"></a>                <span class="fu">grepl</span>(<span class="st">"^N3"</span>, node_stage),</span>
<span id="cb45-147"><a href="#cb45-147" aria-hidden="true" tabindex="-1"></a>                <span class="st">"N3"</span>,</span>
<span id="cb45-148"><a href="#cb45-148" aria-hidden="true" tabindex="-1"></a>                <span class="st">"NX"</span></span>
<span id="cb45-149"><a href="#cb45-149" aria-hidden="true" tabindex="-1"></a>            ) </span>
<span id="cb45-150"><a href="#cb45-150" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-151"><a href="#cb45-151" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-152"><a href="#cb45-152" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-153"><a href="#cb45-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-154"><a href="#cb45-154" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[, metabric<span class="sc">$</span>ER_IHC <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Positve"</span>, <span class="st">"Negative"</span>)]</span>
<span id="cb45-155"><a href="#cb45-155" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>er_status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Positve"</span> <span class="ot">=</span> <span class="st">"pos"</span>, <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"neg"</span>)[metabric<span class="sc">$</span>ER_IHC]</span>
<span id="cb45-156"><a href="#cb45-156" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">tolower</span>(metabric<span class="sc">$</span>CLAUDIN_SUBTYPE)</span>
<span id="cb45-157"><a href="#cb45-157" aria-hidden="true" tabindex="-1"></a>metabric <span class="ot">&lt;-</span> metabric[, metabric<span class="sc">$</span>pam50 <span class="sc">!=</span> <span class="st">"nc"</span>]</span>
<span id="cb45-158"><a href="#cb45-158" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">factor</span>(metabric<span class="sc">$</span>pam50, <span class="at">levels =</span> levels_order_pam50)</span>
<span id="cb45-159"><a href="#cb45-159" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>os_months <span class="ot">&lt;-</span> metabric<span class="sc">$</span>OS_MONTHS</span>
<span id="cb45-160"><a href="#cb45-160" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>rfs_months <span class="ot">&lt;-</span> metabric<span class="sc">$</span>RFS_MONTHS</span>
<span id="cb45-161"><a href="#cb45-161" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>os_status <span class="ot">&lt;-</span> <span class="fu">substr</span>(metabric<span class="sc">$</span>OS_STATUS, <span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb45-162"><a href="#cb45-162" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>os_status <span class="ot">&lt;-</span> metabric<span class="sc">$</span>os_status <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb45-163"><a href="#cb45-163" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> <span class="fu">substr</span>(metabric<span class="sc">$</span>RFS_STATUS, <span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb45-164"><a href="#cb45-164" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> metabric<span class="sc">$</span>rfs_status <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb45-165"><a href="#cb45-165" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>age <span class="ot">&lt;-</span> metabric<span class="sc">$</span>AGE_AT_DIAGNOSIS</span>
<span id="cb45-166"><a href="#cb45-166" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>npi <span class="ot">&lt;-</span> metabric<span class="sc">$</span>NPI </span>
<span id="cb45-167"><a href="#cb45-167" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>NPI <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-168"><a href="#cb45-168" aria-hidden="true" tabindex="-1"></a>metabric<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(metabric)</span>
<span id="cb45-169"><a href="#cb45-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-170"><a href="#cb45-170" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> scanb[, scanb<span class="sc">$</span>ER <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Negative"</span>, <span class="st">"Positive"</span>)]</span>
<span id="cb45-171"><a href="#cb45-171" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>er_status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Positive"</span> <span class="ot">=</span> <span class="st">"pos"</span>, <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"neg"</span>)[scanb<span class="sc">$</span>ER]</span>
<span id="cb45-172"><a href="#cb45-172" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">tolower</span>(scanb<span class="sc">$</span>SSP.PAM50)</span>
<span id="cb45-173"><a href="#cb45-173" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> <span class="fu">factor</span>(scanb<span class="sc">$</span>pam50, <span class="at">levels =</span> levels_order_pam50)</span>
<span id="cb45-174"><a href="#cb45-174" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>nhg <span class="ot">&lt;-</span> scanb<span class="sc">$</span>NHG</span>
<span id="cb45-175"><a href="#cb45-175" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>NHG <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-176"><a href="#cb45-176" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>age <span class="ot">&lt;-</span> scanb<span class="sc">$</span>Age..<span class="fl">5.</span>year.range..e.g...<span class="dv">35</span>.<span class="dv">31</span>.<span class="dv">35</span>...<span class="dv">40</span>.<span class="dv">36</span>.<span class="dv">40</span>...<span class="dv">45</span>.<span class="dv">41</span>.<span class="dv">45</span>..etc..</span>
<span id="cb45-177"><a href="#cb45-177" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>os_months <span class="ot">&lt;-</span> scanb<span class="sc">$</span>OS_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb45-178"><a href="#cb45-178" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>os_status <span class="ot">&lt;-</span> scanb<span class="sc">$</span>OS_event <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb45-179"><a href="#cb45-179" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>rfs_status <span class="ot">&lt;-</span> scanb<span class="sc">$</span>RFi_event <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb45-180"><a href="#cb45-180" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>rfs_months <span class="ot">&lt;-</span> scanb<span class="sc">$</span>RFi_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb45-181"><a href="#cb45-181" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>drfs_status <span class="ot">&lt;-</span> scanb<span class="sc">$</span>DRFi_event <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb45-182"><a href="#cb45-182" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>drfs_months <span class="ot">&lt;-</span> scanb<span class="sc">$</span>DRFi_days<span class="sc">/</span><span class="dv">30</span></span>
<span id="cb45-183"><a href="#cb45-183" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>tumor_size <span class="ot">&lt;-</span> scanb<span class="sc">$</span>Size.mm</span>
<span id="cb45-184"><a href="#cb45-184" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>tumor_stage <span class="ot">&lt;-</span> scanb<span class="sc">$</span>pT</span>
<span id="cb45-185"><a href="#cb45-185" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>tumor_stage <span class="ot">&lt;-</span> <span class="fu">colData</span>(scanb) <span class="sc">%&gt;%</span></span>
<span id="cb45-186"><a href="#cb45-186" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-187"><a href="#cb45-187" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tumor_stage =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb45-188"><a href="#cb45-188" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(tumor_stage, <span class="st">"^T1"</span>) <span class="sc">~</span> <span class="st">"T1"</span>,</span>
<span id="cb45-189"><a href="#cb45-189" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(tumor_stage, <span class="st">"^T2"</span>) <span class="sc">~</span> <span class="st">"T2"</span>,</span>
<span id="cb45-190"><a href="#cb45-190" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(tumor_stage, <span class="st">"^T3"</span>) <span class="sc">~</span> <span class="st">"T3"</span></span>
<span id="cb45-191"><a href="#cb45-191" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb45-192"><a href="#cb45-192" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(tumor_stage)</span>
<span id="cb45-193"><a href="#cb45-193" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>node_group <span class="ot">&lt;-</span> scanb<span class="sc">$</span>LN.spec</span>
<span id="cb45-194"><a href="#cb45-194" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>LN.spec <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-195"><a href="#cb45-195" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(scanb)</span>
<span id="cb45-196"><a href="#cb45-196" aria-hidden="true" tabindex="-1"></a>node_stage <span class="ot">&lt;-</span> scanb<span class="sc">$</span>node_group</span>
<span id="cb45-197"><a href="#cb45-197" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>node_stage <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb45-198"><a href="#cb45-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">grepl</span>(<span class="st">"1to3"</span>, node_stage),</span>
<span id="cb45-199"><a href="#cb45-199" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N1"</span>,</span>
<span id="cb45-200"><a href="#cb45-200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(</span>
<span id="cb45-201"><a href="#cb45-201" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grepl</span>(<span class="st">"4toX"</span>, node_stage),</span>
<span id="cb45-202"><a href="#cb45-202" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N2and3"</span>,</span>
<span id="cb45-203"><a href="#cb45-203" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(</span>
<span id="cb45-204"><a href="#cb45-204" aria-hidden="true" tabindex="-1"></a>            <span class="fu">grepl</span>(<span class="st">"N0"</span>, node_stage),</span>
<span id="cb45-205"><a href="#cb45-205" aria-hidden="true" tabindex="-1"></a>            <span class="st">"N0"</span>,</span>
<span id="cb45-206"><a href="#cb45-206" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NX"</span></span>
<span id="cb45-207"><a href="#cb45-207" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-208"><a href="#cb45-208" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-209"><a href="#cb45-209" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-210"><a href="#cb45-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-211"><a href="#cb45-211" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb45-212"><a href="#cb45-212" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">tcga =</span> tcga, <span class="at">scanb =</span> scanb, <span class="at">metabric =</span> metabric),</span>
<span id="cb45-213"><a href="#cb45-213" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets.rds"</span></span>
<span id="cb45-214"><a href="#cb45-214" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-215"><a href="#cb45-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-216"><a href="#cb45-216" aria-hidden="true" tabindex="-1"></a>which_exp <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-217"><a href="#cb45-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"logFPKM_TMM"</span>,</span>
<span id="cb45-218"><a href="#cb45-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"logFPKM"</span>,</span>
<span id="cb45-219"><a href="#cb45-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"median_intensity"</span></span>
<span id="cb45-220"><a href="#cb45-220" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-221"><a href="#cb45-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-222"><a href="#cb45-222" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb45-223"><a href="#cb45-223" aria-hidden="true" tabindex="-1"></a>    which_exp,</span>
<span id="cb45-224"><a href="#cb45-224" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/which_exp.rds"</span></span>
<span id="cb45-225"><a href="#cb45-225" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-226"><a href="#cb45-226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-227"><a href="#cb45-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-230"><a href="#cb45-230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-231"><a href="#cb45-231" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../results/rds_files/surv_analysis_estrogen/datasets.rds"</span>)</span>
<span id="cb45-232"><a href="#cb45-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-233"><a href="#cb45-233" aria-hidden="true" tabindex="-1"></a><span class="co"># these are some global parameters for each dataset. important for</span></span>
<span id="cb45-234"><a href="#cb45-234" aria-hidden="true" tabindex="-1"></a><span class="co"># when calculating scores and embeddings.</span></span>
<span id="cb45-235"><a href="#cb45-235" aria-hidden="true" tabindex="-1"></a>which_exp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../results/rds_files/surv_analysis_estrogen/which_exp.rds"</span>)</span>
<span id="cb45-236"><a href="#cb45-236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-237"><a href="#cb45-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-238"><a href="#cb45-238" aria-hidden="true" tabindex="-1"></a><span class="fu">## UMAP projection of the datasets</span></span>
<span id="cb45-239"><a href="#cb45-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-240"><a href="#cb45-240" aria-hidden="true" tabindex="-1"></a>The plots below show how each patient is different in a molecular sense, </span>
<span id="cb45-241"><a href="#cb45-241" aria-hidden="true" tabindex="-1"></a>and even inside each molecular subtype there are some differences. This</span>
<span id="cb45-242"><a href="#cb45-242" aria-hidden="true" tabindex="-1"></a>indicates how different patients, at least molecularly. We only do the umap</span>
<span id="cb45-243"><a href="#cb45-243" aria-hidden="true" tabindex="-1"></a>of samples that have a PAM50 molecular subtype assigned.</span>
<span id="cb45-244"><a href="#cb45-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-245"><a href="#cb45-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb45-246"><a href="#cb45-246" aria-hidden="true" tabindex="-1"></a><span class="co"># first one uses the library uwot to calculate the umap projection.</span></span>
<span id="cb45-247"><a href="#cb45-247" aria-hidden="true" tabindex="-1"></a><span class="co"># using uwot is better than umap as it allows you to make parallel computations</span></span>
<span id="cb45-248"><a href="#cb45-248" aria-hidden="true" tabindex="-1"></a><span class="co"># in a reproducible way.</span></span>
<span id="cb45-249"><a href="#cb45-249" aria-hidden="true" tabindex="-1"></a>umap_projections <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-250"><a href="#cb45-250" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(dataset, name_assay){</span>
<span id="cb45-251"><a href="#cb45-251" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-252"><a href="#cb45-252" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Assay being used:"</span>, name_assay, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-253"><a href="#cb45-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-254"><a href="#cb45-254" aria-hidden="true" tabindex="-1"></a>        samples_to_use <span class="ot">&lt;-</span> <span class="fu">colData</span>(dataset) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-255"><a href="#cb45-255" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">%in%</span> </span>
<span id="cb45-256"><a href="#cb45-256" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(<span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"luma"</span>, <span class="st">"lumb"</span>, <span class="st">"normal"</span>)</span>
<span id="cb45-257"><a href="#cb45-257" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-258"><a href="#cb45-258" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb45-259"><a href="#cb45-259" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-260"><a href="#cb45-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># select most variable genes first</span></span>
<span id="cb45-261"><a href="#cb45-261" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">assay</span>(dataset[, samples_to_use], name_assay) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb45-262"><a href="#cb45-262" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> df[<span class="fu">order</span>(<span class="fu">rowVars</span>(df), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>], ]</span>
<span id="cb45-263"><a href="#cb45-263" aria-hidden="true" tabindex="-1"></a>        df <span class="ot">&lt;-</span> <span class="fu">t</span>(df)</span>
<span id="cb45-264"><a href="#cb45-264" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-265"><a href="#cb45-265" aria-hidden="true" tabindex="-1"></a>        uwot<span class="sc">::</span><span class="fu">umap</span>(</span>
<span id="cb45-266"><a href="#cb45-266" aria-hidden="true" tabindex="-1"></a>            df,</span>
<span id="cb45-267"><a href="#cb45-267" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_threads =</span> <span class="dv">20</span>,</span>
<span id="cb45-268"><a href="#cb45-268" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_sgd_threads =</span> <span class="st">"auto"</span>, </span>
<span id="cb45-269"><a href="#cb45-269" aria-hidden="true" tabindex="-1"></a>            <span class="at">batch =</span> <span class="cn">TRUE</span></span>
<span id="cb45-270"><a href="#cb45-270" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-271"><a href="#cb45-271" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-272"><a href="#cb45-272" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb45-273"><a href="#cb45-273" aria-hidden="true" tabindex="-1"></a>    which_exp,</span>
<span id="cb45-274"><a href="#cb45-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-275"><a href="#cb45-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-276"><a href="#cb45-276" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-277"><a href="#cb45-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-278"><a href="#cb45-278" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb45-279"><a href="#cb45-279" aria-hidden="true" tabindex="-1"></a>    umap_projections, </span>
<span id="cb45-280"><a href="#cb45-280" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/umap_projections.rds"</span></span>
<span id="cb45-281"><a href="#cb45-281" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-282"><a href="#cb45-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-283"><a href="#cb45-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-286"><a href="#cb45-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-287"><a href="#cb45-287" aria-hidden="true" tabindex="-1"></a>umap_projections <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb45-288"><a href="#cb45-288" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/umap_projections.rds"</span></span>
<span id="cb45-289"><a href="#cb45-289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-290"><a href="#cb45-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-291"><a href="#cb45-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-292"><a href="#cb45-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=20}</span></span>
<span id="cb45-293"><a href="#cb45-293" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-surv-umap-all</span></span>
<span id="cb45-294"><a href="#cb45-294" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: UMAP projections of all three cohorts in the following order":" </span></span>
<span id="cb45-295"><a href="#cb45-295" aria-hidden="true" tabindex="-1"></a><span class="co">#|     TCGA, SCANB and METABRIC. They are colored by the PAM50</span></span>
<span id="cb45-296"><a href="#cb45-296" aria-hidden="true" tabindex="-1"></a><span class="co">#|     molecular subtype.</span></span>
<span id="cb45-297"><a href="#cb45-297" aria-hidden="true" tabindex="-1"></a>plots_umap <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-298"><a href="#cb45-298" aria-hidden="true" tabindex="-1"></a>    plot_umap,</span>
<span id="cb45-299"><a href="#cb45-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets,</span>
<span id="cb45-300"><a href="#cb45-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">umap_projection =</span> umap_projections,</span>
<span id="cb45-301"><a href="#cb45-301" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="fu">names</span>(datasets),</span>
<span id="cb45-302"><a href="#cb45-302" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">color_by =</span> <span class="st">"pam50"</span>, <span class="at">point_size =</span> <span class="dv">2</span>, <span class="at">base_size =</span> <span class="dv">20</span>),</span>
<span id="cb45-303"><a href="#cb45-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-304"><a href="#cb45-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-305"><a href="#cb45-305" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-306"><a href="#cb45-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-307"><a href="#cb45-307" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plots_umap, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb45-308"><a href="#cb45-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-309"><a href="#cb45-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-310"><a href="#cb45-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb45-311"><a href="#cb45-311" aria-hidden="true" tabindex="-1"></a>width_plot <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb45-312"><a href="#cb45-312" aria-hidden="true" tabindex="-1"></a>height_plot <span class="ot">&lt;-</span> width_plot<span class="sc">/</span><span class="fl">1.6</span></span>
<span id="cb45-313"><a href="#cb45-313" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(</span>
<span id="cb45-314"><a href="#cb45-314" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/plots/surv_analysis_estrogen/umap/"</span>, </span>
<span id="cb45-315"><a href="#cb45-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb45-316"><a href="#cb45-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb45-317"><a href="#cb45-317" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-318"><a href="#cb45-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-319"><a href="#cb45-319" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-320"><a href="#cb45-320" aria-hidden="true" tabindex="-1"></a>    ggsave,</span>
<span id="cb45-321"><a href="#cb45-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> plots_umap,</span>
<span id="cb45-322"><a href="#cb45-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-323"><a href="#cb45-323" aria-hidden="true" tabindex="-1"></a>        <span class="st">"../results/plots/surv_analysis_estrogen/umap/"</span>,</span>
<span id="cb45-324"><a href="#cb45-324" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(plots_umap),</span>
<span id="cb45-325"><a href="#cb45-325" aria-hidden="true" tabindex="-1"></a>        <span class="st">".pdf"</span></span>
<span id="cb45-326"><a href="#cb45-326" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-327"><a href="#cb45-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">width =</span> width_plot, <span class="at">height =</span> height_plot)</span>
<span id="cb45-328"><a href="#cb45-328" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-329"><a href="#cb45-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-330"><a href="#cb45-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-331"><a href="#cb45-331" aria-hidden="true" tabindex="-1"></a>From the plots above we see a distinction of the different molecular subtypes.</span>
<span id="cb45-332"><a href="#cb45-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-333"><a href="#cb45-333" aria-hidden="true" tabindex="-1"></a><span class="fu">## Calculating scores</span></span>
<span id="cb45-334"><a href="#cb45-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-335"><a href="#cb45-335" aria-hidden="true" tabindex="-1"></a>In order to calculate the scores, the package <span class="in">`msigdb`</span> is used to load</span>
<span id="cb45-336"><a href="#cb45-336" aria-hidden="true" tabindex="-1"></a>the hallmark data into R. The $SET_{ER/PR}$ is made of the following genes:</span>
<span id="cb45-337"><a href="#cb45-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-340"><a href="#cb45-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-341"><a href="#cb45-341" aria-hidden="true" tabindex="-1"></a><span class="co"># data is available in the supplementary material of the paper </span></span>
<span id="cb45-342"><a href="#cb45-342" aria-hidden="true" tabindex="-1"></a>seterpr <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"../data/seterpr.tsv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-343"><a href="#cb45-343" aria-hidden="true" tabindex="-1"></a>seterpr<span class="sc">$</span>is_target <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"yes"</span>, <span class="dv">18</span>), <span class="fu">rep</span>(<span class="st">"no"</span>, <span class="dv">10</span>))</span>
<span id="cb45-344"><a href="#cb45-344" aria-hidden="true" tabindex="-1"></a>seterpr <span class="sc">%&gt;%</span> kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-345"><a href="#cb45-345" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-346"><a href="#cb45-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-347"><a href="#cb45-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-348"><a href="#cb45-348" aria-hidden="true" tabindex="-1"></a>The first 18 genes are considered to be the target genes, the last 10 genes</span>
<span id="cb45-349"><a href="#cb45-349" aria-hidden="true" tabindex="-1"></a>are the genes used for reference. According to their paper, the score is </span>
<span id="cb45-350"><a href="#cb45-350" aria-hidden="true" tabindex="-1"></a>calculated in the following way:</span>
<span id="cb45-351"><a href="#cb45-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-352"><a href="#cb45-352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb45-353"><a href="#cb45-353" aria-hidden="true" tabindex="-1"></a>SET_{ER/PR} = \sum_{i = 1}^{18} \frac{T_i}{18} - \sum_{j=1}^{10}\frac{R_j}{10} + 2</span>
<span id="cb45-354"><a href="#cb45-354" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb45-355"><a href="#cb45-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-356"><a href="#cb45-356" aria-hidden="true" tabindex="-1"></a>Where $T_i$ are the expression levels of target genes and $R_j$ are the</span>
<span id="cb45-357"><a href="#cb45-357" aria-hidden="true" tabindex="-1"></a>expression levels of the reference genes. Here we use GSVA to calculate</span>
<span id="cb45-358"><a href="#cb45-358" aria-hidden="true" tabindex="-1"></a>the scores, even when using their genes. </span>
<span id="cb45-359"><a href="#cb45-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-360"><a href="#cb45-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb45-361"><a href="#cb45-361" aria-hidden="true" tabindex="-1"></a>all_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(datasets, rownames) <span class="sc">%&gt;%</span> unlist <span class="sc">%&gt;%</span> unique</span>
<span id="cb45-362"><a href="#cb45-362" aria-hidden="true" tabindex="-1"></a><span class="co"># now load the msigdbr and concatenate with set erpr</span></span>
<span id="cb45-363"><a href="#cb45-363" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> msigdbr<span class="sc">::</span><span class="fu">msigdbr</span>(<span class="at">species =</span> <span class="st">"Homo sapiens"</span>, <span class="at">category =</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-364"><a href="#cb45-364" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(gs_name, gene_symbol) <span class="sc">%&gt;%</span></span>
<span id="cb45-365"><a href="#cb45-365" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb45-366"><a href="#cb45-366" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb45-367"><a href="#cb45-367" aria-hidden="true" tabindex="-1"></a>        seterpr <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_target <span class="sc">==</span> <span class="st">"yes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-368"><a href="#cb45-368" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb45-369"><a href="#cb45-369" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">gene_symbol =</span> ID) <span class="sc">%&gt;%</span></span>
<span id="cb45-370"><a href="#cb45-370" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">gs_name =</span> <span class="st">"SET_ERPR"</span>)</span>
<span id="cb45-371"><a href="#cb45-371" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb45-372"><a href="#cb45-372" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb45-373"><a href="#cb45-373" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb45-374"><a href="#cb45-374" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">gene_symbol =</span> <span class="fu">sample</span>(all_genes, <span class="dv">200</span>), <span class="at">gs_name =</span> <span class="st">"random_200"</span>)</span>
<span id="cb45-375"><a href="#cb45-375" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb45-376"><a href="#cb45-376" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb45-377"><a href="#cb45-377" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb45-378"><a href="#cb45-378" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">gene_symbol =</span> <span class="fu">sample</span>(all_genes, <span class="dv">18</span>), <span class="at">gs_name =</span> <span class="st">"random_18"</span>)</span>
<span id="cb45-379"><a href="#cb45-379" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-380"><a href="#cb45-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-381"><a href="#cb45-381" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gene_sets, <span class="st">"../results/rds_files/surv_analysis_estrogen/gene_sets.rds"</span>)</span>
<span id="cb45-382"><a href="#cb45-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-383"><a href="#cb45-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-384"><a href="#cb45-384" aria-hidden="true" tabindex="-1"></a>Before we calculate any score, let us check the number of genes available</span>
<span id="cb45-385"><a href="#cb45-385" aria-hidden="true" tabindex="-1"></a>for each pathway in each dataset. This is important, in other to have</span>
<span id="cb45-386"><a href="#cb45-386" aria-hidden="true" tabindex="-1"></a>robust scores, most of the genes should be available in the datasets. We also</span>
<span id="cb45-387"><a href="#cb45-387" aria-hidden="true" tabindex="-1"></a>add signatures of 18 and 200 random genes for control. </span>
<span id="cb45-388"><a href="#cb45-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-391"><a href="#cb45-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-392"><a href="#cb45-392" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../results/rds_files/surv_analysis_estrogen/gene_sets.rds"</span>)</span>
<span id="cb45-393"><a href="#cb45-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-394"><a href="#cb45-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-397"><a href="#cb45-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-398"><a href="#cb45-398" aria-hidden="true" tabindex="-1"></a>genes_each_dataset <span class="ot">&lt;-</span> <span class="fu">lapply</span>(datasets, rownames)</span>
<span id="cb45-399"><a href="#cb45-399" aria-hidden="true" tabindex="-1"></a>genes_intersection <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb45-400"><a href="#cb45-400" aria-hidden="true" tabindex="-1"></a>    gene_sets<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique,</span>
<span id="cb45-401"><a href="#cb45-401" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(set_name, gene_sets, genes_each_dataset){</span>
<span id="cb45-402"><a href="#cb45-402" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb45-403"><a href="#cb45-403" aria-hidden="true" tabindex="-1"></a>            genes_each_dataset,</span>
<span id="cb45-404"><a href="#cb45-404" aria-hidden="true" tabindex="-1"></a>            intersect,</span>
<span id="cb45-405"><a href="#cb45-405" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> gene_sets <span class="sc">%&gt;%</span> </span>
<span id="cb45-406"><a href="#cb45-406" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">==</span> set_name) <span class="sc">%&gt;%</span></span>
<span id="cb45-407"><a href="#cb45-407" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">pull</span>(gene_symbol)</span>
<span id="cb45-408"><a href="#cb45-408" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-409"><a href="#cb45-409" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-410"><a href="#cb45-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets,</span>
<span id="cb45-411"><a href="#cb45-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes_each_dataset =</span> genes_each_dataset,</span>
<span id="cb45-412"><a href="#cb45-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-413"><a href="#cb45-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb45-414"><a href="#cb45-414" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-415"><a href="#cb45-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-416"><a href="#cb45-416" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(genes_intersection, <span class="cf">function</span>(x) <span class="fu">sapply</span>(x, length)) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span></span>
<span id="cb45-417"><a href="#cb45-417" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-418"><a href="#cb45-418" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"pathway"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-419"><a href="#cb45-419" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb45-420"><a href="#cb45-420" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb45-421"><a href="#cb45-421" aria-hidden="true" tabindex="-1"></a>        gene_sets <span class="sc">%&gt;%</span> </span>
<span id="cb45-422"><a href="#cb45-422" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(gs_name) <span class="sc">%&gt;%</span></span>
<span id="cb45-423"><a href="#cb45-423" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb45-424"><a href="#cb45-424" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">pathway =</span> gs_name),</span>
<span id="cb45-425"><a href="#cb45-425" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"pathway"</span></span>
<span id="cb45-426"><a href="#cb45-426" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-427"><a href="#cb45-427" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-428"><a href="#cb45-428" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">average_percentage =</span> <span class="fu">format</span>(<span class="fu">mean</span>(</span>
<span id="cb45-429"><a href="#cb45-429" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(tcga<span class="sc">/</span>n, scanb<span class="sc">/</span>n, metabric<span class="sc">/</span>n)</span>
<span id="cb45-430"><a href="#cb45-430" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb45-431"><a href="#cb45-431" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb45-432"><a href="#cb45-432" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb45-433"><a href="#cb45-433" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-434"><a href="#cb45-434" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-435"><a href="#cb45-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-436"><a href="#cb45-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-437"><a href="#cb45-437" aria-hidden="true" tabindex="-1"></a>Most of the genes are available in all datasets. When calculating scores</span>
<span id="cb45-438"><a href="#cb45-438" aria-hidden="true" tabindex="-1"></a>it is always good to check the availability of the genes. Otherwise this</span>
<span id="cb45-439"><a href="#cb45-439" aria-hidden="true" tabindex="-1"></a>can make the score unstable, since too many of the genes are missing. </span>
<span id="cb45-440"><a href="#cb45-440" aria-hidden="true" tabindex="-1"></a>For example, </span>
<span id="cb45-441"><a href="#cb45-441" aria-hidden="true" tabindex="-1"></a>HALLMARK_PANCREAS_BETA_CELLS might have an unstable score, due to a lot </span>
<span id="cb45-442"><a href="#cb45-442" aria-hidden="true" tabindex="-1"></a>of genes missing. </span>
<span id="cb45-443"><a href="#cb45-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-444"><a href="#cb45-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb45-445"><a href="#cb45-445" aria-hidden="true" tabindex="-1"></a>which_exp <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-446"><a href="#cb45-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"logFPKM_TMM"</span>,</span>
<span id="cb45-447"><a href="#cb45-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"logFPKM"</span>,</span>
<span id="cb45-448"><a href="#cb45-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"median_intensity"</span></span>
<span id="cb45-449"><a href="#cb45-449" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-450"><a href="#cb45-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-451"><a href="#cb45-451" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb45-452"><a href="#cb45-452" aria-hidden="true" tabindex="-1"></a>    gene_sets<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique,</span>
<span id="cb45-453"><a href="#cb45-453" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, gene_sets) gene_sets <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb45-454"><a href="#cb45-454" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(gene_symbol),</span>
<span id="cb45-455"><a href="#cb45-455" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets,</span>
<span id="cb45-456"><a href="#cb45-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-457"><a href="#cb45-457" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb45-458"><a href="#cb45-458" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-459"><a href="#cb45-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-460"><a href="#cb45-460" aria-hidden="true" tabindex="-1"></a>gsva_scores <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-461"><a href="#cb45-461" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(sum_exp, which_assay, gene_sets){</span>
<span id="cb45-462"><a href="#cb45-462" aria-hidden="true" tabindex="-1"></a>        GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb45-463"><a href="#cb45-463" aria-hidden="true" tabindex="-1"></a>            <span class="at">expr =</span> <span class="fu">as.matrix</span>(<span class="fu">assay</span>(sum_exp, which_assay)),</span>
<span id="cb45-464"><a href="#cb45-464" aria-hidden="true" tabindex="-1"></a>            <span class="at">gset.idx.list =</span> gene_sets, </span>
<span id="cb45-465"><a href="#cb45-465" aria-hidden="true" tabindex="-1"></a>            <span class="at">parallel.sz =</span> <span class="dv">10</span></span>
<span id="cb45-466"><a href="#cb45-466" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-467"><a href="#cb45-467" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-468"><a href="#cb45-468" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets,</span>
<span id="cb45-469"><a href="#cb45-469" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_assay =</span> which_exp,</span>
<span id="cb45-470"><a href="#cb45-470" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">gene_sets =</span> gene_sets),</span>
<span id="cb45-471"><a href="#cb45-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb45-472"><a href="#cb45-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span></span>
<span id="cb45-473"><a href="#cb45-473" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-474"><a href="#cb45-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-475"><a href="#cb45-475" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-476"><a href="#cb45-476" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(gsva_score, dataset){</span>
<span id="cb45-477"><a href="#cb45-477" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(dataset)[, <span class="fu">rownames</span>(gsva_score)] <span class="ot">&lt;-</span> <span class="fu">t</span>(gsva_score)</span>
<span id="cb45-478"><a href="#cb45-478" aria-hidden="true" tabindex="-1"></a>        dataset</span>
<span id="cb45-479"><a href="#cb45-479" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-480"><a href="#cb45-480" aria-hidden="true" tabindex="-1"></a>    gsva_scores,</span>
<span id="cb45-481"><a href="#cb45-481" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb45-482"><a href="#cb45-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-483"><a href="#cb45-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-484"><a href="#cb45-484" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-485"><a href="#cb45-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-486"><a href="#cb45-486" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb45-487"><a href="#cb45-487" aria-hidden="true" tabindex="-1"></a>    gsva_scores, </span>
<span id="cb45-488"><a href="#cb45-488" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/gsva_scores.rds"</span></span>
<span id="cb45-489"><a href="#cb45-489" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-490"><a href="#cb45-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-491"><a href="#cb45-491" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb45-492"><a href="#cb45-492" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb45-493"><a href="#cb45-493" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets_with_scores.rds"</span></span>
<span id="cb45-494"><a href="#cb45-494" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-495"><a href="#cb45-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-496"><a href="#cb45-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-499"><a href="#cb45-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-500"><a href="#cb45-500" aria-hidden="true" tabindex="-1"></a>gsva_scores <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb45-501"><a href="#cb45-501" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/gsva_scores.rds"</span></span>
<span id="cb45-502"><a href="#cb45-502" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-503"><a href="#cb45-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-504"><a href="#cb45-504" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb45-505"><a href="#cb45-505" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets_with_scores.rds"</span></span>
<span id="cb45-506"><a href="#cb45-506" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-507"><a href="#cb45-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-508"><a href="#cb45-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-509"><a href="#cb45-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-510"><a href="#cb45-510" aria-hidden="true" tabindex="-1"></a>For each dataset one can plot the differences in scores for ER+ and ER- BC</span>
<span id="cb45-511"><a href="#cb45-511" aria-hidden="true" tabindex="-1"></a>patients. This should be already an indication that the scores are meaningful.</span>
<span id="cb45-512"><a href="#cb45-512" aria-hidden="true" tabindex="-1"></a>The next sections shows the results for each dataset individually.</span>
<span id="cb45-513"><a href="#cb45-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-516"><a href="#cb45-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-517"><a href="#cb45-517" aria-hidden="true" tabindex="-1"></a>plot_scores <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-518"><a href="#cb45-518" aria-hidden="true" tabindex="-1"></a>which_scores <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb45-519"><a href="#cb45-519" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb45-520"><a href="#cb45-520" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span>,</span>
<span id="cb45-521"><a href="#cb45-521" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>,</span>
<span id="cb45-522"><a href="#cb45-522" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span>,</span>
<span id="cb45-523"><a href="#cb45-523" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span></span>
<span id="cb45-524"><a href="#cb45-524" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-525"><a href="#cb45-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-526"><a href="#cb45-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-527"><a href="#cb45-527" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb45-528"><a href="#cb45-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-529"><a href="#cb45-529" aria-hidden="true" tabindex="-1"></a><span class="fu">### TCGA</span></span>
<span id="cb45-530"><a href="#cb45-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-533"><a href="#cb45-533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-534"><a href="#cb45-534" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"tcga"</span></span>
<span id="cb45-535"><a href="#cb45-535" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-536"><a href="#cb45-536" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb45-537"><a href="#cb45-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb45-538"><a href="#cb45-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb45-539"><a href="#cb45-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-540"><a href="#cb45-540" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb45-541"><a href="#cb45-541" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> <span class="st">"er_status"</span>, </span>
<span id="cb45-542"><a href="#cb45-542" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> <span class="st">"pam50"</span>,</span>
<span id="cb45-543"><a href="#cb45-543" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb45-544"><a href="#cb45-544" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb45-545"><a href="#cb45-545" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-546"><a href="#cb45-546" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-547"><a href="#cb45-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-548"><a href="#cb45-548" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-549"><a href="#cb45-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-550"><a href="#cb45-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-551"><a href="#cb45-551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb45-552"><a href="#cb45-552" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-tcga</span></span>
<span id="cb45-553"><a href="#cb45-553" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for TCGA patients</span></span>
<span id="cb45-554"><a href="#cb45-554" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb45-555"><a href="#cb45-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-556"><a href="#cb45-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-557"><a href="#cb45-557" aria-hidden="true" tabindex="-1"></a><span class="fu">### METABRIC</span></span>
<span id="cb45-558"><a href="#cb45-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-561"><a href="#cb45-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-562"><a href="#cb45-562" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"metabric"</span></span>
<span id="cb45-563"><a href="#cb45-563" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-564"><a href="#cb45-564" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb45-565"><a href="#cb45-565" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb45-566"><a href="#cb45-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb45-567"><a href="#cb45-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-568"><a href="#cb45-568" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb45-569"><a href="#cb45-569" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> <span class="st">"er_status"</span>, </span>
<span id="cb45-570"><a href="#cb45-570" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> <span class="st">"pam50"</span>,</span>
<span id="cb45-571"><a href="#cb45-571" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb45-572"><a href="#cb45-572" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb45-573"><a href="#cb45-573" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-574"><a href="#cb45-574" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-575"><a href="#cb45-575" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-576"><a href="#cb45-576" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-577"><a href="#cb45-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-578"><a href="#cb45-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-579"><a href="#cb45-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb45-580"><a href="#cb45-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric</span></span>
<span id="cb45-581"><a href="#cb45-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for METABRIC patients</span></span>
<span id="cb45-582"><a href="#cb45-582" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb45-583"><a href="#cb45-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-584"><a href="#cb45-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-585"><a href="#cb45-585" aria-hidden="true" tabindex="-1"></a><span class="fu">### SCANB</span></span>
<span id="cb45-586"><a href="#cb45-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-589"><a href="#cb45-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-590"><a href="#cb45-590" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"scanb"</span></span>
<span id="cb45-591"><a href="#cb45-591" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-592"><a href="#cb45-592" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb45-593"><a href="#cb45-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb45-594"><a href="#cb45-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb45-595"><a href="#cb45-595" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-596"><a href="#cb45-596" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb45-597"><a href="#cb45-597" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> <span class="st">"er_status"</span>, </span>
<span id="cb45-598"><a href="#cb45-598" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> <span class="st">"pam50"</span>,</span>
<span id="cb45-599"><a href="#cb45-599" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb45-600"><a href="#cb45-600" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb45-601"><a href="#cb45-601" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-602"><a href="#cb45-602" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-603"><a href="#cb45-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-604"><a href="#cb45-604" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-605"><a href="#cb45-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-606"><a href="#cb45-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-607"><a href="#cb45-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb45-608"><a href="#cb45-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-scanb</span></span>
<span id="cb45-609"><a href="#cb45-609" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for SCANB patients</span></span>
<span id="cb45-610"><a href="#cb45-610" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb45-611"><a href="#cb45-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-612"><a href="#cb45-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-613"><a href="#cb45-613" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb45-614"><a href="#cb45-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-615"><a href="#cb45-615" aria-hidden="true" tabindex="-1"></a>From the plots above one can conclude that three different estrogen pathways</span>
<span id="cb45-616"><a href="#cb45-616" aria-hidden="true" tabindex="-1"></a>capture the differences between ER status and also molecular subtypes.</span>
<span id="cb45-617"><a href="#cb45-617" aria-hidden="true" tabindex="-1"></a>There are two plots with random genes for control and we can see that</span>
<span id="cb45-618"><a href="#cb45-618" aria-hidden="true" tabindex="-1"></a>there is no difference between the ER status when using those gene sets.</span>
<span id="cb45-619"><a href="#cb45-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-620"><a href="#cb45-620" aria-hidden="true" tabindex="-1"></a>Below is a combined image for TCGA, SCANB and METABRIC using the $SET_{ER/PR}$</span>
<span id="cb45-621"><a href="#cb45-621" aria-hidden="true" tabindex="-1"></a>signature.</span>
<span id="cb45-622"><a href="#cb45-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-623"><a href="#cb45-623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=10, fig.width = 6}</span></span>
<span id="cb45-624"><a href="#cb45-624" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric-tcga-scanb</span></span>
<span id="cb45-625"><a href="#cb45-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: SET ER/PR scores for all three cohorts.</span></span>
<span id="cb45-626"><a href="#cb45-626" aria-hidden="true" tabindex="-1"></a>pathway_to_get <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>)</span>
<span id="cb45-627"><a href="#cb45-627" aria-hidden="true" tabindex="-1"></a>cols_to_select <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pam50"</span>, <span class="st">"er_status"</span>, <span class="fu">names</span>(pathway_to_get))</span>
<span id="cb45-628"><a href="#cb45-628" aria-hidden="true" tabindex="-1"></a>selected_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb45-629"><a href="#cb45-629" aria-hidden="true" tabindex="-1"></a>    plot_scores,</span>
<span id="cb45-630"><a href="#cb45-630" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span>pluck,</span>
<span id="cb45-631"><a href="#cb45-631" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>, </span>
<span id="cb45-632"><a href="#cb45-632" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span></span>
<span id="cb45-633"><a href="#cb45-633" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-634"><a href="#cb45-634" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(., \(x) x[, cols_to_select]) <span class="sc">%&gt;%</span></span>
<span id="cb45-635"><a href="#cb45-635" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-636"><a href="#cb45-636" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">%in%</span> <span class="fu">levels</span>(pam50))</span>
<span id="cb45-637"><a href="#cb45-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-638"><a href="#cb45-638" aria-hidden="true" tabindex="-1"></a>selected_data <span class="sc">%&gt;%</span> </span>
<span id="cb45-639"><a href="#cb45-639" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb45-640"><a href="#cb45-640" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> er_status, </span>
<span id="cb45-641"><a href="#cb45-641" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">names</span>(pathway_to_get)),</span>
<span id="cb45-642"><a href="#cb45-642" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb45-643"><a href="#cb45-643" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb45-644"><a href="#cb45-644" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb45-645"><a href="#cb45-645" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb45-646"><a href="#cb45-646" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span><span class="fl">0.05</span>, </span>
<span id="cb45-647"><a href="#cb45-647" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb45-648"><a href="#cb45-648" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb45-649"><a href="#cb45-649" aria-hidden="true" tabindex="-1"></a>        <span class="at">outlier.shape =</span> <span class="cn">NA</span></span>
<span id="cb45-650"><a href="#cb45-650" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb45-651"><a href="#cb45-651" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb45-652"><a href="#cb45-652" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb45-653"><a href="#cb45-653" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span>cohort, </span>
<span id="cb45-654"><a href="#cb45-654" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb45-655"><a href="#cb45-655" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb45-656"><a href="#cb45-656" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tcga"</span> <span class="ot">=</span> <span class="st">"TCGA"</span>,</span>
<span id="cb45-657"><a href="#cb45-657" aria-hidden="true" tabindex="-1"></a>            <span class="st">"metabric"</span> <span class="ot">=</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb45-658"><a href="#cb45-658" aria-hidden="true" tabindex="-1"></a>            <span class="st">"scanb"</span> <span class="ot">=</span> <span class="st">"SCANB"</span></span>
<span id="cb45-659"><a href="#cb45-659" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb45-660"><a href="#cb45-660" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span> </span>
<span id="cb45-661"><a href="#cb45-661" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-662"><a href="#cb45-662" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER status"</span>,</span>
<span id="cb45-663"><a href="#cb45-663" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb45-664"><a href="#cb45-664" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"SET ER/PR score"</span>,</span>
<span id="cb45-665"><a href="#cb45-665" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(pathway_to_get[<span class="dv">1</span>], <span class="st">" scores by cohort"</span>)</span>
<span id="cb45-666"><a href="#cb45-666" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb45-667"><a href="#cb45-667" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb45-668"><a href="#cb45-668" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(selected_data)) <span class="sc">+</span></span>
<span id="cb45-669"><a href="#cb45-669" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb45-670"><a href="#cb45-670" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb45-671"><a href="#cb45-671" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>))</span>
<span id="cb45-672"><a href="#cb45-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-673"><a href="#cb45-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-674"><a href="#cb45-674" aria-hidden="true" tabindex="-1"></a>And now using the hallmark estrogen response early.</span>
<span id="cb45-675"><a href="#cb45-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-676"><a href="#cb45-676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=10, fig.width = 6}</span></span>
<span id="cb45-677"><a href="#cb45-677" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric-tcga-scanb-estrogen-early</span></span>
<span id="cb45-678"><a href="#cb45-678" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Estrogen early scores for all three cohorts.</span></span>
<span id="cb45-679"><a href="#cb45-679" aria-hidden="true" tabindex="-1"></a>pathway_to_get <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>)</span>
<span id="cb45-680"><a href="#cb45-680" aria-hidden="true" tabindex="-1"></a>cols_to_select <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pam50"</span>, <span class="st">"er_status"</span>, <span class="fu">names</span>(pathway_to_get))</span>
<span id="cb45-681"><a href="#cb45-681" aria-hidden="true" tabindex="-1"></a>selected_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb45-682"><a href="#cb45-682" aria-hidden="true" tabindex="-1"></a>    plot_scores,</span>
<span id="cb45-683"><a href="#cb45-683" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span>pluck,</span>
<span id="cb45-684"><a href="#cb45-684" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>, </span>
<span id="cb45-685"><a href="#cb45-685" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span></span>
<span id="cb45-686"><a href="#cb45-686" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-687"><a href="#cb45-687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(., \(x) x[, cols_to_select]) <span class="sc">%&gt;%</span></span>
<span id="cb45-688"><a href="#cb45-688" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>)</span>
<span id="cb45-689"><a href="#cb45-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-690"><a href="#cb45-690" aria-hidden="true" tabindex="-1"></a>selected_data <span class="sc">%&gt;%</span> </span>
<span id="cb45-691"><a href="#cb45-691" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb45-692"><a href="#cb45-692" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> er_status, </span>
<span id="cb45-693"><a href="#cb45-693" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">names</span>(pathway_to_get)),</span>
<span id="cb45-694"><a href="#cb45-694" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb45-695"><a href="#cb45-695" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb45-696"><a href="#cb45-696" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb45-697"><a href="#cb45-697" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb45-698"><a href="#cb45-698" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb45-699"><a href="#cb45-699" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span><span class="fl">0.05</span>, </span>
<span id="cb45-700"><a href="#cb45-700" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb45-701"><a href="#cb45-701" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb45-702"><a href="#cb45-702" aria-hidden="true" tabindex="-1"></a>        <span class="at">outlier.shape =</span> <span class="cn">NA</span></span>
<span id="cb45-703"><a href="#cb45-703" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb45-704"><a href="#cb45-704" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb45-705"><a href="#cb45-705" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span>cohort, </span>
<span id="cb45-706"><a href="#cb45-706" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb45-707"><a href="#cb45-707" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb45-708"><a href="#cb45-708" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tcga"</span> <span class="ot">=</span> <span class="st">"TCGA"</span>,</span>
<span id="cb45-709"><a href="#cb45-709" aria-hidden="true" tabindex="-1"></a>            <span class="st">"metabric"</span> <span class="ot">=</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb45-710"><a href="#cb45-710" aria-hidden="true" tabindex="-1"></a>            <span class="st">"scanb"</span> <span class="ot">=</span> <span class="st">"SCANB"</span></span>
<span id="cb45-711"><a href="#cb45-711" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb45-712"><a href="#cb45-712" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span> </span>
<span id="cb45-713"><a href="#cb45-713" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-714"><a href="#cb45-714" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER status"</span>,</span>
<span id="cb45-715"><a href="#cb45-715" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb45-716"><a href="#cb45-716" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Estrogen early score"</span>,</span>
<span id="cb45-717"><a href="#cb45-717" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(pathway_to_get[<span class="dv">1</span>], <span class="st">" scores by cohort"</span>)</span>
<span id="cb45-718"><a href="#cb45-718" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb45-719"><a href="#cb45-719" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb45-720"><a href="#cb45-720" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(selected_data)) <span class="sc">+</span></span>
<span id="cb45-721"><a href="#cb45-721" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb45-722"><a href="#cb45-722" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb45-723"><a href="#cb45-723" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>))</span>
<span id="cb45-724"><a href="#cb45-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-725"><a href="#cb45-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-726"><a href="#cb45-726" aria-hidden="true" tabindex="-1"></a>Another way to look at the data is to plot by molecular subtype instead</span>
<span id="cb45-727"><a href="#cb45-727" aria-hidden="true" tabindex="-1"></a>of ER status.</span>
<span id="cb45-728"><a href="#cb45-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-729"><a href="#cb45-729" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb45-730"><a href="#cb45-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-731"><a href="#cb45-731" aria-hidden="true" tabindex="-1"></a><span class="fu">### TCGA</span></span>
<span id="cb45-732"><a href="#cb45-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-735"><a href="#cb45-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-736"><a href="#cb45-736" aria-hidden="true" tabindex="-1"></a>clinical_variable <span class="ot">&lt;-</span> <span class="st">"pam50"</span></span>
<span id="cb45-737"><a href="#cb45-737" aria-hidden="true" tabindex="-1"></a>color_by <span class="ot">&lt;-</span> <span class="st">"er_status"</span></span>
<span id="cb45-738"><a href="#cb45-738" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-739"><a href="#cb45-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-740"><a href="#cb45-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-743"><a href="#cb45-743" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-744"><a href="#cb45-744" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"tcga"</span></span>
<span id="cb45-745"><a href="#cb45-745" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-746"><a href="#cb45-746" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb45-747"><a href="#cb45-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb45-748"><a href="#cb45-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb45-749"><a href="#cb45-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-750"><a href="#cb45-750" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb45-751"><a href="#cb45-751" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> clinical_variable, </span>
<span id="cb45-752"><a href="#cb45-752" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> color_by,</span>
<span id="cb45-753"><a href="#cb45-753" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb45-754"><a href="#cb45-754" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb45-755"><a href="#cb45-755" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-756"><a href="#cb45-756" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-757"><a href="#cb45-757" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-758"><a href="#cb45-758" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-759"><a href="#cb45-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-760"><a href="#cb45-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-761"><a href="#cb45-761" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb45-762"><a href="#cb45-762" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-tcga-pam50</span></span>
<span id="cb45-763"><a href="#cb45-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for TCGA patients stratified by PAM50 molecular subtype</span></span>
<span id="cb45-764"><a href="#cb45-764" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb45-765"><a href="#cb45-765" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-766"><a href="#cb45-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-767"><a href="#cb45-767" aria-hidden="true" tabindex="-1"></a><span class="fu">### METABRIC</span></span>
<span id="cb45-768"><a href="#cb45-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-771"><a href="#cb45-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-772"><a href="#cb45-772" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"metabric"</span></span>
<span id="cb45-773"><a href="#cb45-773" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-774"><a href="#cb45-774" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb45-775"><a href="#cb45-775" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb45-776"><a href="#cb45-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb45-777"><a href="#cb45-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-778"><a href="#cb45-778" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb45-779"><a href="#cb45-779" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> clinical_variable, </span>
<span id="cb45-780"><a href="#cb45-780" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> color_by,</span>
<span id="cb45-781"><a href="#cb45-781" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb45-782"><a href="#cb45-782" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb45-783"><a href="#cb45-783" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-784"><a href="#cb45-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-785"><a href="#cb45-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-786"><a href="#cb45-786" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-787"><a href="#cb45-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-788"><a href="#cb45-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-789"><a href="#cb45-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb45-790"><a href="#cb45-790" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-metabric-pam50</span></span>
<span id="cb45-791"><a href="#cb45-791" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for METABRIC patients stratified by PAM50 molecular subtype</span></span>
<span id="cb45-792"><a href="#cb45-792" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb45-793"><a href="#cb45-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-794"><a href="#cb45-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-795"><a href="#cb45-795" aria-hidden="true" tabindex="-1"></a><span class="fu">### SCANB</span></span>
<span id="cb45-796"><a href="#cb45-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-799"><a href="#cb45-799" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-800"><a href="#cb45-800" aria-hidden="true" tabindex="-1"></a>which_dataset <span class="ot">&lt;-</span> <span class="st">"scanb"</span></span>
<span id="cb45-801"><a href="#cb45-801" aria-hidden="true" tabindex="-1"></a>plot_scores[[which_dataset]] <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-802"><a href="#cb45-802" aria-hidden="true" tabindex="-1"></a>    plot_scores_vs_clinics,</span>
<span id="cb45-803"><a href="#cb45-803" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_score =</span> which_scores,</span>
<span id="cb45-804"><a href="#cb45-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> which_scores,</span>
<span id="cb45-805"><a href="#cb45-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-806"><a href="#cb45-806" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_exp =</span> datasets[[which_dataset]],</span>
<span id="cb45-807"><a href="#cb45-807" aria-hidden="true" tabindex="-1"></a>        <span class="at">clinical_variable =</span> clinical_variable, </span>
<span id="cb45-808"><a href="#cb45-808" aria-hidden="true" tabindex="-1"></a>        <span class="at">color_by =</span> color_by,</span>
<span id="cb45-809"><a href="#cb45-809" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb45-810"><a href="#cb45-810" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size =</span> <span class="fl">0.5</span></span>
<span id="cb45-811"><a href="#cb45-811" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-812"><a href="#cb45-812" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-813"><a href="#cb45-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-814"><a href="#cb45-814" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-815"><a href="#cb45-815" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-816"><a href="#cb45-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-817"><a href="#cb45-817" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=8}</span></span>
<span id="cb45-818"><a href="#cb45-818" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-scanb-pam50</span></span>
<span id="cb45-819"><a href="#cb45-819" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for SCANB patients stratified by PAM50 molecular subtype</span></span>
<span id="cb45-820"><a href="#cb45-820" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plot_scores[[which_dataset]], <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb45-821"><a href="#cb45-821" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-822"><a href="#cb45-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-823"><a href="#cb45-823" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb45-824"><a href="#cb45-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-825"><a href="#cb45-825" aria-hidden="true" tabindex="-1"></a>In all cohorts the luminal A and B patients have a similar score. Also</span>
<span id="cb45-826"><a href="#cb45-826" aria-hidden="true" tabindex="-1"></a>the distinction is very clear between the basal and HER2-like patients</span>
<span id="cb45-827"><a href="#cb45-827" aria-hidden="true" tabindex="-1"></a>versus luminal A and B.</span>
<span id="cb45-828"><a href="#cb45-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-829"><a href="#cb45-829" aria-hidden="true" tabindex="-1"></a>One question that usually arises when calculating scores from gene sets is</span>
<span id="cb45-830"><a href="#cb45-830" aria-hidden="true" tabindex="-1"></a>if proliferation associated genes (PAG) are driving the distinctions. </span>
<span id="cb45-831"><a href="#cb45-831" aria-hidden="true" tabindex="-1"></a>These signatures are highly curated and they have close or no PAGs. </span>
<span id="cb45-832"><a href="#cb45-832" aria-hidden="true" tabindex="-1"></a>Therefore, the scores are not affected by PAGs and they really reflect the</span>
<span id="cb45-833"><a href="#cb45-833" aria-hidden="true" tabindex="-1"></a>biology.</span>
<span id="cb45-834"><a href="#cb45-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-835"><a href="#cb45-835" aria-hidden="true" tabindex="-1"></a>Lastly we show in @fig-scores-scanb-esr1 the correlation of </span>
<span id="cb45-836"><a href="#cb45-836" aria-hidden="true" tabindex="-1"></a>the estrogen signaling scores with the signatures. </span>
<span id="cb45-837"><a href="#cb45-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-838"><a href="#cb45-838" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=6}</span></span>
<span id="cb45-839"><a href="#cb45-839" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-scanb-esr1</span></span>
<span id="cb45-840"><a href="#cb45-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for SCANB patients stratified by PAM50 molecular subtype</span></span>
<span id="cb45-841"><a href="#cb45-841" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb45-842"><a href="#cb45-842" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb45-843"><a href="#cb45-843" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-844"><a href="#cb45-844" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) <span class="sc">%&gt;%</span></span>
<span id="cb45-845"><a href="#cb45-845" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb45-846"><a href="#cb45-846" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, SET_ERPR),</span>
<span id="cb45-847"><a href="#cb45-847" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb45-848"><a href="#cb45-848" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb45-849"><a href="#cb45-849" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb45-850"><a href="#cb45-850" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb45-851"><a href="#cb45-851" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>, </span>
<span id="cb45-852"><a href="#cb45-852" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb45-853"><a href="#cb45-853" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> TreatGroup</span>
<span id="cb45-854"><a href="#cb45-854" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb45-855"><a href="#cb45-855" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">shape =</span> pam50)) <span class="sc">+</span></span>
<span id="cb45-856"><a href="#cb45-856" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb45-857"><a href="#cb45-857" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-858"><a href="#cb45-858" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"log2(ESR1) levels (FPKM)"</span>,</span>
<span id="cb45-859"><a href="#cb45-859" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Treatment</span><span class="sc">\n</span><span class="st">Group"</span>,</span>
<span id="cb45-860"><a href="#cb45-860" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb45-861"><a href="#cb45-861" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-862"><a href="#cb45-862" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between ER IHC percentage and</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb45-863"><a href="#cb45-863" aria-hidden="true" tabindex="-1"></a>            <span class="st">"molecular ER signaling score"</span></span>
<span id="cb45-864"><a href="#cb45-864" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-865"><a href="#cb45-865" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb45-866"><a href="#cb45-866" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-867"><a href="#cb45-867" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb45-868"><a href="#cb45-868" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb45-869"><a href="#cb45-869" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>(<span class="at">shape =</span> <span class="cn">TRUE</span>) </span>
<span id="cb45-870"><a href="#cb45-870" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-871"><a href="#cb45-871" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-872"><a href="#cb45-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-873"><a href="#cb45-873" aria-hidden="true" tabindex="-1"></a>We see that there is a positive correlation between signatures and scores,</span>
<span id="cb45-874"><a href="#cb45-874" aria-hidden="true" tabindex="-1"></a>the problem though is the high variability in the scores in this case. </span>
<span id="cb45-875"><a href="#cb45-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-876"><a href="#cb45-876" aria-hidden="true" tabindex="-1"></a>In the next section we will show how these scores are also prognostic for</span>
<span id="cb45-877"><a href="#cb45-877" aria-hidden="true" tabindex="-1"></a>ER+ BC patients.</span>
<span id="cb45-878"><a href="#cb45-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-879"><a href="#cb45-879" aria-hidden="true" tabindex="-1"></a><span class="fu">## Survival analysis</span></span>
<span id="cb45-880"><a href="#cb45-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-881"><a href="#cb45-881" aria-hidden="true" tabindex="-1"></a>Since the scores are continuous variables and they are already scaled due</span>
<span id="cb45-882"><a href="#cb45-882" aria-hidden="true" tabindex="-1"></a>to the output of GSVA, cox regression <span class="co">[</span><span class="ot">@Cox1972</span><span class="co">]</span> can be used. The advantages </span>
<span id="cb45-883"><a href="#cb45-883" aria-hidden="true" tabindex="-1"></a>of using cox regression is that one can control for other variables. You might</span>
<span id="cb45-884"><a href="#cb45-884" aria-hidden="true" tabindex="-1"></a>ask, why should one control for clinical variables? One of the reasons is </span>
<span id="cb45-885"><a href="#cb45-885" aria-hidden="true" tabindex="-1"></a>because the data being dealt here is observational data. There are several</span>
<span id="cb45-886"><a href="#cb45-886" aria-hidden="true" tabindex="-1"></a>confounders, for example, a score might be up because patients with a higher</span>
<span id="cb45-887"><a href="#cb45-887" aria-hidden="true" tabindex="-1"></a>tumor grade have higher expression of some genes. Thus the score is confounded</span>
<span id="cb45-888"><a href="#cb45-888" aria-hidden="true" tabindex="-1"></a>by the tumor grade and the interpretation changes. </span>
<span id="cb45-889"><a href="#cb45-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-890"><a href="#cb45-890" aria-hidden="true" tabindex="-1"></a>There are limitations still when dealing with observational data. A strong </span>
<span id="cb45-891"><a href="#cb45-891" aria-hidden="true" tabindex="-1"></a>hypothesis for performing survival analysis with observational data is that</span>
<span id="cb45-892"><a href="#cb45-892" aria-hidden="true" tabindex="-1"></a>we have measured all the confounder variables. This is pretty strong and in</span>
<span id="cb45-893"><a href="#cb45-893" aria-hidden="true" tabindex="-1"></a>practice we never know if a confounder is missing or not. For a more</span>
<span id="cb45-894"><a href="#cb45-894" aria-hidden="true" tabindex="-1"></a>thorough overview of the causal framework for observational data, check</span>
<span id="cb45-895"><a href="#cb45-895" aria-hidden="true" tabindex="-1"></a>the books <span class="co">[</span><span class="ot">@Gelman2020-uh; @McElreath2020-jn</span><span class="co">]</span>.</span>
<span id="cb45-896"><a href="#cb45-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-897"><a href="#cb45-897" aria-hidden="true" tabindex="-1"></a>All the cohorts have a different set of clinical variables available. Therefore,</span>
<span id="cb45-898"><a href="#cb45-898" aria-hidden="true" tabindex="-1"></a>the regression will be done by adjusting a different set of variables. Below</span>
<span id="cb45-899"><a href="#cb45-899" aria-hidden="true" tabindex="-1"></a>is the description of the variables used for each cohort.^<span class="co">[</span><span class="ot">This [webpage</span><span class="co">](https://web.archive.org/web/20220630083539/https://www.cancer.net/cancer-types/breast-cancer/stages)</span> explains with more details the different tumor stages and how</span>
<span id="cb45-900"><a href="#cb45-900" aria-hidden="true" tabindex="-1"></a>BC are classified.]</span>
<span id="cb45-901"><a href="#cb45-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-902"><a href="#cb45-902" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Age**: age is one of the most important factors to adjust, specially in</span>
<span id="cb45-903"><a href="#cb45-903" aria-hidden="true" tabindex="-1"></a>breast cancer. This covariate is used for all cohorts.</span>
<span id="cb45-904"><a href="#cb45-904" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**NPI**: the Nottingham prognostic index scores each tumor</span>
<span id="cb45-905"><a href="#cb45-905" aria-hidden="true" tabindex="-1"></a>based on tumor grade, tumor size and number of lymph nodes. Only METABRIC</span>
<span id="cb45-906"><a href="#cb45-906" aria-hidden="true" tabindex="-1"></a>has this information. </span>
<span id="cb45-907"><a href="#cb45-907" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tumor Size**: as name describes. Only SCANB has this information. </span>
<span id="cb45-908"><a href="#cb45-908" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tumor Stage**: tumors are usually described in terms of stage, it reflects</span>
<span id="cb45-909"><a href="#cb45-909" aria-hidden="true" tabindex="-1"></a>the tumor size and location. SCANB and TCGA have this information.</span>
<span id="cb45-910"><a href="#cb45-910" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Node Stage**: similar to tumor stage, but encodes the number of lymph nodes</span>
<span id="cb45-911"><a href="#cb45-911" aria-hidden="true" tabindex="-1"></a>where breast cancer cells can be found. SCANB and TCGA have this information.</span>
<span id="cb45-912"><a href="#cb45-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-913"><a href="#cb45-913" aria-hidden="true" tabindex="-1"></a>Thus the models we are going to use for the survival analysis of each dataset</span>
<span id="cb45-914"><a href="#cb45-914" aria-hidden="true" tabindex="-1"></a>is shown below.</span>
<span id="cb45-915"><a href="#cb45-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-916"><a href="#cb45-916" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TCGA: <span class="in">`~ score + age + node_stage + tumor_stage`</span>,</span>
<span id="cb45-917"><a href="#cb45-917" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>SCANB: <span class="in">`~ score + age + node_stage + tumor_stage`</span>,</span>
<span id="cb45-918"><a href="#cb45-918" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>METABRIC: <span class="in">`~ score + age + NPI`</span>,</span>
<span id="cb45-919"><a href="#cb45-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-920"><a href="#cb45-920" aria-hidden="true" tabindex="-1"></a>where score is one of the scores calculated earlier with GSVA. Note here</span>
<span id="cb45-921"><a href="#cb45-921" aria-hidden="true" tabindex="-1"></a>that since each node stage and tumor stage have sub classifications they </span>
<span id="cb45-922"><a href="#cb45-922" aria-hidden="true" tabindex="-1"></a>will be grouped together, otherwise there will be too many variables with</span>
<span id="cb45-923"><a href="#cb45-923" aria-hidden="true" tabindex="-1"></a>few points. We will also subselect specific tumor stages for TCGA and SCANB,</span>
<span id="cb45-924"><a href="#cb45-924" aria-hidden="true" tabindex="-1"></a>since there are very few patients with tumor stage 4.</span>
<span id="cb45-925"><a href="#cb45-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-926"><a href="#cb45-926" aria-hidden="true" tabindex="-1"></a>To be very specific in the survival analysis, only endocrine treated patients</span>
<span id="cb45-927"><a href="#cb45-927" aria-hidden="true" tabindex="-1"></a>should be used in the analysis, as that is what are interested in. METABRIC</span>
<span id="cb45-928"><a href="#cb45-928" aria-hidden="true" tabindex="-1"></a>and SCANB has this kind of annotation, but TCGA not. So the survival analysis</span>
<span id="cb45-929"><a href="#cb45-929" aria-hidden="true" tabindex="-1"></a>on SCANB and METABRIC will be performed on endocrine only treated, ER+ BC</span>
<span id="cb45-930"><a href="#cb45-930" aria-hidden="true" tabindex="-1"></a>patients. On TCGA, to mitigate this effect, we subselect only luminal A and </span>
<span id="cb45-931"><a href="#cb45-931" aria-hidden="true" tabindex="-1"></a>B patients, and we keep in mind that they might have been treated with</span>
<span id="cb45-932"><a href="#cb45-932" aria-hidden="true" tabindex="-1"></a>chemotherapy as well. Moreover, in Sweden the guidelines for BC treatment is to</span>
<span id="cb45-933"><a href="#cb45-933" aria-hidden="true" tabindex="-1"></a>use 10% as the threshold for ER status. Therefore, ER+ BC patients used on</span>
<span id="cb45-934"><a href="#cb45-934" aria-hidden="true" tabindex="-1"></a>SCANB are those that are above the 10% threshold.</span>
<span id="cb45-935"><a href="#cb45-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-936"><a href="#cb45-936" aria-hidden="true" tabindex="-1"></a>The table below shows the number of patients for each cohort.</span>
<span id="cb45-937"><a href="#cb45-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-940"><a href="#cb45-940" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-941"><a href="#cb45-941" aria-hidden="true" tabindex="-1"></a>tcga_samples <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>tcga) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-942"><a href="#cb45-942" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb45-943"><a href="#cb45-943" aria-hidden="true" tabindex="-1"></a>        pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"luma"</span>, <span class="st">"lumb"</span>) <span class="sc">&amp;</span></span>
<span id="cb45-944"><a href="#cb45-944" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb45-945"><a href="#cb45-945" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"stage_iv"</span>, <span class="st">"na"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb45-946"><a href="#cb45-946" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span></span>
<span id="cb45-947"><a href="#cb45-947" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-948"><a href="#cb45-948" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb45-949"><a href="#cb45-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-950"><a href="#cb45-950" aria-hidden="true" tabindex="-1"></a>scanb_samples <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-951"><a href="#cb45-951" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb45-952"><a href="#cb45-952" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb45-953"><a href="#cb45-953" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb45-954"><a href="#cb45-954" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb45-955"><a href="#cb45-955" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span></span>
<span id="cb45-956"><a href="#cb45-956" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-957"><a href="#cb45-957" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb45-958"><a href="#cb45-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-959"><a href="#cb45-959" aria-hidden="true" tabindex="-1"></a><span class="co"># we select also patients with high ER percentage &gt; 90 for comparison</span></span>
<span id="cb45-960"><a href="#cb45-960" aria-hidden="true" tabindex="-1"></a><span class="co"># down in the analysis</span></span>
<span id="cb45-961"><a href="#cb45-961" aria-hidden="true" tabindex="-1"></a>scanb_high_er <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>scanb) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-962"><a href="#cb45-962" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb45-963"><a href="#cb45-963" aria-hidden="true" tabindex="-1"></a>        node_stage <span class="sc">!=</span> <span class="st">"NX"</span> <span class="sc">&amp;</span></span>
<span id="cb45-964"><a href="#cb45-964" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(tumor_stage <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"T4"</span>, <span class="st">"Tis"</span>, <span class="st">"TX"</span>)) <span class="sc">&amp;</span> </span>
<span id="cb45-965"><a href="#cb45-965" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb45-966"><a href="#cb45-966" aria-hidden="true" tabindex="-1"></a>        TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb45-967"><a href="#cb45-967" aria-hidden="true" tabindex="-1"></a>        ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span></span>
<span id="cb45-968"><a href="#cb45-968" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-969"><a href="#cb45-969" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb45-970"><a href="#cb45-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-971"><a href="#cb45-971" aria-hidden="true" tabindex="-1"></a>metabric_samples <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>metabric) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-972"><a href="#cb45-972" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb45-973"><a href="#cb45-973" aria-hidden="true" tabindex="-1"></a>        CHEMOTHERAPY <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span></span>
<span id="cb45-974"><a href="#cb45-974" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb45-975"><a href="#cb45-975" aria-hidden="true" tabindex="-1"></a>        HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span></span>
<span id="cb45-976"><a href="#cb45-976" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-977"><a href="#cb45-977" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb45-978"><a href="#cb45-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-979"><a href="#cb45-979" aria-hidden="true" tabindex="-1"></a>nb_pts_events <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb45-980"><a href="#cb45-980" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="fu">c</span>(<span class="st">"TCGA"</span>, <span class="st">"SCANB"</span>, <span class="st">"METABRIC"</span>, <span class="st">"SCANB High ER"</span>),</span>
<span id="cb45-981"><a href="#cb45-981" aria-hidden="true" tabindex="-1"></a>    <span class="at">number_patients =</span> <span class="fu">c</span>(</span>
<span id="cb45-982"><a href="#cb45-982" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(tcga_samples),</span>
<span id="cb45-983"><a href="#cb45-983" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_samples),</span>
<span id="cb45-984"><a href="#cb45-984" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(metabric_samples),</span>
<span id="cb45-985"><a href="#cb45-985" aria-hidden="true" tabindex="-1"></a>        <span class="fu">length</span>(scanb_high_er)</span>
<span id="cb45-986"><a href="#cb45-986" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-987"><a href="#cb45-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_events =</span> <span class="fu">c</span>(</span>
<span id="cb45-988"><a href="#cb45-988" aria-hidden="true" tabindex="-1"></a>        datasets<span class="sc">$</span>tcga <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-989"><a href="#cb45-989" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> tcga_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-990"><a href="#cb45-990" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb45-991"><a href="#cb45-991" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb45-992"><a href="#cb45-992" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-993"><a href="#cb45-993" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-994"><a href="#cb45-994" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb45-995"><a href="#cb45-995" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb45-996"><a href="#cb45-996" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>metabric <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-997"><a href="#cb45-997" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> metabric_samples <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-998"><a href="#cb45-998" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb45-999"><a href="#cb45-999" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n),</span>
<span id="cb45-1000"><a href="#cb45-1000" aria-hidden="true" tabindex="-1"></a>       datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span> colData <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-1001"><a href="#cb45-1001" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_high_er <span class="sc">&amp;</span> os_status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-1002"><a href="#cb45-1002" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb45-1003"><a href="#cb45-1003" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(n)</span>
<span id="cb45-1004"><a href="#cb45-1004" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-1005"><a href="#cb45-1005" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-1006"><a href="#cb45-1006" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-1007"><a href="#cb45-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1008"><a href="#cb45-1008" aria-hidden="true" tabindex="-1"></a>nb_pts_events</span>
<span id="cb45-1009"><a href="#cb45-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1010"><a href="#cb45-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1011"><a href="#cb45-1011" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb45-1012"><a href="#cb45-1012" aria-hidden="true" tabindex="-1"></a><span class="co"># run the survival analysis for each dataset with its own formula.</span></span>
<span id="cb45-1013"><a href="#cb45-1013" aria-hidden="true" tabindex="-1"></a><span class="co"># we start by defining the base formulas, because later we sapply and </span></span>
<span id="cb45-1014"><a href="#cb45-1014" aria-hidden="true" tabindex="-1"></a><span class="co"># add the scores. this way if we need to change the formulas, we only</span></span>
<span id="cb45-1015"><a href="#cb45-1015" aria-hidden="true" tabindex="-1"></a><span class="co"># need to change once and all together.</span></span>
<span id="cb45-1016"><a href="#cb45-1016" aria-hidden="true" tabindex="-1"></a>formulas_survival <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb45-1017"><a href="#cb45-1017" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_tcga"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb45-1018"><a href="#cb45-1018" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_scanb"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb45-1019"><a href="#cb45-1019" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_scanb_high_er"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb45-1020"><a href="#cb45-1020" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os_metabric"</span> <span class="ot">=</span> <span class="st">"Surv(os_months, os_status) ~ age + npi"</span>,</span>
<span id="cb45-1021"><a href="#cb45-1021" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_metabric"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + npi"</span>,</span>
<span id="cb45-1022"><a href="#cb45-1022" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_scanb"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage"</span>,</span>
<span id="cb45-1023"><a href="#cb45-1023" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rfs_scanb_high_er"</span> <span class="ot">=</span> <span class="st">"Surv(rfs_months, rfs_status) ~ age + node_stage + tumor_stage"</span></span>
<span id="cb45-1024"><a href="#cb45-1024" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1025"><a href="#cb45-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1026"><a href="#cb45-1026" aria-hidden="true" tabindex="-1"></a>type_survival <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"os"</span>, <span class="st">"rfs"</span>)</span>
<span id="cb45-1027"><a href="#cb45-1027" aria-hidden="true" tabindex="-1"></a>which_scores <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb45-1028"><a href="#cb45-1028" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb45-1029"><a href="#cb45-1029" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span>,</span>
<span id="cb45-1030"><a href="#cb45-1030" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>,</span>
<span id="cb45-1031"><a href="#cb45-1031" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span>,</span>
<span id="cb45-1032"><a href="#cb45-1032" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span>,</span>
<span id="cb45-1033"><a href="#cb45-1033" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ER.pct"</span></span>
<span id="cb45-1034"><a href="#cb45-1034" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1035"><a href="#cb45-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1036"><a href="#cb45-1036" aria-hidden="true" tabindex="-1"></a>survival_results <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb45-1037"><a href="#cb45-1037" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"os"</span>, <span class="st">"rfs"</span>),</span>
<span id="cb45-1038"><a href="#cb45-1038" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(type_analysis, datasets, name_scores, formulas){</span>
<span id="cb45-1039"><a href="#cb45-1039" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb45-1040"><a href="#cb45-1040" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(</span>
<span id="cb45-1041"><a href="#cb45-1041" aria-hidden="true" tabindex="-1"></a>                dataset, name_dataset, name_scores, formulas, type_analysis</span>
<span id="cb45-1042"><a href="#cb45-1042" aria-hidden="true" tabindex="-1"></a>            ){</span>
<span id="cb45-1043"><a href="#cb45-1043" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb45-1044"><a href="#cb45-1044" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (type_analysis <span class="sc">==</span> <span class="st">"rfs"</span> <span class="sc">&amp;</span> name_dataset <span class="sc">==</span> <span class="st">"tcga"</span>){</span>
<span id="cb45-1045"><a href="#cb45-1045" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span>()</span>
<span id="cb45-1046"><a href="#cb45-1046" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> { </span>
<span id="cb45-1047"><a href="#cb45-1047" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb45-1048"><a href="#cb45-1048" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sapply</span>(</span>
<span id="cb45-1049"><a href="#cb45-1049" aria-hidden="true" tabindex="-1"></a>                        name_scores,</span>
<span id="cb45-1050"><a href="#cb45-1050" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">function</span>(name_score, col_data, formula_str){</span>
<span id="cb45-1051"><a href="#cb45-1051" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb45-1052"><a href="#cb45-1052" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> (name_score <span class="sc">%in%</span> <span class="fu">colnames</span>(col_data)){</span>
<span id="cb45-1053"><a href="#cb45-1053" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb45-1054"><a href="#cb45-1054" aria-hidden="true" tabindex="-1"></a>                                survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb45-1055"><a href="#cb45-1055" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">as.formula</span>(</span>
<span id="cb45-1056"><a href="#cb45-1056" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">paste</span>(</span>
<span id="cb45-1057"><a href="#cb45-1057" aria-hidden="true" tabindex="-1"></a>                                            formula_str, </span>
<span id="cb45-1058"><a href="#cb45-1058" aria-hidden="true" tabindex="-1"></a>                                            name_score, </span>
<span id="cb45-1059"><a href="#cb45-1059" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">sep =</span> <span class="st">"+"</span></span>
<span id="cb45-1060"><a href="#cb45-1060" aria-hidden="true" tabindex="-1"></a>                                        )[<span class="dv">1</span>]</span>
<span id="cb45-1061"><a href="#cb45-1061" aria-hidden="true" tabindex="-1"></a>                                    ),</span>
<span id="cb45-1062"><a href="#cb45-1062" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">data =</span> col_data, </span>
<span id="cb45-1063"><a href="#cb45-1063" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">y =</span> <span class="cn">FALSE</span>,</span>
<span id="cb45-1064"><a href="#cb45-1064" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">x =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1065"><a href="#cb45-1065" aria-hidden="true" tabindex="-1"></a>                                )    </span>
<span id="cb45-1066"><a href="#cb45-1066" aria-hidden="true" tabindex="-1"></a>                            } <span class="cf">else</span> {</span>
<span id="cb45-1067"><a href="#cb45-1067" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">return</span>()</span>
<span id="cb45-1068"><a href="#cb45-1068" aria-hidden="true" tabindex="-1"></a>                            }</span>
<span id="cb45-1069"><a href="#cb45-1069" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb45-1070"><a href="#cb45-1070" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb45-1071"><a href="#cb45-1071" aria-hidden="true" tabindex="-1"></a>                        <span class="at">col_data =</span> <span class="fu">colData</span>(dataset) <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb45-1072"><a href="#cb45-1072" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> formulas[</span>
<span id="cb45-1073"><a href="#cb45-1073" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">grepl</span>(</span>
<span id="cb45-1074"><a href="#cb45-1074" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">paste</span>(type_analysis, name_dataset, <span class="at">sep =</span> <span class="st">"_"</span>),</span>
<span id="cb45-1075"><a href="#cb45-1075" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">names</span>(formulas)</span>
<span id="cb45-1076"><a href="#cb45-1076" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb45-1077"><a href="#cb45-1077" aria-hidden="true" tabindex="-1"></a>                        ],</span>
<span id="cb45-1078"><a href="#cb45-1078" aria-hidden="true" tabindex="-1"></a>                        <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1079"><a href="#cb45-1079" aria-hidden="true" tabindex="-1"></a>                        <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1080"><a href="#cb45-1080" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb45-1081"><a href="#cb45-1081" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb45-1082"><a href="#cb45-1082" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb45-1083"><a href="#cb45-1083" aria-hidden="true" tabindex="-1"></a>            <span class="at">dataset =</span> datasets,</span>
<span id="cb45-1084"><a href="#cb45-1084" aria-hidden="true" tabindex="-1"></a>            <span class="at">name_dataset =</span> <span class="fu">names</span>(datasets),</span>
<span id="cb45-1085"><a href="#cb45-1085" aria-hidden="true" tabindex="-1"></a>            <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-1086"><a href="#cb45-1086" aria-hidden="true" tabindex="-1"></a>                <span class="at">formulas =</span> formulas, </span>
<span id="cb45-1087"><a href="#cb45-1087" aria-hidden="true" tabindex="-1"></a>                <span class="at">name_scores =</span> name_scores,</span>
<span id="cb45-1088"><a href="#cb45-1088" aria-hidden="true" tabindex="-1"></a>                <span class="at">type_analysis =</span> type_analysis</span>
<span id="cb45-1089"><a href="#cb45-1089" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb45-1090"><a href="#cb45-1090" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1091"><a href="#cb45-1091" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1092"><a href="#cb45-1092" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-1093"><a href="#cb45-1093" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-1094"><a href="#cb45-1094" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> <span class="fu">mapply</span>(</span>
<span id="cb45-1095"><a href="#cb45-1095" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(dataset, patients) dataset[, patients],</span>
<span id="cb45-1096"><a href="#cb45-1096" aria-hidden="true" tabindex="-1"></a>        <span class="at">dataset =</span> <span class="fu">c</span>(datasets, <span class="at">scanb_high_er =</span> datasets<span class="sc">$</span>scanb),</span>
<span id="cb45-1097"><a href="#cb45-1097" aria-hidden="true" tabindex="-1"></a>        <span class="at">patients =</span> <span class="fu">list</span>(</span>
<span id="cb45-1098"><a href="#cb45-1098" aria-hidden="true" tabindex="-1"></a>            tcga_samples, </span>
<span id="cb45-1099"><a href="#cb45-1099" aria-hidden="true" tabindex="-1"></a>            scanb_samples, </span>
<span id="cb45-1100"><a href="#cb45-1100" aria-hidden="true" tabindex="-1"></a>            metabric_samples, </span>
<span id="cb45-1101"><a href="#cb45-1101" aria-hidden="true" tabindex="-1"></a>            scanb_high_er</span>
<span id="cb45-1102"><a href="#cb45-1102" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb45-1103"><a href="#cb45-1103" aria-hidden="true" tabindex="-1"></a>        <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1104"><a href="#cb45-1104" aria-hidden="true" tabindex="-1"></a>        <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1105"><a href="#cb45-1105" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-1106"><a href="#cb45-1106" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_scores =</span> which_scores,</span>
<span id="cb45-1107"><a href="#cb45-1107" aria-hidden="true" tabindex="-1"></a>    <span class="at">formulas =</span> formulas_survival,</span>
<span id="cb45-1108"><a href="#cb45-1108" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1109"><a href="#cb45-1109" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1110"><a href="#cb45-1110" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1111"><a href="#cb45-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1112"><a href="#cb45-1112" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs <span class="ot">&lt;-</span> survival_results<span class="sc">$</span>rfs[</span>
<span id="cb45-1113"><a href="#cb45-1113" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">sapply</span>(survival_results<span class="sc">$</span>rfs, is.null)</span>
<span id="cb45-1114"><a href="#cb45-1114" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb45-1115"><a href="#cb45-1115" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric <span class="ot">&lt;-</span> survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric[</span>
<span id="cb45-1116"><a href="#cb45-1116" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">sapply</span>(survival_results<span class="sc">$</span>rfs<span class="sc">$</span>metabric, is.null)</span>
<span id="cb45-1117"><a href="#cb45-1117" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb45-1118"><a href="#cb45-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1119"><a href="#cb45-1119" aria-hidden="true" tabindex="-1"></a>survival_results<span class="sc">$</span>os <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">discard</span>(</span>
<span id="cb45-1120"><a href="#cb45-1120" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb45-1121"><a href="#cb45-1121" aria-hidden="true" tabindex="-1"></a>        survival_results<span class="sc">$</span>os, </span>
<span id="cb45-1122"><a href="#cb45-1122" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> purrr<span class="sc">::</span><span class="fu">discard</span>(.x, is.null),</span>
<span id="cb45-1123"><a href="#cb45-1123" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-1124"><a href="#cb45-1124" aria-hidden="true" tabindex="-1"></a>    is.null</span>
<span id="cb45-1125"><a href="#cb45-1125" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1126"><a href="#cb45-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1127"><a href="#cb45-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># we cannot simply save the models as each model has some </span></span>
<span id="cb45-1128"><a href="#cb45-1128" aria-hidden="true" tabindex="-1"></a><span class="co"># environment variables, which adds up to over 20GB. </span></span>
<span id="cb45-1129"><a href="#cb45-1129" aria-hidden="true" tabindex="-1"></a><span class="co"># check this stack exchange thread to read more on it:</span></span>
<span id="cb45-1130"><a href="#cb45-1130" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/42230920/saverds-inflating-size-of-object/52372480</span></span>
<span id="cb45-1131"><a href="#cb45-1131" aria-hidden="true" tabindex="-1"></a><span class="co"># the solution is to basically clear the environment from the terms </span></span>
<span id="cb45-1132"><a href="#cb45-1132" aria-hidden="true" tabindex="-1"></a><span class="co"># object. since it is pretty fast to run the survival analysis</span></span>
<span id="cb45-1133"><a href="#cb45-1133" aria-hidden="true" tabindex="-1"></a><span class="co"># we will not save the objects.</span></span>
<span id="cb45-1134"><a href="#cb45-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1135"><a href="#cb45-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1136"><a href="#cb45-1136" aria-hidden="true" tabindex="-1"></a><span class="co"># we now proceed to prepare the plots. since the survival result is </span></span>
<span id="cb45-1137"><a href="#cb45-1137" aria-hidden="true" tabindex="-1"></a><span class="co"># actually a large file, it is best to do all the plottings, save</span></span>
<span id="cb45-1138"><a href="#cb45-1138" aria-hidden="true" tabindex="-1"></a><span class="co"># them in other rds/pdf files and then use on the quarto markdown.</span></span>
<span id="cb45-1139"><a href="#cb45-1139" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise it is too slow to render the book. </span></span>
<span id="cb45-1140"><a href="#cb45-1140" aria-hidden="true" tabindex="-1"></a><span class="co"># the same is true for the statistics and coefficients available.</span></span>
<span id="cb45-1141"><a href="#cb45-1141" aria-hidden="true" tabindex="-1"></a>names_signatures <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb45-1142"><a href="#cb45-1142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>,</span>
<span id="cb45-1143"><a href="#cb45-1143" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span> <span class="ot">=</span> <span class="st">"Estrogen Late"</span>,</span>
<span id="cb45-1144"><a href="#cb45-1144" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>,</span>
<span id="cb45-1145"><a href="#cb45-1145" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span> <span class="ot">=</span> <span class="st">"random 200 genes"</span>,</span>
<span id="cb45-1146"><a href="#cb45-1146" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span> <span class="ot">=</span> <span class="st">"random 18 genes"</span>,</span>
<span id="cb45-1147"><a href="#cb45-1147" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ER.pct"</span> <span class="ot">=</span> <span class="st">"ER percentage"</span></span>
<span id="cb45-1148"><a href="#cb45-1148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1149"><a href="#cb45-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1150"><a href="#cb45-1150" aria-hidden="true" tabindex="-1"></a>names_coefficients <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-1151"><a href="#cb45-1151" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="fu">c</span>(</span>
<span id="cb45-1152"><a href="#cb45-1152" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"Age"</span>, </span>
<span id="cb45-1153"><a href="#cb45-1153" aria-hidden="true" tabindex="-1"></a>        <span class="st">"npi"</span> <span class="ot">=</span> <span class="st">"NPI"</span>, </span>
<span id="cb45-1154"><a href="#cb45-1154" aria-hidden="true" tabindex="-1"></a>        names_signatures</span>
<span id="cb45-1155"><a href="#cb45-1155" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-1156"><a href="#cb45-1156" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="fu">c</span>(</span>
<span id="cb45-1157"><a href="#cb45-1157" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb45-1158"><a href="#cb45-1158" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb45-1159"><a href="#cb45-1159" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb45-1160"><a href="#cb45-1160" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2and3"</span> <span class="ot">=</span> <span class="st">"N2 and N3"</span>,</span>
<span id="cb45-1161"><a href="#cb45-1161" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT1"</span> <span class="ot">=</span> <span class="st">"T1"</span>,</span>
<span id="cb45-1162"><a href="#cb45-1162" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT2"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb45-1163"><a href="#cb45-1163" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT3"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb45-1164"><a href="#cb45-1164" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-1165"><a href="#cb45-1165" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="fu">c</span>(</span>
<span id="cb45-1166"><a href="#cb45-1166" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb45-1167"><a href="#cb45-1167" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stage"</span> <span class="ot">=</span> <span class="st">"Tumor Stage"</span>,</span>
<span id="cb45-1168"><a href="#cb45-1168" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb45-1169"><a href="#cb45-1169" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb45-1170"><a href="#cb45-1170" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2"</span> <span class="ot">=</span> <span class="st">"N2"</span>,</span>
<span id="cb45-1171"><a href="#cb45-1171" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN3"</span> <span class="ot">=</span> <span class="st">"N3"</span>,</span>
<span id="cb45-1172"><a href="#cb45-1172" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stagestage_ii"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb45-1173"><a href="#cb45-1173" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stagestage_iii"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb45-1174"><a href="#cb45-1174" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-1175"><a href="#cb45-1175" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_er =</span> <span class="fu">c</span>(</span>
<span id="cb45-1176"><a href="#cb45-1176" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"age"</span>,</span>
<span id="cb45-1177"><a href="#cb45-1177" aria-hidden="true" tabindex="-1"></a>        names_signatures,</span>
<span id="cb45-1178"><a href="#cb45-1178" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN1"</span> <span class="ot">=</span> <span class="st">"N1"</span>,</span>
<span id="cb45-1179"><a href="#cb45-1179" aria-hidden="true" tabindex="-1"></a>        <span class="st">"node_stageN2and3"</span> <span class="ot">=</span> <span class="st">"N2 and N3"</span>,</span>
<span id="cb45-1180"><a href="#cb45-1180" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT1"</span> <span class="ot">=</span> <span class="st">"T1"</span>,</span>
<span id="cb45-1181"><a href="#cb45-1181" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT2"</span> <span class="ot">=</span> <span class="st">"T2"</span>,</span>
<span id="cb45-1182"><a href="#cb45-1182" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tumor_stageT3"</span> <span class="ot">=</span> <span class="st">"T3"</span></span>
<span id="cb45-1183"><a href="#cb45-1183" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-1184"><a href="#cb45-1184" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1185"><a href="#cb45-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1186"><a href="#cb45-1186" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-1187"><a href="#cb45-1187" aria-hidden="true" tabindex="-1"></a>    <span class="at">tcga =</span> <span class="st">"Lum A/B, ER+ BC"</span>,</span>
<span id="cb45-1188"><a href="#cb45-1188" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb =</span> <span class="st">"Endo Only, ER+ BC"</span>,</span>
<span id="cb45-1189"><a href="#cb45-1189" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabric =</span> <span class="st">"Endo Only, ER+ BC"</span>,</span>
<span id="cb45-1190"><a href="#cb45-1190" aria-hidden="true" tabindex="-1"></a>    <span class="at">scanb_high_er =</span> <span class="st">"Endo Only, ER+ BC, ER% &gt;= 90"</span></span>
<span id="cb45-1191"><a href="#cb45-1191" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1192"><a href="#cb45-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1193"><a href="#cb45-1193" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb45-1194"><a href="#cb45-1194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(</span>
<span id="cb45-1195"><a href="#cb45-1195" aria-hidden="true" tabindex="-1"></a>        <span class="st">"../results/plots/surv_analysis_estrogen/forest_plots/"</span>,</span>
<span id="cb45-1196"><a href="#cb45-1196" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">"pdf"</span>, <span class="st">"png"</span>)</span>
<span id="cb45-1197"><a href="#cb45-1197" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb45-1198"><a href="#cb45-1198" aria-hidden="true" tabindex="-1"></a>    dir.create,</span>
<span id="cb45-1199"><a href="#cb45-1199" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb45-1200"><a href="#cb45-1200" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb45-1201"><a href="#cb45-1201" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1202"><a href="#cb45-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1203"><a href="#cb45-1203" aria-hidden="true" tabindex="-1"></a>forest_plots <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb45-1204"><a href="#cb45-1204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(fits, type_analysis){</span>
<span id="cb45-1205"><a href="#cb45-1205" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb45-1206"><a href="#cb45-1206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(cohort_fits, name_cohort, type_analysis){</span>
<span id="cb45-1207"><a href="#cb45-1207" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mapply</span>(</span>
<span id="cb45-1208"><a href="#cb45-1208" aria-hidden="true" tabindex="-1"></a>                    forest_plot_fits,</span>
<span id="cb45-1209"><a href="#cb45-1209" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fit =</span> cohort_fits,</span>
<span id="cb45-1210"><a href="#cb45-1210" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name_signature =</span> <span class="fu">names</span>(cohort_fits),</span>
<span id="cb45-1211"><a href="#cb45-1211" aria-hidden="true" tabindex="-1"></a>                    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb45-1212"><a href="#cb45-1212" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cohort =</span> name_cohort,</span>
<span id="cb45-1213"><a href="#cb45-1213" aria-hidden="true" tabindex="-1"></a>                        <span class="at">names_coefficients =</span> names_coefficients,</span>
<span id="cb45-1214"><a href="#cb45-1214" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type_survival =</span> <span class="fu">toupper</span>(type_analysis),</span>
<span id="cb45-1215"><a href="#cb45-1215" aria-hidden="true" tabindex="-1"></a>                        <span class="at">patients =</span> patients[[name_cohort]],</span>
<span id="cb45-1216"><a href="#cb45-1216" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#clip = c(0.1, 2),</span></span>
<span id="cb45-1217"><a href="#cb45-1217" aria-hidden="true" tabindex="-1"></a>                        <span class="at">width =</span> <span class="dv">6</span>, </span>
<span id="cb45-1218"><a href="#cb45-1218" aria-hidden="true" tabindex="-1"></a>                        <span class="at">height =</span> <span class="dv">4</span>, </span>
<span id="cb45-1219"><a href="#cb45-1219" aria-hidden="true" tabindex="-1"></a>                        <span class="at">path_to_save =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-1220"><a href="#cb45-1220" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"../results/plots/surv_analysis_estrogen"</span>,</span>
<span id="cb45-1221"><a href="#cb45-1221" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"/forest_plots/"</span>  </span>
<span id="cb45-1222"><a href="#cb45-1222" aria-hidden="true" tabindex="-1"></a>                        ) </span>
<span id="cb45-1223"><a href="#cb45-1223" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb45-1224"><a href="#cb45-1224" aria-hidden="true" tabindex="-1"></a>                    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1225"><a href="#cb45-1225" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1226"><a href="#cb45-1226" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb45-1227"><a href="#cb45-1227" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb45-1228"><a href="#cb45-1228" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb45-1229"><a href="#cb45-1229" aria-hidden="true" tabindex="-1"></a>            <span class="at">cohort_fits =</span> fits,</span>
<span id="cb45-1230"><a href="#cb45-1230" aria-hidden="true" tabindex="-1"></a>            <span class="at">name_cohort =</span> <span class="fu">names</span>(fits),</span>
<span id="cb45-1231"><a href="#cb45-1231" aria-hidden="true" tabindex="-1"></a>            <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">type_analysis =</span> type_analysis),</span>
<span id="cb45-1232"><a href="#cb45-1232" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1233"><a href="#cb45-1233" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1234"><a href="#cb45-1234" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-1235"><a href="#cb45-1235" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb45-1236"><a href="#cb45-1236" aria-hidden="true" tabindex="-1"></a>    survival_results,</span>
<span id="cb45-1237"><a href="#cb45-1237" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(survival_results),</span>
<span id="cb45-1238"><a href="#cb45-1238" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-1239"><a href="#cb45-1239" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1240"><a href="#cb45-1240" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1241"><a href="#cb45-1241" aria-hidden="true" tabindex="-1"></a><span class="co"># all forest plots are saved as a pdf in the </span></span>
<span id="cb45-1242"><a href="#cb45-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># results/plots/surv_analysis_estrogen folder and</span></span>
<span id="cb45-1243"><a href="#cb45-1243" aria-hidden="true" tabindex="-1"></a><span class="co"># as a rds file in the folder below.</span></span>
<span id="cb45-1244"><a href="#cb45-1244" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb45-1245"><a href="#cb45-1245" aria-hidden="true" tabindex="-1"></a>    forest_plots,</span>
<span id="cb45-1246"><a href="#cb45-1246" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/forest_plots.rds"</span></span>
<span id="cb45-1247"><a href="#cb45-1247" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1248"><a href="#cb45-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1249"><a href="#cb45-1249" aria-hidden="true" tabindex="-1"></a><span class="co"># and now we fetch the tables that will be used later on including the</span></span>
<span id="cb45-1250"><a href="#cb45-1250" aria-hidden="true" tabindex="-1"></a><span class="co"># confidence intervals and other parameters from the fit</span></span>
<span id="cb45-1251"><a href="#cb45-1251" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb45-1252"><a href="#cb45-1252" aria-hidden="true" tabindex="-1"></a>    survival_results, </span>
<span id="cb45-1253"><a href="#cb45-1253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) </span>
<span id="cb45-1254"><a href="#cb45-1254" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb45-1255"><a href="#cb45-1255" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb45-1256"><a href="#cb45-1256" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(y)</span>
<span id="cb45-1257"><a href="#cb45-1257" aria-hidden="true" tabindex="-1"></a>                <span class="fu">lapply</span>(</span>
<span id="cb45-1258"><a href="#cb45-1258" aria-hidden="true" tabindex="-1"></a>                    y,</span>
<span id="cb45-1259"><a href="#cb45-1259" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>(z) broom<span class="sc">::</span><span class="fu">tidy</span>(</span>
<span id="cb45-1260"><a href="#cb45-1260" aria-hidden="true" tabindex="-1"></a>                        z, </span>
<span id="cb45-1261"><a href="#cb45-1261" aria-hidden="true" tabindex="-1"></a>                        <span class="at">exponentiate =</span> <span class="cn">TRUE</span>, </span>
<span id="cb45-1262"><a href="#cb45-1262" aria-hidden="true" tabindex="-1"></a>                        <span class="at">conf.int =</span> <span class="cn">TRUE</span></span>
<span id="cb45-1263"><a href="#cb45-1263" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb45-1264"><a href="#cb45-1264" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"score"</span>)</span>
<span id="cb45-1265"><a href="#cb45-1265" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>)</span>
<span id="cb45-1266"><a href="#cb45-1266" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"type_analysis"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-1267"><a href="#cb45-1267" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">HR =</span> estimate)</span>
<span id="cb45-1268"><a href="#cb45-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1269"><a href="#cb45-1269" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb45-1270"><a href="#cb45-1270" aria-hidden="true" tabindex="-1"></a>    tables_survival,</span>
<span id="cb45-1271"><a href="#cb45-1271" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/surv_analysis_estrogen/survival_results.csv"</span>,</span>
<span id="cb45-1272"><a href="#cb45-1272" aria-hidden="true" tabindex="-1"></a>    <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb45-1273"><a href="#cb45-1273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1274"><a href="#cb45-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1275"><a href="#cb45-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1278"><a href="#cb45-1278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-1279"><a href="#cb45-1279" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(</span>
<span id="cb45-1280"><a href="#cb45-1280" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/tables/surv_analysis_estrogen/survival_results.csv"</span></span>
<span id="cb45-1281"><a href="#cb45-1281" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1282"><a href="#cb45-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1283"><a href="#cb45-1283" aria-hidden="true" tabindex="-1"></a>forest_plots <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb45-1284"><a href="#cb45-1284" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/forest_plots.rds"</span></span>
<span id="cb45-1285"><a href="#cb45-1285" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1286"><a href="#cb45-1286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1287"><a href="#cb45-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1288"><a href="#cb45-1288" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results</span></span>
<span id="cb45-1289"><a href="#cb45-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1290"><a href="#cb45-1290" aria-hidden="true" tabindex="-1"></a>The table below shows the results for each analysis performed for a specific</span>
<span id="cb45-1291"><a href="#cb45-1291" aria-hidden="true" tabindex="-1"></a>term. In order to understand the table the user can filter based on the term,</span>
<span id="cb45-1292"><a href="#cb45-1292" aria-hidden="true" tabindex="-1"></a>cohort and type of analysis. Since METABRIC has recurrence free survival (RFS)</span>
<span id="cb45-1293"><a href="#cb45-1293" aria-hidden="true" tabindex="-1"></a>and overall survival (OS), the results for both analysis are presented here. </span>
<span id="cb45-1294"><a href="#cb45-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1297"><a href="#cb45-1297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-1298"><a href="#cb45-1298" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span> </span>
<span id="cb45-1299"><a href="#cb45-1299" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">!=</span> <span class="st">"scanb_high_er"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-1300"><a href="#cb45-1300" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(term <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>, <span class="st">"SET_ERPR"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb45-1301"><a href="#cb45-1301" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>), <span class="at">filter =</span> <span class="st">'top'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-1302"><a href="#cb45-1302" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatRound</span>(</span>
<span id="cb45-1303"><a href="#cb45-1303" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns=</span><span class="fu">c</span>(</span>
<span id="cb45-1304"><a href="#cb45-1304" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimate"</span>, <span class="st">"std.error"</span>, <span class="st">"statistic"</span>, <span class="st">"HR"</span></span>
<span id="cb45-1305"><a href="#cb45-1305" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb45-1306"><a href="#cb45-1306" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb45-1307"><a href="#cb45-1307" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb45-1308"><a href="#cb45-1308" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatSignif</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"p.value"</span>))</span>
<span id="cb45-1309"><a href="#cb45-1309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1310"><a href="#cb45-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1311"><a href="#cb45-1311" aria-hidden="true" tabindex="-1"></a>The table above shows that $SET_{ER/PR}$ had a small hazard ratio (&lt; 1) in all</span>
<span id="cb45-1312"><a href="#cb45-1312" aria-hidden="true" tabindex="-1"></a>4 analysis performed. Moreover, for all cases where a measure of estrogen</span>
<span id="cb45-1313"><a href="#cb45-1313" aria-hidden="true" tabindex="-1"></a>signaling was used, the hazard ratio was below 1, indicating that the higher</span>
<span id="cb45-1314"><a href="#cb45-1314" aria-hidden="true" tabindex="-1"></a>the score, the less likely the patient is to suffer the event in a specific</span>
<span id="cb45-1315"><a href="#cb45-1315" aria-hidden="true" tabindex="-1"></a>timepoint. This indicates that ER signaling is actually something continuous</span>
<span id="cb45-1316"><a href="#cb45-1316" aria-hidden="true" tabindex="-1"></a>and not dichotomous.</span>
<span id="cb45-1317"><a href="#cb45-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1318"><a href="#cb45-1318" aria-hidden="true" tabindex="-1"></a>@fig-forest-plot shows the forest plot of HALLMARK_ESTROGEN_RESPONSE_EARLY for all </span>
<span id="cb45-1319"><a href="#cb45-1319" aria-hidden="true" tabindex="-1"></a>three cohorts. </span>
<span id="cb45-1320"><a href="#cb45-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1321"><a href="#cb45-1321" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb45-1322"><a href="#cb45-1322" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-forest-plot</span></span>
<span id="cb45-1323"><a href="#cb45-1323" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Forest plots of the different cohorts and their hazard ratios.</span></span>
<span id="cb45-1324"><a href="#cb45-1324" aria-hidden="true" tabindex="-1"></a><span class="co">#|     The bars correspond to 95% confidence interval.</span></span>
<span id="cb45-1325"><a href="#cb45-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1326"><a href="#cb45-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># we use the workaround described here:</span></span>
<span id="cb45-1327"><a href="#cb45-1327" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/71266791/combine-several-forestplot-object-in-one-graph-in-r</span></span>
<span id="cb45-1328"><a href="#cb45-1328" aria-hidden="true" tabindex="-1"></a><span class="co"># we convert the forest plots to grob and then used gridExtra to </span></span>
<span id="cb45-1329"><a href="#cb45-1329" aria-hidden="true" tabindex="-1"></a><span class="co"># plot into the output</span></span>
<span id="cb45-1330"><a href="#cb45-1330" aria-hidden="true" tabindex="-1"></a>which_pathway <span class="ot">&lt;-</span> <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span></span>
<span id="cb45-1331"><a href="#cb45-1331" aria-hidden="true" tabindex="-1"></a>plots_estrogen_early <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb45-1332"><a href="#cb45-1332" aria-hidden="true" tabindex="-1"></a>    forest_plots<span class="sc">$</span>os, </span>
<span id="cb45-1333"><a href="#cb45-1333" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x){</span>
<span id="cb45-1334"><a href="#cb45-1334" aria-hidden="true" tabindex="-1"></a>        ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(x[[which_pathway]]))</span>
<span id="cb45-1335"><a href="#cb45-1335" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb45-1336"><a href="#cb45-1336" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1337"><a href="#cb45-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1338"><a href="#cb45-1338" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb45-1339"><a href="#cb45-1339" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>tcga, </span>
<span id="cb45-1340"><a href="#cb45-1340" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>scanb,</span>
<span id="cb45-1341"><a href="#cb45-1341" aria-hidden="true" tabindex="-1"></a>    plots_estrogen_early<span class="sc">$</span>metabric</span>
<span id="cb45-1342"><a href="#cb45-1342" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1343"><a href="#cb45-1343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1344"><a href="#cb45-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1345"><a href="#cb45-1345" aria-hidden="true" tabindex="-1"></a>The hazard ratios are all below 1 and small for HALLMARK_ESTROGEN_RESPONSE_EARLY.</span>
<span id="cb45-1346"><a href="#cb45-1346" aria-hidden="true" tabindex="-1"></a>The variability changes depending on the cohort, </span>
<span id="cb45-1347"><a href="#cb45-1347" aria-hidden="true" tabindex="-1"></a>specially because they have different follow-up times, </span>
<span id="cb45-1348"><a href="#cb45-1348" aria-hidden="true" tabindex="-1"></a>SCANB being the shortest. TCGA has very few number of events and we could</span>
<span id="cb45-1349"><a href="#cb45-1349" aria-hidden="true" tabindex="-1"></a>not select based on the treatment, the results for TCGA are less reliable.</span>
<span id="cb45-1350"><a href="#cb45-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1351"><a href="#cb45-1351" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of ER IHC and molecular ER signaling</span></span>
<span id="cb45-1352"><a href="#cb45-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1353"><a href="#cb45-1353" aria-hidden="true" tabindex="-1"></a>The new released dataset from the SCANB consortium contains the ER </span>
<span id="cb45-1354"><a href="#cb45-1354" aria-hidden="true" tabindex="-1"></a>percentage based on the IHC stainings. This is great, because we can</span>
<span id="cb45-1355"><a href="#cb45-1355" aria-hidden="true" tabindex="-1"></a>now compare the molecular ER signaling score to what is seen in the clinics.</span>
<span id="cb45-1356"><a href="#cb45-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1357"><a href="#cb45-1357" aria-hidden="true" tabindex="-1"></a>First we start by comparing the molecular score with the percentages </span>
<span id="cb45-1358"><a href="#cb45-1358" aria-hidden="true" tabindex="-1"></a>(@fig-cor-ihc-rna).</span>
<span id="cb45-1359"><a href="#cb45-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1360"><a href="#cb45-1360" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=10}</span></span>
<span id="cb45-1361"><a href="#cb45-1361" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cor-ihc-rna</span></span>
<span id="cb45-1362"><a href="#cb45-1362" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between ER IHC percentage and molecular ER signaling</span></span>
<span id="cb45-1363"><a href="#cb45-1363" aria-hidden="true" tabindex="-1"></a><span class="co">#|     by using the signature HALLMARK_ESTROGEN_RESPONSE_EARLY and SET ER/PR.</span></span>
<span id="cb45-1364"><a href="#cb45-1364" aria-hidden="true" tabindex="-1"></a>esr1_levels <span class="ot">&lt;-</span> <span class="fu">assay</span>(datasets<span class="sc">$</span>scanb, <span class="st">"logFPKM"</span>)[<span class="st">"ESR1"</span>, ]</span>
<span id="cb45-1365"><a href="#cb45-1365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-1366"><a href="#cb45-1366" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb45-1367"><a href="#cb45-1367" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb45-1368"><a href="#cb45-1368" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-1369"><a href="#cb45-1369" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) <span class="sc">%&gt;%</span></span>
<span id="cb45-1370"><a href="#cb45-1370" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb45-1371"><a href="#cb45-1371" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, SET_ERPR, <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>),</span>
<span id="cb45-1372"><a href="#cb45-1372" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb45-1373"><a href="#cb45-1373" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb45-1374"><a href="#cb45-1374" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb45-1375"><a href="#cb45-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1376"><a href="#cb45-1376" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb45-1377"><a href="#cb45-1377" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb45-1378"><a href="#cb45-1378" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> ER.pct, </span>
<span id="cb45-1379"><a href="#cb45-1379" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb45-1380"><a href="#cb45-1380" aria-hidden="true" tabindex="-1"></a>        <span class="co">#color = TreatGroup</span></span>
<span id="cb45-1381"><a href="#cb45-1381" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb45-1382"><a href="#cb45-1382" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb45-1383"><a href="#cb45-1383" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb45-1384"><a href="#cb45-1384" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="co">#, mapping = aes(shape = pam50)) +</span></span>
<span id="cb45-1385"><a href="#cb45-1385" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-1386"><a href="#cb45-1386" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER percentage"</span>,</span>
<span id="cb45-1387"><a href="#cb45-1387" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Molecular score"</span>,</span>
<span id="cb45-1388"><a href="#cb45-1388" aria-hidden="true" tabindex="-1"></a>        <span class="co">#shape = "Treatment group",</span></span>
<span id="cb45-1389"><a href="#cb45-1389" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb45-1390"><a href="#cb45-1390" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-1391"><a href="#cb45-1391" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between ER IHC percentage</span><span class="sc">\n</span><span class="st">and"</span>,</span>
<span id="cb45-1392"><a href="#cb45-1392" aria-hidden="true" tabindex="-1"></a>            <span class="st">" molecular ER signaling score"</span></span>
<span id="cb45-1393"><a href="#cb45-1393" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-1394"><a href="#cb45-1394" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb45-1395"><a href="#cb45-1395" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-1396"><a href="#cb45-1396" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb45-1397"><a href="#cb45-1397" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df)) <span class="sc">+</span></span>
<span id="cb45-1398"><a href="#cb45-1398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb45-1399"><a href="#cb45-1399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb45-1400"><a href="#cb45-1400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1401"><a href="#cb45-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1402"><a href="#cb45-1402" aria-hidden="true" tabindex="-1"></a>The first thing that one can notice is that ER percentage is very discrete,</span>
<span id="cb45-1403"><a href="#cb45-1403" aria-hidden="true" tabindex="-1"></a>pathologists probably don't assign non rounded percentage values, which </span>
<span id="cb45-1404"><a href="#cb45-1404" aria-hidden="true" tabindex="-1"></a>makes sense. Another thing to notice is that for high ER percentage </span>
<span id="cb45-1405"><a href="#cb45-1405" aria-hidden="true" tabindex="-1"></a>patients you have a whole spectrum of molecular ER signaling score.</span>
<span id="cb45-1406"><a href="#cb45-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1407"><a href="#cb45-1407" aria-hidden="true" tabindex="-1"></a>Now we look speficially at the high ER percentage patients and compare</span>
<span id="cb45-1408"><a href="#cb45-1408" aria-hidden="true" tabindex="-1"></a>their ER signaling scores. We previously saw that the distribution</span>
<span id="cb45-1409"><a href="#cb45-1409" aria-hidden="true" tabindex="-1"></a>of these scores seems to be wide.</span>
<span id="cb45-1410"><a href="#cb45-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1411"><a href="#cb45-1411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=7, fig.height=10}</span></span>
<span id="cb45-1412"><a href="#cb45-1412" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-high-er</span></span>
<span id="cb45-1413"><a href="#cb45-1413" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Scores for high ER percentage breast cancer patients.</span></span>
<span id="cb45-1414"><a href="#cb45-1414" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb45-1415"><a href="#cb45-1415" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb45-1416"><a href="#cb45-1416" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-1417"><a href="#cb45-1417" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) <span class="sc">%&gt;%</span></span>
<span id="cb45-1418"><a href="#cb45-1418" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb45-1419"><a href="#cb45-1419" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, SET_ERPR, <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>),</span>
<span id="cb45-1420"><a href="#cb45-1420" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb45-1421"><a href="#cb45-1421" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb45-1422"><a href="#cb45-1422" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb45-1423"><a href="#cb45-1423" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(ER.pct <span class="sc">&gt;=</span> <span class="dv">90</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-1424"><a href="#cb45-1424" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb45-1425"><a href="#cb45-1425" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> score</span>
<span id="cb45-1426"><a href="#cb45-1426" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb45-1427"><a href="#cb45-1427" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span> </span>
<span id="cb45-1428"><a href="#cb45-1428" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-1429"><a href="#cb45-1429" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Score"</span>,</span>
<span id="cb45-1430"><a href="#cb45-1430" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-1431"><a href="#cb45-1431" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Scores for high ER IHC (over 90%)</span><span class="sc">\n</span><span class="st">percentage BC patients"</span>,</span>
<span id="cb45-1432"><a href="#cb45-1432" aria-hidden="true" tabindex="-1"></a>            <span class="st">" ("</span>, <span class="fu">length</span>(scanb_high_er), <span class="st">" pts)"</span></span>
<span id="cb45-1433"><a href="#cb45-1433" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb45-1434"><a href="#cb45-1434" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb45-1435"><a href="#cb45-1435" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb45-1436"><a href="#cb45-1436" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-1437"><a href="#cb45-1437" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span> </span>
<span id="cb45-1438"><a href="#cb45-1438" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb45-1439"><a href="#cb45-1439" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">16</span>),</span>
<span id="cb45-1440"><a href="#cb45-1440" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>), </span>
<span id="cb45-1441"><a href="#cb45-1441" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb45-1442"><a href="#cb45-1442" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb45-1443"><a href="#cb45-1443" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)</span>
<span id="cb45-1444"><a href="#cb45-1444" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-1445"><a href="#cb45-1445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1446"><a href="#cb45-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1447"><a href="#cb45-1447" aria-hidden="true" tabindex="-1"></a>@fig-scores-high-er shows how the distributions are not skewed towards</span>
<span id="cb45-1448"><a href="#cb45-1448" aria-hidden="true" tabindex="-1"></a>high values only. It looks like there is a step in the SET ER/PR signature,</span>
<span id="cb45-1449"><a href="#cb45-1449" aria-hidden="true" tabindex="-1"></a>we now compare with the ESR1 values and hallmark estrogen response early.</span>
<span id="cb45-1450"><a href="#cb45-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1451"><a href="#cb45-1451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=7}</span></span>
<span id="cb45-1452"><a href="#cb45-1452" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-seter-others</span></span>
<span id="cb45-1453"><a href="#cb45-1453" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between SET ER/PR and other scores.</span></span>
<span id="cb45-1454"><a href="#cb45-1454" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb45-1455"><a href="#cb45-1455" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb45-1456"><a href="#cb45-1456" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-1457"><a href="#cb45-1457" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span> <span class="ot">=</span> esr1_levels) <span class="sc">%&gt;%</span></span>
<span id="cb45-1458"><a href="#cb45-1458" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb45-1459"><a href="#cb45-1459" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(HALLMARK_ESTROGEN_RESPONSE_EARLY, <span class="st">`</span><span class="at">log2(ESR1)</span><span class="st">`</span>),</span>
<span id="cb45-1460"><a href="#cb45-1460" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb45-1461"><a href="#cb45-1461" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb45-1462"><a href="#cb45-1462" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb45-1463"><a href="#cb45-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1464"><a href="#cb45-1464" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb45-1465"><a href="#cb45-1465" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb45-1466"><a href="#cb45-1466" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> SET_ERPR, </span>
<span id="cb45-1467"><a href="#cb45-1467" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb45-1468"><a href="#cb45-1468" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb45-1469"><a href="#cb45-1469" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb45-1470"><a href="#cb45-1470" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb45-1471"><a href="#cb45-1471" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb45-1472"><a href="#cb45-1472" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-1473"><a href="#cb45-1473" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">expression</span>(SET[ER<span class="sc">/</span>PR]),</span>
<span id="cb45-1474"><a href="#cb45-1474" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Score"</span>,</span>
<span id="cb45-1475"><a href="#cb45-1475" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb45-1476"><a href="#cb45-1476" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-1477"><a href="#cb45-1477" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Correlation between SET ER/PR and"</span>,</span>
<span id="cb45-1478"><a href="#cb45-1478" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">Estrogen Early, log(ESR1)"</span></span>
<span id="cb45-1479"><a href="#cb45-1479" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-1480"><a href="#cb45-1480" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb45-1481"><a href="#cb45-1481" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-1482"><a href="#cb45-1482" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span> </span>
<span id="cb45-1483"><a href="#cb45-1483" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df)) <span class="sc">+</span></span>
<span id="cb45-1484"><a href="#cb45-1484" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb45-1485"><a href="#cb45-1485" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() </span>
<span id="cb45-1486"><a href="#cb45-1486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1487"><a href="#cb45-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1488"><a href="#cb45-1488" aria-hidden="true" tabindex="-1"></a>There is a highly positive correlation. Also interesting to see that </span>
<span id="cb45-1489"><a href="#cb45-1489" aria-hidden="true" tabindex="-1"></a>ESR1 levels are not necessarily highly correlated with high </span>
<span id="cb45-1490"><a href="#cb45-1490" aria-hidden="true" tabindex="-1"></a>SET ER/PR scores. Remember that for ESR1 the scale is </span>
<span id="cb45-1491"><a href="#cb45-1491" aria-hidden="true" tabindex="-1"></a>logarithmic, so even if the slope is smaller than in the</span>
<span id="cb45-1492"><a href="#cb45-1492" aria-hidden="true" tabindex="-1"></a>hallmark estrogen response early, it might mean a higher correlation</span>
<span id="cb45-1493"><a href="#cb45-1493" aria-hidden="true" tabindex="-1"></a>even..</span>
<span id="cb45-1494"><a href="#cb45-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1495"><a href="#cb45-1495" aria-hidden="true" tabindex="-1"></a>@fig-er-hist shows the distribution of the ER IHC percentage for the</span>
<span id="cb45-1496"><a href="#cb45-1496" aria-hidden="true" tabindex="-1"></a>patients used in the previous survival analysis for SCANB. </span>
<span id="cb45-1497"><a href="#cb45-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1500"><a href="#cb45-1500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-1501"><a href="#cb45-1501" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-hist</span></span>
<span id="cb45-1502"><a href="#cb45-1502" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Histogram of ER IHC percentage of the SCANB samples used</span></span>
<span id="cb45-1503"><a href="#cb45-1503" aria-hidden="true" tabindex="-1"></a><span class="co">#|     for survival analysis</span></span>
<span id="cb45-1504"><a href="#cb45-1504" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>scanb <span class="sc">%&gt;%</span></span>
<span id="cb45-1505"><a href="#cb45-1505" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb45-1506"><a href="#cb45-1506" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb45-1507"><a href="#cb45-1507" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> scanb_samples) <span class="sc">%&gt;%</span></span>
<span id="cb45-1508"><a href="#cb45-1508" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ER.pct)) <span class="sc">+</span></span>
<span id="cb45-1509"><a href="#cb45-1509" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb45-1510"><a href="#cb45-1510" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb45-1511"><a href="#cb45-1511" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER percentage"</span>,</span>
<span id="cb45-1512"><a href="#cb45-1512" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb45-1513"><a href="#cb45-1513" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ER IHC percentage of the patients"</span>,</span>
<span id="cb45-1514"><a href="#cb45-1514" aria-hidden="true" tabindex="-1"></a>            <span class="st">" selected for survival analysis"</span></span>
<span id="cb45-1515"><a href="#cb45-1515" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-1516"><a href="#cb45-1516" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb45-1517"><a href="#cb45-1517" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) </span>
<span id="cb45-1518"><a href="#cb45-1518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1519"><a href="#cb45-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1520"><a href="#cb45-1520" aria-hidden="true" tabindex="-1"></a>We see that the majority of the patients actually have already pretty</span>
<span id="cb45-1521"><a href="#cb45-1521" aria-hidden="true" tabindex="-1"></a>high percentage. It could be that the results of the overall survival </span>
<span id="cb45-1522"><a href="#cb45-1522" aria-hidden="true" tabindex="-1"></a>analysis are actually driven by the the low ER percentage patients,</span>
<span id="cb45-1523"><a href="#cb45-1523" aria-hidden="true" tabindex="-1"></a>so we performed the survival analysis only on patients with ER percentage</span>
<span id="cb45-1524"><a href="#cb45-1524" aria-hidden="true" tabindex="-1"></a>equal or higher than 90%. The table below shows the total number of </span>
<span id="cb45-1525"><a href="#cb45-1525" aria-hidden="true" tabindex="-1"></a>patients for each analysis.</span>
<span id="cb45-1526"><a href="#cb45-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1529"><a href="#cb45-1529" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-1530"><a href="#cb45-1530" aria-hidden="true" tabindex="-1"></a>nb_pts_events</span>
<span id="cb45-1531"><a href="#cb45-1531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1532"><a href="#cb45-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1533"><a href="#cb45-1533" aria-hidden="true" tabindex="-1"></a>There was a decrease of around 200 patients with 80 events less, so indeed</span>
<span id="cb45-1534"><a href="#cb45-1534" aria-hidden="true" tabindex="-1"></a>a lot of those patients with lower ER percentage had died. @fig-er-ihc-survival</span>
<span id="cb45-1535"><a href="#cb45-1535" aria-hidden="true" tabindex="-1"></a>shows the results of the survival analysis when considering the ER IHC </span>
<span id="cb45-1536"><a href="#cb45-1536" aria-hidden="true" tabindex="-1"></a>percentage as a continuous score on SCANB.</span>
<span id="cb45-1537"><a href="#cb45-1537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1540"><a href="#cb45-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-1541"><a href="#cb45-1541" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-survival</span></span>
<span id="cb45-1542"><a href="#cb45-1542" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage as the score instead</span></span>
<span id="cb45-1543"><a href="#cb45-1543" aria-hidden="true" tabindex="-1"></a><span class="co">#|     of the common molecular ER signaling scores</span></span>
<span id="cb45-1544"><a href="#cb45-1544" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb45-1545"><a href="#cb45-1545" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb[[<span class="st">"ER.pct"</span>]]))</span>
<span id="cb45-1546"><a href="#cb45-1546" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1547"><a href="#cb45-1547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1548"><a href="#cb45-1548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1549"><a href="#cb45-1549" aria-hidden="true" tabindex="-1"></a>We a very tight confidence interval in this case with a HR very close</span>
<span id="cb45-1550"><a href="#cb45-1550" aria-hidden="true" tabindex="-1"></a>to 1, meaning that for every 1% increase there is a 2% decrease in your </span>
<span id="cb45-1551"><a href="#cb45-1551" aria-hidden="true" tabindex="-1"></a>risk of dying. The table with the values is shown below.</span>
<span id="cb45-1552"><a href="#cb45-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1555"><a href="#cb45-1555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb45-1556"><a href="#cb45-1556" aria-hidden="true" tabindex="-1"></a>tables_survival <span class="sc">%&gt;%</span></span>
<span id="cb45-1557"><a href="#cb45-1557" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span> <span class="sc">&amp;</span> term <span class="sc">==</span> <span class="st">"ER.pct"</span>)</span>
<span id="cb45-1558"><a href="#cb45-1558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1559"><a href="#cb45-1559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1560"><a href="#cb45-1560" aria-hidden="true" tabindex="-1"></a>Next we selected only patients that had 90% or more ER IHC percentage </span>
<span id="cb45-1561"><a href="#cb45-1561" aria-hidden="true" tabindex="-1"></a>to perform the survival analysis. @fig-er-ihc-high-os shows the results</span>
<span id="cb45-1562"><a href="#cb45-1562" aria-hidden="true" tabindex="-1"></a>for both the analysis done on ER IHC percentage,  </span>
<span id="cb45-1563"><a href="#cb45-1563" aria-hidden="true" tabindex="-1"></a>HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR.</span>
<span id="cb45-1564"><a href="#cb45-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1565"><a href="#cb45-1565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb45-1566"><a href="#cb45-1566" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-high-os</span></span>
<span id="cb45-1567"><a href="#cb45-1567" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb45-1568"><a href="#cb45-1568" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb45-1569"><a href="#cb45-1569" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with 90% or more in the ER IHC were selected.</span></span>
<span id="cb45-1570"><a href="#cb45-1570" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb45-1571"><a href="#cb45-1571" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_high_er<span class="sc">$</span>ER.pct)),</span>
<span id="cb45-1572"><a href="#cb45-1572" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_high_er<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY)),</span>
<span id="cb45-1573"><a href="#cb45-1573" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>os<span class="sc">$</span>scanb_high_er<span class="sc">$</span>SET_ERPR))</span>
<span id="cb45-1574"><a href="#cb45-1574" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1575"><a href="#cb45-1575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1576"><a href="#cb45-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1577"><a href="#cb45-1577" aria-hidden="true" tabindex="-1"></a>When performing the survival analysis among the high ER percentage, there is</span>
<span id="cb45-1578"><a href="#cb45-1578" aria-hidden="true" tabindex="-1"></a>no evidence to differentiate between 90 to 100%, but by using the molecular</span>
<span id="cb45-1579"><a href="#cb45-1579" aria-hidden="true" tabindex="-1"></a>scores that fact is still true, showing that perhaps the molecular score</span>
<span id="cb45-1580"><a href="#cb45-1580" aria-hidden="true" tabindex="-1"></a>could be more sensitive for these patients. </span>
<span id="cb45-1581"><a href="#cb45-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1582"><a href="#cb45-1582" aria-hidden="true" tabindex="-1"></a>We can also analyse the recurrence free survival for this cohort </span>
<span id="cb45-1583"><a href="#cb45-1583" aria-hidden="true" tabindex="-1"></a>(@fig-er-ihc-high-rfs).</span>
<span id="cb45-1584"><a href="#cb45-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1585"><a href="#cb45-1585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=9.5, fig.width = 6}</span></span>
<span id="cb45-1586"><a href="#cb45-1586" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-er-ihc-high-rfs</span></span>
<span id="cb45-1587"><a href="#cb45-1587" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Survival analysis using ER IHC percentage, </span></span>
<span id="cb45-1588"><a href="#cb45-1588" aria-hidden="true" tabindex="-1"></a><span class="co">#|     HALLMARK_ESTROGEN_RESPONSE_EARLY and SET_ERPR as the scores. Only </span></span>
<span id="cb45-1589"><a href="#cb45-1589" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients with 90% or more in the ER IHC were selected.</span></span>
<span id="cb45-1590"><a href="#cb45-1590" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(</span>
<span id="cb45-1591"><a href="#cb45-1591" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_er<span class="sc">$</span>ER.pct)),</span>
<span id="cb45-1592"><a href="#cb45-1592" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_er<span class="sc">$</span>HALLMARK_ESTROGEN_RESPONSE_EARLY)),</span>
<span id="cb45-1593"><a href="#cb45-1593" aria-hidden="true" tabindex="-1"></a>    ggplotify<span class="sc">::</span><span class="fu">grid2grob</span>(<span class="fu">print</span>(forest_plots<span class="sc">$</span>rfs<span class="sc">$</span>scanb_high_er<span class="sc">$</span>SET_ERPR))</span>
<span id="cb45-1594"><a href="#cb45-1594" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-1595"><a href="#cb45-1595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-1596"><a href="#cb45-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1597"><a href="#cb45-1597" aria-hidden="true" tabindex="-1"></a>The problem now is that the number of events is much smaller, so the</span>
<span id="cb45-1598"><a href="#cb45-1598" aria-hidden="true" tabindex="-1"></a>confidence intervals for the estimates will be bigger. We see</span>
<span id="cb45-1599"><a href="#cb45-1599" aria-hidden="true" tabindex="-1"></a>that for both signatures the HR is way below 1, meaning that </span>
<span id="cb45-1600"><a href="#cb45-1600" aria-hidden="true" tabindex="-1"></a>the higher the score the better it is for the patient. Also the </span>
<span id="cb45-1601"><a href="#cb45-1601" aria-hidden="true" tabindex="-1"></a>hazard ratio decreased in this case.</span>
<span id="cb45-1602"><a href="#cb45-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1603"><a href="#cb45-1603" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb45-1604"><a href="#cb45-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1605"><a href="#cb45-1605" aria-hidden="true" tabindex="-1"></a>In this chapter we've shown that ER+ BC patients are very distinct</span>
<span id="cb45-1606"><a href="#cb45-1606" aria-hidden="true" tabindex="-1"></a>from each other, as it can be seen from the umap projections and </span>
<span id="cb45-1607"><a href="#cb45-1607" aria-hidden="true" tabindex="-1"></a>the subtypes. These patients might respond differently for endocrine therapy</span>
<span id="cb45-1608"><a href="#cb45-1608" aria-hidden="true" tabindex="-1"></a>as well, and this might depend on the ER signaling, how active it is. </span>
<span id="cb45-1609"><a href="#cb45-1609" aria-hidden="true" tabindex="-1"></a>Therefore, when deciding a treatment, more care should be taken with</span>
<span id="cb45-1610"><a href="#cb45-1610" aria-hidden="true" tabindex="-1"></a>ER+ BC patients and check their signaling scores somehow. The $SET_{ER/PR}$</span>
<span id="cb45-1611"><a href="#cb45-1611" aria-hidden="true" tabindex="-1"></a>signature is a good signature showing very good hazard ratios across</span>
<span id="cb45-1612"><a href="#cb45-1612" aria-hidden="true" tabindex="-1"></a>the different cohorts. This signature has also been validated on the clinics</span>
<span id="cb45-1613"><a href="#cb45-1613" aria-hidden="true" tabindex="-1"></a>for use.</span>
<span id="cb45-1614"><a href="#cb45-1614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-1615"><a href="#cb45-1615" aria-hidden="true" tabindex="-1"></a>Knowing the ER signaling for a patient is very important when deciding</span>
<span id="cb45-1616"><a href="#cb45-1616" aria-hidden="true" tabindex="-1"></a>treatment, but not enough. What could be other alternatives for patients</span>
<span id="cb45-1617"><a href="#cb45-1617" aria-hidden="true" tabindex="-1"></a>that have low ER signaling and are still considered ER+? Should they use</span>
<span id="cb45-1618"><a href="#cb45-1618" aria-hidden="true" tabindex="-1"></a>only endocrine therapy or supplement it with something else? In the</span>
<span id="cb45-1619"><a href="#cb45-1619" aria-hidden="true" tabindex="-1"></a>next chapters we present a framework where we can take a look</span>
<span id="cb45-1620"><a href="#cb45-1620" aria-hidden="true" tabindex="-1"></a>at a more personalised approach for treatments. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chronchi">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/chronchi">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
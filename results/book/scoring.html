<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Molecular landscape: a new framework for personalized medicine in Breast Cancer. - 4&nbsp; Pathway activity in a personalized context</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./risk_score.html" rel="next">
<link href="./validation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.28/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./scoring.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Molecular landscape: a new framework for personalized medicine in Breast Cancer.</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chronchi/molecular_landscape" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surv_analysis_estrogen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pca_merging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scoring.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./risk_score.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk score model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./trying.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Tests and tries</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discussion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discussion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#calculating-scores-in-neighborhoods" id="toc-calculating-scores-in-neighborhoods" class="nav-link active" data-scroll-target="#calculating-scores-in-neighborhoods"><span class="header-section-number">4.1</span> Calculating scores in neighborhoods</a></li>
  <li><a href="#poetic-embedding" id="toc-poetic-embedding" class="nav-link" data-scroll-target="#poetic-embedding"><span class="header-section-number">4.2</span> POETIC embedding</a>
  <ul class="collapse">
  <li><a href="#number-of-samples" id="toc-number-of-samples" class="nav-link" data-scroll-target="#number-of-samples"><span class="header-section-number">4.2.1</span> Number of samples</a></li>
  <li><a href="#proportion-of-top-loadings" id="toc-proportion-of-top-loadings" class="nav-link" data-scroll-target="#proportion-of-top-loadings"><span class="header-section-number">4.2.2</span> Proportion of top loadings</a></li>
  <li><a href="#embedding" id="toc-embedding" class="nav-link" data-scroll-target="#embedding"><span class="header-section-number">4.2.3</span> Embedding</a></li>
  <li><a href="#differences-in-pc3-for-responders-and-non-responders" id="toc-differences-in-pc3-for-responders-and-non-responders" class="nav-link" data-scroll-target="#differences-in-pc3-for-responders-and-non-responders"><span class="header-section-number">4.2.4</span> Differences in PC3 for responders and non responders</a></li>
  </ul></li>
  <li><a href="#scoring-all-samples" id="toc-scoring-all-samples" class="nav-link" data-scroll-target="#scoring-all-samples"><span class="header-section-number">4.3</span> Scoring all samples</a></li>
  <li><a href="#analysing-patient-neighborhoods" id="toc-analysing-patient-neighborhoods" class="nav-link" data-scroll-target="#analysing-patient-neighborhoods"><span class="header-section-number">4.4</span> Analysing patient neighborhoods</a>
  <ul class="collapse">
  <li><a href="#matching-other-responders-and-non-responders" id="toc-matching-other-responders-and-non-responders" class="nav-link" data-scroll-target="#matching-other-responders-and-non-responders"><span class="header-section-number">4.4.1</span> Matching other responders and non-responders</a></li>
  <li><a href="#analysing-all-patients" id="toc-analysing-all-patients" class="nav-link" data-scroll-target="#analysing-all-patients"><span class="header-section-number">4.4.2</span> Analysing all patients</a></li>
  </ul></li>
  <li><a href="#predicting-response-to-endocrine-therapy" id="toc-predicting-response-to-endocrine-therapy" class="nav-link" data-scroll-target="#predicting-response-to-endocrine-therapy"><span class="header-section-number">4.5</span> Predicting response to endocrine therapy</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chronchi/molecular_landscape/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This chapter we present a new way to think about the personalized medicine, by incorporating patient molecular information and its context. We saw previously that by using different cohorts, we can embed new patients into a point cloud. The idea is that the neighborhood of the patients are similar in the molecular level, and we can draw conclusions based on this.</p>
<p>Each patient can be assigned a score. Scores represent a biological pathway, or in other words, a biological activity. Given a biological process, there is usually a set of genes that represent it. We can then use these set of genes to calculate scores that are proxies of this biological activity.</p>
<p>For example, in the previous chapters we used the ER signaling scores to motivate the continuity of ER signaling. This is not restricted to this specific pathway, we could have used any other list of genes representing a process.</p>
<p>By combining a score and the neighborhood of a patient, we can make direct comparisons and questions. Given a patient, how different is its score for a pathway compared to its neighbors? Is there also an alternative pathway that could be target and has a higher signaling? In this case specifically, is ER signaling more or less expressed compared to its neighbors?</p>
<p>The POETIC trial <span class="citation" data-cites="Gao2019">(<a href="references.html#ref-Gao2019" role="doc-biblioref">Gao et al. 2019</a>)</span> is a breast cancer trial that had as hypothesis neoadjuvant therapy could improve overall and recurrence free survival. They gave aromatase inhibitors (AIs) for ER+ BC patients for 2 weeks prior to surgery and then 2 weeks after surgery. Moreover, they collected a needle biopsy before the treatment started and a biopsy in the surgery. They also measured the Ki67 levels, therefore we have a proxy on how well these patients responded in the short term to AIs. Also, they sent the tissues for sequencing, so microarray data is available. This is a unique cohort, in the sense that we can understand what are the responders or not, in terms of Ki67 levels, and use the molecular data to try to understand the responsiveness. The definition of responders are those patients that have a reduction of at least 60% in Ki67 levels when comparing pre-treatment versus surgery.</p>
<p>Here we use this cohort to draw conclusions on responders and non responders and how the molecular landscape can be used. We show that some patients that are close to each other in the molecular landscape can have different pathway scores and therefore have different responses.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>* The library is already synchronized with the lockfile.</code></pre>
</div>
</div>
<section id="calculating-scores-in-neighborhoods" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="calculating-scores-in-neighborhoods"><span class="header-section-number">4.1</span> Calculating scores in neighborhoods</h2>
<p>Patients close to each other in the molecular landscape are somewhat molecularly close, due to how the embedding works. Therefore, we can look at patients in a neighborhood and calculate the average scores, to see what it means to be in a specific neighborhood.</p>
<p>To do this, we define a radius for a patient where all the patients within the euclidean ball with this radius will be selected and an average score distribution is calculated.</p>
<p>To calculate the average score distribution we use the <code>rstanarm</code> package. We set the prior distribution for the intercept to be a normal distribution centered at 0 with standard deviation of 1. All scores are in a range of -1 to 1, so this is a relatively flat prior for our use case.</p>
<p>The video below shows how scores change in average when comparing different neighborhoods.</p>
<iframe width="720" height="480" src="../plots/scoring/mol_land.mp4" align="middle" frameborder="0" allowfullscreen="">
</iframe>
<p>Going from right to left it shows how ER signaling is decreased. From top to bottom there is a reduction of proliferation, E2F targets, and a change in EMT and TGFb signaling. These are representative scores, other pathways could be used as well.</p>
</section>
<section id="poetic-embedding" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="poetic-embedding"><span class="header-section-number">4.2</span> POETIC embedding</h2>
<p>In this section we show the embedding of the POETIC trial samples. But first we analyse some basic properties of the dataset. The data for this dataset was downloaded and processed as described at <a href="https://chronchi.github.io/transcriptomics/">chronchi.github.io/transcriptomics</a> in the chapter AI - GSE105777.</p>
<section id="number-of-samples" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="number-of-samples"><span class="header-section-number">4.2.1</span> Number of samples</h3>
<p>In this dataset there are matched samples from patients that are treated and untreated. <a href="#tbl-pt-poetic-nb">Table&nbsp;<span>4.1</span></a></p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-pt-poetic-nb" class="anchored">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.1: Table showing the number of samples for treated and untreated patients</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">treated</td>
<td style="text-align: right;">157</td>
<td style="text-align: right;">74</td>
</tr>
<tr class="even">
<td style="text-align: left;">untreated</td>
<td style="text-align: right;">56</td>
<td style="text-align: right;">26</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>In this cohort, there is the PAM50 molecular subtype available for the untreated. <a href="#tbl-pt-poetic-pam50">Table&nbsp;<span>4.2</span></a> shows the number of patients for each subtype.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-pt-poetic-pam50" class="anchored">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.2: Table showing the number of molecular subtypes for each group.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">pam50</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">her2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.235</td>
</tr>
<tr class="even">
<td style="text-align: left;">luma</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">18.075</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lumb</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">7.277</td>
</tr>
<tr class="even">
<td style="text-align: left;">normal</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.704</td>
</tr>
<tr class="odd">
<td style="text-align: left;">not_available</td>
<td style="text-align: right;">314</td>
<td style="text-align: right;">73.709</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>The numbers differ from previously, since the molecular subtype is calculated for each sample, so two molecular subtypes for each patient.</p>
</section>
<section id="proportion-of-top-loadings" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="proportion-of-top-loadings"><span class="header-section-number">4.2.2</span> Proportion of top loadings</h3>
<p>There are in total 1008 genes available out of the . Among them, 39 are the housekeeping genes. Out of the 36 genes missing, a total number of 8 are missing from the top 200 PC3 loadings, a proportion of 4%. A total number of 5 are missing from the top 200 PC4 loadings, a proportion of 2%. These are very small proportions, and we have seen from the last chapter that they will not affect the position of the patients in the embedding.</p>
</section>
<section id="embedding" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="embedding"><span class="header-section-number">4.2.3</span> Embedding</h3>
<p><a href="#fig-pca-poetic-er-pam50">Figure&nbsp;<span>4.1</span></a> shows a good mixing of the POETIC sample and how all the patients are scattered across the whole landscape. Here all samples are plotted, meaning that every two dots correspond to a single patient.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-poetic-er-pam50" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-pca-poetic-er-pam50-1.png" class="img-fluid figure-img" width="1824"></p>
<figcaption class="figure-caption">Figure&nbsp;4.1: PCA embedding of all samples from TCGA, SCANB and METABRIC including the POETIC samples on top. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype.</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-pca-responders-baseline">Figure&nbsp;<span>4.2</span></a> shows the embedding of baseline samples from patients that received endocrine therapy prior to surgery. Patients on the left part of the molecular landscape are considered to be non responders, this coincides with the fact this region corresponds to the ER- BC patients.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-responders-baseline" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-pca-responders-baseline-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4.2: PCA embedding of all samples from TCGA, SCANB and METABRIC including the POETIC samples on top. POETIC samples correspond to only baseline treated patients.</figcaption>
</figure>
</div>
</div>
</div>
<p>And when checking the first two components, the POETIC data is closer to METABRIC, which makes sense since both are microarrays, as it can be seen in <a href="#fig-poetic-cohort">Figure&nbsp;<span>4.3</span></a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-poetic-cohort" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-poetic-cohort-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.3: Biplot of first two PCA components from POETIC, TCGA, SCANB and METABRIC. POETIC is highlighted in the plot and has a bigger point.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="differences-in-pc3-for-responders-and-non-responders" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="differences-in-pc3-for-responders-and-non-responders"><span class="header-section-number">4.2.4</span> Differences in PC3 for responders and non responders</h3>
<p>We now also compare the differences in non responders vs responders according to the third component.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-comp-responders-pc3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-comp-responders-pc3-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;4.4: Comparison of the PC3 between responders and non responders</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that there is a clear difference, we now use bayesian stats to do the comparison and get the posterior distribution of the difference in PC3.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Model Info:
 function:     stan_lm
 family:       gaussian [identity]
 formula:      PC3 ~ is_responder
 algorithm:    sampling
 sample:       4000 (posterior sample size)
 priors:       see help('prior_summary')
 observations: 137
 predictors:   2

Estimates:
                        mean   sd   10%   50%   90%
(Intercept)           -0.8    0.3 -1.1  -0.8  -0.4 
is_responderResponder  1.6    0.3  1.2   1.6   2.0 
sigma                  2.0    0.1  1.8   2.0   2.2 
log-fit_ratio         -0.3    0.1 -0.4  -0.3  -0.2 
R2                     0.2    0.1  0.1   0.2   0.4 

Fit Diagnostics:
           mean   sd   10%   50%   90%
mean_PPD 0.3    0.2  0.0   0.3   0.6  

The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help('summary.stanreg')).

MCMC diagnostics
                      mcse Rhat n_eff
(Intercept)           0.0  1.0  1039 
is_responderResponder 0.0  1.0  1048 
sigma                 0.0  1.0  2077 
log-fit_ratio         0.0  1.0  1472 
R2                    0.0  1.0   872 
mean_PPD              0.0  1.0  2971 
log-posterior         0.0  1.0  1252 

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
</div>
</div>
<p>The difference is clear, when looking at the parameter <code>is_responderResponder</code>. The Rhat is reasonable and the number of effective sample size is good as well. Below we plot the average posterior distribution of the difference between responders and non responders.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-comp-responders-pc3-bayes" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-comp-responders-pc3-bayes-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;4.5: Comparison of the PC3 between responders and non responders. Difference in the expected posterior predictive distributions. Each dot corresponds to a 1% quantile.</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that the difference is 100% higher than 0 and even more the difference is higher than 0.5, meaning that responders have higher PC3 compared to non responders. The plot below shows the average values as well for responders and non responders separately.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-average-pc3-poetic" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-average-pc3-poetic-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;4.6: <strong>?(caption)</strong></figcaption>
</figure>
</div>
</div>
</div>
<p>And to conclude we also calculate the p-value for the sake of it.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-eef9d8502abeac1c8696" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-eef9d8502abeac1c8696">{"x":{"filter":"none","vertical":false,"data":[["1","2"],["(Intercept)","is_responderResponder"],["-0.9"," 1.8"],["0.30","0.36"],["-3.0"," 4.9"],["3.4e-03","2.9e-06"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>term<\/th>\n      <th>estimate<\/th>\n      <th>std.error<\/th>\n      <th>statistic<\/th>\n      <th>p.value<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The p-value is around 2.9e-06, very small, three stars!</p>
</section>
</section>
<section id="scoring-all-samples" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="scoring-all-samples"><span class="header-section-number">4.3</span> Scoring all samples</h2>
<p>In the last chapters scores were showed for TCGA, SCANB and METABRIC. <a href="pca_merging.html#fig-pca-seterpr">Figure&nbsp;<span>2.20</span></a> shows how ER signaling changes as patients move across the molecular landscape. We intend to use the scores now for the POETIC samples. We first start by calculating using GSVA as well and include in the dataframe with the other cohorts. Before moving to the next chapter, we will analyse and compare the scores across the responders and non responders.</p>
<p><a href="#fig-scores-poetic-er">Figure&nbsp;<span>4.7</span></a> shows that when using the scores, it looks like in average at baseline <span class="math inline">\(SET_{ER/PR}\)</span> is lower in non responders than in responders. For the other scores there is no clear difference.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-poetic-er" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-scores-poetic-er-1.png" class="img-fluid figure-img" width="1248"></p>
<figcaption class="figure-caption">Figure&nbsp;4.7: Baseline scores for all treated patients in the POETIC trial. G2M corresponds to a proliferation score, EMT to epithelial to mesenchymal transition score and the others are related to ER signaling.</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that for PC3 and SET ER/PR There are some differences in terms of the responders and non responders.</p>
<p>Let us take a closer look at those patients. We start by plotting the scatter plot of PC3 vs SET ER/PR and color by response status defined by the POETIC trial.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-poetic-responders" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-scores-poetic-responders-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.8: Comparison of the third component with SET ER/PR scores colored by response status.</figcaption>
</figure>
</div>
</div>
</div>
<p>This figure shows that there is a correlation between third component and SET ER/PR for the POETIC trial data as well as it was already seen from the other cohorts. Moreover, it seems that the responders have higher PC scores in general. We now correlate for each subgroup (responder and non responders) the PC3 and the change in percentage for Ki67.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scores-corr-poetic" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-scores-corr-poetic-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4.9: Correlation between change in Ki67 versus PC3 stratified by response group.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now another metric we can calculate from our dataset is the difference of the embedding positions between the different samples of the same patient. The idea is that if a patient responded well, there were bigger changes as well in the transcriptomics and that is reflected in the embedding.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-diff-embedding-poetic" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-diff-embedding-poetic-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4.10: Differences of the embeddings for each patient individually stratified by response status. Each dot corresponds to a single patient.</figcaption>
</figure>
</div>
</div>
</div>
<p>And now we perform a comparison of these positions by using rstanarm to get the posterior distributions of the differences.</p>
<p>The figure below shows the distribution of the averages of the differences in the embedding of the projections.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-diff-embedding-poetic-averages" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-diff-embedding-poetic-averages-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.11: Differences of the embeddings for each patient individually stratified by response status. Each dot corresponds to a single patient.</figcaption>
</figure>
</div>
</div>
</div>
<p>And the figure below shows the posterior distribution of the differences in average.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-diff-embedding-poetic-averages-diff" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-diff-embedding-poetic-averages-diff-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.12: Differences of the average differences in the embedding for each patient individually. The comparison made was non responder vs responder, which means that if non responder has a lower difference in average, the difference in difference will be negative.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="analysing-patient-neighborhoods" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="analysing-patient-neighborhoods"><span class="header-section-number">4.4</span> Analysing patient neighborhoods</h2>
<p>There are two ways to interpret the embedding. If the patient has ER+ BC and its embedding is close to the ER- BC patients, we can infer that the endocrine response might not work so well, as it was shown in <a href="#fig-pca-responders-baseline">Figure&nbsp;<span>4.2</span></a>. The other option is to compare the patientâ€™s score to the average score of its neighborhood.</p>
<p>What is a neighborhood? When performing the embedding, global structures are not preserved usually. In this sense we only compare patients that are close to each other in an euclidean neighborhood, i.e., we calculate a radius around each sample and see what other samples are within this ball given the euclidean distance.</p>
<p>Given a neighborhood, one can calculate the posterior average score of all samples from METABRIC, SCANB and TCGA and use that as an indication of average score that we can compare other patients to. The concept is that if an ER+ BC patient has a much lower ER signaling score, it means the patients will not respond so well to endocrine therapy, as they are very different from their neighboors.</p>
<p>To showcase the ability to use the scores and infer results, we use the POETIC trial patients to compare the scores. This cohort is special in the sense that the patients are filtered based on selection criterias, meaning that the patients are clinically similar.</p>
<p>Two random patients in very close neighborhoods were selected to showcase the ability of the molecular landscape. The id of the patients are 63 and 236. <a href="#tbl-pt63-236">Table&nbsp;<span>4.3</span></a> shows the clinical features of these patients. One of them is HER2+. Patient 63 had a higher Ki67 baseline level but a very good response to endocrine therapy. Patient 236 did not respond to endocrine therapy in terms of reduction of Ki67 levels.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-pt63-236" class="anchored">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;4.3: Clinical features from patients 63 and 236.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">patient_nb</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">er_status</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">her2_status</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ki67</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">change_ki67</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">ccca_surgery_ki67_2_7</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">63</td>
<td style="text-align: left;">pos</td>
<td style="text-align: left;">Positive</td>
<td style="text-align: right;">16.60702</td>
<td style="text-align: right;">-69.958509</td>
<td style="text-align: left;">noCCCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">236</td>
<td style="text-align: left;">pos</td>
<td style="text-align: left;">Negative</td>
<td style="text-align: right;">11.30906</td>
<td style="text-align: right;">5.593711</td>
<td style="text-align: left;">noCCCA</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p><a href="#fig-pt63-236">Figure&nbsp;<span>4.13</span></a> shows the embedding of two distinct patients in a similar neighborhood.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pt63-236" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-pt63-236-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4.13: Plot of two selected patients in the molecular landscape. One is a responder and the other is a non responder. The patient id numbers are 63 and 236.</figcaption>
</figure>
</div>
</div>
</div>
<p>And now we calculate the average scores for each patient neighborhoods. We start by defining a radius value. After that we select the patients in the neighborhood and use <code>rstanarm</code> to get the posterior distribution of the average score in the neighborhood. For this we use the function <code>stan_glm</code> to calculate the average. This is effective because it can be paired with the package <code>tidybayes</code> for plotting. It makes extremely easy to deal with posterior data. For the average we use a normal prior centered at 0 with 1 standard deviation, since all scores are between -1 and 1.</p>
<p>Patient 63 <a href="trying.html#fig-pt63">Figure&nbsp;<span>6.8</span></a> is considered a responder. According to the scores, when comparing the estrogen early signature to its average distribution in the neighborhood, the score is higher.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pt63" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-pt63-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4.14: Posterior distribution of the average scores in the neighborhood of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.</figcaption>
</figure>
</div>
</div>
</div>
<p>Patient 236 <a href="trying.html#fig-pt236">Figure&nbsp;<span>6.9</span></a> was considered a non responder. According to the scores, when comparing the estrogen early signature to its average distribution in the neighborhood, the score is lower, being in the 5% quantile.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pt236" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-pt236-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;4.15: Posterior distribution of the average scores in the neighborhood of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.</figcaption>
</figure>
</div>
</div>
</div>
<p>When comparing these two patients, there is also a difference in the androgen response score, which could be a reflection of different estrogen signaling.</p>
<section id="matching-other-responders-and-non-responders" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="matching-other-responders-and-non-responders"><span class="header-section-number">4.4.1</span> Matching other responders and non-responders</h3>
<p>In this section we now match all the responders and non-responders in a close neighbourhood and try to do a similar analysis. We use a threshold of 0.5 for samples close enough, which corresponds to the 1% percentile.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-1654161fc1f6bc51338d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1654161fc1f6bc51338d">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38"],["treated_nb86_baseline","treated_nb94_baseline","treated_nb134_baseline","treated_nb137_baseline","treated_nb167_baseline","treated_nb184_baseline","treated_nb198_baseline","treated_nb200_baseline","treated_nb200_baseline","treated_nb202_baseline","treated_nb202_baseline","treated_nb203_baseline","treated_nb203_baseline","treated_nb207_baseline","treated_nb209_baseline","treated_nb211_baseline","treated_nb211_baseline","treated_nb215_baseline","treated_nb215_baseline","treated_nb216_baseline","treated_nb217_baseline","treated_nb222_baseline","treated_nb223_baseline","treated_nb223_baseline","treated_nb223_baseline","treated_nb223_baseline","treated_nb224_baseline","treated_nb224_baseline","treated_nb228_baseline","treated_nb228_baseline","treated_nb232_baseline","treated_nb235_baseline","treated_nb235_baseline","treated_nb236_baseline","treated_nb236_baseline","treated_nb239_baseline","treated_nb239_baseline","treated_nb239_baseline"],["treated_nb79_baseline","treated_nb73_baseline","treated_nb72_baseline","treated_nb71_baseline","treated_nb70_baseline","treated_nb75_baseline","treated_nb143_baseline","treated_nb65_baseline","treated_nb99_baseline","treated_nb89_baseline","treated_nb188_baseline","treated_nb93_baseline","treated_nb101_baseline","treated_nb138_baseline","treated_nb191_baseline","treated_nb182_baseline","treated_nb192_baseline","treated_nb130_baseline","treated_nb165_baseline","treated_nb153_baseline","treated_nb161_baseline","treated_nb96_baseline","treated_nb119_baseline","treated_nb124_baseline","treated_nb152_baseline","treated_nb195_baseline","treated_nb89_baseline","treated_nb188_baseline","treated_nb104_baseline","treated_nb131_baseline","treated_nb112_baseline","treated_nb130_baseline","treated_nb165_baseline","treated_nb91_baseline","treated_nb112_baseline","treated_nb95_baseline","treated_nb125_baseline","treated_nb188_baseline"],["responder","responder","responder","responder","responder","responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder"],["non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder"],[-97.31768650461021,-95.42323947722042,-85.38694661300489,-85.03297788541801,-76.95053807947021,-71.6866134751773,-59.6716448445172,-58.88178757867005,-58.88178757867005,-56.43948120942713,-56.43948120942713,-56.40401430842608,-56.40401430842608,-49.43113887924717,-45.24519000846118,-43.70239970351153,-43.70239970351153,-38.62228808085413,-38.62228808085413,-38.35915566184881,-36.93972179289025,-28.53010645945298,-27.21039571633799,-27.21039571633799,-27.21039571633799,-27.21039571633799,-26.58027704258757,-26.58027704258757,-10.82467532467533,-10.82467532467533,0.4291845493562363,5.143082744456131,5.143082744456131,5.593711367240657,5.593711367240657,23.77858906904325,23.77858906904325,23.77858906904325],[11.03070495277152,-36.47736204063163,-44.68763102725367,-48.08510638297872,-53.04169064573114,-24.58280187074829,-83.75212057772529,-66.52236652236653,-94.77899976156414,-96.22595760224712,-66.63798754506719,-95.428416686156,-94.5553734690357,-84.95029667873931,-64.7145307522666,-71.84033312729757,-64.52631156746349,-86.56780840991368,-77.88128756928361,-80.62568093385214,-78.2468317276149,-95.11545941890198,-89.02829476533827,-88.36552524080891,-80.62866781459746,-62.57182670779251,-96.22595760224712,-66.63798754506719,-92.99871609693467,-86.14917595585433,-92.22091684387982,-86.56780840991368,-77.88128756928361,-96.10901636891403,-92.22091684387982,-95.1308470867147,-87.65082491997045,-66.63798754506719],[47.79647435897436,68.68217054263566,12.58440761203192,21.52704135737009,16.94725028058361,21.91780821917808,9.894736842105264,23.35600907029479,23.35600907029479,13.03901437371663,13.03901437371663,10.54131054131054,10.54131054131054,20.43929225137279,15.98360655737705,49.6790757381258,49.6790757381258,29.50507614213198,29.50507614213198,21.99730094466937,39.70588235294117,24.83296213808463,13.16348195329087,13.16348195329087,13.16348195329087,13.16348195329087,8.801498127340825,8.801498127340825,9.932279909706546,9.932279909706546,16.66666666666666,40.94138543516873,40.94138543516873,11.30906274206042,11.30906274206042,17.48427672955975,17.48427672955975,17.48427672955975],[15.96931659693166,21.54942119323241,27.57352941176471,22.1311475409836,41.98331788693234,29.8932384341637,12.62773722627737,18.96551724137931,14.38561438561439,49.3116395494368,23.59081419624217,11.06623586429725,22.50825082508251,35.02304147465438,7.291666666666667,16.35859519408503,48.37013669821241,8.665906499429875,51.44444444444445,32.13367609254499,50.17064846416383,28.8058856819468,14.59074733096085,20.54616384915475,38.91156462585034,32.35724743777453,49.3116395494368,23.59081419624217,17.7650429799427,17.7639751552795,73.50590026646364,8.665906499429875,51.44444444444445,21.26514131897712,73.50590026646364,24.7191011235955,26.12163509471585,23.59081419624217]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>first_sample_name<\/th>\n      <th>second_sample_name<\/th>\n      <th>is_responder_first<\/th>\n      <th>is_responder_second<\/th>\n      <th>change_ki67_first<\/th>\n      <th>change_ki67_second<\/th>\n      <th>ki67_first<\/th>\n      <th>ki67_second<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[5,6,7,8]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In total there is number of 38 neighborhoods that we will analyse with a total of 56 unique samples, with a total of 32 responders and 24 non-responders, meaning that some responders they share non-responders.</p>
<p>By analysing the table below we get the following results. The way the table was obtained was by manually inspecting all the 38 neighrborhoods and checking in which the samples scores were below (b), in the average (m) and above average (a). The columns with the a, m and b letters represent the scores ER Early and SET ER/PR along with their respective positions.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-1c2f97f02d8b70596302" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1c2f97f02d8b70596302">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38"],["a","a","m","m","a","b","a","a","b","b","b","b","a","a","b","a","a","b","b","a","a","a","a","a","b","b","b","b","a","b","m","b","b","m","m","m","b","b"],["a","m","a","m","a","a","b","b","a","m","a","b","a","a","b","a","b","b","b","a","a","a","a","a","a","b","m","a","b","b","b","b","b","b","b","a","b","a"],["a","a","a","a","a","m","a","b","b","a","a","b","b","a","a","b","b","b","b","a","b","a","a","a","a","a","b","b","a","a","a","a","a","b","b","b","b","b"],["b","b","b","b","b","a","a","b","b","a","a","b","b","a","a","a","a","b","b","a","m","a","b","b","b","b","b","b","b","b","a","m","m","a","a","b","b","b"],["m","a","b","b","b","b","a","a","a","b","a","b","a","a","b","m","b","m","b","a","a","a","m","m","b","b","b","a","b","b","m","m","b","a","m","m","b","a"],["b","m","a","b","b","b","m","b","b","b","b","b","b","m","a","a","a","a","a","a","b","b","a","a","a","a","b","b","a","a","a","a","a","a","a","m","m","m"],["","","good reduction in ki67 for non-responder and even higher baseline","","good reduction in ki67 for non-responder","","The non-responder is actually a responder, with change in ki67 as 59.67, a rounding error.","good reduction in ki67 for non-responder as well, almost 60%","","High Ki67 levels for the responder, almost 50%","Non-responder is almost a reponder with 56% of change","","","","Very low ki67 levels for responder","","Very low Ki67 levels for responder","super high Ki67 levels for responder and very low SET ER/PR","","","","","","","ER early is close to average for responder but SET ER/PR is far away from non-responder","","","","Again non-responder is very far away from average","","Responder had a very high Ki67 and high change but low ER score surprisingly","","","","","","",""],["no","no","no","no","no","yes","yes","yes","yes","no","yes","no","no","no","no","no","yes","no","no","no","no","no","no","no","yes","no","no","yes","yes","no","no","no","no","no","no","no","no","yes"],["yes","yes","yes","yes","yes","no","no","no","no","no","no","no","no","no","no","yes","yes","no","no","no","no","no","yes","yes","yes","yes","no","no","yes","yes","no","no","no","yes","yes","no","no","no"],["yes","yes","no","no","yes","no","yes","no","yes","no","no","yes","no","yes","no","no","no","yes","yes","yes","no","yes","yes","yes","no","no","yes","yes","yes","no","no","no","no","no","no","no","yes","yes"],["no","no","no","no","no","yes","no","yes","no","no","yes","yes","no","yes","no","yes","no","yes","yes","yes","no","yes","no","no","no","yes","no","no","yes","yes","no","no","no","no","no","no","yes","no"],["treated_nb86_baseline","treated_nb94_baseline","treated_nb134_baseline","treated_nb137_baseline","treated_nb167_baseline","treated_nb184_baseline","treated_nb198_baseline","treated_nb200_baseline","treated_nb200_baseline","treated_nb202_baseline","treated_nb202_baseline","treated_nb203_baseline","treated_nb203_baseline","treated_nb207_baseline","treated_nb209_baseline","treated_nb211_baseline","treated_nb211_baseline","treated_nb215_baseline","treated_nb215_baseline","treated_nb216_baseline","treated_nb217_baseline","treated_nb222_baseline","treated_nb223_baseline","treated_nb223_baseline","treated_nb223_baseline","treated_nb223_baseline","treated_nb224_baseline","treated_nb224_baseline","treated_nb228_baseline","treated_nb228_baseline","treated_nb232_baseline","treated_nb235_baseline","treated_nb235_baseline","treated_nb236_baseline","treated_nb236_baseline","treated_nb239_baseline","treated_nb239_baseline","treated_nb239_baseline"],["treated_nb79_baseline","treated_nb73_baseline","treated_nb72_baseline","treated_nb71_baseline","treated_nb70_baseline","treated_nb75_baseline","treated_nb143_baseline","treated_nb65_baseline","treated_nb99_baseline","treated_nb89_baseline","treated_nb188_baseline","treated_nb93_baseline","treated_nb101_baseline","treated_nb138_baseline","treated_nb191_baseline","treated_nb182_baseline","treated_nb192_baseline","treated_nb130_baseline","treated_nb165_baseline","treated_nb153_baseline","treated_nb161_baseline","treated_nb96_baseline","treated_nb119_baseline","treated_nb124_baseline","treated_nb152_baseline","treated_nb195_baseline","treated_nb89_baseline","treated_nb188_baseline","treated_nb104_baseline","treated_nb131_baseline","treated_nb112_baseline","treated_nb130_baseline","treated_nb165_baseline","treated_nb91_baseline","treated_nb112_baseline","treated_nb95_baseline","treated_nb125_baseline","treated_nb188_baseline"],["responder","responder","responder","responder","responder","responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","non_responder"],["non_responder","non_responder","non_responder","non_responder","non_responder","non_responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder","responder"],[-97.31768650461021,-95.42323947722042,-85.38694661300489,-85.03297788541801,-76.95053807947021,-71.6866134751773,-59.6716448445172,-58.88178757867005,-58.88178757867005,-56.43948120942713,-56.43948120942713,-56.40401430842608,-56.40401430842608,-49.43113887924717,-45.24519000846118,-43.70239970351153,-43.70239970351153,-38.62228808085413,-38.62228808085413,-38.35915566184881,-36.93972179289025,-28.53010645945298,-27.21039571633799,-27.21039571633799,-27.21039571633799,-27.21039571633799,-26.58027704258757,-26.58027704258757,-10.82467532467533,-10.82467532467533,0.4291845493562363,5.143082744456131,5.143082744456131,5.593711367240657,5.593711367240657,23.77858906904325,23.77858906904325,23.77858906904325],[11.03070495277152,-36.47736204063163,-44.68763102725367,-48.08510638297872,-53.04169064573114,-24.58280187074829,-83.75212057772529,-66.52236652236653,-94.77899976156414,-96.22595760224712,-66.63798754506719,-95.428416686156,-94.5553734690357,-84.95029667873931,-64.7145307522666,-71.84033312729757,-64.52631156746349,-86.56780840991368,-77.88128756928361,-80.62568093385214,-78.2468317276149,-95.11545941890198,-89.02829476533827,-88.36552524080891,-80.62866781459746,-62.57182670779251,-96.22595760224712,-66.63798754506719,-92.99871609693467,-86.14917595585433,-92.22091684387982,-86.56780840991368,-77.88128756928361,-96.10901636891403,-92.22091684387982,-95.1308470867147,-87.65082491997045,-66.63798754506719],[47.79647435897436,68.68217054263566,12.58440761203192,21.52704135737009,16.94725028058361,21.91780821917808,9.894736842105264,23.35600907029479,23.35600907029479,13.03901437371663,13.03901437371663,10.54131054131054,10.54131054131054,20.43929225137279,15.98360655737705,49.6790757381258,49.6790757381258,29.50507614213198,29.50507614213198,21.99730094466937,39.70588235294117,24.83296213808463,13.16348195329087,13.16348195329087,13.16348195329087,13.16348195329087,8.801498127340825,8.801498127340825,9.932279909706546,9.932279909706546,16.66666666666666,40.94138543516873,40.94138543516873,11.30906274206042,11.30906274206042,17.48427672955975,17.48427672955975,17.48427672955975],[15.96931659693166,21.54942119323241,27.57352941176471,22.1311475409836,41.98331788693234,29.8932384341637,12.62773722627737,18.96551724137931,14.38561438561439,49.3116395494368,23.59081419624217,11.06623586429725,22.50825082508251,35.02304147465438,7.291666666666667,16.35859519408503,48.37013669821241,8.665906499429875,51.44444444444445,32.13367609254499,50.17064846416383,28.8058856819468,14.59074733096085,20.54616384915475,38.91156462585034,32.35724743777453,49.3116395494368,23.59081419624217,17.7650429799427,17.7639751552795,73.50590026646364,8.665906499429875,51.44444444444445,21.26514131897712,73.50590026646364,24.7191011235955,26.12163509471585,23.59081419624217],["no","no","no","no","no","no","no","yes","no","no","no","no","yes","no","no","yes","yes","no","no","no","yes","no","no","no","no","no","no","no","no","no","no","no","no","yes","yes","yes","no","no"],["yes","yes","yes","yes","yes","no","no","no","yes","no","no","no","yes","no","no","no","no","no","no","no","no","no","yes","yes","yes","no","yes","yes","no","no","no","no","no","no","no","yes","no","yes"],["no","no","no","no","no","yes","no","no","no","yes","yes","no","no","no","yes","no","no","no","no","no","no","no","no","no","yes","yes","no","no","no","yes","no","yes","yes","no","no","no","no","no"],["no","no","no","no","no","no","yes","no","no","no","no","no","no","no","yes","no","yes","no","no","no","no","no","no","no","no","no","no","no","no","no","yes","yes","yes","yes","yes","no","no","no"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>responder_er_early<\/th>\n      <th>responder_set_erpr<\/th>\n      <th>non_responder_er_early<\/th>\n      <th>non_responder_set_erpr<\/th>\n      <th>responder_androgen<\/th>\n      <th>non_responder_androgen<\/th>\n      <th>comments<\/th>\n      <th>mismatch_er_responder<\/th>\n      <th>mismatch_er_non_responder<\/th>\n      <th>both_same_direction_er_early<\/th>\n      <th>both_same_direction_set_erpr<\/th>\n      <th>first_sample_name<\/th>\n      <th>second_sample_name<\/th>\n      <th>is_responder_first<\/th>\n      <th>is_responder_second<\/th>\n      <th>change_ki67_first<\/th>\n      <th>change_ki67_second<\/th>\n      <th>ki67_first<\/th>\n      <th>ki67_second<\/th>\n      <th>er_early_above_responder<\/th>\n      <th>set_erpr_above_responder<\/th>\n      <th>er_early_above_non_responder<\/th>\n      <th>set_erpr_above_non_responder<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[16,17,18,19]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In out of the 38 neighborhoods, there are 8 where the responders are at average or above estrogen response early and non responders are below. The total number of unique non-responders is 6. On the other hand, there are 9 neighborhoods with 6 unique non-responders that have higher scores than average and in which 8 non-responders have scores below average.</p>
<p>The number increases to 14 when we consider SET ER/PR and out of the 14 neighborhoods, there are 10 unique samples from non-responders.</p>
<p>On the other hand there are 8 neighborhoods which have non responders with SET ER/PR higher than average and responders with scores below average. Out of these 8 neighborhoods, the number of unique non-responders are 6. In total, there are 10 non-responders that are below average, 6 that are above average and the remaining 8 have similar direction as the responders.</p>
<p>These results suggest that SET ER/PR might be a better signature to compare in the neighborhoods.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> non_responder_androgen  n   percent
                      a 15 0.5555556
                      b  7 0.2592593
                      m  5 0.1851852</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> responder_androgen n   percent
                  a 3 0.2727273
                  b 4 0.3636364
                  m 4 0.3636364</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's Chi-squared test with simulated p-value (based on 2000
    replicates)

data:  data.frame(non_responder = non_responder_androgen_counts[, 2],     responder = responder_androgen_counts[, 2])
X-squared = 2.6649, df = NA, p-value = 0.2954</code></pre>
</div>
</div>
</section>
<section id="analysing-all-patients" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="analysing-all-patients"><span class="header-section-number">4.4.2</span> Analysing all patients</h3>
<p>We now try to extend this comparison to something more systematic. Instead of looking just for these two patients we will compare the neighborhoods for the top responders and non-responder patients. The first thing we have to have in mind is that some non responders they did respond to the drug, just the reduction in Ki67 was not so big. For example patient 209 has a reduction of 40% in Ki67 going from 16% to 9%. Still this patient is considered a non-responder.</p>
<p>We donâ€™t select all patients for the comparisons. We select only patients that are at least in the HER2 enriched region to the right, so we exclude the basal like patients. The reason for this as well is because they all either have low Estrogen response early scores or low SET ER/PR.</p>
<div class="cell">
<div class="cell-output-display">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">HALLMARK_ESTROGEN_RESPONSE_EARLY</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">SET_ERPR</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">PC3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">treated_nb69_baseline</td>
<td style="text-align: left;">-0.265</td>
<td style="text-align: left;">-0.50</td>
<td style="text-align: left;">-4.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">treated_nb76_baseline</td>
<td style="text-align: left;">-0.275</td>
<td style="text-align: left;">-0.19</td>
<td style="text-align: left;">-4.1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">treated_nb80_baseline</td>
<td style="text-align: left;">-0.013</td>
<td style="text-align: left;">-0.49</td>
<td style="text-align: left;">-5.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">treated_nb229_baseline</td>
<td style="text-align: left;">-0.234</td>
<td style="text-align: left;">-0.54</td>
<td style="text-align: left;">-4.7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">treated_nb230_baseline</td>
<td style="text-align: left;">-0.308</td>
<td style="text-align: left;">-0.50</td>
<td style="text-align: left;">-7.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">treated_nb237_baseline</td>
<td style="text-align: left;">-0.377</td>
<td style="text-align: left;">-0.29</td>
<td style="text-align: left;">-7.9</td>
</tr>
</tbody>
</table>


</div>
</div>
<section id="non-responders" class="level4" data-number="4.4.2.1">
<h4 data-number="4.4.2.1" class="anchored" data-anchor-id="non-responders"><span class="header-section-number">4.4.2.1</span> Non-responders</h4>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Estrogen score still close to 0, high proliferation at baseline and higher androgen score. But in this case SET ER/PR is lower than average. There is a mismatch.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>This patient has a score close to 0 still but low proliferation in general. This is a case where the EMT signaling is really at average and TGFb is super low. Again SET ER/PR is much lower, mismatch with ER signaling.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Estrogen signaling close to 0, high androgen and E2F targets and high EMT. Intriguing patient, both ER and SET ER/PR are going in the same direction and above average.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Low ER signaling and super high EMT with an increase P53 pathway expression. Super low ER signaling here in terms of SET ER/PR.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Low ER score, even lower than average and low EMT signaling. Average E2F targets and lower than average for SET ER/PR.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>This case is a bit different, the ER signaling is higher, E2F targets at baseline is not so high, even lower than the average, but in this case androgen response is much higher and EMT is extremely high. There is a relative mismatch between ER early and SET ER/PR. SET ER/PR is relatively small and close to the average.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Androgen score lower than the average and high E2F targets at baseline. In this case we see a very small EMT signature. In this case there is again a mismatch between ER signaling and SET ER/PR.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>This one has a low ER signaling as well and higher E2F targets score. Massive difference in SET ER/PR here when comparing to the average.</p>
<p>In general all these non responders with no change in Ki67 had a low ER signaling score or a mismatch between ER early and SET ER/PR</p>
</section>
<section id="top-responders" class="level4" data-number="4.4.2.2">
<h4 data-number="4.4.2.2" class="anchored" data-anchor-id="top-responders"><span class="header-section-number">4.4.2.2</span> Top responders</h4>
<p>We now investigate the top responders with the biggest decrease in Ki67.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>First thing is that this patient had already a positive score and a very low Androgen signaling score. Moreover the Ki67 is low. This is one of the furthest patients to the right and still has a low ER signaling score.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>A bit high E2F targets but higher than average of the estrogen signaling score. High SET ER/PR.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Here the ER signaling is above average and androgen response is similar to the average. E2F targets is high. Also super high SET ER/PR.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Very low E2F targets and low Androgen response. ER is about the average. SET ER/PR is still positive. This sample is in the luminal A region also.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>In this case ER signaling is also above average and E2F targets is similar to the average of neighbors. SET ER/PR on average and in the expected direction.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>This one is intriguing, ER signaling is extremely low, E2F targets is very low as well but the patient responded pretty well. But there is a big mismatch between Ki67 and transcriptomics for this patient. Further investigation should be performed. Actually probably the samples have mixed names. Below are the values of the pathways after treatment:</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-221b6fade5c7c9e54b39" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-221b6fade5c7c9e54b39">{"x":{"filter":"none","vertical":false,"data":[["treated_nb89_baseline","treated_nb89_surgery"],[49.3116395494368,1.861042183622829],[-0.556062047578453,0.3838614791520841],[0.05702999599230771,0.279317135063836],[-0.3243439029943877,-0.1749994827902819],[0.737080017429381,0.04095668109262285],[-2.03855921324292,1.881224967279456]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>ki67<\/th>\n      <th>HALLMARK_E2F_TARGETS<\/th>\n      <th>SET_ERPR<\/th>\n      <th>HALLMARK_ESTROGEN_RESPONSE_EARLY<\/th>\n      <th>PC3<\/th>\n      <th>PC4<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>It looks super weird that there is a big increase in proliferation based on the transcriptomic data considering the reduction in the Ki67 percentage. Not only that, ER signaling increases. It is very likely that the sample has a mixed label.</p>
<p>Moving to the next one.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>This one also is intriguing, estrogen signaling is very low but the patient is a responder with a good decrease in Ki67. Below is a table with the values for surgery and baseline. We see that there is indeed a decrease in proliferation and also in estrogen signaling. Also this sample is closer to the normal like and luminal A region.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-cc993bfc39c30cf60af2" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-cc993bfc39c30cf60af2">{"x":{"filter":"none","vertical":false,"data":[["treated_nb90_baseline","treated_nb90_surgery"],[0.4062863196128002,2.491538647594793],[-3.028366761734366,-2.060701538233106],[-0.3247598890648363,-0.2188959734288057],[0.06425367442921755,-0.3789363819351155],[29.37181663837012,1.111111111111111]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>PC3<\/th>\n      <th>PC4<\/th>\n      <th>HALLMARK_ESTROGEN_RESPONSE_EARLY<\/th>\n      <th>HALLMARK_E2F_TARGETS<\/th>\n      <th>ki67<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>And last patient.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>This patient has a score slightly higher than the average, but still negative. Nonetheless, the patient responded well to the therapy. One note is that this patient is close to the HER2 enriched region.</p>
<p>In general non responders had more mismatches between SET ER/PR and below average values than responders.</p>
</section>
<section id="responders-in-the-middle-of-embedding" class="level4" data-number="4.4.2.3">
<h4 data-number="4.4.2.3" class="anchored" data-anchor-id="responders-in-the-middle-of-embedding"><span class="header-section-number">4.4.2.3</span> Responders in the middle of embedding</h4>
<p>We lastly check the responders that are in the middle of the molecular landscape to see how they are.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Low ER signaling in both cases. This patient specifically had very high Ki67 levels at baseline.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Also ER signaling is low here compared to the average, but a very low Ki67 proliferation index at baseline.</p>
</section>
<section id="conclusion" class="level4" data-number="4.4.2.4">
<h4 data-number="4.4.2.4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4.4.2.4</span> Conclusion</h4>
<p>In general what we can see is that when comparing responders and non responders the main difference is in the position of the molecular landscape. If we select the top responders and the top non-responders in terms of decrease in Ki67 levels, we see that non responders have way lower third principal component (<a href="#fig-high-respnon">Figure&nbsp;<span>4.16</span></a>).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-high-respnon" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="scoring_files/figure-html/fig-high-respnon-1.png" class="img-fluid figure-img" width="576"></p>
<figcaption class="figure-caption">Figure&nbsp;4.16: PC3 comparison of the top non responders and responders</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="predicting-response-to-endocrine-therapy" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="predicting-response-to-endocrine-therapy"><span class="header-section-number">4.5</span> Predicting response to endocrine therapy</h2>
<p>We now try to use a penalized logistic regression to predict patient response, as defined by the POETIC trialists using the principal components. For this we already saw that in average the patients further to the left are non-responders and further to the right would be responders, suggesting a predictive power of the molecular landscape. The landscape still is not perfect as there is a lot of overlap between the responders and non-responders. So we try to use more principal components to capture the differences.</p>
<p>Just when randomizing the train test split, we need to make sure that we include some of the samples that are in the basal like region in both splits, since they are in small numbers. Due to the small sample size, we use the components starting from 3 and going up to 20.</p>
<p>In this dataset the total of responders vs non responder is:</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-cfb9efed4da7622f3ea7" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-cfb9efed4da7622f3ea7">{"x":{"filter":"none","vertical":false,"data":[["1","2"],["non_responder","responder"],[43,94],[0.3138686131386861,0.6861313868613139]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>is_responder<\/th>\n      <th>n<\/th>\n      <th>percent<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
</div>
<p>More than 2/3 are responders. Using a set seed for the randomization, the numbers of responders and non responders are shown below for the training set.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-093b57fee0c1a7d243d8" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-093b57fee0c1a7d243d8">{"x":{"filter":"none","vertical":false,"data":[["1","2"],["non_responder","responder"],[28,63],[0.3076923076923077,0.6923076923076923]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>is_responder<\/th>\n      <th>n<\/th>\n      <th>percent<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
</div>
<p>And for the test set.</p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-2dfac9ebe77c552454fb" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2dfac9ebe77c552454fb">{"x":{"filter":"none","vertical":false,"data":[["1","2"],["non_responder","responder"],[15,31],[0.3260869565217391,0.6739130434782609]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>is_responder<\/th>\n      <th>n<\/th>\n      <th>percent<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 0, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":["options.columnDefs.0.render"],"jsHooks":[]}</script>
</div>
</div>
<p>And we compare the PC3 values distributions to see if they are equally distributed.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>They are similarly distributed, so we can proceed with the training and testing strategy.</p>
<p>The plot below shows the misclassification error versus the lambda used for the penalization term in the logistic regression.</p>
<p>The plot below shows the misclassification error for different <span class="math inline">\(\lambda\)</span> values and number of components.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="scoring_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Overall the misclassification is pretty similar for all number of variables. We select the variables obtained with the lambda that is 1 SE away from the minimum. So in total we have three variables: The intercept and PC3, PC10, PC20.</p>
<p>And below we show the confusion matrix.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>         True
Predicted  0  1 Total
    0      1  3     4
    1     14 28    42
    Total 15 31    46

 Percent Correct:  0.6304 </code></pre>
</div>
</div>
<p>We see that the accuracy is very low and most of the patients are classified as responders. This could be potentially due to the class imbalance, but the results are still underwhelming.</p>
<p>Let us take a look on the patients that were predicted to be non responders and check their Ki67 differences in baseline and surgery.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>                             PC3 change_ki67     ki67
treated_nb64_baseline  -2.733038   -66.53449 44.46653
treated_nb80_baseline  -5.649423    26.83238 43.24122
treated_nb129_baseline -3.468263   -86.59865 21.55340
treated_nb147_baseline -3.421153   -81.93744 42.51592</code></pre>
</div>
</div>
<p>All the patients that were misclassified as non responders they have a very low third principal component and their baseline Ki67 is quite high, so the decrease in proliferation is not actually big enough. It is still considered a responder.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Gao2019" class="csl-entry" role="listitem">
Gao, Qiong, and Elena LÃ³pez-Knowles, Maggie Chon U. Cheang, James Morden, Ricardo Ribas, Kally Sidhu, David Evans, et al. 2019. <span>â€œImpact of Aromatase Inhibitor Treatment on Global Gene Expression and Its Association with Antiproliferative Response in <span>ER</span><span class="math inline">\(\mathplus\)</span> Breast Cancer in Postmenopausal Patients.â€</span> <em>Breast Cancer Research</em> 22 (1). <a href="https://doi.org/10.1186/s13058-019-1223-z">https://doi.org/10.1186/s13058-019-1223-z</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./validation.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./risk_score.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk score model</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb8" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Pathway activity in a personalized context</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>This chapter we present a new way to think about the personalized medicine,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>by incorporating patient molecular information and its context. </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>We saw previously that by using different cohorts, we can embed new patients</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>into a point cloud. The idea is that the neighborhood of the patients </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>are similar in the molecular level, and we can draw conclusions based on</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>this. </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>Each patient can be assigned a score. Scores represent a biological</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>pathway, or in other words, a biological activity. Given a biological</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>process, there is usually a set of genes that represent it. We</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>can then use these set of genes to calculate scores that are </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>proxies of this biological activity.</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>For example, in the previous chapters we used the ER signaling</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>scores to motivate the continuity of ER signaling. This is not</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>restricted to this specific pathway, we could have used any</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>other list of genes representing a process. </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>By combining a score and the neighborhood of a patient, we </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>can make direct comparisons and questions. Given a patient,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>how different is its score for a pathway compared to its</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>neighbors? Is there also an alternative pathway that could</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>be target and has a higher signaling? In this case </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>specifically, is ER signaling more or less expressed compared</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>to its neighbors? </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>The POETIC trial <span class="co">[</span><span class="ot">@Gao2019</span><span class="co">]</span> </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>is a breast cancer trial that had as hypothesis</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>neoadjuvant therapy could improve overall and recurrence free</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>survival. They gave aromatase inhibitors (AIs) for ER+ BC patients</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>for 2 weeks prior to surgery and then 2 weeks after surgery.</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>Moreover, they collected a needle biopsy before the</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>treatment started and a biopsy in the surgery. They</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>also measured the Ki67 levels, therefore we have a proxy</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>on how well these patients responded in the short term to </span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>AIs. Also, they sent the tissues for sequencing, so </span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>microarray data is available. This is a unique </span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>cohort, in the sense that we can understand what are the</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>responders or not, in terms of Ki67 levels, and use</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>the molecular data to try to understand the responsiveness. </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>The definition of responders are those patients that have a </span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>reduction of at least 60\%</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>in Ki67 levels when comparing pre-treatment versus surgery. </span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>Here we use this cohort to draw conclusions on responders</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>and non responders and how the molecular landscape can be </span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>used. We show that some patients that are close to each</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>other in the molecular landscape can have different</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>pathway scores and therefore have different responses.</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>()</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCAtools)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GSVA)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SummarizedExperiment)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utils.R"</span>)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"first_run.R"</span>)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we are using rds files from previous chapters, so we source</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="co"># in any case the load_rds_files.R and exclude all the associated files</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="co"># that are generated in this current chapter</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (first_run){</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>    load_at_setup <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    load_at_setup <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>name_document <span class="ot">&lt;-</span> <span class="st">"scoring"</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"load_rds_files.R"</span>)</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="co"># by setting the dev to png and pdf, this saves the figures in a specific</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="co"># folder in both formats. moreover, since png is coming first, it shows</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="co"># this figure when rendering the html. What is nice about this is that it</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co"># inherits the properties from the chunk to save the figure, so no need</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="co"># to use ggplot2::ggsave to save the plots. this also works </span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="fu">c</span>(<span class="st">'png'</span>, <span class="st">'pdf'</span>))</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">bitmapType =</span> <span class="st">'cairo'</span>)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a><span class="fu">## Calculating scores in neighborhoods</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>Patients close to each other in the molecular landscape are somewhat</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>molecularly close, due to how the embedding works. Therefore, we can </span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>look at patients in a neighborhood and calculate the average scores,</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>to see what it means to be in a specific neighborhood. </span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>To do this, we define a radius for a patient where all the patients</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>within the euclidean ball with this radius will be selected and an </span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>average score distribution is calculated.</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>To calculate the average score distribution we use the <span class="in">`rstanarm`</span> package. </span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>We set the prior distribution for the intercept to be a normal distribution</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>centered at 0 with standard deviation of 1. All scores are in a range of</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>-1 to 1, so this is a relatively flat prior for our use case.</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>The video below shows how scores change in average when comparing different</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>neighborhoods. </span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>scores_to_use <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estrogen response early"</span>,</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"E2F targets"</span>,</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"P53 pathway"</span>,</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EMT"</span>,</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Androgen response"</span>,</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TGFb signaling"</span>,</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET ER/PR"</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">c</span>(</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_E2F_TARGETS"</span>,</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_P53_PATHWAY"</span>,</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION"</span>,</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ANDROGEN_RESPONSE"</span>,</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_TGF_BETA_SIGNALING"</span>,</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>df_pca <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>        pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"normal"</span>, <span class="st">"luma"</span>, <span class="st">"lumb"</span>, <span class="st">"basal"</span>, <span class="st">"her2"</span>)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.[, <span class="st">"sample_name"</span>])</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a><span class="co"># we first get random samples from the path determined below</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>pc3_values <span class="ot">&lt;-</span> <span class="fl">2.5</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>pc4_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">4</span>, <span class="at">to =</span> <span class="dv">4</span>, <span class="at">length.out =</span> <span class="dv">20</span>)</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>pca_values <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PC3 =</span> pc3_values, <span class="at">PC4 =</span> pc4_values) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>samples_top_down <span class="ot">&lt;-</span> <span class="fu">apply</span>(pca_values, <span class="dv">1</span>, get_closest_sample, <span class="at">df_pca =</span> df_pca)</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>pc3_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="fl">8.5</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">20</span>)</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>pc4_values <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>pca_values <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">PC3 =</span> pc3_values, <span class="at">PC4 =</span> pc4_values) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>samples_left_right <span class="ot">&lt;-</span> <span class="fu">apply</span>(pca_values, <span class="dv">1</span>, get_closest_sample, <span class="at">df_pca =</span> df_pca)</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>all_samples <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_down =</span> samples_top_down,</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">left_right =</span> <span class="fu">rev</span>(samples_left_right)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>pca_values <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>    all_samples, </span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, df_pca){</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>        df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(PC3, PC4) <span class="sc">%&gt;%</span></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>            as.matrix <span class="sc">%&gt;%</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>            .[x, ]</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> df_pca</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>scores_for_movie <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>        pca_value, </span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>        which_direction, </span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>        df_pca, </span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>        scores_to_use,</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>        radius,</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>        base_size</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(</span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rownames</span>(pca_value), </span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>            get_patient_scores_distributions,</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>            <span class="at">df_pca =</span> df_pca,</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>            <span class="at">scores_to_use =</span> scores_to_use,</span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>            <span class="at">which_direction =</span> which_direction,</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>            <span class="at">radius =</span> radius,</span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>            <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_value =</span> pca_values,</span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_direction =</span> <span class="fu">names</span>(pca_values),</span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>        <span class="at">df_pca =</span> df_pca, </span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores_to_use =</span> scores_to_use,</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a>        <span class="at">radius =</span> <span class="dv">1</span></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>plots_scores_for_movie <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(</span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>        avg_rstan_samples, </span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>        which_direction,</span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(</span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>            avg_rstan_samples, </span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>            get_plot_patient_distribution,</span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>            <span class="at">which_direction =</span> which_direction,</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>            ...,</span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a>            <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_rstan_samples =</span> scores_for_movie,</span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_direction =</span> <span class="fu">names</span>(scores_for_movie),</span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(</span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>        <span class="at">scores_to_use =</span> scores_to_use,</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_size =</span> <span class="dv">15</span>,</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>        <span class="at">size_dots =</span> <span class="dv">3</span></span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span></span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a>plots_molecular_landscape <span class="ot">&lt;-</span> <span class="fu">plot_selected_samples</span>(</span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a>    df_pca,</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a>    pca_values,</span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_plots_movie =</span> plots_scores_for_movie,</span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_line =</span> <span class="fl">0.5</span>,</span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a>    <span class="at">radius =</span> <span class="dv">1</span>,</span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_points =</span> <span class="dv">3</span>,</span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">title_plot =</span> <span class="st">"Molecular landscape"</span></span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>plots_estimates_tog <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(plot1, plot2){</span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>        cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(plot1, plot2, <span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot1 =</span> plots_scores_for_movie<span class="sc">$</span>top_down,</span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot2 =</span> plots_scores_for_movie<span class="sc">$</span>left_right,</span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>final_plots <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(plots_estimates_tog),</span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i) {</span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a>        cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a>            plots_molecular_landscape[[i]],</span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a>            plots_estimates_tog[[i]], </span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a>            <span class="at">ncol =</span> <span class="dv">2</span>, </span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a>            <span class="at">rel_widths =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="dv">1</span>)</span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a>folder_to_save <span class="ot">&lt;-</span> <span class="st">"../results/plots/scoring/movie"</span></span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(</span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a>    folder_to_save, </span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a>fig_width <span class="ot">&lt;-</span> <span class="dv">22</span></span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a>fig_height <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-260"><a href="#cb8-260" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb8-261"><a href="#cb8-261" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(final_plots),</span>
<span id="cb8-262"><a href="#cb8-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i, final_plots){</span>
<span id="cb8-263"><a href="#cb8-263" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(</span>
<span id="cb8-264"><a href="#cb8-264" aria-hidden="true" tabindex="-1"></a>            <span class="at">filename =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-265"><a href="#cb8-265" aria-hidden="true" tabindex="-1"></a>                folder_to_save, </span>
<span id="cb8-266"><a href="#cb8-266" aria-hidden="true" tabindex="-1"></a>                <span class="st">"/"</span>, </span>
<span id="cb8-267"><a href="#cb8-267" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ifelse</span>(i <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="fu">paste0</span>(<span class="st">"0"</span>,i), i), <span class="st">".png"</span></span>
<span id="cb8-268"><a href="#cb8-268" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-269"><a href="#cb8-269" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot =</span> final_plots[[i]],</span>
<span id="cb8-270"><a href="#cb8-270" aria-hidden="true" tabindex="-1"></a>            <span class="at">width =</span> fig_width,</span>
<span id="cb8-271"><a href="#cb8-271" aria-hidden="true" tabindex="-1"></a>            <span class="at">height =</span> fig_height, </span>
<span id="cb8-272"><a href="#cb8-272" aria-hidden="true" tabindex="-1"></a>            <span class="at">dpi =</span> <span class="dv">320</span></span>
<span id="cb8-273"><a href="#cb8-273" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-274"><a href="#cb8-274" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-275"><a href="#cb8-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_plots =</span> final_plots</span>
<span id="cb8-276"><a href="#cb8-276" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-277"><a href="#cb8-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-278"><a href="#cb8-278" aria-hidden="true" tabindex="-1"></a><span class="co"># the original command used in the command line is the one below:</span></span>
<span id="cb8-279"><a href="#cb8-279" aria-hidden="true" tabindex="-1"></a><span class="co"># ffmpeg -y -framerate 2 -pattern_type glob -i 'movie/*.png' mol_land.mp4</span></span>
<span id="cb8-280"><a href="#cb8-280" aria-hidden="true" tabindex="-1"></a><span class="co"># we can then call it directly from R instead of having to do it manually</span></span>
<span id="cb8-281"><a href="#cb8-281" aria-hidden="true" tabindex="-1"></a><span class="co"># after rendering the document</span></span>
<span id="cb8-282"><a href="#cb8-282" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(</span>
<span id="cb8-283"><a href="#cb8-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(</span>
<span id="cb8-284"><a href="#cb8-284" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ffmpeg -y -framerate 2 -pattern_type glob -i '"</span>,</span>
<span id="cb8-285"><a href="#cb8-285" aria-hidden="true" tabindex="-1"></a>        folder_to_save, <span class="st">"/*.png' "</span>, </span>
<span id="cb8-286"><a href="#cb8-286" aria-hidden="true" tabindex="-1"></a>        folder_to_save, <span class="st">"/../mol_land.mp4"</span></span>
<span id="cb8-287"><a href="#cb8-287" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-288"><a href="#cb8-288" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-289"><a href="#cb8-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-290"><a href="#cb8-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-291"><a href="#cb8-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = !first_run, results = 'asis', echo = FALSE}</span></span>
<span id="cb8-292"><a href="#cb8-292" aria-hidden="true" tabindex="-1"></a>embedding_video <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb8-293"><a href="#cb8-293" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;iframe width="720" height="480" '</span>,</span>
<span id="cb8-294"><a href="#cb8-294" aria-hidden="true" tabindex="-1"></a>    <span class="st">'src="../plots/scoring/mol_land.mp4" align="middle"'</span>,</span>
<span id="cb8-295"><a href="#cb8-295" aria-hidden="true" tabindex="-1"></a>    <span class="st">'frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;'</span></span>
<span id="cb8-296"><a href="#cb8-296" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-297"><a href="#cb8-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-298"><a href="#cb8-298" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(embedding_video)</span>
<span id="cb8-299"><a href="#cb8-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-300"><a href="#cb8-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-301"><a href="#cb8-301" aria-hidden="true" tabindex="-1"></a>Going from right to left it shows how ER signaling is decreased. From top to</span>
<span id="cb8-302"><a href="#cb8-302" aria-hidden="true" tabindex="-1"></a>bottom there is a reduction of proliferation, E2F targets, and a change in</span>
<span id="cb8-303"><a href="#cb8-303" aria-hidden="true" tabindex="-1"></a>EMT and TGFb signaling. These are representative scores, other pathways could</span>
<span id="cb8-304"><a href="#cb8-304" aria-hidden="true" tabindex="-1"></a>be used as well. </span>
<span id="cb8-305"><a href="#cb8-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-306"><a href="#cb8-306" aria-hidden="true" tabindex="-1"></a><span class="fu">## POETIC embedding</span></span>
<span id="cb8-307"><a href="#cb8-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-308"><a href="#cb8-308" aria-hidden="true" tabindex="-1"></a>In this section we show the embedding of the POETIC trial samples.</span>
<span id="cb8-309"><a href="#cb8-309" aria-hidden="true" tabindex="-1"></a>But first we analyse some basic properties of the dataset.</span>
<span id="cb8-310"><a href="#cb8-310" aria-hidden="true" tabindex="-1"></a>The data for this dataset was downloaded and processed</span>
<span id="cb8-311"><a href="#cb8-311" aria-hidden="true" tabindex="-1"></a>as described at </span>
<span id="cb8-312"><a href="#cb8-312" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">chronchi.github.io/transcriptomics</span><span class="co">](https://chronchi.github.io/transcriptomics/)</span></span>
<span id="cb8-313"><a href="#cb8-313" aria-hidden="true" tabindex="-1"></a>in the chapter AI - GSE105777. </span>
<span id="cb8-314"><a href="#cb8-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-315"><a href="#cb8-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb8-316"><a href="#cb8-316" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb8-317"><a href="#cb8-317" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/datasets_with_scores.rds"</span></span>
<span id="cb8-318"><a href="#cb8-318" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-319"><a href="#cb8-319" aria-hidden="true" tabindex="-1"></a>poetic <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/poetic.rds"</span>)</span>
<span id="cb8-320"><a href="#cb8-320" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb8-321"><a href="#cb8-321" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/pca_merging/df_pca_coordinates.rds"</span></span>
<span id="cb8-322"><a href="#cb8-322" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-323"><a href="#cb8-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-324"><a href="#cb8-324" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>poetic <span class="ot">&lt;-</span> poetic</span>
<span id="cb8-325"><a href="#cb8-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-326"><a href="#cb8-326" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-327"><a href="#cb8-327" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb8-328"><a href="#cb8-328" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/datasets_with_poetic.rds"</span></span>
<span id="cb8-329"><a href="#cb8-329" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-330"><a href="#cb8-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-331"><a href="#cb8-331" aria-hidden="true" tabindex="-1"></a><span class="co"># get the normalization performed </span></span>
<span id="cb8-332"><a href="#cb8-332" aria-hidden="true" tabindex="-1"></a>poetic_normalized <span class="ot">&lt;-</span> <span class="fu">get_final_ranking_values</span>(</span>
<span id="cb8-333"><a href="#cb8-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> poetic,</span>
<span id="cb8-334"><a href="#cb8-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">assay_to_use =</span> <span class="st">"normalized_intensity"</span>,</span>
<span id="cb8-335"><a href="#cb8-335" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable_genes =</span> stable_genes,</span>
<span id="cb8-336"><a href="#cb8-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_variable_genes =</span> <span class="fu">setdiff</span>(<span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings), stable_genes)</span>
<span id="cb8-337"><a href="#cb8-337" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-338"><a href="#cb8-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-339"><a href="#cb8-339" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the embedding</span></span>
<span id="cb8-340"><a href="#cb8-340" aria-hidden="true" tabindex="-1"></a>poetic_df_pca <span class="ot">&lt;-</span> <span class="fu">get_pca_coordinates</span>(poetic_normalized, pca_fit) <span class="sc">%&gt;%</span></span>
<span id="cb8-341"><a href="#cb8-341" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb8-342"><a href="#cb8-342" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb8-343"><a href="#cb8-343" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb8-344"><a href="#cb8-344" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(poetic_normalized) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb8-345"><a href="#cb8-345" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-346"><a href="#cb8-346" aria-hidden="true" tabindex="-1"></a>                <span class="at">er_status =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-347"><a href="#cb8-347" aria-hidden="true" tabindex="-1"></a>                    er_status <span class="sc">==</span> <span class="st">"Positive"</span>, </span>
<span id="cb8-348"><a href="#cb8-348" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pos"</span>, </span>
<span id="cb8-349"><a href="#cb8-349" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"neg"</span></span>
<span id="cb8-350"><a href="#cb8-350" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-351"><a href="#cb8-351" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-352"><a href="#cb8-352" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">cohort =</span> <span class="st">"poetic"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-353"><a href="#cb8-353" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">is_responder =</span></span>
<span id="cb8-354"><a href="#cb8-354" aria-hidden="true" tabindex="-1"></a>                r_or_no_r_change_ki67_60_and_baseline_ki67_5_percent</span>
<span id="cb8-355"><a href="#cb8-355" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-356"><a href="#cb8-356" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-357"><a href="#cb8-357" aria-hidden="true" tabindex="-1"></a>                <span class="at">sample_name =</span> <span class="fu">colnames</span>(poetic_normalized)</span>
<span id="cb8-358"><a href="#cb8-358" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-359"><a href="#cb8-359" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-360"><a href="#cb8-360" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(., df_pca_coordinates)</span>
<span id="cb8-361"><a href="#cb8-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-362"><a href="#cb8-362" aria-hidden="true" tabindex="-1"></a><span class="co"># save all the results</span></span>
<span id="cb8-363"><a href="#cb8-363" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-364"><a href="#cb8-364" aria-hidden="true" tabindex="-1"></a>    poetic_df_pca <span class="sc">%&gt;%</span> data.frame,</span>
<span id="cb8-365"><a href="#cb8-365" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/poetic_df_pca.rds"</span></span>
<span id="cb8-366"><a href="#cb8-366" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-367"><a href="#cb8-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-368"><a href="#cb8-368" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-369"><a href="#cb8-369" aria-hidden="true" tabindex="-1"></a>    poetic_normalized,</span>
<span id="cb8-370"><a href="#cb8-370" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/poetic_normalized.rds"</span></span>
<span id="cb8-371"><a href="#cb8-371" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-372"><a href="#cb8-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-373"><a href="#cb8-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-374"><a href="#cb8-374" aria-hidden="true" tabindex="-1"></a><span class="fu">### Number of samples</span></span>
<span id="cb8-375"><a href="#cb8-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-376"><a href="#cb8-376" aria-hidden="true" tabindex="-1"></a>In this dataset there are matched samples from patients that </span>
<span id="cb8-377"><a href="#cb8-377" aria-hidden="true" tabindex="-1"></a>are treated and untreated. @tbl-pt-poetic-nb</span>
<span id="cb8-378"><a href="#cb8-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-381"><a href="#cb8-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-382"><a href="#cb8-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-pt-poetic-nb</span></span>
<span id="cb8-383"><a href="#cb8-383" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: Table showing the number of samples for treated and untreated</span></span>
<span id="cb8-384"><a href="#cb8-384" aria-hidden="true" tabindex="-1"></a><span class="co">#|     patients</span></span>
<span id="cb8-385"><a href="#cb8-385" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(poetic_normalized) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb8-386"><a href="#cb8-386" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb8-387"><a href="#cb8-387" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> n<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-388"><a href="#cb8-388" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">percent =</span> <span class="fu">round</span>(n<span class="sc">/</span><span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-389"><a href="#cb8-389" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-390"><a href="#cb8-390" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>()</span>
<span id="cb8-391"><a href="#cb8-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-392"><a href="#cb8-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-393"><a href="#cb8-393" aria-hidden="true" tabindex="-1"></a>In this cohort, there is the PAM50 molecular subtype available</span>
<span id="cb8-394"><a href="#cb8-394" aria-hidden="true" tabindex="-1"></a>for the untreated. @tbl-pt-poetic-pam50 shows the</span>
<span id="cb8-395"><a href="#cb8-395" aria-hidden="true" tabindex="-1"></a>number of patients for each subtype.</span>
<span id="cb8-396"><a href="#cb8-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-399"><a href="#cb8-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-400"><a href="#cb8-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-pt-poetic-pam50</span></span>
<span id="cb8-401"><a href="#cb8-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: Table showing the number of molecular subtypes for each </span></span>
<span id="cb8-402"><a href="#cb8-402" aria-hidden="true" tabindex="-1"></a><span class="co">#|     group.</span></span>
<span id="cb8-403"><a href="#cb8-403" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(poetic_normalized) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb8-404"><a href="#cb8-404" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(pam50) <span class="sc">%&gt;%</span> </span>
<span id="cb8-405"><a href="#cb8-405" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">percent =</span> <span class="fu">round</span>(n<span class="sc">/</span><span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>, <span class="at">digits =</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-406"><a href="#cb8-406" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-407"><a href="#cb8-407" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>()</span>
<span id="cb8-408"><a href="#cb8-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-409"><a href="#cb8-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-410"><a href="#cb8-410" aria-hidden="true" tabindex="-1"></a>The numbers differ from previously, since the molecular subtype is </span>
<span id="cb8-411"><a href="#cb8-411" aria-hidden="true" tabindex="-1"></a>calculated for each sample, so two molecular subtypes for each patient. </span>
<span id="cb8-412"><a href="#cb8-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-413"><a href="#cb8-413" aria-hidden="true" tabindex="-1"></a><span class="fu">### Proportion of top loadings</span></span>
<span id="cb8-414"><a href="#cb8-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-417"><a href="#cb8-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-418"><a href="#cb8-418" aria-hidden="true" tabindex="-1"></a>nb_genes <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb8-419"><a href="#cb8-419" aria-hidden="true" tabindex="-1"></a>proportions <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb8-420"><a href="#cb8-420" aria-hidden="true" tabindex="-1"></a>gene_names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pca_fit<span class="sc">$</span>loadings)</span>
<span id="cb8-421"><a href="#cb8-421" aria-hidden="true" tabindex="-1"></a>which_pcs <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb8-422"><a href="#cb8-422" aria-hidden="true" tabindex="-1"></a>top_loadings_genes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb8-423"><a href="#cb8-423" aria-hidden="true" tabindex="-1"></a>    which_pcs,</span>
<span id="cb8-424"><a href="#cb8-424" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(pc, gene_names, pca_fit, nb_genes){</span>
<span id="cb8-425"><a href="#cb8-425" aria-hidden="true" tabindex="-1"></a>        gene_names[<span class="fu">order</span>(</span>
<span id="cb8-426"><a href="#cb8-426" aria-hidden="true" tabindex="-1"></a>            <span class="fu">abs</span>(pca_fit<span class="sc">$</span>loadings[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, pc)]), </span>
<span id="cb8-427"><a href="#cb8-427" aria-hidden="true" tabindex="-1"></a>            <span class="at">decreasing =</span> <span class="cn">TRUE</span></span>
<span id="cb8-428"><a href="#cb8-428" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">1</span><span class="sc">:</span>nb_genes]]   </span>
<span id="cb8-429"><a href="#cb8-429" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-430"><a href="#cb8-430" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_names =</span> gene_names,</span>
<span id="cb8-431"><a href="#cb8-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit,</span>
<span id="cb8-432"><a href="#cb8-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_genes =</span> nb_genes</span>
<span id="cb8-433"><a href="#cb8-433" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb8-434"><a href="#cb8-434" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, which_pcs))</span>
<span id="cb8-435"><a href="#cb8-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-436"><a href="#cb8-436" aria-hidden="true" tabindex="-1"></a>missing_genes_pcx <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(</span>
<span id="cb8-437"><a href="#cb8-437" aria-hidden="true" tabindex="-1"></a>    top_loadings_genes<span class="sc">$</span>PC3,</span>
<span id="cb8-438"><a href="#cb8-438" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(poetic_normalized)</span>
<span id="cb8-439"><a href="#cb8-439" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-440"><a href="#cb8-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-441"><a href="#cb8-441" aria-hidden="true" tabindex="-1"></a>missing_genes_pcy <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(</span>
<span id="cb8-442"><a href="#cb8-442" aria-hidden="true" tabindex="-1"></a>    top_loadings_genes<span class="sc">$</span>PC4,</span>
<span id="cb8-443"><a href="#cb8-443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(poetic_normalized)</span>
<span id="cb8-444"><a href="#cb8-444" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-445"><a href="#cb8-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-446"><a href="#cb8-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-447"><a href="#cb8-447" aria-hidden="true" tabindex="-1"></a>There are in total <span class="in">`r nrow(poetic_normalized)`</span> genes available out</span>
<span id="cb8-448"><a href="#cb8-448" aria-hidden="true" tabindex="-1"></a>of the <span class="in">`r nrow(datasets_normalized)`</span>. Among them, </span>
<span id="cb8-449"><a href="#cb8-449" aria-hidden="true" tabindex="-1"></a><span class="in">`r length(intersect(rownames(poetic_normalized), stable_genes))`</span> are</span>
<span id="cb8-450"><a href="#cb8-450" aria-hidden="true" tabindex="-1"></a>the housekeeping genes. Out of the</span>
<span id="cb8-451"><a href="#cb8-451" aria-hidden="true" tabindex="-1"></a><span class="in">`r nrow(pca_fit$loadings) - nrow(poetic_normalized)`</span> genes missing,</span>
<span id="cb8-452"><a href="#cb8-452" aria-hidden="true" tabindex="-1"></a>a total number of <span class="in">`r length(missing_genes_pcx)`</span> are missing from the</span>
<span id="cb8-453"><a href="#cb8-453" aria-hidden="true" tabindex="-1"></a>top <span class="in">`r nb_genes`</span> PC3 loadings, a proportion of </span>
<span id="cb8-454"><a href="#cb8-454" aria-hidden="true" tabindex="-1"></a><span class="in">`r format(length(missing_genes_pcx)/nb_genes * 100, digits = 1)`</span>\%. </span>
<span id="cb8-455"><a href="#cb8-455" aria-hidden="true" tabindex="-1"></a>A total number of <span class="in">`r length(missing_genes_pcy)`</span> are missing from the</span>
<span id="cb8-456"><a href="#cb8-456" aria-hidden="true" tabindex="-1"></a>top <span class="in">`r nb_genes`</span> PC4 loadings, a proportion of </span>
<span id="cb8-457"><a href="#cb8-457" aria-hidden="true" tabindex="-1"></a><span class="in">`r format(length(missing_genes_pcy)/nb_genes * 100, digits = 1)`</span>\%. These</span>
<span id="cb8-458"><a href="#cb8-458" aria-hidden="true" tabindex="-1"></a>are very small proportions, and we have seen from the last chapter that</span>
<span id="cb8-459"><a href="#cb8-459" aria-hidden="true" tabindex="-1"></a>they will not affect the position of the patients in the embedding.</span>
<span id="cb8-460"><a href="#cb8-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-461"><a href="#cb8-461" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedding </span></span>
<span id="cb8-462"><a href="#cb8-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-463"><a href="#cb8-463" aria-hidden="true" tabindex="-1"></a>@fig-pca-poetic-er-pam50 shows a good mixing of the POETIC sample and how</span>
<span id="cb8-464"><a href="#cb8-464" aria-hidden="true" tabindex="-1"></a>all the patients are scattered across the whole landscape. Here all samples</span>
<span id="cb8-465"><a href="#cb8-465" aria-hidden="true" tabindex="-1"></a>are plotted, meaning that every two dots correspond to a single patient.</span>
<span id="cb8-466"><a href="#cb8-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-467"><a href="#cb8-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=19, fig.height=12}</span></span>
<span id="cb8-468"><a href="#cb8-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-poetic-er-pam50</span></span>
<span id="cb8-469"><a href="#cb8-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC including</span></span>
<span id="cb8-470"><a href="#cb8-470" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the POETIC samples on top.</span></span>
<span id="cb8-471"><a href="#cb8-471" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (A) Colored by cohort,</span></span>
<span id="cb8-472"><a href="#cb8-472" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (B) colored by ER status, (C) colored by PAM50 molecular subtype.</span></span>
<span id="cb8-473"><a href="#cb8-473" aria-hidden="true" tabindex="-1"></a>plots_poetic <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb8-474"><a href="#cb8-474" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"cohort"</span>, <span class="st">"er_status"</span>, <span class="st">"pam50"</span>), </span>
<span id="cb8-475"><a href="#cb8-475" aria-hidden="true" tabindex="-1"></a>    get_plot_new_samples,</span>
<span id="cb8-476"><a href="#cb8-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cohort =</span> <span class="st">"poetic"</span>,</span>
<span id="cb8-477"><a href="#cb8-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> poetic_df_pca,</span>
<span id="cb8-478"><a href="#cb8-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"POETIC samples projected on the molecular landscape"</span>,</span>
<span id="cb8-479"><a href="#cb8-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-480"><a href="#cb8-480" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-481"><a href="#cb8-481" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb8-482"><a href="#cb8-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span></span>
<span id="cb8-483"><a href="#cb8-483" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-484"><a href="#cb8-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-485"><a href="#cb8-485" aria-hidden="true" tabindex="-1"></a>plots_poetic<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> plots_poetic<span class="sc">$</span>pam50 <span class="sc">+</span></span>
<span id="cb8-486"><a href="#cb8-486" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb8-487"><a href="#cb8-487" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb8-488"><a href="#cb8-488" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_colors_pam50</span>(plots_poetic<span class="sc">$</span>pam50<span class="sc">$</span>data),</span>
<span id="cb8-489"><a href="#cb8-489" aria-hidden="true" tabindex="-1"></a>            <span class="st">"not_available"</span> <span class="ot">=</span> <span class="st">"black"</span></span>
<span id="cb8-490"><a href="#cb8-490" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-491"><a href="#cb8-491" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb8-492"><a href="#cb8-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-493"><a href="#cb8-493" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plots_poetic, <span class="at">labels =</span> <span class="st">"AUTO"</span>)</span>
<span id="cb8-494"><a href="#cb8-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-495"><a href="#cb8-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-496"><a href="#cb8-496" aria-hidden="true" tabindex="-1"></a>@fig-pca-responders-baseline shows the embedding of baseline samples</span>
<span id="cb8-497"><a href="#cb8-497" aria-hidden="true" tabindex="-1"></a>from patients that received endocrine therapy prior to surgery. </span>
<span id="cb8-498"><a href="#cb8-498" aria-hidden="true" tabindex="-1"></a>Patients on the left part of the molecular landscape are considered to</span>
<span id="cb8-499"><a href="#cb8-499" aria-hidden="true" tabindex="-1"></a>be non responders, this coincides with the fact this region corresponds</span>
<span id="cb8-500"><a href="#cb8-500" aria-hidden="true" tabindex="-1"></a>to the ER- BC patients.</span>
<span id="cb8-501"><a href="#cb8-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-502"><a href="#cb8-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=6}</span></span>
<span id="cb8-503"><a href="#cb8-503" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-responders-baseline</span></span>
<span id="cb8-504"><a href="#cb8-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC including</span></span>
<span id="cb8-505"><a href="#cb8-505" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the POETIC samples on top. POETIC samples correspond to only baseline</span></span>
<span id="cb8-506"><a href="#cb8-506" aria-hidden="true" tabindex="-1"></a><span class="co">#|     treated patients.</span></span>
<span id="cb8-507"><a href="#cb8-507" aria-hidden="true" tabindex="-1"></a>poetic_df_pca_baseline <span class="ot">&lt;-</span> poetic_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-508"><a href="#cb8-508" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> group <span class="sc">==</span> <span class="st">"untreated"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-509"><a href="#cb8-509" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-510"><a href="#cb8-510" aria-hidden="true" tabindex="-1"></a>        <span class="at">timepoint =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(timepoint), <span class="st">"baseline"</span>, timepoint)</span>
<span id="cb8-511"><a href="#cb8-511" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-512"><a href="#cb8-512" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(timepoint <span class="sc">==</span> <span class="st">"baseline"</span>)</span>
<span id="cb8-513"><a href="#cb8-513" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-514"><a href="#cb8-514" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"PC3"</span></span>
<span id="cb8-515"><a href="#cb8-515" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="st">"PC4"</span></span>
<span id="cb8-516"><a href="#cb8-516" aria-hidden="true" tabindex="-1"></a>title <span class="ot">&lt;-</span> <span class="st">"POETIC baseline samples"</span></span>
<span id="cb8-517"><a href="#cb8-517" aria-hidden="true" tabindex="-1"></a>color <span class="ot">&lt;-</span> <span class="st">"is_responder"</span></span>
<span id="cb8-518"><a href="#cb8-518" aria-hidden="true" tabindex="-1"></a>plot_responder_poetic <span class="ot">&lt;-</span> poetic_df_pca_baseline <span class="sc">%&gt;%</span></span>
<span id="cb8-519"><a href="#cb8-519" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-520"><a href="#cb8-520" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.na</span>(is_responder) <span class="sc">~</span> <span class="st">"All cohorts"</span>,</span>
<span id="cb8-521"><a href="#cb8-521" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"non_responder"</span> <span class="sc">~</span> <span class="st">"Non responder"</span>,</span>
<span id="cb8-522"><a href="#cb8-522" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"responder"</span> <span class="sc">~</span> <span class="st">"Responder"</span>,</span>
<span id="cb8-523"><a href="#cb8-523" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"not_available"</span> <span class="sc">~</span> <span class="st">"Not available"</span></span>
<span id="cb8-524"><a href="#cb8-524" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb8-525"><a href="#cb8-525" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb8-526"><a href="#cb8-526" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb8-527"><a href="#cb8-527" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> <span class="sc">!!</span><span class="fu">sym</span>(x), </span>
<span id="cb8-528"><a href="#cb8-528" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(y), </span>
<span id="cb8-529"><a href="#cb8-529" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="sc">!!</span><span class="fu">sym</span>(color), </span>
<span id="cb8-530"><a href="#cb8-530" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="sc">!!</span><span class="fu">sym</span>(color),</span>
<span id="cb8-531"><a href="#cb8-531" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="sc">!!</span><span class="fu">sym</span>(color)</span>
<span id="cb8-532"><a href="#cb8-532" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-533"><a href="#cb8-533" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-534"><a href="#cb8-534" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb8-535"><a href="#cb8-535" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb8-536"><a href="#cb8-536" aria-hidden="true" tabindex="-1"></a>        <span class="st">"grey"</span>,</span>
<span id="cb8-537"><a href="#cb8-537" aria-hidden="true" tabindex="-1"></a>        scales<span class="sc">::</span><span class="fu">hue_pal</span>()(<span class="dv">3</span>)</span>
<span id="cb8-538"><a href="#cb8-538" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb8-539"><a href="#cb8-539" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(</span>
<span id="cb8-540"><a href="#cb8-540" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb8-541"><a href="#cb8-541" aria-hidden="true" tabindex="-1"></a>        <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb8-542"><a href="#cb8-542" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-543"><a href="#cb8-543" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(</span>
<span id="cb8-544"><a href="#cb8-544" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(.<span class="dv">1</span>, <span class="dv">1</span>, .<span class="dv">7</span>, <span class="dv">1</span>)</span>
<span id="cb8-545"><a href="#cb8-545" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-546"><a href="#cb8-546" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-547"><a href="#cb8-547" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-548"><a href="#cb8-548" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-549"><a href="#cb8-549" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-550"><a href="#cb8-550" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> title</span>
<span id="cb8-551"><a href="#cb8-551" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-552"><a href="#cb8-552" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb8-553"><a href="#cb8-553" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb8-554"><a href="#cb8-554" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-555"><a href="#cb8-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-556"><a href="#cb8-556" aria-hidden="true" tabindex="-1"></a>plot_responder_poetic</span>
<span id="cb8-557"><a href="#cb8-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-558"><a href="#cb8-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-559"><a href="#cb8-559" aria-hidden="true" tabindex="-1"></a>And when checking the first two components, the POETIC data is closer to</span>
<span id="cb8-560"><a href="#cb8-560" aria-hidden="true" tabindex="-1"></a>METABRIC, which makes sense since both are microarrays, as it can be seen</span>
<span id="cb8-561"><a href="#cb8-561" aria-hidden="true" tabindex="-1"></a>in @fig-poetic-cohort.</span>
<span id="cb8-562"><a href="#cb8-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-565"><a href="#cb8-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-566"><a href="#cb8-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-poetic-cohort</span></span>
<span id="cb8-567"><a href="#cb8-567" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Biplot of first two PCA components from POETIC, TCGA, SCANB and </span></span>
<span id="cb8-568"><a href="#cb8-568" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC. POETIC is highlighted in the plot and has a bigger point.</span></span>
<span id="cb8-569"><a href="#cb8-569" aria-hidden="true" tabindex="-1"></a>poetic_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-570"><a href="#cb8-570" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb8-571"><a href="#cb8-571" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> cohort)</span>
<span id="cb8-572"><a href="#cb8-572" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-573"><a href="#cb8-573" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> cohort, <span class="at">size =</span> cohort)) <span class="sc">+</span></span>
<span id="cb8-574"><a href="#cb8-574" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb8-575"><a href="#cb8-575" aria-hidden="true" tabindex="-1"></a>        <span class="st">"poetic"</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb8-576"><a href="#cb8-576" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb8-577"><a href="#cb8-577" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb8-578"><a href="#cb8-578" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb8-579"><a href="#cb8-579" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-580"><a href="#cb8-580" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb8-581"><a href="#cb8-581" aria-hidden="true" tabindex="-1"></a>        <span class="st">"poetic"</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb8-582"><a href="#cb8-582" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tcga"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb8-583"><a href="#cb8-583" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scanb"</span> <span class="ot">=</span> <span class="fl">0.1</span>,</span>
<span id="cb8-584"><a href="#cb8-584" aria-hidden="true" tabindex="-1"></a>        <span class="st">"metabric"</span> <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb8-585"><a href="#cb8-585" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-586"><a href="#cb8-586" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-587"><a href="#cb8-587" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb8-588"><a href="#cb8-588" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb8-589"><a href="#cb8-589" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="st">"Cohort"</span>,</span>
<span id="cb8-590"><a href="#cb8-590" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-591"><a href="#cb8-591" aria-hidden="true" tabindex="-1"></a>            <span class="st">"First two components of POETIC overlayed on all the three</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb8-592"><a href="#cb8-592" aria-hidden="true" tabindex="-1"></a>            <span class="st">"big cohorts in the the molecular landscape"</span></span>
<span id="cb8-593"><a href="#cb8-593" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-594"><a href="#cb8-594" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"All samples from TCGA, METABRIC and SCANB are plotted"</span></span>
<span id="cb8-595"><a href="#cb8-595" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-596"><a href="#cb8-596" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb8-597"><a href="#cb8-597" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb8-598"><a href="#cb8-598" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-599"><a href="#cb8-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-600"><a href="#cb8-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-601"><a href="#cb8-601" aria-hidden="true" tabindex="-1"></a><span class="fu">### Differences in PC3 for responders and non responders</span></span>
<span id="cb8-602"><a href="#cb8-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-603"><a href="#cb8-603" aria-hidden="true" tabindex="-1"></a>We now also compare the differences in non responders vs responders</span>
<span id="cb8-604"><a href="#cb8-604" aria-hidden="true" tabindex="-1"></a>according to the third component. </span>
<span id="cb8-605"><a href="#cb8-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-606"><a href="#cb8-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=6, fig.height=5}</span></span>
<span id="cb8-607"><a href="#cb8-607" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comp-responders-pc3</span></span>
<span id="cb8-608"><a href="#cb8-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Comparison of the PC3 between responders and non responders</span></span>
<span id="cb8-609"><a href="#cb8-609" aria-hidden="true" tabindex="-1"></a>poetic_df_pca_baseline <span class="sc">%&gt;%</span></span>
<span id="cb8-610"><a href="#cb8-610" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> is_responder <span class="sc">!=</span> <span class="st">"not_available"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-611"><a href="#cb8-611" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-612"><a href="#cb8-612" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"responder"</span> <span class="sc">~</span> <span class="st">"Responder"</span>,</span>
<span id="cb8-613"><a href="#cb8-613" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"non_responder"</span> <span class="sc">~</span> <span class="st">"Non responder"</span>,</span>
<span id="cb8-614"><a href="#cb8-614" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"na"</span></span>
<span id="cb8-615"><a href="#cb8-615" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb8-616"><a href="#cb8-616" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_responder, <span class="at">y =</span> PC3, <span class="at">color =</span> is_responder)) <span class="sc">+</span></span>
<span id="cb8-617"><a href="#cb8-617" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb8-618"><a href="#cb8-618" aria-hidden="true" tabindex="-1"></a>        <span class="at">outlier.shape =</span> <span class="cn">NA</span>,</span>
<span id="cb8-619"><a href="#cb8-619" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb8-620"><a href="#cb8-620" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-621"><a href="#cb8-621" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span></span>
<span id="cb8-622"><a href="#cb8-622" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-623"><a href="#cb8-623" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Third component score"</span>,</span>
<span id="cb8-624"><a href="#cb8-624" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-625"><a href="#cb8-625" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Response status"</span></span>
<span id="cb8-626"><a href="#cb8-626" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-627"><a href="#cb8-627" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb8-628"><a href="#cb8-628" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> scales<span class="sc">::</span><span class="fu">hue_pal</span>()(<span class="dv">3</span>)[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)]</span>
<span id="cb8-629"><a href="#cb8-629" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-630"><a href="#cb8-630" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb8-631"><a href="#cb8-631" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span> </span>
<span id="cb8-632"><a href="#cb8-632" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>() <span class="sc">+</span></span>
<span id="cb8-633"><a href="#cb8-633" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb8-634"><a href="#cb8-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-635"><a href="#cb8-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-636"><a href="#cb8-636" aria-hidden="true" tabindex="-1"></a>We see that there is a clear difference, we now use bayesian stats to do the</span>
<span id="cb8-637"><a href="#cb8-637" aria-hidden="true" tabindex="-1"></a>comparison and get the posterior distribution of the difference in PC3.</span>
<span id="cb8-638"><a href="#cb8-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-639"><a href="#cb8-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE}</span></span>
<span id="cb8-640"><a href="#cb8-640" aria-hidden="true" tabindex="-1"></a>pc3_responders_comparison_df <span class="ot">&lt;-</span> poetic_df_pca_baseline <span class="sc">%&gt;%</span></span>
<span id="cb8-641"><a href="#cb8-641" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> is_responder <span class="sc">!=</span> <span class="st">"not_available"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-642"><a href="#cb8-642" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-643"><a href="#cb8-643" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"responder"</span> <span class="sc">~</span> <span class="st">"Responder"</span>,</span>
<span id="cb8-644"><a href="#cb8-644" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"non_responder"</span> <span class="sc">~</span> <span class="st">"Non responder"</span></span>
<span id="cb8-645"><a href="#cb8-645" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb8-646"><a href="#cb8-646" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> <span class="fu">factor</span>(</span>
<span id="cb8-647"><a href="#cb8-647" aria-hidden="true" tabindex="-1"></a>        is_responder, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Non responder"</span>, <span class="st">"Responder"</span>)</span>
<span id="cb8-648"><a href="#cb8-648" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb8-649"><a href="#cb8-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-650"><a href="#cb8-650" aria-hidden="true" tabindex="-1"></a>pc3_responders_comparison <span class="ot">&lt;-</span> pc3_responders_comparison_df <span class="sc">%&gt;%</span></span>
<span id="cb8-651"><a href="#cb8-651" aria-hidden="true" tabindex="-1"></a>    rstanarm<span class="sc">::</span><span class="fu">stan_lm</span>(</span>
<span id="cb8-652"><a href="#cb8-652" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> PC3 <span class="sc">~</span> is_responder, </span>
<span id="cb8-653"><a href="#cb8-653" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> .,</span>
<span id="cb8-654"><a href="#cb8-654" aria-hidden="true" tabindex="-1"></a>        <span class="at">prior =</span> rstanarm<span class="sc">::</span><span class="fu">R2</span>(<span class="at">location =</span> <span class="fl">0.1</span>, <span class="at">what =</span> <span class="st">"mean"</span>), </span>
<span id="cb8-655"><a href="#cb8-655" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb8-656"><a href="#cb8-656" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-657"><a href="#cb8-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-658"><a href="#cb8-658" aria-hidden="true" tabindex="-1"></a>pc3_responders_comparison <span class="sc">%&gt;%</span> </span>
<span id="cb8-659"><a href="#cb8-659" aria-hidden="true" tabindex="-1"></a>    summary</span>
<span id="cb8-660"><a href="#cb8-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-661"><a href="#cb8-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-662"><a href="#cb8-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-663"><a href="#cb8-663" aria-hidden="true" tabindex="-1"></a>The difference is clear, when looking at the parameter <span class="in">`is_responderResponder`</span>.</span>
<span id="cb8-664"><a href="#cb8-664" aria-hidden="true" tabindex="-1"></a>The Rhat is reasonable and the number of effective sample size is good as well. </span>
<span id="cb8-665"><a href="#cb8-665" aria-hidden="true" tabindex="-1"></a>Below we plot the average posterior distribution of the difference between</span>
<span id="cb8-666"><a href="#cb8-666" aria-hidden="true" tabindex="-1"></a>responders and non responders.</span>
<span id="cb8-667"><a href="#cb8-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-668"><a href="#cb8-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=6, fig.height=4}</span></span>
<span id="cb8-669"><a href="#cb8-669" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comp-responders-pc3-bayes</span></span>
<span id="cb8-670"><a href="#cb8-670" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Comparison of the PC3 between responders and non responders. </span></span>
<span id="cb8-671"><a href="#cb8-671" aria-hidden="true" tabindex="-1"></a><span class="co">#|     Difference in the expected posterior predictive distributions. Each</span></span>
<span id="cb8-672"><a href="#cb8-672" aria-hidden="true" tabindex="-1"></a><span class="co">#|     dot corresponds to a 1% quantile.</span></span>
<span id="cb8-673"><a href="#cb8-673" aria-hidden="true" tabindex="-1"></a>pc3_responders_comparison_df <span class="sc">%&gt;%</span></span>
<span id="cb8-674"><a href="#cb8-674" aria-hidden="true" tabindex="-1"></a>    modelr<span class="sc">::</span><span class="fu">data_grid</span>(is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-675"><a href="#cb8-675" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">add_epred_draws</span>(pc3_responders_comparison) <span class="sc">%&gt;%</span></span>
<span id="cb8-676"><a href="#cb8-676" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb8-677"><a href="#cb8-677" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">".draw"</span>),</span>
<span id="cb8-678"><a href="#cb8-678" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> <span class="st">"is_responder"</span>, </span>
<span id="cb8-679"><a href="#cb8-679" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> <span class="st">".epred"</span></span>
<span id="cb8-680"><a href="#cb8-680" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-681"><a href="#cb8-681" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">difference =</span> <span class="st">`</span><span class="at">Responder</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">Non responder</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-682"><a href="#cb8-682" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> difference)) <span class="sc">+</span></span>
<span id="cb8-683"><a href="#cb8-683" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb8-684"><a href="#cb8-684" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">stat_dotsinterval</span>(<span class="at">quantiles =</span> <span class="dv">100</span>, <span class="at">.width =</span> <span class="fu">c</span>(.<span class="dv">66</span>, .<span class="dv">95</span>)) <span class="sc">+</span> </span>
<span id="cb8-685"><a href="#cb8-685" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-686"><a href="#cb8-686" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Difference from expection of</span><span class="sc">\n</span><span class="st">the posterior predictive distribution"</span>,</span>
<span id="cb8-687"><a href="#cb8-687" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb8-688"><a href="#cb8-688" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-689"><a href="#cb8-689" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span> </span>
<span id="cb8-690"><a href="#cb8-690" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb8-691"><a href="#cb8-691" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-692"><a href="#cb8-692" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb8-693"><a href="#cb8-693" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-694"><a href="#cb8-694" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb8-695"><a href="#cb8-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-696"><a href="#cb8-696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-697"><a href="#cb8-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-698"><a href="#cb8-698" aria-hidden="true" tabindex="-1"></a>We see that the difference is 100% higher than 0 and</span>
<span id="cb8-699"><a href="#cb8-699" aria-hidden="true" tabindex="-1"></a>even more the difference is higher than 0.5, meaning that</span>
<span id="cb8-700"><a href="#cb8-700" aria-hidden="true" tabindex="-1"></a>responders have higher PC3 compared to non responders. The plot</span>
<span id="cb8-701"><a href="#cb8-701" aria-hidden="true" tabindex="-1"></a>below shows the average values as well for responders and non</span>
<span id="cb8-702"><a href="#cb8-702" aria-hidden="true" tabindex="-1"></a>responders separately.</span>
<span id="cb8-703"><a href="#cb8-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-704"><a href="#cb8-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8}</span></span>
<span id="cb8-705"><a href="#cb8-705" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-average-pc3-poetic</span></span>
<span id="cb8-706"><a href="#cb8-706" aria-hidden="true" tabindex="-1"></a>pc3_responders_comparison_df <span class="sc">%&gt;%</span></span>
<span id="cb8-707"><a href="#cb8-707" aria-hidden="true" tabindex="-1"></a>    modelr<span class="sc">::</span><span class="fu">data_grid</span>(is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-708"><a href="#cb8-708" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">add_epred_draws</span>(pc3_responders_comparison) <span class="sc">%&gt;%</span></span>
<span id="cb8-709"><a href="#cb8-709" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .epred, <span class="at">y =</span> is_responder)) <span class="sc">+</span></span>
<span id="cb8-710"><a href="#cb8-710" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">stat_dotsinterval</span>(<span class="at">quantiles =</span> <span class="dv">100</span>, <span class="at">.width =</span> <span class="fu">c</span>(.<span class="dv">66</span>, .<span class="dv">95</span>)) <span class="sc">+</span> </span>
<span id="cb8-711"><a href="#cb8-711" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-712"><a href="#cb8-712" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Expection of the posterior predictive distribution"</span>,</span>
<span id="cb8-713"><a href="#cb8-713" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb8-714"><a href="#cb8-714" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-715"><a href="#cb8-715" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb8-716"><a href="#cb8-716" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb8-717"><a href="#cb8-717" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-718"><a href="#cb8-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-719"><a href="#cb8-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-720"><a href="#cb8-720" aria-hidden="true" tabindex="-1"></a>And to conclude we also calculate the p-value for the sake of it.</span>
<span id="cb8-721"><a href="#cb8-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-724"><a href="#cb8-724" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-725"><a href="#cb8-725" aria-hidden="true" tabindex="-1"></a>pc3_responders_comparison_df <span class="sc">%&gt;%</span></span>
<span id="cb8-726"><a href="#cb8-726" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm</span>(PC3 <span class="sc">~</span> is_responder, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb8-727"><a href="#cb8-727" aria-hidden="true" tabindex="-1"></a>    broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-728"><a href="#cb8-728" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-729"><a href="#cb8-729" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb8-730"><a href="#cb8-730" aria-hidden="true" tabindex="-1"></a>            <span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"term"</span>)), </span>
<span id="cb8-731"><a href="#cb8-731" aria-hidden="true" tabindex="-1"></a>            <span class="at">.fns =</span> format, </span>
<span id="cb8-732"><a href="#cb8-732" aria-hidden="true" tabindex="-1"></a>            <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb8-733"><a href="#cb8-733" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-734"><a href="#cb8-734" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-735"><a href="#cb8-735" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-736"><a href="#cb8-736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-737"><a href="#cb8-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-738"><a href="#cb8-738" aria-hidden="true" tabindex="-1"></a>The p-value is around 2.9e-06, very small, three stars!</span>
<span id="cb8-739"><a href="#cb8-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-740"><a href="#cb8-740" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scoring all samples </span></span>
<span id="cb8-741"><a href="#cb8-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-742"><a href="#cb8-742" aria-hidden="true" tabindex="-1"></a>In the last chapters scores were showed for TCGA, SCANB and </span>
<span id="cb8-743"><a href="#cb8-743" aria-hidden="true" tabindex="-1"></a>METABRIC. @fig-pca-seterpr shows how ER signaling changes as patients</span>
<span id="cb8-744"><a href="#cb8-744" aria-hidden="true" tabindex="-1"></a>move across the molecular landscape. We intend to use the scores now for the</span>
<span id="cb8-745"><a href="#cb8-745" aria-hidden="true" tabindex="-1"></a>POETIC samples. We first start by calculating using GSVA as well and include</span>
<span id="cb8-746"><a href="#cb8-746" aria-hidden="true" tabindex="-1"></a>in the dataframe with the other cohorts. Before moving to the next chapter,</span>
<span id="cb8-747"><a href="#cb8-747" aria-hidden="true" tabindex="-1"></a>we will analyse and compare the scores across the responders and non </span>
<span id="cb8-748"><a href="#cb8-748" aria-hidden="true" tabindex="-1"></a>responders. </span>
<span id="cb8-749"><a href="#cb8-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-750"><a href="#cb8-750" aria-hidden="true" tabindex="-1"></a>@fig-scores-poetic-er shows that when using the scores, it looks like</span>
<span id="cb8-751"><a href="#cb8-751" aria-hidden="true" tabindex="-1"></a>in average at baseline $SET_{ER/PR}$ is lower in non responders than</span>
<span id="cb8-752"><a href="#cb8-752" aria-hidden="true" tabindex="-1"></a>in responders. For the other scores there is no clear difference.</span>
<span id="cb8-753"><a href="#cb8-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-754"><a href="#cb8-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb8-755"><a href="#cb8-755" aria-hidden="true" tabindex="-1"></a><span class="co"># before we calculate the scores we filter the poetic dataset</span></span>
<span id="cb8-756"><a href="#cb8-756" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">assay</span>(datasets<span class="sc">$</span>poetic, <span class="st">"normalized_intensity"</span>) <span class="sc">&gt;</span> <span class="fl">6.4</span>)</span>
<span id="cb8-757"><a href="#cb8-757" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="ot">&lt;-</span> keep_genes <span class="sc">&gt;</span> <span class="fl">0.7</span></span>
<span id="cb8-758"><a href="#cb8-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-759"><a href="#cb8-759" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb8-760"><a href="#cb8-760" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/surv_analysis_estrogen/gene_sets.rds"</span></span>
<span id="cb8-761"><a href="#cb8-761" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-762"><a href="#cb8-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-763"><a href="#cb8-763" aria-hidden="true" tabindex="-1"></a>gene_sets <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb8-764"><a href="#cb8-764" aria-hidden="true" tabindex="-1"></a>    gene_sets<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique,</span>
<span id="cb8-765"><a href="#cb8-765" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, gene_sets) gene_sets <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb8-766"><a href="#cb8-766" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(gene_symbol),</span>
<span id="cb8-767"><a href="#cb8-767" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets,</span>
<span id="cb8-768"><a href="#cb8-768" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-769"><a href="#cb8-769" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb8-770"><a href="#cb8-770" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-771"><a href="#cb8-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-772"><a href="#cb8-772" aria-hidden="true" tabindex="-1"></a>gsva_scores <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb8-773"><a href="#cb8-773" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(sum_exp, which_assay, gene_sets){</span>
<span id="cb8-774"><a href="#cb8-774" aria-hidden="true" tabindex="-1"></a>        GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb8-775"><a href="#cb8-775" aria-hidden="true" tabindex="-1"></a>            <span class="at">expr =</span> <span class="fu">as.matrix</span>(<span class="fu">assay</span>(sum_exp, which_assay)),</span>
<span id="cb8-776"><a href="#cb8-776" aria-hidden="true" tabindex="-1"></a>            <span class="at">gset.idx.list =</span> gene_sets, </span>
<span id="cb8-777"><a href="#cb8-777" aria-hidden="true" tabindex="-1"></a>            <span class="at">parallel.sz =</span> <span class="dv">20</span></span>
<span id="cb8-778"><a href="#cb8-778" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-779"><a href="#cb8-779" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-780"><a href="#cb8-780" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> <span class="fu">list</span>(<span class="at">poetic =</span> datasets<span class="sc">$</span>poetic[keep_genes, ]),</span>
<span id="cb8-781"><a href="#cb8-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_assay =</span> <span class="fu">list</span>(<span class="at">poetic =</span> <span class="st">"normalized_intensity"</span>),</span>
<span id="cb8-782"><a href="#cb8-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">gene_sets =</span> gene_sets),</span>
<span id="cb8-783"><a href="#cb8-783" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-784"><a href="#cb8-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span></span>
<span id="cb8-785"><a href="#cb8-785" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-786"><a href="#cb8-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-787"><a href="#cb8-787" aria-hidden="true" tabindex="-1"></a>poetic_df_pca[</span>
<span id="cb8-788"><a href="#cb8-788" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(gsva_scores<span class="sc">$</span>poetic), </span>
<span id="cb8-789"><a href="#cb8-789" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(gsva_scores<span class="sc">$</span>poetic)</span>
<span id="cb8-790"><a href="#cb8-790" aria-hidden="true" tabindex="-1"></a>] <span class="ot">&lt;-</span> gsva_scores<span class="sc">$</span>poetic <span class="sc">%&gt;%</span> t</span>
<span id="cb8-791"><a href="#cb8-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-792"><a href="#cb8-792" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-793"><a href="#cb8-793" aria-hidden="true" tabindex="-1"></a>    poetic_df_pca,</span>
<span id="cb8-794"><a href="#cb8-794" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/poetic_df_pca_with_scores.rds"</span></span>
<span id="cb8-795"><a href="#cb8-795" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-796"><a href="#cb8-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-797"><a href="#cb8-797" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="ot">&lt;-</span> poetic_df_pca</span>
<span id="cb8-798"><a href="#cb8-798" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-799"><a href="#cb8-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-802"><a href="#cb8-802" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-803"><a href="#cb8-803" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>load_at_setup){</span>
<span id="cb8-804"><a href="#cb8-804" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb8-805"><a href="#cb8-805" aria-hidden="true" tabindex="-1"></a>        <span class="st">"../results/rds_files/scoring/poetic_df_pca_with_scores.rds"</span></span>
<span id="cb8-806"><a href="#cb8-806" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-807"><a href="#cb8-807" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-808"><a href="#cb8-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-809"><a href="#cb8-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-810"><a href="#cb8-810" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=13, fig.height=8}</span></span>
<span id="cb8-811"><a href="#cb8-811" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-poetic-er</span></span>
<span id="cb8-812"><a href="#cb8-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Baseline scores for all treated patients in the POETIC trial. </span></span>
<span id="cb8-813"><a href="#cb8-813" aria-hidden="true" tabindex="-1"></a><span class="co">#|     G2M corresponds to a proliferation score, EMT to epithelial to </span></span>
<span id="cb8-814"><a href="#cb8-814" aria-hidden="true" tabindex="-1"></a><span class="co">#|     mesenchymal transition score and the others are related to ER </span></span>
<span id="cb8-815"><a href="#cb8-815" aria-hidden="true" tabindex="-1"></a><span class="co">#|     signaling. </span></span>
<span id="cb8-816"><a href="#cb8-816" aria-hidden="true" tabindex="-1"></a>which_scores <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-817"><a href="#cb8-817" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>,</span>
<span id="cb8-818"><a href="#cb8-818" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span> <span class="ot">=</span> <span class="st">"Estrogen Early"</span>,</span>
<span id="cb8-819"><a href="#cb8-819" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_LATE"</span> <span class="ot">=</span> <span class="st">"Estrogen Late"</span>,</span>
<span id="cb8-820"><a href="#cb8-820" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_G2M_CHECKPOINT"</span> <span class="ot">=</span> <span class="st">"G2M"</span>,</span>
<span id="cb8-821"><a href="#cb8-821" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION"</span> <span class="ot">=</span> <span class="st">"EMT"</span>,</span>
<span id="cb8-822"><a href="#cb8-822" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PC3"</span> <span class="ot">=</span> <span class="st">"PC3"</span></span>
<span id="cb8-823"><a href="#cb8-823" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-824"><a href="#cb8-824" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-825"><a href="#cb8-825" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> timepoint <span class="sc">==</span> <span class="st">"baseline"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-826"><a href="#cb8-826" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb8-827"><a href="#cb8-827" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(which_scores),</span>
<span id="cb8-828"><a href="#cb8-828" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb8-829"><a href="#cb8-829" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb8-830"><a href="#cb8-830" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-831"><a href="#cb8-831" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-832"><a href="#cb8-832" aria-hidden="true" tabindex="-1"></a>        <span class="at">pathway =</span> which_scores[pathway]</span>
<span id="cb8-833"><a href="#cb8-833" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-834"><a href="#cb8-834" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_responder, <span class="at">y =</span> score, <span class="at">fill =</span> is_responder)) <span class="sc">+</span></span>
<span id="cb8-835"><a href="#cb8-835" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb8-836"><a href="#cb8-836" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb8-837"><a href="#cb8-837" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb8-838"><a href="#cb8-838" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway, <span class="at">scale =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb8-839"><a href="#cb8-839" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb8-840"><a href="#cb8-840" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-841"><a href="#cb8-841" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Is responder?"</span>, <span class="at">y =</span> <span class="st">"Score"</span>, <span class="at">fill =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-842"><a href="#cb8-842" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Distribution of some scores for samples at baseline timepoint"</span></span>
<span id="cb8-843"><a href="#cb8-843" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-844"><a href="#cb8-844" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb8-845"><a href="#cb8-845" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-846"><a href="#cb8-846" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-847"><a href="#cb8-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-848"><a href="#cb8-848" aria-hidden="true" tabindex="-1"></a>We see that for PC3 and SET ER/PR There are some</span>
<span id="cb8-849"><a href="#cb8-849" aria-hidden="true" tabindex="-1"></a>differences in terms of the responders and non responders.</span>
<span id="cb8-850"><a href="#cb8-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-851"><a href="#cb8-851" aria-hidden="true" tabindex="-1"></a>Let us take a closer look at those patients. We start</span>
<span id="cb8-852"><a href="#cb8-852" aria-hidden="true" tabindex="-1"></a>by plotting the scatter plot of PC3 vs SET ER/PR and color</span>
<span id="cb8-853"><a href="#cb8-853" aria-hidden="true" tabindex="-1"></a>by response status defined by the POETIC trial. </span>
<span id="cb8-854"><a href="#cb8-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-857"><a href="#cb8-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-858"><a href="#cb8-858" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-poetic-responders</span></span>
<span id="cb8-859"><a href="#cb8-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Comparison of the third component with SET ER/PR scores colored</span></span>
<span id="cb8-860"><a href="#cb8-860" aria-hidden="true" tabindex="-1"></a><span class="co">#|     by response status.</span></span>
<span id="cb8-861"><a href="#cb8-861" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-862"><a href="#cb8-862" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> timepoint <span class="sc">==</span> <span class="st">"baseline"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-863"><a href="#cb8-863" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_responder <span class="sc">!=</span> <span class="st">"not_available"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-864"><a href="#cb8-864" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> SET_ERPR, <span class="at">color =</span> is_responder)) <span class="sc">+</span></span>
<span id="cb8-865"><a href="#cb8-865" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb8-866"><a href="#cb8-866" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb8-867"><a href="#cb8-867" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"gam"</span>,</span>
<span id="cb8-868"><a href="#cb8-868" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb8-869"><a href="#cb8-869" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-870"><a href="#cb8-870" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb8-871"><a href="#cb8-871" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-872"><a href="#cb8-872" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"PC3"</span>, </span>
<span id="cb8-873"><a href="#cb8-873" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"SET ER/PR"</span>, </span>
<span id="cb8-874"><a href="#cb8-874" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-875"><a href="#cb8-875" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-876"><a href="#cb8-876" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Scores for responders and non</span><span class="sc">\n</span><span class="st">responders of "</span>,</span>
<span id="cb8-877"><a href="#cb8-877" aria-hidden="true" tabindex="-1"></a>            <span class="st">"POETIC trial samples"</span></span>
<span id="cb8-878"><a href="#cb8-878" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-879"><a href="#cb8-879" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-880"><a href="#cb8-880" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb8-881"><a href="#cb8-881" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-882"><a href="#cb8-882" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-883"><a href="#cb8-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-884"><a href="#cb8-884" aria-hidden="true" tabindex="-1"></a>This figure shows that there is a correlation between</span>
<span id="cb8-885"><a href="#cb8-885" aria-hidden="true" tabindex="-1"></a>third component and SET ER/PR for the POETIC trial data</span>
<span id="cb8-886"><a href="#cb8-886" aria-hidden="true" tabindex="-1"></a>as well as it was already seen from the other cohorts. </span>
<span id="cb8-887"><a href="#cb8-887" aria-hidden="true" tabindex="-1"></a>Moreover, it seems that the responders have higher PC scores</span>
<span id="cb8-888"><a href="#cb8-888" aria-hidden="true" tabindex="-1"></a>in general. We now correlate for each subgroup (responder and non </span>
<span id="cb8-889"><a href="#cb8-889" aria-hidden="true" tabindex="-1"></a>responders) the PC3 and the change in percentage for Ki67.</span>
<span id="cb8-890"><a href="#cb8-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-891"><a href="#cb8-891" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=6}</span></span>
<span id="cb8-892"><a href="#cb8-892" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scores-corr-poetic</span></span>
<span id="cb8-893"><a href="#cb8-893" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between change in Ki67 versus PC3 stratified by</span></span>
<span id="cb8-894"><a href="#cb8-894" aria-hidden="true" tabindex="-1"></a><span class="co">#|     response group.</span></span>
<span id="cb8-895"><a href="#cb8-895" aria-hidden="true" tabindex="-1"></a>responder_non_responder_base <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-896"><a href="#cb8-896" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-897"><a href="#cb8-897" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> timepoint <span class="sc">==</span> <span class="st">"baseline"</span> <span class="sc">&amp;</span></span>
<span id="cb8-898"><a href="#cb8-898" aria-hidden="true" tabindex="-1"></a>            is_responder <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"non_responder"</span>, <span class="st">"responder"</span>)</span>
<span id="cb8-899"><a href="#cb8-899" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-900"><a href="#cb8-900" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> <span class="fu">factor</span>(</span>
<span id="cb8-901"><a href="#cb8-901" aria-hidden="true" tabindex="-1"></a>        is_responder, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"responder"</span>, <span class="st">"non_responder"</span>)</span>
<span id="cb8-902"><a href="#cb8-902" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb8-903"><a href="#cb8-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-904"><a href="#cb8-904" aria-hidden="true" tabindex="-1"></a><span class="co"># calculates the correlation and also get the p-values</span></span>
<span id="cb8-905"><a href="#cb8-905" aria-hidden="true" tabindex="-1"></a>cor_tests <span class="ot">&lt;-</span> responder_non_responder_base <span class="sc">%&gt;%</span> </span>
<span id="cb8-906"><a href="#cb8-906" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-907"><a href="#cb8-907" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-908"><a href="#cb8-908" aria-hidden="true" tabindex="-1"></a>        <span class="at">test =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">cor.test</span>(.x<span class="sc">$</span>change_ki67, .x<span class="sc">$</span>PC3)),</span>
<span id="cb8-909"><a href="#cb8-909" aria-hidden="true" tabindex="-1"></a>        <span class="at">tidied =</span> <span class="fu">map</span>(test, broom<span class="sc">::</span>tidy)</span>
<span id="cb8-910"><a href="#cb8-910" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-911"><a href="#cb8-911" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span> </span>
<span id="cb8-912"><a href="#cb8-912" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="st">"data"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-913"><a href="#cb8-913" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-914"><a href="#cb8-914" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-915"><a href="#cb8-915" aria-hidden="true" tabindex="-1"></a>            <span class="st">"\U03C1: "</span>, </span>
<span id="cb8-916"><a href="#cb8-916" aria-hidden="true" tabindex="-1"></a>            <span class="fu">format</span>(estimate, <span class="at">digits =</span> <span class="dv">2</span>), </span>
<span id="cb8-917"><a href="#cb8-917" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st"> p-val: "</span>, </span>
<span id="cb8-918"><a href="#cb8-918" aria-hidden="true" tabindex="-1"></a>            <span class="fu">format</span>(p.value, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb8-919"><a href="#cb8-919" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-920"><a href="#cb8-920" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">90</span>, <span class="sc">-</span><span class="dv">20</span>),</span>
<span id="cb8-921"><a href="#cb8-921" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb8-922"><a href="#cb8-922" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-923"><a href="#cb8-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-924"><a href="#cb8-924" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> responder_non_responder_base <span class="sc">%&gt;%</span></span>
<span id="cb8-925"><a href="#cb8-925" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> change_ki67, <span class="at">y =</span> PC3)) <span class="sc">+</span></span>
<span id="cb8-926"><a href="#cb8-926" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb8-927"><a href="#cb8-927" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>) <span class="sc">+</span> </span>
<span id="cb8-928"><a href="#cb8-928" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>is_responder, <span class="at">scale =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb8-929"><a href="#cb8-929" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-930"><a href="#cb8-930" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Change in Ki67"</span>,</span>
<span id="cb8-931"><a href="#cb8-931" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Pearson correlation for each subgroup separately"</span></span>
<span id="cb8-932"><a href="#cb8-932" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-933"><a href="#cb8-933" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb8-934"><a href="#cb8-934" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb8-935"><a href="#cb8-935" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-936"><a href="#cb8-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-937"><a href="#cb8-937" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_label</span>(</span>
<span id="cb8-938"><a href="#cb8-938" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> cor_tests,</span>
<span id="cb8-939"><a href="#cb8-939" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">label =</span> label)</span>
<span id="cb8-940"><a href="#cb8-940" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-941"><a href="#cb8-941" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-942"><a href="#cb8-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-943"><a href="#cb8-943" aria-hidden="true" tabindex="-1"></a>Now another metric we can calculate from our dataset is the difference</span>
<span id="cb8-944"><a href="#cb8-944" aria-hidden="true" tabindex="-1"></a>of the embedding positions </span>
<span id="cb8-945"><a href="#cb8-945" aria-hidden="true" tabindex="-1"></a>between the different samples of the same patient. The idea is that if a </span>
<span id="cb8-946"><a href="#cb8-946" aria-hidden="true" tabindex="-1"></a>patient responded well, there were bigger changes as well in the</span>
<span id="cb8-947"><a href="#cb8-947" aria-hidden="true" tabindex="-1"></a>transcriptomics and that is reflected in the embedding. </span>
<span id="cb8-948"><a href="#cb8-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-949"><a href="#cb8-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-950"><a href="#cb8-950" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-diff-embedding-poetic</span></span>
<span id="cb8-951"><a href="#cb8-951" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Differences of the embeddings for each patient individually</span></span>
<span id="cb8-952"><a href="#cb8-952" aria-hidden="true" tabindex="-1"></a><span class="co">#|     stratified by response status. Each dot corresponds to a single patient.</span></span>
<span id="cb8-953"><a href="#cb8-953" aria-hidden="true" tabindex="-1"></a>diff_positions_poetic <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-954"><a href="#cb8-954" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-955"><a href="#cb8-955" aria-hidden="true" tabindex="-1"></a>                      is_responder <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"responder"</span>, <span class="st">"non_responder"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-956"><a href="#cb8-956" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb8-957"><a href="#cb8-957" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_cols =</span> <span class="fu">c</span>(patient_nb, is_responder, change_ki67),</span>
<span id="cb8-958"><a href="#cb8-958" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> timepoint, </span>
<span id="cb8-959"><a href="#cb8-959" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> <span class="fu">c</span>(PC3, PC4, ki67, SET_ERPR, HALLMARK_G2M_CHECKPOINT)</span>
<span id="cb8-960"><a href="#cb8-960" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-961"><a href="#cb8-961" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb8-962"><a href="#cb8-962" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff_positions =</span> <span class="fu">sqrt</span>(</span>
<span id="cb8-963"><a href="#cb8-963" aria-hidden="true" tabindex="-1"></a>            (PC3_baseline <span class="sc">-</span> PC3_surgery)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb8-964"><a href="#cb8-964" aria-hidden="true" tabindex="-1"></a>                (PC4_baseline <span class="sc">-</span> PC4_surgery)<span class="sc">^</span><span class="dv">2</span> </span>
<span id="cb8-965"><a href="#cb8-965" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-966"><a href="#cb8-966" aria-hidden="true" tabindex="-1"></a>        <span class="at">is_responder =</span> is_responder,</span>
<span id="cb8-967"><a href="#cb8-967" aria-hidden="true" tabindex="-1"></a>        <span class="at">change_ki67 =</span> change_ki67,</span>
<span id="cb8-968"><a href="#cb8-968" aria-hidden="true" tabindex="-1"></a>        <span class="at">ki67_baseline =</span> ki67_baseline,</span>
<span id="cb8-969"><a href="#cb8-969" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff_pc4 =</span> PC4_baseline <span class="sc">-</span> PC4_surgery,</span>
<span id="cb8-970"><a href="#cb8-970" aria-hidden="true" tabindex="-1"></a>        <span class="at">SET_ERPR =</span> SET_ERPR_baseline,</span>
<span id="cb8-971"><a href="#cb8-971" aria-hidden="true" tabindex="-1"></a>        <span class="at">G2M =</span> HALLMARK_G2M_CHECKPOINT_baseline,</span>
<span id="cb8-972"><a href="#cb8-972" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff_G2M =</span> HALLMARK_G2M_CHECKPOINT_baseline <span class="sc">-</span> </span>
<span id="cb8-973"><a href="#cb8-973" aria-hidden="true" tabindex="-1"></a>            HALLMARK_G2M_CHECKPOINT_surgery</span>
<span id="cb8-974"><a href="#cb8-974" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-975"><a href="#cb8-975" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> <span class="fu">factor</span>(</span>
<span id="cb8-976"><a href="#cb8-976" aria-hidden="true" tabindex="-1"></a>        is_responder, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"responder"</span>, <span class="st">"non_responder"</span>)</span>
<span id="cb8-977"><a href="#cb8-977" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb8-978"><a href="#cb8-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-979"><a href="#cb8-979" aria-hidden="true" tabindex="-1"></a>diff_positions_poetic <span class="sc">%&gt;%</span></span>
<span id="cb8-980"><a href="#cb8-980" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_responder, <span class="at">y =</span> diff_positions)) <span class="sc">+</span></span>
<span id="cb8-981"><a href="#cb8-981" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb8-982"><a href="#cb8-982" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span> </span>
<span id="cb8-983"><a href="#cb8-983" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-984"><a href="#cb8-984" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-985"><a href="#cb8-985" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Difference in positions of the embedding"</span></span>
<span id="cb8-986"><a href="#cb8-986" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-987"><a href="#cb8-987" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb8-988"><a href="#cb8-988" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb8-989"><a href="#cb8-989" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-990"><a href="#cb8-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-991"><a href="#cb8-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-992"><a href="#cb8-992" aria-hidden="true" tabindex="-1"></a>And now we perform a comparison of these positions by using</span>
<span id="cb8-993"><a href="#cb8-993" aria-hidden="true" tabindex="-1"></a>rstanarm to get the posterior distributions of the differences.</span>
<span id="cb8-994"><a href="#cb8-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-997"><a href="#cb8-997" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-998"><a href="#cb8-998" aria-hidden="true" tabindex="-1"></a>fit_differences <span class="ot">&lt;-</span> rstanarm<span class="sc">::</span><span class="fu">stan_glm</span>(</span>
<span id="cb8-999"><a href="#cb8-999" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> diff_positions <span class="sc">~</span> is_responder,</span>
<span id="cb8-1000"><a href="#cb8-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> diff_positions_poetic, </span>
<span id="cb8-1001"><a href="#cb8-1001" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span> </span>
<span id="cb8-1002"><a href="#cb8-1002" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1003"><a href="#cb8-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1004"><a href="#cb8-1004" aria-hidden="true" tabindex="-1"></a>diff_means <span class="ot">&lt;-</span> fit_differences <span class="sc">%&gt;%</span></span>
<span id="cb8-1005"><a href="#cb8-1005" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">spread_draws</span>(is_respondernon_responder)</span>
<span id="cb8-1006"><a href="#cb8-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1007"><a href="#cb8-1007" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> diff_positions_poetic <span class="sc">%&gt;%</span></span>
<span id="cb8-1008"><a href="#cb8-1008" aria-hidden="true" tabindex="-1"></a>    modelr<span class="sc">::</span><span class="fu">data_grid</span>(is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-1009"><a href="#cb8-1009" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">add_epred_draws</span>(fit_differences)</span>
<span id="cb8-1010"><a href="#cb8-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1011"><a href="#cb8-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1012"><a href="#cb8-1012" aria-hidden="true" tabindex="-1"></a>The figure below shows the distribution of the averages of the differences</span>
<span id="cb8-1013"><a href="#cb8-1013" aria-hidden="true" tabindex="-1"></a>in the embedding of the projections.</span>
<span id="cb8-1014"><a href="#cb8-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1017"><a href="#cb8-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1018"><a href="#cb8-1018" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-diff-embedding-poetic-averages</span></span>
<span id="cb8-1019"><a href="#cb8-1019" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Differences of the embeddings for each patient individually</span></span>
<span id="cb8-1020"><a href="#cb8-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#|     stratified by response status. Each dot corresponds to a single patient.</span></span>
<span id="cb8-1021"><a href="#cb8-1021" aria-hidden="true" tabindex="-1"></a>means <span class="sc">%&gt;%</span></span>
<span id="cb8-1022"><a href="#cb8-1022" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .epred, <span class="at">y =</span> is_responder)) <span class="sc">+</span></span>
<span id="cb8-1023"><a href="#cb8-1023" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">stat_dotsinterval</span>(<span class="at">quantiles =</span> <span class="dv">100</span>, <span class="at">overlaps =</span> <span class="st">"keep"</span>) <span class="sc">+</span> </span>
<span id="cb8-1024"><a href="#cb8-1024" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-1025"><a href="#cb8-1025" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Average distance of embedding positions"</span>,</span>
<span id="cb8-1026"><a href="#cb8-1026" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">""</span></span>
<span id="cb8-1027"><a href="#cb8-1027" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-1028"><a href="#cb8-1028" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb8-1029"><a href="#cb8-1029" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb8-1030"><a href="#cb8-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1031"><a href="#cb8-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1032"><a href="#cb8-1032" aria-hidden="true" tabindex="-1"></a>And the figure below shows the posterior distribution of the differences</span>
<span id="cb8-1033"><a href="#cb8-1033" aria-hidden="true" tabindex="-1"></a>in average.</span>
<span id="cb8-1034"><a href="#cb8-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1037"><a href="#cb8-1037" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1038"><a href="#cb8-1038" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-diff-embedding-poetic-averages-diff</span></span>
<span id="cb8-1039"><a href="#cb8-1039" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Differences of the average differences in the embedding for </span></span>
<span id="cb8-1040"><a href="#cb8-1040" aria-hidden="true" tabindex="-1"></a><span class="co">#|    each patient individually. The comparison made was non responder vs </span></span>
<span id="cb8-1041"><a href="#cb8-1041" aria-hidden="true" tabindex="-1"></a><span class="co">#|    responder, which means that if non responder has a lower difference in</span></span>
<span id="cb8-1042"><a href="#cb8-1042" aria-hidden="true" tabindex="-1"></a><span class="co">#|    average, the difference in difference will be negative.</span></span>
<span id="cb8-1043"><a href="#cb8-1043" aria-hidden="true" tabindex="-1"></a>diff_means <span class="sc">%&gt;%</span></span>
<span id="cb8-1044"><a href="#cb8-1044" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_respondernon_responder)) <span class="sc">+</span></span>
<span id="cb8-1045"><a href="#cb8-1045" aria-hidden="true" tabindex="-1"></a>    tidybayes<span class="sc">::</span><span class="fu">stat_dotsinterval</span>(<span class="at">quantiles =</span> <span class="dv">100</span>, <span class="at">overlaps =</span> <span class="st">"keep"</span>) <span class="sc">+</span></span>
<span id="cb8-1046"><a href="#cb8-1046" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb8-1047"><a href="#cb8-1047" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-1048"><a href="#cb8-1048" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Average difference of the embedding differences"</span>,</span>
<span id="cb8-1049"><a href="#cb8-1049" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb8-1050"><a href="#cb8-1050" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">""</span></span>
<span id="cb8-1051"><a href="#cb8-1051" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-1052"><a href="#cb8-1052" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb8-1053"><a href="#cb8-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1054"><a href="#cb8-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1055"><a href="#cb8-1055" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysing patient neighborhoods</span></span>
<span id="cb8-1056"><a href="#cb8-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1057"><a href="#cb8-1057" aria-hidden="true" tabindex="-1"></a>There are two ways to interpret the embedding. If the patient has</span>
<span id="cb8-1058"><a href="#cb8-1058" aria-hidden="true" tabindex="-1"></a>ER+ BC and its embedding is close to the ER- BC patients, we can</span>
<span id="cb8-1059"><a href="#cb8-1059" aria-hidden="true" tabindex="-1"></a>infer that the endocrine response might not work so well, as </span>
<span id="cb8-1060"><a href="#cb8-1060" aria-hidden="true" tabindex="-1"></a>it was shown in @fig-pca-responders-baseline. The other option</span>
<span id="cb8-1061"><a href="#cb8-1061" aria-hidden="true" tabindex="-1"></a>is to compare the patient's score to the average score of </span>
<span id="cb8-1062"><a href="#cb8-1062" aria-hidden="true" tabindex="-1"></a>its neighborhood.</span>
<span id="cb8-1063"><a href="#cb8-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1064"><a href="#cb8-1064" aria-hidden="true" tabindex="-1"></a>What is a neighborhood? When performing the embedding, global</span>
<span id="cb8-1065"><a href="#cb8-1065" aria-hidden="true" tabindex="-1"></a>structures are not preserved usually. In this sense we only</span>
<span id="cb8-1066"><a href="#cb8-1066" aria-hidden="true" tabindex="-1"></a>compare patients that are close to each other in an euclidean </span>
<span id="cb8-1067"><a href="#cb8-1067" aria-hidden="true" tabindex="-1"></a>neighborhood, i.e., we calculate a radius around each sample and</span>
<span id="cb8-1068"><a href="#cb8-1068" aria-hidden="true" tabindex="-1"></a>see what other samples are within this ball given the euclidean</span>
<span id="cb8-1069"><a href="#cb8-1069" aria-hidden="true" tabindex="-1"></a>distance.</span>
<span id="cb8-1070"><a href="#cb8-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1071"><a href="#cb8-1071" aria-hidden="true" tabindex="-1"></a>Given a neighborhood, one can calculate the posterior average score</span>
<span id="cb8-1072"><a href="#cb8-1072" aria-hidden="true" tabindex="-1"></a>of all samples from METABRIC, SCANB and TCGA and use that as an </span>
<span id="cb8-1073"><a href="#cb8-1073" aria-hidden="true" tabindex="-1"></a>indication of average score that we can compare other patients to.</span>
<span id="cb8-1074"><a href="#cb8-1074" aria-hidden="true" tabindex="-1"></a>The concept is that if an ER+ BC patient has a much lower ER signaling</span>
<span id="cb8-1075"><a href="#cb8-1075" aria-hidden="true" tabindex="-1"></a>score, it means the patients will not respond so well to endocrine </span>
<span id="cb8-1076"><a href="#cb8-1076" aria-hidden="true" tabindex="-1"></a>therapy, as they are very different from their neighboors.</span>
<span id="cb8-1077"><a href="#cb8-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1078"><a href="#cb8-1078" aria-hidden="true" tabindex="-1"></a>To showcase the ability to use the scores and infer results, we </span>
<span id="cb8-1079"><a href="#cb8-1079" aria-hidden="true" tabindex="-1"></a>use the POETIC trial patients to compare the scores. This cohort</span>
<span id="cb8-1080"><a href="#cb8-1080" aria-hidden="true" tabindex="-1"></a>is special in the sense that the patients are filtered based on</span>
<span id="cb8-1081"><a href="#cb8-1081" aria-hidden="true" tabindex="-1"></a>selection criterias, meaning that the patients are clinically</span>
<span id="cb8-1082"><a href="#cb8-1082" aria-hidden="true" tabindex="-1"></a>similar. </span>
<span id="cb8-1083"><a href="#cb8-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1084"><a href="#cb8-1084" aria-hidden="true" tabindex="-1"></a>Two random patients in very close neighborhoods were selected</span>
<span id="cb8-1085"><a href="#cb8-1085" aria-hidden="true" tabindex="-1"></a>to showcase the ability of the molecular landscape.</span>
<span id="cb8-1086"><a href="#cb8-1086" aria-hidden="true" tabindex="-1"></a>The id of the patients are 63 and 236.</span>
<span id="cb8-1087"><a href="#cb8-1087" aria-hidden="true" tabindex="-1"></a>@tbl-pt63-236 shows the clinical features of these patients. One</span>
<span id="cb8-1088"><a href="#cb8-1088" aria-hidden="true" tabindex="-1"></a>of them is HER2+. Patient 63 had a higher Ki67 baseline level but</span>
<span id="cb8-1089"><a href="#cb8-1089" aria-hidden="true" tabindex="-1"></a>a very good response to endocrine therapy. Patient 236 did not </span>
<span id="cb8-1090"><a href="#cb8-1090" aria-hidden="true" tabindex="-1"></a>respond to endocrine therapy in terms of reduction of Ki67 levels.</span>
<span id="cb8-1091"><a href="#cb8-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1094"><a href="#cb8-1094" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1095"><a href="#cb8-1095" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-pt63-236</span></span>
<span id="cb8-1096"><a href="#cb8-1096" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: Clinical features from patients 63 and 236. </span></span>
<span id="cb8-1097"><a href="#cb8-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1098"><a href="#cb8-1098" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"treated_nb63_baseline"</span>, <span class="st">"treated_nb236_baseline"</span>)</span>
<span id="cb8-1099"><a href="#cb8-1099" aria-hidden="true" tabindex="-1"></a>poetic_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-1100"><a href="#cb8-1100" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb8-1101"><a href="#cb8-1101" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> patients) <span class="sc">%&gt;%</span></span>
<span id="cb8-1102"><a href="#cb8-1102" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb8-1103"><a href="#cb8-1103" aria-hidden="true" tabindex="-1"></a>        patient_nb, er_status, her2_status, ki67, change_ki67, </span>
<span id="cb8-1104"><a href="#cb8-1104" aria-hidden="true" tabindex="-1"></a>        ccca_surgery_ki67_2_7</span>
<span id="cb8-1105"><a href="#cb8-1105" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1106"><a href="#cb8-1106" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">row.names =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1107"><a href="#cb8-1107" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>()</span>
<span id="cb8-1108"><a href="#cb8-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1109"><a href="#cb8-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1110"><a href="#cb8-1110" aria-hidden="true" tabindex="-1"></a>@fig-pt63-236 shows the embedding of two distinct patients </span>
<span id="cb8-1111"><a href="#cb8-1111" aria-hidden="true" tabindex="-1"></a>in a similar neighborhood.</span>
<span id="cb8-1112"><a href="#cb8-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1113"><a href="#cb8-1113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1114"><a href="#cb8-1114" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pt63-236</span></span>
<span id="cb8-1115"><a href="#cb8-1115" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Plot of two selected patients in the molecular landscape. One</span></span>
<span id="cb8-1116"><a href="#cb8-1116" aria-hidden="true" tabindex="-1"></a><span class="co">#|     is a responder and the other is a non responder. The patient id numbers</span></span>
<span id="cb8-1117"><a href="#cb8-1117" aria-hidden="true" tabindex="-1"></a><span class="co">#|     are 63 and 236.</span></span>
<span id="cb8-1118"><a href="#cb8-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1119"><a href="#cb8-1119" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"treated_nb63_baseline"</span>, <span class="st">"treated_nb236_baseline"</span>)</span>
<span id="cb8-1120"><a href="#cb8-1120" aria-hidden="true" tabindex="-1"></a>remove_patients <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(datasets<span class="sc">$</span>poetic <span class="sc">%&gt;%</span> colnames, patients)</span>
<span id="cb8-1121"><a href="#cb8-1121" aria-hidden="true" tabindex="-1"></a>poetic_df_pca_baseline <span class="ot">&lt;-</span> poetic_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-1122"><a href="#cb8-1122" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(sample_name <span class="sc">%in%</span> remove_patients))</span>
<span id="cb8-1123"><a href="#cb8-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1124"><a href="#cb8-1124" aria-hidden="true" tabindex="-1"></a>base_plot <span class="ot">&lt;-</span> <span class="fu">get_base_plot</span>(</span>
<span id="cb8-1125"><a href="#cb8-1125" aria-hidden="true" tabindex="-1"></a>    poetic_df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb8-1126"><a href="#cb8-1126" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tcga"</span>, <span class="st">"metabric"</span>, <span class="st">"scanb"</span>)),</span>
<span id="cb8-1127"><a href="#cb8-1127" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_dots =</span> <span class="dv">2</span>,</span>
<span id="cb8-1128"><a href="#cb8-1128" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha_val =</span> <span class="fl">0.1</span>,</span>
<span id="cb8-1129"><a href="#cb8-1129" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_legend =</span> <span class="dv">4</span>,</span>
<span id="cb8-1130"><a href="#cb8-1130" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span></span>
<span id="cb8-1131"><a href="#cb8-1131" aria-hidden="true" tabindex="-1"></a>)    </span>
<span id="cb8-1132"><a href="#cb8-1132" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> poetic_df_pca_baseline <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"poetic"</span>)</span>
<span id="cb8-1133"><a href="#cb8-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1134"><a href="#cb8-1134" aria-hidden="true" tabindex="-1"></a>plot_patients <span class="ot">&lt;-</span> base_plot <span class="sc">+</span> </span>
<span id="cb8-1135"><a href="#cb8-1135" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb8-1136"><a href="#cb8-1136" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df,</span>
<span id="cb8-1137"><a href="#cb8-1137" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb8-1138"><a href="#cb8-1138" aria-hidden="true" tabindex="-1"></a>            <span class="at">shape =</span> timepoint,</span>
<span id="cb8-1139"><a href="#cb8-1139" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="cn">NA</span>,</span>
<span id="cb8-1140"><a href="#cb8-1140" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> is_responder</span>
<span id="cb8-1141"><a href="#cb8-1141" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1142"><a href="#cb8-1142" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">7</span>,</span>
<span id="cb8-1143"><a href="#cb8-1143" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> <span class="dv">22</span></span>
<span id="cb8-1144"><a href="#cb8-1144" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-1145"><a href="#cb8-1145" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb8-1146"><a href="#cb8-1146" aria-hidden="true" tabindex="-1"></a>    ggrepel<span class="sc">::</span><span class="fu">geom_label_repel</span>(</span>
<span id="cb8-1147"><a href="#cb8-1147" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">patient_nb =</span> <span class="fu">paste0</span>(<span class="st">"#"</span>, patient_nb)),</span>
<span id="cb8-1148"><a href="#cb8-1148" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">label =</span> patient_nb),</span>
<span id="cb8-1149"><a href="#cb8-1149" aria-hidden="true" tabindex="-1"></a>        <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-1150"><a href="#cb8-1150" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb8-1151"><a href="#cb8-1151" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.padding =</span> <span class="fl">0.5</span></span>
<span id="cb8-1152"><a href="#cb8-1152" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-1153"><a href="#cb8-1153" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-1154"><a href="#cb8-1154" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-1155"><a href="#cb8-1155" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1156"><a href="#cb8-1156" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Responder status for each patient in the baseline</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb8-1157"><a href="#cb8-1157" aria-hidden="true" tabindex="-1"></a>            <span class="st">"and treated group"</span></span>
<span id="cb8-1158"><a href="#cb8-1158" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1159"><a href="#cb8-1159" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1160"><a href="#cb8-1160" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Responder is defined as having at least 5% baseline Ki67</span><span class="sc">\n</span><span class="st">and"</span>,</span>
<span id="cb8-1161"><a href="#cb8-1161" aria-hidden="true" tabindex="-1"></a>            <span class="st">" reduction of at least 60% in Ki67 levels"</span></span>
<span id="cb8-1162"><a href="#cb8-1162" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-1163"><a href="#cb8-1163" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-1164"><a href="#cb8-1164" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb8-1165"><a href="#cb8-1165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb8-1166"><a href="#cb8-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1167"><a href="#cb8-1167" aria-hidden="true" tabindex="-1"></a>plot_patients</span>
<span id="cb8-1168"><a href="#cb8-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1169"><a href="#cb8-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1170"><a href="#cb8-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1171"><a href="#cb8-1171" aria-hidden="true" tabindex="-1"></a>And now we calculate the average scores for each patient neighborhoods. We </span>
<span id="cb8-1172"><a href="#cb8-1172" aria-hidden="true" tabindex="-1"></a>start by defining a radius value. After that we select the patients in the</span>
<span id="cb8-1173"><a href="#cb8-1173" aria-hidden="true" tabindex="-1"></a>neighborhood and use <span class="in">`rstanarm`</span> to get the posterior distribution of the</span>
<span id="cb8-1174"><a href="#cb8-1174" aria-hidden="true" tabindex="-1"></a>average score in the neighborhood. For this we use the function</span>
<span id="cb8-1175"><a href="#cb8-1175" aria-hidden="true" tabindex="-1"></a><span class="in">`stan_glm`</span> to calculate the average. This is effective because it can</span>
<span id="cb8-1176"><a href="#cb8-1176" aria-hidden="true" tabindex="-1"></a>be paired with the package <span class="in">`tidybayes`</span> for plotting. It makes extremely easy</span>
<span id="cb8-1177"><a href="#cb8-1177" aria-hidden="true" tabindex="-1"></a>to deal with posterior data. For the average we use a </span>
<span id="cb8-1178"><a href="#cb8-1178" aria-hidden="true" tabindex="-1"></a>normal prior centered at 0 with 1 standard deviation, </span>
<span id="cb8-1179"><a href="#cb8-1179" aria-hidden="true" tabindex="-1"></a>since all scores are between -1 and 1.</span>
<span id="cb8-1180"><a href="#cb8-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1183"><a href="#cb8-1183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1184"><a href="#cb8-1184" aria-hidden="true" tabindex="-1"></a>scores_to_use <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-1185"><a href="#cb8-1185" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estrogen response early"</span>,</span>
<span id="cb8-1186"><a href="#cb8-1186" aria-hidden="true" tabindex="-1"></a>    <span class="st">"E2F targets"</span>,</span>
<span id="cb8-1187"><a href="#cb8-1187" aria-hidden="true" tabindex="-1"></a>    <span class="st">"P53 pathway"</span>,</span>
<span id="cb8-1188"><a href="#cb8-1188" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EMT"</span>,</span>
<span id="cb8-1189"><a href="#cb8-1189" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Androgen response"</span>,</span>
<span id="cb8-1190"><a href="#cb8-1190" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TGFb signaling"</span>,</span>
<span id="cb8-1191"><a href="#cb8-1191" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET ER/PR"</span></span>
<span id="cb8-1192"><a href="#cb8-1192" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">c</span>(</span>
<span id="cb8-1193"><a href="#cb8-1193" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb8-1194"><a href="#cb8-1194" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_E2F_TARGETS"</span>,</span>
<span id="cb8-1195"><a href="#cb8-1195" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_P53_PATHWAY"</span>,</span>
<span id="cb8-1196"><a href="#cb8-1196" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION"</span>,</span>
<span id="cb8-1197"><a href="#cb8-1197" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_ANDROGEN_RESPONSE"</span>,</span>
<span id="cb8-1198"><a href="#cb8-1198" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HALLMARK_TGF_BETA_SIGNALING"</span>,</span>
<span id="cb8-1199"><a href="#cb8-1199" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span></span>
<span id="cb8-1200"><a href="#cb8-1200" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb8-1201"><a href="#cb8-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1202"><a href="#cb8-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1203"><a href="#cb8-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1204"><a href="#cb8-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb8-1205"><a href="#cb8-1205" aria-hidden="true" tabindex="-1"></a>patients_all <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-1206"><a href="#cb8-1206" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(timepoint <span class="sc">==</span> <span class="st">"baseline"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-1207"><a href="#cb8-1207" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">grepl</span>(<span class="st">"^treated"</span>, sample_name)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1208"><a href="#cb8-1208" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb8-1209"><a href="#cb8-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1210"><a href="#cb8-1210" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"treated_nb63_baseline"</span>, <span class="st">"treated_nb236_baseline"</span>)</span>
<span id="cb8-1211"><a href="#cb8-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1212"><a href="#cb8-1212" aria-hidden="true" tabindex="-1"></a>pipeline_scores_plots <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb8-1213"><a href="#cb8-1213" aria-hidden="true" tabindex="-1"></a>    patients_all, </span>
<span id="cb8-1214"><a href="#cb8-1214" aria-hidden="true" tabindex="-1"></a>    get_patient_scores_distributions_all,</span>
<span id="cb8-1215"><a href="#cb8-1215" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> poetic_df_pca,</span>
<span id="cb8-1216"><a href="#cb8-1216" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_to_use =</span> scores_to_use,</span>
<span id="cb8-1217"><a href="#cb8-1217" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">20</span>,</span>
<span id="cb8-1218"><a href="#cb8-1218" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-1219"><a href="#cb8-1219" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb8-1220"><a href="#cb8-1220" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1221"><a href="#cb8-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1222"><a href="#cb8-1222" aria-hidden="true" tabindex="-1"></a>pipeline_scores_plots_er_only <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb8-1223"><a href="#cb8-1223" aria-hidden="true" tabindex="-1"></a>    patients_all, </span>
<span id="cb8-1224"><a href="#cb8-1224" aria-hidden="true" tabindex="-1"></a>    get_patient_scores_distributions_all,</span>
<span id="cb8-1225"><a href="#cb8-1225" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> poetic_df_pca,</span>
<span id="cb8-1226"><a href="#cb8-1226" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores_to_use =</span> scores_to_use[</span>
<span id="cb8-1227"><a href="#cb8-1227" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>, <span class="st">"SET_ERPR"</span>)</span>
<span id="cb8-1228"><a href="#cb8-1228" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb8-1229"><a href="#cb8-1229" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">20</span>,</span>
<span id="cb8-1230"><a href="#cb8-1230" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-1231"><a href="#cb8-1231" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb8-1232"><a href="#cb8-1232" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1233"><a href="#cb8-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1234"><a href="#cb8-1234" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-1235"><a href="#cb8-1235" aria-hidden="true" tabindex="-1"></a>    pipeline_scores_plots,</span>
<span id="cb8-1236"><a href="#cb8-1236" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/pipeline_scores_plots.rds"</span></span>
<span id="cb8-1237"><a href="#cb8-1237" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1238"><a href="#cb8-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1239"><a href="#cb8-1239" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-1240"><a href="#cb8-1240" aria-hidden="true" tabindex="-1"></a>    pipeline_scores_plots_er_only,</span>
<span id="cb8-1241"><a href="#cb8-1241" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/pipeline_scores_plots_er_only.rds"</span></span>
<span id="cb8-1242"><a href="#cb8-1242" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1243"><a href="#cb8-1243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1244"><a href="#cb8-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1245"><a href="#cb8-1245" aria-hidden="true" tabindex="-1"></a>Patient 63 @fig-pt63 is considered a responder. According to </span>
<span id="cb8-1246"><a href="#cb8-1246" aria-hidden="true" tabindex="-1"></a>the scores, when comparing the estrogen early signature to its average </span>
<span id="cb8-1247"><a href="#cb8-1247" aria-hidden="true" tabindex="-1"></a>distribution in the neighborhood, the score is higher.</span>
<span id="cb8-1248"><a href="#cb8-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1249"><a href="#cb8-1249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=7, fig.width=10}</span></span>
<span id="cb8-1250"><a href="#cb8-1250" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pt63</span></span>
<span id="cb8-1251"><a href="#cb8-1251" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Posterior distribution of the average scores in the neighborhood</span></span>
<span id="cb8-1252"><a href="#cb8-1252" aria-hidden="true" tabindex="-1"></a><span class="co">#|     of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.</span></span>
<span id="cb8-1253"><a href="#cb8-1253" aria-hidden="true" tabindex="-1"></a>pipeline_scores_plots<span class="sc">$</span>treated_nb63_baseline<span class="sc">$</span>plot <span class="sc">+</span></span>
<span id="cb8-1254"><a href="#cb8-1254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb8-1255"><a href="#cb8-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1256"><a href="#cb8-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1257"><a href="#cb8-1257" aria-hidden="true" tabindex="-1"></a>Patient 236 @fig-pt236 was considered a non responder. According to </span>
<span id="cb8-1258"><a href="#cb8-1258" aria-hidden="true" tabindex="-1"></a>the scores, when comparing the estrogen early signature to its average </span>
<span id="cb8-1259"><a href="#cb8-1259" aria-hidden="true" tabindex="-1"></a>distribution in the neighborhood, the score is lower, being in the</span>
<span id="cb8-1260"><a href="#cb8-1260" aria-hidden="true" tabindex="-1"></a>5% quantile.</span>
<span id="cb8-1261"><a href="#cb8-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1262"><a href="#cb8-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=7, fig.width=10}</span></span>
<span id="cb8-1263"><a href="#cb8-1263" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pt236</span></span>
<span id="cb8-1264"><a href="#cb8-1264" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Posterior distribution of the average scores in the neighborhood</span></span>
<span id="cb8-1265"><a href="#cb8-1265" aria-hidden="true" tabindex="-1"></a><span class="co">#|     of patient 236 from POETIC trial. Each dot corresponds to a 1% quantile.</span></span>
<span id="cb8-1266"><a href="#cb8-1266" aria-hidden="true" tabindex="-1"></a>pipeline_scores_plots<span class="sc">$</span>treated_nb236_baseline<span class="sc">$</span>plot <span class="sc">+</span></span>
<span id="cb8-1267"><a href="#cb8-1267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb8-1268"><a href="#cb8-1268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1269"><a href="#cb8-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1270"><a href="#cb8-1270" aria-hidden="true" tabindex="-1"></a>When comparing these two patients, there is also a difference in the androgen</span>
<span id="cb8-1271"><a href="#cb8-1271" aria-hidden="true" tabindex="-1"></a>response score, which could be a reflection of different estrogen signaling.</span>
<span id="cb8-1272"><a href="#cb8-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1273"><a href="#cb8-1273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Matching other responders and non-responders</span></span>
<span id="cb8-1274"><a href="#cb8-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1275"><a href="#cb8-1275" aria-hidden="true" tabindex="-1"></a>In this section we now match all the responders and non-responders in a </span>
<span id="cb8-1276"><a href="#cb8-1276" aria-hidden="true" tabindex="-1"></a>close neighbourhood and try to do a similar analysis. We use</span>
<span id="cb8-1277"><a href="#cb8-1277" aria-hidden="true" tabindex="-1"></a>a threshold of 0.5 for samples close enough, which corresponds to the</span>
<span id="cb8-1278"><a href="#cb8-1278" aria-hidden="true" tabindex="-1"></a>1% percentile.</span>
<span id="cb8-1279"><a href="#cb8-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1282"><a href="#cb8-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1283"><a href="#cb8-1283" aria-hidden="true" tabindex="-1"></a>distances_samples_poetic <span class="ot">&lt;-</span> <span class="fu">dist</span>(</span>
<span id="cb8-1284"><a href="#cb8-1284" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-1285"><a href="#cb8-1285" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-1286"><a href="#cb8-1286" aria-hidden="true" tabindex="-1"></a>            cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-1287"><a href="#cb8-1287" aria-hidden="true" tabindex="-1"></a>                timepoint <span class="sc">==</span> <span class="st">"baseline"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-1288"><a href="#cb8-1288" aria-hidden="true" tabindex="-1"></a>                is_responder <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"responder"</span>, <span class="st">"non_responder"</span>)</span>
<span id="cb8-1289"><a href="#cb8-1289" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1290"><a href="#cb8-1290" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"PC3"</span>, <span class="st">"PC4"</span>))), </span>
<span id="cb8-1291"><a href="#cb8-1291" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"euclidean"</span>,</span>
<span id="cb8-1292"><a href="#cb8-1292" aria-hidden="true" tabindex="-1"></a>    <span class="at">diag =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-1293"><a href="#cb8-1293" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="cn">FALSE</span></span>
<span id="cb8-1294"><a href="#cb8-1294" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> as.matrix <span class="sc">%&gt;%</span></span>
<span id="cb8-1295"><a href="#cb8-1295" aria-hidden="true" tabindex="-1"></a>    data.frame </span>
<span id="cb8-1296"><a href="#cb8-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1297"><a href="#cb8-1297" aria-hidden="true" tabindex="-1"></a>distances_samples_poetic[<span class="fu">upper.tri</span>(distances_samples_poetic)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb8-1298"><a href="#cb8-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1299"><a href="#cb8-1299" aria-hidden="true" tabindex="-1"></a>distances_samples_poetic <span class="ot">&lt;-</span> distances_samples_poetic <span class="sc">%&gt;%</span></span>
<span id="cb8-1300"><a href="#cb8-1300" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"first_sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1301"><a href="#cb8-1301" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_name =</span> first_sample_name)</span>
<span id="cb8-1302"><a href="#cb8-1302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1303"><a href="#cb8-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1306"><a href="#cb8-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1307"><a href="#cb8-1307" aria-hidden="true" tabindex="-1"></a>cols_to_not_pivot <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-1308"><a href="#cb8-1308" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample_name"</span>, <span class="st">"is_responder"</span>, <span class="st">"ki67"</span>, <span class="st">"change_ki67"</span>, <span class="st">"first_sample_name"</span></span>
<span id="cb8-1309"><a href="#cb8-1309" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1310"><a href="#cb8-1310" aria-hidden="true" tabindex="-1"></a>distances_samples_poetic_long <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb8-1311"><a href="#cb8-1311" aria-hidden="true" tabindex="-1"></a>        distances_samples_poetic, </span>
<span id="cb8-1312"><a href="#cb8-1312" aria-hidden="true" tabindex="-1"></a>        df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-1313"><a href="#cb8-1313" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb8-1314"><a href="#cb8-1314" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sample_name"</span>, <span class="st">"is_responder"</span>, <span class="st">"ki67"</span>, <span class="st">"change_ki67"</span></span>
<span id="cb8-1315"><a href="#cb8-1315" aria-hidden="true" tabindex="-1"></a>            ))),</span>
<span id="cb8-1316"><a href="#cb8-1316" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb8-1317"><a href="#cb8-1317" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1318"><a href="#cb8-1318" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb8-1319"><a href="#cb8-1319" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">setdiff</span>(<span class="fu">colnames</span>(.), cols_to_not_pivot)),</span>
<span id="cb8-1320"><a href="#cb8-1320" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"second_sample_name"</span>,</span>
<span id="cb8-1321"><a href="#cb8-1321" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"distance"</span></span>
<span id="cb8-1322"><a href="#cb8-1322" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-1323"><a href="#cb8-1323" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(distance <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1324"><a href="#cb8-1324" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb8-1325"><a href="#cb8-1325" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb8-1326"><a href="#cb8-1326" aria-hidden="true" tabindex="-1"></a>        df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-1327"><a href="#cb8-1327" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">second_sample_name =</span> sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1328"><a href="#cb8-1328" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb8-1329"><a href="#cb8-1329" aria-hidden="true" tabindex="-1"></a>                <span class="st">"second_sample_name"</span>, <span class="st">"is_responder"</span>, <span class="st">"ki67"</span>, <span class="st">"change_ki67"</span></span>
<span id="cb8-1330"><a href="#cb8-1330" aria-hidden="true" tabindex="-1"></a>            ))),</span>
<span id="cb8-1331"><a href="#cb8-1331" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"second_sample_name"</span>,  </span>
<span id="cb8-1332"><a href="#cb8-1332" aria-hidden="true" tabindex="-1"></a>        <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_first"</span>, <span class="st">"_second"</span>)</span>
<span id="cb8-1333"><a href="#cb8-1333" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb8-1334"><a href="#cb8-1334" aria-hidden="true" tabindex="-1"></a>close_samples_poetic <span class="ot">&lt;-</span> distances_samples_poetic_long <span class="sc">%&gt;%</span></span>
<span id="cb8-1335"><a href="#cb8-1335" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-1336"><a href="#cb8-1336" aria-hidden="true" tabindex="-1"></a>        distance <span class="sc">&lt;</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> </span>
<span id="cb8-1337"><a href="#cb8-1337" aria-hidden="true" tabindex="-1"></a>            is_responder_first <span class="sc">!=</span> is_responder_second</span>
<span id="cb8-1338"><a href="#cb8-1338" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-1339"><a href="#cb8-1339" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb8-1340"><a href="#cb8-1340" aria-hidden="true" tabindex="-1"></a>        first_sample_name, </span>
<span id="cb8-1341"><a href="#cb8-1341" aria-hidden="true" tabindex="-1"></a>        second_sample_name, </span>
<span id="cb8-1342"><a href="#cb8-1342" aria-hidden="true" tabindex="-1"></a>        is_responder_first, </span>
<span id="cb8-1343"><a href="#cb8-1343" aria-hidden="true" tabindex="-1"></a>        is_responder_second,</span>
<span id="cb8-1344"><a href="#cb8-1344" aria-hidden="true" tabindex="-1"></a>        change_ki67_first,</span>
<span id="cb8-1345"><a href="#cb8-1345" aria-hidden="true" tabindex="-1"></a>        change_ki67_second,</span>
<span id="cb8-1346"><a href="#cb8-1346" aria-hidden="true" tabindex="-1"></a>        ki67_first,</span>
<span id="cb8-1347"><a href="#cb8-1347" aria-hidden="true" tabindex="-1"></a>        ki67_second</span>
<span id="cb8-1348"><a href="#cb8-1348" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb8-1349"><a href="#cb8-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1350"><a href="#cb8-1350" aria-hidden="true" tabindex="-1"></a>close_samples_poetic <span class="sc">%&gt;%</span></span>
<span id="cb8-1351"><a href="#cb8-1351" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>()</span>
<span id="cb8-1352"><a href="#cb8-1352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1353"><a href="#cb8-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1356"><a href="#cb8-1356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1357"><a href="#cb8-1357" aria-hidden="true" tabindex="-1"></a>unique_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-1358"><a href="#cb8-1358" aria-hidden="true" tabindex="-1"></a>    close_samples_poetic<span class="sc">$</span>first_sample_name, </span>
<span id="cb8-1359"><a href="#cb8-1359" aria-hidden="true" tabindex="-1"></a>    close_samples_poetic<span class="sc">$</span>second_sample_name</span>
<span id="cb8-1360"><a href="#cb8-1360" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> unique </span>
<span id="cb8-1361"><a href="#cb8-1361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1362"><a href="#cb8-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1363"><a href="#cb8-1363" aria-hidden="true" tabindex="-1"></a>In total there is number of 38 neighborhoods that we will analyse with</span>
<span id="cb8-1364"><a href="#cb8-1364" aria-hidden="true" tabindex="-1"></a>a total of <span class="in">`r length(unique_samples)`</span> unique samples, with a total of </span>
<span id="cb8-1365"><a href="#cb8-1365" aria-hidden="true" tabindex="-1"></a>32 responders and 24 non-responders, meaning that some responders</span>
<span id="cb8-1366"><a href="#cb8-1366" aria-hidden="true" tabindex="-1"></a>they share non-responders.</span>
<span id="cb8-1367"><a href="#cb8-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1368"><a href="#cb8-1368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb8-1369"><a href="#cb8-1369" aria-hidden="true" tabindex="-1"></a>plots_scores_close_patients <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb8-1370"><a href="#cb8-1370" aria-hidden="true" tabindex="-1"></a>    close_samples_poetic, </span>
<span id="cb8-1371"><a href="#cb8-1371" aria-hidden="true" tabindex="-1"></a>    <span class="at">MARGIN =</span> <span class="dv">1</span>,</span>
<span id="cb8-1372"><a href="#cb8-1372" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(info_patients, plots){</span>
<span id="cb8-1373"><a href="#cb8-1373" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1374"><a href="#cb8-1374" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the plots and modify the titles so we can put them together</span></span>
<span id="cb8-1375"><a href="#cb8-1375" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for visualization. let us stick with responder first and</span></span>
<span id="cb8-1376"><a href="#cb8-1376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># non-responder as second to make it easier to analyse afterwards</span></span>
<span id="cb8-1377"><a href="#cb8-1377" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1378"><a href="#cb8-1378" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">which</span>(info_patients <span class="sc">==</span> <span class="st">"responder"</span>) <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="cb8-1379"><a href="#cb8-1379" aria-hidden="true" tabindex="-1"></a>            which_responder <span class="ot">&lt;-</span> <span class="st">"first"</span></span>
<span id="cb8-1380"><a href="#cb8-1380" aria-hidden="true" tabindex="-1"></a>            which_non_responder <span class="ot">&lt;-</span> <span class="st">"second"</span></span>
<span id="cb8-1381"><a href="#cb8-1381" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb8-1382"><a href="#cb8-1382" aria-hidden="true" tabindex="-1"></a>            which_responder <span class="ot">&lt;-</span> <span class="st">"second"</span></span>
<span id="cb8-1383"><a href="#cb8-1383" aria-hidden="true" tabindex="-1"></a>            which_non_responder <span class="ot">&lt;-</span> <span class="st">"first"</span></span>
<span id="cb8-1384"><a href="#cb8-1384" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-1385"><a href="#cb8-1385" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1386"><a href="#cb8-1386" aria-hidden="true" tabindex="-1"></a>        plot_responder <span class="ot">&lt;-</span> plots[[</span>
<span id="cb8-1387"><a href="#cb8-1387" aria-hidden="true" tabindex="-1"></a>            info_patients[<span class="fu">paste0</span>(which_responder, <span class="st">"_sample_name"</span>)]</span>
<span id="cb8-1388"><a href="#cb8-1388" aria-hidden="true" tabindex="-1"></a>        ]]<span class="sc">$</span>plot</span>
<span id="cb8-1389"><a href="#cb8-1389" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1390"><a href="#cb8-1390" aria-hidden="true" tabindex="-1"></a>        plot_non_responder <span class="ot">&lt;-</span> plots[[</span>
<span id="cb8-1391"><a href="#cb8-1391" aria-hidden="true" tabindex="-1"></a>            info_patients[<span class="fu">paste0</span>(which_non_responder, <span class="st">"_sample_name"</span>)]</span>
<span id="cb8-1392"><a href="#cb8-1392" aria-hidden="true" tabindex="-1"></a>        ]]<span class="sc">$</span>plot</span>
<span id="cb8-1393"><a href="#cb8-1393" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1394"><a href="#cb8-1394" aria-hidden="true" tabindex="-1"></a>        <span class="co"># now we change the titles to include the information of interest.</span></span>
<span id="cb8-1395"><a href="#cb8-1395" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1396"><a href="#cb8-1396" aria-hidden="true" tabindex="-1"></a>        plot_responder <span class="ot">&lt;-</span> plot_responder <span class="sc">+</span></span>
<span id="cb8-1397"><a href="#cb8-1397" aria-hidden="true" tabindex="-1"></a>            ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-1398"><a href="#cb8-1398" aria-hidden="true" tabindex="-1"></a>                <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1399"><a href="#cb8-1399" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(which_responder, <span class="st">"_sample_name"</span>)],</span>
<span id="cb8-1400"><a href="#cb8-1400" aria-hidden="true" tabindex="-1"></a>                    <span class="st">", "</span>,</span>
<span id="cb8-1401"><a href="#cb8-1401" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(<span class="st">"is_responder_"</span>, which_responder)]</span>
<span id="cb8-1402"><a href="#cb8-1402" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb8-1403"><a href="#cb8-1403" aria-hidden="true" tabindex="-1"></a>                <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1404"><a href="#cb8-1404" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Ki67 baseline: "</span>, </span>
<span id="cb8-1405"><a href="#cb8-1405" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(<span class="st">"ki67_"</span>, which_responder)],</span>
<span id="cb8-1406"><a href="#cb8-1406" aria-hidden="true" tabindex="-1"></a>                    <span class="st">", Change Ki67: "</span>, </span>
<span id="cb8-1407"><a href="#cb8-1407" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(<span class="st">"change_ki67_"</span>, which_responder)]</span>
<span id="cb8-1408"><a href="#cb8-1408" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-1409"><a href="#cb8-1409" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-1410"><a href="#cb8-1410" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1411"><a href="#cb8-1411" aria-hidden="true" tabindex="-1"></a>        plot_non_responder <span class="ot">&lt;-</span> plot_non_responder <span class="sc">+</span></span>
<span id="cb8-1412"><a href="#cb8-1412" aria-hidden="true" tabindex="-1"></a>            ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-1413"><a href="#cb8-1413" aria-hidden="true" tabindex="-1"></a>                <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1414"><a href="#cb8-1414" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(which_non_responder, <span class="st">"_sample_name"</span>)],</span>
<span id="cb8-1415"><a href="#cb8-1415" aria-hidden="true" tabindex="-1"></a>                    <span class="st">", "</span>,</span>
<span id="cb8-1416"><a href="#cb8-1416" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(<span class="st">"is_responder_"</span>, which_non_responder)]</span>
<span id="cb8-1417"><a href="#cb8-1417" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb8-1418"><a href="#cb8-1418" aria-hidden="true" tabindex="-1"></a>                <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1419"><a href="#cb8-1419" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Ki67 baseline: "</span>, </span>
<span id="cb8-1420"><a href="#cb8-1420" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(<span class="st">"ki67_"</span>, which_non_responder)],</span>
<span id="cb8-1421"><a href="#cb8-1421" aria-hidden="true" tabindex="-1"></a>                    <span class="st">", Change Ki67: "</span>, </span>
<span id="cb8-1422"><a href="#cb8-1422" aria-hidden="true" tabindex="-1"></a>                    info_patients[<span class="fu">paste0</span>(<span class="st">"change_ki67_"</span>, which_non_responder)]</span>
<span id="cb8-1423"><a href="#cb8-1423" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-1424"><a href="#cb8-1424" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-1425"><a href="#cb8-1425" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1426"><a href="#cb8-1426" aria-hidden="true" tabindex="-1"></a>        p <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb8-1427"><a href="#cb8-1427" aria-hidden="true" tabindex="-1"></a>            plot_responder,</span>
<span id="cb8-1428"><a href="#cb8-1428" aria-hidden="true" tabindex="-1"></a>            plot_non_responder,</span>
<span id="cb8-1429"><a href="#cb8-1429" aria-hidden="true" tabindex="-1"></a>            <span class="at">nrow =</span> <span class="dv">2</span></span>
<span id="cb8-1430"><a href="#cb8-1430" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-1431"><a href="#cb8-1431" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1432"><a href="#cb8-1432" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">responder =</span> plot_responder, <span class="at">non_responder =</span> plot_non_responder)</span>
<span id="cb8-1433"><a href="#cb8-1433" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1434"><a href="#cb8-1434" aria-hidden="true" tabindex="-1"></a>    }, </span>
<span id="cb8-1435"><a href="#cb8-1435" aria-hidden="true" tabindex="-1"></a>    <span class="at">plots =</span> pipeline_scores_plots,</span>
<span id="cb8-1436"><a href="#cb8-1436" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb8-1437"><a href="#cb8-1437" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1438"><a href="#cb8-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1439"><a href="#cb8-1439" aria-hidden="true" tabindex="-1"></a><span class="co"># a means above, m means middle and b means below</span></span>
<span id="cb8-1440"><a href="#cb8-1440" aria-hidden="true" tabindex="-1"></a>comparison_to_average_neighbors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-1441"><a href="#cb8-1441" aria-hidden="true" tabindex="-1"></a>    <span class="at">responder_er_early =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>,</span>
<span id="cb8-1442"><a href="#cb8-1442" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1443"><a href="#cb8-1443" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1444"><a href="#cb8-1444" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"m"</span>, <span class="st">"m"</span>, </span>
<span id="cb8-1445"><a href="#cb8-1445" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"b"</span>, <span class="st">"b"</span>),</span>
<span id="cb8-1446"><a href="#cb8-1446" aria-hidden="true" tabindex="-1"></a>    <span class="at">responder_set_erpr =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, </span>
<span id="cb8-1447"><a href="#cb8-1447" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1448"><a href="#cb8-1448" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, </span>
<span id="cb8-1449"><a href="#cb8-1449" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1450"><a href="#cb8-1450" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>),</span>
<span id="cb8-1451"><a href="#cb8-1451" aria-hidden="true" tabindex="-1"></a>    <span class="at">non_responder_er_early =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1452"><a href="#cb8-1452" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1453"><a href="#cb8-1453" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, </span>
<span id="cb8-1454"><a href="#cb8-1454" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, </span>
<span id="cb8-1455"><a href="#cb8-1455" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>),</span>
<span id="cb8-1456"><a href="#cb8-1456" aria-hidden="true" tabindex="-1"></a>    <span class="at">non_responder_set_erpr =</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1457"><a href="#cb8-1457" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, </span>
<span id="cb8-1458"><a href="#cb8-1458" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, </span>
<span id="cb8-1459"><a href="#cb8-1459" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, </span>
<span id="cb8-1460"><a href="#cb8-1460" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>),</span>
<span id="cb8-1461"><a href="#cb8-1461" aria-hidden="true" tabindex="-1"></a>    <span class="at">responder_androgen =</span>     <span class="fu">c</span>(<span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>,</span>
<span id="cb8-1462"><a href="#cb8-1462" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>,</span>
<span id="cb8-1463"><a href="#cb8-1463" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"m"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>,</span>
<span id="cb8-1464"><a href="#cb8-1464" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"m"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>, <span class="st">"m"</span>,</span>
<span id="cb8-1465"><a href="#cb8-1465" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"a"</span>),</span>
<span id="cb8-1466"><a href="#cb8-1466" aria-hidden="true" tabindex="-1"></a>    <span class="at">non_responder_androgen =</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>,</span>
<span id="cb8-1467"><a href="#cb8-1467" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"m"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>,</span>
<span id="cb8-1468"><a href="#cb8-1468" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>,</span>
<span id="cb8-1469"><a href="#cb8-1469" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"a"</span>, <span class="st">"m"</span>,</span>
<span id="cb8-1470"><a href="#cb8-1470" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"m"</span>, <span class="st">"m"</span>),</span>
<span id="cb8-1471"><a href="#cb8-1471" aria-hidden="true" tabindex="-1"></a>    <span class="at">comments =</span> <span class="fu">c</span>(</span>
<span id="cb8-1472"><a href="#cb8-1472" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>, <span class="st">""</span>,</span>
<span id="cb8-1473"><a href="#cb8-1473" aria-hidden="true" tabindex="-1"></a>        <span class="st">"good reduction in ki67 for non-responder and even higher baseline"</span>,</span>
<span id="cb8-1474"><a href="#cb8-1474" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb8-1475"><a href="#cb8-1475" aria-hidden="true" tabindex="-1"></a>        <span class="st">"good reduction in ki67 for non-responder"</span>,</span>
<span id="cb8-1476"><a href="#cb8-1476" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb8-1477"><a href="#cb8-1477" aria-hidden="true" tabindex="-1"></a>        <span class="st">"The non-responder is actually a responder, with change in ki67 as 59.67, a rounding error."</span>,</span>
<span id="cb8-1478"><a href="#cb8-1478" aria-hidden="true" tabindex="-1"></a>        <span class="st">"good reduction in ki67 for non-responder as well, almost 60%"</span>,</span>
<span id="cb8-1479"><a href="#cb8-1479" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb8-1480"><a href="#cb8-1480" aria-hidden="true" tabindex="-1"></a>        <span class="st">"High Ki67 levels for the responder, almost 50%"</span>,</span>
<span id="cb8-1481"><a href="#cb8-1481" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Non-responder is almost a reponder with 56% of change"</span>,</span>
<span id="cb8-1482"><a href="#cb8-1482" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, </span>
<span id="cb8-1483"><a href="#cb8-1483" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Very low ki67 levels for responder"</span>,</span>
<span id="cb8-1484"><a href="#cb8-1484" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb8-1485"><a href="#cb8-1485" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Very low Ki67 levels for responder"</span>,</span>
<span id="cb8-1486"><a href="#cb8-1486" aria-hidden="true" tabindex="-1"></a>        <span class="st">"super high Ki67 levels for responder and very low SET ER/PR"</span>,</span>
<span id="cb8-1487"><a href="#cb8-1487" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, </span>
<span id="cb8-1488"><a href="#cb8-1488" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ER early is close to average for responder but SET ER/PR is far away from non-responder"</span>, </span>
<span id="cb8-1489"><a href="#cb8-1489" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, </span>
<span id="cb8-1490"><a href="#cb8-1490" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Again non-responder is very far away from average"</span>,</span>
<span id="cb8-1491"><a href="#cb8-1491" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb8-1492"><a href="#cb8-1492" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Responder had a very high Ki67 and high change but low ER score surprisingly"</span>,</span>
<span id="cb8-1493"><a href="#cb8-1493" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span></span>
<span id="cb8-1494"><a href="#cb8-1494" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1495"><a href="#cb8-1495" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-1496"><a href="#cb8-1496" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1497"><a href="#cb8-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1498"><a href="#cb8-1498" aria-hidden="true" tabindex="-1"></a>comparison_to_average_neighbors <span class="ot">&lt;-</span> comparison_to_average_neighbors <span class="sc">%&gt;%</span></span>
<span id="cb8-1499"><a href="#cb8-1499" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-1500"><a href="#cb8-1500" aria-hidden="true" tabindex="-1"></a>        <span class="at">mismatch_er_responder =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-1501"><a href="#cb8-1501" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1502"><a href="#cb8-1502" aria-hidden="true" tabindex="-1"></a>                responder_set_erpr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1503"><a href="#cb8-1503" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1504"><a href="#cb8-1504" aria-hidden="true" tabindex="-1"></a>                responder_set_erpr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1505"><a href="#cb8-1505" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1506"><a href="#cb8-1506" aria-hidden="true" tabindex="-1"></a>                responder_set_erpr <span class="sc">==</span> <span class="st">"b"</span> <span class="sc">~</span> <span class="st">"yes"</span>,</span>
<span id="cb8-1507"><a href="#cb8-1507" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1508"><a href="#cb8-1508" aria-hidden="true" tabindex="-1"></a>                responder_set_erpr <span class="sc">==</span> <span class="st">"a"</span> <span class="sc">~</span> <span class="st">"yes"</span>,</span>
<span id="cb8-1509"><a href="#cb8-1509" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1510"><a href="#cb8-1510" aria-hidden="true" tabindex="-1"></a>                responder_set_erpr <span class="sc">==</span> <span class="st">"a"</span> <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1511"><a href="#cb8-1511" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1512"><a href="#cb8-1512" aria-hidden="true" tabindex="-1"></a>                responder_set_erpr <span class="sc">==</span> <span class="st">"b"</span> <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1513"><a href="#cb8-1513" aria-hidden="true" tabindex="-1"></a>            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"not_available"</span></span>
<span id="cb8-1514"><a href="#cb8-1514" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1515"><a href="#cb8-1515" aria-hidden="true" tabindex="-1"></a>        <span class="at">mismatch_er_non_responder =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb8-1516"><a href="#cb8-1516" aria-hidden="true" tabindex="-1"></a>            non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1517"><a href="#cb8-1517" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1518"><a href="#cb8-1518" aria-hidden="true" tabindex="-1"></a>            non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1519"><a href="#cb8-1519" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1520"><a href="#cb8-1520" aria-hidden="true" tabindex="-1"></a>            non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1521"><a href="#cb8-1521" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">==</span> <span class="st">"b"</span> <span class="sc">~</span> <span class="st">"yes"</span>,</span>
<span id="cb8-1522"><a href="#cb8-1522" aria-hidden="true" tabindex="-1"></a>            non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1523"><a href="#cb8-1523" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">==</span> <span class="st">"a"</span> <span class="sc">~</span> <span class="st">"yes"</span>,</span>
<span id="cb8-1524"><a href="#cb8-1524" aria-hidden="true" tabindex="-1"></a>            non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1525"><a href="#cb8-1525" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">==</span> <span class="st">"a"</span> <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1526"><a href="#cb8-1526" aria-hidden="true" tabindex="-1"></a>            non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span> </span>
<span id="cb8-1527"><a href="#cb8-1527" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">==</span> <span class="st">"b"</span> <span class="sc">~</span> <span class="st">"no"</span>,</span>
<span id="cb8-1528"><a href="#cb8-1528" aria-hidden="true" tabindex="-1"></a>            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"not_available"</span></span>
<span id="cb8-1529"><a href="#cb8-1529" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1530"><a href="#cb8-1530" aria-hidden="true" tabindex="-1"></a>        <span class="at">both_same_direction_er_early =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-1531"><a href="#cb8-1531" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">==</span> non_responder_er_early,</span>
<span id="cb8-1532"><a href="#cb8-1532" aria-hidden="true" tabindex="-1"></a>            <span class="st">"yes"</span>,</span>
<span id="cb8-1533"><a href="#cb8-1533" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span></span>
<span id="cb8-1534"><a href="#cb8-1534" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1535"><a href="#cb8-1535" aria-hidden="true" tabindex="-1"></a>        <span class="at">both_same_direction_set_erpr =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-1536"><a href="#cb8-1536" aria-hidden="true" tabindex="-1"></a>            responder_set_erpr <span class="sc">==</span> non_responder_set_erpr,</span>
<span id="cb8-1537"><a href="#cb8-1537" aria-hidden="true" tabindex="-1"></a>            <span class="st">"yes"</span>,</span>
<span id="cb8-1538"><a href="#cb8-1538" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span></span>
<span id="cb8-1539"><a href="#cb8-1539" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-1540"><a href="#cb8-1540" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-1541"><a href="#cb8-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1542"><a href="#cb8-1542" aria-hidden="true" tabindex="-1"></a>comparison_to_average_neighbors <span class="ot">&lt;-</span> comparison_to_average_neighbors <span class="sc">%&gt;%</span></span>
<span id="cb8-1543"><a href="#cb8-1543" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(., close_samples_poetic)</span>
<span id="cb8-1544"><a href="#cb8-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1545"><a href="#cb8-1545" aria-hidden="true" tabindex="-1"></a>comparison_to_average_neighbors <span class="ot">&lt;-</span> comparison_to_average_neighbors <span class="sc">%&gt;%</span></span>
<span id="cb8-1546"><a href="#cb8-1546" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-1547"><a href="#cb8-1547" aria-hidden="true" tabindex="-1"></a>        <span class="at">er_early_above_responder =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-1548"><a href="#cb8-1548" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1549"><a href="#cb8-1549" aria-hidden="true" tabindex="-1"></a>                non_responder_er_early <span class="sc">==</span> <span class="st">"b"</span>,</span>
<span id="cb8-1550"><a href="#cb8-1550" aria-hidden="true" tabindex="-1"></a>            <span class="st">"yes"</span>,</span>
<span id="cb8-1551"><a href="#cb8-1551" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span></span>
<span id="cb8-1552"><a href="#cb8-1552" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1553"><a href="#cb8-1553" aria-hidden="true" tabindex="-1"></a>        <span class="at">set_erpr_above_responder =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-1554"><a href="#cb8-1554" aria-hidden="true" tabindex="-1"></a>            responder_set_erpr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1555"><a href="#cb8-1555" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">==</span> <span class="st">"b"</span>,</span>
<span id="cb8-1556"><a href="#cb8-1556" aria-hidden="true" tabindex="-1"></a>            <span class="st">"yes"</span>,</span>
<span id="cb8-1557"><a href="#cb8-1557" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span></span>
<span id="cb8-1558"><a href="#cb8-1558" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1559"><a href="#cb8-1559" aria-hidden="true" tabindex="-1"></a>        <span class="at">er_early_above_non_responder =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-1560"><a href="#cb8-1560" aria-hidden="true" tabindex="-1"></a>            responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"b"</span>) <span class="sc">&amp;</span></span>
<span id="cb8-1561"><a href="#cb8-1561" aria-hidden="true" tabindex="-1"></a>                non_responder_er_early <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>),</span>
<span id="cb8-1562"><a href="#cb8-1562" aria-hidden="true" tabindex="-1"></a>            <span class="st">"yes"</span>,</span>
<span id="cb8-1563"><a href="#cb8-1563" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span></span>
<span id="cb8-1564"><a href="#cb8-1564" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-1565"><a href="#cb8-1565" aria-hidden="true" tabindex="-1"></a>        <span class="at">set_erpr_above_non_responder =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-1566"><a href="#cb8-1566" aria-hidden="true" tabindex="-1"></a>            responder_set_erpr <span class="sc">==</span> <span class="st">"b"</span> <span class="sc">&amp;</span></span>
<span id="cb8-1567"><a href="#cb8-1567" aria-hidden="true" tabindex="-1"></a>                non_responder_set_erpr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"m"</span>),</span>
<span id="cb8-1568"><a href="#cb8-1568" aria-hidden="true" tabindex="-1"></a>            <span class="st">"yes"</span>,</span>
<span id="cb8-1569"><a href="#cb8-1569" aria-hidden="true" tabindex="-1"></a>            <span class="st">"no"</span></span>
<span id="cb8-1570"><a href="#cb8-1570" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-1571"><a href="#cb8-1571" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-1572"><a href="#cb8-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1573"><a href="#cb8-1573" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb8-1574"><a href="#cb8-1574" aria-hidden="true" tabindex="-1"></a>    comparison_to_average_neighbors,</span>
<span id="cb8-1575"><a href="#cb8-1575" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../results/rds_files/scoring/comparison_to_average_neighbors.rds"</span></span>
<span id="cb8-1576"><a href="#cb8-1576" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1577"><a href="#cb8-1577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1578"><a href="#cb8-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1579"><a href="#cb8-1579" aria-hidden="true" tabindex="-1"></a>By analysing the table below we get the following results. The way</span>
<span id="cb8-1580"><a href="#cb8-1580" aria-hidden="true" tabindex="-1"></a>the table was obtained was by manually inspecting all the 38 neighrborhoods</span>
<span id="cb8-1581"><a href="#cb8-1581" aria-hidden="true" tabindex="-1"></a>and checking in which the samples scores were below (b), in the average (m) and</span>
<span id="cb8-1582"><a href="#cb8-1582" aria-hidden="true" tabindex="-1"></a>above average (a). The columns with the a, m and b letters represent the</span>
<span id="cb8-1583"><a href="#cb8-1583" aria-hidden="true" tabindex="-1"></a>scores ER Early and SET ER/PR along with their respective positions.</span>
<span id="cb8-1584"><a href="#cb8-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1587"><a href="#cb8-1587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1588"><a href="#cb8-1588" aria-hidden="true" tabindex="-1"></a>comparison_to_average_neighbors <span class="sc">%&gt;%</span></span>
<span id="cb8-1589"><a href="#cb8-1589" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb8-1590"><a href="#cb8-1590" aria-hidden="true" tabindex="-1"></a>        <span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-1591"><a href="#cb8-1591" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-1592"><a href="#cb8-1592" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1593"><a href="#cb8-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1594"><a href="#cb8-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1595"><a href="#cb8-1595" aria-hidden="true" tabindex="-1"></a>In out of the 38 neighborhoods,</span>
<span id="cb8-1596"><a href="#cb8-1596" aria-hidden="true" tabindex="-1"></a>there are 8 where the responders are at average or above estrogen response</span>
<span id="cb8-1597"><a href="#cb8-1597" aria-hidden="true" tabindex="-1"></a>early and non responders are below.  The total number of unique non-responders</span>
<span id="cb8-1598"><a href="#cb8-1598" aria-hidden="true" tabindex="-1"></a>is 6. On the other hand, there are 9 neighborhoods with 6 unique </span>
<span id="cb8-1599"><a href="#cb8-1599" aria-hidden="true" tabindex="-1"></a>non-responders that have higher scores than average and in which 8 non-responders</span>
<span id="cb8-1600"><a href="#cb8-1600" aria-hidden="true" tabindex="-1"></a>have scores below average. </span>
<span id="cb8-1601"><a href="#cb8-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1602"><a href="#cb8-1602" aria-hidden="true" tabindex="-1"></a>The number increases to 14 when we consider SET ER/PR and out of the 14</span>
<span id="cb8-1603"><a href="#cb8-1603" aria-hidden="true" tabindex="-1"></a>neighborhoods, there are 10 unique samples from non-responders.</span>
<span id="cb8-1604"><a href="#cb8-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1605"><a href="#cb8-1605" aria-hidden="true" tabindex="-1"></a>On the other hand there are 8 neighborhoods which have non responders with</span>
<span id="cb8-1606"><a href="#cb8-1606" aria-hidden="true" tabindex="-1"></a>SET ER/PR higher than average and responders with scores below average.</span>
<span id="cb8-1607"><a href="#cb8-1607" aria-hidden="true" tabindex="-1"></a>Out of these 8 neighborhoods, the number of unique non-responders are </span>
<span id="cb8-1608"><a href="#cb8-1608" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>In total, there are 10 non-responders that are below average,</span>
<span id="cb8-1609"><a href="#cb8-1609" aria-hidden="true" tabindex="-1"></a>6 that are above average and the remaining 8 have similar direction as the</span>
<span id="cb8-1610"><a href="#cb8-1610" aria-hidden="true" tabindex="-1"></a>responders.</span>
<span id="cb8-1611"><a href="#cb8-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1612"><a href="#cb8-1612" aria-hidden="true" tabindex="-1"></a>These results suggest that SET ER/PR might be a better signature to compare</span>
<span id="cb8-1613"><a href="#cb8-1613" aria-hidden="true" tabindex="-1"></a>in the neighborhoods.</span>
<span id="cb8-1614"><a href="#cb8-1614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1617"><a href="#cb8-1617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1618"><a href="#cb8-1618" aria-hidden="true" tabindex="-1"></a>borderline_non_responders <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-1619"><a href="#cb8-1619" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb8-1620"><a href="#cb8-1620" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample_name"</span>, <span class="st">"is_responder"</span>, <span class="st">"ki67"</span>, <span class="st">"change_ki67"</span></span>
<span id="cb8-1621"><a href="#cb8-1621" aria-hidden="true" tabindex="-1"></a>    ))) <span class="sc">%&gt;%</span></span>
<span id="cb8-1622"><a href="#cb8-1622" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(change_ki67 <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">&amp;</span> is_responder <span class="sc">==</span> <span class="st">"non_responder"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1623"><a href="#cb8-1623" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1624"><a href="#cb8-1624" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(., <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb8-1625"><a href="#cb8-1625" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1626"><a href="#cb8-1626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1629"><a href="#cb8-1629" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1630"><a href="#cb8-1630" aria-hidden="true" tabindex="-1"></a>non_responder_androgen_counts <span class="ot">&lt;-</span> comparison_to_average_neighbors <span class="sc">%&gt;%</span></span>
<span id="cb8-1631"><a href="#cb8-1631" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(borderline_non_responders, first_sample_name)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1632"><a href="#cb8-1632" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(borderline_non_responders, second_sample_name)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1633"><a href="#cb8-1633" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-1634"><a href="#cb8-1634" aria-hidden="true" tabindex="-1"></a>        set_erpr_above_non_responder <span class="sc">==</span> <span class="st">"no"</span> <span class="sc">|</span> </span>
<span id="cb8-1635"><a href="#cb8-1635" aria-hidden="true" tabindex="-1"></a>            er_early_above_non_responder <span class="sc">==</span> <span class="st">"no"</span></span>
<span id="cb8-1636"><a href="#cb8-1636" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1637"><a href="#cb8-1637" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(non_responder_androgen)</span>
<span id="cb8-1638"><a href="#cb8-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1639"><a href="#cb8-1639" aria-hidden="true" tabindex="-1"></a>responder_androgen_counts <span class="ot">&lt;-</span> comparison_to_average_neighbors <span class="sc">%&gt;%</span></span>
<span id="cb8-1640"><a href="#cb8-1640" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(borderline_non_responders, first_sample_name)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1641"><a href="#cb8-1641" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(borderline_non_responders, second_sample_name)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1642"><a href="#cb8-1642" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-1643"><a href="#cb8-1643" aria-hidden="true" tabindex="-1"></a>        set_erpr_above_responder <span class="sc">==</span> <span class="st">"yes"</span> <span class="co">#&amp;</span></span>
<span id="cb8-1644"><a href="#cb8-1644" aria-hidden="true" tabindex="-1"></a>            <span class="co">#er_early_above_responder == "yes"</span></span>
<span id="cb8-1645"><a href="#cb8-1645" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1646"><a href="#cb8-1646" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(responder_androgen)</span>
<span id="cb8-1647"><a href="#cb8-1647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1648"><a href="#cb8-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1651"><a href="#cb8-1651" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1652"><a href="#cb8-1652" aria-hidden="true" tabindex="-1"></a>non_responder_androgen_counts</span>
<span id="cb8-1653"><a href="#cb8-1653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1654"><a href="#cb8-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1657"><a href="#cb8-1657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1658"><a href="#cb8-1658" aria-hidden="true" tabindex="-1"></a>responder_androgen_counts</span>
<span id="cb8-1659"><a href="#cb8-1659" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1660"><a href="#cb8-1660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1663"><a href="#cb8-1663" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1664"><a href="#cb8-1664" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>(</span>
<span id="cb8-1665"><a href="#cb8-1665" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb8-1666"><a href="#cb8-1666" aria-hidden="true" tabindex="-1"></a>        <span class="at">non_responder =</span> non_responder_androgen_counts[,<span class="dv">2</span>],</span>
<span id="cb8-1667"><a href="#cb8-1667" aria-hidden="true" tabindex="-1"></a>        <span class="at">responder =</span> responder_androgen_counts[,<span class="dv">2</span>]</span>
<span id="cb8-1668"><a href="#cb8-1668" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb8-1669"><a href="#cb8-1669" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulate.p.value =</span> <span class="cn">TRUE</span></span>
<span id="cb8-1670"><a href="#cb8-1670" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1671"><a href="#cb8-1671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1672"><a href="#cb8-1672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1673"><a href="#cb8-1673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1674"><a href="#cb8-1674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1675"><a href="#cb8-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1676"><a href="#cb8-1676" aria-hidden="true" tabindex="-1"></a><span class="fu">### Analysing all patients</span></span>
<span id="cb8-1677"><a href="#cb8-1677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1678"><a href="#cb8-1678" aria-hidden="true" tabindex="-1"></a>We now try to extend this comparison to something more systematic. Instead</span>
<span id="cb8-1679"><a href="#cb8-1679" aria-hidden="true" tabindex="-1"></a>of looking just for these two patients we will compare the neighborhoods</span>
<span id="cb8-1680"><a href="#cb8-1680" aria-hidden="true" tabindex="-1"></a>for the top responders and </span>
<span id="cb8-1681"><a href="#cb8-1681" aria-hidden="true" tabindex="-1"></a>non-responder patients. The first thing we</span>
<span id="cb8-1682"><a href="#cb8-1682" aria-hidden="true" tabindex="-1"></a>have to have in mind is that some non </span>
<span id="cb8-1683"><a href="#cb8-1683" aria-hidden="true" tabindex="-1"></a>responders they did respond to the drug, just the reduction in Ki67</span>
<span id="cb8-1684"><a href="#cb8-1684" aria-hidden="true" tabindex="-1"></a>was not so big. For example patient 209 has a reduction of 40% in Ki67</span>
<span id="cb8-1685"><a href="#cb8-1685" aria-hidden="true" tabindex="-1"></a>going from 16% to 9%. Still this patient is considered a non-responder.</span>
<span id="cb8-1686"><a href="#cb8-1686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1689"><a href="#cb8-1689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1690"><a href="#cb8-1690" aria-hidden="true" tabindex="-1"></a><span class="co"># first we calculate the distance to distributions of the scores</span></span>
<span id="cb8-1691"><a href="#cb8-1691" aria-hidden="true" tabindex="-1"></a>distance_to_distribution <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb8-1692"><a href="#cb8-1692" aria-hidden="true" tabindex="-1"></a>    pipeline_scores_plots,</span>
<span id="cb8-1693"><a href="#cb8-1693" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(patient_data){</span>
<span id="cb8-1694"><a href="#cb8-1694" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1695"><a href="#cb8-1695" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the draws from the pathway of interest and then subtract </span></span>
<span id="cb8-1696"><a href="#cb8-1696" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the score of the patient. we will then compare the results for</span></span>
<span id="cb8-1697"><a href="#cb8-1697" aria-hidden="true" tabindex="-1"></a>        <span class="co"># responders and non responders</span></span>
<span id="cb8-1698"><a href="#cb8-1698" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1699"><a href="#cb8-1699" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapply</span>(</span>
<span id="cb8-1700"><a href="#cb8-1700" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(pathway, pathway_name){</span>
<span id="cb8-1701"><a href="#cb8-1701" aria-hidden="true" tabindex="-1"></a>                score_patient <span class="ot">&lt;-</span> patient_data<span class="sc">$</span>scores_patient <span class="sc">%&gt;%</span></span>
<span id="cb8-1702"><a href="#cb8-1702" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">==</span> pathway_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1703"><a href="#cb8-1703" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">pull</span>(score)</span>
<span id="cb8-1704"><a href="#cb8-1704" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-1705"><a href="#cb8-1705" aria-hidden="true" tabindex="-1"></a>                <span class="co"># we split it in two lines here so the code is easier to read</span></span>
<span id="cb8-1706"><a href="#cb8-1706" aria-hidden="true" tabindex="-1"></a>                <span class="co"># afterwards</span></span>
<span id="cb8-1707"><a href="#cb8-1707" aria-hidden="true" tabindex="-1"></a>                scores_neighborhood <span class="ot">&lt;-</span> patient_data<span class="sc">$</span>average_scores_neighborhood</span>
<span id="cb8-1708"><a href="#cb8-1708" aria-hidden="true" tabindex="-1"></a>                scores_neighborhood <span class="ot">&lt;-</span> scores_neighborhood[[pathway]]</span>
<span id="cb8-1709"><a href="#cb8-1709" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-1710"><a href="#cb8-1710" aria-hidden="true" tabindex="-1"></a>                scores_neighborhood <span class="sc">%&gt;%</span></span>
<span id="cb8-1711"><a href="#cb8-1711" aria-hidden="true" tabindex="-1"></a>                    tidybayes<span class="sc">::</span><span class="fu">spread_draws</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1712"><a href="#cb8-1712" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">intercept =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1713"><a href="#cb8-1713" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">intercept_diff =</span> score_patient <span class="sc">-</span> intercept) <span class="sc">%&gt;%</span></span>
<span id="cb8-1714"><a href="#cb8-1714" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(intercept, intercept_diff)       </span>
<span id="cb8-1715"><a href="#cb8-1715" aria-hidden="true" tabindex="-1"></a>            }, </span>
<span id="cb8-1716"><a href="#cb8-1716" aria-hidden="true" tabindex="-1"></a>            <span class="at">pathway =</span> <span class="fu">names</span>(patient_data<span class="sc">$</span>scores_patient<span class="sc">$</span>pathway),</span>
<span id="cb8-1717"><a href="#cb8-1717" aria-hidden="true" tabindex="-1"></a>            <span class="at">pathway_name =</span> patient_data<span class="sc">$</span>scores_patient<span class="sc">$</span>pathway,</span>
<span id="cb8-1718"><a href="#cb8-1718" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-1719"><a href="#cb8-1719" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb8-1720"><a href="#cb8-1720" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-1721"><a href="#cb8-1721" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"pathway"</span>)</span>
<span id="cb8-1722"><a href="#cb8-1722" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-1723"><a href="#cb8-1723" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1724"><a href="#cb8-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1725"><a href="#cb8-1725" aria-hidden="true" tabindex="-1"></a>is_mismatch <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb8-1726"><a href="#cb8-1726" aria-hidden="true" tabindex="-1"></a>    pipeline_scores_plots,</span>
<span id="cb8-1727"><a href="#cb8-1727" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(patient_data){</span>
<span id="cb8-1728"><a href="#cb8-1728" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1729"><a href="#cb8-1729" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the draws from the pathway of interest and then subtract </span></span>
<span id="cb8-1730"><a href="#cb8-1730" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the score of the patient. we will then compare the results for</span></span>
<span id="cb8-1731"><a href="#cb8-1731" aria-hidden="true" tabindex="-1"></a>        <span class="co"># responders and non responders</span></span>
<span id="cb8-1732"><a href="#cb8-1732" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1733"><a href="#cb8-1733" aria-hidden="true" tabindex="-1"></a>        is_mismatch <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb8-1734"><a href="#cb8-1734" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(pathway, pathway_name){</span>
<span id="cb8-1735"><a href="#cb8-1735" aria-hidden="true" tabindex="-1"></a>                score_patient <span class="ot">&lt;-</span> patient_data<span class="sc">$</span>scores_patient <span class="sc">%&gt;%</span></span>
<span id="cb8-1736"><a href="#cb8-1736" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">==</span> pathway_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1737"><a href="#cb8-1737" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">pull</span>(score)</span>
<span id="cb8-1738"><a href="#cb8-1738" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-1739"><a href="#cb8-1739" aria-hidden="true" tabindex="-1"></a>                <span class="co"># we split it in two lines here so the code is easier to read</span></span>
<span id="cb8-1740"><a href="#cb8-1740" aria-hidden="true" tabindex="-1"></a>                <span class="co"># afterwards</span></span>
<span id="cb8-1741"><a href="#cb8-1741" aria-hidden="true" tabindex="-1"></a>                scores_neighborhood <span class="ot">&lt;-</span> patient_data<span class="sc">$</span>average_scores_neighborhood</span>
<span id="cb8-1742"><a href="#cb8-1742" aria-hidden="true" tabindex="-1"></a>                scores_neighborhood <span class="ot">&lt;-</span> scores_neighborhood[[pathway]]</span>
<span id="cb8-1743"><a href="#cb8-1743" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-1744"><a href="#cb8-1744" aria-hidden="true" tabindex="-1"></a>                top_quantiles <span class="ot">&lt;-</span> scores_neighborhood <span class="sc">%&gt;%</span></span>
<span id="cb8-1745"><a href="#cb8-1745" aria-hidden="true" tabindex="-1"></a>                    tidybayes<span class="sc">::</span><span class="fu">spread_draws</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1746"><a href="#cb8-1746" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">intercept =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1747"><a href="#cb8-1747" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">pull</span>(intercept) <span class="sc">%&gt;%</span></span>
<span id="cb8-1748"><a href="#cb8-1748" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">quantile</span>(., <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">05</span>, .<span class="dv">95</span>))</span>
<span id="cb8-1749"><a href="#cb8-1749" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-1750"><a href="#cb8-1750" aria-hidden="true" tabindex="-1"></a>                <span class="fu">data.frame</span>(</span>
<span id="cb8-1751"><a href="#cb8-1751" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lower =</span> top_quantiles[<span class="dv">1</span>],</span>
<span id="cb8-1752"><a href="#cb8-1752" aria-hidden="true" tabindex="-1"></a>                    <span class="at">upper =</span> top_quantiles[<span class="dv">2</span>]</span>
<span id="cb8-1753"><a href="#cb8-1753" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1754"><a href="#cb8-1754" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-1755"><a href="#cb8-1755" aria-hidden="true" tabindex="-1"></a>                        <span class="at">is_between =</span> dplyr<span class="sc">::</span><span class="fu">between</span>(</span>
<span id="cb8-1756"><a href="#cb8-1756" aria-hidden="true" tabindex="-1"></a>                            <span class="at">x =</span> score_patient,</span>
<span id="cb8-1757"><a href="#cb8-1757" aria-hidden="true" tabindex="-1"></a>                            <span class="at">left =</span> lower,</span>
<span id="cb8-1758"><a href="#cb8-1758" aria-hidden="true" tabindex="-1"></a>                            <span class="at">right =</span> upper</span>
<span id="cb8-1759"><a href="#cb8-1759" aria-hidden="true" tabindex="-1"></a>                        ),</span>
<span id="cb8-1760"><a href="#cb8-1760" aria-hidden="true" tabindex="-1"></a>                        <span class="at">is_above =</span> score_patient <span class="sc">&gt;</span> upper,</span>
<span id="cb8-1761"><a href="#cb8-1761" aria-hidden="true" tabindex="-1"></a>                        <span class="at">is_below =</span> score_patient <span class="sc">&lt;</span> lower</span>
<span id="cb8-1762"><a href="#cb8-1762" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-1763"><a href="#cb8-1763" aria-hidden="true" tabindex="-1"></a>            }, </span>
<span id="cb8-1764"><a href="#cb8-1764" aria-hidden="true" tabindex="-1"></a>            <span class="at">pathway =</span> <span class="fu">names</span>(patient_data<span class="sc">$</span>scores_patient<span class="sc">$</span>pathway),</span>
<span id="cb8-1765"><a href="#cb8-1765" aria-hidden="true" tabindex="-1"></a>            <span class="at">pathway_name =</span> patient_data<span class="sc">$</span>scores_patient<span class="sc">$</span>pathway,</span>
<span id="cb8-1766"><a href="#cb8-1766" aria-hidden="true" tabindex="-1"></a>            <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-1767"><a href="#cb8-1767" aria-hidden="true" tabindex="-1"></a>            <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb8-1768"><a href="#cb8-1768" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-1769"><a href="#cb8-1769" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"pathway"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1770"><a href="#cb8-1770" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb8-1771"><a href="#cb8-1771" aria-hidden="true" tabindex="-1"></a>                <span class="at">.cols =</span> <span class="fu">c</span>(is_between, is_above, is_below),</span>
<span id="cb8-1772"><a href="#cb8-1772" aria-hidden="true" tabindex="-1"></a>                <span class="at">.fns =</span> as.numeric</span>
<span id="cb8-1773"><a href="#cb8-1773" aria-hidden="true" tabindex="-1"></a>            ))</span>
<span id="cb8-1774"><a href="#cb8-1774" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1775"><a href="#cb8-1775" aria-hidden="true" tabindex="-1"></a>        estrogen_early_above <span class="ot">&lt;-</span> is_mismatch <span class="sc">%&gt;%</span> </span>
<span id="cb8-1776"><a href="#cb8-1776" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">==</span> <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1777"><a href="#cb8-1777" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(is_above)</span>
<span id="cb8-1778"><a href="#cb8-1778" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1779"><a href="#cb8-1779" aria-hidden="true" tabindex="-1"></a>        estrogen_early_below <span class="ot">&lt;-</span> is_mismatch <span class="sc">%&gt;%</span> </span>
<span id="cb8-1780"><a href="#cb8-1780" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">==</span> <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1781"><a href="#cb8-1781" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(is_below)</span>
<span id="cb8-1782"><a href="#cb8-1782" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1783"><a href="#cb8-1783" aria-hidden="true" tabindex="-1"></a>        set_erpr_above <span class="ot">&lt;-</span> is_mismatch <span class="sc">%&gt;%</span> </span>
<span id="cb8-1784"><a href="#cb8-1784" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">==</span> <span class="st">"SET_ERPR"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1785"><a href="#cb8-1785" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(is_above)</span>
<span id="cb8-1786"><a href="#cb8-1786" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-1787"><a href="#cb8-1787" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb8-1788"><a href="#cb8-1788" aria-hidden="true" tabindex="-1"></a>            <span class="at">mismatch =</span> estrogen_early_above <span class="sc">!=</span> set_erpr_above,</span>
<span id="cb8-1789"><a href="#cb8-1789" aria-hidden="true" tabindex="-1"></a>            <span class="at">is_above =</span> estrogen_early_above,</span>
<span id="cb8-1790"><a href="#cb8-1790" aria-hidden="true" tabindex="-1"></a>            <span class="at">df =</span> is_mismatch,</span>
<span id="cb8-1791"><a href="#cb8-1791" aria-hidden="true" tabindex="-1"></a>            <span class="at">is_below =</span> estrogen_early_below</span>
<span id="cb8-1792"><a href="#cb8-1792" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-1793"><a href="#cb8-1793" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-1794"><a href="#cb8-1794" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-1795"><a href="#cb8-1795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1796"><a href="#cb8-1796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1797"><a href="#cb8-1797" aria-hidden="true" tabindex="-1"></a>We don't select all patients for the comparisons. We select only patients that </span>
<span id="cb8-1798"><a href="#cb8-1798" aria-hidden="true" tabindex="-1"></a>are at least in the HER2 enriched region to the right, so we </span>
<span id="cb8-1799"><a href="#cb8-1799" aria-hidden="true" tabindex="-1"></a>exclude the basal like patients. The reason for this as well is because</span>
<span id="cb8-1800"><a href="#cb8-1800" aria-hidden="true" tabindex="-1"></a>they all either have low Estrogen response early scores or low SET ER/PR.</span>
<span id="cb8-1801"><a href="#cb8-1801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1804"><a href="#cb8-1804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1805"><a href="#cb8-1805" aria-hidden="true" tabindex="-1"></a>remove_patients <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-1806"><a href="#cb8-1806" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-1807"><a href="#cb8-1807" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-1808"><a href="#cb8-1808" aria-hidden="true" tabindex="-1"></a>            PC3 <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">4</span> <span class="sc">&amp;</span> </span>
<span id="cb8-1809"><a href="#cb8-1809" aria-hidden="true" tabindex="-1"></a>            is_responder <span class="sc">==</span> <span class="st">"non_responder"</span> <span class="sc">&amp;</span></span>
<span id="cb8-1810"><a href="#cb8-1810" aria-hidden="true" tabindex="-1"></a>            timepoint <span class="sc">==</span> <span class="st">"baseline"</span></span>
<span id="cb8-1811"><a href="#cb8-1811" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-1812"><a href="#cb8-1812" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb8-1813"><a href="#cb8-1813" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-1814"><a href="#cb8-1814" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-1815"><a href="#cb8-1815" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> remove_patients) <span class="sc">%&gt;%</span></span>
<span id="cb8-1816"><a href="#cb8-1816" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb8-1817"><a href="#cb8-1817" aria-hidden="true" tabindex="-1"></a>        <span class="st">"HALLMARK_ESTROGEN_RESPONSE_EARLY"</span>, <span class="st">"SET_ERPR"</span>, <span class="st">"PC3"</span></span>
<span id="cb8-1818"><a href="#cb8-1818" aria-hidden="true" tabindex="-1"></a>    ))) <span class="sc">%&gt;%</span></span>
<span id="cb8-1819"><a href="#cb8-1819" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.fns =</span> format, <span class="at">digits =</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1820"><a href="#cb8-1820" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-1821"><a href="#cb8-1821" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-1822"><a href="#cb8-1822" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1823"><a href="#cb8-1823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1826"><a href="#cb8-1826" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-1827"><a href="#cb8-1827" aria-hidden="true" tabindex="-1"></a>mismatch_analysis <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb8-1828"><a href="#cb8-1828" aria-hidden="true" tabindex="-1"></a>    is_mismatch,</span>
<span id="cb8-1829"><a href="#cb8-1829" aria-hidden="true" tabindex="-1"></a>    \(x) <span class="fu">c</span>(</span>
<span id="cb8-1830"><a href="#cb8-1830" aria-hidden="true" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">pluck</span>(x, <span class="st">"mismatch"</span>), </span>
<span id="cb8-1831"><a href="#cb8-1831" aria-hidden="true" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">pluck</span>(x, <span class="st">"is_above"</span>),</span>
<span id="cb8-1832"><a href="#cb8-1832" aria-hidden="true" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">pluck</span>(x, <span class="st">"is_below"</span>)</span>
<span id="cb8-1833"><a href="#cb8-1833" aria-hidden="true" tabindex="-1"></a>    )  <span class="sc">%&gt;%</span></span>
<span id="cb8-1834"><a href="#cb8-1834" aria-hidden="true" tabindex="-1"></a>        as.numeric</span>
<span id="cb8-1835"><a href="#cb8-1835" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1836"><a href="#cb8-1836" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1837"><a href="#cb8-1837" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span></span>
<span id="cb8-1838"><a href="#cb8-1838" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">sample_name =</span> <span class="fu">rownames</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1839"><a href="#cb8-1839" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">mismatch =</span> <span class="st">"X1"</span>, <span class="at">is_above =</span> <span class="st">"X2"</span>, <span class="at">is_below =</span> <span class="st">"X3"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1840"><a href="#cb8-1840" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(sample_name <span class="sc">%in%</span> remove_patients)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1841"><a href="#cb8-1841" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb8-1842"><a href="#cb8-1842" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb8-1843"><a href="#cb8-1843" aria-hidden="true" tabindex="-1"></a>        df_pca_coordinates,</span>
<span id="cb8-1844"><a href="#cb8-1844" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb8-1845"><a href="#cb8-1845" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-1846"><a href="#cb8-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1847"><a href="#cb8-1847" aria-hidden="true" tabindex="-1"></a>average_distances <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb8-1848"><a href="#cb8-1848" aria-hidden="true" tabindex="-1"></a>    distance_to_distribution, </span>
<span id="cb8-1849"><a href="#cb8-1849" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x){</span>
<span id="cb8-1850"><a href="#cb8-1850" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">%&gt;%</span></span>
<span id="cb8-1851"><a href="#cb8-1851" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(pathway) <span class="sc">%&gt;%</span></span>
<span id="cb8-1852"><a href="#cb8-1852" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb8-1853"><a href="#cb8-1853" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_distance =</span> <span class="fu">mean</span>(intercept_diff),</span>
<span id="cb8-1854"><a href="#cb8-1854" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">mean</span>(intercept)</span>
<span id="cb8-1855"><a href="#cb8-1855" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-1856"><a href="#cb8-1856" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-1857"><a href="#cb8-1857" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1858"><a href="#cb8-1858" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"sample_name"</span>)</span>
<span id="cb8-1859"><a href="#cb8-1859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1860"><a href="#cb8-1860" aria-hidden="true" tabindex="-1"></a>poetic_distances <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb8-1861"><a href="#cb8-1861" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(sample_name <span class="sc">%in%</span> remove_patients)) <span class="sc">%&gt;%</span></span>
<span id="cb8-1862"><a href="#cb8-1862" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(., average_distances, <span class="at">by =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1863"><a href="#cb8-1863" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_responder <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"responder"</span>, <span class="st">"non_responder"</span>)) </span>
<span id="cb8-1864"><a href="#cb8-1864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1865"><a href="#cb8-1865" aria-hidden="true" tabindex="-1"></a>non_responders_sub <span class="ot">&lt;-</span> poetic_distances <span class="sc">%&gt;%</span></span>
<span id="cb8-1866"><a href="#cb8-1866" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(change_ki67 <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1867"><a href="#cb8-1867" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1868"><a href="#cb8-1868" aria-hidden="true" tabindex="-1"></a>    unique</span>
<span id="cb8-1869"><a href="#cb8-1869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1870"><a href="#cb8-1870" aria-hidden="true" tabindex="-1"></a>responders_sub <span class="ot">&lt;-</span> poetic_distances <span class="sc">%&gt;%</span></span>
<span id="cb8-1871"><a href="#cb8-1871" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(change_ki67) <span class="sc">%&gt;%</span></span>
<span id="cb8-1872"><a href="#cb8-1872" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1873"><a href="#cb8-1873" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-1874"><a href="#cb8-1874" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1875"><a href="#cb8-1875" aria-hidden="true" tabindex="-1"></a>    unique</span>
<span id="cb8-1876"><a href="#cb8-1876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1877"><a href="#cb8-1877" aria-hidden="true" tabindex="-1"></a>responders_middle <span class="ot">&lt;-</span> poetic_distances <span class="sc">%&gt;%</span></span>
<span id="cb8-1878"><a href="#cb8-1878" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(change_ki67) <span class="sc">%&gt;%</span></span>
<span id="cb8-1879"><a href="#cb8-1879" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(sample_name, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1880"><a href="#cb8-1880" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(is_responder <span class="sc">==</span> <span class="st">"responder"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1881"><a href="#cb8-1881" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(PC3 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> PC4 <span class="sc">&gt;</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="sc">&amp;</span> PC4 <span class="sc">&lt;</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1882"><a href="#cb8-1882" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb8-1883"><a href="#cb8-1883" aria-hidden="true" tabindex="-1"></a>    unique</span>
<span id="cb8-1884"><a href="#cb8-1884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1885"><a href="#cb8-1885" aria-hidden="true" tabindex="-1"></a>plot_scores_patient <span class="ot">&lt;-</span> <span class="cf">function</span>(nb_patient, list_patients, distances){</span>
<span id="cb8-1886"><a href="#cb8-1886" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-1887"><a href="#cb8-1887" aria-hidden="true" tabindex="-1"></a>    ki67_patient <span class="ot">&lt;-</span> distances <span class="sc">%&gt;%</span></span>
<span id="cb8-1888"><a href="#cb8-1888" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">==</span> list_patients[[nb]]) <span class="sc">%&gt;%</span></span>
<span id="cb8-1889"><a href="#cb8-1889" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(change_ki67, ki67, PC3, PC4) <span class="sc">%&gt;%</span></span>
<span id="cb8-1890"><a href="#cb8-1890" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-1891"><a href="#cb8-1891" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.fns =</span> format, <span class="at">digit =</span> <span class="dv">3</span>))</span>
<span id="cb8-1892"><a href="#cb8-1892" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-1893"><a href="#cb8-1893" aria-hidden="true" tabindex="-1"></a>    pipeline_scores_plots[[list_patients[nb]]]<span class="sc">$</span>plot <span class="sc">+</span></span>
<span id="cb8-1894"><a href="#cb8-1894" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-1895"><a href="#cb8-1895" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-1896"><a href="#cb8-1896" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Ki67: "</span>, ki67_patient<span class="sc">$</span>ki67, </span>
<span id="cb8-1897"><a href="#cb8-1897" aria-hidden="true" tabindex="-1"></a>                <span class="st">", change Ki67: "</span>, ki67_patient<span class="sc">$</span>change_ki67,</span>
<span id="cb8-1898"><a href="#cb8-1898" aria-hidden="true" tabindex="-1"></a>                <span class="st">", PC3: "</span>, ki67_patient<span class="sc">$</span>PC3, <span class="st">", PC4: "</span>, ki67_patient<span class="sc">$</span>PC4</span>
<span id="cb8-1899"><a href="#cb8-1899" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-1900"><a href="#cb8-1900" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-1901"><a href="#cb8-1901" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-1902"><a href="#cb8-1902" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1903"><a href="#cb8-1903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1904"><a href="#cb8-1904" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Non-responders</span></span>
<span id="cb8-1905"><a href="#cb8-1905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1906"><a href="#cb8-1906" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1907"><a href="#cb8-1907" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-1908"><a href="#cb8-1908" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1909"><a href="#cb8-1909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1910"><a href="#cb8-1910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1911"><a href="#cb8-1911" aria-hidden="true" tabindex="-1"></a>Estrogen score still close to 0, high proliferation at baseline and higher</span>
<span id="cb8-1912"><a href="#cb8-1912" aria-hidden="true" tabindex="-1"></a>androgen score. But in this case SET ER/PR is lower than average. There is</span>
<span id="cb8-1913"><a href="#cb8-1913" aria-hidden="true" tabindex="-1"></a>a mismatch.</span>
<span id="cb8-1914"><a href="#cb8-1914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1915"><a href="#cb8-1915" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1916"><a href="#cb8-1916" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb8-1917"><a href="#cb8-1917" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1918"><a href="#cb8-1918" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1919"><a href="#cb8-1919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1920"><a href="#cb8-1920" aria-hidden="true" tabindex="-1"></a>This patient has a score close to 0 still but low proliferation in general. </span>
<span id="cb8-1921"><a href="#cb8-1921" aria-hidden="true" tabindex="-1"></a>This is a case where the EMT signaling is really at average and </span>
<span id="cb8-1922"><a href="#cb8-1922" aria-hidden="true" tabindex="-1"></a>TGFb is super low. Again SET ER/PR is much lower, mismatch with ER </span>
<span id="cb8-1923"><a href="#cb8-1923" aria-hidden="true" tabindex="-1"></a>signaling.</span>
<span id="cb8-1924"><a href="#cb8-1924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1925"><a href="#cb8-1925" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1926"><a href="#cb8-1926" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb8-1927"><a href="#cb8-1927" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1928"><a href="#cb8-1928" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1929"><a href="#cb8-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1930"><a href="#cb8-1930" aria-hidden="true" tabindex="-1"></a>Estrogen signaling close to 0, high androgen and E2F targets and high</span>
<span id="cb8-1931"><a href="#cb8-1931" aria-hidden="true" tabindex="-1"></a>EMT. Intriguing patient, both ER and SET ER/PR are going in </span>
<span id="cb8-1932"><a href="#cb8-1932" aria-hidden="true" tabindex="-1"></a>the same direction and above average. </span>
<span id="cb8-1933"><a href="#cb8-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1934"><a href="#cb8-1934" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1935"><a href="#cb8-1935" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb8-1936"><a href="#cb8-1936" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1937"><a href="#cb8-1937" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1938"><a href="#cb8-1938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1939"><a href="#cb8-1939" aria-hidden="true" tabindex="-1"></a>Low ER signaling and super high EMT with an increase P53 pathway</span>
<span id="cb8-1940"><a href="#cb8-1940" aria-hidden="true" tabindex="-1"></a>expression. Super low ER signaling here in terms of SET ER/PR. </span>
<span id="cb8-1941"><a href="#cb8-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1942"><a href="#cb8-1942" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1943"><a href="#cb8-1943" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb8-1944"><a href="#cb8-1944" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1945"><a href="#cb8-1945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1946"><a href="#cb8-1946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1947"><a href="#cb8-1947" aria-hidden="true" tabindex="-1"></a>Low ER score, even lower than average and low EMT signaling. Average </span>
<span id="cb8-1948"><a href="#cb8-1948" aria-hidden="true" tabindex="-1"></a>E2F targets and lower than average for SET ER/PR.</span>
<span id="cb8-1949"><a href="#cb8-1949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1950"><a href="#cb8-1950" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1951"><a href="#cb8-1951" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb8-1952"><a href="#cb8-1952" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1953"><a href="#cb8-1953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1954"><a href="#cb8-1954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1955"><a href="#cb8-1955" aria-hidden="true" tabindex="-1"></a>This case is a bit different, the ER signaling is higher, E2F targets at</span>
<span id="cb8-1956"><a href="#cb8-1956" aria-hidden="true" tabindex="-1"></a>baseline is not so high, even lower than the average, but in this</span>
<span id="cb8-1957"><a href="#cb8-1957" aria-hidden="true" tabindex="-1"></a>case androgen response is much higher and EMT is extremely high. There is</span>
<span id="cb8-1958"><a href="#cb8-1958" aria-hidden="true" tabindex="-1"></a>a relative mismatch between ER early and SET ER/PR. SET ER/PR is </span>
<span id="cb8-1959"><a href="#cb8-1959" aria-hidden="true" tabindex="-1"></a>relatively small and close to the average.</span>
<span id="cb8-1960"><a href="#cb8-1960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1961"><a href="#cb8-1961" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1962"><a href="#cb8-1962" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb8-1963"><a href="#cb8-1963" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1964"><a href="#cb8-1964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1965"><a href="#cb8-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1966"><a href="#cb8-1966" aria-hidden="true" tabindex="-1"></a>Androgen score lower than the average and high E2F targets at baseline. </span>
<span id="cb8-1967"><a href="#cb8-1967" aria-hidden="true" tabindex="-1"></a>In this case we see a very small EMT signature. In this case there is </span>
<span id="cb8-1968"><a href="#cb8-1968" aria-hidden="true" tabindex="-1"></a>again a mismatch between ER signaling and SET ER/PR.</span>
<span id="cb8-1969"><a href="#cb8-1969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1970"><a href="#cb8-1970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1971"><a href="#cb8-1971" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb8-1972"><a href="#cb8-1972" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, non_responders_sub, poetic_distances)</span>
<span id="cb8-1973"><a href="#cb8-1973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1974"><a href="#cb8-1974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1975"><a href="#cb8-1975" aria-hidden="true" tabindex="-1"></a>This one has a low ER signaling as well and higher E2F targets score. </span>
<span id="cb8-1976"><a href="#cb8-1976" aria-hidden="true" tabindex="-1"></a>Massive difference in SET ER/PR here when comparing to the average.</span>
<span id="cb8-1977"><a href="#cb8-1977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1978"><a href="#cb8-1978" aria-hidden="true" tabindex="-1"></a>In general all these non responders with no change in Ki67 had a low</span>
<span id="cb8-1979"><a href="#cb8-1979" aria-hidden="true" tabindex="-1"></a>ER signaling score or a mismatch between ER early and SET ER/PR</span>
<span id="cb8-1980"><a href="#cb8-1980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1981"><a href="#cb8-1981" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Top responders</span></span>
<span id="cb8-1982"><a href="#cb8-1982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1983"><a href="#cb8-1983" aria-hidden="true" tabindex="-1"></a>We now investigate the top responders with the</span>
<span id="cb8-1984"><a href="#cb8-1984" aria-hidden="true" tabindex="-1"></a>biggest decrease in Ki67.</span>
<span id="cb8-1985"><a href="#cb8-1985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1986"><a href="#cb8-1986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1987"><a href="#cb8-1987" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-1988"><a href="#cb8-1988" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-1989"><a href="#cb8-1989" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-1990"><a href="#cb8-1990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1991"><a href="#cb8-1991" aria-hidden="true" tabindex="-1"></a>First thing is that this patient had already a positive score</span>
<span id="cb8-1992"><a href="#cb8-1992" aria-hidden="true" tabindex="-1"></a>and a very low Androgen signaling score. Moreover the Ki67</span>
<span id="cb8-1993"><a href="#cb8-1993" aria-hidden="true" tabindex="-1"></a>is low. This is one of the furthest patients to the</span>
<span id="cb8-1994"><a href="#cb8-1994" aria-hidden="true" tabindex="-1"></a>right and still has a low ER signaling score.</span>
<span id="cb8-1995"><a href="#cb8-1995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1996"><a href="#cb8-1996" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-1997"><a href="#cb8-1997" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb8-1998"><a href="#cb8-1998" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-1999"><a href="#cb8-1999" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2000"><a href="#cb8-2000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2001"><a href="#cb8-2001" aria-hidden="true" tabindex="-1"></a>A bit high E2F targets but higher than average of the estrogen</span>
<span id="cb8-2002"><a href="#cb8-2002" aria-hidden="true" tabindex="-1"></a>signaling score. High SET ER/PR.</span>
<span id="cb8-2003"><a href="#cb8-2003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2004"><a href="#cb8-2004" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2005"><a href="#cb8-2005" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb8-2006"><a href="#cb8-2006" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-2007"><a href="#cb8-2007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2008"><a href="#cb8-2008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2009"><a href="#cb8-2009" aria-hidden="true" tabindex="-1"></a>Here the ER signaling is above average and androgen response is similar</span>
<span id="cb8-2010"><a href="#cb8-2010" aria-hidden="true" tabindex="-1"></a>to the average. E2F targets is high. Also super high SET ER/PR.</span>
<span id="cb8-2011"><a href="#cb8-2011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2012"><a href="#cb8-2012" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2013"><a href="#cb8-2013" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb8-2014"><a href="#cb8-2014" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-2015"><a href="#cb8-2015" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2016"><a href="#cb8-2016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2017"><a href="#cb8-2017" aria-hidden="true" tabindex="-1"></a>Very low E2F targets and low Androgen response. ER is about the</span>
<span id="cb8-2018"><a href="#cb8-2018" aria-hidden="true" tabindex="-1"></a>average. SET ER/PR is still positive. This sample is in </span>
<span id="cb8-2019"><a href="#cb8-2019" aria-hidden="true" tabindex="-1"></a>the luminal A region also.</span>
<span id="cb8-2020"><a href="#cb8-2020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2021"><a href="#cb8-2021" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2022"><a href="#cb8-2022" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb8-2023"><a href="#cb8-2023" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-2024"><a href="#cb8-2024" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2025"><a href="#cb8-2025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2026"><a href="#cb8-2026" aria-hidden="true" tabindex="-1"></a>In this case ER signaling is also above average and E2F targets is </span>
<span id="cb8-2027"><a href="#cb8-2027" aria-hidden="true" tabindex="-1"></a>similar to the average of neighbors. SET ER/PR on average and in the </span>
<span id="cb8-2028"><a href="#cb8-2028" aria-hidden="true" tabindex="-1"></a>expected direction.</span>
<span id="cb8-2029"><a href="#cb8-2029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2030"><a href="#cb8-2030" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2031"><a href="#cb8-2031" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb8-2032"><a href="#cb8-2032" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-2033"><a href="#cb8-2033" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2034"><a href="#cb8-2034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2035"><a href="#cb8-2035" aria-hidden="true" tabindex="-1"></a>This one is intriguing, ER signaling is extremely low, E2F targets is</span>
<span id="cb8-2036"><a href="#cb8-2036" aria-hidden="true" tabindex="-1"></a>very low as well but the patient responded pretty well. But there is a </span>
<span id="cb8-2037"><a href="#cb8-2037" aria-hidden="true" tabindex="-1"></a>big mismatch between Ki67 and transcriptomics for this patient. Further</span>
<span id="cb8-2038"><a href="#cb8-2038" aria-hidden="true" tabindex="-1"></a>investigation should be performed. Actually probably the samples have mixed</span>
<span id="cb8-2039"><a href="#cb8-2039" aria-hidden="true" tabindex="-1"></a>names. Below are the values of the pathways after treatment:</span>
<span id="cb8-2040"><a href="#cb8-2040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2043"><a href="#cb8-2043" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2044"><a href="#cb8-2044" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-2045"><a href="#cb8-2045" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(patient_nb <span class="sc">==</span> <span class="st">"89"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-2046"><a href="#cb8-2046" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb8-2047"><a href="#cb8-2047" aria-hidden="true" tabindex="-1"></a>        ki67,</span>
<span id="cb8-2048"><a href="#cb8-2048" aria-hidden="true" tabindex="-1"></a>        HALLMARK_E2F_TARGETS,</span>
<span id="cb8-2049"><a href="#cb8-2049" aria-hidden="true" tabindex="-1"></a>        SET_ERPR,</span>
<span id="cb8-2050"><a href="#cb8-2050" aria-hidden="true" tabindex="-1"></a>        HALLMARK_ESTROGEN_RESPONSE_EARLY,</span>
<span id="cb8-2051"><a href="#cb8-2051" aria-hidden="true" tabindex="-1"></a>        PC3, </span>
<span id="cb8-2052"><a href="#cb8-2052" aria-hidden="true" tabindex="-1"></a>        PC4</span>
<span id="cb8-2053"><a href="#cb8-2053" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-2054"><a href="#cb8-2054" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-2055"><a href="#cb8-2055" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2056"><a href="#cb8-2056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2057"><a href="#cb8-2057" aria-hidden="true" tabindex="-1"></a>It looks super weird that there is a big increase in proliferation based</span>
<span id="cb8-2058"><a href="#cb8-2058" aria-hidden="true" tabindex="-1"></a>on the transcriptomic data considering the reduction in the Ki67 percentage.</span>
<span id="cb8-2059"><a href="#cb8-2059" aria-hidden="true" tabindex="-1"></a>Not only that, ER signaling increases. It is very likely that the sample </span>
<span id="cb8-2060"><a href="#cb8-2060" aria-hidden="true" tabindex="-1"></a>has a mixed label. </span>
<span id="cb8-2061"><a href="#cb8-2061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2062"><a href="#cb8-2062" aria-hidden="true" tabindex="-1"></a>Moving to the next one.</span>
<span id="cb8-2063"><a href="#cb8-2063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2064"><a href="#cb8-2064" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2065"><a href="#cb8-2065" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb8-2066"><a href="#cb8-2066" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-2067"><a href="#cb8-2067" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2068"><a href="#cb8-2068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2069"><a href="#cb8-2069" aria-hidden="true" tabindex="-1"></a>This one also is intriguing, estrogen signaling is very low but the patient</span>
<span id="cb8-2070"><a href="#cb8-2070" aria-hidden="true" tabindex="-1"></a>is a responder with a good decrease in Ki67. Below is a table with the values</span>
<span id="cb8-2071"><a href="#cb8-2071" aria-hidden="true" tabindex="-1"></a>for surgery and baseline. We see that there is indeed a decrease in </span>
<span id="cb8-2072"><a href="#cb8-2072" aria-hidden="true" tabindex="-1"></a>proliferation and also in estrogen signaling. Also this sample </span>
<span id="cb8-2073"><a href="#cb8-2073" aria-hidden="true" tabindex="-1"></a>is closer to the normal like and luminal A region.</span>
<span id="cb8-2074"><a href="#cb8-2074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2077"><a href="#cb8-2077" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2078"><a href="#cb8-2078" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-2079"><a href="#cb8-2079" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(patient_nb <span class="sc">==</span> <span class="st">"90"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-2080"><a href="#cb8-2080" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb8-2081"><a href="#cb8-2081" aria-hidden="true" tabindex="-1"></a>        PC3, </span>
<span id="cb8-2082"><a href="#cb8-2082" aria-hidden="true" tabindex="-1"></a>        PC4, </span>
<span id="cb8-2083"><a href="#cb8-2083" aria-hidden="true" tabindex="-1"></a>        HALLMARK_ESTROGEN_RESPONSE_EARLY, </span>
<span id="cb8-2084"><a href="#cb8-2084" aria-hidden="true" tabindex="-1"></a>        HALLMARK_E2F_TARGETS, </span>
<span id="cb8-2085"><a href="#cb8-2085" aria-hidden="true" tabindex="-1"></a>        ki67</span>
<span id="cb8-2086"><a href="#cb8-2086" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-2087"><a href="#cb8-2087" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-2088"><a href="#cb8-2088" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2089"><a href="#cb8-2089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2090"><a href="#cb8-2090" aria-hidden="true" tabindex="-1"></a>And last patient.</span>
<span id="cb8-2091"><a href="#cb8-2091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2092"><a href="#cb8-2092" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2093"><a href="#cb8-2093" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb8-2094"><a href="#cb8-2094" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_sub, poetic_distances)</span>
<span id="cb8-2095"><a href="#cb8-2095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2096"><a href="#cb8-2096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2097"><a href="#cb8-2097" aria-hidden="true" tabindex="-1"></a>This patient has a score slightly higher than the average, but still negative.</span>
<span id="cb8-2098"><a href="#cb8-2098" aria-hidden="true" tabindex="-1"></a>Nonetheless, the patient responded well to the therapy. One note is </span>
<span id="cb8-2099"><a href="#cb8-2099" aria-hidden="true" tabindex="-1"></a>that this patient is close to the HER2 enriched region. </span>
<span id="cb8-2100"><a href="#cb8-2100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2101"><a href="#cb8-2101" aria-hidden="true" tabindex="-1"></a>In general non responders had more mismatches between SET ER/PR and </span>
<span id="cb8-2102"><a href="#cb8-2102" aria-hidden="true" tabindex="-1"></a>below average values than responders.</span>
<span id="cb8-2103"><a href="#cb8-2103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2104"><a href="#cb8-2104" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Responders in the middle of embedding </span></span>
<span id="cb8-2105"><a href="#cb8-2105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2106"><a href="#cb8-2106" aria-hidden="true" tabindex="-1"></a>We lastly check the responders that are in the middle of the </span>
<span id="cb8-2107"><a href="#cb8-2107" aria-hidden="true" tabindex="-1"></a>molecular landscape to see how they are. </span>
<span id="cb8-2108"><a href="#cb8-2108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2109"><a href="#cb8-2109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2110"><a href="#cb8-2110" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb8-2111"><a href="#cb8-2111" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_middle, poetic_distances)</span>
<span id="cb8-2112"><a href="#cb8-2112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2113"><a href="#cb8-2113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2114"><a href="#cb8-2114" aria-hidden="true" tabindex="-1"></a>Low ER signaling in both cases. This patient</span>
<span id="cb8-2115"><a href="#cb8-2115" aria-hidden="true" tabindex="-1"></a>specifically had very high Ki67 levels at baseline.</span>
<span id="cb8-2116"><a href="#cb8-2116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2117"><a href="#cb8-2117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=7}</span></span>
<span id="cb8-2118"><a href="#cb8-2118" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb8-2119"><a href="#cb8-2119" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_scores_patient</span>(nb, responders_middle, poetic_distances)</span>
<span id="cb8-2120"><a href="#cb8-2120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2121"><a href="#cb8-2121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2122"><a href="#cb8-2122" aria-hidden="true" tabindex="-1"></a>Also ER signaling is low here compared to the average, but a very low</span>
<span id="cb8-2123"><a href="#cb8-2123" aria-hidden="true" tabindex="-1"></a>Ki67 proliferation index at baseline.</span>
<span id="cb8-2124"><a href="#cb8-2124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2125"><a href="#cb8-2125" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Conclusion</span></span>
<span id="cb8-2126"><a href="#cb8-2126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2127"><a href="#cb8-2127" aria-hidden="true" tabindex="-1"></a>In general what we can see is that when comparing responders and</span>
<span id="cb8-2128"><a href="#cb8-2128" aria-hidden="true" tabindex="-1"></a>non responders the main difference is in the position of </span>
<span id="cb8-2129"><a href="#cb8-2129" aria-hidden="true" tabindex="-1"></a>the molecular landscape. If we select the top responders and the</span>
<span id="cb8-2130"><a href="#cb8-2130" aria-hidden="true" tabindex="-1"></a>top non-responders in terms of decrease in Ki67 levels, we see</span>
<span id="cb8-2131"><a href="#cb8-2131" aria-hidden="true" tabindex="-1"></a>that non responders have way lower third principal </span>
<span id="cb8-2132"><a href="#cb8-2132" aria-hidden="true" tabindex="-1"></a>component (@fig-high-respnon).</span>
<span id="cb8-2133"><a href="#cb8-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2134"><a href="#cb8-2134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=6, fig.height=5}</span></span>
<span id="cb8-2135"><a href="#cb8-2135" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-high-respnon</span></span>
<span id="cb8-2136"><a href="#cb8-2136" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PC3 comparison of the top non responders and responders</span></span>
<span id="cb8-2137"><a href="#cb8-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2138"><a href="#cb8-2138" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates <span class="sc">%&gt;%</span> </span>
<span id="cb8-2139"><a href="#cb8-2139" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> <span class="fu">c</span>(responders_sub, non_responders_sub)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-2140"><a href="#cb8-2140" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_responder, <span class="at">y =</span> PC3, <span class="at">color =</span> is_responder)) <span class="sc">+</span> </span>
<span id="cb8-2141"><a href="#cb8-2141" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb8-2142"><a href="#cb8-2142" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb8-2143"><a href="#cb8-2143" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"H"</span>) <span class="sc">+</span></span>
<span id="cb8-2144"><a href="#cb8-2144" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb8-2145"><a href="#cb8-2145" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Is responder?"</span>,</span>
<span id="cb8-2146"><a href="#cb8-2146" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Top non-responders and responders"</span></span>
<span id="cb8-2147"><a href="#cb8-2147" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-2148"><a href="#cb8-2148" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb8-2149"><a href="#cb8-2149" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb8-2150"><a href="#cb8-2150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb8-2151"><a href="#cb8-2151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb8-2152"><a href="#cb8-2152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2153"><a href="#cb8-2153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2154"><a href="#cb8-2154" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicting response to endocrine therapy</span></span>
<span id="cb8-2155"><a href="#cb8-2155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2156"><a href="#cb8-2156" aria-hidden="true" tabindex="-1"></a>We now try to use a penalized logistic regression to predict patient</span>
<span id="cb8-2157"><a href="#cb8-2157" aria-hidden="true" tabindex="-1"></a>response, as defined by the POETIC trialists using the principal</span>
<span id="cb8-2158"><a href="#cb8-2158" aria-hidden="true" tabindex="-1"></a>components. For this we already saw that in average the patients further</span>
<span id="cb8-2159"><a href="#cb8-2159" aria-hidden="true" tabindex="-1"></a>to the left are non-responders and further to the right would be responders,</span>
<span id="cb8-2160"><a href="#cb8-2160" aria-hidden="true" tabindex="-1"></a>suggesting a predictive power of the molecular landscape. The landscape still</span>
<span id="cb8-2161"><a href="#cb8-2161" aria-hidden="true" tabindex="-1"></a>is not perfect as there is a lot of overlap between the responders and </span>
<span id="cb8-2162"><a href="#cb8-2162" aria-hidden="true" tabindex="-1"></a>non-responders. So we try to use more principal components to </span>
<span id="cb8-2163"><a href="#cb8-2163" aria-hidden="true" tabindex="-1"></a>capture the differences. </span>
<span id="cb8-2164"><a href="#cb8-2164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2165"><a href="#cb8-2165" aria-hidden="true" tabindex="-1"></a>Just when randomizing the train test split, we need to make sure that</span>
<span id="cb8-2166"><a href="#cb8-2166" aria-hidden="true" tabindex="-1"></a>we include some of the samples that are in the basal like region in </span>
<span id="cb8-2167"><a href="#cb8-2167" aria-hidden="true" tabindex="-1"></a>both splits, since they are in small numbers. Due to the small sample</span>
<span id="cb8-2168"><a href="#cb8-2168" aria-hidden="true" tabindex="-1"></a>size, we use the components starting from 3 and going up to 20.</span>
<span id="cb8-2169"><a href="#cb8-2169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2172"><a href="#cb8-2172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2173"><a href="#cb8-2173" aria-hidden="true" tabindex="-1"></a>nb_components <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">20</span></span>
<span id="cb8-2174"><a href="#cb8-2174" aria-hidden="true" tabindex="-1"></a>poetic_pcs_response <span class="ot">&lt;-</span> poetic_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb8-2175"><a href="#cb8-2175" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb8-2176"><a href="#cb8-2176" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-2177"><a href="#cb8-2177" aria-hidden="true" tabindex="-1"></a>            timepoint <span class="sc">==</span> <span class="st">"baseline"</span> <span class="sc">&amp;</span> </span>
<span id="cb8-2178"><a href="#cb8-2178" aria-hidden="true" tabindex="-1"></a>            is_responder <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"responder"</span>, <span class="st">"non_responder"</span>)</span>
<span id="cb8-2179"><a href="#cb8-2179" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-2180"><a href="#cb8-2180" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb8-2181"><a href="#cb8-2181" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample_name"</span>,</span>
<span id="cb8-2182"><a href="#cb8-2182" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_responder"</span>,</span>
<span id="cb8-2183"><a href="#cb8-2183" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">"PC"</span>, nb_components)</span>
<span id="cb8-2184"><a href="#cb8-2184" aria-hidden="true" tabindex="-1"></a>    )))</span>
<span id="cb8-2185"><a href="#cb8-2185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2186"><a href="#cb8-2186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2187"><a href="#cb8-2187" aria-hidden="true" tabindex="-1"></a>In this dataset the total of responders vs non responder is:</span>
<span id="cb8-2188"><a href="#cb8-2188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2191"><a href="#cb8-2191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2192"><a href="#cb8-2192" aria-hidden="true" tabindex="-1"></a>poetic_pcs_response <span class="sc">%&gt;%</span> </span>
<span id="cb8-2193"><a href="#cb8-2193" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-2194"><a href="#cb8-2194" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-2195"><a href="#cb8-2195" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatPercentage</span>(<span class="st">"percent"</span>)</span>
<span id="cb8-2196"><a href="#cb8-2196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2197"><a href="#cb8-2197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2198"><a href="#cb8-2198" aria-hidden="true" tabindex="-1"></a>More than 2/3 are responders. Using a set seed for the randomization, </span>
<span id="cb8-2199"><a href="#cb8-2199" aria-hidden="true" tabindex="-1"></a>the numbers of responders and non responders are shown below for the training</span>
<span id="cb8-2200"><a href="#cb8-2200" aria-hidden="true" tabindex="-1"></a>set.</span>
<span id="cb8-2201"><a href="#cb8-2201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2204"><a href="#cb8-2204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2205"><a href="#cb8-2205" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb8-2206"><a href="#cb8-2206" aria-hidden="true" tabindex="-1"></a>train_poetic <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb8-2207"><a href="#cb8-2207" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(poetic_pcs_response), </span>
<span id="cb8-2208"><a href="#cb8-2208" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">floor</span>(<span class="dv">2</span><span class="sc">/</span><span class="dv">3</span> <span class="sc">*</span> <span class="fu">nrow</span>(poetic_pcs_response))</span>
<span id="cb8-2209"><a href="#cb8-2209" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-2210"><a href="#cb8-2210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2211"><a href="#cb8-2211" aria-hidden="true" tabindex="-1"></a>poetic_pcs_response <span class="sc">%&gt;%</span> </span>
<span id="cb8-2212"><a href="#cb8-2212" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> train_poetic) <span class="sc">%&gt;%</span></span>
<span id="cb8-2213"><a href="#cb8-2213" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-2214"><a href="#cb8-2214" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-2215"><a href="#cb8-2215" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatPercentage</span>(<span class="st">"percent"</span>)</span>
<span id="cb8-2216"><a href="#cb8-2216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2217"><a href="#cb8-2217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2218"><a href="#cb8-2218" aria-hidden="true" tabindex="-1"></a>And for the test set.</span>
<span id="cb8-2219"><a href="#cb8-2219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2222"><a href="#cb8-2222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2223"><a href="#cb8-2223" aria-hidden="true" tabindex="-1"></a>poetic_pcs_response <span class="sc">%&gt;%</span> </span>
<span id="cb8-2224"><a href="#cb8-2224" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(sample_name <span class="sc">%in%</span> train_poetic)) <span class="sc">%&gt;%</span></span>
<span id="cb8-2225"><a href="#cb8-2225" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(is_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-2226"><a href="#cb8-2226" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-2227"><a href="#cb8-2227" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">formatPercentage</span>(<span class="st">"percent"</span>)</span>
<span id="cb8-2228"><a href="#cb8-2228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2229"><a href="#cb8-2229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2230"><a href="#cb8-2230" aria-hidden="true" tabindex="-1"></a>And we compare the PC3 values distributions to see if they are </span>
<span id="cb8-2231"><a href="#cb8-2231" aria-hidden="true" tabindex="-1"></a>equally distributed.</span>
<span id="cb8-2232"><a href="#cb8-2232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2235"><a href="#cb8-2235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2236"><a href="#cb8-2236" aria-hidden="true" tabindex="-1"></a>poetic_pcs_response <span class="ot">&lt;-</span> poetic_pcs_response <span class="sc">%&gt;%</span></span>
<span id="cb8-2237"><a href="#cb8-2237" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">train_or_test =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-2238"><a href="#cb8-2238" aria-hidden="true" tabindex="-1"></a>        sample_name <span class="sc">%in%</span> train_poetic,</span>
<span id="cb8-2239"><a href="#cb8-2239" aria-hidden="true" tabindex="-1"></a>        <span class="st">"train"</span>,</span>
<span id="cb8-2240"><a href="#cb8-2240" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test"</span></span>
<span id="cb8-2241"><a href="#cb8-2241" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb8-2242"><a href="#cb8-2242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2243"><a href="#cb8-2243" aria-hidden="true" tabindex="-1"></a>poetic_pcs_response <span class="sc">%&gt;%</span></span>
<span id="cb8-2244"><a href="#cb8-2244" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb8-2245"><a href="#cb8-2245" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb8-2246"><a href="#cb8-2246" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pc"</span>,</span>
<span id="cb8-2247"><a href="#cb8-2247" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"position"</span></span>
<span id="cb8-2248"><a href="#cb8-2248" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-2249"><a href="#cb8-2249" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> position, <span class="at">fill =</span> train_or_test)) <span class="sc">+</span></span>
<span id="cb8-2250"><a href="#cb8-2250" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(</span>
<span id="cb8-2251"><a href="#cb8-2251" aria-hidden="true" tabindex="-1"></a>        <span class="at">position =</span> <span class="st">"identity"</span>, </span>
<span id="cb8-2252"><a href="#cb8-2252" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.4</span>,</span>
<span id="cb8-2253"><a href="#cb8-2253" aria-hidden="true" tabindex="-1"></a>        <span class="at">bins =</span> <span class="dv">20</span></span>
<span id="cb8-2254"><a href="#cb8-2254" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb8-2255"><a href="#cb8-2255" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pc, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb8-2256"><a href="#cb8-2256" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb8-2257"><a href="#cb8-2257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2258"><a href="#cb8-2258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2259"><a href="#cb8-2259" aria-hidden="true" tabindex="-1"></a>They are similarly distributed, so we can proceed with the training and</span>
<span id="cb8-2260"><a href="#cb8-2260" aria-hidden="true" tabindex="-1"></a>testing strategy. </span>
<span id="cb8-2261"><a href="#cb8-2261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2264"><a href="#cb8-2264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2265"><a href="#cb8-2265" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">&lt;-</span> poetic_pcs_response <span class="sc">%&gt;%</span></span>
<span id="cb8-2266"><a href="#cb8-2266" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(train_or_test <span class="sc">==</span> <span class="st">"train"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-2267"><a href="#cb8-2267" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(</span>
<span id="cb8-2268"><a href="#cb8-2268" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">"PC"</span>, nb_components)</span>
<span id="cb8-2269"><a href="#cb8-2269" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb8-2270"><a href="#cb8-2270" aria-hidden="true" tabindex="-1"></a>    as.matrix</span>
<span id="cb8-2271"><a href="#cb8-2271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2272"><a href="#cb8-2272" aria-hidden="true" tabindex="-1"></a>x_test <span class="ot">&lt;-</span> poetic_pcs_response <span class="sc">%&gt;%</span></span>
<span id="cb8-2273"><a href="#cb8-2273" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(train_or_test <span class="sc">==</span> <span class="st">"test"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-2274"><a href="#cb8-2274" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(</span>
<span id="cb8-2275"><a href="#cb8-2275" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">"PC"</span>, nb_components)</span>
<span id="cb8-2276"><a href="#cb8-2276" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb8-2277"><a href="#cb8-2277" aria-hidden="true" tabindex="-1"></a>    as.matrix</span>
<span id="cb8-2278"><a href="#cb8-2278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2279"><a href="#cb8-2279" aria-hidden="true" tabindex="-1"></a>y_all <span class="ot">&lt;-</span> poetic_pcs_response <span class="sc">%&gt;%</span></span>
<span id="cb8-2280"><a href="#cb8-2280" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_responder =</span> <span class="fu">ifelse</span>(</span>
<span id="cb8-2281"><a href="#cb8-2281" aria-hidden="true" tabindex="-1"></a>        is_responder <span class="sc">==</span> <span class="st">"responder"</span>,</span>
<span id="cb8-2282"><a href="#cb8-2282" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>,</span>
<span id="cb8-2283"><a href="#cb8-2283" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span></span>
<span id="cb8-2284"><a href="#cb8-2284" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb8-2285"><a href="#cb8-2285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2286"><a href="#cb8-2286" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> y_all <span class="sc">%&gt;%</span></span>
<span id="cb8-2287"><a href="#cb8-2287" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(train_or_test <span class="sc">==</span> <span class="st">"train"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-2288"><a href="#cb8-2288" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(is_responder)</span>
<span id="cb8-2289"><a href="#cb8-2289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2290"><a href="#cb8-2290" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> y_all <span class="sc">%&gt;%</span></span>
<span id="cb8-2291"><a href="#cb8-2291" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(train_or_test <span class="sc">==</span> <span class="st">"test"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-2292"><a href="#cb8-2292" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(is_responder)</span>
<span id="cb8-2293"><a href="#cb8-2293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-2294"><a href="#cb8-2294" aria-hidden="true" tabindex="-1"></a>fit_responders <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">cv.glmnet</span>(</span>
<span id="cb8-2295"><a href="#cb8-2295" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb8-2296"><a href="#cb8-2296" aria-hidden="true" tabindex="-1"></a>    y_train, </span>
<span id="cb8-2297"><a href="#cb8-2297" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>, </span>
<span id="cb8-2298"><a href="#cb8-2298" aria-hidden="true" tabindex="-1"></a>    <span class="at">type.measure =</span> <span class="st">"class"</span></span>
<span id="cb8-2299"><a href="#cb8-2299" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-2300"><a href="#cb8-2300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2301"><a href="#cb8-2301" aria-hidden="true" tabindex="-1"></a>coefs_vals <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_responders, <span class="at">s =</span> <span class="st">"lambda.1se"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-2302"><a href="#cb8-2302" aria-hidden="true" tabindex="-1"></a>    as.matrix</span>
<span id="cb8-2303"><a href="#cb8-2303" aria-hidden="true" tabindex="-1"></a>coefs_vals <span class="ot">&lt;-</span> coefs_vals[coefs_vals[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>, ]</span>
<span id="cb8-2304"><a href="#cb8-2304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2305"><a href="#cb8-2305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2306"><a href="#cb8-2306" aria-hidden="true" tabindex="-1"></a>The plot below shows the misclassification error versus the </span>
<span id="cb8-2307"><a href="#cb8-2307" aria-hidden="true" tabindex="-1"></a>lambda used for the penalization term in the logistic regression. </span>
<span id="cb8-2308"><a href="#cb8-2308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2309"><a href="#cb8-2309" aria-hidden="true" tabindex="-1"></a>The plot below shows the misclassification error for different $\lambda$</span>
<span id="cb8-2310"><a href="#cb8-2310" aria-hidden="true" tabindex="-1"></a>values and number of components.</span>
<span id="cb8-2311"><a href="#cb8-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2314"><a href="#cb8-2314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2315"><a href="#cb8-2315" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_responders, <span class="at">xlab =</span> <span class="st">"log(lambda)"</span>)</span>
<span id="cb8-2316"><a href="#cb8-2316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2317"><a href="#cb8-2317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2318"><a href="#cb8-2318" aria-hidden="true" tabindex="-1"></a>Overall the misclassification is pretty similar for all number of variables.</span>
<span id="cb8-2319"><a href="#cb8-2319" aria-hidden="true" tabindex="-1"></a>We select the variables obtained with the lambda that is 1 SE away </span>
<span id="cb8-2320"><a href="#cb8-2320" aria-hidden="true" tabindex="-1"></a>from the minimum. So in total we have three variables: </span>
<span id="cb8-2321"><a href="#cb8-2321" aria-hidden="true" tabindex="-1"></a>The intercept and <span class="in">`r names(coefs_vals)[2:length(coefs_vals)]`</span>. </span>
<span id="cb8-2322"><a href="#cb8-2322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2323"><a href="#cb8-2323" aria-hidden="true" tabindex="-1"></a>And below we show the confusion matrix.</span>
<span id="cb8-2324"><a href="#cb8-2324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2327"><a href="#cb8-2327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2328"><a href="#cb8-2328" aria-hidden="true" tabindex="-1"></a>cnf_test <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">confusion.glmnet</span>(</span>
<span id="cb8-2329"><a href="#cb8-2329" aria-hidden="true" tabindex="-1"></a>    fit_responders, </span>
<span id="cb8-2330"><a href="#cb8-2330" aria-hidden="true" tabindex="-1"></a>    <span class="at">newx =</span> x_test, </span>
<span id="cb8-2331"><a href="#cb8-2331" aria-hidden="true" tabindex="-1"></a>    <span class="at">newy =</span> y_test,</span>
<span id="cb8-2332"><a href="#cb8-2332" aria-hidden="true" tabindex="-1"></a>    <span class="at">s =</span> <span class="st">"lambda.1se"</span></span>
<span id="cb8-2333"><a href="#cb8-2333" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-2334"><a href="#cb8-2334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2335"><a href="#cb8-2335" aria-hidden="true" tabindex="-1"></a>cnf_test</span>
<span id="cb8-2336"><a href="#cb8-2336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2337"><a href="#cb8-2337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2338"><a href="#cb8-2338" aria-hidden="true" tabindex="-1"></a>We see that the accuracy is very low and most of the patients are </span>
<span id="cb8-2339"><a href="#cb8-2339" aria-hidden="true" tabindex="-1"></a>classified as responders. This could be potentially due to the</span>
<span id="cb8-2340"><a href="#cb8-2340" aria-hidden="true" tabindex="-1"></a>class imbalance, but the results are still underwhelming. </span>
<span id="cb8-2341"><a href="#cb8-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2342"><a href="#cb8-2342" aria-hidden="true" tabindex="-1"></a>Let us take a look on the patients that were predicted to be</span>
<span id="cb8-2343"><a href="#cb8-2343" aria-hidden="true" tabindex="-1"></a>non responders and check their Ki67 differences in baseline and</span>
<span id="cb8-2344"><a href="#cb8-2344" aria-hidden="true" tabindex="-1"></a>surgery.</span>
<span id="cb8-2345"><a href="#cb8-2345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2348"><a href="#cb8-2348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-2349"><a href="#cb8-2349" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb8-2350"><a href="#cb8-2350" aria-hidden="true" tabindex="-1"></a>    fit_responders, </span>
<span id="cb8-2351"><a href="#cb8-2351" aria-hidden="true" tabindex="-1"></a>    <span class="at">newx =</span> x_test, </span>
<span id="cb8-2352"><a href="#cb8-2352" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"class"</span>,</span>
<span id="cb8-2353"><a href="#cb8-2353" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="st">"lambda.1se"</span></span>
<span id="cb8-2354"><a href="#cb8-2354" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-2355"><a href="#cb8-2355" aria-hidden="true" tabindex="-1"></a>patients_non_responder <span class="ot">&lt;-</span> <span class="fu">rownames</span>(x_test)[<span class="fu">which</span>(y_pred <span class="sc">==</span> <span class="st">"0"</span>)]</span>
<span id="cb8-2356"><a href="#cb8-2356" aria-hidden="true" tabindex="-1"></a>poetic_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb8-2357"><a href="#cb8-2357" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> patients_non_responder) <span class="sc">%&gt;%</span></span>
<span id="cb8-2358"><a href="#cb8-2358" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(PC3, change_ki67, ki67)</span>
<span id="cb8-2359"><a href="#cb8-2359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-2360"><a href="#cb8-2360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2361"><a href="#cb8-2361" aria-hidden="true" tabindex="-1"></a>All the patients that were misclassified as non responders they have a </span>
<span id="cb8-2362"><a href="#cb8-2362" aria-hidden="true" tabindex="-1"></a>very low third principal component and their baseline Ki67 is quite high, so</span>
<span id="cb8-2363"><a href="#cb8-2363" aria-hidden="true" tabindex="-1"></a>the decrease in proliferation is not actually big enough. It is still</span>
<span id="cb8-2364"><a href="#cb8-2364" aria-hidden="true" tabindex="-1"></a>considered a responder. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chronchi">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/chronchi">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>
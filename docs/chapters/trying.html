<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>EMBER creates a unified space for independent breast cancer transcriptomic datasets enabling precision oncology. - 7&nbsp; Tests and tries</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/revision.html" rel="next">
<link href="../chapters/expanding_ember.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/trying.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Tests and tries</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">EMBER creates a unified space for independent breast cancer transcriptomic datasets enabling precision oncology.</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chronchi/molecular_landscape" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/surv_analysis_estrogen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Estrogen receptor status is continuous, not dichotomous</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/pca_merging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A new framework for personalized medicine: integrating</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Validating the molecular landscape</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/scoring.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Pathway activity in a personalized context</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/risk_score.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk score model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/expanding_ember.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Expanding embedding and removing batch effects</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/trying.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Tests and tries</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/revision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Revision</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/discussion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discussion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#using-several-pathways-or-just-one-pathway-for-gsva" id="toc-using-several-pathways-or-just-one-pathway-for-gsva" class="nav-link active" data-scroll-target="#using-several-pathways-or-just-one-pathway-for-gsva"><span class="header-section-number">7.1</span> Using several pathways or just one pathway for GSVA</a>
  <ul class="collapse">
  <li><a href="#one-vs-all" id="toc-one-vs-all" class="nav-link" data-scroll-target="#one-vs-all"><span class="header-section-number">7.1.1</span> One vs all</a></li>
  </ul></li>
  <li><a href="#minimum-number-of-samples-for-gsva" id="toc-minimum-number-of-samples-for-gsva" class="nav-link" data-scroll-target="#minimum-number-of-samples-for-gsva"><span class="header-section-number">7.2</span> Minimum number of samples for GSVA</a></li>
  <li><a href="#normalization-strategy" id="toc-normalization-strategy" class="nav-link" data-scroll-target="#normalization-strategy"><span class="header-section-number">7.3</span> Normalization strategy</a></li>
  <li><a href="#genefu" id="toc-genefu" class="nav-link" data-scroll-target="#genefu"><span class="header-section-number">7.4</span> genefu</a>
  <ul class="collapse">
  <li><a href="#genefu-and-aims" id="toc-genefu-and-aims" class="nav-link" data-scroll-target="#genefu-and-aims"><span class="header-section-number">7.4.1</span> genefu and AIMS</a></li>
  </ul></li>
  <li><a href="#nanostring-signatures" id="toc-nanostring-signatures" class="nav-link" data-scroll-target="#nanostring-signatures"><span class="header-section-number">7.5</span> nanostring signatures</a></li>
  <li><a href="#risk-stratification-and-the-molecular-landscape" id="toc-risk-stratification-and-the-molecular-landscape" class="nav-link" data-scroll-target="#risk-stratification-and-the-molecular-landscape"><span class="header-section-number">7.6</span> Risk stratification and the molecular landscape</a></li>
  <li><a href="#late-distant-recurrence-trying-to-find-biomarkers" id="toc-late-distant-recurrence-trying-to-find-biomarkers" class="nav-link" data-scroll-target="#late-distant-recurrence-trying-to-find-biomarkers"><span class="header-section-number">7.7</span> Late distant recurrence: trying to find biomarkers</a></li>
  <li><a href="#correlation-of-pathways-with-proliferation" id="toc-correlation-of-pathways-with-proliferation" class="nav-link" data-scroll-target="#correlation-of-pathways-with-proliferation"><span class="header-section-number">7.8</span> Correlation of pathways with proliferation</a></li>
  <li><a href="#ilc-and-position-in-the-molecular-landscape" id="toc-ilc-and-position-in-the-molecular-landscape" class="nav-link" data-scroll-target="#ilc-and-position-in-the-molecular-landscape"><span class="header-section-number">7.9</span> ILC and position in the molecular landscape</a></li>
  <li><a href="#robustness-to-library-protocol" id="toc-robustness-to-library-protocol" class="nav-link" data-scroll-target="#robustness-to-library-protocol"><span class="header-section-number">7.10</span> Robustness to library protocol</a></li>
  <li><a href="#distance-in-4th-component-for-poetic" id="toc-distance-in-4th-component-for-poetic" class="nav-link" data-scroll-target="#distance-in-4th-component-for-poetic"><span class="header-section-number">7.11</span> Distance in 4th component for POETIC</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chronchi/molecular_landscape/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Tests and tries</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This is a file where we try different things using the molecular data. We keep it here in case anyone finds anything here interesting and would like to further discuss with us for potential collaborations.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>* The library is already synchronized with the lockfile.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    ../../results/plots/trying ../../results/rds_files/trying 
                         FALSE                          FALSE 
   ../../results/tables/trying 
                         FALSE </code></pre>
</div>
</div>
<section id="using-several-pathways-or-just-one-pathway-for-gsva" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="using-several-pathways-or-just-one-pathway-for-gsva"><span class="header-section-number">7.1</span> Using several pathways or just one pathway for GSVA</h2>
<p>We now evaluate the effect of the scores for each pathway when using all the 53 pathways combined and each one individually. We use only TCGA for this step.</p>
<section id="one-vs-all" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="one-vs-all"><span class="header-section-number">7.1.1</span> One vs all</h3>
<p>We now calculate the scores for each gene set individually.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="1920"></p>
</div>
</div>
<p>It seems they are all positively correlated, so one could calculate the scores basically using just one gene set with exception of some of the gene sets.</p>
</section>
</section>
<section id="minimum-number-of-samples-for-gsva" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="minimum-number-of-samples-for-gsva"><span class="header-section-number">7.2</span> Minimum number of samples for GSVA</h2>
<p>According to the original GSVA paper, a minimum of 10 samples are necessary to have a good power when using GSVA. Since here we have at least 5 molecular subgroups, we hypothesize we need at least 50 samples to get a good score so we can compare across cohorts. We will try with different numbers of samples using TCGA, we start with 10, 25, 50 and 100 samples and we compare with the scores using the full dataset.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="4800"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="4800"></p>
</div>
</div>
<p>The conclusion we can take here is that depending on the gene set not even 150 samples is enough. For some only 25 patients is already enough, such as SET ER/PR, androgen response, estrogen response early and E2F targets.</p>
<p>Could we mix around 20 samples of SCANB together with more samples from TCGA and METABRIC to get the scores? Let us try to adress this question again. We are using the regressed data now here as this is the only way.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="1920"></p>
</div>
</div>
<p>There is still some correlation but the scores are shrinked in the end.</p>
</section>
<section id="normalization-strategy" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="normalization-strategy"><span class="header-section-number">7.3</span> Normalization strategy</h2>
<p>We can also try another way of normalizing, namely for each sample we can z scale it.</p>
<p>And now we can visualize the results.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-embeddings-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-pca-embeddings-3-1.png" class="img-fluid figure-img" width="1344"></p>
<figcaption class="figure-caption">Figure&nbsp;7.1: PCA projections colored by different factors and organized by different components. (A) Plot of the first two components colored by cohort. (B) Plot of the first two components colored by ER status. (C) Plot of the second and third components colored by cohort. (D) Plot of the second and third components colored by ER status. (E) Plot of the second and third components colored by PAM50. (F) Plot of the second and third components colored by INTCLUST, only METABRIC has an assigned value for this variable, NAs are TCGA samples.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that samples are well embedded as well.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb-pc1-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-pca-scanb-pc1-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;7.2: PCA embedding colored by cohort. The components used are the first and second components.</figcaption>
</figure>
</div>
</div>
</div>
<p>SCANB and POETIC are in between as expected and they are closer to their sequencing technology. Interestingly the variation for SCANB and TCGA are compressed in the PC1 vs PC2 axis compared to METABRIC and POETIC.</p>
<p><a href="#fig-pca-scanb-er-pam50-2">Figure&nbsp;<span>7.3</span></a> shows that the SCANB samples are also well mixed regarding the clinical factors, including the <span class="math inline">\(SET_{ER/PR}\)</span> signature.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-scanb-er-pam50-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-pca-scanb-er-pam50-2-1.png" class="img-fluid figure-img" width="1536"></p>
<figcaption class="figure-caption">Figure&nbsp;7.3: PCA embedding of all samples from TCGA, SCANB and METABRIC. (A) Colored by cohort, (B) colored by ER status, (C) colored by PAM50 molecular subtype, (D) colored by the <span class="math inline">\(SET_{ER/PR}\)</span> signature and only SCANB samples.</figcaption>
</figure>
</div>
</div>
</div>
<p>In the end normalizing by scaling the sample before doing any embedding works as well. Though the embedding seems to be more compressed. I would argue that the qPCR-like normalization gives a bit better embedding.</p>
</section>
<section id="genefu" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="genefu"><span class="header-section-number">7.4</span> genefu</h2>
<p>With genefu it is possible to calculate scores from comercially available signatures. Here we try to use it on SCANB, METABRIC and TCGA. Moreover, we can start with ABiM, as this dataset has the gold standard ROR score obtained from nCounter data. This is a good way of validating the pipeline.</p>
<p>We start by comparing the molecular subtypes:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
FALSE  TRUE 
   14    86 </code></pre>
</div>
</div>
<p>86 out of 100 were correctly called. Here we are using the gold standard wich is the molecular subtype called from FT samples. The normal like subtype is not available from the FT prosigna assay. So we now compare the results with the SSP obtained from the SCANB team.</p>
<p>Below is the confusion matrix to see which subtypes were misclassified.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction Basal Her2 LumB LumA Normal
    Basal     13    0    0    0      0
    Her2       0    8    0    0      0
    LumB       1    1   33    1      0
    LumA       1    0    7   32      0
    Normal     1    0    0    2      0

Overall Statistics
                                          
               Accuracy : 0.86            
                 95% CI : (0.7763, 0.9213)
    No Information Rate : 0.4             
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.7965          
                                          
 Mcnemar's Test P-Value : NA              

Statistics by Class:

                     Class: Basal Class: Her2 Class: LumB Class: LumA
Sensitivity                0.8125      0.8889      0.8250      0.9143
Specificity                1.0000      1.0000      0.9500      0.8769
Pos Pred Value             1.0000      1.0000      0.9167      0.8000
Neg Pred Value             0.9655      0.9891      0.8906      0.9500
Prevalence                 0.1600      0.0900      0.4000      0.3500
Detection Rate             0.1300      0.0800      0.3300      0.3200
Detection Prevalence       0.1300      0.0800      0.3600      0.4000
Balanced Accuracy          0.9062      0.9444      0.8875      0.8956
                     Class: Normal
Sensitivity                     NA
Specificity                   0.97
Pos Pred Value                  NA
Neg Pred Value                  NA
Prevalence                    0.00
Detection Rate                0.00
Detection Prevalence          0.03
Balanced Accuracy               NA</code></pre>
</div>
</div>
<p>All luminal A were predicted correctly. Some normal like were predicted to be luminal A or basal and Her2. There were some mismatches for the LumB, that were misclassified as LumA. Still it is ok.</p>
<p>Let us now calculate the ROR for the ABiM cohort.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ror-genefu-abim" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-ror-genefu-abim-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;7.4: Correlation between ROR obtained from prosigna assay and R package genefu</figcaption>
</figure>
</div>
</div>
</div>
<p>The correlation is relatively good and respects the molecular subtypes in general. The ROR obtained from genefu for some luminal B are not quite right as they are below 50.</p>
<p>We now move on to the other signatures: Mammaprint, EndoPredict (EP) and OncotypeDX Risk Score (RS).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ror-mammaprint-genefu-abim" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-ror-mammaprint-genefu-abim-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;7.5: Correlation between ROR obtained from prosigna assay and the mammaprint signature obtained from the R package genefu</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-ror-mammaprint-genefu-abim">Figure&nbsp;<span>7.5</span></a> shows the correlation between the mammaprint signature (named GENE70) and the ROR from prosigna.</p>
<p>Let us now compare the GENE70 signature with the risk score developed in the previous chapters. We use the ABiM 100 cohort to make the comparison. One side note, we are using only 51 out of the 70 probes available in the package. 15 probes don’t have any corresponding symbol. Out of the available genes, some are duplicated. For the duplicated genes, the correlation coefficients are all similar, so we can select just the first ocurrence in the list.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There is a good correlation between the two signatures, suggesting that the Mammaprint signature is somehow based on the position of the samples in the molecular landscape.</p>
<p>We now proceed and calculate the mammaprint scores for SCANB and METABRIC as well and only for ER+ BC samples.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-met-scanb-mammaprint" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-met-scanb-mammaprint-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Figure&nbsp;7.6: Embedding of ER+ BC samples colored by the mammaprint score.</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that the pattern is very close to what we have from the risk score created in the previous chapter. The figure below shows the correlation between mammaprint and the risk score once again.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="1344"></p>
</div>
</div>
<p>Now for OncotypeDX:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ror-genefu-abim-oncotype" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-ror-genefu-abim-oncotype-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;7.7: Correlation between oncotypeDX and R package genefu</figcaption>
</figure>
</div>
</div>
</div>
<p>There is also a correlation between the risk score and oncotypeDX. The paper https://www.nature.com/articles/s41523-022-00492-0#Sec8 also used the genefu for calculating the oncotypeDX.</p>
<section id="genefu-and-aims" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="genefu-and-aims"><span class="header-section-number">7.4.1</span> genefu and AIMS</h3>
<p>Here we try to use AIMS to calculate the PAM50 subtypes for the and compare with the results obtained previously. We want to compare the classifications with the molecular landscape.</p>
<p>The confusion matrix below show the results of the AIMS PAM50 as the predicted and the reference is the PAM50 subtypes obtained from the SCANB team.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction luma her2 normal lumb basal
    luma   2301   61     51  664     0
    her2      9  627     16  200     4
    normal  724   37    830    6    11
    lumb     17   17      0  938     0
    basal     0   75     14    0   614

Overall Statistics
                                         
               Accuracy : 0.7359         
                 95% CI : (0.7255, 0.746)
    No Information Rate : 0.4228         
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16      
                                         
                  Kappa : 0.6411         
                                         
 Mcnemar's Test P-Value : NA             

Statistics by Class:

                     Class: luma Class: her2 Class: normal Class: lumb
Sensitivity               0.7542     0.76744        0.9111      0.5188
Specificity               0.8137     0.96421        0.8766      0.9937
Pos Pred Value            0.7478     0.73248        0.5162      0.9650
Neg Pred Value            0.8188     0.97013        0.9856      0.8607
Prevalence                0.4228     0.11322        0.1262      0.2506
Detection Rate            0.3189     0.08689        0.1150      0.1300
Detection Prevalence      0.4264     0.11863        0.2228      0.1347
Balanced Accuracy         0.7839     0.86583        0.8938      0.7563
                     Class: basal
Sensitivity               0.97615
Specificity               0.98649
Pos Pred Value            0.87340
Neg Pred Value            0.99770
Prevalence                0.08717
Detection Rate            0.08509
Detection Prevalence      0.09742
Balanced Accuracy         0.98132</code></pre>
</div>
</div>
<p>We see that there is a big misclassification from luminal A samples to normal like samples and several luminal B are misclassified as luminal A.</p>
<p>The plot below shows the coloring by the reference PAM50 and the predicted by AIMS.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scanb-aims" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-scanb-aims-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;7.8: SCANB embedding stratified by PAM50 algorithms by both the ones provided by the SCANB (SSP) and the AIMS algorithm</figcaption>
</figure>
</div>
</div>
</div>
<p>On the left there is the coloring for the AIMS algorithm and on the right from the reference. We see the missclassified samples are not randomly misclassified, they are on the boundaries.</p>
<p>The plot below shows the maximum probability score for each sample individually.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="384"></p>
</div>
</div>
<p>The majority of samples have probabilities of either 1 or 0. Not so often in between.</p>
<p>And the figure below shows the confusion matrix for the ABIM cohort.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction luma lumb her2 normal
    luma     28   17    1      3
    lumb      0   16    0      0
    her2      0    0   10      0
    normal    2    0    2      2

Overall Statistics
                                          
               Accuracy : 0.6914          
                 95% CI : (0.5789, 0.7893)
    No Information Rate : 0.4074          
    P-Value [Acc &gt; NIR] : 2.253e-07       
                                          
                  Kappa : 0.5401          
                                          
 Mcnemar's Test P-Value : NA              

Statistics by Class:

                     Class: luma Class: lumb Class: her2 Class: normal
Sensitivity               0.9333      0.4848      0.7692       0.40000
Specificity               0.5882      1.0000      1.0000       0.94737
Pos Pred Value            0.5714      1.0000      1.0000       0.33333
Neg Pred Value            0.9375      0.7385      0.9577       0.96000
Prevalence                0.3704      0.4074      0.1605       0.06173
Detection Rate            0.3457      0.1975      0.1235       0.02469
Detection Prevalence      0.6049      0.1975      0.1235       0.07407
Balanced Accuracy         0.7608      0.7424      0.8846       0.67368</code></pre>
</div>
</div>
<p>We see here that in this case that there are several luminal B samples missclassified as luminal A.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>The misclassified samples from AIMS they really seem to be on the top region together with the luminal A. Some of the normal samples are even in the luminal A region.</p>
<p>And another validation is using the normal cohort. Below is the number of all predicted molecular subtypes.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Normal 
    66 </code></pre>
</div>
</div>
<p>All samples are normal-like as expected, since they are normal.</p>
</section>
</section>
<section id="nanostring-signatures" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="nanostring-signatures"><span class="header-section-number">7.5</span> nanostring signatures</h2>
<p>In this section we try the nanostring panel signatures provided by the Breast Cancer 360 test. We will compare some of the signatures by using GSVA on the original datasets and by calculating the sum of the gene expression levels of the genes when regressing out the 1st, 2nd and 5th components.</p>
<p>The table below shows the number of genes available for each signature and each dataset. In general it seems that all signatures have over 70% of the genes available, a good indication.</p>
<div class="cell">
<div class="cell-output-display">
<table class="lightable-classic table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">pathway</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tcga</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">scanb</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">metabric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">poetic</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">average_percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">adhesion_and_migration</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">83</td>
<td style="text-align: right;">83</td>
<td style="text-align: left;">0.83</td>
</tr>
<tr class="even">
<td style="text-align: left;">angiogenesis</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">34</td>
<td style="text-align: left;">0.85</td>
</tr>
<tr class="odd">
<td style="text-align: left;">antigen_presentation</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">0.92</td>
</tr>
<tr class="even">
<td style="text-align: left;">apoptosis</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">0.78</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cytokine_and_chemokine_signaling</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">50</td>
<td style="text-align: left;">0.76</td>
</tr>
<tr class="even">
<td style="text-align: left;">dna_damage_repair</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">108</td>
<td style="text-align: right;">118</td>
<td style="text-align: right;">133</td>
<td style="text-align: right;">143</td>
<td style="text-align: left;">0.85</td>
</tr>
<tr class="odd">
<td style="text-align: left;">emt</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">85</td>
<td style="text-align: left;">0.85</td>
</tr>
<tr class="even">
<td style="text-align: left;">er_signaling</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">27</td>
<td style="text-align: left;">0.94</td>
</tr>
<tr class="odd">
<td style="text-align: left;">epigenetic_regulation</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">0.88</td>
</tr>
<tr class="even">
<td style="text-align: left;">hedgehog</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">20</td>
<td style="text-align: left;">0.76</td>
</tr>
<tr class="odd">
<td style="text-align: left;">immune_infiltration</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">34</td>
<td style="text-align: left;">0.75</td>
</tr>
<tr class="even">
<td style="text-align: left;">jak_stat</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">47</td>
<td style="text-align: left;">0.81</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mapk</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">95</td>
<td style="text-align: right;">100</td>
<td style="text-align: left;">0.73</td>
</tr>
<tr class="even">
<td style="text-align: left;">notch</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">22</td>
<td style="text-align: left;">0.88</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pi3k</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">96</td>
<td style="text-align: left;">0.76</td>
</tr>
<tr class="even">
<td style="text-align: left;">proliferation</td>
<td style="text-align: right;">121</td>
<td style="text-align: right;">113</td>
<td style="text-align: right;">114</td>
<td style="text-align: right;">136</td>
<td style="text-align: right;">144</td>
<td style="text-align: left;">0.84</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stromal_markers</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">subtypes</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">70</td>
<td style="text-align: left;">0.94</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tgf_beta</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">57</td>
<td style="text-align: left;">0.83</td>
</tr>
<tr class="even">
<td style="text-align: left;">transcriptional_misregulation</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">63</td>
<td style="text-align: left;">0.74</td>
</tr>
<tr class="odd">
<td style="text-align: left;">triple_negative_biology</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">50</td>
<td style="text-align: left;">0.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">tumor_metabolism</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">15</td>
<td style="text-align: left;">0.97</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wnt</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">51</td>
<td style="text-align: left;">0.81</td>
</tr>
<tr class="even">
<td style="text-align: left;">internal_reference_gene</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">0.96</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We now compare the scores obtained by GSVA on the datasets and see how they relate with nanostring scores obtained with the regressed data.</p>
<p>First we compare GSVA SET ER/PR with ER signaling obtained by the scoring procedure when regressing the data.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Next we compare EMT, G2M with proliferation and PI3K signaling.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In general there is a correlation but the scores are not so well correlated and they are noisy. One that works fairly well is the ER signaling score, but the others not so well. The proliferation score barely shows any difference between luminal A and B patients in any of the cohorts.</p>
<p>Perhaps if we calculate the scores using the hallmarks pathways the scores are better correlated, since they are the same gene sets.</p>
<p>Below we plot the correlation between the proliferation pathway using GSVA and the regressed scoring strategy for the TCGA cohort.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It is perfectly correlated.</p>
<p>And for ER signaling:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Also it is very much correlated. So the problem in the end is comparing the hallmarks signatures with the nanostring. But interestingly the nanostring proliferation signature was not good to pick up the differences between luminal A and B.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="risk-stratification-and-the-molecular-landscape" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="risk-stratification-and-the-molecular-landscape"><span class="header-section-number">7.6</span> Risk stratification and the molecular landscape</h2>
<p>One common problem in the clinics is what to do with patients that are in the so called intermediate risk group. Here we use the SSP classification from the SCANB team to check what is the position of these patients in the molecular landscape.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scanb-risk-embedding" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-scanb-risk-embedding-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;7.9: Embedding of the SCANB samples colored by their predicted ROR risk category.</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-scanb-risk-embedding">Figure&nbsp;<span>7.9</span></a> shows that the embedding detects the positions where the intermediate risk patients are, namely they are in the intersection of the luminal A and B subtypes.</p>
<p>And <a href="#fig-intermediate-pca-position">Figure&nbsp;<span>7.10</span></a> below shows that there is a shift in PC4 for the intermediate to the high risk group, which makes sense as this is exactly where the distinction between luminal A and B are.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-intermediate-pca-position" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-intermediate-pca-position-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption class="figure-caption">Figure&nbsp;7.10: Distribution of the principal components for the different risk groups defined by the SSP ROR scores.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="late-distant-recurrence-trying-to-find-biomarkers" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="late-distant-recurrence-trying-to-find-biomarkers"><span class="header-section-number">7.7</span> Late distant recurrence: trying to find biomarkers</h2>
<p>One of the key problems in breast cancer research is finding patients that will develop late recurrence. Here we use METABRIC as it has a long follow-up history. We start by plotting the embedding of all METABRIC patients that had a followup longer than 10 years and received only ET. We then try to predict which patients recurr or not based on the molecular data by using lasso regression. For this we use the package <code>glmnet</code> that provides such functionality.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In general there is no distinction in terms of the molecular landscape among the patients that recurred, both in terms of molecular subtype and position in the molecular landscape.</p>
<p>We now compare their molecular scores.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="1920"></p>
</div>
</div>
<p>Even here we don’t see much difference. Unless there is some kind of linear combination of pathways, I don’t think it would be possible to classify these two groups by using only transcriptomic data and these pathways. In any case we proceed now with the lasso regression using the 50 pathways.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that actually it does not work. And when we predict all the samples are predicted as there is no recurrence.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>.
 no 
407 </code></pre>
</div>
</div>
<p>This is probably because of the unbalanced dataset. Next we try with random forest as well.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = as.factor(is_there_recurrence) ~ ., data = et_metabric_late_data[,      c("is_there_recurrence", pathways_to_compare, "AGE_AT_DIAGNOSIS",          "LYMPH_NODES_EXAMINED_POSITIVE", "npi")], ntree = 500) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 7

        OOB estimate of  error rate: 17.44%
Confusion matrix:
     no yes class.error
no  336   3 0.008849558
yes  68   0 1.000000000</code></pre>
</div>
</div>
<p>That is not the case, still we can’t predict if a patient will develop recurrence or not in this cohort.</p>
</section>
<section id="correlation-of-pathways-with-proliferation" class="level2" data-number="7.8">
<h2 data-number="7.8" class="anchored" data-anchor-id="correlation-of-pathways-with-proliferation"><span class="header-section-number">7.8</span> Correlation of pathways with proliferation</h2>
<p>One thing that is very common is defining a gene signature and then using this gene signature to calculate survival analysis. The thing is, proliferation related genes are pretty much present in almost any signature and hence all these pathways are correlated to G2M and E2F to some extent <span class="citation" data-cites="Venet2011">(<a href="references.html#ref-Venet2011" role="doc-biblioref">Venet, Dumont, and Detours 2011</a>)</span>.</p>
<p>Here we calculate the pathway scores by using the regressed data and do all pairwise comparison of some of the most important pathways to see their correlations.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="1632"></p>
</div>
</div>
<p>First we see that G2M and E2F are encoding basically the same information. PI3K AKT MTOR, AR and the Biocarta HER2 and SET ER/PR are all correlated to some extent to proliferation. Surprisingly the two HER2 signaling scores are not able to distinguish the HER2 subtype. The SET ER/PR correlation with G2M is possibly explained by the fact that the basal molecular subtype has higher G2M and lower ER signaling compared to luminal A and B.</p>
</section>
<section id="ilc-and-position-in-the-molecular-landscape" class="level2" data-number="7.9">
<h2 data-number="7.9" class="anchored" data-anchor-id="ilc-and-position-in-the-molecular-landscape"><span class="header-section-number">7.9</span> ILC and position in the molecular landscape</h2>
<p>Invasive lobular carcinoma is a subtype of ER+ BC. They tend to respond better to ET in the short term but they recurr after 20 years. Here we just show where the ILC BC lie in the molecular landscape.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-lobular-scanb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-pca-lobular-scanb-1.png" class="img-fluid figure-img" width="864"></p>
<figcaption class="figure-caption">Figure&nbsp;7.11: Embedding of the lobular samples from SCANB on top METABRIC and TCGA</figcaption>
</figure>
</div>
</div>
</div>
<p>We see that they are mostly in the normal and luminal A region. Still there are several samples that are luminal B, meaning they are more proliferative.</p>
<p>Is there any difference in the SET ER/PR for lobulars when comparing to ER+ HER2- Ductal carcinomas?</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>They seem to be the same, also when checking the risk score calculated for all patients, the lobular patients don’t seem to have a decreased risk overall, it is mostly because they are in the same region of the molecular landscape. Interestingly there is way less luminal B patients in the lobular, but still their distributions are very similar.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And we also plot by intrinsic molecular subtype.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="1344"></p>
</div>
</div>
<p>We also compare EMT.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>EMT is very similar across both histological subtypes. The plot below shows the densities for ER percentage, notice how the two overlap.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We now check the lobular signature LobSig that is touted to be superior to OncotypeDX, Prosigna’s PAM50 and other signatures. In total, 63% of the genes are available here. Based on my experience this is already a good number to make comparisons. For example, G2M checkpoint has 71% of the genes available, estrogen response early has 66%.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>We see that the LobSig is highgly correlated with G2M checkpoint and also the risk of recurrence score obtained from PAM50. The random 200 is a signature of 200 random genes that works as a negative control.</p>
<p>The figure below shows the distinction of the signature among the 3 different risk categories from ROR.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There is an increase in the score as expected based on the previous results that show where the intermediate risk group is according to the molecular landscape.</p>
<p>Lastly we check the CDH1 expression levels on the regressed data to see if the differences are still captured upon the whole process.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="1344"></p>
</div>
</div>
<p>The differences are still captured, and CDH1 is decreased when comparing lobular vs NST. Note also that the difference seems to be the biggest in the luminal B subtype.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="1344"></p>
</div>
</div>
<p>We also check the PC3 and PC4 loadings for CDH1, to see how important this gene is in the molecular landscape.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  gene          PC3        PC4
1 CDH1 0.0002872375 0.01509738</code></pre>
</div>
</div>
<p>PC4 has a relatively high value which puts it into the 95 percentile as shown below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9547769</code></pre>
</div>
</div>
<p>Next we can plot the lobular samples from Ciriello’s paper and color by the 3 subtypes they found. Note here that there is a mismatch between the cbioportal data and what is found in the original papers <span class="citation" data-cites="Curtis2012">(<a href="references.html#ref-Curtis2012" role="doc-biblioref">Curtis et al. 2012</a>)</span>. We will use the Curtis 2012 annotation as this is what matches Ciriello’s paper. Surprisingly the mismatch is not a systematic issue, rather 88 ILC samples are matching and the non-matching samples are NST but the other info matches usually, such as NPI.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pca-lobular-metabric" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="trying_files/figure-html/fig-pca-lobular-metabric-1.png" class="img-fluid figure-img" width="864"></p>
<figcaption class="figure-caption">Figure&nbsp;7.12: Embedding of the lobular samples from METABRIC on top SCANB and TCGA</figcaption>
</figure>
</div>
</div>
</div>
<p>The table below shows the number of subtypes for each molecular subtype. In general there are samples in each one of the molecular subtypes. The reactive-like is actually more enriched in the normal region.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>        subtype basal claudin-low her2 luma lumb normal
 Immune-Related     0           3    2   27   10      4
  Proliferative     3           3    5   11   15      4
  Reactive-like     0           5    1   22    2     20</code></pre>
</div>
</div>
<p>And below is a plot of the lobular samples from Ciriello/Curtis with the molecular subtypes defined by Ciriello.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It seems that more proliferative saaples are in the luminal B region whereas the Reactive-like and Immune-related are not so distinguishable, they are in the luminal A region.</p>
<p>Some of the samples are NST on cbioportal and Lobular on Curtis. We selected the following samples and checked on cbioPortal (https://www.cbioportal.org/study/clinicalData?id=brca_metabric) their histologic subtype directly.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  sample_name   npi
1     MB-0035 3.056
2     MB-0050 4.066
3     MB-0083 3.026
4     MB-0101 3.068
5     MB-0102 5.080
6     MB-0112 6.300</code></pre>
</div>
</div>
<p>All the 6 samples are Ductal/NST and not Lobular.</p>
</section>
<section id="robustness-to-library-protocol" class="level2" data-number="7.10">
<h2 data-number="7.10" class="anchored" data-anchor-id="robustness-to-library-protocol"><span class="header-section-number">7.10</span> Robustness to library protocol</h2>
<p>The figure below shows the first two components for SCANB stratified by the library protocol used in the study. We see that PC2 is partially capturing the differences due to library protocol.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="distance-in-4th-component-for-poetic" class="level2" data-number="7.11">
<h2 data-number="7.11" class="anchored" data-anchor-id="distance-in-4th-component-for-poetic"><span class="header-section-number">7.11</span> Distance in 4th component for POETIC</h2>
<p>We have seen previosuly that there is a bigger difference in between the matched samples in the responder than to non-responder patients. Hallmark G2M checkpoint is one of the signatures driving the PC4, meaning that the position wrt the fourth component might be used to define a new response status.</p>
<p>Below we plot the matched samples for all non responder patients with no change at all in Ki67 (change &gt;= 0%) and their respective positions in the molecular landscape.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid" width="1536"></p>
</div>
</div>
<p>Now we do the same for the top responders (change in Ki67 <span class="math inline">\(\leq\)</span> -90%).</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="trying_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid" width="1536"></p>
</div>
</div>
<p>In general the distance for the responder samples seem to be higher and not only that we see that the surgery sample goes to the bottom part of the embedding, suggesting that the reduction of the proliferation is reflected in the molecular landscape.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Curtis2012" class="csl-entry" role="listitem">
Curtis, Christina, and Sohrab P. Shah, Suet-Feung Chin, Gulisa Turashvili, Oscar M. Rueda, Mark J. Dunning, Doug Speed, et al. 2012. <span>“The Genomic and Transcriptomic Architecture of 2, 000 Breast Tumours Reveals Novel Subgroups.”</span> <em>Nature</em> 486 (7403): 346–52. <a href="https://doi.org/10.1038/nature10983">https://doi.org/10.1038/nature10983</a>.
</div>
<div id="ref-Venet2011" class="csl-entry" role="listitem">
Venet, David, Jacques E. Dumont, and Vincent Detours. 2011. <span>“Most Random Gene Expression Signatures Are Significantly Associated with Breast Cancer Outcome.”</span> Edited by Isidore Rigoutsos. <em><span>PLoS</span> Computational Biology</em> 7 (10): e1002240. <a href="https://doi.org/10.1371/journal.pcbi.1002240">https://doi.org/10.1371/journal.pcbi.1002240</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/expanding_ember.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Expanding embedding and removing batch effects</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/revision.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Revision</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb14" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Tests and tries </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>This is a file where we try different things using the molecular data.</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>We keep it here in case anyone finds anything here interesting and would like</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>to further discuss with us for potential collaborations.</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>()</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCAtools)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(singscore)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SummarizedExperiment)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(genefu)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/utils.R"</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/first_run.R"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># the following script load all data necessary to run the chunks.</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># the data is generated from this quarto document itself, therefore</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co"># if you are running this documents the first time and don't have the</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co"># files, comment the following lines. Moreover, if this is your first</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># time running the document, you should run all chunks, to generate </span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co"># all the necessary files, if you don't have them. Once all files </span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># are saved and available in the respective folder, the following</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># lines can be executed. </span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (first_run){</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    load_at_setup <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    load_at_setup <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>name_document <span class="ot">&lt;-</span> <span class="st">"trying"</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"../../results/"</span>, <span class="fu">c</span>(<span class="st">"plots"</span>, <span class="st">"rds_files"</span>, <span class="st">"tables"</span>), <span class="st">"/"</span>, name_document),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    dir.create,</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">showWarnings =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">recursive =</span> <span class="cn">TRUE</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../R/load_rds_files.R"</span>)</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="co"># by setting the dev to png and pdf, this saves the figures in a specific</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="co"># folder in both formats. moreover, since png is coming first, it shows</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="co"># this figure when rendering the html. What is nice about this is that it</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="co"># inherits the properties from the chunk to save the figure, so no need</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="co"># to use ggplot2::ggsave to save the plots. this also works </span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="fu">c</span>(<span class="st">'png'</span>, <span class="st">'pdf'</span>))</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">bitmapType =</span> <span class="st">'cairo'</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>p4_pathways <span class="ot">&lt;-</span> msigdbr<span class="sc">::</span><span class="fu">msigdbr</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"WILCOX_RESPONSE_TO_PROGESTERONE_UP"</span>,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GOBP_RESPONSE_TO_PROGESTERONE"</span>,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"BIOCARTA_HER2_PATHWAY"</span>,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"KEGG_ERBB_SIGNALING_PATHWAY"</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>gene_sets_prog <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    gene_sets, </span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    p4_pathways</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>gene_sets_ <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    gene_sets_prog<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique,</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, gene_sets) gene_sets <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(gs_name <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(gene_symbol),</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets_prog,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>datasets<span class="sc">$</span>poetic<span class="sc">$</span>sample_name <span class="ot">&lt;-</span> <span class="fu">colnames</span>(datasets<span class="sc">$</span>poetic)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using several pathways or just one pathway for GSVA</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>We now evaluate the effect of the scores for each pathway when using all the</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>53 pathways combined and each one individually. We use only TCGA for </span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>this step.</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>gene_expression <span class="ot">&lt;-</span> <span class="fu">assay</span>(datasets<span class="sc">$</span>tcga, which_exp<span class="sc">$</span>tcga) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>all_scores <span class="ot">&lt;-</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>tcga) <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="fu">### One vs all</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>We now calculate the scores for each gene set individually.</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">187293</span>)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>samples_one_pathway <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(gene_expression), <span class="at">size =</span> <span class="dv">200</span>)</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>gsva_one_pathway <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    gene_sets_[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x){</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>        GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>            <span class="at">expr =</span> gene_expression[, samples_one_pathway], </span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>            <span class="at">gset.idx.list =</span> <span class="fu">list</span>(x),</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>    gsva_one_pathway,</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/trying/gsva_one_pathway.rds"</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>gsva_one_pathways <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(rbind, gsva_one_pathway) <span class="sc">%&gt;%</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(<span class="fu">names</span>(gsva_one_pathway)) <span class="sc">%&gt;%</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">names</span>(gsva_one_pathway)),</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"one_gsva"</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>        merged_col_data <span class="sc">%&gt;%</span></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>            tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>                <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">intersect</span>(</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">names</span>(gsva_one_pathway),</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">colnames</span>(merged_col_data)</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>                )),</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>                <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_to =</span> <span class="st">"gsva"</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>, <span class="st">"pathway"</span>)</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=20, fig.height=16, dev="png"}</span></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>gsva_one_pathways <span class="sc">%&gt;%</span></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> one_gsva, <span class="at">y =</span> gsva, <span class="at">color =</span> pam50</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>It seems they are all positively correlated, so one could calculate the </span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>scores basically using just one gene set with exception of some of the</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>gene sets. </span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a><span class="fu">## Minimum number of samples for GSVA</span></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>According to the original GSVA paper, a minimum of 10 samples are necessary</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>to have a good power when using GSVA. Since here we have at least 5 </span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>molecular subgroups, we hypothesize we need at least 50 samples to get a </span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>good score so we can compare across cohorts. We will try with</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>different numbers of samples using TCGA, we start with 10, 25, 50 and</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>100 samples and we compare with the scores using the full dataset.</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>nb_of_samples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>)</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>seeds <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">123</span>, <span class="dv">1234</span>, <span class="dv">21345</span>, <span class="dv">12</span>, <span class="dv">123</span>)</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>gsva_scores <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(nb_samples, seed, df, gene_sets, col_data){</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set.seed</span>(seed)</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>        patients <span class="ot">&lt;-</span> col_data <span class="sc">%&gt;%</span></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> nb_samples) <span class="sc">%&gt;%</span></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>        GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>            df[, patients],</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>            gene_sets,</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">nb_samples =</span> nb_of_samples,</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seeds,</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">df =</span> gene_expression, <span class="at">gene_sets =</span> gene_sets_,</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col_data =</span> <span class="fu">colData</span>(datasets<span class="sc">$</span>tcga) <span class="sc">%&gt;%</span> data.frame)</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>    gsva_scores, </span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/trying/gsva_scores_trying.rds"</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(gsva_scores) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"nb_"</span>, nb_of_samples)</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>gsva_scores_ <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>    gsva_scores,</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    \(x) <span class="fu">data.frame</span>(<span class="fu">t</span>(x)) <span class="sc">%&gt;%</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>)</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"nb_of_samples"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">nb_of_samples =</span> <span class="fu">factor</span>(nb_of_samples, <span class="fu">names</span>(gsva_scores))) <span class="sc">%&gt;%</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(gene_sets_), p4_pathways<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique),</span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"gsva_sub"</span></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>        merged_col_data <span class="sc">%&gt;%</span></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>            tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(gene_sets_), p4_pathways<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique),</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"gsva_full"</span></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>, <span class="st">"pathway"</span>)</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 50, fig.height=15}</span></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>gsva_scores_ <span class="sc">%&gt;%</span> </span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">%in%</span> <span class="fu">names</span>(gene_sets_)[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> gsva_full, <span class="at">y =</span> gsva_sub, <span class="at">color =</span> pam50</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(nb_of_samples <span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 50, fig.height=15}</span></span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>gsva_scores_ <span class="sc">%&gt;%</span> </span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pathway <span class="sc">%in%</span> <span class="fu">names</span>(gene_sets_)[<span class="dv">25</span><span class="sc">:</span>(<span class="fu">length</span>(<span class="fu">names</span>(gene_sets_))<span class="sc">-</span><span class="dv">2</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> gsva_full, <span class="at">y =</span> gsva_sub, <span class="at">color =</span> pam50</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(nb_of_samples <span class="sc">~</span> pathway, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>The conclusion we can take here is that depending on the gene set not even 150</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>samples is enough. For some only 25 patients is already enough, such as SET </span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>ER/PR, androgen response, estrogen response early and E2F targets.</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>Could we mix around 20 samples of SCANB together with more samples from </span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>TCGA and METABRIC to get the scores? Let us try to adress this question</span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>again. We are using the regressed data now here as this is the only way.</span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>scanb_samples <span class="ot">&lt;-</span> df_pca_coordinates <span class="sc">%&gt;%</span></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>gsva_scores_embeddings_scanb_within_tcga_regressed <span class="ot">&lt;-</span> GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>    df_pcs_regressed[</span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>        , </span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>        merged_col_data <span class="sc">%&gt;%</span></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tcga"</span>, <span class="st">"metabric"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">500</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(., scanb_samples)</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>    gene_sets_,</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>    <span class="at">parallel.sz =</span> <span class="dv">10</span>,</span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>    gsva_scores_embeddings_scanb_within_tcga_regressed,</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/trying/gsva_scores_embeddings_scanb_within_tcga_regressed.rds"</span></span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>sub_scanb_scores <span class="ot">&lt;-</span> gsva_scores_embeddings_scanb_within_tcga_regressed <span class="sc">%&gt;%</span></span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span> </span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(gene_sets_), p4_pathways<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique),</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"gsva_sub"</span></span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>        merged_col_data <span class="sc">%&gt;%</span></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>            tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>                <span class="at">cols =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(gene_sets_), p4_pathways<span class="sc">$</span>gs_name <span class="sc">%&gt;%</span> unique),</span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>                <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_to =</span> <span class="st">"gsva_full"</span></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>, <span class="st">"pathway"</span>)</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=20, fig.height=16}</span></span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>sub_scanb_scores <span class="sc">%&gt;%</span></span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> gsva_sub,</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> gsva_full,</span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> cohort</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway) <span class="sc">+</span> </span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>There is still some correlation but the scores are </span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>shrinked in the end. </span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normalization strategy</span></span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>We can also try another way of normalizing, namely for each sample we</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>can z scale it.</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1329</span>)</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>samples_for_training <span class="ot">&lt;-</span> merged_col_data <span class="sc">%&gt;%</span></span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> which_cohorts_training) <span class="sc">%&gt;%</span></span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample</span>(., <span class="at">size =</span> <span class="dv">1000</span>) </span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>common_genes <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(intersect, <span class="fu">lapply</span>(datasets, rownames))</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>stable_genes <span class="ot">&lt;-</span> <span class="fu">intersect</span>(stable_genes, common_genes)</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a><span class="co"># and now we can perform the molecular embedding</span></span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>training_set <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>    datasets_normalized[which_cohorts_training], </span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(sum_exp, i, genes_for_pca) </span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assay</span>(sum_exp[genes_for_pca, ], <span class="at">i =</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(<span class="at">check.names =</span> <span class="cn">FALSE</span>), </span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> <span class="st">"znorm"</span>,</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes_for_pca =</span> common_genes</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>    .[, samples_for_training]</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>pca_fit_znorm <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">pca</span>(</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>    training_set,</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>    <span class="at">metadata =</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>            datasets_normalized[which_cohorts_training],</span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(df){</span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>                <span class="fu">colData</span>(df) <span class="sc">%&gt;%</span> data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> <span class="fu">colnames</span>(training_set))</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>        <span class="at">.id =</span> <span class="st">"cohort"</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> .[<span class="fu">colnames</span>(training_set), ],</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">center =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="cn">FALSE</span></span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>And now we can visualize the results.</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=14, fig.height=16}</span></span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-embeddings-3</span></span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA projections colored by different factors and organized</span></span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a><span class="co">#|    by different components. (A) Plot of the first two components colored</span></span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a><span class="co">#|    by cohort. (B) Plot of the first two components colored by ER status.</span></span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a><span class="co">#|    (C) Plot of the second and third components colored by cohort. </span></span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a><span class="co">#|    (D) Plot of the second and third components colored by ER status.</span></span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a><span class="co">#|    (E) Plot of the second and third components colored by PAM50.</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a><span class="co">#|    (F) Plot of the second and third components colored by INTCLUST, only</span></span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a><span class="co">#|    METABRIC has an assigned value for this variable, NAs are TCGA samples.</span></span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>plots_pca_fit <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>point_size <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc1_pc2_cohort <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"cohort"</span>,</span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC1"</span>,</span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"First two components colored by cohort"</span>,</span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc1_pc2_er_status <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"er_status"</span>,</span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC1"</span>,</span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"First two components colored by ER status"</span>,</span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc2_pc3_cohort <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"cohort"</span>,</span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Second and third components colored by cohort"</span>,</span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc2_pc3_er_status <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"er_status"</span>,</span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Second and third components colored by ER status"</span>,</span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc2_pc3_pam50 <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"pam50"</span>,</span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Second and third components colored by PAM50"</span>,</span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc2_pc3_pam50 <span class="ot">&lt;-</span> plots_pca_fit<span class="sc">$</span>pc2_pc3_pam50 <span class="sc">+</span></span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(pca_fit<span class="sc">$</span>metadata))</span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc2_pc3_intclust <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"INTCLUST"</span>,</span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Second and third components colored by INTCLUST"</span>,</span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc3_pc4_pam50 <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"pam50"</span>,</span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Third and fourth components colored by PAM50"</span>,</span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc3_pc4_pam50 <span class="ot">&lt;-</span> plots_pca_fit<span class="sc">$</span>pc3_pc4_pam50 <span class="sc">+</span></span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(pca_fit<span class="sc">$</span>metadata))</span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>plots_pca_fit<span class="sc">$</span>pc3_pc4_cohort <span class="ot">&lt;-</span> PCAtools<span class="sc">::</span><span class="fu">biplot</span>(</span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>    pca_fit_znorm,</span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">"cohort"</span>,</span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">legendPosition =</span> <span class="st">"right"</span>,</span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Third and fourth components colored by cohort"</span>,</span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Only 1000 training samples"</span>,</span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> point_size</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> plots_pca_fit, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">labels =</span> <span class="st">"AUTO"</span>)</span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a>datasets_pca_coordinates_znorm <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a>    datasets_normalized,</span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a>    get_pca_coordinates,</span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_fit =</span> pca_fit_znorm,</span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes_for_pca =</span> <span class="fu">rownames</span>(pca_fit_znorm<span class="sc">$</span>loadings)</span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a>df_pca_coordinates_znorm <span class="ot">&lt;-</span> datasets_pca_coordinates_znorm <span class="sc">%&gt;%</span> </span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">do.call</span>(rbind, .) <span class="sc">%&gt;%</span></span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span> </span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>        merged_col_data,</span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca_coordinates</span>(</span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates_znorm <span class="sc">%&gt;%</span> </span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"cohort"</span>,</span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>,</span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA,</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC and SCANB"</span></span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>We see that samples are well embedded as well. </span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb-pc1-2</span></span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding colored by cohort. The components used are the</span></span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a><span class="co">#|     first and second components.</span></span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca_coordinates</span>(</span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a>    df_pca_coordinates_znorm,</span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"cohort"</span>,</span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC1"</span>,</span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC2"</span>,</span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">10</span>,</span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb14-556"><a href="#cb14-556" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA,</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb14-557"><a href="#cb14-557" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC and SCANB"</span></span>
<span id="cb14-558"><a href="#cb14-558" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-559"><a href="#cb14-559" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb14-560"><a href="#cb14-560" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-561"><a href="#cb14-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-562"><a href="#cb14-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-563"><a href="#cb14-563" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-564"><a href="#cb14-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-565"><a href="#cb14-565" aria-hidden="true" tabindex="-1"></a>SCANB and POETIC are in between as expected and they are closer</span>
<span id="cb14-566"><a href="#cb14-566" aria-hidden="true" tabindex="-1"></a>to their sequencing technology. Interestingly the </span>
<span id="cb14-567"><a href="#cb14-567" aria-hidden="true" tabindex="-1"></a>variation for SCANB and TCGA are compressed in the PC1 vs PC2 axis compared</span>
<span id="cb14-568"><a href="#cb14-568" aria-hidden="true" tabindex="-1"></a>to METABRIC and POETIC.</span>
<span id="cb14-569"><a href="#cb14-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-570"><a href="#cb14-570" aria-hidden="true" tabindex="-1"></a>@fig-pca-scanb-er-pam50-2 shows that the SCANB samples are also well mixed</span>
<span id="cb14-571"><a href="#cb14-571" aria-hidden="true" tabindex="-1"></a>regarding the clinical factors, including the $SET_{ER/PR}$ signature.</span>
<span id="cb14-572"><a href="#cb14-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-573"><a href="#cb14-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=16, fig.height=14}</span></span>
<span id="cb14-574"><a href="#cb14-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-scanb-er-pam50-2</span></span>
<span id="cb14-575"><a href="#cb14-575" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: PCA embedding of all samples from TCGA, SCANB and METABRIC.</span></span>
<span id="cb14-576"><a href="#cb14-576" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (A) Colored by cohort,</span></span>
<span id="cb14-577"><a href="#cb14-577" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (B) colored by ER status, (C) colored by PAM50 molecular subtype,</span></span>
<span id="cb14-578"><a href="#cb14-578" aria-hidden="true" tabindex="-1"></a><span class="co">#|     (D) colored by the $SET_{ER/PR}$ signature and only SCANB samples.</span></span>
<span id="cb14-579"><a href="#cb14-579" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb14-580"><a href="#cb14-580" aria-hidden="true" tabindex="-1"></a>base_size <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb14-581"><a href="#cb14-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-582"><a href="#cb14-582" aria-hidden="true" tabindex="-1"></a>plots_with_scanb <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb14-583"><a href="#cb14-583" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"cohort"</span>, <span class="st">"er_status"</span>, <span class="st">"pam50"</span>, <span class="st">"SET_ERPR"</span>, <span class="st">"HALLMARK_G2M_CHECKPOINT"</span>), </span>
<span id="cb14-584"><a href="#cb14-584" aria-hidden="true" tabindex="-1"></a>    plot_pca_coordinates,</span>
<span id="cb14-585"><a href="#cb14-585" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pca =</span> df_pca_coordinates_znorm <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-586"><a href="#cb14-586" aria-hidden="true" tabindex="-1"></a>        pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"luma"</span>, <span class="st">"lumb"</span>, <span class="st">"basal"</span>, <span class="st">"her2"</span>, <span class="st">"normal"</span>) <span class="sc">&amp;</span></span>
<span id="cb14-587"><a href="#cb14-587" aria-hidden="true" tabindex="-1"></a>            cohort <span class="sc">!=</span> <span class="st">"poetic"</span></span>
<span id="cb14-588"><a href="#cb14-588" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-589"><a href="#cb14-589" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())),</span>
<span id="cb14-590"><a href="#cb14-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PC3"</span>, </span>
<span id="cb14-591"><a href="#cb14-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PC4"</span>,</span>
<span id="cb14-592"><a href="#cb14-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> size,</span>
<span id="cb14-593"><a href="#cb14-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> base_size,</span>
<span id="cb14-594"><a href="#cb14-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste0</span>(</span>
<span id="cb14-595"><a href="#cb14-595" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Embedding of all samples from TCGA,</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb14-596"><a href="#cb14-596" aria-hidden="true" tabindex="-1"></a>        <span class="st">"METABRIC and SCANB"</span></span>
<span id="cb14-597"><a href="#cb14-597" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-598"><a href="#cb14-598" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb14-599"><a href="#cb14-599" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb14-600"><a href="#cb14-600" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-601"><a href="#cb14-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-602"><a href="#cb14-602" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>cohort <span class="ot">&lt;-</span> plots_with_scanb<span class="sc">$</span>cohort <span class="sc">+</span></span>
<span id="cb14-603"><a href="#cb14-603" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-604"><a href="#cb14-604" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-605"><a href="#cb14-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-606"><a href="#cb14-606" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>pam50 <span class="ot">&lt;-</span> plots_with_scanb<span class="sc">$</span>pam50 <span class="sc">+</span></span>
<span id="cb14-607"><a href="#cb14-607" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb14-608"><a href="#cb14-608" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_colors_pam50</span>(plots_with_scanb<span class="sc">$</span>pam50<span class="sc">$</span>data)</span>
<span id="cb14-609"><a href="#cb14-609" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-610"><a href="#cb14-610" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-611"><a href="#cb14-611" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-612"><a href="#cb14-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-613"><a href="#cb14-613" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>er_status <span class="ot">&lt;-</span>  plots_with_scanb<span class="sc">$</span>er_status <span class="sc">+</span></span>
<span id="cb14-614"><a href="#cb14-614" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb14-615"><a href="#cb14-615" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"ER status"</span>) <span class="sc">+</span></span>
<span id="cb14-616"><a href="#cb14-616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-617"><a href="#cb14-617" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-618"><a href="#cb14-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-619"><a href="#cb14-619" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>SET_ERPR <span class="ot">&lt;-</span> df_pca_coordinates_znorm <span class="sc">%&gt;%</span> </span>
<span id="cb14-620"><a href="#cb14-620" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-621"><a href="#cb14-621" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes_string</span>(<span class="at">x =</span> <span class="st">"PC3"</span>, <span class="at">y =</span> <span class="st">"PC4"</span>, <span class="at">z =</span> <span class="st">"SET_ERPR"</span>)) <span class="sc">+</span> </span>
<span id="cb14-622"><a href="#cb14-622" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb14-623"><a href="#cb14-623" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb14-624"><a href="#cb14-624" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-625"><a href="#cb14-625" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Embedding of SCANB only"</span>,</span>
<span id="cb14-626"><a href="#cb14-626" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="fu">expression</span>(SET[ER<span class="sc">/</span>PR])</span>
<span id="cb14-627"><a href="#cb14-627" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span> </span>
<span id="cb14-628"><a href="#cb14-628" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> base_size) <span class="sc">+</span></span>
<span id="cb14-629"><a href="#cb14-629" aria-hidden="true" tabindex="-1"></a>        <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb14-630"><a href="#cb14-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-631"><a href="#cb14-631" aria-hidden="true" tabindex="-1"></a>plots_with_scanb<span class="sc">$</span>HALLMARK_G2M_CHECKPOINT <span class="ot">&lt;-</span> df_pca_coordinates_znorm <span class="sc">%&gt;%</span> </span>
<span id="cb14-632"><a href="#cb14-632" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb"</span>) <span class="sc">&amp;</span> pam50 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"luma"</span>, <span class="st">"lumb"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-633"><a href="#cb14-633" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes_string</span>(<span class="at">x =</span> <span class="st">"PC3"</span>, <span class="at">y =</span> <span class="st">"PC4"</span>, <span class="at">z =</span> <span class="st">"HALLMARK_G2M_CHECKPOINT"</span>)) <span class="sc">+</span> </span>
<span id="cb14-634"><a href="#cb14-634" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb14-635"><a href="#cb14-635" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb14-636"><a href="#cb14-636" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-637"><a href="#cb14-637" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Embedding of SCANB, luminal A and B only"</span>,</span>
<span id="cb14-638"><a href="#cb14-638" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"G2M"</span></span>
<span id="cb14-639"><a href="#cb14-639" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span> </span>
<span id="cb14-640"><a href="#cb14-640" aria-hidden="true" tabindex="-1"></a>        ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> base_size) <span class="sc">+</span></span>
<span id="cb14-641"><a href="#cb14-641" aria-hidden="true" tabindex="-1"></a>        <span class="fu">change_plot_aes_point</span>()</span>
<span id="cb14-642"><a href="#cb14-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-643"><a href="#cb14-643" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb14-644"><a href="#cb14-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">plotlist =</span> plots_with_scanb,</span>
<span id="cb14-645"><a href="#cb14-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb14-646"><a href="#cb14-646" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-647"><a href="#cb14-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-648"><a href="#cb14-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-649"><a href="#cb14-649" aria-hidden="true" tabindex="-1"></a>In the end normalizing by scaling the sample before doing any embedding</span>
<span id="cb14-650"><a href="#cb14-650" aria-hidden="true" tabindex="-1"></a>works as well. Though the embedding seems to be more compressed. </span>
<span id="cb14-651"><a href="#cb14-651" aria-hidden="true" tabindex="-1"></a>I would argue that the qPCR-like normalization gives a bit better</span>
<span id="cb14-652"><a href="#cb14-652" aria-hidden="true" tabindex="-1"></a>embedding. </span>
<span id="cb14-653"><a href="#cb14-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-654"><a href="#cb14-654" aria-hidden="true" tabindex="-1"></a><span class="fu">## genefu </span></span>
<span id="cb14-655"><a href="#cb14-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-656"><a href="#cb14-656" aria-hidden="true" tabindex="-1"></a>With genefu it is possible to calculate scores from comercially available </span>
<span id="cb14-657"><a href="#cb14-657" aria-hidden="true" tabindex="-1"></a>signatures. Here we try to use it on SCANB, METABRIC and TCGA. Moreover,</span>
<span id="cb14-658"><a href="#cb14-658" aria-hidden="true" tabindex="-1"></a>we can start with ABiM, as this dataset has the gold standard ROR score </span>
<span id="cb14-659"><a href="#cb14-659" aria-hidden="true" tabindex="-1"></a>obtained from nCounter data. This is a good way of validating the</span>
<span id="cb14-660"><a href="#cb14-660" aria-hidden="true" tabindex="-1"></a>pipeline. </span>
<span id="cb14-661"><a href="#cb14-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-664"><a href="#cb14-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-665"><a href="#cb14-665" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(pam50.robust)</span>
<span id="cb14-666"><a href="#cb14-666" aria-hidden="true" tabindex="-1"></a>abim_genefu_pam50 <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">molecular.subtyping</span>(</span>
<span id="cb14-667"><a href="#cb14-667" aria-hidden="true" tabindex="-1"></a>    <span class="at">sbt.model =</span> <span class="st">"pam50"</span>,</span>
<span id="cb14-668"><a href="#cb14-668" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">t</span>(<span class="fu">assay</span>(abim_100, <span class="st">"log2fpkm"</span>)), </span>
<span id="cb14-669"><a href="#cb14-669" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span></span>
<span id="cb14-670"><a href="#cb14-670" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-671"><a href="#cb14-671" aria-hidden="true" tabindex="-1"></a>            <span class="at">EntrezGene.ID =</span> entrez,</span>
<span id="cb14-672"><a href="#cb14-672" aria-hidden="true" tabindex="-1"></a>            <span class="at">Gene.Symbol =</span> symbol</span>
<span id="cb14-673"><a href="#cb14-673" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-674"><a href="#cb14-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">FALSE</span></span>
<span id="cb14-675"><a href="#cb14-675" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-676"><a href="#cb14-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-677"><a href="#cb14-677" aria-hidden="true" tabindex="-1"></a>abim_100<span class="sc">$</span>GENEFU.PAM50 <span class="ot">&lt;-</span> abim_genefu_pam50<span class="sc">$</span>subtype</span>
<span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a>We start by comparing the molecular subtypes:</span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(abim_100<span class="sc">$</span>GENEFU.PAM50 <span class="sc">==</span> abim_100<span class="sc">$</span>ProsignaFT.Subtype)</span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-688"><a href="#cb14-688" aria-hidden="true" tabindex="-1"></a>86 out of 100 were correctly called. Here we are using the gold standard wich</span>
<span id="cb14-689"><a href="#cb14-689" aria-hidden="true" tabindex="-1"></a>is the molecular subtype called from FT samples. The normal like subtype is not</span>
<span id="cb14-690"><a href="#cb14-690" aria-hidden="true" tabindex="-1"></a>available from the FT prosigna assay. So we now compare the results with the</span>
<span id="cb14-691"><a href="#cb14-691" aria-hidden="true" tabindex="-1"></a>SSP obtained from the SCANB team. </span>
<span id="cb14-692"><a href="#cb14-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-693"><a href="#cb14-693" aria-hidden="true" tabindex="-1"></a>Below is the confusion matrix to see which subtypes were misclassified. </span>
<span id="cb14-694"><a href="#cb14-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-697"><a href="#cb14-697" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-698"><a href="#cb14-698" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(</span>
<span id="cb14-699"><a href="#cb14-699" aria-hidden="true" tabindex="-1"></a>    abim_100<span class="sc">$</span>GENEFU.PAM50,</span>
<span id="cb14-700"><a href="#cb14-700" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(</span>
<span id="cb14-701"><a href="#cb14-701" aria-hidden="true" tabindex="-1"></a>        abim_100<span class="sc">$</span>ProsignaFT.Subtype, </span>
<span id="cb14-702"><a href="#cb14-702" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">levels</span>(abim_100<span class="sc">$</span>GENEFU.PAM50)</span>
<span id="cb14-703"><a href="#cb14-703" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-704"><a href="#cb14-704" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-705"><a href="#cb14-705" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-706"><a href="#cb14-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-707"><a href="#cb14-707" aria-hidden="true" tabindex="-1"></a>All luminal A were predicted correctly. Some normal like were predicted to</span>
<span id="cb14-708"><a href="#cb14-708" aria-hidden="true" tabindex="-1"></a>be luminal A or basal and Her2. There were some mismatches </span>
<span id="cb14-709"><a href="#cb14-709" aria-hidden="true" tabindex="-1"></a>for the LumB, that were misclassified as LumA. Still it is ok. </span>
<span id="cb14-710"><a href="#cb14-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-711"><a href="#cb14-711" aria-hidden="true" tabindex="-1"></a>Let us now calculate the ROR for the ABiM cohort.</span>
<span id="cb14-712"><a href="#cb14-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-715"><a href="#cb14-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-716"><a href="#cb14-716" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ror-genefu-abim</span></span>
<span id="cb14-717"><a href="#cb14-717" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between ROR obtained from prosigna assay and </span></span>
<span id="cb14-718"><a href="#cb14-718" aria-hidden="true" tabindex="-1"></a><span class="co">#|     R package genefu</span></span>
<span id="cb14-719"><a href="#cb14-719" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(pam50)</span>
<span id="cb14-720"><a href="#cb14-720" aria-hidden="true" tabindex="-1"></a>ror_abim <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">rorS</span>(</span>
<span id="cb14-721"><a href="#cb14-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">t</span>(<span class="fu">assay</span>(abim_100, <span class="st">"log2fpkm"</span>)), </span>
<span id="cb14-722"><a href="#cb14-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span></span>
<span id="cb14-723"><a href="#cb14-723" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-724"><a href="#cb14-724" aria-hidden="true" tabindex="-1"></a>            <span class="at">EntrezGene.ID =</span> entrez,</span>
<span id="cb14-725"><a href="#cb14-725" aria-hidden="true" tabindex="-1"></a>            <span class="at">Gene.Symbol =</span> symbol</span>
<span id="cb14-726"><a href="#cb14-726" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-727"><a href="#cb14-727" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">FALSE</span></span>
<span id="cb14-728"><a href="#cb14-728" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-729"><a href="#cb14-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-730"><a href="#cb14-730" aria-hidden="true" tabindex="-1"></a>abim_100<span class="sc">$</span>GENEFU.ROR <span class="ot">&lt;-</span> ror_abim<span class="sc">$</span>score</span>
<span id="cb14-731"><a href="#cb14-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-732"><a href="#cb14-732" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(abim_100) <span class="sc">%&gt;%</span></span>
<span id="cb14-733"><a href="#cb14-733" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-734"><a href="#cb14-734" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> GENEFU.ROR, <span class="at">y =</span> ProsignaFT.ROR, <span class="at">color =</span> ProsignaFT.Subtype)) <span class="sc">+</span></span>
<span id="cb14-735"><a href="#cb14-735" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-736"><a href="#cb14-736" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb14-737"><a href="#cb14-737" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb14-738"><a href="#cb14-738" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"loess"</span>,</span>
<span id="cb14-739"><a href="#cb14-739" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> <span class="st">"y ~ x"</span></span>
<span id="cb14-740"><a href="#cb14-740" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-741"><a href="#cb14-741" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ABiM 100 cohort"</span>) <span class="sc">+</span></span>
<span id="cb14-742"><a href="#cb14-742" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-743"><a href="#cb14-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-744"><a href="#cb14-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-745"><a href="#cb14-745" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-746"><a href="#cb14-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-747"><a href="#cb14-747" aria-hidden="true" tabindex="-1"></a>The correlation is relatively good and respects the molecular subtypes</span>
<span id="cb14-748"><a href="#cb14-748" aria-hidden="true" tabindex="-1"></a>in general. The ROR obtained from genefu for some luminal B are not </span>
<span id="cb14-749"><a href="#cb14-749" aria-hidden="true" tabindex="-1"></a>quite right as they are below 50. </span>
<span id="cb14-750"><a href="#cb14-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-751"><a href="#cb14-751" aria-hidden="true" tabindex="-1"></a>We now move on to the other signatures: Mammaprint, EndoPredict (EP) and </span>
<span id="cb14-752"><a href="#cb14-752" aria-hidden="true" tabindex="-1"></a>OncotypeDX Risk Score (RS).</span>
<span id="cb14-753"><a href="#cb14-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-754"><a href="#cb14-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-757"><a href="#cb14-757" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-758"><a href="#cb14-758" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ror-mammaprint-genefu-abim</span></span>
<span id="cb14-759"><a href="#cb14-759" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between ROR obtained from prosigna assay and </span></span>
<span id="cb14-760"><a href="#cb14-760" aria-hidden="true" tabindex="-1"></a><span class="co">#|     the mammaprint signature obtained from the R package genefu</span></span>
<span id="cb14-761"><a href="#cb14-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-762"><a href="#cb14-762" aria-hidden="true" tabindex="-1"></a>annot_abim <span class="ot">&lt;-</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span></span>
<span id="cb14-763"><a href="#cb14-763" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-764"><a href="#cb14-764" aria-hidden="true" tabindex="-1"></a>            <span class="at">EntrezGene.ID =</span> entrez,</span>
<span id="cb14-765"><a href="#cb14-765" aria-hidden="true" tabindex="-1"></a>            <span class="at">Gene.Symbol =</span> symbol</span>
<span id="cb14-766"><a href="#cb14-766" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb14-767"><a href="#cb14-767" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(symbol)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-768"><a href="#cb14-768" aria-hidden="true" tabindex="-1"></a>        data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-769"><a href="#cb14-769" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>symbol)</span>
<span id="cb14-770"><a href="#cb14-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-771"><a href="#cb14-771" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(sig.gene70)</span>
<span id="cb14-772"><a href="#cb14-772" aria-hidden="true" tabindex="-1"></a>sig.gene70 <span class="ot">&lt;-</span> sig.gene70 <span class="sc">%&gt;%</span></span>
<span id="cb14-773"><a href="#cb14-773" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(HUGO.gene.symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb14-774"><a href="#cb14-774" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(HUGO.gene.symbol, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-775"><a href="#cb14-775" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>HUGO.gene.symbol)</span>
<span id="cb14-776"><a href="#cb14-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-777"><a href="#cb14-777" aria-hidden="true" tabindex="-1"></a>erp_abim <span class="ot">&lt;-</span> <span class="fu">colData</span>(abim_100) <span class="sc">%&gt;%</span></span>
<span id="cb14-778"><a href="#cb14-778" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-779"><a href="#cb14-779" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(ER <span class="sc">==</span> <span class="st">"Positive"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-780"><a href="#cb14-780" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(sample_name)</span>
<span id="cb14-781"><a href="#cb14-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-782"><a href="#cb14-782" aria-hidden="true" tabindex="-1"></a>abim_100 <span class="ot">&lt;-</span> abim_100[, erp_abim]</span>
<span id="cb14-783"><a href="#cb14-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-784"><a href="#cb14-784" aria-hidden="true" tabindex="-1"></a>mammaprint_abim <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">gene70</span>(</span>
<span id="cb14-785"><a href="#cb14-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">t</span>(<span class="fu">assay</span>(abim_100, <span class="st">"log2fpkm"</span>)), </span>
<span id="cb14-786"><a href="#cb14-786" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_abim,</span>
<span id="cb14-787"><a href="#cb14-787" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-788"><a href="#cb14-788" aria-hidden="true" tabindex="-1"></a>    <span class="at">std =</span> <span class="st">"robust"</span>,</span>
<span id="cb14-789"><a href="#cb14-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb14-790"><a href="#cb14-790" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-791"><a href="#cb14-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-792"><a href="#cb14-792" aria-hidden="true" tabindex="-1"></a>abim_100<span class="sc">$</span>GENEFU.GENE70 <span class="ot">&lt;-</span> mammaprint_abim<span class="sc">$</span>score</span>
<span id="cb14-793"><a href="#cb14-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-794"><a href="#cb14-794" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(abim_100) <span class="sc">%&gt;%</span></span>
<span id="cb14-795"><a href="#cb14-795" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-796"><a href="#cb14-796" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb14-797"><a href="#cb14-797" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb14-798"><a href="#cb14-798" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> GENEFU.GENE70, </span>
<span id="cb14-799"><a href="#cb14-799" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> ProsignaFT.ROR, </span>
<span id="cb14-800"><a href="#cb14-800" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> ProsignaFT.Subtype</span>
<span id="cb14-801"><a href="#cb14-801" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-802"><a href="#cb14-802" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-803"><a href="#cb14-803" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-804"><a href="#cb14-804" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb14-805"><a href="#cb14-805" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb14-806"><a href="#cb14-806" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"loess"</span>,</span>
<span id="cb14-807"><a href="#cb14-807" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> <span class="st">"y ~ x"</span></span>
<span id="cb14-808"><a href="#cb14-808" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-809"><a href="#cb14-809" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ABiM 100 cohort"</span>) <span class="sc">+</span></span>
<span id="cb14-810"><a href="#cb14-810" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-811"><a href="#cb14-811" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-812"><a href="#cb14-812" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-813"><a href="#cb14-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-814"><a href="#cb14-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-815"><a href="#cb14-815" aria-hidden="true" tabindex="-1"></a>@fig-ror-mammaprint-genefu-abim shows the correlation between </span>
<span id="cb14-816"><a href="#cb14-816" aria-hidden="true" tabindex="-1"></a>the mammaprint signature (named GENE70) and the ROR from prosigna. </span>
<span id="cb14-817"><a href="#cb14-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-818"><a href="#cb14-818" aria-hidden="true" tabindex="-1"></a>Let us now compare the GENE70 signature with the risk score developed in </span>
<span id="cb14-819"><a href="#cb14-819" aria-hidden="true" tabindex="-1"></a>the previous chapters. We use the ABiM 100 cohort to make the comparison. </span>
<span id="cb14-820"><a href="#cb14-820" aria-hidden="true" tabindex="-1"></a>One side note, we are using only 51 out of the 70 probes available in the</span>
<span id="cb14-821"><a href="#cb14-821" aria-hidden="true" tabindex="-1"></a>package. 15 probes don't have any corresponding symbol. Out of the available</span>
<span id="cb14-822"><a href="#cb14-822" aria-hidden="true" tabindex="-1"></a>genes, some are duplicated. For the duplicated genes, the correlation </span>
<span id="cb14-823"><a href="#cb14-823" aria-hidden="true" tabindex="-1"></a>coefficients are all similar, so we can select just the first ocurrence </span>
<span id="cb14-824"><a href="#cb14-824" aria-hidden="true" tabindex="-1"></a>in the list.</span>
<span id="cb14-825"><a href="#cb14-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-828"><a href="#cb14-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-829"><a href="#cb14-829" aria-hidden="true" tabindex="-1"></a>coefs_risk_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb14-830"><a href="#cb14-830" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/risk_score/coefs_risk_model.rds"</span></span>
<span id="cb14-831"><a href="#cb14-831" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-832"><a href="#cb14-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-833"><a href="#cb14-833" aria-hidden="true" tabindex="-1"></a>abim_100<span class="sc">$</span>risk_score <span class="ot">&lt;-</span> <span class="fu">calculate_risk_score</span>(</span>
<span id="cb14-834"><a href="#cb14-834" aria-hidden="true" tabindex="-1"></a>    coefs_risk_model,</span>
<span id="cb14-835"><a href="#cb14-835" aria-hidden="true" tabindex="-1"></a>    abim_100_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-836"><a href="#cb14-836" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(sample_name <span class="sc">%in%</span> <span class="fu">colnames</span>(abim_100)),</span>
<span id="cb14-837"><a href="#cb14-837" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_node =</span> <span class="cn">TRUE</span></span>
<span id="cb14-838"><a href="#cb14-838" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-839"><a href="#cb14-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-840"><a href="#cb14-840" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(abim_100) <span class="sc">%&gt;%</span></span>
<span id="cb14-841"><a href="#cb14-841" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-842"><a href="#cb14-842" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb14-843"><a href="#cb14-843" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb14-844"><a href="#cb14-844" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> GENEFU.GENE70, </span>
<span id="cb14-845"><a href="#cb14-845" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> risk_score, </span>
<span id="cb14-846"><a href="#cb14-846" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> ProsignaFT.Subtype</span>
<span id="cb14-847"><a href="#cb14-847" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-848"><a href="#cb14-848" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-849"><a href="#cb14-849" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-850"><a href="#cb14-850" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb14-851"><a href="#cb14-851" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb14-852"><a href="#cb14-852" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"loess"</span>,</span>
<span id="cb14-853"><a href="#cb14-853" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> <span class="st">"y ~ x"</span></span>
<span id="cb14-854"><a href="#cb14-854" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-855"><a href="#cb14-855" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-856"><a href="#cb14-856" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-857"><a href="#cb14-857" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"ABiM 100 cohort, ER+ BC only"</span>,</span>
<span id="cb14-858"><a href="#cb14-858" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Risk score"</span></span>
<span id="cb14-859"><a href="#cb14-859" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-860"><a href="#cb14-860" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-861"><a href="#cb14-861" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-862"><a href="#cb14-862" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-863"><a href="#cb14-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-864"><a href="#cb14-864" aria-hidden="true" tabindex="-1"></a>There is a good correlation between the two signatures, suggesting </span>
<span id="cb14-865"><a href="#cb14-865" aria-hidden="true" tabindex="-1"></a>that the Mammaprint signature is somehow based on the position of the samples in</span>
<span id="cb14-866"><a href="#cb14-866" aria-hidden="true" tabindex="-1"></a>the molecular landscape. </span>
<span id="cb14-867"><a href="#cb14-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-868"><a href="#cb14-868" aria-hidden="true" tabindex="-1"></a>We now proceed and calculate the mammaprint scores for SCANB and </span>
<span id="cb14-869"><a href="#cb14-869" aria-hidden="true" tabindex="-1"></a>METABRIC as well and only for ER+ BC samples.</span>
<span id="cb14-870"><a href="#cb14-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-873"><a href="#cb14-873" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-874"><a href="#cb14-874" aria-hidden="true" tabindex="-1"></a>mammaprint_datasets <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb14-875"><a href="#cb14-875" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, y){</span>
<span id="cb14-876"><a href="#cb14-876" aria-hidden="true" tabindex="-1"></a>        genefu<span class="sc">::</span><span class="fu">gene70</span>(</span>
<span id="cb14-877"><a href="#cb14-877" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">t</span>(<span class="fu">assay</span>(x, y)),</span>
<span id="cb14-878"><a href="#cb14-878" aria-hidden="true" tabindex="-1"></a>            <span class="at">annot =</span> annot_abim,</span>
<span id="cb14-879"><a href="#cb14-879" aria-hidden="true" tabindex="-1"></a>            <span class="at">do.mapping =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-880"><a href="#cb14-880" aria-hidden="true" tabindex="-1"></a>            <span class="at">std =</span> <span class="st">"robust"</span>,</span>
<span id="cb14-881"><a href="#cb14-881" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb14-882"><a href="#cb14-882" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span>score <span class="sc">%&gt;%</span></span>
<span id="cb14-883"><a href="#cb14-883" aria-hidden="true" tabindex="-1"></a>            data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-884"><a href="#cb14-884" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(<span class="fu">c</span>(<span class="st">"mammaprint"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-885"><a href="#cb14-885" aria-hidden="true" tabindex="-1"></a>            tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>) </span>
<span id="cb14-886"><a href="#cb14-886" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-887"><a href="#cb14-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> datasets,</span>
<span id="cb14-888"><a href="#cb14-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(which_exp, <span class="st">"poetic"</span> <span class="ot">=</span> <span class="st">"normalized_intensity"</span>),</span>
<span id="cb14-889"><a href="#cb14-889" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-890"><a href="#cb14-890" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb14-891"><a href="#cb14-891" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"cohort"</span>)</span>
<span id="cb14-892"><a href="#cb14-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-893"><a href="#cb14-893" aria-hidden="true" tabindex="-1"></a>scanb_metabric_erp <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-894"><a href="#cb14-894" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-895"><a href="#cb14-895" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"scanb"</span>, <span class="st">"metabric"</span>) <span class="sc">&amp;</span></span>
<span id="cb14-896"><a href="#cb14-896" aria-hidden="true" tabindex="-1"></a>            er_status <span class="sc">==</span> <span class="st">"pos"</span></span>
<span id="cb14-897"><a href="#cb14-897" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-898"><a href="#cb14-898" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-899"><a href="#cb14-899" aria-hidden="true" tabindex="-1"></a>        mammaprint_datasets,</span>
<span id="cb14-900"><a href="#cb14-900" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>, <span class="st">"cohort"</span>)</span>
<span id="cb14-901"><a href="#cb14-901" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-902"><a href="#cb14-902" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-903"><a href="#cb14-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-904"><a href="#cb14-904" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=5}</span></span>
<span id="cb14-905"><a href="#cb14-905" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-met-scanb-mammaprint</span></span>
<span id="cb14-906"><a href="#cb14-906" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of ER+ BC samples colored by the mammaprint </span></span>
<span id="cb14-907"><a href="#cb14-907" aria-hidden="true" tabindex="-1"></a><span class="co">#|     score.</span></span>
<span id="cb14-908"><a href="#cb14-908" aria-hidden="true" tabindex="-1"></a>scanb_metabric_erp <span class="sc">%&gt;%</span></span>
<span id="cb14-909"><a href="#cb14-909" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">z =</span> mammaprint)) <span class="sc">+</span> </span>
<span id="cb14-910"><a href="#cb14-910" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb14-911"><a href="#cb14-911" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span> cohort) <span class="sc">+</span></span>
<span id="cb14-912"><a href="#cb14-912" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb14-913"><a href="#cb14-913" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Mammaprint"</span>) <span class="sc">+</span></span>
<span id="cb14-914"><a href="#cb14-914" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb14-915"><a href="#cb14-915" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-916"><a href="#cb14-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-917"><a href="#cb14-917" aria-hidden="true" tabindex="-1"></a>We see that the pattern is very close to what we have from the risk score </span>
<span id="cb14-918"><a href="#cb14-918" aria-hidden="true" tabindex="-1"></a>created in the previous chapter. The figure below shows the correlation</span>
<span id="cb14-919"><a href="#cb14-919" aria-hidden="true" tabindex="-1"></a>between mammaprint and the risk score once again.</span>
<span id="cb14-920"><a href="#cb14-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-923"><a href="#cb14-923" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-924"><a href="#cb14-924" aria-hidden="true" tabindex="-1"></a>endo_only_scanb <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb14-925"><a href="#cb14-925" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-926"><a href="#cb14-926" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">node_status =</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-927"><a href="#cb14-927" aria-hidden="true" tabindex="-1"></a>        node_group <span class="sc">==</span> <span class="st">"N0"</span>, </span>
<span id="cb14-928"><a href="#cb14-928" aria-hidden="true" tabindex="-1"></a>        <span class="st">"neg"</span>,</span>
<span id="cb14-929"><a href="#cb14-929" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pos"</span></span>
<span id="cb14-930"><a href="#cb14-930" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb14-931"><a href="#cb14-931" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">node_status =</span> <span class="fu">factor</span>(</span>
<span id="cb14-932"><a href="#cb14-932" aria-hidden="true" tabindex="-1"></a>        node_status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"neg"</span>, <span class="st">"pos"</span>)</span>
<span id="cb14-933"><a href="#cb14-933" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb14-934"><a href="#cb14-934" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-935"><a href="#cb14-935" aria-hidden="true" tabindex="-1"></a>            TreatGroup <span class="sc">==</span> <span class="st">"Endo"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-936"><a href="#cb14-936" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(rfs_status) <span class="sc">&amp;</span> </span>
<span id="cb14-937"><a href="#cb14-937" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(rfs_months) <span class="sc">&amp;</span></span>
<span id="cb14-938"><a href="#cb14-938" aria-hidden="true" tabindex="-1"></a>            er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span></span>
<span id="cb14-939"><a href="#cb14-939" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(age) <span class="sc">&amp;</span></span>
<span id="cb14-940"><a href="#cb14-940" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(tumor_size) <span class="sc">&amp;</span></span>
<span id="cb14-941"><a href="#cb14-941" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(node_status)</span>
<span id="cb14-942"><a href="#cb14-942" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-943"><a href="#cb14-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-944"><a href="#cb14-944" aria-hidden="true" tabindex="-1"></a>endo_only_metabric <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb14-945"><a href="#cb14-945" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"metabric"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-946"><a href="#cb14-946" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">TreatGroup =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-947"><a href="#cb14-947" aria-hidden="true" tabindex="-1"></a>        HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">&amp;</span> CHEMOTHERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">~</span> <span class="st">"ChemoEndo"</span>,</span>
<span id="cb14-948"><a href="#cb14-948" aria-hidden="true" tabindex="-1"></a>        HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">&amp;</span> CHEMOTHERAPY <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">~</span> <span class="st">"Endo"</span>,</span>
<span id="cb14-949"><a href="#cb14-949" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb14-950"><a href="#cb14-950" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb14-951"><a href="#cb14-951" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">node_status =</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-952"><a href="#cb14-952" aria-hidden="true" tabindex="-1"></a>        LYMPH_NODES_EXAMINED_POSITIVE <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb14-953"><a href="#cb14-953" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pos"</span>,</span>
<span id="cb14-954"><a href="#cb14-954" aria-hidden="true" tabindex="-1"></a>        <span class="st">"neg"</span></span>
<span id="cb14-955"><a href="#cb14-955" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb14-956"><a href="#cb14-956" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-957"><a href="#cb14-957" aria-hidden="true" tabindex="-1"></a>        <span class="at">node_status =</span> <span class="fu">factor</span>(node_status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"neg"</span>, <span class="st">"pos"</span>)),</span>
<span id="cb14-958"><a href="#cb14-958" aria-hidden="true" tabindex="-1"></a>        <span class="at">tumor_size =</span> TUMOR_SIZE</span>
<span id="cb14-959"><a href="#cb14-959" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-960"><a href="#cb14-960" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-961"><a href="#cb14-961" aria-hidden="true" tabindex="-1"></a>            HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-962"><a href="#cb14-962" aria-hidden="true" tabindex="-1"></a>            CHEMOTHERAPY <span class="sc">==</span> <span class="st">"NO"</span> <span class="sc">&amp;</span></span>
<span id="cb14-963"><a href="#cb14-963" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(rfs_status) <span class="sc">&amp;</span> </span>
<span id="cb14-964"><a href="#cb14-964" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(rfs_months) <span class="sc">&amp;</span></span>
<span id="cb14-965"><a href="#cb14-965" aria-hidden="true" tabindex="-1"></a>            er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span></span>
<span id="cb14-966"><a href="#cb14-966" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(age) <span class="sc">&amp;</span></span>
<span id="cb14-967"><a href="#cb14-967" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(tumor_size) <span class="sc">&amp;</span></span>
<span id="cb14-968"><a href="#cb14-968" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(node_status)</span>
<span id="cb14-969"><a href="#cb14-969" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-970"><a href="#cb14-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-971"><a href="#cb14-971" aria-hidden="true" tabindex="-1"></a>endo_scanb_metabric <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb14-972"><a href="#cb14-972" aria-hidden="true" tabindex="-1"></a>    endo_only_metabric,</span>
<span id="cb14-973"><a href="#cb14-973" aria-hidden="true" tabindex="-1"></a>    endo_only_scanb</span>
<span id="cb14-974"><a href="#cb14-974" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-975"><a href="#cb14-975" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-976"><a href="#cb14-976" aria-hidden="true" tabindex="-1"></a>        mammaprint_datasets,</span>
<span id="cb14-977"><a href="#cb14-977" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>, <span class="st">"cohort"</span>)</span>
<span id="cb14-978"><a href="#cb14-978" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-979"><a href="#cb14-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-980"><a href="#cb14-980" aria-hidden="true" tabindex="-1"></a>endo_scanb_metabric<span class="sc">$</span>risk_score <span class="ot">&lt;-</span> <span class="fu">calculate_risk_score</span>(</span>
<span id="cb14-981"><a href="#cb14-981" aria-hidden="true" tabindex="-1"></a>    coefs_risk_model, endo_scanb_metabric</span>
<span id="cb14-982"><a href="#cb14-982" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-983"><a href="#cb14-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-984"><a href="#cb14-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-985"><a href="#cb14-985" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=14, fig.height=8}</span></span>
<span id="cb14-986"><a href="#cb14-986" aria-hidden="true" tabindex="-1"></a>endo_scanb_metabric <span class="sc">%&gt;%</span></span>
<span id="cb14-987"><a href="#cb14-987" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">!=</span> <span class="st">"claudin-low"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-988"><a href="#cb14-988" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-989"><a href="#cb14-989" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb14-990"><a href="#cb14-990" aria-hidden="true" tabindex="-1"></a>            <span class="st">"risk_score"</span>,</span>
<span id="cb14-991"><a href="#cb14-991" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_G2M_CHECKPOINT"</span>,</span>
<span id="cb14-992"><a href="#cb14-992" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SET_ERPR"</span></span>
<span id="cb14-993"><a href="#cb14-993" aria-hidden="true" tabindex="-1"></a>        )),</span>
<span id="cb14-994"><a href="#cb14-994" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span>,</span>
<span id="cb14-995"><a href="#cb14-995" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span></span>
<span id="cb14-996"><a href="#cb14-996" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-997"><a href="#cb14-997" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mammaprint, <span class="at">y =</span> score, <span class="at">color =</span> pam50)) <span class="sc">+</span> </span>
<span id="cb14-998"><a href="#cb14-998" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb14-999"><a href="#cb14-999" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb14-1000"><a href="#cb14-1000" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"loess"</span>,</span>
<span id="cb14-1001"><a href="#cb14-1001" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y <span class="sc">~</span> x,</span>
<span id="cb14-1002"><a href="#cb14-1002" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb14-1003"><a href="#cb14-1003" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-1004"><a href="#cb14-1004" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb14-1005"><a href="#cb14-1005" aria-hidden="true" tabindex="-1"></a>        cohort<span class="sc">~</span>pathway, </span>
<span id="cb14-1006"><a href="#cb14-1006" aria-hidden="true" tabindex="-1"></a>        <span class="at">scales =</span> <span class="st">"free_y"</span>,</span>
<span id="cb14-1007"><a href="#cb14-1007" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(</span>
<span id="cb14-1008"><a href="#cb14-1008" aria-hidden="true" tabindex="-1"></a>            <span class="st">"scanb"</span> <span class="ot">=</span> <span class="st">"SCANB"</span>,</span>
<span id="cb14-1009"><a href="#cb14-1009" aria-hidden="true" tabindex="-1"></a>            <span class="st">"metabric"</span> <span class="ot">=</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb14-1010"><a href="#cb14-1010" aria-hidden="true" tabindex="-1"></a>            <span class="st">"HALLMARK_G2M_CHECKPOINT"</span> <span class="ot">=</span> <span class="st">"G2M"</span>,</span>
<span id="cb14-1011"><a href="#cb14-1011" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SET_ERPR"</span> <span class="ot">=</span> <span class="st">"SET ER/PR"</span>,</span>
<span id="cb14-1012"><a href="#cb14-1012" aria-hidden="true" tabindex="-1"></a>            <span class="st">"risk_score"</span> <span class="ot">=</span> <span class="st">"Risk score"</span></span>
<span id="cb14-1013"><a href="#cb14-1013" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb14-1014"><a href="#cb14-1014" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1015"><a href="#cb14-1015" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-1016"><a href="#cb14-1016" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(endo_scanb_metabric)) <span class="sc">+</span></span>
<span id="cb14-1017"><a href="#cb14-1017" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-1018"><a href="#cb14-1018" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1019"><a href="#cb14-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1020"><a href="#cb14-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1021"><a href="#cb14-1021" aria-hidden="true" tabindex="-1"></a>Now for OncotypeDX:</span>
<span id="cb14-1022"><a href="#cb14-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1025"><a href="#cb14-1025" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1026"><a href="#cb14-1026" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ror-genefu-abim-oncotype</span></span>
<span id="cb14-1027"><a href="#cb14-1027" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Correlation between oncotypeDX and </span></span>
<span id="cb14-1028"><a href="#cb14-1028" aria-hidden="true" tabindex="-1"></a><span class="co">#|     R package genefu</span></span>
<span id="cb14-1029"><a href="#cb14-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1030"><a href="#cb14-1030" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(sig.endoPredict)</span>
<span id="cb14-1031"><a href="#cb14-1031" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(sig.oncotypedx)</span>
<span id="cb14-1032"><a href="#cb14-1032" aria-hidden="true" tabindex="-1"></a>ep_abim <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">endoPredict</span>(</span>
<span id="cb14-1033"><a href="#cb14-1033" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">t</span>(<span class="fu">assay</span>(abim_100, <span class="st">"log2fpkm"</span>)), </span>
<span id="cb14-1034"><a href="#cb14-1034" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_abim,</span>
<span id="cb14-1035"><a href="#cb14-1035" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-1036"><a href="#cb14-1036" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb14-1037"><a href="#cb14-1037" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1038"><a href="#cb14-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1039"><a href="#cb14-1039" aria-hidden="true" tabindex="-1"></a>oncotypedx_abim <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">oncotypedx</span>(</span>
<span id="cb14-1040"><a href="#cb14-1040" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">t</span>(<span class="fu">assay</span>(abim_100, <span class="st">"log2fpkm"</span>)), </span>
<span id="cb14-1041"><a href="#cb14-1041" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_abim,</span>
<span id="cb14-1042"><a href="#cb14-1042" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-1043"><a href="#cb14-1043" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-1044"><a href="#cb14-1044" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.scaling =</span> <span class="cn">FALSE</span></span>
<span id="cb14-1045"><a href="#cb14-1045" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1046"><a href="#cb14-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1047"><a href="#cb14-1047" aria-hidden="true" tabindex="-1"></a>abim_100<span class="sc">$</span>GENEFU.ONCOTYPEDX <span class="ot">&lt;-</span> oncotypedx_abim<span class="sc">$</span>score</span>
<span id="cb14-1048"><a href="#cb14-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1049"><a href="#cb14-1049" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(abim_100) <span class="sc">%&gt;%</span></span>
<span id="cb14-1050"><a href="#cb14-1050" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1051"><a href="#cb14-1051" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb14-1052"><a href="#cb14-1052" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb14-1053"><a href="#cb14-1053" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> GENEFU.ONCOTYPEDX, </span>
<span id="cb14-1054"><a href="#cb14-1054" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> risk_score, </span>
<span id="cb14-1055"><a href="#cb14-1055" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> ProsignaFT.Subtype</span>
<span id="cb14-1056"><a href="#cb14-1056" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1057"><a href="#cb14-1057" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-1058"><a href="#cb14-1058" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-1059"><a href="#cb14-1059" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(</span>
<span id="cb14-1060"><a href="#cb14-1060" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb14-1061"><a href="#cb14-1061" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"loess"</span>,</span>
<span id="cb14-1062"><a href="#cb14-1062" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> <span class="st">"y ~ x"</span></span>
<span id="cb14-1063"><a href="#cb14-1063" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-1064"><a href="#cb14-1064" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1065"><a href="#cb14-1065" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-1066"><a href="#cb14-1066" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1067"><a href="#cb14-1067" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1068"><a href="#cb14-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1069"><a href="#cb14-1069" aria-hidden="true" tabindex="-1"></a>There is also a correlation between the risk score and oncotypeDX.</span>
<span id="cb14-1070"><a href="#cb14-1070" aria-hidden="true" tabindex="-1"></a>The paper https://www.nature.com/articles/s41523-022-00492-0#Sec8</span>
<span id="cb14-1071"><a href="#cb14-1071" aria-hidden="true" tabindex="-1"></a>also used the genefu for calculating the oncotypeDX. </span>
<span id="cb14-1072"><a href="#cb14-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1073"><a href="#cb14-1073" aria-hidden="true" tabindex="-1"></a><span class="fu">### genefu and AIMS</span></span>
<span id="cb14-1074"><a href="#cb14-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1075"><a href="#cb14-1075" aria-hidden="true" tabindex="-1"></a>Here we try to use AIMS to calculate the PAM50 subtypes for the</span>
<span id="cb14-1076"><a href="#cb14-1076" aria-hidden="true" tabindex="-1"></a>and compare with the results obtained previously. We want to compare</span>
<span id="cb14-1077"><a href="#cb14-1077" aria-hidden="true" tabindex="-1"></a>the classifications with the molecular landscape.</span>
<span id="cb14-1078"><a href="#cb14-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1081"><a href="#cb14-1081" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1082"><a href="#cb14-1082" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(AIMSmodel)</span>
<span id="cb14-1083"><a href="#cb14-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1084"><a href="#cb14-1084" aria-hidden="true" tabindex="-1"></a><span class="co"># we have to match the symbols</span></span>
<span id="cb14-1085"><a href="#cb14-1085" aria-hidden="true" tabindex="-1"></a>annot_aims <span class="ot">&lt;-</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span> </span>
<span id="cb14-1086"><a href="#cb14-1086" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(entrez, symbol) <span class="sc">%&gt;%</span></span>
<span id="cb14-1087"><a href="#cb14-1087" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">EntrezGene.ID =</span> entrez) <span class="sc">%&gt;%</span></span>
<span id="cb14-1088"><a href="#cb14-1088" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">EntrezGene.ID =</span> <span class="fu">as.character</span>(EntrezGene.ID)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1089"><a href="#cb14-1089" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(symbol <span class="sc">%in%</span> <span class="fu">rownames</span>(pdx_tpm)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1090"><a href="#cb14-1090" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1091"><a href="#cb14-1091" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1092"><a href="#cb14-1092" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>symbol)</span>
<span id="cb14-1093"><a href="#cb14-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1094"><a href="#cb14-1094" aria-hidden="true" tabindex="-1"></a>pdx_tpm <span class="ot">&lt;-</span> pdx_tpm[annot_aims<span class="sc">$</span>symbol, ]</span>
<span id="cb14-1095"><a href="#cb14-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1096"><a href="#cb14-1096" aria-hidden="true" tabindex="-1"></a>sbt_pdx_AIMS <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">molecular.subtyping</span>(</span>
<span id="cb14-1097"><a href="#cb14-1097" aria-hidden="true" tabindex="-1"></a>    <span class="at">sbt.model =</span> <span class="st">"AIMS"</span>, </span>
<span id="cb14-1098"><a href="#cb14-1098" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">assay</span>(pdx_tpm, <span class="st">"log2tpm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1099"><a href="#cb14-1099" aria-hidden="true" tabindex="-1"></a>        t,</span>
<span id="cb14-1100"><a href="#cb14-1100" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_aims,</span>
<span id="cb14-1101"><a href="#cb14-1101" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">TRUE</span></span>
<span id="cb14-1102"><a href="#cb14-1102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1103"><a href="#cb14-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1104"><a href="#cb14-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1105"><a href="#cb14-1105" aria-hidden="true" tabindex="-1"></a>annot_aims_abim_100 <span class="ot">&lt;-</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span> </span>
<span id="cb14-1106"><a href="#cb14-1106" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(entrez, symbol) <span class="sc">%&gt;%</span></span>
<span id="cb14-1107"><a href="#cb14-1107" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">EntrezGene.ID =</span> entrez) <span class="sc">%&gt;%</span></span>
<span id="cb14-1108"><a href="#cb14-1108" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">EntrezGene.ID =</span> <span class="fu">as.character</span>(EntrezGene.ID)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1109"><a href="#cb14-1109" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(symbol <span class="sc">%in%</span> <span class="fu">rownames</span>(abim_100)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1110"><a href="#cb14-1110" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1111"><a href="#cb14-1111" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1112"><a href="#cb14-1112" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>symbol)</span>
<span id="cb14-1113"><a href="#cb14-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1114"><a href="#cb14-1114" aria-hidden="true" tabindex="-1"></a>abim_100 <span class="ot">&lt;-</span> abim_100[annot_aims_abim_100<span class="sc">$</span>symbol, ]</span>
<span id="cb14-1115"><a href="#cb14-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1116"><a href="#cb14-1116" aria-hidden="true" tabindex="-1"></a>sbt_aim_100_AIMS <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">molecular.subtyping</span>(</span>
<span id="cb14-1117"><a href="#cb14-1117" aria-hidden="true" tabindex="-1"></a>    <span class="at">sbt.model =</span> <span class="st">"AIMS"</span>, </span>
<span id="cb14-1118"><a href="#cb14-1118" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">assay</span>(abim_100, <span class="st">"log2fpkm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1119"><a href="#cb14-1119" aria-hidden="true" tabindex="-1"></a>        t,</span>
<span id="cb14-1120"><a href="#cb14-1120" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_aims_abim_100,</span>
<span id="cb14-1121"><a href="#cb14-1121" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">TRUE</span></span>
<span id="cb14-1122"><a href="#cb14-1122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1123"><a href="#cb14-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1124"><a href="#cb14-1124" aria-hidden="true" tabindex="-1"></a>abim_100<span class="sc">$</span>aims_pam50 <span class="ot">&lt;-</span> sbt_aim_100_AIMS<span class="sc">$</span>subtype <span class="sc">%&gt;%</span> <span class="fu">as.vector</span>()</span>
<span id="cb14-1125"><a href="#cb14-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1126"><a href="#cb14-1126" aria-hidden="true" tabindex="-1"></a><span class="co"># try with swiss normal as we have the baseline values</span></span>
<span id="cb14-1127"><a href="#cb14-1127" aria-hidden="true" tabindex="-1"></a>normal_swiss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../../results/rds_files/validation/normal_swiss.rds"</span>)</span>
<span id="cb14-1128"><a href="#cb14-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1129"><a href="#cb14-1129" aria-hidden="true" tabindex="-1"></a>annot_aims_normal_swiss <span class="ot">&lt;-</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span> </span>
<span id="cb14-1130"><a href="#cb14-1130" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(entrez, symbol) <span class="sc">%&gt;%</span></span>
<span id="cb14-1131"><a href="#cb14-1131" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">EntrezGene.ID =</span> entrez) <span class="sc">%&gt;%</span></span>
<span id="cb14-1132"><a href="#cb14-1132" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">EntrezGene.ID =</span> <span class="fu">as.character</span>(EntrezGene.ID)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1133"><a href="#cb14-1133" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(symbol <span class="sc">%in%</span> <span class="fu">rownames</span>(normal_swiss)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1134"><a href="#cb14-1134" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1135"><a href="#cb14-1135" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1136"><a href="#cb14-1136" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>symbol)</span>
<span id="cb14-1137"><a href="#cb14-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1138"><a href="#cb14-1138" aria-hidden="true" tabindex="-1"></a>normal_swiss <span class="ot">&lt;-</span> normal_swiss[annot_aims_normal_swiss<span class="sc">$</span>symbol, ]</span>
<span id="cb14-1139"><a href="#cb14-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1140"><a href="#cb14-1140" aria-hidden="true" tabindex="-1"></a>sbt_normal_swiss_AIMS <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">molecular.subtyping</span>(</span>
<span id="cb14-1141"><a href="#cb14-1141" aria-hidden="true" tabindex="-1"></a>    <span class="at">sbt.model =</span> <span class="st">"AIMS"</span>, </span>
<span id="cb14-1142"><a href="#cb14-1142" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">assay</span>(normal_swiss, <span class="st">"log2fpkm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1143"><a href="#cb14-1143" aria-hidden="true" tabindex="-1"></a>        t,</span>
<span id="cb14-1144"><a href="#cb14-1144" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_aims_normal_swiss,</span>
<span id="cb14-1145"><a href="#cb14-1145" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">TRUE</span></span>
<span id="cb14-1146"><a href="#cb14-1146" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1147"><a href="#cb14-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1148"><a href="#cb14-1148" aria-hidden="true" tabindex="-1"></a>normal_swiss<span class="sc">$</span>aims_pam50 <span class="ot">&lt;-</span> sbt_normal_swiss_AIMS<span class="sc">$</span>subtype <span class="sc">%&gt;%</span> <span class="fu">as.vector</span>()</span>
<span id="cb14-1149"><a href="#cb14-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1150"><a href="#cb14-1150" aria-hidden="true" tabindex="-1"></a><span class="co"># and we try with scanb as well</span></span>
<span id="cb14-1151"><a href="#cb14-1151" aria-hidden="true" tabindex="-1"></a>annot_aims_scanb <span class="ot">&lt;-</span> annotables<span class="sc">::</span>grch38 <span class="sc">%&gt;%</span> </span>
<span id="cb14-1152"><a href="#cb14-1152" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(entrez, symbol) <span class="sc">%&gt;%</span></span>
<span id="cb14-1153"><a href="#cb14-1153" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">EntrezGene.ID =</span> entrez) <span class="sc">%&gt;%</span></span>
<span id="cb14-1154"><a href="#cb14-1154" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">EntrezGene.ID =</span> <span class="fu">as.character</span>(EntrezGene.ID)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1155"><a href="#cb14-1155" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(symbol <span class="sc">%in%</span> <span class="fu">rownames</span>(datasets<span class="sc">$</span>scanb)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1156"><a href="#cb14-1156" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(symbol)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1157"><a href="#cb14-1157" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1158"><a href="#cb14-1158" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rownames&lt;-</span><span class="st">`</span>(.<span class="sc">$</span>symbol)</span>
<span id="cb14-1159"><a href="#cb14-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1160"><a href="#cb14-1160" aria-hidden="true" tabindex="-1"></a>scanb <span class="ot">&lt;-</span> datasets<span class="sc">$</span>scanb[annot_aims_scanb<span class="sc">$</span>symbol, ]</span>
<span id="cb14-1161"><a href="#cb14-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1162"><a href="#cb14-1162" aria-hidden="true" tabindex="-1"></a>sbt_scanb_AIMS <span class="ot">&lt;-</span> genefu<span class="sc">::</span><span class="fu">molecular.subtyping</span>(</span>
<span id="cb14-1163"><a href="#cb14-1163" aria-hidden="true" tabindex="-1"></a>    <span class="at">sbt.model =</span> <span class="st">"AIMS"</span>, </span>
<span id="cb14-1164"><a href="#cb14-1164" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">assay</span>(scanb, <span class="st">"logFPKM"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1165"><a href="#cb14-1165" aria-hidden="true" tabindex="-1"></a>        t,</span>
<span id="cb14-1166"><a href="#cb14-1166" aria-hidden="true" tabindex="-1"></a>    <span class="at">annot =</span> annot_aims_scanb,</span>
<span id="cb14-1167"><a href="#cb14-1167" aria-hidden="true" tabindex="-1"></a>    <span class="at">do.mapping =</span> <span class="cn">TRUE</span></span>
<span id="cb14-1168"><a href="#cb14-1168" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1169"><a href="#cb14-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1170"><a href="#cb14-1170" aria-hidden="true" tabindex="-1"></a>scanb<span class="sc">$</span>aims_pam50 <span class="ot">&lt;-</span> sbt_scanb_AIMS<span class="sc">$</span>subtype <span class="sc">%&gt;%</span> as.vector</span>
<span id="cb14-1171"><a href="#cb14-1171" aria-hidden="true" tabindex="-1"></a>scanb_coldata <span class="ot">&lt;-</span> <span class="fu">colData</span>(scanb) <span class="sc">%&gt;%</span></span>
<span id="cb14-1172"><a href="#cb14-1172" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1173"><a href="#cb14-1173" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-1174"><a href="#cb14-1174" aria-hidden="true" tabindex="-1"></a>        <span class="at">aims_pam50 =</span> <span class="fu">factor</span>(<span class="fu">tolower</span>(aims_pam50), <span class="at">levels =</span> <span class="fu">unique</span>(pam50)),</span>
<span id="cb14-1175"><a href="#cb14-1175" aria-hidden="true" tabindex="-1"></a>        <span class="at">pam50 =</span> <span class="fu">factor</span>(pam50, <span class="at">levels =</span> <span class="fu">unique</span>(pam50))</span>
<span id="cb14-1176"><a href="#cb14-1176" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb14-1177"><a href="#cb14-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1178"><a href="#cb14-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1179"><a href="#cb14-1179" aria-hidden="true" tabindex="-1"></a>The confusion matrix below show the results of the AIMS PAM50 as the</span>
<span id="cb14-1180"><a href="#cb14-1180" aria-hidden="true" tabindex="-1"></a>predicted and the reference is the PAM50 subtypes obtained from the</span>
<span id="cb14-1181"><a href="#cb14-1181" aria-hidden="true" tabindex="-1"></a>SCANB team.</span>
<span id="cb14-1182"><a href="#cb14-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1185"><a href="#cb14-1185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1186"><a href="#cb14-1186" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(scanb_coldata<span class="sc">$</span>aims_pam50, scanb_coldata<span class="sc">$</span>pam50)</span>
<span id="cb14-1187"><a href="#cb14-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1188"><a href="#cb14-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1189"><a href="#cb14-1189" aria-hidden="true" tabindex="-1"></a>We see that there is a big misclassification from luminal A samples to </span>
<span id="cb14-1190"><a href="#cb14-1190" aria-hidden="true" tabindex="-1"></a>normal like samples and several luminal B are misclassified as luminal A.</span>
<span id="cb14-1191"><a href="#cb14-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1192"><a href="#cb14-1192" aria-hidden="true" tabindex="-1"></a>The plot below shows the coloring by the reference PAM50 and the predicted</span>
<span id="cb14-1193"><a href="#cb14-1193" aria-hidden="true" tabindex="-1"></a>by AIMS.</span>
<span id="cb14-1194"><a href="#cb14-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1195"><a href="#cb14-1195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=7, fig.height=10}</span></span>
<span id="cb14-1196"><a href="#cb14-1196" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scanb-aims</span></span>
<span id="cb14-1197"><a href="#cb14-1197" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: SCANB embedding stratified by PAM50 algorithms by both the ones</span></span>
<span id="cb14-1198"><a href="#cb14-1198" aria-hidden="true" tabindex="-1"></a><span class="co">#|     provided by the SCANB (SSP) and the AIMS algorithm</span></span>
<span id="cb14-1199"><a href="#cb14-1199" aria-hidden="true" tabindex="-1"></a>df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1200"><a href="#cb14-1200" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1201"><a href="#cb14-1201" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-1202"><a href="#cb14-1202" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb14-1203"><a href="#cb14-1203" aria-hidden="true" tabindex="-1"></a>        scanb_coldata <span class="sc">%&gt;%</span></span>
<span id="cb14-1204"><a href="#cb14-1204" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(aims_pam50, sample_name),</span>
<span id="cb14-1205"><a href="#cb14-1205" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-1206"><a href="#cb14-1206" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1207"><a href="#cb14-1207" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-1208"><a href="#cb14-1208" aria-hidden="true" tabindex="-1"></a>        <span class="at">AIMS =</span> aims_pam50,</span>
<span id="cb14-1209"><a href="#cb14-1209" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">SSP SCANB</span><span class="st">`</span> <span class="ot">=</span> pam50</span>
<span id="cb14-1210"><a href="#cb14-1210" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1211"><a href="#cb14-1211" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-1212"><a href="#cb14-1212" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"AIMS"</span>, <span class="st">"SSP SCANB"</span>)),</span>
<span id="cb14-1213"><a href="#cb14-1213" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pam50_algo"</span>,</span>
<span id="cb14-1214"><a href="#cb14-1214" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"classes"</span></span>
<span id="cb14-1215"><a href="#cb14-1215" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1216"><a href="#cb14-1216" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">color =</span> classes)) <span class="sc">+</span></span>
<span id="cb14-1217"><a href="#cb14-1217" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-1218"><a href="#cb14-1218" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(classes<span class="sc">~</span>pam50_algo) <span class="sc">+</span></span>
<span id="cb14-1219"><a href="#cb14-1219" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1220"><a href="#cb14-1220" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span>,</span>
<span id="cb14-1221"><a href="#cb14-1221" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1222"><a href="#cb14-1222" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-1223"><a href="#cb14-1223" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(</span>
<span id="cb14-1224"><a href="#cb14-1224" aria-hidden="true" tabindex="-1"></a>        df_pca <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">%in%</span> scanb<span class="sc">$</span>pam50)</span>
<span id="cb14-1225"><a href="#cb14-1225" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-1226"><a href="#cb14-1226" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span> </span>
<span id="cb14-1227"><a href="#cb14-1227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-1228"><a href="#cb14-1228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1229"><a href="#cb14-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1230"><a href="#cb14-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1231"><a href="#cb14-1231" aria-hidden="true" tabindex="-1"></a>On the left there is the coloring for the AIMS algorithm and on the right</span>
<span id="cb14-1232"><a href="#cb14-1232" aria-hidden="true" tabindex="-1"></a>from the reference. We see the missclassified samples are not randomly</span>
<span id="cb14-1233"><a href="#cb14-1233" aria-hidden="true" tabindex="-1"></a>misclassified, they are on the boundaries. </span>
<span id="cb14-1234"><a href="#cb14-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1235"><a href="#cb14-1235" aria-hidden="true" tabindex="-1"></a>The plot below shows the maximum probability score for each sample</span>
<span id="cb14-1236"><a href="#cb14-1236" aria-hidden="true" tabindex="-1"></a>individually.</span>
<span id="cb14-1237"><a href="#cb14-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1238"><a href="#cb14-1238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=10, fig.width=4}</span></span>
<span id="cb14-1239"><a href="#cb14-1239" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb14-1240"><a href="#cb14-1240" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_prob =</span> <span class="fu">apply</span>(sbt_scanb_AIMS<span class="sc">$</span>subtype.proba, <span class="dv">1</span>, max),</span>
<span id="cb14-1241"><a href="#cb14-1241" aria-hidden="true" tabindex="-1"></a>    <span class="at">aims_pam50 =</span> sbt_scanb_AIMS<span class="sc">$</span>subtype <span class="sc">%&gt;%</span> as.vector</span>
<span id="cb14-1242"><a href="#cb14-1242" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1243"><a href="#cb14-1243" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> max_prob)) <span class="sc">+</span></span>
<span id="cb14-1244"><a href="#cb14-1244" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>) <span class="sc">+</span> </span>
<span id="cb14-1245"><a href="#cb14-1245" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>aims_pam50, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb14-1246"><a href="#cb14-1246" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb14-1247"><a href="#cb14-1247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1248"><a href="#cb14-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1249"><a href="#cb14-1249" aria-hidden="true" tabindex="-1"></a>The majority of samples have probabilities of either 1 or </span>
<span id="cb14-1250"><a href="#cb14-1250" aria-hidden="true" tabindex="-1"></a><span class="ss">0. </span>Not so often in between. </span>
<span id="cb14-1251"><a href="#cb14-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1252"><a href="#cb14-1252" aria-hidden="true" tabindex="-1"></a>And the figure below shows the confusion matrix for the ABIM cohort.</span>
<span id="cb14-1253"><a href="#cb14-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1256"><a href="#cb14-1256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1257"><a href="#cb14-1257" aria-hidden="true" tabindex="-1"></a>abim_coldata <span class="ot">&lt;-</span> <span class="fu">colData</span>(abim_100) <span class="sc">%&gt;%</span></span>
<span id="cb14-1258"><a href="#cb14-1258" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1259"><a href="#cb14-1259" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-1260"><a href="#cb14-1260" aria-hidden="true" tabindex="-1"></a>        <span class="at">aims_pam50 =</span> <span class="fu">factor</span>(<span class="fu">tolower</span>(aims_pam50), <span class="at">levels =</span> <span class="fu">unique</span>(pam50)),</span>
<span id="cb14-1261"><a href="#cb14-1261" aria-hidden="true" tabindex="-1"></a>        <span class="at">pam50 =</span> <span class="fu">factor</span>(pam50, <span class="at">levels =</span> <span class="fu">unique</span>(pam50))</span>
<span id="cb14-1262"><a href="#cb14-1262" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb14-1263"><a href="#cb14-1263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-1264"><a href="#cb14-1264" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(abim_coldata<span class="sc">$</span>aims_pam50, abim_coldata<span class="sc">$</span>pam50)</span>
<span id="cb14-1265"><a href="#cb14-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1266"><a href="#cb14-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1267"><a href="#cb14-1267" aria-hidden="true" tabindex="-1"></a>We see here that in this case that there are several luminal B samples </span>
<span id="cb14-1268"><a href="#cb14-1268" aria-hidden="true" tabindex="-1"></a>missclassified as luminal A. </span>
<span id="cb14-1269"><a href="#cb14-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1270"><a href="#cb14-1270" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=8, fig.height=10}</span></span>
<span id="cb14-1271"><a href="#cb14-1271" aria-hidden="true" tabindex="-1"></a>abim_100_df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1272"><a href="#cb14-1272" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"abim_100"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1273"><a href="#cb14-1273" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-1274"><a href="#cb14-1274" aria-hidden="true" tabindex="-1"></a>        ., </span>
<span id="cb14-1275"><a href="#cb14-1275" aria-hidden="true" tabindex="-1"></a>        abim_coldata <span class="sc">%&gt;%</span></span>
<span id="cb14-1276"><a href="#cb14-1276" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(aims_pam50, sample_name),</span>
<span id="cb14-1277"><a href="#cb14-1277" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-1278"><a href="#cb14-1278" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1279"><a href="#cb14-1279" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pam50_scanb =</span> pam50) <span class="sc">%&gt;%</span></span>
<span id="cb14-1280"><a href="#cb14-1280" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-1281"><a href="#cb14-1281" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(pam50_scanb, aims_pam50),</span>
<span id="cb14-1282"><a href="#cb14-1282" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pam50_algo"</span>,</span>
<span id="cb14-1283"><a href="#cb14-1283" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"classes"</span></span>
<span id="cb14-1284"><a href="#cb14-1284" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1285"><a href="#cb14-1285" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">color =</span> classes)) <span class="sc">+</span></span>
<span id="cb14-1286"><a href="#cb14-1286" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb14-1287"><a href="#cb14-1287" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(classes<span class="sc">~</span>pam50_algo) <span class="sc">+</span></span>
<span id="cb14-1288"><a href="#cb14-1288" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-1289"><a href="#cb14-1289" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">get_colors_pam50</span>(</span>
<span id="cb14-1290"><a href="#cb14-1290" aria-hidden="true" tabindex="-1"></a>        df_pca <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pam50 <span class="sc">%in%</span> scanb<span class="sc">$</span>pam50)</span>
<span id="cb14-1291"><a href="#cb14-1291" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-1292"><a href="#cb14-1292" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-1293"><a href="#cb14-1293" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1294"><a href="#cb14-1294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1295"><a href="#cb14-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1296"><a href="#cb14-1296" aria-hidden="true" tabindex="-1"></a>The misclassified samples from AIMS they really seem to be on the </span>
<span id="cb14-1297"><a href="#cb14-1297" aria-hidden="true" tabindex="-1"></a>top region together with the luminal A. Some of the normal</span>
<span id="cb14-1298"><a href="#cb14-1298" aria-hidden="true" tabindex="-1"></a>samples are even in the luminal A region. </span>
<span id="cb14-1299"><a href="#cb14-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1300"><a href="#cb14-1300" aria-hidden="true" tabindex="-1"></a>And another validation is using the normal cohort. Below is the number of</span>
<span id="cb14-1301"><a href="#cb14-1301" aria-hidden="true" tabindex="-1"></a>all predicted molecular subtypes.</span>
<span id="cb14-1302"><a href="#cb14-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1305"><a href="#cb14-1305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1306"><a href="#cb14-1306" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(normal_swiss<span class="sc">$</span>aims_pam50)</span>
<span id="cb14-1307"><a href="#cb14-1307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1308"><a href="#cb14-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1309"><a href="#cb14-1309" aria-hidden="true" tabindex="-1"></a>All samples are normal-like as expected, since they are normal. </span>
<span id="cb14-1310"><a href="#cb14-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1311"><a href="#cb14-1311" aria-hidden="true" tabindex="-1"></a><span class="fu">## nanostring signatures</span></span>
<span id="cb14-1312"><a href="#cb14-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1313"><a href="#cb14-1313" aria-hidden="true" tabindex="-1"></a>In this section we try the nanostring panel signatures provided by the</span>
<span id="cb14-1314"><a href="#cb14-1314" aria-hidden="true" tabindex="-1"></a>Breast Cancer 360 test. We will compare some of the signatures</span>
<span id="cb14-1315"><a href="#cb14-1315" aria-hidden="true" tabindex="-1"></a>by using GSVA on the original datasets and by calculating the sum of the</span>
<span id="cb14-1316"><a href="#cb14-1316" aria-hidden="true" tabindex="-1"></a>gene expression levels of the genes when regressing out the 1st, 2nd and</span>
<span id="cb14-1317"><a href="#cb14-1317" aria-hidden="true" tabindex="-1"></a>5th components.</span>
<span id="cb14-1318"><a href="#cb14-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1319"><a href="#cb14-1319" aria-hidden="true" tabindex="-1"></a>The table below shows the number of genes available for each signature</span>
<span id="cb14-1320"><a href="#cb14-1320" aria-hidden="true" tabindex="-1"></a>and each dataset. In general it seems that all signatures have over</span>
<span id="cb14-1321"><a href="#cb14-1321" aria-hidden="true" tabindex="-1"></a>70% of the genes available, a good indication.</span>
<span id="cb14-1322"><a href="#cb14-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1325"><a href="#cb14-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1326"><a href="#cb14-1326" aria-hidden="true" tabindex="-1"></a>nanostring_panel <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(</span>
<span id="cb14-1327"><a href="#cb14-1327" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../data/nanostring_panel.xlsx"</span>,</span>
<span id="cb14-1328"><a href="#cb14-1328" aria-hidden="true" tabindex="-1"></a>    <span class="at">sheet =</span> <span class="st">"Annotations"</span>, </span>
<span id="cb14-1329"><a href="#cb14-1329" aria-hidden="true" tabindex="-1"></a>    <span class="at">skip =</span> <span class="dv">1</span></span>
<span id="cb14-1330"><a href="#cb14-1330" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1331"><a href="#cb14-1331" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"Cell Type"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb14-1332"><a href="#cb14-1332" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb14-1333"><a href="#cb14-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1334"><a href="#cb14-1334" aria-hidden="true" tabindex="-1"></a>gene_sets_nanostring <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb14-1335"><a href="#cb14-1335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(nanostring_panel)[<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(nanostring_panel)], </span>
<span id="cb14-1336"><a href="#cb14-1336" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(signature){</span>
<span id="cb14-1337"><a href="#cb14-1337" aria-hidden="true" tabindex="-1"></a>        nanostring_panel <span class="sc">%&gt;%</span></span>
<span id="cb14-1338"><a href="#cb14-1338" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(signature) <span class="sc">==</span> <span class="st">"+"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1339"><a href="#cb14-1339" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">pull</span>(gene)</span>
<span id="cb14-1340"><a href="#cb14-1340" aria-hidden="true" tabindex="-1"></a>    }, </span>
<span id="cb14-1341"><a href="#cb14-1341" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>, </span>
<span id="cb14-1342"><a href="#cb14-1342" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb14-1343"><a href="#cb14-1343" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1344"><a href="#cb14-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1345"><a href="#cb14-1345" aria-hidden="true" tabindex="-1"></a>genes_each_dataset <span class="ot">&lt;-</span> <span class="fu">lapply</span>(datasets, rownames)</span>
<span id="cb14-1346"><a href="#cb14-1346" aria-hidden="true" tabindex="-1"></a>genes_intersection <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb14-1347"><a href="#cb14-1347" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(gene_sets_nanostring),</span>
<span id="cb14-1348"><a href="#cb14-1348" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(set_name, gene_sets, genes_each_dataset){</span>
<span id="cb14-1349"><a href="#cb14-1349" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(</span>
<span id="cb14-1350"><a href="#cb14-1350" aria-hidden="true" tabindex="-1"></a>            genes_each_dataset,</span>
<span id="cb14-1351"><a href="#cb14-1351" aria-hidden="true" tabindex="-1"></a>            intersect,</span>
<span id="cb14-1352"><a href="#cb14-1352" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> gene_sets[[set_name]]</span>
<span id="cb14-1353"><a href="#cb14-1353" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1354"><a href="#cb14-1354" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-1355"><a href="#cb14-1355" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_sets =</span> gene_sets_nanostring,</span>
<span id="cb14-1356"><a href="#cb14-1356" aria-hidden="true" tabindex="-1"></a>    <span class="at">genes_each_dataset =</span> genes_each_dataset,</span>
<span id="cb14-1357"><a href="#cb14-1357" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-1358"><a href="#cb14-1358" aria-hidden="true" tabindex="-1"></a>    <span class="at">simplify =</span> <span class="cn">FALSE</span></span>
<span id="cb14-1359"><a href="#cb14-1359" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1360"><a href="#cb14-1360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1361"><a href="#cb14-1361" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(genes_intersection, <span class="cf">function</span>(x) <span class="fu">sapply</span>(x, length)) <span class="sc">%&gt;%</span> t <span class="sc">%&gt;%</span></span>
<span id="cb14-1362"><a href="#cb14-1362" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1363"><a href="#cb14-1363" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"pathway"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1364"><a href="#cb14-1364" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-1365"><a href="#cb14-1365" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-1366"><a href="#cb14-1366" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(gene_sets_nanostring, data.frame) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1367"><a href="#cb14-1367" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"gs_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1368"><a href="#cb14-1368" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(gs_name) <span class="sc">%&gt;%</span></span>
<span id="cb14-1369"><a href="#cb14-1369" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-1370"><a href="#cb14-1370" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">pathway =</span> gs_name),</span>
<span id="cb14-1371"><a href="#cb14-1371" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"pathway"</span></span>
<span id="cb14-1372"><a href="#cb14-1372" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1373"><a href="#cb14-1373" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-1374"><a href="#cb14-1374" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">average_percentage =</span> <span class="fu">format</span>(<span class="fu">mean</span>(</span>
<span id="cb14-1375"><a href="#cb14-1375" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(tcga<span class="sc">/</span>n, scanb<span class="sc">/</span>n, metabric<span class="sc">/</span>n, poetic<span class="sc">/</span>n)</span>
<span id="cb14-1376"><a href="#cb14-1376" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb14-1377"><a href="#cb14-1377" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb14-1378"><a href="#cb14-1378" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1379"><a href="#cb14-1379" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-1380"><a href="#cb14-1380" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_classic</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-1381"><a href="#cb14-1381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1382"><a href="#cb14-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1383"><a href="#cb14-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = first_run}</span></span>
<span id="cb14-1384"><a href="#cb14-1384" aria-hidden="true" tabindex="-1"></a>gsva_scores_nanostring <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb14-1385"><a href="#cb14-1385" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(sum_exp, which_assay, gene_sets){</span>
<span id="cb14-1386"><a href="#cb14-1386" aria-hidden="true" tabindex="-1"></a>        GSVA<span class="sc">::</span><span class="fu">gsva</span>(</span>
<span id="cb14-1387"><a href="#cb14-1387" aria-hidden="true" tabindex="-1"></a>            <span class="at">expr =</span> <span class="fu">as.matrix</span>(<span class="fu">assay</span>(sum_exp, which_assay)),</span>
<span id="cb14-1388"><a href="#cb14-1388" aria-hidden="true" tabindex="-1"></a>            <span class="at">gset.idx.list =</span> gene_sets, </span>
<span id="cb14-1389"><a href="#cb14-1389" aria-hidden="true" tabindex="-1"></a>            <span class="at">parallel.sz =</span> <span class="dv">10</span>,</span>
<span id="cb14-1390"><a href="#cb14-1390" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb14-1391"><a href="#cb14-1391" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1392"><a href="#cb14-1392" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-1393"><a href="#cb14-1393" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_exp =</span> datasets,</span>
<span id="cb14-1394"><a href="#cb14-1394" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_assay =</span> <span class="fu">c</span>(which_exp, <span class="st">"poetic"</span> <span class="ot">=</span> <span class="st">"normalized_intensity"</span>),</span>
<span id="cb14-1395"><a href="#cb14-1395" aria-hidden="true" tabindex="-1"></a>    <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">gene_sets =</span> gene_sets_nanostring),</span>
<span id="cb14-1396"><a href="#cb14-1396" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-1397"><a href="#cb14-1397" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span></span>
<span id="cb14-1398"><a href="#cb14-1398" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1399"><a href="#cb14-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1400"><a href="#cb14-1400" aria-hidden="true" tabindex="-1"></a>datasets_nanostring <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb14-1401"><a href="#cb14-1401" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(gsva_score, dataset){</span>
<span id="cb14-1402"><a href="#cb14-1402" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colData</span>(dataset)[, <span class="fu">rownames</span>(gsva_score)] <span class="ot">&lt;-</span> <span class="fu">t</span>(gsva_score)</span>
<span id="cb14-1403"><a href="#cb14-1403" aria-hidden="true" tabindex="-1"></a>        dataset</span>
<span id="cb14-1404"><a href="#cb14-1404" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-1405"><a href="#cb14-1405" aria-hidden="true" tabindex="-1"></a>    gsva_scores_nanostring,</span>
<span id="cb14-1406"><a href="#cb14-1406" aria-hidden="true" tabindex="-1"></a>    datasets,</span>
<span id="cb14-1407"><a href="#cb14-1407" aria-hidden="true" tabindex="-1"></a>    <span class="at">USE.NAMES =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-1408"><a href="#cb14-1408" aria-hidden="true" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb14-1409"><a href="#cb14-1409" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1410"><a href="#cb14-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1411"><a href="#cb14-1411" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb14-1412"><a href="#cb14-1412" aria-hidden="true" tabindex="-1"></a>    gene_sets_nanostring,</span>
<span id="cb14-1413"><a href="#cb14-1413" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(gene_set, df_pcs_regressed){</span>
<span id="cb14-1414"><a href="#cb14-1414" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-1415"><a href="#cb14-1415" aria-hidden="true" tabindex="-1"></a>        gene_set <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb14-1416"><a href="#cb14-1416" aria-hidden="true" tabindex="-1"></a>            gene_set,</span>
<span id="cb14-1417"><a href="#cb14-1417" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rownames</span>(df_pcs_regressed)</span>
<span id="cb14-1418"><a href="#cb14-1418" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1419"><a href="#cb14-1419" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colSums</span>(df_pcs_regressed[gene_set, ])</span>
<span id="cb14-1420"><a href="#cb14-1420" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-1421"><a href="#cb14-1421" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-1422"><a href="#cb14-1422" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pcs_regressed =</span> df_pcs_regressed</span>
<span id="cb14-1423"><a href="#cb14-1423" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1424"><a href="#cb14-1424" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1425"><a href="#cb14-1425" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>)</span>
<span id="cb14-1426"><a href="#cb14-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1427"><a href="#cb14-1427" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-1428"><a href="#cb14-1428" aria-hidden="true" tabindex="-1"></a>    scores_nanostring,</span>
<span id="cb14-1429"><a href="#cb14-1429" aria-hidden="true" tabindex="-1"></a>    df_pca,</span>
<span id="cb14-1430"><a href="#cb14-1430" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>)</span>
<span id="cb14-1431"><a href="#cb14-1431" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1432"><a href="#cb14-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1433"><a href="#cb14-1433" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(scores_nanostring) <span class="ot">&lt;-</span> scores_nanostring<span class="sc">$</span>sample_name</span>
<span id="cb14-1434"><a href="#cb14-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1435"><a href="#cb14-1435" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb14-1436"><a href="#cb14-1436" aria-hidden="true" tabindex="-1"></a>    scores_nanostring,</span>
<span id="cb14-1437"><a href="#cb14-1437" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/trying/scores_nanostring_only.rds"</span></span>
<span id="cb14-1438"><a href="#cb14-1438" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1439"><a href="#cb14-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1440"><a href="#cb14-1440" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb14-1441"><a href="#cb14-1441" aria-hidden="true" tabindex="-1"></a>    gsva_scores_nanostring, </span>
<span id="cb14-1442"><a href="#cb14-1442" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/trying/gsva_scores_nanostring.rds"</span></span>
<span id="cb14-1443"><a href="#cb14-1443" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1444"><a href="#cb14-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1445"><a href="#cb14-1445" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb14-1446"><a href="#cb14-1446" aria-hidden="true" tabindex="-1"></a>    datasets_nanostring,</span>
<span id="cb14-1447"><a href="#cb14-1447" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/trying/datasets_with_scores_nanostring.rds"</span></span>
<span id="cb14-1448"><a href="#cb14-1448" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1449"><a href="#cb14-1449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1450"><a href="#cb14-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1451"><a href="#cb14-1451" aria-hidden="true" tabindex="-1"></a>We now compare the scores obtained by GSVA on the datasets and </span>
<span id="cb14-1452"><a href="#cb14-1452" aria-hidden="true" tabindex="-1"></a>see how they relate with nanostring scores obtained with the</span>
<span id="cb14-1453"><a href="#cb14-1453" aria-hidden="true" tabindex="-1"></a>regressed data. </span>
<span id="cb14-1454"><a href="#cb14-1454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1455"><a href="#cb14-1455" aria-hidden="true" tabindex="-1"></a>First we compare GSVA SET ER/PR with ER signaling obtained by the</span>
<span id="cb14-1456"><a href="#cb14-1456" aria-hidden="true" tabindex="-1"></a>scoring procedure when regressing the data.</span>
<span id="cb14-1457"><a href="#cb14-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1460"><a href="#cb14-1460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1461"><a href="#cb14-1461" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="sc">%&gt;%</span></span>
<span id="cb14-1462"><a href="#cb14-1462" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb14-1463"><a href="#cb14-1463" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb14-1464"><a href="#cb14-1464" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> er_signaling, </span>
<span id="cb14-1465"><a href="#cb14-1465" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> SET_ERPR,</span>
<span id="cb14-1466"><a href="#cb14-1466" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> pam50</span>
<span id="cb14-1467"><a href="#cb14-1467" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1468"><a href="#cb14-1468" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-1469"><a href="#cb14-1469" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-1470"><a href="#cb14-1470" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1471"><a href="#cb14-1471" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>cohort)</span>
<span id="cb14-1472"><a href="#cb14-1472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1473"><a href="#cb14-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1474"><a href="#cb14-1474" aria-hidden="true" tabindex="-1"></a>Next we compare EMT, G2M with proliferation and PI3K signaling. </span>
<span id="cb14-1475"><a href="#cb14-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1478"><a href="#cb14-1478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1479"><a href="#cb14-1479" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="sc">%&gt;%</span></span>
<span id="cb14-1480"><a href="#cb14-1480" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb14-1481"><a href="#cb14-1481" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb14-1482"><a href="#cb14-1482" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> emt, </span>
<span id="cb14-1483"><a href="#cb14-1483" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION,</span>
<span id="cb14-1484"><a href="#cb14-1484" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> pam50</span>
<span id="cb14-1485"><a href="#cb14-1485" aria-hidden="true" tabindex="-1"></a>        )) <span class="sc">+</span></span>
<span id="cb14-1486"><a href="#cb14-1486" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-1487"><a href="#cb14-1487" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1488"><a href="#cb14-1488" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>cohort)</span>
<span id="cb14-1489"><a href="#cb14-1489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1490"><a href="#cb14-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1493"><a href="#cb14-1493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1494"><a href="#cb14-1494" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="sc">%&gt;%</span></span>
<span id="cb14-1495"><a href="#cb14-1495" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> proliferation, <span class="at">y =</span> HALLMARK_G2M_CHECKPOINT,</span>
<span id="cb14-1496"><a href="#cb14-1496" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> pam50)) <span class="sc">+</span></span>
<span id="cb14-1497"><a href="#cb14-1497" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-1498"><a href="#cb14-1498" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1499"><a href="#cb14-1499" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>cohort)</span>
<span id="cb14-1500"><a href="#cb14-1500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1501"><a href="#cb14-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1504"><a href="#cb14-1504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1505"><a href="#cb14-1505" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="sc">%&gt;%</span></span>
<span id="cb14-1506"><a href="#cb14-1506" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pi3k, <span class="at">y =</span> HALLMARK_PI3K_AKT_MTOR_SIGNALING,</span>
<span id="cb14-1507"><a href="#cb14-1507" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> pam50)) <span class="sc">+</span></span>
<span id="cb14-1508"><a href="#cb14-1508" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-1509"><a href="#cb14-1509" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1510"><a href="#cb14-1510" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>cohort)</span>
<span id="cb14-1511"><a href="#cb14-1511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1512"><a href="#cb14-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1515"><a href="#cb14-1515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1516"><a href="#cb14-1516" aria-hidden="true" tabindex="-1"></a>scores_nanostring <span class="sc">%&gt;%</span></span>
<span id="cb14-1517"><a href="#cb14-1517" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pam50, <span class="at">y =</span> proliferation, <span class="at">color =</span> pam50)) <span class="sc">+</span></span>
<span id="cb14-1518"><a href="#cb14-1518" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb14-1519"><a href="#cb14-1519" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1520"><a href="#cb14-1520" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>cohort)</span>
<span id="cb14-1521"><a href="#cb14-1521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1522"><a href="#cb14-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1523"><a href="#cb14-1523" aria-hidden="true" tabindex="-1"></a>In general there is a correlation but the scores are not so well correlated</span>
<span id="cb14-1524"><a href="#cb14-1524" aria-hidden="true" tabindex="-1"></a>and they are noisy. One that works fairly well is the ER signaling score,</span>
<span id="cb14-1525"><a href="#cb14-1525" aria-hidden="true" tabindex="-1"></a>but the others not so well. The proliferation score barely shows any</span>
<span id="cb14-1526"><a href="#cb14-1526" aria-hidden="true" tabindex="-1"></a>difference between luminal A and B patients in any of the cohorts. </span>
<span id="cb14-1527"><a href="#cb14-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1528"><a href="#cb14-1528" aria-hidden="true" tabindex="-1"></a>Perhaps if we calculate the scores using the hallmarks pathways the scores are</span>
<span id="cb14-1529"><a href="#cb14-1529" aria-hidden="true" tabindex="-1"></a>better correlated, since they are the same gene sets.</span>
<span id="cb14-1530"><a href="#cb14-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1531"><a href="#cb14-1531" aria-hidden="true" tabindex="-1"></a>Below we plot the correlation between the proliferation pathway using GSVA and</span>
<span id="cb14-1532"><a href="#cb14-1532" aria-hidden="true" tabindex="-1"></a>the regressed scoring strategy for the TCGA cohort.</span>
<span id="cb14-1533"><a href="#cb14-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1536"><a href="#cb14-1536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1537"><a href="#cb14-1537" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb14-1538"><a href="#cb14-1538" aria-hidden="true" tabindex="-1"></a>    datasets_nanostring<span class="sc">$</span>tcga<span class="sc">$</span>proliferation,</span>
<span id="cb14-1539"><a href="#cb14-1539" aria-hidden="true" tabindex="-1"></a>    scores_nanostring[<span class="fu">colnames</span>(datasets_nanostring<span class="sc">$</span>tcga), <span class="st">"proliferation"</span>]</span>
<span id="cb14-1540"><a href="#cb14-1540" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1541"><a href="#cb14-1541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1542"><a href="#cb14-1542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1543"><a href="#cb14-1543" aria-hidden="true" tabindex="-1"></a>It is perfectly correlated.</span>
<span id="cb14-1544"><a href="#cb14-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1545"><a href="#cb14-1545" aria-hidden="true" tabindex="-1"></a>And for ER signaling:</span>
<span id="cb14-1546"><a href="#cb14-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1549"><a href="#cb14-1549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1550"><a href="#cb14-1550" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb14-1551"><a href="#cb14-1551" aria-hidden="true" tabindex="-1"></a>    datasets_nanostring<span class="sc">$</span>tcga<span class="sc">$</span>er_signaling,</span>
<span id="cb14-1552"><a href="#cb14-1552" aria-hidden="true" tabindex="-1"></a>    scores_nanostring[<span class="fu">colnames</span>(datasets_nanostring<span class="sc">$</span>tcga), <span class="st">"er_signaling"</span>]</span>
<span id="cb14-1553"><a href="#cb14-1553" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1554"><a href="#cb14-1554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1555"><a href="#cb14-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1556"><a href="#cb14-1556" aria-hidden="true" tabindex="-1"></a>Also it is very much correlated. So the problem in the end is comparing</span>
<span id="cb14-1557"><a href="#cb14-1557" aria-hidden="true" tabindex="-1"></a>the hallmarks signatures with the nanostring. But interestingly </span>
<span id="cb14-1558"><a href="#cb14-1558" aria-hidden="true" tabindex="-1"></a>the nanostring proliferation signature was not good to pick up the differences</span>
<span id="cb14-1559"><a href="#cb14-1559" aria-hidden="true" tabindex="-1"></a>between luminal A and B.</span>
<span id="cb14-1560"><a href="#cb14-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1563"><a href="#cb14-1563" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1564"><a href="#cb14-1564" aria-hidden="true" tabindex="-1"></a>datasets_nanostring<span class="sc">$</span>tcga <span class="sc">%&gt;%</span></span>
<span id="cb14-1565"><a href="#cb14-1565" aria-hidden="true" tabindex="-1"></a>    colData <span class="sc">%&gt;%</span></span>
<span id="cb14-1566"><a href="#cb14-1566" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1567"><a href="#cb14-1567" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-1568"><a href="#cb14-1568" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"proliferation"</span>, <span class="st">"HALLMARK_G2M_CHECKPOINT"</span>),</span>
<span id="cb14-1569"><a href="#cb14-1569" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-1570"><a href="#cb14-1570" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb14-1571"><a href="#cb14-1571" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1572"><a href="#cb14-1572" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pam50, <span class="at">y =</span> score, <span class="at">color =</span> pam50)) <span class="sc">+</span> </span>
<span id="cb14-1573"><a href="#cb14-1573" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb14-1574"><a href="#cb14-1574" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb14-1575"><a href="#cb14-1575" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb14-1576"><a href="#cb14-1576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1577"><a href="#cb14-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1578"><a href="#cb14-1578" aria-hidden="true" tabindex="-1"></a><span class="fu">## Risk stratification and the molecular landscape</span></span>
<span id="cb14-1579"><a href="#cb14-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1580"><a href="#cb14-1580" aria-hidden="true" tabindex="-1"></a>One common problem in the clinics is what to do with patients that are </span>
<span id="cb14-1581"><a href="#cb14-1581" aria-hidden="true" tabindex="-1"></a>in the so called intermediate risk group. Here we use the SSP </span>
<span id="cb14-1582"><a href="#cb14-1582" aria-hidden="true" tabindex="-1"></a>classification from the SCANB team to check what is the position of these</span>
<span id="cb14-1583"><a href="#cb14-1583" aria-hidden="true" tabindex="-1"></a>patients in the molecular landscape.</span>
<span id="cb14-1584"><a href="#cb14-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1587"><a href="#cb14-1587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1588"><a href="#cb14-1588" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scanb-risk-embedding</span></span>
<span id="cb14-1589"><a href="#cb14-1589" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of the SCANB samples colored by their predicted</span></span>
<span id="cb14-1590"><a href="#cb14-1590" aria-hidden="true" tabindex="-1"></a><span class="co">#|     ROR risk category.</span></span>
<span id="cb14-1591"><a href="#cb14-1591" aria-hidden="true" tabindex="-1"></a>df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1592"><a href="#cb14-1592" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(SSP.ROR.risk.cat)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1593"><a href="#cb14-1593" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1594"><a href="#cb14-1594" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sample_name =</span> <span class="fu">factor</span>(sample_name)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1595"><a href="#cb14-1595" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">color =</span> SSP.ROR.risk.cat)) <span class="sc">+</span></span>
<span id="cb14-1596"><a href="#cb14-1596" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb14-1597"><a href="#cb14-1597" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"H"</span>) <span class="sc">+</span> </span>
<span id="cb14-1598"><a href="#cb14-1598" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb14-1599"><a href="#cb14-1599" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-1600"><a href="#cb14-1600" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1601"><a href="#cb14-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1602"><a href="#cb14-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1603"><a href="#cb14-1603" aria-hidden="true" tabindex="-1"></a>@fig-scanb-risk-embedding shows that the embedding detects the positions</span>
<span id="cb14-1604"><a href="#cb14-1604" aria-hidden="true" tabindex="-1"></a>where the intermediate risk patients are, namely they are in the</span>
<span id="cb14-1605"><a href="#cb14-1605" aria-hidden="true" tabindex="-1"></a>intersection of the luminal A and B subtypes.</span>
<span id="cb14-1606"><a href="#cb14-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1607"><a href="#cb14-1607" aria-hidden="true" tabindex="-1"></a>And @fig-intermediate-pca-position below shows that there is a shift in</span>
<span id="cb14-1608"><a href="#cb14-1608" aria-hidden="true" tabindex="-1"></a>PC4 for the intermediate to the high risk group, which makes sense as this is</span>
<span id="cb14-1609"><a href="#cb14-1609" aria-hidden="true" tabindex="-1"></a>exactly where the distinction between luminal A and B are.</span>
<span id="cb14-1610"><a href="#cb14-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1611"><a href="#cb14-1611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height=4, fig.width=8}</span></span>
<span id="cb14-1612"><a href="#cb14-1612" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-intermediate-pca-position</span></span>
<span id="cb14-1613"><a href="#cb14-1613" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Distribution of the principal components for the different</span></span>
<span id="cb14-1614"><a href="#cb14-1614" aria-hidden="true" tabindex="-1"></a><span class="co">#|     risk groups defined by the SSP ROR scores.</span></span>
<span id="cb14-1615"><a href="#cb14-1615" aria-hidden="true" tabindex="-1"></a>df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1616"><a href="#cb14-1616" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(SSP.ROR.risk.cat)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1617"><a href="#cb14-1617" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-1618"><a href="#cb14-1618" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(PC3, PC4), </span>
<span id="cb14-1619"><a href="#cb14-1619" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pcs"</span>, </span>
<span id="cb14-1620"><a href="#cb14-1620" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"pc_scores"</span></span>
<span id="cb14-1621"><a href="#cb14-1621" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1622"><a href="#cb14-1622" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> SSP.ROR.risk.cat, <span class="at">x =</span> pc_scores, <span class="at">color =</span> SSP.ROR.risk.cat)) <span class="sc">+</span></span>
<span id="cb14-1623"><a href="#cb14-1623" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb14-1624"><a href="#cb14-1624" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb14-1625"><a href="#cb14-1625" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pcs) <span class="sc">+</span></span>
<span id="cb14-1626"><a href="#cb14-1626" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"H"</span>) <span class="sc">+</span></span>
<span id="cb14-1627"><a href="#cb14-1627" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"PC"</span>) <span class="sc">+</span> </span>
<span id="cb14-1628"><a href="#cb14-1628" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-1629"><a href="#cb14-1629" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span> </span>
<span id="cb14-1630"><a href="#cb14-1630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-1631"><a href="#cb14-1631" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1632"><a href="#cb14-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1633"><a href="#cb14-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1634"><a href="#cb14-1634" aria-hidden="true" tabindex="-1"></a><span class="fu">## Late distant recurrence: trying to find biomarkers</span></span>
<span id="cb14-1635"><a href="#cb14-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1636"><a href="#cb14-1636" aria-hidden="true" tabindex="-1"></a>One of the key problems in breast cancer research is finding patients that</span>
<span id="cb14-1637"><a href="#cb14-1637" aria-hidden="true" tabindex="-1"></a>will develop late recurrence. Here we use METABRIC as it has a long follow-up</span>
<span id="cb14-1638"><a href="#cb14-1638" aria-hidden="true" tabindex="-1"></a>history. We start by plotting the embedding of all METABRIC patients that</span>
<span id="cb14-1639"><a href="#cb14-1639" aria-hidden="true" tabindex="-1"></a>had a followup longer than 10 years and received only ET. We then try to </span>
<span id="cb14-1640"><a href="#cb14-1640" aria-hidden="true" tabindex="-1"></a>predict which patients recurr or not based on the molecular data by</span>
<span id="cb14-1641"><a href="#cb14-1641" aria-hidden="true" tabindex="-1"></a>using lasso regression. For this we use the package <span class="in">`glmnet`</span> that </span>
<span id="cb14-1642"><a href="#cb14-1642" aria-hidden="true" tabindex="-1"></a>provides such functionality. </span>
<span id="cb14-1643"><a href="#cb14-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1646"><a href="#cb14-1646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1647"><a href="#cb14-1647" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">get_base_plot</span>(</span>
<span id="cb14-1648"><a href="#cb14-1648" aria-hidden="true" tabindex="-1"></a>    df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb14-1649"><a href="#cb14-1649" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">!=</span> <span class="st">"poetic"</span>) </span>
<span id="cb14-1650"><a href="#cb14-1650" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb14-1651"><a href="#cb14-1651" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb14-1652"><a href="#cb14-1652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1653"><a href="#cb14-1653" aria-hidden="true" tabindex="-1"></a>et_metabric_late_data <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1654"><a href="#cb14-1654" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-1655"><a href="#cb14-1655" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"metabric"</span> <span class="sc">&amp;</span></span>
<span id="cb14-1656"><a href="#cb14-1656" aria-hidden="true" tabindex="-1"></a>            rfs_months <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">*</span> <span class="dv">12</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1657"><a href="#cb14-1657" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.numeric</span>(rfs_status) <span class="sc">&amp;</span> </span>
<span id="cb14-1658"><a href="#cb14-1658" aria-hidden="true" tabindex="-1"></a>            HORMONE_THERAPY <span class="sc">==</span> <span class="st">"YES"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1659"><a href="#cb14-1659" aria-hidden="true" tabindex="-1"></a>            er_status <span class="sc">==</span> <span class="st">"pos"</span></span>
<span id="cb14-1660"><a href="#cb14-1660" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1661"><a href="#cb14-1661" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_there_recurrence =</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-1662"><a href="#cb14-1662" aria-hidden="true" tabindex="-1"></a>        rfs_status <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb14-1663"><a href="#cb14-1663" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yes"</span>,</span>
<span id="cb14-1664"><a href="#cb14-1664" aria-hidden="true" tabindex="-1"></a>        <span class="st">"no"</span></span>
<span id="cb14-1665"><a href="#cb14-1665" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-1666"><a href="#cb14-1666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1667"><a href="#cb14-1667" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb14-1668"><a href="#cb14-1668" aria-hidden="true" tabindex="-1"></a>    et_metabric_late_data,</span>
<span id="cb14-1669"><a href="#cb14-1669" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb14-1670"><a href="#cb14-1670" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> PC3, </span>
<span id="cb14-1671"><a href="#cb14-1671" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> PC4, </span>
<span id="cb14-1672"><a href="#cb14-1672" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> is_there_recurrence, </span>
<span id="cb14-1673"><a href="#cb14-1673" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> is_there_recurrence</span>
<span id="cb14-1674"><a href="#cb14-1674" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-1675"><a href="#cb14-1675" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb14-1676"><a href="#cb14-1676" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb14-1677"><a href="#cb14-1677" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb14-1678"><a href="#cb14-1678" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb14-1679"><a href="#cb14-1679" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1680"><a href="#cb14-1680" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-1681"><a href="#cb14-1681" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1682"><a href="#cb14-1682" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb14-1683"><a href="#cb14-1683" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"ER+ BC, ET only, over 10 years of RFS follow-up"</span>,</span>
<span id="cb14-1684"><a href="#cb14-1684" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Recurrence?"</span>,</span>
<span id="cb14-1685"><a href="#cb14-1685" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> <span class="st">"Recurrence?"</span></span>
<span id="cb14-1686"><a href="#cb14-1686" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-1687"><a href="#cb14-1687" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_cartesian</span>(</span>
<span id="cb14-1688"><a href="#cb14-1688" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(df_pca<span class="sc">$</span>PC3), <span class="fu">max</span>(df_pca<span class="sc">$</span>PC3)),</span>
<span id="cb14-1689"><a href="#cb14-1689" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(df_pca<span class="sc">$</span>PC4), <span class="fu">max</span>(df_pca<span class="sc">$</span>PC4))</span>
<span id="cb14-1690"><a href="#cb14-1690" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1691"><a href="#cb14-1691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-1692"><a href="#cb14-1692" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1693"><a href="#cb14-1693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1694"><a href="#cb14-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1695"><a href="#cb14-1695" aria-hidden="true" tabindex="-1"></a>In general there is no distinction in terms of the molecular</span>
<span id="cb14-1696"><a href="#cb14-1696" aria-hidden="true" tabindex="-1"></a>landscape among the patients that recurred, both in terms of</span>
<span id="cb14-1697"><a href="#cb14-1697" aria-hidden="true" tabindex="-1"></a>molecular subtype and position in the molecular landscape. </span>
<span id="cb14-1698"><a href="#cb14-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1699"><a href="#cb14-1699" aria-hidden="true" tabindex="-1"></a>We now compare their molecular scores. </span>
<span id="cb14-1700"><a href="#cb14-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1701"><a href="#cb14-1701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=20, fig.height=40}</span></span>
<span id="cb14-1702"><a href="#cb14-1702" aria-hidden="true" tabindex="-1"></a>pathways_to_compare <span class="ot">&lt;-</span> <span class="fu">colnames</span>(df_pca)[<span class="fu">grepl</span>(<span class="st">"^HALLMARK"</span>, <span class="fu">colnames</span>(df_pca))]</span>
<span id="cb14-1703"><a href="#cb14-1703" aria-hidden="true" tabindex="-1"></a>et_metabric_late_data <span class="sc">%&gt;%</span></span>
<span id="cb14-1704"><a href="#cb14-1704" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-1705"><a href="#cb14-1705" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(pathways_to_compare),</span>
<span id="cb14-1706"><a href="#cb14-1706" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-1707"><a href="#cb14-1707" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb14-1708"><a href="#cb14-1708" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1709"><a href="#cb14-1709" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_there_recurrence, <span class="at">y =</span> score)) <span class="sc">+</span> </span>
<span id="cb14-1710"><a href="#cb14-1710" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb14-1711"><a href="#cb14-1711" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb14-1712"><a href="#cb14-1712" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(</span>
<span id="cb14-1713"><a href="#cb14-1713" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span>pathway, </span>
<span id="cb14-1714"><a href="#cb14-1714" aria-hidden="true" tabindex="-1"></a>        <span class="at">ncol =</span> <span class="dv">5</span>,</span>
<span id="cb14-1715"><a href="#cb14-1715" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> <span class="fu">as_labeller</span>(</span>
<span id="cb14-1716"><a href="#cb14-1716" aria-hidden="true" tabindex="-1"></a>            stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(pathways_to_compare, <span class="st">"^HALLMARK_"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1717"><a href="#cb14-1717" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(pathways_to_compare)</span>
<span id="cb14-1718"><a href="#cb14-1718" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1719"><a href="#cb14-1719" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1720"><a href="#cb14-1720" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1721"><a href="#cb14-1721" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Recurrence?"</span>,</span>
<span id="cb14-1722"><a href="#cb14-1722" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"METABRIC"</span>,</span>
<span id="cb14-1723"><a href="#cb14-1723" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"ER+ BC, ET only, over 10 years of RFS follow-up"</span>    </span>
<span id="cb14-1724"><a href="#cb14-1724" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1725"><a href="#cb14-1725" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span>
<span id="cb14-1726"><a href="#cb14-1726" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1727"><a href="#cb14-1727" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb14-1728"><a href="#cb14-1728" aria-hidden="true" tabindex="-1"></a>Even here we don't see much difference. Unless there is some kind of </span>
<span id="cb14-1729"><a href="#cb14-1729" aria-hidden="true" tabindex="-1"></a>linear combination of pathways, I don't think it would be possible</span>
<span id="cb14-1730"><a href="#cb14-1730" aria-hidden="true" tabindex="-1"></a>to classify these two groups by using only transcriptomic data</span>
<span id="cb14-1731"><a href="#cb14-1731" aria-hidden="true" tabindex="-1"></a>and these pathways. In any case we proceed now with the </span>
<span id="cb14-1732"><a href="#cb14-1732" aria-hidden="true" tabindex="-1"></a>lasso regression using the 50 pathways. </span>
<span id="cb14-1733"><a href="#cb14-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1736"><a href="#cb14-1736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1737"><a href="#cb14-1737" aria-hidden="true" tabindex="-1"></a>fit_recurrence <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">cv.glmnet</span>(</span>
<span id="cb14-1738"><a href="#cb14-1738" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">as.matrix</span>(et_metabric_late_data[, pathways_to_compare]),</span>
<span id="cb14-1739"><a href="#cb14-1739" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> et_metabric_late_data<span class="sc">$</span>is_there_recurrence,</span>
<span id="cb14-1740"><a href="#cb14-1740" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb14-1741"><a href="#cb14-1741" aria-hidden="true" tabindex="-1"></a>    <span class="at">type.measure =</span> <span class="st">"class"</span></span>
<span id="cb14-1742"><a href="#cb14-1742" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1743"><a href="#cb14-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1744"><a href="#cb14-1744" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_recurrence)</span>
<span id="cb14-1745"><a href="#cb14-1745" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1746"><a href="#cb14-1746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1747"><a href="#cb14-1747" aria-hidden="true" tabindex="-1"></a>We see that actually it does not work. And when we predict all the </span>
<span id="cb14-1748"><a href="#cb14-1748" aria-hidden="true" tabindex="-1"></a>samples are predicted as there is no recurrence.</span>
<span id="cb14-1749"><a href="#cb14-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1752"><a href="#cb14-1752" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1753"><a href="#cb14-1753" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(</span>
<span id="cb14-1754"><a href="#cb14-1754" aria-hidden="true" tabindex="-1"></a>    fit_recurrence, </span>
<span id="cb14-1755"><a href="#cb14-1755" aria-hidden="true" tabindex="-1"></a>    <span class="at">new =</span> et_metabric_late_data[, pathways_to_compare] <span class="sc">%&gt;%</span></span>
<span id="cb14-1756"><a href="#cb14-1756" aria-hidden="true" tabindex="-1"></a>            as.matrix,</span>
<span id="cb14-1757"><a href="#cb14-1757" aria-hidden="true" tabindex="-1"></a>    <span class="at">s =</span> <span class="st">"lambda.1se"</span>,</span>
<span id="cb14-1758"><a href="#cb14-1758" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"class"</span></span>
<span id="cb14-1759"><a href="#cb14-1759" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> table</span>
<span id="cb14-1760"><a href="#cb14-1760" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1761"><a href="#cb14-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1762"><a href="#cb14-1762" aria-hidden="true" tabindex="-1"></a>This is probably because of the unbalanced dataset. Next we </span>
<span id="cb14-1763"><a href="#cb14-1763" aria-hidden="true" tabindex="-1"></a>try with random forest as well.</span>
<span id="cb14-1764"><a href="#cb14-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1767"><a href="#cb14-1767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1768"><a href="#cb14-1768" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">randomForest</span>(</span>
<span id="cb14-1769"><a href="#cb14-1769" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(is_there_recurrence) <span class="sc">~</span> ., </span>
<span id="cb14-1770"><a href="#cb14-1770" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> et_metabric_late_data[, <span class="fu">c</span>(</span>
<span id="cb14-1771"><a href="#cb14-1771" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_there_recurrence"</span>,</span>
<span id="cb14-1772"><a href="#cb14-1772" aria-hidden="true" tabindex="-1"></a>        pathways_to_compare,</span>
<span id="cb14-1773"><a href="#cb14-1773" aria-hidden="true" tabindex="-1"></a>        <span class="st">"AGE_AT_DIAGNOSIS"</span>,</span>
<span id="cb14-1774"><a href="#cb14-1774" aria-hidden="true" tabindex="-1"></a>        <span class="st">"LYMPH_NODES_EXAMINED_POSITIVE"</span>, </span>
<span id="cb14-1775"><a href="#cb14-1775" aria-hidden="true" tabindex="-1"></a>        <span class="st">"npi"</span></span>
<span id="cb14-1776"><a href="#cb14-1776" aria-hidden="true" tabindex="-1"></a>    )],</span>
<span id="cb14-1777"><a href="#cb14-1777" aria-hidden="true" tabindex="-1"></a>    <span class="at">ntree =</span> <span class="dv">500</span></span>
<span id="cb14-1778"><a href="#cb14-1778" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1779"><a href="#cb14-1779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1780"><a href="#cb14-1780" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rf)</span>
<span id="cb14-1781"><a href="#cb14-1781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1782"><a href="#cb14-1782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1783"><a href="#cb14-1783" aria-hidden="true" tabindex="-1"></a>That is not the case, still we can't predict if a patient will develop</span>
<span id="cb14-1784"><a href="#cb14-1784" aria-hidden="true" tabindex="-1"></a>recurrence or not in this cohort. </span>
<span id="cb14-1785"><a href="#cb14-1785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1786"><a href="#cb14-1786" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correlation of pathways with proliferation</span></span>
<span id="cb14-1787"><a href="#cb14-1787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1788"><a href="#cb14-1788" aria-hidden="true" tabindex="-1"></a>One thing that is very common is defining a gene signature and then </span>
<span id="cb14-1789"><a href="#cb14-1789" aria-hidden="true" tabindex="-1"></a>using this gene signature to calculate survival analysis. The thing is, </span>
<span id="cb14-1790"><a href="#cb14-1790" aria-hidden="true" tabindex="-1"></a>proliferation related genes are pretty much present in almost any signature</span>
<span id="cb14-1791"><a href="#cb14-1791" aria-hidden="true" tabindex="-1"></a>and hence all these pathways are correlated to G2M and E2F to some extent </span>
<span id="cb14-1792"><a href="#cb14-1792" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@Venet2011</span><span class="co">]</span>.</span>
<span id="cb14-1793"><a href="#cb14-1793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1794"><a href="#cb14-1794" aria-hidden="true" tabindex="-1"></a>Here we calculate the pathway scores by using the regressed data and do</span>
<span id="cb14-1795"><a href="#cb14-1795" aria-hidden="true" tabindex="-1"></a>all pairwise comparison of some of the most important pathways to see</span>
<span id="cb14-1796"><a href="#cb14-1796" aria-hidden="true" tabindex="-1"></a>their correlations.</span>
<span id="cb14-1797"><a href="#cb14-1797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1798"><a href="#cb14-1798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=17, fig.height=13, dev='png'}</span></span>
<span id="cb14-1799"><a href="#cb14-1799" aria-hidden="true" tabindex="-1"></a>color_by <span class="ot">&lt;-</span> <span class="st">"pam50"</span></span>
<span id="cb14-1800"><a href="#cb14-1800" aria-hidden="true" tabindex="-1"></a>pathways_correlation <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-1801"><a href="#cb14-1801" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G2M"</span>, <span class="st">"ER early"</span>, <span class="st">"ER late"</span>, <span class="st">"PI3K AKT MTOR"</span>,</span>
<span id="cb14-1802"><a href="#cb14-1802" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AR"</span>, <span class="st">"E2F"</span>, <span class="st">"EMT"</span>, </span>
<span id="cb14-1803"><a href="#cb14-1803" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Biocarta HER2"</span>, </span>
<span id="cb14-1804"><a href="#cb14-1804" aria-hidden="true" tabindex="-1"></a>    <span class="st">"KEGG HER2"</span>,</span>
<span id="cb14-1805"><a href="#cb14-1805" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET ER/PR"</span>, <span class="st">"Random 18"</span>, <span class="st">"Random 200"</span></span>
<span id="cb14-1806"><a href="#cb14-1806" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1807"><a href="#cb14-1807" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pathways_correlation) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-1808"><a href="#cb14-1808" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"HALLMARK_"</span>, <span class="fu">c</span>(</span>
<span id="cb14-1809"><a href="#cb14-1809" aria-hidden="true" tabindex="-1"></a>        <span class="st">"G2M_CHECKPOINT"</span>,</span>
<span id="cb14-1810"><a href="#cb14-1810" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ESTROGEN_RESPONSE_EARLY"</span>,</span>
<span id="cb14-1811"><a href="#cb14-1811" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ESTROGEN_RESPONSE_LATE"</span>,</span>
<span id="cb14-1812"><a href="#cb14-1812" aria-hidden="true" tabindex="-1"></a>        <span class="st">"PI3K_AKT_MTOR_SIGNALING"</span>,</span>
<span id="cb14-1813"><a href="#cb14-1813" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ANDROGEN_RESPONSE"</span>,</span>
<span id="cb14-1814"><a href="#cb14-1814" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E2F_TARGETS"</span>,</span>
<span id="cb14-1815"><a href="#cb14-1815" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EPITHELIAL_MESENCHYMAL_TRANSITION"</span></span>
<span id="cb14-1816"><a href="#cb14-1816" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb14-1817"><a href="#cb14-1817" aria-hidden="true" tabindex="-1"></a>    <span class="st">"BIOCARTA_HER2_PATHWAY"</span>,</span>
<span id="cb14-1818"><a href="#cb14-1818" aria-hidden="true" tabindex="-1"></a>    <span class="st">"KEGG_ERBB_SIGNALING_PATHWAY"</span>,</span>
<span id="cb14-1819"><a href="#cb14-1819" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SET_ERPR"</span>,</span>
<span id="cb14-1820"><a href="#cb14-1820" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_18"</span>,</span>
<span id="cb14-1821"><a href="#cb14-1821" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_200"</span></span>
<span id="cb14-1822"><a href="#cb14-1822" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1823"><a href="#cb14-1823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1824"><a href="#cb14-1824" aria-hidden="true" tabindex="-1"></a>scores_her2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb14-1825"><a href="#cb14-1825" aria-hidden="true" tabindex="-1"></a>    gene_sets_[<span class="fu">names</span>(pathways_correlation)],</span>
<span id="cb14-1826"><a href="#cb14-1826" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(gene_set, df_pcs_regressed, avg_hkg_pcs_regressed){</span>
<span id="cb14-1827"><a href="#cb14-1827" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-1828"><a href="#cb14-1828" aria-hidden="true" tabindex="-1"></a>        gene_set <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb14-1829"><a href="#cb14-1829" aria-hidden="true" tabindex="-1"></a>            gene_set,</span>
<span id="cb14-1830"><a href="#cb14-1830" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rownames</span>(df_pcs_regressed)</span>
<span id="cb14-1831"><a href="#cb14-1831" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-1832"><a href="#cb14-1832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1833"><a href="#cb14-1833" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colSums</span>(df_pcs_regressed[gene_set, ])</span>
<span id="cb14-1834"><a href="#cb14-1834" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-1835"><a href="#cb14-1835" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb14-1836"><a href="#cb14-1836" aria-hidden="true" tabindex="-1"></a>    <span class="at">df_pcs_regressed =</span> df_pcs_regressed,</span>
<span id="cb14-1837"><a href="#cb14-1837" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_hkg_pcs_regressed =</span> avg_hkg_pcs_regressed</span>
<span id="cb14-1838"><a href="#cb14-1838" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1839"><a href="#cb14-1839" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-1840"><a href="#cb14-1840" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="fu">setNames</span>(<span class="fu">names</span>(pathways_correlation), pathways_correlation)) <span class="sc">%&gt;%</span></span>
<span id="cb14-1841"><a href="#cb14-1841" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>)</span>
<span id="cb14-1842"><a href="#cb14-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1843"><a href="#cb14-1843" aria-hidden="true" tabindex="-1"></a>p_pathways <span class="ot">&lt;-</span> GGally<span class="sc">::</span><span class="fu">ggpairs</span>(</span>
<span id="cb14-1844"><a href="#cb14-1844" aria-hidden="true" tabindex="-1"></a>    df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1845"><a href="#cb14-1845" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1846"><a href="#cb14-1846" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(., scores_her2, <span class="at">by =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1847"><a href="#cb14-1847" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(</span>
<span id="cb14-1848"><a href="#cb14-1848" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.vector</span>(pathways_correlation), </span>
<span id="cb14-1849"><a href="#cb14-1849" aria-hidden="true" tabindex="-1"></a>            color_by</span>
<span id="cb14-1850"><a href="#cb14-1850" aria-hidden="true" tabindex="-1"></a>        ))),</span>
<span id="cb14-1851"><a href="#cb14-1851" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">color =</span> <span class="sc">!!</span><span class="fu">sym</span>(color_by), <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb14-1852"><a href="#cb14-1852" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb14-1853"><a href="#cb14-1853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1854"><a href="#cb14-1854" aria-hidden="true" tabindex="-1"></a>p_pathways <span class="sc">+</span> </span>
<span id="cb14-1855"><a href="#cb14-1855" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>) </span>
<span id="cb14-1856"><a href="#cb14-1856" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1857"><a href="#cb14-1857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1858"><a href="#cb14-1858" aria-hidden="true" tabindex="-1"></a>First we see that G2M and E2F are encoding basically the same information. </span>
<span id="cb14-1859"><a href="#cb14-1859" aria-hidden="true" tabindex="-1"></a>PI3K AKT MTOR, AR and the Biocarta HER2 and SET ER/PR are all correlated to</span>
<span id="cb14-1860"><a href="#cb14-1860" aria-hidden="true" tabindex="-1"></a>some extent to proliferation. Surprisingly the two HER2 signaling scores </span>
<span id="cb14-1861"><a href="#cb14-1861" aria-hidden="true" tabindex="-1"></a>are not able to distinguish the HER2 subtype.</span>
<span id="cb14-1862"><a href="#cb14-1862" aria-hidden="true" tabindex="-1"></a>The SET ER/PR correlation with G2M is possibly explained by the fact that</span>
<span id="cb14-1863"><a href="#cb14-1863" aria-hidden="true" tabindex="-1"></a>the basal molecular subtype has higher G2M and lower ER signaling compared to</span>
<span id="cb14-1864"><a href="#cb14-1864" aria-hidden="true" tabindex="-1"></a>luminal A and B.</span>
<span id="cb14-1865"><a href="#cb14-1865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1866"><a href="#cb14-1866" aria-hidden="true" tabindex="-1"></a><span class="fu">## ILC and position in the molecular landscape</span></span>
<span id="cb14-1867"><a href="#cb14-1867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1868"><a href="#cb14-1868" aria-hidden="true" tabindex="-1"></a>Invasive lobular carcinoma is a subtype of ER+ BC. They tend to respond</span>
<span id="cb14-1869"><a href="#cb14-1869" aria-hidden="true" tabindex="-1"></a>better to ET in the short term but they recurr after 20 years. Here we</span>
<span id="cb14-1870"><a href="#cb14-1870" aria-hidden="true" tabindex="-1"></a>just show where the ILC BC lie in the molecular landscape.</span>
<span id="cb14-1871"><a href="#cb14-1871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1872"><a href="#cb14-1872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=9, fig.height=6, message=FALSE}</span></span>
<span id="cb14-1873"><a href="#cb14-1873" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-lobular-scanb</span></span>
<span id="cb14-1874"><a href="#cb14-1874" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of the lobular samples from SCANB on top </span></span>
<span id="cb14-1875"><a href="#cb14-1875" aria-hidden="true" tabindex="-1"></a><span class="co">#|     METABRIC and TCGA</span></span>
<span id="cb14-1876"><a href="#cb14-1876" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">get_base_plot</span>(df_pca <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tcga"</span>, <span class="st">"metabric"</span>)))</span>
<span id="cb14-1877"><a href="#cb14-1877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1878"><a href="#cb14-1878" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb14-1879"><a href="#cb14-1879" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb14-1880"><a href="#cb14-1880" aria-hidden="true" tabindex="-1"></a>        df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1881"><a href="#cb14-1881" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span> <span class="sc">&amp;</span> InvCa.type <span class="sc">==</span> <span class="st">"Lobular"</span>),</span>
<span id="cb14-1882"><a href="#cb14-1882" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4),</span>
<span id="cb14-1883"><a href="#cb14-1883" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb14-1884"><a href="#cb14-1884" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1885"><a href="#cb14-1885" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-1886"><a href="#cb14-1886" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1887"><a href="#cb14-1887" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Lobular samples from SCANB</span><span class="sc">\n</span><span class="st">on top of METABRIC and TCGA samples"</span></span>
<span id="cb14-1888"><a href="#cb14-1888" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1889"><a href="#cb14-1889" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb14-1890"><a href="#cb14-1890" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="fu">get_colors_pam50</span>(p<span class="sc">$</span>data))</span>
<span id="cb14-1891"><a href="#cb14-1891" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-1892"><a href="#cb14-1892" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-1893"><a href="#cb14-1893" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>(<span class="at">shape =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-1894"><a href="#cb14-1894" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1895"><a href="#cb14-1895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1896"><a href="#cb14-1896" aria-hidden="true" tabindex="-1"></a>We see that they are mostly in the normal and luminal A region. Still</span>
<span id="cb14-1897"><a href="#cb14-1897" aria-hidden="true" tabindex="-1"></a>there are several samples that are luminal B, meaning they are more</span>
<span id="cb14-1898"><a href="#cb14-1898" aria-hidden="true" tabindex="-1"></a>proliferative.</span>
<span id="cb14-1899"><a href="#cb14-1899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1900"><a href="#cb14-1900" aria-hidden="true" tabindex="-1"></a>Is there any difference in the SET ER/PR for lobulars when comparing</span>
<span id="cb14-1901"><a href="#cb14-1901" aria-hidden="true" tabindex="-1"></a>to ER+ HER2- Ductal carcinomas? </span>
<span id="cb14-1902"><a href="#cb14-1902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1905"><a href="#cb14-1905" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1906"><a href="#cb14-1906" aria-hidden="true" tabindex="-1"></a>df_pca <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-1907"><a href="#cb14-1907" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-1908"><a href="#cb14-1908" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-1909"><a href="#cb14-1909" aria-hidden="true" tabindex="-1"></a>        scores_her2,</span>
<span id="cb14-1910"><a href="#cb14-1910" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-1911"><a href="#cb14-1911" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb14-1912"><a href="#cb14-1912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1913"><a href="#cb14-1913" aria-hidden="true" tabindex="-1"></a>coefs_risk_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(</span>
<span id="cb14-1914"><a href="#cb14-1914" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../results/rds_files/risk_score/coefs_risk_model.rds"</span></span>
<span id="cb14-1915"><a href="#cb14-1915" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1916"><a href="#cb14-1916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1917"><a href="#cb14-1917" aria-hidden="true" tabindex="-1"></a><span class="co"># now we can calculate the scores for all the patients. For TCGA and POETIC</span></span>
<span id="cb14-1918"><a href="#cb14-1918" aria-hidden="true" tabindex="-1"></a><span class="co"># we do not have tumor size, so for those we calculate the risk score based</span></span>
<span id="cb14-1919"><a href="#cb14-1919" aria-hidden="true" tabindex="-1"></a><span class="co"># on the components only.</span></span>
<span id="cb14-1920"><a href="#cb14-1920" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="ot">&lt;-</span> df_pca <span class="sc">%&gt;%</span> </span>
<span id="cb14-1921"><a href="#cb14-1921" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-1922"><a href="#cb14-1922" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">node_status =</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-1923"><a href="#cb14-1923" aria-hidden="true" tabindex="-1"></a>        node_group <span class="sc">==</span> <span class="st">"N0"</span>, </span>
<span id="cb14-1924"><a href="#cb14-1924" aria-hidden="true" tabindex="-1"></a>        <span class="st">"neg"</span>,</span>
<span id="cb14-1925"><a href="#cb14-1925" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pos"</span></span>
<span id="cb14-1926"><a href="#cb14-1926" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb14-1927"><a href="#cb14-1927" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">node_status =</span> <span class="fu">factor</span>(</span>
<span id="cb14-1928"><a href="#cb14-1928" aria-hidden="true" tabindex="-1"></a>        node_status, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"neg"</span>, <span class="st">"pos"</span>)</span>
<span id="cb14-1929"><a href="#cb14-1929" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-1930"><a href="#cb14-1930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1931"><a href="#cb14-1931" aria-hidden="true" tabindex="-1"></a>df_pca_scanb<span class="sc">$</span>risk_score <span class="ot">&lt;-</span> <span class="fu">calculate_risk_score</span>(</span>
<span id="cb14-1932"><a href="#cb14-1932" aria-hidden="true" tabindex="-1"></a>    coefs_risk_model, df_pca_scanb</span>
<span id="cb14-1933"><a href="#cb14-1933" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-1934"><a href="#cb14-1934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1935"><a href="#cb14-1935" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-1936"><a href="#cb14-1936" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-1937"><a href="#cb14-1937" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-1938"><a href="#cb14-1938" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1939"><a href="#cb14-1939" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1940"><a href="#cb14-1940" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.na</span>(risk_score)</span>
<span id="cb14-1941"><a href="#cb14-1941" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1942"><a href="#cb14-1942" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> InvCa.type, <span class="at">y =</span> <span class="st">`</span><span class="at">SET ER/PR</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb14-1943"><a href="#cb14-1943" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="fl">0.4</span>, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> pam50)) <span class="sc">+</span> </span>
<span id="cb14-1944"><a href="#cb14-1944" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb14-1945"><a href="#cb14-1945" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1946"><a href="#cb14-1946" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, </span>
<span id="cb14-1947"><a href="#cb14-1947" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC"</span></span>
<span id="cb14-1948"><a href="#cb14-1948" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1949"><a href="#cb14-1949" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-1950"><a href="#cb14-1950" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-1951"><a href="#cb14-1951" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1952"><a href="#cb14-1952" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1953"><a href="#cb14-1953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1954"><a href="#cb14-1954" aria-hidden="true" tabindex="-1"></a>They seem to be the same, also when checking the risk score calculated </span>
<span id="cb14-1955"><a href="#cb14-1955" aria-hidden="true" tabindex="-1"></a>for all patients, the lobular patients don't seem to have a decreased </span>
<span id="cb14-1956"><a href="#cb14-1956" aria-hidden="true" tabindex="-1"></a>risk overall, it is mostly because they are in the same region </span>
<span id="cb14-1957"><a href="#cb14-1957" aria-hidden="true" tabindex="-1"></a>of the molecular landscape. Interestingly there is way less</span>
<span id="cb14-1958"><a href="#cb14-1958" aria-hidden="true" tabindex="-1"></a>luminal B patients in the lobular, but still their distributions</span>
<span id="cb14-1959"><a href="#cb14-1959" aria-hidden="true" tabindex="-1"></a>are very similar.</span>
<span id="cb14-1960"><a href="#cb14-1960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1963"><a href="#cb14-1963" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-1964"><a href="#cb14-1964" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-1965"><a href="#cb14-1965" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-1966"><a href="#cb14-1966" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-1967"><a href="#cb14-1967" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1968"><a href="#cb14-1968" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1969"><a href="#cb14-1969" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.na</span>(risk_score)</span>
<span id="cb14-1970"><a href="#cb14-1970" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1971"><a href="#cb14-1971" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> InvCa.type, <span class="at">y =</span> risk_score)) <span class="sc">+</span></span>
<span id="cb14-1972"><a href="#cb14-1972" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="fl">0.4</span>, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> pam50)) <span class="sc">+</span> </span>
<span id="cb14-1973"><a href="#cb14-1973" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb14-1974"><a href="#cb14-1974" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1975"><a href="#cb14-1975" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, </span>
<span id="cb14-1976"><a href="#cb14-1976" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC"</span>,</span>
<span id="cb14-1977"><a href="#cb14-1977" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Risk score"</span></span>
<span id="cb14-1978"><a href="#cb14-1978" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-1979"><a href="#cb14-1979" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-1980"><a href="#cb14-1980" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-1981"><a href="#cb14-1981" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-1982"><a href="#cb14-1982" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-1983"><a href="#cb14-1983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1984"><a href="#cb14-1984" aria-hidden="true" tabindex="-1"></a>And we also plot by intrinsic molecular subtype. </span>
<span id="cb14-1985"><a href="#cb14-1985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-1986"><a href="#cb14-1986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height = 5, fig.width = 14}</span></span>
<span id="cb14-1987"><a href="#cb14-1987" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-1988"><a href="#cb14-1988" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-1989"><a href="#cb14-1989" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-1990"><a href="#cb14-1990" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1991"><a href="#cb14-1991" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-1992"><a href="#cb14-1992" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.na</span>(risk_score) <span class="sc">&amp;</span> </span>
<span id="cb14-1993"><a href="#cb14-1993" aria-hidden="true" tabindex="-1"></a>        risk_score <span class="sc">&lt;</span> <span class="dv">3</span></span>
<span id="cb14-1994"><a href="#cb14-1994" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-1995"><a href="#cb14-1995" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> InvCa.type, <span class="at">y =</span> risk_score)) <span class="sc">+</span></span>
<span id="cb14-1996"><a href="#cb14-1996" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="fl">0.4</span>) <span class="sc">+</span> </span>
<span id="cb14-1997"><a href="#cb14-1997" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb14-1998"><a href="#cb14-1998" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-1999"><a href="#cb14-1999" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>, </span>
<span id="cb14-2000"><a href="#cb14-2000" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC"</span>,</span>
<span id="cb14-2001"><a href="#cb14-2001" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Risk score"</span></span>
<span id="cb14-2002"><a href="#cb14-2002" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2003"><a href="#cb14-2003" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-2004"><a href="#cb14-2004" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pam50, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb14-2005"><a href="#cb14-2005" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-2006"><a href="#cb14-2006" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-2007"><a href="#cb14-2007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2008"><a href="#cb14-2008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2009"><a href="#cb14-2009" aria-hidden="true" tabindex="-1"></a>We also compare EMT.</span>
<span id="cb14-2010"><a href="#cb14-2010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2013"><a href="#cb14-2013" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2014"><a href="#cb14-2014" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-2015"><a href="#cb14-2015" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2016"><a href="#cb14-2016" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-2017"><a href="#cb14-2017" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2018"><a href="#cb14-2018" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span></span>
<span id="cb14-2019"><a href="#cb14-2019" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2020"><a href="#cb14-2020" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> InvCa.type, <span class="at">y =</span> <span class="st">`</span><span class="at">EMT</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb14-2021"><a href="#cb14-2021" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">size =</span> <span class="fl">0.4</span>, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> pam50)) <span class="sc">+</span> </span>
<span id="cb14-2022"><a href="#cb14-2022" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb14-2023"><a href="#cb14-2023" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC"</span>) <span class="sc">+</span> </span>
<span id="cb14-2024"><a href="#cb14-2024" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-2025"><a href="#cb14-2025" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-2026"><a href="#cb14-2026" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-2027"><a href="#cb14-2027" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2028"><a href="#cb14-2028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2029"><a href="#cb14-2029" aria-hidden="true" tabindex="-1"></a>EMT is very similar across both histological subtypes. The plot </span>
<span id="cb14-2030"><a href="#cb14-2030" aria-hidden="true" tabindex="-1"></a>below shows the densities for ER percentage, notice how the two </span>
<span id="cb14-2031"><a href="#cb14-2031" aria-hidden="true" tabindex="-1"></a>overlap.</span>
<span id="cb14-2032"><a href="#cb14-2032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2035"><a href="#cb14-2035" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2036"><a href="#cb14-2036" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-2037"><a href="#cb14-2037" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2038"><a href="#cb14-2038" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-2039"><a href="#cb14-2039" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2040"><a href="#cb14-2040" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2041"><a href="#cb14-2041" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.na</span>(risk_score)</span>
<span id="cb14-2042"><a href="#cb14-2042" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2043"><a href="#cb14-2043" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ER.pct, <span class="at">fill =</span> InvCa.type)) <span class="sc">+</span></span>
<span id="cb14-2044"><a href="#cb14-2044" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb14-2045"><a href="#cb14-2045" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2046"><a href="#cb14-2046" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb14-2047"><a href="#cb14-2047" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC"</span>,</span>
<span id="cb14-2048"><a href="#cb14-2048" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"ER percentage"</span>,</span>
<span id="cb14-2049"><a href="#cb14-2049" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="st">"Histology"</span></span>
<span id="cb14-2050"><a href="#cb14-2050" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2051"><a href="#cb14-2051" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb14-2052"><a href="#cb14-2052" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-2053"><a href="#cb14-2053" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-2054"><a href="#cb14-2054" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2055"><a href="#cb14-2055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2056"><a href="#cb14-2056" aria-hidden="true" tabindex="-1"></a>We now check the lobular signature LobSig that is touted to be superior</span>
<span id="cb14-2057"><a href="#cb14-2057" aria-hidden="true" tabindex="-1"></a>to OncotypeDX, Prosigna's PAM50 and other signatures. In total, 63%</span>
<span id="cb14-2058"><a href="#cb14-2058" aria-hidden="true" tabindex="-1"></a>of the genes are available here. Based on my experience this is </span>
<span id="cb14-2059"><a href="#cb14-2059" aria-hidden="true" tabindex="-1"></a>already a good number to make comparisons. For example, G2M checkpoint has</span>
<span id="cb14-2060"><a href="#cb14-2060" aria-hidden="true" tabindex="-1"></a>71% of the genes available, estrogen response early has 66%.</span>
<span id="cb14-2061"><a href="#cb14-2061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2062"><a href="#cb14-2062" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=10, fig.height=6}</span></span>
<span id="cb14-2063"><a href="#cb14-2063" aria-hidden="true" tabindex="-1"></a>lobsig <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"../../data/lobular_signature.txt"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2064"><a href="#cb14-2064" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">colnames&lt;-</span><span class="st">`</span>(<span class="st">"genes"</span>)</span>
<span id="cb14-2065"><a href="#cb14-2065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2066"><a href="#cb14-2066" aria-hidden="true" tabindex="-1"></a>lobsig_available <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb14-2067"><a href="#cb14-2067" aria-hidden="true" tabindex="-1"></a>    lobsig<span class="sc">$</span>genes,</span>
<span id="cb14-2068"><a href="#cb14-2068" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(df_pcs_regressed)</span>
<span id="cb14-2069"><a href="#cb14-2069" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-2070"><a href="#cb14-2070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2071"><a href="#cb14-2071" aria-hidden="true" tabindex="-1"></a>df_pca_scanb<span class="sc">$</span>LobSig <span class="ot">&lt;-</span> <span class="fu">colSums</span>(</span>
<span id="cb14-2072"><a href="#cb14-2072" aria-hidden="true" tabindex="-1"></a>    df_pcs_regressed[lobsig_available, df_pca_scanb<span class="sc">$</span>sample_name]</span>
<span id="cb14-2073"><a href="#cb14-2073" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-2074"><a href="#cb14-2074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2075"><a href="#cb14-2075" aria-hidden="true" tabindex="-1"></a>col_to_compare <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-2076"><a href="#cb14-2076" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G2M"</span>, <span class="st">"EMT"</span>, <span class="st">"ER early"</span>, </span>
<span id="cb14-2077"><a href="#cb14-2077" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Random 200"</span>, <span class="st">"risk_score"</span>, <span class="st">"NCN.ROR.asT0"</span></span>
<span id="cb14-2078"><a href="#cb14-2078" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-2079"><a href="#cb14-2079" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-2080"><a href="#cb14-2080" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb14-2081"><a href="#cb14-2081" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(col_to_compare),</span>
<span id="cb14-2082"><a href="#cb14-2082" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"pathway"</span>,</span>
<span id="cb14-2083"><a href="#cb14-2083" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"score"</span> </span>
<span id="cb14-2084"><a href="#cb14-2084" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2085"><a href="#cb14-2085" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2086"><a href="#cb14-2086" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-2087"><a href="#cb14-2087" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(score)</span>
<span id="cb14-2088"><a href="#cb14-2088" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2089"><a href="#cb14-2089" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pathway =</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-2090"><a href="#cb14-2090" aria-hidden="true" tabindex="-1"></a>        pathway <span class="sc">==</span> <span class="st">"risk_score"</span>,</span>
<span id="cb14-2091"><a href="#cb14-2091" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Risk Score"</span>,</span>
<span id="cb14-2092"><a href="#cb14-2092" aria-hidden="true" tabindex="-1"></a>        pathway</span>
<span id="cb14-2093"><a href="#cb14-2093" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb14-2094"><a href="#cb14-2094" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-2095"><a href="#cb14-2095" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> LobSig, </span>
<span id="cb14-2096"><a href="#cb14-2096" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> score,</span>
<span id="cb14-2097"><a href="#cb14-2097" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb14-2098"><a href="#cb14-2098" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-2099"><a href="#cb14-2099" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-2100"><a href="#cb14-2100" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb14-2101"><a href="#cb14-2101" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pathway, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb14-2102"><a href="#cb14-2102" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb14-2103"><a href="#cb14-2103" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df_pca_scanb)</span>
<span id="cb14-2104"><a href="#cb14-2104" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2105"><a href="#cb14-2105" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2106"><a href="#cb14-2106" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"LobSig"</span>, </span>
<span id="cb14-2107"><a href="#cb14-2107" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Score of signatures"</span>,</span>
<span id="cb14-2108"><a href="#cb14-2108" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"All samples classified with lobular BC from SCANB"</span></span>
<span id="cb14-2109"><a href="#cb14-2109" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2110"><a href="#cb14-2110" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb14-2111"><a href="#cb14-2111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-2112"><a href="#cb14-2112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-2113"><a href="#cb14-2113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2114"><a href="#cb14-2114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2115"><a href="#cb14-2115" aria-hidden="true" tabindex="-1"></a>We see that the LobSig is highgly correlated with G2M checkpoint and also</span>
<span id="cb14-2116"><a href="#cb14-2116" aria-hidden="true" tabindex="-1"></a>the risk of recurrence score obtained from PAM50. The random 200 is a signature</span>
<span id="cb14-2117"><a href="#cb14-2117" aria-hidden="true" tabindex="-1"></a>of 200 random genes that works as a negative control. </span>
<span id="cb14-2118"><a href="#cb14-2118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2119"><a href="#cb14-2119" aria-hidden="true" tabindex="-1"></a>The figure below shows the distinction of the signature among the 3 different</span>
<span id="cb14-2120"><a href="#cb14-2120" aria-hidden="true" tabindex="-1"></a>risk categories from ROR.</span>
<span id="cb14-2121"><a href="#cb14-2121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2124"><a href="#cb14-2124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2125"><a href="#cb14-2125" aria-hidden="true" tabindex="-1"></a>df_pca_scanb <span class="sc">%&gt;%</span></span>
<span id="cb14-2126"><a href="#cb14-2126" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(NCN.ROR.risk.cat)) <span class="sc">%&gt;%</span></span>
<span id="cb14-2127"><a href="#cb14-2127" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">NCN.ROR.risk.cat =</span> <span class="fu">factor</span>(</span>
<span id="cb14-2128"><a href="#cb14-2128" aria-hidden="true" tabindex="-1"></a>        NCN.ROR.risk.cat,</span>
<span id="cb14-2129"><a href="#cb14-2129" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"Intermediate"</span>, <span class="st">"High"</span>)</span>
<span id="cb14-2130"><a href="#cb14-2130" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb14-2131"><a href="#cb14-2131" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-2132"><a href="#cb14-2132" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> LobSig, </span>
<span id="cb14-2133"><a href="#cb14-2133" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> NCN.ROR.risk.cat,</span>
<span id="cb14-2134"><a href="#cb14-2134" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> pam50</span>
<span id="cb14-2135"><a href="#cb14-2135" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-2136"><a href="#cb14-2136" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span> </span>
<span id="cb14-2137"><a href="#cb14-2137" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb14-2138"><a href="#cb14-2138" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb14-2139"><a href="#cb14-2139" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_colors_pam50</span>(df_pca_scanb)</span>
<span id="cb14-2140"><a href="#cb14-2140" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2141"><a href="#cb14-2141" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2142"><a href="#cb14-2142" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"NCN ROR risk category"</span>,</span>
<span id="cb14-2143"><a href="#cb14-2143" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"PAM50"</span></span>
<span id="cb14-2144"><a href="#cb14-2144" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2145"><a href="#cb14-2145" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb14-2146"><a href="#cb14-2146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span> </span>
<span id="cb14-2147"><a href="#cb14-2147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>()</span>
<span id="cb14-2148"><a href="#cb14-2148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2149"><a href="#cb14-2149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2150"><a href="#cb14-2150" aria-hidden="true" tabindex="-1"></a>There is an increase in the score as expected based on the previous results</span>
<span id="cb14-2151"><a href="#cb14-2151" aria-hidden="true" tabindex="-1"></a>that show where the intermediate risk group is according to the molecular</span>
<span id="cb14-2152"><a href="#cb14-2152" aria-hidden="true" tabindex="-1"></a>landscape. </span>
<span id="cb14-2153"><a href="#cb14-2153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2154"><a href="#cb14-2154" aria-hidden="true" tabindex="-1"></a>Lastly we check the CDH1 expression levels on the regressed data to </span>
<span id="cb14-2155"><a href="#cb14-2155" aria-hidden="true" tabindex="-1"></a>see if the differences are still captured upon the whole process. </span>
<span id="cb14-2156"><a href="#cb14-2156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2157"><a href="#cb14-2157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height = 5, fig.width = 14}</span></span>
<span id="cb14-2158"><a href="#cb14-2158" aria-hidden="true" tabindex="-1"></a>genes_of_interest <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CDH1"</span>, <span class="st">"ESR1"</span>, <span class="st">"LOXL1"</span>)</span>
<span id="cb14-2159"><a href="#cb14-2159" aria-hidden="true" tabindex="-1"></a>df_pcs_regressed[genes_of_interest, ] <span class="sc">%&gt;%</span></span>
<span id="cb14-2160"><a href="#cb14-2160" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span></span>
<span id="cb14-2161"><a href="#cb14-2161" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-2162"><a href="#cb14-2162" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2163"><a href="#cb14-2163" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-2164"><a href="#cb14-2164" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-2165"><a href="#cb14-2165" aria-hidden="true" tabindex="-1"></a>        df_pca_scanb,</span>
<span id="cb14-2166"><a href="#cb14-2166" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-2167"><a href="#cb14-2167" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2168"><a href="#cb14-2168" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2169"><a href="#cb14-2169" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-2170"><a href="#cb14-2170" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2171"><a href="#cb14-2171" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span></span>
<span id="cb14-2172"><a href="#cb14-2172" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2173"><a href="#cb14-2173" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> InvCa.type, <span class="at">y =</span> CDH1)) <span class="sc">+</span></span>
<span id="cb14-2174"><a href="#cb14-2174" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span> </span>
<span id="cb14-2175"><a href="#cb14-2175" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb14-2176"><a href="#cb14-2176" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pam50, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb14-2177"><a href="#cb14-2177" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2178"><a href="#cb14-2178" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>,</span>
<span id="cb14-2179"><a href="#cb14-2179" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Regressed CDH1</span><span class="sc">\n</span><span class="st">expressioon levels"</span>,</span>
<span id="cb14-2180"><a href="#cb14-2180" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC samples only"</span></span>
<span id="cb14-2181"><a href="#cb14-2181" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2182"><a href="#cb14-2182" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb14-2183"><a href="#cb14-2183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2184"><a href="#cb14-2184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2185"><a href="#cb14-2185" aria-hidden="true" tabindex="-1"></a>The differences are still captured, and CDH1 is decreased when </span>
<span id="cb14-2186"><a href="#cb14-2186" aria-hidden="true" tabindex="-1"></a>comparing lobular vs NST. Note also that the difference seems to be</span>
<span id="cb14-2187"><a href="#cb14-2187" aria-hidden="true" tabindex="-1"></a>the biggest in the luminal B subtype.</span>
<span id="cb14-2188"><a href="#cb14-2188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2189"><a href="#cb14-2189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height = 5, fig.width = 14}</span></span>
<span id="cb14-2190"><a href="#cb14-2190" aria-hidden="true" tabindex="-1"></a>df_pcs_regressed[genes_of_interest, ] <span class="sc">%&gt;%</span></span>
<span id="cb14-2191"><a href="#cb14-2191" aria-hidden="true" tabindex="-1"></a>    t <span class="sc">%&gt;%</span></span>
<span id="cb14-2192"><a href="#cb14-2192" aria-hidden="true" tabindex="-1"></a>    data.frame <span class="sc">%&gt;%</span></span>
<span id="cb14-2193"><a href="#cb14-2193" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"sample_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2194"><a href="#cb14-2194" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-2195"><a href="#cb14-2195" aria-hidden="true" tabindex="-1"></a>        .,</span>
<span id="cb14-2196"><a href="#cb14-2196" aria-hidden="true" tabindex="-1"></a>        df_pca_scanb,</span>
<span id="cb14-2197"><a href="#cb14-2197" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-2198"><a href="#cb14-2198" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2199"><a href="#cb14-2199" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2200"><a href="#cb14-2200" aria-hidden="true" tabindex="-1"></a>        InvCa.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lobular"</span>, <span class="st">"Ductal"</span>) <span class="sc">&amp;</span> </span>
<span id="cb14-2201"><a href="#cb14-2201" aria-hidden="true" tabindex="-1"></a>        er_status <span class="sc">==</span> <span class="st">"pos"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2202"><a href="#cb14-2202" aria-hidden="true" tabindex="-1"></a>        HER2 <span class="sc">==</span> <span class="st">"Negative"</span></span>
<span id="cb14-2203"><a href="#cb14-2203" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2204"><a href="#cb14-2204" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> InvCa.type, <span class="at">y =</span> LOXL1)) <span class="sc">+</span></span>
<span id="cb14-2205"><a href="#cb14-2205" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>() <span class="sc">+</span> </span>
<span id="cb14-2206"><a href="#cb14-2206" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_violin</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb14-2207"><a href="#cb14-2207" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>pam50, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb14-2208"><a href="#cb14-2208" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2209"><a href="#cb14-2209" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">""</span>,</span>
<span id="cb14-2210"><a href="#cb14-2210" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Regressed LOXL1</span><span class="sc">\n</span><span class="st">expressioon levels"</span>,</span>
<span id="cb14-2211"><a href="#cb14-2211" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"SCANB, ER+ HER2- BC samples only"</span></span>
<span id="cb14-2212"><a href="#cb14-2212" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2213"><a href="#cb14-2213" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb14-2214"><a href="#cb14-2214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2215"><a href="#cb14-2215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2216"><a href="#cb14-2216" aria-hidden="true" tabindex="-1"></a>We also check the PC3 and PC4 loadings for CDH1, to see how important</span>
<span id="cb14-2217"><a href="#cb14-2217" aria-hidden="true" tabindex="-1"></a>this gene is in the molecular landscape. </span>
<span id="cb14-2218"><a href="#cb14-2218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2221"><a href="#cb14-2221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2222"><a href="#cb14-2222" aria-hidden="true" tabindex="-1"></a>pca_fit_all_genes_wo_outliers<span class="sc">$</span>loadings <span class="sc">%&gt;%</span></span>
<span id="cb14-2223"><a href="#cb14-2223" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(PC3, PC4) <span class="sc">%&gt;%</span></span>
<span id="cb14-2224"><a href="#cb14-2224" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"gene"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2225"><a href="#cb14-2225" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(gene <span class="sc">==</span> <span class="st">"CDH1"</span>)</span>
<span id="cb14-2226"><a href="#cb14-2226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2227"><a href="#cb14-2227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2228"><a href="#cb14-2228" aria-hidden="true" tabindex="-1"></a>PC4 has a relatively high value which puts it into the 95 percentile as </span>
<span id="cb14-2229"><a href="#cb14-2229" aria-hidden="true" tabindex="-1"></a>shown below.</span>
<span id="cb14-2230"><a href="#cb14-2230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2233"><a href="#cb14-2233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2234"><a href="#cb14-2234" aria-hidden="true" tabindex="-1"></a>ecdf_genes_pc4 <span class="ot">&lt;-</span> pca_fit_all_genes_wo_outliers<span class="sc">$</span>loadings <span class="sc">%&gt;%</span></span>
<span id="cb14-2235"><a href="#cb14-2235" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(PC3, PC4) <span class="sc">%&gt;%</span></span>
<span id="cb14-2236"><a href="#cb14-2236" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"gene"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2237"><a href="#cb14-2237" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(PC4) <span class="sc">%&gt;%</span></span>
<span id="cb14-2238"><a href="#cb14-2238" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ecdf</span>(.)</span>
<span id="cb14-2239"><a href="#cb14-2239" aria-hidden="true" tabindex="-1"></a><span class="fu">ecdf_genes_pc4</span>(<span class="fl">0.01509738</span>)</span>
<span id="cb14-2240"><a href="#cb14-2240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2241"><a href="#cb14-2241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2242"><a href="#cb14-2242" aria-hidden="true" tabindex="-1"></a>Next we can plot the lobular samples from Ciriello's paper</span>
<span id="cb14-2243"><a href="#cb14-2243" aria-hidden="true" tabindex="-1"></a>and color by the 3 subtypes they found. Note here that there is a mismatch</span>
<span id="cb14-2244"><a href="#cb14-2244" aria-hidden="true" tabindex="-1"></a>between the cbioportal data and what is found in the original papers</span>
<span id="cb14-2245"><a href="#cb14-2245" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@Curtis2012</span><span class="co">]</span>. We will use the Curtis 2012 annotation as this is what </span>
<span id="cb14-2246"><a href="#cb14-2246" aria-hidden="true" tabindex="-1"></a>matches Ciriello's paper. Surprisingly the mismatch is not a systematic</span>
<span id="cb14-2247"><a href="#cb14-2247" aria-hidden="true" tabindex="-1"></a>issue, rather 88 ILC samples are matching and the non-matching samples</span>
<span id="cb14-2248"><a href="#cb14-2248" aria-hidden="true" tabindex="-1"></a>are NST but the other info matches usually, such as NPI.</span>
<span id="cb14-2249"><a href="#cb14-2249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2252"><a href="#cb14-2252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2253"><a href="#cb14-2253" aria-hidden="true" tabindex="-1"></a>metabric_ilc_subtypes <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb14-2254"><a href="#cb14-2254" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../../data/2015_Ciriello_metabric_ilc_subtypes.txt"</span>,</span>
<span id="cb14-2255"><a href="#cb14-2255" aria-hidden="true" tabindex="-1"></a>    <span class="at">header =</span> <span class="cn">FALSE</span></span>
<span id="cb14-2256"><a href="#cb14-2256" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-2257"><a href="#cb14-2257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2258"><a href="#cb14-2258" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(metabric_ilc_subtypes) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sample_name"</span>, <span class="st">"cohort"</span>, <span class="st">"subtype"</span>)</span>
<span id="cb14-2259"><a href="#cb14-2259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2260"><a href="#cb14-2260" aria-hidden="true" tabindex="-1"></a>metabric_lobular <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb14-2261"><a href="#cb14-2261" aria-hidden="true" tabindex="-1"></a>    df_pca, </span>
<span id="cb14-2262"><a href="#cb14-2262" aria-hidden="true" tabindex="-1"></a>    metabric_ilc_subtypes,</span>
<span id="cb14-2263"><a href="#cb14-2263" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"sample_name"</span></span>
<span id="cb14-2264"><a href="#cb14-2264" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-2265"><a href="#cb14-2265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2266"><a href="#cb14-2266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2267"><a href="#cb14-2267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=9, fig.height=6, message=FALSE}</span></span>
<span id="cb14-2268"><a href="#cb14-2268" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pca-lobular-metabric</span></span>
<span id="cb14-2269"><a href="#cb14-2269" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Embedding of the lobular samples from METABRIC on top </span></span>
<span id="cb14-2270"><a href="#cb14-2270" aria-hidden="true" tabindex="-1"></a><span class="co">#|     SCANB and TCGA</span></span>
<span id="cb14-2271"><a href="#cb14-2271" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">get_base_plot</span>(df_pca <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tcga"</span>, <span class="st">"scanb"</span>)))</span>
<span id="cb14-2272"><a href="#cb14-2272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2273"><a href="#cb14-2273" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb14-2274"><a href="#cb14-2274" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb14-2275"><a href="#cb14-2275" aria-hidden="true" tabindex="-1"></a>        metabric_lobular,</span>
<span id="cb14-2276"><a href="#cb14-2276" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4),</span>
<span id="cb14-2277"><a href="#cb14-2277" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb14-2278"><a href="#cb14-2278" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2279"><a href="#cb14-2279" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-2280"><a href="#cb14-2280" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2281"><a href="#cb14-2281" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Lobular samples from METABRIC</span><span class="sc">\n</span><span class="st">on top of SCANB and TCGA samples"</span></span>
<span id="cb14-2282"><a href="#cb14-2282" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2283"><a href="#cb14-2283" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(</span>
<span id="cb14-2284"><a href="#cb14-2284" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="fu">get_colors_pam50</span>(df_pca <span class="sc">%&gt;%</span></span>
<span id="cb14-2285"><a href="#cb14-2285" aria-hidden="true" tabindex="-1"></a>                                        dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"metabric"</span>)))</span>
<span id="cb14-2286"><a href="#cb14-2286" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-2287"><a href="#cb14-2287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-2288"><a href="#cb14-2288" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>(<span class="at">shape =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-2289"><a href="#cb14-2289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2290"><a href="#cb14-2290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2291"><a href="#cb14-2291" aria-hidden="true" tabindex="-1"></a>The table below shows the number of subtypes for each molecular subtype. </span>
<span id="cb14-2292"><a href="#cb14-2292" aria-hidden="true" tabindex="-1"></a>In general there are samples in each one of the molecular subtypes.</span>
<span id="cb14-2293"><a href="#cb14-2293" aria-hidden="true" tabindex="-1"></a>The reactive-like is actually more enriched in the normal region.</span>
<span id="cb14-2294"><a href="#cb14-2294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2297"><a href="#cb14-2297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2298"><a href="#cb14-2298" aria-hidden="true" tabindex="-1"></a>metabric_lobular <span class="sc">%&gt;%</span> </span>
<span id="cb14-2299"><a href="#cb14-2299" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">tabyl</span>(subtype, pam50)</span>
<span id="cb14-2300"><a href="#cb14-2300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2301"><a href="#cb14-2301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2302"><a href="#cb14-2302" aria-hidden="true" tabindex="-1"></a>And below is a plot of the lobular samples from Ciriello/Curtis with</span>
<span id="cb14-2303"><a href="#cb14-2303" aria-hidden="true" tabindex="-1"></a>the molecular subtypes defined by Ciriello. </span>
<span id="cb14-2304"><a href="#cb14-2304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2307"><a href="#cb14-2307" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2308"><a href="#cb14-2308" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb14-2309"><a href="#cb14-2309" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(</span>
<span id="cb14-2310"><a href="#cb14-2310" aria-hidden="true" tabindex="-1"></a>        metabric_lobular,</span>
<span id="cb14-2311"><a href="#cb14-2311" aria-hidden="true" tabindex="-1"></a>        <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PC3, <span class="at">y =</span> PC4, <span class="at">color =</span> subtype),</span>
<span id="cb14-2312"><a href="#cb14-2312" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb14-2313"><a href="#cb14-2313" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb14-2314"><a href="#cb14-2314" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb14-2315"><a href="#cb14-2315" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb14-2316"><a href="#cb14-2316" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Lobular samples from METABRIC</span><span class="sc">\n</span><span class="st">on top of SCANB and TCGA samples"</span></span>
<span id="cb14-2317"><a href="#cb14-2317" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-2318"><a href="#cb14-2318" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_plot_aes_point</span>() <span class="sc">+</span></span>
<span id="cb14-2319"><a href="#cb14-2319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change_guides_point</span>(<span class="at">shape =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-2320"><a href="#cb14-2320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2321"><a href="#cb14-2321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2322"><a href="#cb14-2322" aria-hidden="true" tabindex="-1"></a>It seems that more proliferative saaples are in the luminal B </span>
<span id="cb14-2323"><a href="#cb14-2323" aria-hidden="true" tabindex="-1"></a>region whereas the Reactive-like and Immune-related are not so</span>
<span id="cb14-2324"><a href="#cb14-2324" aria-hidden="true" tabindex="-1"></a>distinguishable, they are in the luminal A region.</span>
<span id="cb14-2325"><a href="#cb14-2325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2326"><a href="#cb14-2326" aria-hidden="true" tabindex="-1"></a>Some of the samples are NST on cbioportal and Lobular on Curtis. </span>
<span id="cb14-2327"><a href="#cb14-2327" aria-hidden="true" tabindex="-1"></a>We selected the following samples and checked on </span>
<span id="cb14-2328"><a href="#cb14-2328" aria-hidden="true" tabindex="-1"></a>cbioPortal (https://www.cbioportal.org/study/clinicalData?id=brca_metabric)</span>
<span id="cb14-2329"><a href="#cb14-2329" aria-hidden="true" tabindex="-1"></a>their histologic subtype directly.</span>
<span id="cb14-2330"><a href="#cb14-2330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2333"><a href="#cb14-2333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2334"><a href="#cb14-2334" aria-hidden="true" tabindex="-1"></a>metabric_lobular <span class="sc">%&gt;%</span></span>
<span id="cb14-2335"><a href="#cb14-2335" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(sample_name, npi) <span class="sc">%&gt;%</span> </span>
<span id="cb14-2336"><a href="#cb14-2336" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(sample_name) <span class="sc">%&gt;%</span></span>
<span id="cb14-2337"><a href="#cb14-2337" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>()</span>
<span id="cb14-2338"><a href="#cb14-2338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2339"><a href="#cb14-2339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2340"><a href="#cb14-2340" aria-hidden="true" tabindex="-1"></a>All the 6 samples are Ductal/NST and not Lobular.</span>
<span id="cb14-2341"><a href="#cb14-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2342"><a href="#cb14-2342" aria-hidden="true" tabindex="-1"></a><span class="fu">## Robustness to library protocol</span></span>
<span id="cb14-2343"><a href="#cb14-2343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2344"><a href="#cb14-2344" aria-hidden="true" tabindex="-1"></a>The figure below shows the first two components</span>
<span id="cb14-2345"><a href="#cb14-2345" aria-hidden="true" tabindex="-1"></a>for SCANB stratified by the library protocol used in the </span>
<span id="cb14-2346"><a href="#cb14-2346" aria-hidden="true" tabindex="-1"></a>study. We see that PC2 is partially capturing the</span>
<span id="cb14-2347"><a href="#cb14-2347" aria-hidden="true" tabindex="-1"></a>differences due to library protocol.</span>
<span id="cb14-2348"><a href="#cb14-2348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2351"><a href="#cb14-2351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-2352"><a href="#cb14-2352" aria-hidden="true" tabindex="-1"></a>df_pca_scores <span class="sc">%&gt;%</span> </span>
<span id="cb14-2353"><a href="#cb14-2353" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(cohort <span class="sc">==</span> <span class="st">"scanb"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2354"><a href="#cb14-2354" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-2355"><a href="#cb14-2355" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> PC1,</span>
<span id="cb14-2356"><a href="#cb14-2356" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> PC2,</span>
<span id="cb14-2357"><a href="#cb14-2357" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> LibraryProtocol</span>
<span id="cb14-2358"><a href="#cb14-2358" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-2359"><a href="#cb14-2359" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-2360"><a href="#cb14-2360" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>LibraryProtocol) <span class="sc">+</span></span>
<span id="cb14-2361"><a href="#cb14-2361" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb14-2362"><a href="#cb14-2362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2363"><a href="#cb14-2363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2364"><a href="#cb14-2364" aria-hidden="true" tabindex="-1"></a><span class="fu">## Distance in 4th component for POETIC</span></span>
<span id="cb14-2365"><a href="#cb14-2365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2366"><a href="#cb14-2366" aria-hidden="true" tabindex="-1"></a>We have seen previosuly that there is a bigger difference in </span>
<span id="cb14-2367"><a href="#cb14-2367" aria-hidden="true" tabindex="-1"></a>between the matched samples in the responder than to non-responder </span>
<span id="cb14-2368"><a href="#cb14-2368" aria-hidden="true" tabindex="-1"></a>patients. Hallmark G2M checkpoint is one of the signatures</span>
<span id="cb14-2369"><a href="#cb14-2369" aria-hidden="true" tabindex="-1"></a>driving the PC4, meaning that the position wrt the fourth component</span>
<span id="cb14-2370"><a href="#cb14-2370" aria-hidden="true" tabindex="-1"></a>might be used to define a new response status. </span>
<span id="cb14-2371"><a href="#cb14-2371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2372"><a href="#cb14-2372" aria-hidden="true" tabindex="-1"></a>Below we plot the matched samples for all non responder patients</span>
<span id="cb14-2373"><a href="#cb14-2373" aria-hidden="true" tabindex="-1"></a>with no change at all in Ki67 (change &gt;= 0%)</span>
<span id="cb14-2374"><a href="#cb14-2374" aria-hidden="true" tabindex="-1"></a>and their respective positions in the molecular landscape.</span>
<span id="cb14-2375"><a href="#cb14-2375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2376"><a href="#cb14-2376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=16, fig.height=10}</span></span>
<span id="cb14-2377"><a href="#cb14-2377" aria-hidden="true" tabindex="-1"></a>df_pca_scores <span class="sc">%&gt;%</span> </span>
<span id="cb14-2378"><a href="#cb14-2378" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2379"><a href="#cb14-2379" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2380"><a href="#cb14-2380" aria-hidden="true" tabindex="-1"></a>            is_responder <span class="sc">==</span> <span class="st">"non_responder"</span> <span class="sc">&amp;</span></span>
<span id="cb14-2381"><a href="#cb14-2381" aria-hidden="true" tabindex="-1"></a>            change_ki67 <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb14-2382"><a href="#cb14-2382" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2383"><a href="#cb14-2383" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-2384"><a href="#cb14-2384" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> PC3,</span>
<span id="cb14-2385"><a href="#cb14-2385" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> PC4,</span>
<span id="cb14-2386"><a href="#cb14-2386" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> patient_nb,</span>
<span id="cb14-2387"><a href="#cb14-2387" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> timepoint,</span>
<span id="cb14-2388"><a href="#cb14-2388" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste</span>(change_ki67)</span>
<span id="cb14-2389"><a href="#cb14-2389" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-2390"><a href="#cb14-2390" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb14-2391"><a href="#cb14-2391" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb14-2392"><a href="#cb14-2392" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>patient_nb) <span class="sc">+</span> </span>
<span id="cb14-2393"><a href="#cb14-2393" aria-hidden="true" tabindex="-1"></a>    ggrepel<span class="sc">::</span><span class="fu">geom_label_repel</span>(<span class="at">max.overlaps =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb14-2394"><a href="#cb14-2394" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_cartesian</span>(</span>
<span id="cb14-2395"><a href="#cb14-2395" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">7</span>),</span>
<span id="cb14-2396"><a href="#cb14-2396" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb14-2397"><a href="#cb14-2397" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-2398"><a href="#cb14-2398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2399"><a href="#cb14-2399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2400"><a href="#cb14-2400" aria-hidden="true" tabindex="-1"></a>Now we do the same for the top responders (change in Ki67 $\leq$ -90%).</span>
<span id="cb14-2401"><a href="#cb14-2401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2402"><a href="#cb14-2402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width=16, fig.height=10}</span></span>
<span id="cb14-2403"><a href="#cb14-2403" aria-hidden="true" tabindex="-1"></a>df_pca_scores <span class="sc">%&gt;%</span> </span>
<span id="cb14-2404"><a href="#cb14-2404" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb14-2405"><a href="#cb14-2405" aria-hidden="true" tabindex="-1"></a>        cohort <span class="sc">==</span> <span class="st">"poetic"</span> <span class="sc">&amp;</span> </span>
<span id="cb14-2406"><a href="#cb14-2406" aria-hidden="true" tabindex="-1"></a>            is_responder <span class="sc">==</span> <span class="st">"responder"</span> <span class="sc">&amp;</span></span>
<span id="cb14-2407"><a href="#cb14-2407" aria-hidden="true" tabindex="-1"></a>            change_ki67 <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">90</span></span>
<span id="cb14-2408"><a href="#cb14-2408" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb14-2409"><a href="#cb14-2409" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb14-2410"><a href="#cb14-2410" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> PC3,</span>
<span id="cb14-2411"><a href="#cb14-2411" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> PC4,</span>
<span id="cb14-2412"><a href="#cb14-2412" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> patient_nb,</span>
<span id="cb14-2413"><a href="#cb14-2413" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> timepoint</span>
<span id="cb14-2414"><a href="#cb14-2414" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span> </span>
<span id="cb14-2415"><a href="#cb14-2415" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb14-2416"><a href="#cb14-2416" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb14-2417"><a href="#cb14-2417" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>patient_nb) <span class="sc">+</span> </span>
<span id="cb14-2418"><a href="#cb14-2418" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_cartesian</span>(</span>
<span id="cb14-2419"><a href="#cb14-2419" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">7</span>),</span>
<span id="cb14-2420"><a href="#cb14-2420" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb14-2421"><a href="#cb14-2421" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-2422"><a href="#cb14-2422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-2423"><a href="#cb14-2423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2424"><a href="#cb14-2424" aria-hidden="true" tabindex="-1"></a>In general the distance for the responder samples seem to be higher and not only</span>
<span id="cb14-2425"><a href="#cb14-2425" aria-hidden="true" tabindex="-1"></a>that we see that the surgery sample goes to the bottom part of the embedding, </span>
<span id="cb14-2426"><a href="#cb14-2426" aria-hidden="true" tabindex="-1"></a>suggesting that the reduction of the proliferation is reflected in the</span>
<span id="cb14-2427"><a href="#cb14-2427" aria-hidden="true" tabindex="-1"></a>molecular landscape.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chronchi">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/chronchi">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>